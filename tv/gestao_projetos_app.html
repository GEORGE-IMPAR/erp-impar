<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ERP √çMPAR ‚Äî Gest√£o √† Vista</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root{
      --bg1:#0b1e4a;
      --bg2:#0e3b6e;
      --bg3:#0f766e;
      --panel: rgba(2,6,23,.66);
      --panel2: rgba(2,6,23,.78);
      --border: rgba(148,163,184,.45);
      --text: #e5e7eb;
      --soft: rgba(229,231,235,.78);
      --blue:#3b82f6;
      --green:#22c55e;
      --yellow:#facc15;
      --red:#ef4444;
      --radius: 18px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background:linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3));
      display:flex;
      flex-direction:column;
    }

    body{opacity:0}
    @keyframes imparEnter{
      0%{opacity:0; transform: translateY(28px) scale(.98); filter: blur(10px);}
      100%{opacity:1; transform: translateY(0) scale(1); filter: blur(0);}
    }
    body.impar-enter{animation:imparEnter .75s cubic-bezier(.16,1,.3,1) both;}

    header{
      padding:14px 14px 10px;
      display:flex;
      justify-content:center;
    }
    .header-inner{
      width:100%;
      max-width:1200px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      text-shadow:0 2px 6px rgba(0,0,0,.75);
      min-width:0;
    }
    .logo-orb{
      width:36px;height:36px;border-radius:999px;flex:0 0 auto;
      position:relative;
      background: conic-gradient(from 210deg,#22c55e,#06b6d4,#3b82f6,#a855f7,#f97316,#22c55e);
      box-shadow:0 10px 22px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.18) inset;
      overflow:hidden;
    }
    .logo-orb:before{
      content:""; position:absolute; inset:-6px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 55%);
    }
    .brand-text{display:flex; flex-direction:column; gap:2px; min-width:0;}
    .brand-kicker{font-size:12px; letter-spacing:.22em; text-transform:uppercase; font-weight:800; opacity:.9;}
    .brand-title{font-size:18px; font-weight:900; line-height:1.05;}
    .brand-sub{font-size:14px; font-weight:800; opacity:.92; line-height:1.1;}

    .tag-top{
      margin-left:auto;
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.85);
      border:1px solid rgba(148,163,184,.6);
      color:var(--soft);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill-btn{
      border:none;
      background:transparent;
      color:inherit;
      font:inherit;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      padding:0;
    }
    .pill-btn:hover{filter:brightness(1.08)}

    main{
      flex:1 0 auto;
      display:flex;
      justify-content:center;
      padding:12px 16px 18px;
    }
    .layout{
      width:100%;
      max-width:1200px;
      display:flex;
      justify-content:center;
    }
    .container{
      width:100%;
      border-radius:var(--radius);
      border:1px solid rgba(148,163,184,.6);
      box-shadow:0 24px 60px rgba(15,23,42,.9);
      background:linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3));
      padding:18px;
    }

    .topbox{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:12px 14px;
      border-radius:14px;
      border:2px solid rgba(34,197,94,.45);
      background:linear-gradient(120deg, rgba(2,6,23,.78), rgba(2,6,23,.35));
      box-shadow:0 18px 60px rgba(0,0,0,.35);
      flex-wrap:wrap;
    }
    .topbox-left .title{
      font-size:18px;
      font-weight:800;
      margin-bottom:4px;
    }
    .topbox-left .subtitle{
      font-size:12px;
      opacity:.82;
    }

    .form-section{
      margin-top:20px;
      padding:20px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--panel);
    }
    .form-section h3{
      font-size:16px;
      margin-bottom:16px;
      color:var(--green);
    }
    .form-group{
      margin-bottom:16px;
    }
    label{
      display:block;
      font-size:12px;
      font-weight:700;
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:.05em;
      color:var(--soft);
    }
    select, input, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.6);
      color:var(--text);
      font-family:inherit;
      font-size:14px;
    }
    select:focus, input:focus, textarea:focus{
      outline:none;
      border-color:var(--green);
      box-shadow:0 0 0 3px rgba(34,197,94,.2);
    }
    textarea{
      min-height:80px;
      resize:vertical;
    }

    .radio-group{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .radio-item{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .radio-item input[type="radio"]{
      width:auto;
    }

    .farol-group{
      display:flex;
      gap:12px;
    }
    .farol-btn{
      flex:1;
      padding:12px;
      border-radius:8px;
      border:2px solid transparent;
      background:rgba(15,23,42,.6);
      color:var(--text);
      cursor:pointer;
      font-weight:700;
      transition:all .2s;
      text-align:center;
    }
    .farol-btn:hover{
      transform:scale(1.02);
    }
    .farol-btn.active{
      border-color:currentColor;
      box-shadow:0 0 20px currentColor;
    }
    .farol-btn.verde{ color:var(--green); }
    .farol-btn.amarelo{ color:var(--yellow); }
    .farol-btn.vermelho{ color:var(--red); }

    .btn{
      padding:12px 24px;
      border-radius:10px;
      border:none;
      font-weight:700;
      cursor:pointer;
      transition:all .2s;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn-primary{
      background:var(--green);
      color:#fff;
    }
    .btn-primary:hover{
      transform:scale(1.02);
      box-shadow:0 10px 25px rgba(34,197,94,.35);
    }
    .btn-secondary{
      background:rgba(148,163,184,.2);
      color:var(--text);
      border:1px solid var(--border);
    }
    .btn-secondary:hover{
      background:rgba(148,163,184,.3);
    }

    .actions{
      margin-top:24px;
      display:flex;
      gap:12px;
      justify-content:flex-end;
    }

    footer{
      padding:12px;
      text-align:center;
      font-size:11px;
      opacity:.7;
    }

    @media (max-width:600px){
      .topbox{flex-direction:column; align-items:flex-start;}
      .actions{flex-direction:column;}
      .btn{width:100%;}
    }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo-orb"></div>
      <div class="brand-text">
        <div class="brand-kicker">ERP</div>
        <div class="brand-title">√çMPAR</div>
        <div class="brand-sub">Gest√£o √† Vista</div>
      </div>
    </div>
    <div class="tag-top">
      <span>Logado como</span>
      <button class="pill-btn" onclick="voltarMenu()">
        <strong id="usuarioNome">‚Äî</strong>
        <span id="usuarioEmail" style="font-size:10px;opacity:.7">‚Äî</span>
      </button>
    </div>
  </div>
</header>

<main>
  <div class="layout">
    <div class="container">
      <div class="topbox">
        <div class="topbox-left">
          <div class="title">üìä Atualizar Status do Projeto</div>
          <div class="subtitle">Preencha os campos e clique em Salvar Atualiza√ß√£o</div>
        </div>
      </div>

      <form id="formProjeto" class="form-section">
        <h3>üìå Dados do Projeto</h3>

        <div class="form-group">
          <label for="projeto">Projeto *</label>
          <select id="projeto" required>
            <option value="">Carregando...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="status">Status Atual *</label>
          <textarea id="status" placeholder="Ex: Funda√ß√£o conclu√≠da, iniciando estrutura..." required></textarea>
        </div>

        <div class="form-group">
          <label>Execu√ß√£o *</label>
          <div class="radio-group">
            <div class="radio-item">
              <input type="radio" id="execInterno" name="execucao" value="Interno" required>
              <label for="execInterno" style="margin:0">Interno</label>
            </div>
            <div class="radio-item">
              <input type="radio" id="execEmpreiteiro" name="execucao" value="Empreiteiro" required>
              <label for="execEmpreiteiro" style="margin:0">Empreiteiro</label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Farol do Projeto *</label>
          <div class="farol-group">
            <button type="button" class="farol-btn verde" data-farol="verde" onclick="selecionarFarol('verde')">
              üü¢ Verde<br><small style="font-size:10px;opacity:.8">Normal</small>
            </button>
            <button type="button" class="farol-btn amarelo" data-farol="amarelo" onclick="selecionarFarol('amarelo')">
              üü° Amarelo<br><small style="font-size:10px;opacity:.8">Aten√ß√£o</small>
            </button>
            <button type="button" class="farol-btn vermelho" data-farol="vermelho" onclick="selecionarFarol('vermelho')">
              üî¥ Vermelho<br><small style="font-size:10px;opacity:.8">Cr√≠tico</small>
            </button>
          </div>
          <input type="hidden" id="farol" required>
        </div>

        <div class="actions">
          <button type="button" class="btn btn-secondary" onclick="voltarMenu()">
            ‚Üê Voltar
          </button>
          <button type="submit" class="btn btn-primary">
            üíæ Salvar Atualiza√ß√£o
          </button>
        </div>
      </form>
    </div>
  </div>
</main>

<footer>
  ERP √çMPAR ¬© 2026 ‚Äî Sistema de Gest√£o √† Vista
</footer>

<script>
  // Configura√ß√£o da API
  const API_BASE = 'https://api.erpimpar.com.br/tv';

  // ===== Logged user (ERP √çMPAR) ‚Äî vers√£o √öNICA (sem duplicar) =====
  function getLoggedUser(){
    const candidates = [];

    // prioridade: ERPIMPAR_USER (local e session)
    const primaryKey = "ERPIMPAR_USER";
    const rawPrimary = (localStorage.getItem(primaryKey) || sessionStorage.getItem(primaryKey) || "").trim();
    if(rawPrimary) candidates.push(rawPrimary);

    // fallbacks compat√≠veis
    const keys = ["usuarioLogado","impar_user","imparUser","user","ERP_IMPAR_USER","ERPIMPAR_LOGIN"];
    for(const k of keys){
      const raw = (localStorage.getItem(k) || sessionStorage.getItem(k) || "").trim();
      if(raw) candidates.push(raw);
    }

    for(const raw of candidates){
      try{
        const u = JSON.parse(raw);
        const nome  = (u.Nome || u.nome || u.name || u.userName || u.usuario || u.usuarioNome || "").toString().trim();
        const email = (u.Email || u.email || u.mail || u.userEmail || u.usuarioEmail || "").toString().trim();
        if(nome || email) return { nome: nome || "Usu√°rio", email: email || "‚Äî" };
      }catch(e){
        if(raw.includes("@")) return { nome:"Usu√°rio", email: raw };
      }
    }

    // √∫ltimo fallback simples
    const nome2  = (localStorage.getItem("usuarioNome")  || "").trim();
    const email2 = (localStorage.getItem("usuarioEmail") || "").trim();
    return { nome: nome2 || "", email: email2 || "" };
  }

  // Carregar usu√°rio logado + projetos
  window.addEventListener('DOMContentLoaded', () => {
    document.body.classList.add('impar-enter');

    const u = getLoggedUser();
    document.getElementById('usuarioNome').textContent = u.nome || "‚Äî";
    document.getElementById('usuarioEmail').textContent = u.email || "‚Äî";

    // Mant√©m compatibilidade com outros m√≥dulos
    localStorage.setItem("usuarioNome", u.nome || "");
    localStorage.setItem("usuarioEmail", u.email || "");

    carregarProjetos();
  });

  // Carregar lista de projetos
  async function carregarProjetos() {
    try {
      const response = await fetch(`${API_BASE}/listar.php?t=${Date.now()}`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);

      const data = await response.json();

      if (data.success && data.data && Array.isArray(data.data.projetos)) {
        const projetos = data.data.projetos;
        const select = document.getElementById('projeto');
        select.innerHTML = '<option value="">Selecione um projeto</option>';

        projetos.forEach(proj => {
          const option = document.createElement('option');
          option.value = proj.id;
          option.textContent = `${proj.nome} (${proj.coordenador})`;
          option.dataset.coordenador = proj.coordenador || "";
          select.appendChild(option);
        });

      } else {
        throw new Error('Formato inv√°lido da API');
      }
    } catch (error) {
      console.error('Erro ao carregar projetos:', error);
      const select = document.getElementById('projeto');
      select.innerHTML = '<option value="">Erro ao carregar projetos</option>';

      Swal.fire({
        icon: 'error',
        title: 'Erro',
        text: 'N√£o foi poss√≠vel carregar a lista de projetos. Verifique a conex√£o com a API.'
      });
    }
  }

  // Selecionar farol
  let farolSelecionado = '';
  function selecionarFarol(cor) {
    document.querySelectorAll('.farol-btn').forEach(btn => btn.classList.remove('active'));
    const btn = document.querySelector(`.farol-btn.${cor}`);
    if (btn) btn.classList.add('active');
    document.getElementById('farol').value = cor;
    farolSelecionado = cor;
  }

  // Enviar formul√°rio
  document.getElementById('formProjeto').addEventListener('submit', async (e) => {
    e.preventDefault();

    const projetoId = document.getElementById('projeto').value;
    const status = document.getElementById('status').value;
    const execucao = document.querySelector('input[name="execucao"]:checked')?.value || '';
    const farol = document.getElementById('farol').value;

    if (!projetoId || !status || !execucao || !farol) {
      Swal.fire({
        icon: 'warning',
        title: 'Aten√ß√£o',
        text: 'Preencha todos os campos obrigat√≥rios'
      });
      return;
    }

    const opt = document.querySelector(`#projeto option[value="${projetoId}"]`);
    const coordenador = opt?.dataset?.coordenador || "";

    const u = getLoggedUser();
    const usuario = (u.nome || "").trim();

    if (!usuario) {
      Swal.fire({
        icon: 'warning',
        title: 'Login n√£o identificado',
        text: 'Fa√ßa login no ERP √çMPAR antes de atualizar o projeto.'
      });
      return;
    }

    try {
      const response = await fetch(`${API_BASE}/atualizar.php`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          projeto_id: parseInt(projetoId, 10),
          status,
          execucao,
          farol,
          coordenador,
          usuario_atualizacao: usuario
        })
      });

      const data = await response.json();

      if (data.success) {
        await Swal.fire({
          icon: 'success',
          title: 'Sucesso!',
          text: 'Projeto atualizado com sucesso',
          timer: 2000
        });

        document.getElementById('formProjeto').reset();
        farolSelecionado = '';
        document.querySelectorAll('.farol-btn').forEach(btn => btn.classList.remove('active'));

      } else {
        throw new Error(data.error || 'Erro desconhecido');
      }
    } catch (error) {
      console.error('Erro:', error);
      Swal.fire({
        icon: 'error',
        title: 'Erro',
        text: 'N√£o foi poss√≠vel salvar a atualiza√ß√£o'
      });
    }
  });

  function voltarMenu() {
    window.location.href = '../menu.html';
  }
</script>

</body>
</html>
