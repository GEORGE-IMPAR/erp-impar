<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ERP √çMPAR ‚Äî Gest√£o √† Vista TV</title>
  <style>
    :root{
      --bg1:#0b1e4a;
      --bg2:#0e3b6e;
      --bg3:#0f766e;
      --text: #e5e7eb;
      --green:#22c55e;
      --yellow:#facc15;
      --red:#ef4444;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow:hidden}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background:linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3));
      display:flex;
      flex-direction:column;
    }

    header{
      padding:16px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:rgba(2,6,23,.85);
      border-bottom:2px solid rgba(34,197,94,.3);
      flex-shrink:0;
      position:relative;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo-orb{
      width:42px;height:42px;border-radius:999px;
      position:relative;
      background: conic-gradient(from 210deg,#22c55e,#06b6d4,#3b82f6,#a855f7,#f97316,#22c55e);
      box-shadow:0 10px 22px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.18) inset;
      overflow:hidden;
    }
    .logo-orb:before{
      content:""; position:absolute; inset:-6px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 55%);
    }
    .brand-text{display:flex; flex-direction:column; gap:1px;}
    .brand-kicker{font-size:11px; letter-spacing:.22em; text-transform:uppercase; font-weight:800; opacity:.9;}
    .brand-title{font-size:24px; font-weight:900; line-height:1;}
    .brand-sub{font-size:15px; font-weight:800; opacity:.92;}

    .header-info{
      text-align:right;
      font-size:13px;
    }
    .header-info strong{
      display:block;
      font-size:16px;
      color:var(--green);
      margin-bottom:4px;
    }
    .relogio{
      font-size:28px;
      font-weight:900;
      font-variant-numeric:tabular-nums;
    }

    .ultima-sync{
      position:absolute;
      top:16px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(34,197,94,.15);
      border:1px solid rgba(34,197,94,.4);
      padding:8px 16px;
      border-radius:999px;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
      animation:pulseSync 2s ease-in-out infinite;
      white-space:nowrap;
    }
    @keyframes pulseSync{
      0%, 100%{opacity:.9; transform:translateX(-50%) scale(1);}
      50%{opacity:1; transform:translateX(-50%) scale(1.02);}
    }

    .btn-fullscreen{
      position:fixed;
      bottom:20px;
      right:20px;
      background:var(--green);
      color:#000;
      border:none;
      padding:14px 24px;
      border-radius:12px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(34,197,94,.4);
      transition:all .3s;
      z-index:9999;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn-fullscreen:hover{
      transform:scale(1.05);
      box-shadow:0 12px 30px rgba(34,197,94,.6);
    }
    .btn-fullscreen.hide{ display:none; }

    main{
      flex:1;
      overflow-y:auto;
      padding:24px;
      display:flex;
      justify-content:center;
    }

    .container{ width:100%; max-width:1400px; }

    .projetos-grid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      grid-template-rows:repeat(2, 1fr);
      gap:20px;
    }

    .projeto-card{
      padding:24px;
      border-radius:16px;
      border:2px solid rgba(148,163,184,.4);
      background:rgba(2,6,23,.75);
      box-shadow:0 10px 30px rgba(0,0,0,.4);
      position:relative;
      transition:all .3s;
      min-height: 240px;
    }

    .projeto-card.atualizado{
      animation:destaque 2.6s ease-out;
      border-color:var(--green);
      box-shadow:0 0 40px rgba(34,197,94,.65), 0 10px 30px rgba(0,0,0,.4);
    }
    @keyframes destaque{
      0%, 100%{transform:scale(1);}
      50%{transform:scale(1.02);}
    }

    .projeto-card.desatualizado{
      border-color: rgba(239,68,68,.95);
      box-shadow: 0 0 38px rgba(239,68,68,.55), 0 10px 30px rgba(0,0,0,.4);
      animation: stalePulse 1.4s ease-in-out infinite;
    }
    @keyframes stalePulse{
      0%,100%{transform:scale(1); filter:brightness(1);}
      50%{transform:scale(1.01); filter:brightness(1.08);}
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:16px;
    }
    .card-titulo{
      font-size:22px;
      font-weight:900;
      color:#fff;
      line-height:1.2;
    }

    .farol{
      width:50px;height:50px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      font-size:32px;flex-shrink:0;
      animation:pulse 2s ease-in-out infinite;
    }
    .farol.verde{
      background:radial-gradient(circle, rgba(34,197,94,.25), transparent);
      box-shadow:0 0 25px rgba(34,197,94,.5);
    }
    .farol.amarelo{
      background:radial-gradient(circle, rgba(250,204,21,.25), transparent);
      box-shadow:0 0 25px rgba(250,204,21,.5);
    }
    .farol.vermelho{
      background:radial-gradient(circle, rgba(239,68,68,.25), transparent);
      box-shadow:0 0 25px rgba(239,68,68,.5);
    }
    @keyframes pulse{
      0%, 100%{transform:scale(1); opacity:1;}
      50%{transform:scale(1.08); opacity:.85;}
    }

    .card-info{ display:flex; gap:12px; margin-bottom:14px; }
    .info-badge{
      flex:1; padding:8px 10px; border-radius:8px;
      background:rgba(15,23,42,.6);
      border:1px solid rgba(148,163,184,.2);
      font-size:11px;
    }
    .info-badge-label{
      text-transform:uppercase;
      letter-spacing:.05em;
      opacity:.7;
      margin-bottom:3px;
    }
    .info-badge-value{ font-size:14px; font-weight:700; }

    .card-status{
      padding:14px;border-radius:10px;
      background:linear-gradient(135deg, rgba(2,6,23,.6), rgba(15,118,110,.1));
      border:1px solid rgba(34,197,94,.2);
      margin-bottom:12px;min-height:70px;
    }
    .status-label{
      font-size:10px;text-transform:uppercase;
      letter-spacing:.08em;color:var(--green);
      margin-bottom:6px;font-weight:800;
    }
    .status-text{
      font-size:14px;line-height:1.4;color:#fff;
      word-break:break-word;
    }

    .card-footer{
      display:flex;justify-content:space-between;align-items:center;
      padding-top:10px;border-top:1px solid rgba(148,163,184,.15);
      font-size:11px;opacity:.8;
    }
    .footer-user{ font-weight:700; color:var(--green); }

    .badge-novo{
      position:absolute; top:-8px; right:-8px;
      background:var(--green); color:#000;
      padding:4px 12px; border-radius:999px;
      font-size:10px; font-weight:900;
      text-transform:uppercase; letter-spacing:.05em;
      box-shadow:0 4px 12px rgba(34,197,94,.4);
      animation:badgePulse 1.5s ease-in-out infinite;
    }
    .badge-stale{
      position:absolute; top:-8px; right:-8px;
      background:rgba(239,68,68,.98); color:#000;
      padding:4px 12px; border-radius:999px;
      font-size:10px; font-weight:1000;
      text-transform:uppercase; letter-spacing:.05em;
      box-shadow:0 0 22px rgba(239,68,68,.55);
      animation:badgePulse 1.1s ease-in-out infinite;
    }
    @keyframes badgePulse{
      0%, 100%{transform:scale(1);}
      50%{transform:scale(1.1);}
    }

    .loading{
      text-align:center;
      padding:60px;
      font-size:20px;
      opacity:.7;
    }

    footer{
      padding:10px;
      text-align:center;
      font-size:11px;
      opacity:.6;
      background:rgba(2,6,23,.5);
      flex-shrink:0;
    }

    main::-webkit-scrollbar{ width:10px; }
    main::-webkit-scrollbar-track{ background:rgba(15,23,42,.3); }
    main::-webkit-scrollbar-thumb{ background:rgba(34,197,94,.4); border-radius:5px; }
    main::-webkit-scrollbar-thumb:hover{ background:rgba(34,197,94,.6); }

    .slide-out{ animation:slideOut .55s ease-in forwards; }
    .slide-in{ animation:slideIn .55s ease-out forwards; }
    @keyframes slideOut{
      from{ transform:translateX(0); opacity:1; }
      to{ transform:translateX(-60px); opacity:0; }
    }
    @keyframes slideIn{
      from{ transform:translateX(60px); opacity:0; }
      to{ transform:translateX(0); opacity:1; }
    }

    /* ===== AVISO (tela inteira) ===== */
    .projetos-grid.aviso-mode{
      grid-template-columns: 1fr !important;
      grid-template-rows: 1fr !important;
    }
    .aviso-full{
      width: 100%;
      min-height: calc(100vh - 150px);
      border-radius: 22px;
      border: 4px solid rgba(239,68,68,.88);
      background:
        radial-gradient(circle at 20% 20%, rgba(239,68,68,.20), transparent 45%),
        radial-gradient(circle at 80% 20%, rgba(250,204,21,.14), transparent 45%),
        linear-gradient(135deg, rgba(2,6,23,.92), rgba(15,118,110,.18));
      box-shadow: 0 0 60px rgba(239,68,68,.38), 0 18px 50px rgba(0,0,0,.55);
      display:flex;
      flex-direction:column;
      justify-content:center;
      padding: 40px;
      position:relative;
      overflow:hidden;
      animation: stalePulse 1.4s ease-in-out infinite;
    }
    .aviso-badge{
      position:absolute;
      top:18px;
      right:18px;
      background: rgba(239,68,68,.98);
      color:#000;
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 1000;
      letter-spacing:.06em;
      text-transform: uppercase;
      box-shadow: 0 0 22px rgba(239,68,68,.55);
    }
    .aviso-title{
      font-size: 56px;
      line-height:1.05;
      font-weight: 1000;
      color:#fff;
      text-shadow: 0 10px 22px rgba(0,0,0,.55);
      margin-bottom: 16px;
    }
    .aviso-sub{
      font-size: 28px;
      opacity:.96;
      max-width: 1200px;
      line-height:1.35;
    }
    .aviso-hint{
      margin-top: 22px;
      font-size: 18px;
      opacity:.75;
    }
  </style>
</head>
<body>

<button class="btn-fullscreen" id="btnFullscreen" onclick="ativarFullscreen()">
  üñ•Ô∏è Ativar Tela Cheia
</button>

<header>
  <div class="brand">
    <div class="logo-orb"></div>
    <div class="brand-text">
      <div class="brand-kicker">ERP</div>
      <div class="brand-title">√çMPAR</div>
      <div class="brand-sub">Gest√£o √† Vista</div>
    </div>
  </div>

  <div class="ultima-sync" id="ultimaSync">
    üîÑ Sincronizando...
  </div>

  <div class="header-info">
    <strong id="dataAtual">‚Äî</strong>
    <div class="relogio" id="relogio">00:00:00</div>
  </div>
</header>

<main>
  <div class="container">
    <div class="projetos-grid" id="projetosGrid">
      <div class="loading">üìä Carregando projetos...</div>
    </div>
  </div>
</main>

<footer>
  ERP √çMPAR ¬© 2026 ‚Äî Atualiza√ß√£o autom√°tica a cada 10 segundos
</footer>

<script>
/* =========================
   CONFIG (F√ÅCIL DE MEXER)
   ========================= */
const API_BASE = 'https://api.erpimpar.com.br/tv';

const PAGE_SIZE = 6;

// ‚è±Ô∏è tempo para trocar ‚Äúslide‚Äù dos cards
const PAGE_INTERVAL_MS = 30000; // 30s

// ‚è±Ô∏è dura√ß√£o do aviso (tela inteira)
const AVISO_DURATION_MS = 15000;

// üìÖ dias: segunda(1) e sexta(5)
const AVISO_DAYS = new Set([1,5]);

// ‚è≤Ô∏è intervalo ALEAT√ìRIO entre avisos, mas GARANTINDO que aparece nesses dias
// Ex.: a cada 6‚Äì12 minutos ele aparece 1 vez (em momento aleat√≥rio)
const AVISO_REPEAT_MINUTES_MIN = 6;
const AVISO_REPEAT_MINUTES_MAX = 12;

// ‚õî stale (>= 1 dia)
const STALE_AFTER_DAYS = 1;

// üîî bip discreto
const AVISO_BEEP_ENABLED = true;


/* =========================
   ESTADO
   ========================= */
let projetosAtuais = [];
let ultimaAtualizacaoGlobal = null;
let ultimaAtualizacaoUsuario = null;

let pageIndex = 0;
let pageTimer = null;

let highlightProjectId = null;
let highlightUntilTs = 0;

// trava para n√£o re-enfatizar a mesma atualiza√ß√£o
let lastSeenGlobalUpdateTs = 0;
let lastHighlightUpdateKey = "";

// aviso
let isShowingAviso = false;
let avisoTimer = null;
let avisoScheduleTimer = null;


/* =========================
   INIT
   ========================= */
window.addEventListener('DOMContentLoaded', () => {
  atualizarRelogio();
  setInterval(atualizarRelogio, 1000);

  carregarProjetos();
  setInterval(carregarProjetos, 10000);

  iniciarPager();

  // ‚úÖ agenda do aviso: garante que aparece seg/sex (em momentos aleat√≥rios)
  iniciarAgendaAviso();

  verificarFullscreen();
  document.addEventListener('fullscreenchange', verificarFullscreen);
  document.addEventListener('webkitfullscreenchange', verificarFullscreen);
  document.addEventListener('mozfullscreenchange', verificarFullscreen);
  document.addEventListener('MSFullscreenChange', verificarFullscreen);
});

function ativarFullscreen() {
  const elem = document.documentElement;
  if (elem.requestFullscreen) elem.requestFullscreen();
  else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
  else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
  else if (elem.mozRequestFullScreen) elem.mozRequestFullScreen();
}

function verificarFullscreen() {
  const isFullscreen =
    document.fullscreenElement ||
    document.webkitFullscreenElement ||
    document.mozFullScreenElement ||
    document.msFullscreenElement;

  const btn = document.getElementById('btnFullscreen');
  if (isFullscreen) btn.classList.add('hide');
  else btn.classList.remove('hide');
}

function atualizarRelogio() {
  const agora = new Date();
  const data = agora.toLocaleDateString('pt-BR', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
  const hora = agora.toLocaleTimeString('pt-BR');

  document.getElementById('dataAtual').textContent = data.charAt(0).toUpperCase() + data.slice(1);
  document.getElementById('relogio').textContent = hora;
}

function parseDataBR(dataStr) {
  if (!dataStr || typeof dataStr !== 'string') return null;
  const partes = dataStr.split(' ');
  if (partes.length !== 2) return null;

  const [dataParte, horaParte] = partes;
  const [ano, mes, dia] = dataParte.split('-');
  const [hora, min, seg] = horaParte.split(':');

  return new Date(
    parseInt(ano,10),
    parseInt(mes,10) - 1,
    parseInt(dia,10),
    parseInt(hora,10),
    parseInt(min,10),
    parseInt(seg,10)
  );
}

/* =========================
   PAGER
   ========================= */
function iniciarPager() {
  if (pageTimer) clearInterval(pageTimer);
  pageTimer = setInterval(() => {
    if (isShowingAviso) return;

    const totalPages = Math.max(1, Math.ceil(projetosAtuais.length / PAGE_SIZE));
    if (totalPages <= 1) return;

    const next = (pageIndex + 1) % totalPages;
    setPage(next, true);
  }, PAGE_INTERVAL_MS);
}

function setPage(newIndex, animate) {
  const totalPages = Math.max(1, Math.ceil(projetosAtuais.length / PAGE_SIZE));
  if (totalPages <= 1) {
    pageIndex = 0;
    renderizarProjetos(new Set(), false);
    return;
  }

  pageIndex = Math.max(0, Math.min(newIndex, totalPages - 1));
  renderizarProjetos(new Set(), animate);
}

/* =========================
   AVISO: agenda garantida seg/sex
   ========================= */
function isAvisoDay() {
  const d = new Date();
  return AVISO_DAYS.has(d.getDay());
}

function randInt(min, max){
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function iniciarAgendaAviso(){
  // limpa timers antigos
  if (avisoScheduleTimer) clearTimeout(avisoScheduleTimer);

  // replaneja a cada 60s (se virar dia, pega)
  setInterval(() => {
    if (!isAvisoDay()) return;
    // se n√£o existe agenda ativa, cria
    if (!avisoScheduleTimer) agendarProximoAviso();
  }, 60000);

  // se j√° √© dia de aviso, agenda agora
  if (isAvisoDay()) agendarProximoAviso();
}

function agendarProximoAviso(){
  // se n√£o √© dia, n√£o agenda
  if (!isAvisoDay()){
    avisoScheduleTimer = null;
    return;
  }

  // se j√° est√° mostrando aviso, tenta depois
  if (isShowingAviso){
    avisoScheduleTimer = setTimeout(agendarProximoAviso, 30000);
    return;
  }

  // agenda com atraso aleat√≥rio dentro do intervalo
  const mins = randInt(AVISO_REPEAT_MINUTES_MIN, AVISO_REPEAT_MINUTES_MAX);
  const delayMs = mins * 60 * 1000;

  avisoScheduleTimer = setTimeout(() => {
    avisoScheduleTimer = null; // libera para agendar o pr√≥ximo ap√≥s exibir

    // se virou dia e n√£o √© mais seg/sex, para
    if (!isAvisoDay()) return;

    showAvisoForDuration(AVISO_DURATION_MS);

    // ap√≥s mostrar, agenda o pr√≥ximo (garante que aparece sempre nesse dia)
    setTimeout(() => {
      agendarProximoAviso();
    }, 2000);

  }, delayMs);
}

function showAvisoForDuration(durationMs) {
  isShowingAviso = true;

  renderAvisoSlide(true);

  if (avisoTimer) clearTimeout(avisoTimer);
  avisoTimer = setTimeout(() => {
    isShowingAviso = false;
    renderizarProjetos(new Set(), true);
  }, Math.max(4000, durationMs));
}

function renderAvisoSlide(animate){
  const grid = document.getElementById('projetosGrid');

  const doRender = () => {
    grid.classList.add("aviso-mode");
    grid.innerHTML = `
      <div class="aviso-full">
        <div class="aviso-badge">ATEN√á√ÉO ‚Ä¢ VIAGENS</div>

        <div class="aviso-title">Time de Obras: Planejamento de Viagens</div>

        <div class="aviso-sub">
          Entrega do planejamento de viagens para o <b>RH</b> toda <b>Segunda-feira</b>.
          <br/><br/>
          <b>Refor√ßo:</b> revisar e alinhar a programa√ß√£o tamb√©m na <b>Sexta-feira</b>.
        </div>

        <div class="aviso-hint">‚úÖ Slide obrigat√≥rio (Seg &amp; Sex) ‚Ä¢ aparece em momentos aleat√≥rios no dia</div>
      </div>
    `;
  };

  if (!animate){
    doRender();
    playAvisoBeep();
    return;
  }

  grid.classList.remove('slide-in');
  grid.classList.add('slide-out');

  setTimeout(() => {
    grid.classList.remove('slide-out');
    doRender();
    playAvisoBeep();
    grid.classList.add('slide-in');
    setTimeout(() => grid.classList.remove('slide-in'), 600);
  }, 560);
}

function playAvisoBeep(){
  if (!AVISO_BEEP_ENABLED) return;
  try{
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if(!AudioCtx) return;
    const ctx = new AudioCtx();

    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.value = 880;
    g.gain.value = 0.0001;

    o.connect(g);
    g.connect(ctx.destination);

    const t = ctx.currentTime;
    g.gain.setValueAtTime(0.0001, t);
    g.gain.linearRampToValueAtTime(0.06, t + 0.02);
    g.gain.linearRampToValueAtTime(0.0001, t + 0.18);

    o.start(t);
    o.stop(t + 0.2);

    o.onended = () => { try{ ctx.close(); }catch(e){} };
  }catch(e){}
}

/* =========================
   API LOAD
   ========================= */
async function carregarProjetos() {
  try {
    const response = await fetch(`${API_BASE}/listar.php?t=${Date.now()}`);
    const data = await response.json();

    if (data.success && data.data && Array.isArray(data.data.projetos) && data.data.projetos.length > 0) {
      const projetosNovosRaw = data.data.projetos;

      const projetosNovos = projetosNovosRaw.map(p => ({ ...p, _id: String(p.id) }));
      const antigos = projetosAtuais.map(p => ({ ...p, _id: String(p._id ?? p.id) }));

      let maisRecente = null;
      let maisRecenteTs = -1;

      projetosNovos.forEach(p => {
        const d = parseDataBR(p.data_atualizacao);
        if (!d) return;
        const ts = d.getTime();
        if (ts > maisRecenteTs) {
          maisRecenteTs = ts;
          maisRecente = p;
        }
      });

      if (maisRecente && maisRecenteTs > 0) {
        ultimaAtualizacaoGlobal = new Date(maisRecenteTs);
        ultimaAtualizacaoUsuario = (maisRecente.usuario_atualizacao || '').trim() || 'Sistema';
      }

      const projetosAtualizados = detectarAtualizacoesNorm(projetosNovos, antigos);
      projetosAtuais = projetosNovos;

      // ‚úÖ s√≥ destaca se √© atualiza√ß√£o NOVA (n√£o repete sempre)
      if (maisRecente && maisRecenteTs > 0) {
        const updateKey = `${String(maisRecente._id)}|${String(maisRecente.data_atualizacao || "")}`;
        const isNewGlobalUpdate = (maisRecenteTs > lastSeenGlobalUpdateTs);
        const isNotRepeatedKey  = (updateKey !== lastHighlightUpdateKey);

        if (isNewGlobalUpdate && isNotRepeatedKey) {
          lastSeenGlobalUpdateTs = maisRecenteTs;
          lastHighlightUpdateKey = updateKey;

          highlightProjectId = String(maisRecente._id);
          highlightUntilTs = Date.now() + 15000;

          const idx = projetosAtuais.findIndex(p => String(p._id) === String(maisRecente._id));
          if (idx >= 0) pageIndex = Math.floor(idx / PAGE_SIZE);
        } else {
          highlightProjectId = null;
          highlightUntilTs = 0;
        }
      }

      if (!isShowingAviso) renderizarProjetos(projetosAtualizados, false);
      atualizarBadgeSync();

    } else {
      document.getElementById('projetosGrid').innerHTML = '<div class="loading">üì≠ Nenhum projeto cadastrado</div>';
    }
  } catch (error) {
    console.error('Erro ao carregar projetos:', error);
    document.getElementById('projetosGrid').innerHTML = '<div class="loading">‚ö†Ô∏è Erro ao carregar projetos</div>';
  }
}

function detectarAtualizacoesNorm(projetosNovos, projetosAntigos) {
  const atualizados = new Set();

  const mapOld = new Map();
  projetosAntigos.forEach(p => mapOld.set(String(p._id), p));

  projetosNovos.forEach(novo => {
    const old = mapOld.get(String(novo._id));
    if (!old) { atualizados.add(String(novo._id)); return; }
    if (String(novo.data_atualizacao || "") !== String(old.data_atualizacao || "")) {
      atualizados.add(String(novo._id));
    }
  });

  return atualizados;
}

/* =========================
   RENDER
   ========================= */
function renderizarProjetos(projetosAtualizados, animate) {
  const grid = document.getElementById('projetosGrid');
  grid.classList.remove("aviso-mode");

  const farolEmoji = {'verde':'üü¢','amarelo':'üü°','vermelho':'üî¥'};

  const totalPages = Math.max(1, Math.ceil(projetosAtuais.length / PAGE_SIZE));
  if (pageIndex >= totalPages) pageIndex = 0;

  const start = pageIndex * PAGE_SIZE;
  const slice = projetosAtuais.slice(start, start + PAGE_SIZE);

  const doRender = () => {
    const agoraTs = Date.now();

    const html = slice.map(projeto => {
      const dataAtualizada = parseDataBR(projeto.data_atualizacao);
      if (!dataAtualizada) return '';

      const diffMs = Date.now() - dataAtualizada.getTime();
      const diffMins = Math.floor(diffMs / 60000);
      const diffHoras = Math.floor(diffMins / 60);
      const diffDias = Math.floor(diffHoras / 24);

      let tempoRelativo;
      if (diffMins < 1) tempoRelativo = 'Agora mesmo';
      else if (diffMins < 60) tempoRelativo = `h√° ${diffMins} min`;
      else if (diffHoras < 24) tempoRelativo = `h√° ${diffHoras}h`;
      else tempoRelativo = `h√° ${diffDias} dia${diffDias > 1 ? 's' : ''}`;

      const dataFormatada = dataAtualizada.toLocaleString('pt-BR', {
        day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'
      });

      const pid = String(projeto._id ?? projeto.id);

      const foiAtualizado = projetosAtualizados.has(pid);
      const estaEmDestaque = (String(highlightProjectId) === pid) && (agoraTs < highlightUntilTs);

      const isStale = diffDias >= STALE_AFTER_DAYS;

      const classAtualizado = (foiAtualizado || estaEmDestaque) ? 'atualizado' : '';
      const classStale = isStale ? 'desatualizado' : '';

      const badgeAtualizado = (foiAtualizado || estaEmDestaque)
        ? '<div class="badge-novo">Atualizado!</div>'
        : '';

      const badgeStale = isStale
        ? '<div class="badge-stale">Falta atualiza√ß√£o!</div>'
        : '';

      const badgeFinal = isStale ? badgeStale : badgeAtualizado;

      return `
        <div class="projeto-card ${classAtualizado} ${classStale}">
          ${badgeFinal}
          <div class="card-header">
            <h2 class="card-titulo">${projeto.nome || ''}</h2>
            <div class="farol ${projeto.farol || ''}">
              ${farolEmoji[projeto.farol] || '‚ö™'}
            </div>
          </div>

          <div class="card-info">
            <div class="info-badge">
              <div class="info-badge-label">üë∑ Coordenador</div>
              <div class="info-badge-value">${projeto.coordenador || '‚Äî'}</div>
            </div>
            <div class="info-badge">
              <div class="info-badge-label">üîß Execu√ß√£o</div>
              <div class="info-badge-value">${projeto.execucao || '‚Äî'}</div>
            </div>
          </div>

          <div class="card-status">
            <div class="status-label">üìä Status Atual</div>
            <div class="status-text">${projeto.status || ''}</div>
          </div>

          <div class="card-footer">
            <div>
              <span class="footer-user">üïê ${tempoRelativo}</span>
              <div style="font-size:10px;opacity:.7;margin-top:2px">${dataFormatada}</div>
            </div>
            <div>
              <span class="footer-user">${(projeto.usuario_atualizacao || 'Sistema')}</span>
            </div>
          </div>
        </div>
      `;
    }).join('');

    grid.innerHTML = html || '<div class="loading">üì≠ Nenhum projeto cadastrado</div>';

    if (projetosAtualizados.size > 0) {
      setTimeout(() => {
        document.querySelectorAll('.badge-novo').forEach(b => {
          b.style.animation = 'none';
          b.style.opacity = '0';
          setTimeout(() => b.remove(), 250);
        });
      }, 6000);
    }
  };

  if (!animate) { doRender(); return; }

  grid.classList.remove('slide-in');
  grid.classList.add('slide-out');

  setTimeout(() => {
    grid.classList.remove('slide-out');
    doRender();
    grid.classList.add('slide-in');
    setTimeout(() => grid.classList.remove('slide-in'), 600);
  }, 560);
}

function atualizarBadgeSync() {
  const badge = document.getElementById('ultimaSync');

  if (ultimaAtualizacaoGlobal) {
    const dataFormatada = ultimaAtualizacaoGlobal.toLocaleString('pt-BR', {
      day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'
    });

    const usuario = (ultimaAtualizacaoUsuario || 'Sistema');

    badge.innerHTML = `‚úÖ √öltima atualiza√ß√£o: ${dataFormatada} ‚Äî ${usuario}`;
    badge.style.background = 'rgba(34,197,94,.2)';
    badge.style.borderColor = 'rgba(34,197,94,.5)';

    setTimeout(() => {
      badge.style.background = 'rgba(34,197,94,.15)';
      badge.style.borderColor = 'rgba(34,197,94,.4)';
    }, 2000);
  } else {
    badge.innerHTML = 'üîÑ Aguardando dados...';
  }
}
</script>

</body>
</html>
