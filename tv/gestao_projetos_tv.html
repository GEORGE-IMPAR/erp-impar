<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ERP √çMPAR ‚Äî Gest√£o √† Vista TV</title>
  <style>
    :root{
      --bg1:#0b1e4a;
      --bg2:#0e3b6e;
      --bg3:#0f766e;
      --text: #e5e7eb;
      --green:#22c55e;
      --yellow:#facc15;
      --red:#ef4444;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow:hidden}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background:linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3));
      display:flex;
      flex-direction:column;
    }

    header{
      padding:16px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:rgba(2,6,23,.85);
      border-bottom:2px solid rgba(34,197,94,.3);
      flex-shrink:0;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo-orb{
      width:42px;height:42px;border-radius:999px;
      position:relative;
      background: conic-gradient(from 210deg,#22c55e,#06b6d4,#3b82f6,#a855f7,#f97316,#22c55e);
      box-shadow:0 10px 22px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.18) inset;
      overflow:hidden;
    }
    .logo-orb:before{
      content:""; position:absolute; inset:-6px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 55%);
    }
    .brand-text{display:flex; flex-direction:column; gap:1px;}
    .brand-kicker{font-size:11px; letter-spacing:.22em; text-transform:uppercase; font-weight:800; opacity:.9;}
    .brand-title{font-size:24px; font-weight:900; line-height:1;}
    .brand-sub{font-size:15px; font-weight:800; opacity:.92;}

    .header-info{
      text-align:right;
      font-size:13px;
    }
    .header-info strong{
      display:block;
      font-size:16px;
      color:var(--green);
      margin-bottom:4px;
    }
    .relogio{
      font-size:28px;
      font-weight:900;
      font-variant-numeric:tabular-nums;
    }

    .ultima-sync{
      position:absolute;
      top:16px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(34,197,94,.15);
      border:1px solid rgba(34,197,94,.4);
      padding:8px 16px;
      border-radius:999px;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
      animation:pulseSync 2s ease-in-out infinite;
    }
    @keyframes pulseSync{
      0%, 100%{opacity:.9; transform:translateX(-50%) scale(1);}
      50%{opacity:1; transform:translateX(-50%) scale(1.02);}
    }

    .btn-fullscreen{
      position:fixed;
      bottom:20px;
      right:20px;
      background:var(--green);
      color:#000;
      border:none;
      padding:14px 24px;
      border-radius:12px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(34,197,94,.4);
      transition:all .3s;
      z-index:9999;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn-fullscreen:hover{
      transform:scale(1.05);
      box-shadow:0 12px 30px rgba(34,197,94,.6);
    }
    .btn-fullscreen.hide{
      display:none;
    }

    main{
      flex:1;
      overflow-y:auto;
      padding:24px;
      display:flex;
      justify-content:center;
    }

    .container{
      width:100%;
      max-width:1400px;
    }

    .projetos-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(380px, 1fr));
      gap:20px;
    }

    .projeto-card{
      padding:24px;
      border-radius:16px;
      border:2px solid rgba(148,163,184,.4);
      background:rgba(2,6,23,.75);
      box-shadow:0 10px 30px rgba(0,0,0,.4);
      position:relative;
      transition:all .3s;
    }

    .projeto-card.atualizado{
      animation:destaque 2s ease-out;
      border-color:var(--green);
      box-shadow:0 0 30px rgba(34,197,94,.5), 0 10px 30px rgba(0,0,0,.4);
    }

    @keyframes destaque{
      0%, 100%{transform:scale(1);}
      50%{transform:scale(1.02);}
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:16px;
    }

    .card-titulo{
      font-size:22px;
      font-weight:900;
      color:#fff;
      line-height:1.2;
    }

    .farol{
      width:50px;
      height:50px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:32px;
      flex-shrink:0;
      animation:pulse 2s ease-in-out infinite;
    }
    .farol.verde{
      background:radial-gradient(circle, rgba(34,197,94,.25), transparent);
      box-shadow:0 0 25px rgba(34,197,94,.5);
    }
    .farol.amarelo{
      background:radial-gradient(circle, rgba(250,204,21,.25), transparent);
      box-shadow:0 0 25px rgba(250,204,21,.5);
    }
    .farol.vermelho{
      background:radial-gradient(circle, rgba(239,68,68,.25), transparent);
      box-shadow:0 0 25px rgba(239,68,68,.5);
    }

    @keyframes pulse{
      0%, 100%{transform:scale(1); opacity:1;}
      50%{transform:scale(1.08); opacity:.85;}
    }

    .card-info{
      display:flex;
      gap:12px;
      margin-bottom:14px;
    }
    .info-badge{
      flex:1;
      padding:8px 10px;
      border-radius:8px;
      background:rgba(15,23,42,.6);
      border:1px solid rgba(148,163,184,.2);
      font-size:11px;
    }
    .info-badge-label{
      text-transform:uppercase;
      letter-spacing:.05em;
      opacity:.7;
      margin-bottom:3px;
    }
    .info-badge-value{
      font-size:14px;
      font-weight:700;
    }

    .card-status{
      padding:14px;
      border-radius:10px;
      background:linear-gradient(135deg, rgba(2,6,23,.6), rgba(15,118,110,.1));
      border:1px solid rgba(34,197,94,.2);
      margin-bottom:12px;
      min-height:70px;
    }
    .status-label{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--green);
      margin-bottom:6px;
      font-weight:800;
    }
    .status-text{
      font-size:14px;
      line-height:1.4;
      color:#fff;
    }

    .card-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding-top:10px;
      border-top:1px solid rgba(148,163,184,.15);
      font-size:11px;
      opacity:.8;
    }
    .footer-user{
      font-weight:700;
      color:var(--green);
    }

    .badge-novo{
      position:absolute;
      top:-8px;
      right:-8px;
      background:var(--green);
      color:#000;
      padding:4px 12px;
      border-radius:999px;
      font-size:10px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.05em;
      box-shadow:0 4px 12px rgba(34,197,94,.4);
      animation:badgePulse 1.5s ease-in-out infinite;
    }

    @keyframes badgePulse{
      0%, 100%{transform:scale(1);}
      50%{transform:scale(1.1);}
    }

    .loading{
      text-align:center;
      padding:60px;
      font-size:20px;
      opacity:.7;
    }

    footer{
      padding:10px;
      text-align:center;
      font-size:11px;
      opacity:.6;
      background:rgba(2,6,23,.5);
      flex-shrink:0;
    }

    main::-webkit-scrollbar{
      width:10px;
    }
    main::-webkit-scrollbar-track{
      background:rgba(15,23,42,.3);
    }
    main::-webkit-scrollbar-thumb{
      background:rgba(34,197,94,.4);
      border-radius:5px;
    }
    main::-webkit-scrollbar-thumb:hover{
      background:rgba(34,197,94,.6);
    }
  </style>
</head>
<body>

<button class="btn-fullscreen" id="btnFullscreen" onclick="ativarFullscreen()">
  üñ•Ô∏è Ativar Tela Cheia
</button>

<header>
  <div class="brand">
    <div class="logo-orb"></div>
    <div class="brand-text">
      <div class="brand-kicker">ERP</div>
      <div class="brand-title">√çMPAR</div>
      <div class="brand-sub">Gest√£o √† Vista</div>
    </div>
  </div>

  <div class="ultima-sync" id="ultimaSync">
    üîÑ Sincronizando...
  </div>

  <div class="header-info">
    <strong id="dataAtual">‚Äî</strong>
    <div class="relogio" id="relogio">00:00:00</div>
  </div>
</header>

<main>
  <div class="container">
    <div class="projetos-grid" id="projetosGrid">
      <div class="loading">üìä Carregando projetos...</div>
    </div>
  </div>
</main>

<footer>
  ERP √çMPAR ¬© 2026 ‚Äî Atualiza√ß√£o autom√°tica a cada 10 segundos
</footer>

<script>
const API_BASE = 'https://api.erpimpar.com.br/tv';
let projetosAtuais = [];
let ultimaAtualizacaoGlobal = null;

// Inicializar
window.addEventListener('DOMContentLoaded', () => {
  atualizarRelogio();
  setInterval(atualizarRelogio, 1000);
  carregarProjetos();
  setInterval(carregarProjetos, 10000);
  
  verificarFullscreen();
  
  document.addEventListener('fullscreenchange', verificarFullscreen);
  document.addEventListener('webkitfullscreenchange', verificarFullscreen);
  document.addEventListener('mozfullscreenchange', verificarFullscreen);
  document.addEventListener('MSFullscreenChange', verificarFullscreen);
});

// Ativar fullscreen
function ativarFullscreen() {
  const elem = document.documentElement;
  
  if (elem.requestFullscreen) {
    elem.requestFullscreen();
  } else if (elem.webkitRequestFullscreen) {
    elem.webkitRequestFullscreen();
  } else if (elem.msRequestFullscreen) {
    elem.msRequestFullscreen();
  } else if (elem.mozRequestFullScreen) {
    elem.mozRequestFullScreen();
  }
}

// Verificar fullscreen
function verificarFullscreen() {
  const isFullscreen = document.fullscreenElement || 
                       document.webkitFullscreenElement || 
                       document.mozFullScreenElement ||
                       document.msFullscreenElement;
  
  const btn = document.getElementById('btnFullscreen');
  if (isFullscreen) {
    btn.classList.add('hide');
  } else {
    btn.classList.remove('hide');
  }
}

// Rel√≥gio
function atualizarRelogio() {
  const agora = new Date();
  const data = agora.toLocaleDateString('pt-BR', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
  const hora = agora.toLocaleTimeString('pt-BR');
  
  document.getElementById('dataAtual').textContent = data.charAt(0).toUpperCase() + data.slice(1);
  document.getElementById('relogio').textContent = hora;
}

// Converter string de data para objeto Date
function parseDataBR(dataStr) {
  // Formato: "2026-02-18 09:30:00"
  if (!dataStr || typeof dataStr !== 'string') return null;
  
  const partes = dataStr.split(' ');
  if (partes.length !== 2) return null;
  
  const [dataParte, horaParte] = partes;
  const [ano, mes, dia] = dataParte.split('-');
  const [hora, min, seg] = horaParte.split(':');
  
  // Date(ano, mes-1, dia, hora, min, seg)
  return new Date(
    parseInt(ano), 
    parseInt(mes) - 1, 
    parseInt(dia), 
    parseInt(hora), 
    parseInt(min), 
    parseInt(seg)
  );
}

// Carregar projetos da API
async function carregarProjetos() {
  try {
    console.log('üîÑ Carregando projetos da TV...');
    const response = await fetch(`${API_BASE}/listar.php?t=${Date.now()}`);
    const data = await response.json();
    
    console.log('üì¶ Resposta da API:', data);
    
    if (data.success && data.data && data.data.projetos && data.data.projetos.length > 0) {
      const projetosNovos = data.data.projetos;
      console.log(`‚úÖ ${projetosNovos.length} projetos carregados`);
      
      // Encontrar a data mais recente de atualiza√ß√£o
      const datasAtualizacao = projetosNovos
        .map(p => parseDataBR(p.data_atualizacao))
        .filter(d => d !== null);
      
      if (datasAtualizacao.length > 0) {
        ultimaAtualizacaoGlobal = new Date(Math.max(...datasAtualizacao));
        console.log('üìÖ √öltima atualiza√ß√£o global:', ultimaAtualizacaoGlobal);
      }
      
      const projetosAtualizados = detectarAtualizacoes(projetosNovos);
      projetosAtuais = projetosNovos;
      renderizarProjetos(projetosAtualizados);
      atualizarBadgeSync();
      
    } else {
      console.warn('‚ö†Ô∏è Nenhum projeto encontrado');
      document.getElementById('projetosGrid').innerHTML = '<div class="loading">üì≠ Nenhum projeto cadastrado</div>';
    }
  } catch (error) {
    console.error('‚ùå Erro ao carregar projetos:', error);
    document.getElementById('projetosGrid').innerHTML = '<div class="loading">‚ö†Ô∏è Erro ao carregar projetos</div>';
  }
}

// Detectar atualiza√ß√µes
function detectarAtualizacoes(projetosNovos) {
  const atualizados = new Set();
  
  projetosNovos.forEach(projetoNovo => {
    const projetoAntigo = projetosAtuais.find(p => p.id === projetoNovo.id);
    
    if (projetoAntigo) {
      if (projetoNovo.data_atualizacao !== projetoAntigo.data_atualizacao) {
        atualizados.add(projetoNovo.id);
        console.log(`üÜï Projeto atualizado: ${projetoNovo.nome}`);
      }
    } else {
      atualizados.add(projetoNovo.id);
      console.log(`‚ú® Novo projeto: ${projetoNovo.nome}`);
    }
  });
  
  return atualizados;
}

// Renderizar projetos
function renderizarProjetos(projetosAtualizados) {
  const grid = document.getElementById('projetosGrid');
  
  const farolEmoji = {
    'verde': 'üü¢',
    'amarelo': 'üü°',
    'vermelho': 'üî¥'
  };
  
  const html = projetosAtuais.map(projeto => {
    const dataAtualizada = parseDataBR(projeto.data_atualizacao);
    
    if (!dataAtualizada) {
      console.error('Data inv√°lida para projeto:', projeto.nome, projeto.data_atualizacao);
      return '';
    }
    
    const agora = new Date();
    const diffMs = agora - dataAtualizada;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHoras = Math.floor(diffMins / 60);
    const diffDias = Math.floor(diffHoras / 24);
    
    let tempoRelativo;
    if (diffMins < 1) tempoRelativo = 'Agora mesmo';
    else if (diffMins < 60) tempoRelativo = `h√° ${diffMins} min`;
    else if (diffHoras < 24) tempoRelativo = `h√° ${diffHoras}h`;
    else tempoRelativo = `h√° ${diffDias} dia${diffDias > 1 ? 's' : ''}`;
    
    const dataFormatada = dataAtualizada.toLocaleString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
    
    const foiAtualizado = projetosAtualizados.has(projeto.id);
    
    return `
      <div class="projeto-card ${foiAtualizado ? 'atualizado' : ''}">
        ${foiAtualizado ? '<div class="badge-novo">Atualizado!</div>' : ''}
        
        <div class="card-header">
          <h2 class="card-titulo">${projeto.nome}</h2>
          <div class="farol ${projeto.farol}">
            ${farolEmoji[projeto.farol] || '‚ö™'}
          </div>
        </div>
        
        <div class="card-info">
          <div class="info-badge">
            <div class="info-badge-label">üë∑ Coordenador</div>
            <div class="info-badge-value">${projeto.coordenador}</div>
          </div>
          <div class="info-badge">
            <div class="info-badge-label">üîß Execu√ß√£o</div>
            <div class="info-badge-value">${projeto.execucao}</div>
          </div>
        </div>
        
        <div class="card-status">
          <div class="status-label">üìä Status Atual</div>
          <div class="status-text">${projeto.status}</div>
        </div>
        
        <div class="card-footer">
          <div>
            <span class="footer-user">üïê ${tempoRelativo}</span>
            <div style="font-size:10px;opacity:.7;margin-top:2px">${dataFormatada}</div>
          </div>
          <div>
            <span class="footer-user">${projeto.usuario_atualizacao || 'Sistema'}</span>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  grid.innerHTML = html;
  
  if (projetosAtualizados.size > 0) {
    setTimeout(() => {
      document.querySelectorAll('.badge-novo').forEach(badge => {
        badge.style.animation = 'none';
        badge.style.opacity = '0';
        setTimeout(() => badge.remove(), 300);
      });
      document.querySelectorAll('.projeto-card.atualizado').forEach(card => {
        card.classList.remove('atualizado');
      });
    }, 5000);
  }
}

// Atualizar badge de sincroniza√ß√£o
function atualizarBadgeSync() {
  const badge = document.getElementById('ultimaSync');
  
  if (ultimaAtualizacaoGlobal) {
    const dataFormatada = ultimaAtualizacaoGlobal.toLocaleString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    badge.innerHTML = `‚úÖ √öltima atualiza√ß√£o: ${dataFormatada}`;
    badge.style.background = 'rgba(34,197,94,.2)';
    badge.style.borderColor = 'rgba(34,197,94,.5)';
    
    setTimeout(() => {
      badge.style.background = 'rgba(34,197,94,.15)';
      badge.style.borderColor = 'rgba(34,197,94,.4)';
    }, 2000);
  } else {
    badge.innerHTML = 'üîÑ Aguardando dados...';
  }
}
</script>

</body>
</html>
