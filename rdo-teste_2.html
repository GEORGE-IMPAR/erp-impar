<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>ERP √çMPAR ‚Äì RDO da Obra</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg-main: #020617;
      --bg-header: linear-gradient(90deg, #020617 0%, #020617 40%, #0f172a 100%);
      --texto-principal: #f9fafb;
      --texto-secundario: #9ca3af;
      --input-bg: #020617;
      --input-border: #1f2937;
      --shadow-card: 0 24px 60px rgba(15, 23, 42, 0.85);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top left, #0b1120 0, #020617 45%, #000 100%);
      color: var(--texto-principal);
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--bg-header);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.85);
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-ball {
      width: 38px;
      height: 38px;
      border-radius: 14px;
      background: radial-gradient(circle at 20% 20%, #f97316, #1d4ed8 45%, #0f172a 100%);
    }

    .title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title-main {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .title-sub {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--texto-secundario);
      letter-spacing: 0.18em;
    }

    .btn-header {
      padding: 8px 18px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.7);
      color: #e5e7eb;
      font-size: 11px;
      letter-spacing: 0.16em;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.18s;
      text-transform: uppercase;
    }

    .btn-header-primary {
      background: linear-gradient(90deg, #1d4ed8, #22c55e);
      border: none;
      color: white;
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.45);
    }

    main {
      flex: 1;
      padding: 18px 12px 24px;
      display: flex;
      justify-content: center;
    }

    .page-shell {
      width: 100%;
      max-width: 1100px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .card-rdo {
      background: radial-gradient(circle at top left, #0b1120 0, #020617 45%, #020617 100%);
      border-radius: 24px;
      box-shadow: var(--shadow-card);
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    h2 {
      margin: 0 0 8px 0;
      font-size: 20px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .section {
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(30, 64, 175, 0.45);
      border-radius: 20px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }

    .section h3 {
      margin: 0 0 4px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #bfdbfe;
    }

    label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--texto-secundario);
      margin-bottom: 3px;
      display: block;
    }

    select,
    input[type="text"],
    input[type="date"],
    textarea {
      background: var(--input-bg);
      border-radius: 999px;
      border: 1px solid var(--input-border);
      color: var(--texto-principal);
      padding: 9px 14px;
      font-size: 14px;
      width: 100%;
      outline: none;
      transition: border-color 0.16s ease, box-shadow 0.16s ease;
    }

    textarea {
      min-height: 100px;
      border-radius: 18px;
      resize: vertical;
      padding-right: 44px;
    }

    select:focus,
    input[type="text"]:focus,
    input[type="date"]:focus,
    textarea:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.55);
    }

    small {
      font-size: 11px;
      color: var(--texto-secundario);
    }

    .inline-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 640px) {
      .inline-3 {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* Microfone gen√©rico */
    .field-with-mic {
      position: relative;
    }

    .btn-mic {
      position: absolute;
      right: 10px;
      bottom: 10px;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #22c55e, #1d4ed8);
      color: #fff;
      font-size: 17px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.9);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .btn-mic.mic-active {
      border: 2px solid #f97316;
      animation: mic-pulse 1.2s infinite;
    }

    @keyframes mic-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.06); }
      100% { transform: scale(1); }
    }

    /* M√≠dias (foto/v√≠deo) */
    .midia-item {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(96, 165, 250, 0.35);
      border-radius: 16px;
      padding: 10px;
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .midia-item img,
    .midia-item video {
      width: 100%;
      border-radius: 12px;
    }

    footer {
      text-align: center;
      padding: 10px;
      font-size: 11px;
      color: #6b7280;
    }
  </style>
</head>

<body>
<header>
  <div class="logo-area">
    <div class="logo-ball"></div>
    <div class="title-wrap">
      <div class="title-main">ERP √çMPAR ¬∑ RDO</div>
      <div class="title-sub">Registro di√°rio de obra</div>
    </div>
  </div>
  <a href="index.html" class="btn-header btn-header-primary">Menu</a>
</header>

<main>
  <div class="page-shell">
    <section class="card-rdo">
      <h2>RDO da obra</h2>

      <!-- DADOS PRINCIPAIS -->
      <div class="section">
        <h3>Dados do RDO</h3>

        <label for="obra-select">Obra</label>
        <select id="obra-select">
          <option value="">Selecione...</option>
          <option value="036">036 ‚Äî Cl√≠nica Artisti</option>
          <option value="041">041 ‚Äî F√≥rum Araquari</option>
          <option value="052">052 ‚Äî Hospital NS F√°tima</option>
        </select>

        <label for="atividade-select">Atividade do cronograma</label>
        <select id="atividade-select" disabled>
          <option>Selecione primeiro a obra...</option>
        </select>

        <div class="inline-3">
          <div>
            <label for="data-rdo">Data</label>
            <input type="date" id="data-rdo" />
          </div>
          <div>
            <label for="hora-inicio">Hora in√≠cio</label>
            <input type="text" id="hora-inicio" placeholder="HH:MM" />
          </div>
          <div>
            <label for="hora-fim">Hora fim</label>
            <input type="text" id="hora-fim" placeholder="HH:MM" />
          </div>
        </div>

        <label for="descricao-rdo">Resumo do que foi executado</label>
        <div class="field-with-mic">
          <textarea id="descricao-rdo"
            placeholder="Toque no microfone e fale o que foi feito hoje nessa atividade..."></textarea>
          <button id="btn-mic-descricao" class="btn-mic" type="button">üéôÔ∏è</button>
        </div>
        <small id="mic-status">Ditado dispon√≠vel (melhor em Chrome/Edge no Android).</small>
      </div>

      <!-- ANDAMENTO (PERCENTUAL + MOTIVO) -->
      <div class="section">
        <h3>Andamento da atividade</h3>

        <label for="percentual-atividade">Percentual conclu√≠do</label>
        <select id="percentual-atividade">
          <option value="">Selecione...</option>
          <option value="0">0% ¬∑ N√£o iniciado</option>
          <option value="25">25% ¬∑ In√≠cio</option>
          <option value="50">50% ¬∑ Metade</option>
          <option value="75">75% ¬∑ Quase conclu√≠do</option>
          <option value="100">100% ¬∑ Conclu√≠da</option>
        </select>
        <small id="percentual-status">Ao escolher o percentual, a hora de fim ser√° carimbada automaticamente.</small>

        <div id="justificativa-wrapper" class="field-with-mic" style="display:none; margin-top:8px;">
          <label for="justificativa">Motivo de n√£o conclus√£o</label>
          <textarea id="justificativa"
            placeholder="Ex.: Choveu, falta de material, bloqueio de frente de servi√ßo..."></textarea>
          <button id="btn-mic-justificativa" class="btn-mic" type="button">üéôÔ∏è</button>
        </div>
        <small id="just-status"></small>
      </div>

      <!-- M√çDIAS -->
      <div class="section">
        <h3>Fotos e v√≠deos da atividade</h3>

        <button class="btn-header btn-header-primary" type="button" id="btn-midia">
          üì∑ üé• Capturar foto ou v√≠deo
        </button>
        <small>Voc√™ pode anexar v√°rias m√≠dias para esta atividade. Cada uma pode ter uma descri√ß√£o por voz.</small>

        <div id="lista-midia"></div>
      </div>

      <!-- LOCALIZA√á√ÉO -->
      <div class="section">
        <h3>Localiza√ß√£o da obra</h3>

        <button class="btn-header" id="btn-localizar" type="button">üìç Capturar localiza√ß√£o</button>
        <div id="status-localizacao">Aguardando captura...</div>

        <div style="margin-top:10px;border-radius:14px;overflow:hidden;">
          <iframe id="mapa-obra" width="100%" height="240"
            src="https://www.google.com/maps?q=-27.0,-48.0&z=4&output=embed"
            loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
        <small>Quando voc√™ capturar a localiza√ß√£o, o mapa aproxima para onde o celular est√° naquele momento.</small>
      </div>

      <button class="btn-header btn-header-primary" style="margin-top:18px;" type="button">
        üíæ Salvar RDO (prot√≥tipo)
      </button>
    </section>
  </div>
</main>

<footer>ERP √çMPAR ¬∑ RDO piloto ‚Äì depois integramos com o back-end e cronograma real.</footer>

<script>
  // ====================
  // 1. Data / hora inicial padr√£o
  // ====================
  (function () {
    const agora = new Date();
    const dataInput = document.getElementById("data-rdo");
    const horaIni = document.getElementById("hora-inicio");
    if (dataInput) dataInput.value = agora.toISOString().slice(0, 10);
    if (horaIni) {
      const h = String(agora.getHours()).padStart(2, "0");
      const m = String(agora.getMinutes()).padStart(2, "0");
      horaIni.value = h + ":" + m;
    }
  })();

  // ====================
  // 2. Atividades mock (depois trocamos para API do cronograma)
  // ====================
  const atividadesPorObra = {
    "036": [
      { id: 1, codigo: "1.1", descricao: "Funda√ß√£o bloco 1" },
      { id: 2, codigo: "2.3", descricao: "Estrutura bloco 1" }
    ],
    "041": [
      { id: 10, codigo: "1.0", descricao: "Demoli√ß√£o do terreno" },
      { id: 11, codigo: "2.1", descricao: "Funda√ß√µes profundas" }
    ],
    "052": [
      { id: 20, codigo: "3.2", descricao: "Alvenaria interna ‚Äì setores cr√≠ticos" },
      { id: 21, codigo: "5.4", descricao: "Instala√ß√µes el√©tricas ‚Äì leitos t√©cnicos" }
    ]
  };

  const obraSelect = document.getElementById("obra-select");
  const atividadeSelect = document.getElementById("atividade-select");

  obraSelect.addEventListener("change", () => {
    const obra = obraSelect.value;
    atividadeSelect.innerHTML = "";
    if (!atividadesPorObra[obra]) {
      atividadeSelect.disabled = true;
      atividadeSelect.innerHTML = "<option>Nenhuma atividade configurada (prot√≥tipo).</option>";
      return;
    }
    atividadeSelect.disabled = false;
    atividadeSelect.innerHTML =
      '<option value="">Selecione...</option>' +
      atividadesPorObra[obra]
        .map(a => `<option value="${a.id}">${a.codigo} ‚Äî ${a.descricao}</option>`)
        .join("");
  });

  // ====================
  // 3. Ditado por voz (resumo)
  // ====================
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const desc = document.getElementById("descricao-rdo");
  const micBtn = document.getElementById("btn-mic-descricao");
  const micStatus = document.getElementById("mic-status");

  let recognizingResumo = false;
  let recogResumo;

  if (!SpeechRecognition) {
    micBtn.style.display = "none";
    micStatus.textContent = "Ditado n√£o suportado neste navegador.";
  } else {
    recogResumo = new SpeechRecognition();
    recogResumo.lang = "pt-BR";
    recogResumo.interimResults = true;
    recogResumo.continuous = false;

    micBtn.addEventListener("click", () => {
      if (!recognizingResumo) {
        try {
          recogResumo.start();
          recognizingResumo = true;
          micBtn.classList.add("mic-active");
          micStatus.textContent = "Ouvindo...";
        } catch (e) {
          console.error(e);
        }
      } else {
        recogResumo.stop();
        recognizingResumo = false;
        micBtn.classList.remove("mic-active");
        micStatus.textContent = "Pausado.";
      }
    });

    recogResumo.onresult = (e) => {
      let t = "";
      for (let i = e.resultIndex; i < e.results.length; i++) {
        t += e.results[i][0].transcript;
      }
      desc.value = t.trim() + " ";
    };

    recogResumo.onend = () => {
      recognizingResumo = false;
      micBtn.classList.remove("mic-active");
      if (micStatus.textContent.startsWith("Ouvindo")) {
        micStatus.textContent = "Ditado finalizado. Toque novamente para continuar.";
      }
    };
  }

  // ====================
  // 4. Percentual + justificativa + hora fim autom√°tica
  // ====================
  const percentualSelect = document.getElementById("percentual-atividade");
  const percentualStatus = document.getElementById("percentual-status");
  const justWrapper = document.getElementById("justificativa-wrapper");
  const justText = document.getElementById("justificativa");
  const justStatus = document.getElementById("just-status");
  const btnMicJust = document.getElementById("btn-mic-justificativa");
  const horaFimInput = document.getElementById("hora-fim");

  percentualSelect.addEventListener("change", () => {
    const val = percentualSelect.value;
    if (!val) {
      justWrapper.style.display = "none";
      justText.value = "";
      justStatus.textContent = "";
      return;
    }

    // Carimba hora fim ao escolher o percentual
    const agora = new Date();
    const h = String(agora.getHours()).padStart(2, "0");
    const m = String(agora.getMinutes()).padStart(2, "0");
    if (horaFimInput) horaFimInput.value = h + ":" + m;

    if (val === "100") {
      justWrapper.style.display = "none";
      justText.value = "";
      justStatus.textContent = "Atividade marcada como conclu√≠da 100%.";
    } else {
      justWrapper.style.display = "block";
      justStatus.textContent = "Explique rapidamente por que a atividade n√£o foi conclu√≠da.";
    }
  });

  // Ditado para justificativa
  if (!SpeechRecognition) {
    btnMicJust.style.display = "none";
    justStatus.textContent = "Ditado n√£o suportado neste navegador.";
  } else {
    const recogJust = new SpeechRecognition();
    recogJust.lang = "pt-BR";
    recogJust.interimResults = true;
    recogJust.continuous = false;
    let ouvindoJust = false;
    let baseJust = "";

    btnMicJust.addEventListener("click", () => {
      if (!ouvindoJust) {
        try {
          baseJust = justText.value ? justText.value.trim() + " " : "";
          recogJust.start();
          ouvindoJust = true;
          btnMicJust.classList.add("mic-active");
          justStatus.textContent = "Ouvindo justificativa...";
        } catch (e) {
          console.error(e);
        }
      } else {
        recogJust.stop();
        ouvindoJust = false;
        btnMicJust.classList.remove("mic-active");
      }
    });

    recogJust.onresult = (e) => {
      let t = "";
      for (let i = e.resultIndex; i < e.results.length; i++) {
        t += e.results[i][0].transcript;
      }
      justText.value = baseJust + t.trim() + " ";
    };

    recogJust.onend = () => {
      ouvindoJust = false;
      btnMicJust.classList.remove("mic-active");
      if (justText.value) {
        justStatus.textContent = "Justificativa gravada. Voc√™ pode ajustar o texto se quiser.";
      }
    };
  }

  // ====================
  // 5. M√≠dia (foto ou v√≠deo) com descri√ß√£o por voz
  // ====================
  const btnMidia = document.getElementById("btn-midia");
  const listaMidia = document.getElementById("lista-midia");

  btnMidia.addEventListener("click", () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*;capture=camera,video/*;capture=camcorder";

    input.onchange = () => {
      const file = input.files[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      const div = document.createElement("div");
      div.className = "midia-item";

      let midiaHtml = "";
      if (file.type.startsWith("image/")) {
        midiaHtml = `<img src="${url}" alt="Foto da atividade">`;
      } else if (file.type.startsWith("video/")) {
        midiaHtml = `<video src="${url}" controls></video>`;
      } else {
        midiaHtml = `<small>Arquivo anexado: ${file.name}</small>`;
      }

      div.innerHTML = `
        ${midiaHtml}
        <div class="field-with-mic">
          <textarea class="midia-descricao" placeholder="Descri√ß√£o desta m√≠dia (use o microfone)..."></textarea>
          <button type="button" class="btn-mic btn-mic-midia">üéôÔ∏è</button>
        </div>
      `;
      listaMidia.appendChild(div);

      const micMidia = div.querySelector(".btn-mic-midia");
      const txtMidia = div.querySelector(".midia-descricao");

      if (!SpeechRecognition) {
        micMidia.style.display = "none";
        return;
      }

      const r = new SpeechRecognition();
      r.lang = "pt-BR";
      r.interimResults = true;
      let ativo = false;
      let base = "";

      micMidia.addEventListener("click", () => {
        if (!ativo) {
          try {
            base = txtMidia.value ? txtMidia.value.trim() + " " : "";
            r.start();
            ativo = true;
            micMidia.classList.add("mic-active");
          } catch (e) {
            console.error(e);
          }
        } else {
          r.stop();
          ativo = false;
          micMidia.classList.remove("mic-active");
        }
      });

      r.onresult = (e) => {
        let t = "";
        for (let i = e.resultIndex; i < e.results.length; i++) {
          t += e.results[i][0].transcript;
        }
        txtMidia.value = base + t.trim() + " ";
      };

      r.onend = () => {
        ativo = false;
        micMidia.classList.remove("mic-active");
      };
    };

    input.click();
  });

  // ====================
  // 6. Geolocaliza√ß√£o + mapa
  // ====================
  const btnLocalizar = document.getElementById("btn-localizar");
  const statusLoc = document.getElementById("status-localizacao");
  const mapa = document.getElementById("mapa-obra");

  function setStatusLoc(msg) {
    if (statusLoc) statusLoc.textContent = msg;
  }

  if (btnLocalizar && statusLoc && mapa) {
    btnLocalizar.addEventListener("click", () => {
      if (!("geolocation" in navigator)) {
        setStatusLoc("Este navegador n√£o suporta geolocaliza√ß√£o.");
        return;
      }

      setStatusLoc("Buscando localiza√ß√£o do aparelho...");

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const acc = pos.coords.accuracy;

          setStatusLoc(
            `Localiza√ß√£o obtida: ${lat.toFixed(5)}, ${lng.toFixed(5)} (¬±${Math.round(acc)} m)`
          );

          mapa.src = `https://www.google.com/maps?q=${lat},${lng}&z=18&output=embed`;
        },
        (err) => {
          console.error("Erro geolocaliza√ß√£o:", err);
          if (err.code === err.PERMISSION_DENIED) {
            setStatusLoc(
              "Permiss√£o de localiza√ß√£o negada. Ative a localiza√ß√£o do navegador e permita o acesso."
            );
          } else if (err.code === err.POSITION_UNAVAILABLE) {
            setStatusLoc("Sinal de localiza√ß√£o indispon√≠vel no momento.");
          } else if (err.code === err.TIMEOUT) {
            setStatusLoc("Tempo excedido ao tentar obter a localiza√ß√£o.");
          } else {
            setStatusLoc("Erro desconhecido ao obter a localiza√ß√£o.");
          }
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        }
      );
    });
  }
</script>
</body>
</html>
