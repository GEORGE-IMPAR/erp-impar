<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Status da Obra ‚Äì Vis√£o Cliente ‚Ä¢ ERP √çMPAR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- html2canvas para captura da tela -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- jsPDF para gera√ß√£o de PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#020617;
      --card:#020617;
      --border:#1f2937;
      --text:#e5e7eb;
      --text-soft:#9ca3af;
      --blue:#3b82f6;
      --blue-dark:#1d4ed8;
      --green:#22c55e;
      --yellow:#eab308;
      --red:#ef4444;
      --accent:#cc6e00;
    }
    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(circle at top left,#1d4ed8 0,transparent 55%),
        radial-gradient(circle at bottom right,#f97316 0,transparent 55%),
        linear-gradient(120deg,#020617,#020617 60%,#030712);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      padding:10px 16px 4px;
      display:flex;
      justify-content:center;
    }
    .header-inner{
      width:100%;
      max-width:1200px;
      display:flex;
      justify-content:space-between;
      gap:16px;
      align-items:flex-start;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      text-shadow:0 2px 6px rgba(0,0,0,.8);
    }
    .brand span:nth-child(1){
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.22em;
      opacity:.9;
    }
    .brand span:nth-child(2){
      font-size:20px;
      font-weight:800;
    }
    .brand span:nth-child(3){
      font-size:11px;
      opacity:.9;
    }

    .tag-top{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.7);
      color:var(--text-soft);
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:12px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill-btn{
      border-radius:999px;
      border:1px solid #4b5563;
      background:#020617;
      padding:5px 10px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--text-soft);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .pill-btn span.icn{font-size:12px;}
    .pill-btn:hover{
      border-color:#9ca3af;
      color:#e5e7eb;
    }

    main{
      flex:1 0 auto;
      display:flex;
      justify-content:center;
      padding:8px 12px 16px;
    }
    .layout{
      width:100%;
      max-width:1200px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .container {
      background:rgba(15,23,42,.96);
      border-radius:18px;
      border:1px solid rgba(55,65,81,.9);
      box-shadow:0 18px 40px rgba(0,0,0,.75);
      padding:16px 18px 18px;
    }

    h1 {
      margin-top:0;
      color:#ffffff;
      font-size:18px;
      margin-bottom:6px;
    }

    .subtitulo{
      font-size:12px;
      color:var(--text-soft);
      margin-bottom:10px;
    }

    .obra-header{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      margin-bottom:10px;
    }

    .obra-titulo-bloco{
      flex:1;
      min-width:220px;
    }
    .obra-nome{
      font-size:17px;
      font-weight:700;
      color:#f9fafb;
      letter-spacing:.03em;
    }
    .obra-coordenador{
      margin-top:2px;
      font-size:12px;
      color:#cbd5f5;
    }
    .obra-meta{
      margin-top:4px;
      font-size:11px;
      color:#9ca3af;
    }

    .obra-select-bloco{
      min-width:220px;
    }
    label{
      display:block;
      font-size:11px;
      margin-bottom:3px;
      color:#cfd8ff;
    }
    select{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #293552;
      background:#020617;
      color:#f5f5f5;
      font-size:12px;
    }

    .actions-top{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
      margin-bottom:6px;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:7px 12px;
      font-size:11px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .btn-primary{
      background:linear-gradient(135deg,#2563eb,#22c55e);
      color:#fff;
      box-shadow:0 10px 24px rgba(0,0,0,.7);
      text-transform:uppercase;
      letter-spacing:.12em;
      font-weight:600;
    }
    .btn-secondary{
      background:#111827;
      color:#fff;
      border:1px solid #374151;
    }

    .status-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      border:1px solid #374151;
      background:#020617;
      margin-top:4px;
    }
    .status-dot{
      width:8px;height:8px;border-radius:999px;
    }
    .status-concluido .status-dot{background:var(--green);}
    .status-em-dia .status-dot{background:var(--blue);}
    .status-atrasado .status-dot{background:var(--red);}
    .status-sem-inicio .status-dot{background:#6b7280;}

    .cards-grid{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:10px;
      margin-top:8px;
      margin-bottom:10px;
    }
    .card-kpi{
      background:#020617;
      border-radius:14px;
      padding:10px 12px;
      border:1px solid #1f2937;
      box-shadow:0 10px 26px rgba(0,0,0,.5);
    }
    .card-kpi-label{
      font-size:11px;
      color:#9ca3af;
      margin-bottom:2px;
    }
    .card-kpi-valor{
      font-size:18px;
      font-weight:700;
      color:#f9fafb;
    }
    .card-kpi-extra{
      font-size:10px;
      margin-top:2px;
      color:#9ca3af;
    }

    .charts-grid{
      display:grid;
      grid-template-columns:2fr 3fr;
      gap:10px;
      margin-top:6px;
      margin-bottom:8px;
    }
    .card-chart{
      background:#020617;
      border-radius:14px;
      padding:10px 12px 12px;
      border:1px solid #1f2937;
      box-shadow:0 10px 26px rgba(0,0,0,.5);
    }
    .card-chart-title{
      font-size:12px;
      margin-bottom:6px;
      color:#e5e7eb;
    }
    canvas{
      max-width:100%;
    }

    .updates-grid{
      display:grid;
      grid-template-columns:2fr 3fr;
      gap:10px;
      margin-top:6px;
    }
    .card-updates, .card-info{
      background:#020617;
      border-radius:14px;
      padding:10px 12px;
      border:1px solid #1f2937;
      box-shadow:0 10px 26px rgba(0,0,0,.5);
      font-size:11px;
      color:#e5e7eb;
    }
    .card-updates-title,
    .card-info-title{
      font-size:12px;
      margin-bottom:6px;
      color:#e5e7eb;
    }
    .update-item{
      margin-bottom:6px;
      border-bottom:1px dashed #1f2937;
      padding-bottom:4px;
    }
    .update-item:last-child{
      border-bottom:none;
      padding-bottom:0;
    }
    .update-atividade{
      font-weight:600;
      color:#cbd5f5;
      margin-bottom:2px;
    }
    .update-texto{
      white-space:pre-wrap;
      color:#e5e7eb;
    }
    .info-list{
      list-style:none;
      padding-left:0;
      margin:0;
    }
    .info-list li{
      margin-bottom:4px;
      color:#cbd5f5;
    }
    .info-label{
      color:#9ca3af;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
      display:block;
    }

    .no-data{
      font-size:11px;
      color:#9ca3af;
      margin-top:6px;
    }

    /* ====== GALERIA DE FOTOS ====== */
    .fotos-grid{
      margin-top:14px;
      background:#020617;
      border-radius:14px;
      padding:10px 12px 12px;
      border:1px solid #1f2937;
      box-shadow:0 10px 26px rgba(0,0,0,.5);
    }
    .fotos-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:8px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .fotos-titulos{
      max-width:70%;
    }
    .fotos-title{
      font-size:12px;
      color:#e5e7eb;
    }
    .fotos-subtitle{
      font-size:10px;
      color:#9ca3af;
      margin-top:2px;
    }
    .fotos-list{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:10px;
      font-size:11px;
    }
    .foto-card{
      background:#020617;
      border-radius:12px;
      border:1px solid #1f2937;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
    }
    .foto-thumb-wrap{
      background:#020617;
      height:150px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .foto-thumb{
      max-width:100%;
      max-height:100%;
      object-fit:cover;
      display:block;
    }
    .foto-meta{
      padding:6px 8px 8px;
    }
    .foto-data{
      font-size:10px;
      color:#9ca3af;
      margin-bottom:2px;
    }
    .foto-legenda{
      font-size:11px;
      color:#e5e7eb;
    }
    .foto-delete{
      position:absolute;
      top:6px;
      right:6px;
      border:none;
      border-radius:999px;
      padding:2px 6px;
      font-size:10px;
      cursor:pointer;
      background:rgba(15,23,42,.9);
      color:#fecaca;
      border:1px solid #7f1d1d;
    }
    .foto-delete:hover{
      background:#7f1d1d;
    }

    /* MODAL FOTO */
    .foto-modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.8);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .foto-modal-inner{
      max-width:90vw;
      max-height:90vh;
      background:#020617;
      border-radius:16px;
      border:1px solid #374151;
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .foto-modal-imgwrap{
      max-height:70vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#020617;
    }
    .foto-modal-imgwrap img{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
      display:block;
    }
    .foto-modal-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      font-size:11px;
      color:#e5e7eb;
      flex-wrap:wrap;
    }
    .foto-modal-legenda{
      flex:1;
    }
    .foto-modal-fechar{
      border:none;
      border-radius:999px;
      padding:5px 10px;
      font-size:11px;
      cursor:pointer;
      background:#111827;
      color:#f9fafb;
      border:1px solid #374151;
    }

    footer{
      background:#020617;
      color:#9ca3af;
      padding:6px 16px;
      font-size:10px;
    }
    .rodape-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .loading{
      font-size:11px;
      color:#9ca3af;
      margin-top:4px;
    }
    .erro-msg{
      font-size:11px;
      color:#fecaca;
      margin-top:4px;
    }

    @media(max-width:900px){
      .container{padding:14px 12px 16px;}
      h1{font-size:16px;}
      .cards-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
      .charts-grid{grid-template-columns:1fr;}
      .updates-grid{grid-template-columns:1fr;}
      .fotos-list{grid-template-columns:repeat(2,minmax(0,1fr));}
      .fotos-titulos{max-width:100%;}
    }

    @media(max-width:600px){
      .cards-grid{grid-template-columns:1fr 1fr;}
      .fotos-list{grid-template-columns:1fr;}
    }

    /* √°rea que vai pro PDF */
    #printArea{
      /* nada especial aqui para n√£o atrapalhar a tela,
         o ajuste √© feito na hora de gerar o PDF */
    }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <span>PLATAFORMA</span>
      <span>ERP √çMPAR ‚Ä¢ Status da Obra</span>
      <span>Vis√£o executiva para o cliente</span>
    </div>
    <div class="tag-top">
      <button class="pill-btn" type="button" onclick="voltarMenu()">
        <span class="icn">üè†</span> Menu principal
      </button>
      <button class="pill-btn" type="button" onclick="voltarFarol()">
        <span class="icn">‚Üê</span> Farol de obras
      </button>
    </div>
  </div>
</header>

<main>
  <div class="layout">
    <div class="container" id="printArea">
      <h1>Status da Obra ‚Äì Vis√£o Cliente</h1>
      <div class="subtitulo">
        Painel executivo de acompanhamento da sua obra, com avan√ßo f√≠sico planejado x real,
        status consolidado e principais atualiza√ß√µes registradas pela equipe √çMPAR.
      </div>

      <div class="obra-header">
        <div class="obra-titulo-bloco">
          <div class="obra-nome" id="lblObraNome">Selecione uma obra</div>
          <div class="obra-coordenador" id="lblCoordenador">Coordenador: ‚Äî</div>
          <div class="obra-meta">
            Atualizado em <span id="lblAtualizadoEm">‚Äî</span>
          </div>
          <div class="status-badge" id="statusBadge">
            <span class="status-dot"></span>
            <span id="lblStatus">Status geral: ‚Äî</span>
          </div>
        </div>

        <div class="obra-select-bloco">
          <label for="obraSelect">Obras com cronograma dispon√≠vel</label>
          <select id="obraSelect">
            <option value="">Carregando lista de obras...</option>
          </select>
          <div id="listaObrasInfo" class="loading"></div>
        </div>
      </div>

      <div class="actions-top">
        <button class="btn btn-primary" type="button" onclick="baixarPDF()">
          üìÑ Baixar PDF
        </button>
        <button class="btn btn-secondary" type="button" onclick="compartilharStatus()">
          üì§ Compartilhar
        </button>
      </div>

      <div id="erroGlobal" class="erro-msg" style="display:none;"></div>

      <div class="cards-grid">
        <div class="card-kpi">
          <div class="card-kpi-label">Avan√ßo planejado</div>
          <div class="card-kpi-valor" id="kpiPlanejado">0%</div>
          <div class="card-kpi-extra" id="kpiPlanejadoDetalhe">Baseline ainda n√£o consolidada.</div>
        </div>
        <div class="card-kpi">
          <div class="card-kpi-label">Avan√ßo real</div>
          <div class="card-kpi-valor" id="kpiReal">0%</div>
          <div class="card-kpi-extra" id="kpiRealDetalhe">Nenhum avan√ßo registrado at√© o momento.</div>
        </div>
        <div class="card-kpi">
          <div class="card-kpi-label">Per√≠odo de execu√ß√£o (baseline)</div>
          <div class="card-kpi-valor" id="kpiPeriodoBase">‚Äî</div>
          <div class="card-kpi-extra" id="kpiPeriodoBaseDetalhe">Janela planejada original.</div>
        </div>
        <div class="card-kpi">
          <div class="card-kpi-label">Atividades do cronograma</div>
          <div class="card-kpi-valor" id="kpiAtividadesTotal">0</div>
          <div class="card-kpi-extra" id="kpiAtividadesDetalhe">Conclu√≠das / em andamento / atrasadas.</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card-chart">
          <div class="card-chart-title">Situa√ß√£o das atividades da obra</div>
          <canvas id="chartStatusAtividades" height="180"></canvas>
          <div id="chartStatusResumo" class="no-data"></div>
        </div>
        <div class="card-chart">
          <div class="card-chart-title">Avan√ßo f√≠sico global ‚Äì Planejado x Real</div>
          <canvas id="chartPlanejadoReal" height="180"></canvas>
        </div>
      </div>

      <div class="updates-grid">
        <div class="card-updates">
          <div class="card-updates-title">Hist√≥rico de observa√ß√µes da obra</div>
          <div id="listaUpdates" class="no-data">
            Nenhuma observa√ß√£o registrada at√© o momento.
          </div>
        </div>
        <div class="card-info">
          <div class="card-info-title">Resumo t√©cnico simplificado</div>
          <ul class="info-list">
            <li>
              <span class="info-label">Status consolidado</span>
              <span id="infoStatus">‚Äî</span>
            </li>
            <li>
              <span class="info-label">% Planejado x Real</span>
              <span id="infoPercs">‚Äî</span>
            </li>
            <li>
              <span class="info-label">Linha de base</span>
              <span id="infoBaseline">‚Äî</span>
            </li>
            <li>
              <span class="info-label">Execu√ß√£o real</span>
              <span id="infoExecucao">‚Äî</span>
            </li>
            <li>
              <span class="info-label">Origem dos dados</span>
              <span>ERP √çMPAR ‚Äì M√≥dulo Cronograma de Obras (integra√ß√£o Farol x Cronograma)</span>
            </li>
          </ul>
        </div>
      </div>

      <!-- ====== GALERIA DE FOTOS ====== -->
      <div class="fotos-grid">
        <div class="fotos-header">
          <div class="fotos-titulos">
            <div class="fotos-title">Evolu√ß√£o da obra ‚Äì Registros fotogr√°ficos e v√≠deos</div>
            <div class="fotos-subtitle">
              Hist√≥rico de imagens e v√≠deos da obra, atualizadas pela equipe √çMPAR.
            </div>
          </div>
          <button class="btn btn-secondary" type="button" onclick="abrirSelecaoFoto()">
            ‚ûï Adicionar foto
          </button>
          <button class="btn btn-secondary btn-add-video" type="button" onclick="abrirSelecaoVideo()">
            üé¨ Adicionar v√≠deo
          </button>
          <input type="file" id="fotoInput" accept="image/*" style="display:none" />
          <input type="file" id="videoInput" accept="video/*" style="display:none" />
        </div>
        <div id="galeriaFotos" class="fotos-list no-data">
          Nenhuma foto cadastrada para esta obra.
        </div>
      </div>

    </div>
  </div>
</main>

<footer>
  <div class="rodape-inner">
    <span>¬© 2025 ERP √çMPAR ‚Ä¢ Status da Obra ‚Äì Vis√£o Cliente</span>
    <span>Relat√≥rio executivo gerado automaticamente a partir do cronograma oficial da obra</span>
  </div>
</footer>

<!-- MODAL FOTO -->
<div id="fotoModal" class="foto-modal-backdrop" onclick="fecharFotoModal(event)">
  <div class="foto-modal-inner">
    <div class="foto-modal-imgwrap">
      <img id="fotoModalImg" src="" alt="Foto da obra" />
    </div>
    <div class="foto-modal-footer">
      <div class="foto-modal-legenda">
        <div id="fotoModalData"></div>
        <div id="fotoModalLegenda"></div>
      </div>
      <button class="foto-modal-fechar" type="button" onclick="fecharFotoModal()">
        Fechar
      </button>
    </div>
  </div>
</div>

<script>
  const API_BASE       = "https://api.erpimpar.com.br/cronograma";
  const API_LOAD_URL   = API_BASE + "/carregar_cronograma.php";
  const API_LIST_OBRAS = API_BASE + "/listar_obras.php";
  const API_FOTOS      = API_BASE + "/fotos_obra.php";

  let chartStatus = null;
  let chartPlanejadoReal = null;

  // guarda qual obra est√° selecionada (arquivo JSON)
  let obraArquivoAtual = null;

  // ========= FUN√á√ïES DE DATA =========
  function parseDate(str){
    if(!str) return null;
    str = String(str).trim();
    const partsDash = str.split("-");
    if(partsDash.length === 3 && partsDash[0].length === 4){
      const [y,m,d] = partsDash.map(Number);
      return new Date(y, m-1, d);
    }
    const partsSlash = str.split("/");
    if(partsSlash.length === 3 && partsSlash[2].length === 4){
      const [d,m,y] = partsSlash.map(Number);
      return new Date(y, m-1, d);
    }
    const d = new Date(str);
    if(isNaN(d.getTime())) return null;
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }
  function formatDateBr(d){
    if(!d) return "‚Äî";
    const dia = String(d.getDate()).padStart(2,"0");
    const mes = String(d.getMonth()+1).padStart(2,"0");
    const ano = d.getFullYear();
    return `${dia}/${mes}/${ano}`;
  }
  function hojeData(){
    const a = new Date();
    return new Date(a.getFullYear(), a.getMonth(), a.getDate());
  }

  function arredondarPercentual(p){
    const steps = [0,25,50,75,100];
    let melhor = steps[0];
    let menorDif = Math.abs(p-steps[0]);
    for(const s of steps){
      const dif = Math.abs(p-s);
      if(dif < menorDif){
        menorDif = dif;
        melhor = s;
      }
    }
    return melhor;
  }

  // ========= MONTA LISTA DE ATIVIDADES =========
  function montarAtividadesDeJson(json){
    let atividadesBase = [];
    if(json.baseline && Array.isArray(json.baseline.versoes) && json.baseline.versoes.length){
      const ultima = json.baseline.versoes[json.baseline.versoes.length-1];
      if(ultima && Array.isArray(ultima.atividades)){
        atividadesBase = ultima.atividades;
      }
    }
    const realAtividades = (json.real && Array.isArray(json.real.atividades))
      ? json.real.atividades
      : [];

    const mapaReal = {};
    realAtividades.forEach(r => {
      const key = r.id != null
        ? String(r.id)
        : (r.idBaseline != null ? String(r.idBaseline) : null);
      if(key) mapaReal[key] = r;
    });

    const hoje = hojeData();
    const lista = atividadesBase.map((b, idx) => {
      const key = b.id != null ? String(b.id) : String(idx);
      const r   = mapaReal[key] || {};

      const baseIniStr = b.inicio || b.inicioStr || "";
      const baseFimStr = b.fim    || b.fimStr    || "";

      const realIniStr = r.inicio || r.inicioStr || baseIniStr;
      const realFimStr = r.fim    || r.fimStr    || baseFimStr;

      const baseIni = baseIniStr ? parseDate(baseIniStr) : null;
      const baseFim = baseFimStr ? parseDate(baseFimStr) : null;
      const ini     = realIniStr ? parseDate(realIniStr) : null;
      const fim     = realFimStr ? parseDate(realFimStr) : null;

      const durBase = b.duracaoDias || b.duracao || 0;
      const durReal = r.duracaoDias || r.duracao || durBase || 0;

      const percReal = Number(r.realPercent || r.percentual || 0) || 0;

      let plannedPercent = 0;
      if(baseIni && baseFim){
        if(hoje <= baseIni){
          plannedPercent = 0;
        }else if(hoje >= baseFim){
          plannedPercent = 100;
        }else{
          const totalMs = baseFim - baseIni;
          const elapsedMs = hoje - baseIni;
          let perc = (elapsedMs / totalMs) * 100;
          if(isNaN(perc)) perc = 0;
          perc = Math.min(100, Math.max(0, perc));
          plannedPercent = arredondarPercentual(perc);
        }
      }

      let status = "N√£o iniciado";
      let statusClass = "status-nao-iniciado";
      const pr = plannedPercent;
      const rr = percReal;
      if(rr === 0 && pr === 0){
        status = "N√£o iniciado";
        statusClass = "nao-iniciado";
      }else if(rr >= 100 && pr >= 100){
        status = "Conclu√≠do";
        statusClass = "concluido";
      }else if(rr < pr){
        status = "Atrasado";
        statusClass = "atrasado";
      }else{
        status = "Em andamento";
        statusClass = "em-andamento";
      }

      return {
        id: b.id,
        atividade: b.atividade || "",
        responsavel: (r.responsavel || b.responsavel || "").toString(),
        baselineInicio: baseIni,
        baselineFim: baseFim,
        inicio: ini,
        fim: fim,
        duracaoBase: durBase,
        duracaoReal: durReal,
        plannedPercent,
        realPercent: percReal,
        status,
        statusClass,
        observacao: r.observacao || b.observacao || ""
      };
    });

    return lista;
  }

  // ========= RESUMO GLOBAL =========
  function calcularResumoGlobal(atividades){
    if(!atividades || !atividades.length){
      return {
        baseline_inicio:null,
        baseline_fim:null,
        real_inicio:null,
        real_fim:null,
        perc_planejado:0,
        perc_real:0,
        status:"Sem in√≠cio",
        status_classe:"status-sem-inicio"
      };
    }

    let baseIni = null, baseFim = null;
    let realIni = null, realFim = null;
    let somaPlan=0, pesoPlan=0;
    let somaReal=0, pesoReal=0;

    atividades.forEach(a => {
      if(a.baselineInicio){
        if(!baseIni || a.baselineInicio < baseIni) baseIni = a.baselineInicio;
      }
      if(a.baselineFim){
        if(!baseFim || a.baselineFim > baseFim) baseFim = a.baselineFim;
      }
      if(a.inicio){
        if(!realIni || a.inicio < realIni) realIni = a.inicio;
      }
      if(a.fim){
        if(!realFim || a.fim > realFim) realFim = a.fim;
      }

      const durBase = a.duracaoBase || 0;
      const durReal = a.duracaoReal || durBase || 0;

      somaPlan += a.plannedPercent * (durBase || 1);
      pesoPlan += (durBase || 1);

      somaReal += a.realPercent * (durReal || 1);
      pesoReal += (durReal || 1);
    });

    const percPlanejado = pesoPlan ? Math.round(somaPlan / pesoPlan) : 0;
    const percReal      = pesoReal ? Math.round(somaReal / pesoReal) : 0;

    let status="Sem in√≠cio", statusClasse="status-sem-inicio";
    if(percReal >= 100 && percPlanejado >= 100){
      status="Conclu√≠do";
      statusClasse="status-concluido";
    }else if(percReal === 0 && percPlanejado === 0){
      status="Sem in√≠cio";
      statusClasse="status-sem-inicio";
    }else if(percReal >= percPlanejado){
      status="Em dia";
      statusClasse="status-em-dia";
    }else{
      status="Atrasado";
      statusClasse="status-atrasado";
    }

    return {
      baseline_inicio: baseIni,
      baseline_fim: baseFim,
      real_inicio: realIni,
      real_fim: realFim,
      perc_planejado: percPlanejado,
      perc_real: percReal,
      status: status,
      status_classe: statusClasse
    };
  }

  // ========= CARREGAR UMA OBRA =========
  async function carregarStatusPorArquivo(arquivo){
    if(!arquivo) return;

    obraArquivoAtual = arquivo;  // guarda para fotos

    document.getElementById("erroGlobal").style.display = "none";
    document.getElementById("listaUpdates").innerHTML =
      '<div class="loading">Carregando dados da obra...</div>';

    try{
      const resp = await fetch(API_LOAD_URL + "?arquivo=" + encodeURIComponent(arquivo));
      const json = await resp.json();
      if(json.error){
        document.getElementById("erroGlobal").textContent =
          "N√£o foi poss√≠vel carregar o cronograma desta obra (" + (json.message || "erro do servidor") + ").";
        document.getElementById("erroGlobal").style.display = "block";
        return;
      }

      const obraNome = json.obra || "Obra n√£o identificada";
      const coord    = json.coordenador || "‚Äî";

      document.getElementById("lblObraNome").textContent = obraNome;
      document.getElementById("lblCoordenador").textContent = "Coordenador: " + coord;

      const agora = new Date();
      document.getElementById("lblAtualizadoEm").textContent =
        agora.toLocaleString("pt-BR", {day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});

      const atividades = montarAtividadesDeJson(json);

      let resumo = json.resumo || null;
      if(!resumo || typeof resumo.baseline_inicio !== "string"){
        resumo = calcularResumoGlobal(atividades);
      }

      aplicarResumoNaTela(resumo, atividades);
      aplicarUpdatesNaTela(atividades);
      carregarFotosObra();   // üì∏ carrega fotos da obra

    }catch(e){
      console.error("Erro ao carregar status da obra:", e);
      document.getElementById("erroGlobal").textContent =
        "Erro de comunica√ß√£o ao carregar o status da obra.";
      document.getElementById("erroGlobal").style.display = "block";
    }
  }

  // ========= APLICA RESUMO / CHARTS =========
  function aplicarResumoNaTela(resumo, atividades){
    let baseIniStr = "‚Äî", baseFimStr="‚Äî", realIniStr="‚Äî", realFimStr="‚Äî";
    if(resumo.baseline_inicio instanceof Date){
      baseIniStr = formatDateBr(resumo.baseline_inicio);
    }else if(typeof resumo.baseline_inicio === "string"){
      baseIniStr = resumo.baseline_inicio;
    }
    if(resumo.baseline_fim instanceof Date){
      baseFimStr = formatDateBr(resumo.baseline_fim);
    }else if(typeof resumo.baseline_fim === "string"){
      baseFimStr = resumo.baseline_fim;
    }
    if(resumo.real_inicio instanceof Date){
      realIniStr = formatDateBr(resumo.real_inicio);
    }else if(typeof resumo.real_inicio === "string"){
      realIniStr = resumo.real_inicio;
    }
    if(resumo.real_fim instanceof Date){
      realFimStr = formatDateBr(resumo.real_fim);
    }else if(typeof resumo.real_fim === "string"){
      realFimStr = resumo.real_fim;
    }

    const percPlan = Number(resumo.perc_planejado || 0);
    const percReal = Number(resumo.perc_real || 0);

    document.getElementById("kpiPlanejado").textContent = percPlan + "%";
    document.getElementById("kpiReal").textContent = percReal + "%";

    if(percPlan === 0){
      document.getElementById("kpiPlanejadoDetalhe").textContent =
        "Baseline ainda n√£o consolidada ou fora da janela de in√≠cio.";
    }else{
      document.getElementById("kpiPlanejadoDetalhe").textContent =
        "Percentual de avan√ßo esperado at√© hoje, de acordo com a programa√ß√£o.";
    }

    if(percReal === 0){
      document.getElementById("kpiRealDetalhe").textContent =
        "Nenhum avan√ßo f√≠sico registrado at√© o momento.";
    }else{
      document.getElementById("kpiRealDetalhe").textContent =
        "Percentual de avan√ßo efetivamente realizado at√© hoje.";
    }

    document.getElementById("kpiPeriodoBase").textContent =
      baseIniStr !== "‚Äî" && baseFimStr !== "‚Äî"
        ? `${baseIniStr} ‚Üí ${baseFimStr}`
        : "‚Äî";

    const totalAtiv = atividades.length;
    const concluidas   = atividades.filter(a => a.status === "Conclu√≠do").length;
    const atrasadas    = atividades.filter(a => a.status === "Atrasado").length;
    const andamento    = atividades.filter(a => a.status === "Em andamento").length;
    const naoIniciadas = atividades.filter(a => a.status === "N√£o iniciado").length;

    document.getElementById("kpiAtividadesTotal").textContent = totalAtiv;
    document.getElementById("kpiAtividadesDetalhe").textContent =
      `${concluidas} conclu√≠da(s), ${andamento} em andamento, ${atrasadas} atrasada(s).`;

    const status = resumo.status || "Sem in√≠cio";
    const statusClasse = resumo.status_classe || "status-sem-inicio";

    const badge = document.getElementById("statusBadge");
    badge.className = "status-badge " + statusClasse;

    document.getElementById("lblStatus").textContent = "Status geral: " + status;

    document.getElementById("infoStatus").textContent = status;
    document.getElementById("infoPercs").textContent =
      `Planejado: ${percPlan}% ‚Ä¢ Real: ${percReal}%`;
    document.getElementById("infoBaseline").textContent =
      baseIniStr !== "‚Äî" && baseFimStr !== "‚Äî"
        ? `${baseIniStr} a ${baseFimStr}`
        : "N√£o informado";
    document.getElementById("infoExecucao").textContent =
      realIniStr !== "‚Äî" && realFimStr !== "‚Äî"
        ? `${realIniStr} a ${realFimStr}`
        : "Ainda n√£o iniciada ou em registro inicial.";

    const elChartStatus = document.getElementById("chartStatusAtividades");
    const dataStatus = [concluidas, andamento, atrasadas, naoIniciadas];
    const temAlguma = dataStatus.some(v => v>0);

    if(!temAlguma){
      document.getElementById("chartStatusResumo").textContent =
        "Ainda n√£o h√° atividades conclu√≠das ou em andamento registradas.";
    }else{
      document.getElementById("chartStatusResumo").textContent = "";
    }

    if(chartStatus){
      chartStatus.destroy();
      chartStatus = null;
    }
    chartStatus = new Chart(elChartStatus, {
      type:"doughnut",
      data:{
        labels:["Conclu√≠das","Em andamento","Atrasadas","N√£o iniciadas"],
        datasets:[{
          data:dataStatus
        }]
      },
      options:{
        plugins:{
          legend:{
            position:"bottom",
            labels:{ color:"#e5e7eb", font:{size:10} }
          },
          tooltip:{
            enabled:true,
            callbacks:{
              label: function(ctx){
                const label = ctx.label || "";
                const value = ctx.parsed;
                return `${label}: ${value} atividade(s)`;
              }
            }
          }
        },
        cutout:"55%"
      }
    });

    const elChartPR = document.getElementById("chartPlanejadoReal");
    if(chartPlanejadoReal){
      chartPlanejadoReal.destroy();
      chartPlanejadoReal = null;
    }
    chartPlanejadoReal = new Chart(elChartPR, {
      type:"bar",
      data:{
        labels:["Avan√ßo f√≠sico global"],
        datasets:[
          { label:"Planejado", data:[percPlan] },
          { label:"Real",      data:[percReal] }
        ]
      },
      options:{
        indexAxis:"y",
        scales:{
          x:{min:0, max:100, ticks:{color:"#e5e7eb"}, grid:{color:"#1f2937"}},
          y:{ticks:{color:"#e5e7eb"}, grid:{display:false}}
        },
        plugins:{
          legend:{labels:{color:"#e5e7eb", font:{size:10}}},
          tooltip:{enabled:true}
        }
      }
    });
  }

  // ========= OBSERVA√á√ïES =========
  function aplicarUpdatesNaTela(atividades){
    const container = document.getElementById("listaUpdates");
    if(!atividades || !atividades.length){
      container.className = "no-data";
      container.textContent = "Nenhuma atividade cadastrada.";
      return;
    }

    const updates = [];

    atividades.forEach(a => {
      const obs = (a.observacao || "").trim();
      if(!obs) return;

      const linhas = obs.split("\n").filter(l => l.trim());
      if(!linhas.length) return;

      linhas.forEach(linha => {
        updates.push({
          atividade: a.atividade || "Atividade",
          texto: linha
        });
      });
    });

    if(!updates.length){
      container.className = "no-data";
      container.textContent = "Nenhuma observa√ß√£o registrada at√© o momento.";
      return;
    }

    container.className = "";
    container.innerHTML = "";

    updates.forEach(up => {
      const div = document.createElement("div");
      div.className = "update-item";
      div.innerHTML = `
        <div class="update-atividade">${up.atividade}</div>
        <div class="update-texto">${up.texto}</div>
      `;
      container.appendChild(div);
    });
  }

  // ========= LISTAR S√ì OBRAS QUE POSSUEM CRONOGRAMA =========
  async function carregarObrasComCronograma(){
    const select = document.getElementById("obraSelect");
    const info   = document.getElementById("listaObrasInfo");

    select.innerHTML = `<option value="">Carregando obras com cronograma...</option>`;
    info.textContent = "";

    try{
      const resp = await fetch(API_LIST_OBRAS);
      const lista = await resp.json();
      if(!Array.isArray(lista)){
        throw new Error("Formato inesperado em listar_obras.php");
      }

      const obrasComArquivo = [];

      for(const o of lista){
        const idObra  = (o.id !== undefined && o.id !== null) ? String(o.id) : "";
        const nomeObra = o.obra || ("Obra " + (idObra || ""));

        if(!idObra && !nomeObra) continue;

        const arquivo = getArquivoNome(nomeObra, idObra);
        if(!arquivo) continue;

        try{
          const r = await fetch(API_LOAD_URL + "?arquivo=" + encodeURIComponent(arquivo));
          const j = await r.json();
          // S√≥ considera "com cronograma" se tiver baseline OU real com atividades
          const temBaseline = j.baseline && j.baseline.versoes && j.baseline.versoes.length;
          const temReal     = j.real && Array.isArray(j.real.atividades) && j.real.atividades.length;
          if(!j.error && (temBaseline || temReal)){
            obrasComArquivo.push({
              id:idObra,
              obra:nomeObra,
              arquivo:arquivo
            });
          }
        }catch(e2){
          console.warn("Erro ao testar cronograma da obra", nomeObra, e2);
        }
      }

      select.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = obrasComArquivo.length
        ? "Selecione a obra para visualizar o status"
        : "Nenhuma obra com cronograma encontrada";
      select.appendChild(opt0);

      obrasComArquivo.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.arquivo;
        opt.textContent = o.obra;
        opt.setAttribute("data-id", o.id);
        select.appendChild(opt);
      });

      info.textContent = obrasComArquivo.length
        ? `${obrasComArquivo.length} obra(s) com cronograma dispon√≠vel.`
        : "Nenhum cronograma encontrado at√© o momento.";

    }catch(e){
      console.error("Erro ao carregar obras com cronograma:", e);
      select.innerHTML = `<option value="">Erro ao carregar lista de obras</option>`;
      info.textContent = "Tente novamente mais tarde.";
    }
  }

  function getArquivoNome(obraNomeParam, obraIdParam){
    const obraId = obraIdParam ? String(obraIdParam).trim() : "";
    const obraNome = obraNomeParam ? String(obraNomeParam).trim() : "";

    if(obraId){
      return "obra_" + obraId.padStart(3,"0") + ".json";
    }
    if(!obraNome) return null;
    const slug = obraNome
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-zA-Z0-9]+/g,"_")
      .replace(/^_+|_+$/g,"")
      .toUpperCase();
    return "obra_" + slug + ".json";
  }

  // ========= GALERIA DE FOTOS =========
  async function carregarFotosObra(){
    const galeria = document.getElementById("galeriaFotos");
    if(!galeria) return;

    if(!obraArquivoAtual){
      galeria.className = "fotos-list no-data";
      galeria.textContent = "Selecione uma obra para visualizar as fotos.";
      return;
    }

    galeria.className = "fotos-list loading";
    galeria.textContent = "Carregando fotos da obra...";

    try{
      const resp = await fetch(
        `${API_FOTOS}?acao=listar&arquivo=${encodeURIComponent(obraArquivoAtual)}`
      );
      const json = await resp.json();
      if(json.error){
        galeria.className = "fotos-list no-data";
        galeria.textContent = json.message || "Erro ao carregar fotos.";
        return;
      }
      const fotos = json.fotos || [];
      renderizarFotos(fotos);
    }catch(e){
      console.error("Erro ao listar fotos:", e);
      galeria.className = "fotos-list no-data";
      galeria.textContent = "Erro ao carregar fotos da obra.";
    }
  }

  function renderizarFotos(fotos){
    const galeria = document.getElementById("galeriaFotos");
    if(!galeria) return;

    if(!fotos.length){
      galeria.className = "fotos-list no-data";
      galeria.textContent = "Nenhuma foto cadastrada para esta obra.";
      return;
    }

    galeria.className = "fotos-list";
    galeria.innerHTML = "";

    fotos.forEach(f => {
      const card = document.createElement("div");
      card.className = "foto-card";
      card.innerHTML = `
        <div class="foto-thumb-wrap">
          <img class="foto-thumb"
               src="${f.url}"
               alt="${(f.legenda || "Foto da obra").replace(/"/g,"&quot;")}">
        </div>
        <div class="foto-meta">
          <div class="foto-data">${f.data || ""}</div>
          <div class="foto-legenda">${f.legenda || "Foto da obra"}</div>
        </div>
        <button class="foto-delete" type="button" title="Excluir foto">üóë</button>
      `;
      card.querySelector(".foto-thumb-wrap").addEventListener("click", () => abrirFotoModal(f));
      card.querySelector(".foto-delete").addEventListener("click", () => excluirFoto(f.id));
      galeria.appendChild(card);
    });
  }

  function abrirSelecaoFoto(){
    if(!obraArquivoAtual){
      alert("Selecione uma obra antes de adicionar fotos.");
      return;
    }
    const input = document.getElementById("fotoInput");
    if(input) input.click();
  }

  function abrirSelecaoVideo(){
    if(!obraArquivoAtual){
      alert("Selecione uma obra antes de adicionar v√≠deos.");
      return;
    }
    const input = document.getElementById("videoInput");
    if(input) input.click();
  }

// upload ao selecionar arquivo
  document.addEventListener("DOMContentLoaded", () => {
    const input = document.getElementById("fotoInput");
    if(input){
      input.addEventListener("change", async (ev) => {
        const file = ev.target.files[0];
        if(!file || !obraArquivoAtual) return;

        const legenda = prompt("Digite uma legenda curta para a foto (opcional):", "") || "";

        const fd = new FormData();
        fd.append("acao", "upload");
        fd.append("arquivo", obraArquivoAtual);
        fd.append("foto", file);
        fd.append("legenda", legenda);

        try{
          const resp = await fetch(API_FOTOS, {
            method:"POST",
            body: fd
          });
          const json = await resp.json();
          if(json.error){
            alert(json.message || "Erro ao enviar foto.");
          }else{
            carregarFotosObra();
          }
        }catch(e){
          console.error("Erro ao enviar foto:", e);
          alert("Erro ao enviar foto da obra.");
        }finally{
          ev.target.value = "";
        }
      });
    }

    const inputVideo = document.getElementById("videoInput");
    if(inputVideo){
      inputVideo.addEventListener("change", async (ev) => {
        const file = ev.target.files[0];
        if(!file || !obraArquivoAtual) return;

        const legenda = prompt("Digite uma legenda curta para o v√≠deo (opcional):", "") || "";

        const fd = new FormData();
        fd.append("acao", "upload");
        fd.append("arquivo", obraArquivoAtual);
        fd.append("foto", file);
        fd.append("legenda", legenda);
        fd.append("tipo", "video");

        try{
          const resp = await fetch(API_FOTOS, {
            method:"POST",
            body: fd
          });
          const json = await resp.json();
          if(json.error){
            alert(json.message || "Erro ao enviar v√≠deo.");
          }else{
            carregarFotosObra();
          }
        }catch(e){
          console.error("Erro ao enviar v√≠deo:", e);
          alert("Erro ao enviar v√≠deo da obra.");
        }finally{
          ev.target.value = "";
        }
      });
    }
  });

  async function excluirFoto(idFoto){
    if(!obraArquivoAtual || !idFoto) return;
    if(!confirm("Deseja realmente excluir esta foto da obra?")) return;

    try{
      const resp = await fetch(API_FOTOS + "?acao=excluir", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          arquivo: obraArquivoAtual,
          id: idFoto
        })
      });
      const json = await resp.json();
      if(json.error){
        alert(json.message || "Erro ao excluir foto.");
      }else{
        carregarFotosObra();
      }
    }catch(e){
      console.error("Erro ao excluir foto:", e);
      alert("Erro ao excluir foto da obra.");
    }
  }

  function abrirFotoModal(foto){
    const backdrop = document.getElementById("fotoModal");
    if(!backdrop) return;
    document.getElementById("fotoModalImg").src = foto.url;
    document.getElementById("fotoModalData").textContent = foto.data || "";
    document.getElementById("fotoModalLegenda").textContent = foto.legenda || "Foto da obra";
    backdrop.style.display = "flex";
  }

  function fecharFotoModal(ev){
    if(ev && ev.target && !ev.target.classList.contains("foto-modal-backdrop") && ev.target.id !== "fotoModal"){
      // clique dentro do modal, ignora
      const backdrop = document.getElementById("fotoModal");
      if(ev.target === backdrop){
        backdrop.style.display = "none";
      }
      return;
    }
    const backdrop = document.getElementById("fotoModal");
    if(backdrop){
      backdrop.style.display = "none";
    }
  }

  // ========= PDF E COMPARTILHAR =========
  async function baixarPDF(){
    const elem = document.getElementById("printArea");
    if(!elem) return;

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "mm", "a4");

    const canvas = await html2canvas(elem, {scale:2, useCORS:true});
    const imgData = canvas.toDataURL("image/png");

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgProps = pdf.getImageProperties(imgData);
    const imgWidth = pageWidth - 20;
    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

    let y = 10;
    if(imgHeight > pageHeight-20){
      const ratio = (pageHeight-20)/imgHeight;
      const finalWidth = imgWidth * ratio;
      const finalHeight = imgHeight * ratio;
      const x = (pageWidth-finalWidth)/2;
      pdf.addImage(imgData, "PNG", x, 10, finalWidth, finalHeight);
    }else{
      const x = (pageWidth-imgWidth)/2;
      pdf.addImage(imgData, "PNG", x, y, imgWidth, imgHeight);
    }

    const nomeObra = document.getElementById("lblObraNome").textContent || "obra";
    const slug = nomeObra
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-zA-Z0-9]+/g,"_")
      .replace(/^_+|_+$/g,"")
      .toLowerCase();

    pdf.save(`status_${slug}.pdf`);
  }

  function compartilharStatus(){
    const nomeObra = document.getElementById("lblObraNome").textContent || "sua obra";
    const status   = document.getElementById("infoStatus").textContent || "Sem in√≠cio";
    const percs    = document.getElementById("infoPercs").textContent || "";

    const texto = `Status da obra ‚Äì ${nomeObra}\n` +
                  `${status}\n` +
                  `${percs}\n\n` +
                  `Relat√≥rio gerado automaticamente via ERP √çMPAR.`;

    if(navigator.share){
      navigator.share({
        title: `Status da obra ‚Äì ${nomeObra}`,
        text: texto,
        url: window.location.href
      }).catch(err => {
        console.warn("Compartilhamento cancelado ou n√£o dispon√≠vel:", err);
      });
    }else{
      alert("O compartilhamento nativo n√£o est√° dispon√≠vel neste dispositivo/navegador.");
    }
  }

  // ========= NAVEGA√á√ÉO =========
  function voltarMenu(){
    window.location.href = "../index.html";
  }
  function voltarFarol(){
    window.location.href = "farol.html";
  }

  // ========= INIT =========
  document.addEventListener("DOMContentLoaded", async () => {
    const params = new URLSearchParams(window.location.search);
    const arquivoUrl = params.get("arquivo");
    const idUrl = params.get("id");

    const select = document.getElementById("obraSelect");

    carregarObrasComCronograma();

    if(arquivoUrl){
      carregarStatusPorArquivo(arquivoUrl);
      select.value = arquivoUrl;
    }else if(idUrl){
      const arquivo = getArquivoNome(null, idUrl);
      carregarStatusPorArquivo(arquivo);
      select.value = arquivo;
    }

    select.addEventListener("change", () => {
      const arq = select.value;
      if(arq){
        carregarStatusPorArquivo(arq);
        const url = new URL(window.location.href);
        url.searchParams.set("arquivo", arq);
        window.history.replaceState({}, "", url.toString());
      }
    });
  });
</script>

</body>
</html>

