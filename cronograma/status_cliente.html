<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>ERP √çMPAR ‚Äì Status cliente da obra</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#020617;
      --card:#020617;
      --border:#1f2937;
      --text:#e5e7eb;
      --text-soft:#9ca3af;
      --blue:#3b82f6;
      --blue-dark:#1d4ed8;
      --green:#22c55e;
      --yellow:#eab308;
      --red:#ef4444;
      --accent:#cc6e00;
    }
    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(circle at top left,#1d4ed8 0,transparent 55%),
        radial-gradient(circle at bottom right,#f97316 0,transparent 55%),
        linear-gradient(120deg,#020617,#020617 60%,#030712);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      padding:10px 16px 4px;
      display:flex;
      justify-content:center;
    }
    .header-inner{
      width:100%;
      max-width:1200px;
      display:flex;
      justify-content:space-between;
      gap:16px;
      align-items:flex-start;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      text-shadow:0 2px 6px rgba(0,0,0,.8);
    }
    .brand span:nth-child(1){
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.22em;
      opacity:.9;
    }
    .brand span:nth-child(2){
      font-size:20px;
      font-weight:800;
    }
    .brand span:nth-child(3){
      font-size:11px;
      opacity:.9;
    }
    .tag-top{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.7);
      color:var(--text-soft);
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:12px;
    }
    .pill-btn{
      border-radius:999px;
      border:1px solid #4b5563;
      background:#020617;
      padding:5px 10px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--text-soft);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .pill-btn span.icn{font-size:12px;}
    .pill-btn:hover{
      border-color:#9ca3af;
      color:#e5e7eb;
    }
    .pill-btn[disabled]{
      opacity:.4;
      cursor:not-allowed;
      border-color:#374151;
    }

    main{
      flex:1 0 auto;
      display:flex;
      justify-content:center;
      padding:6px 12px 16px;
    }
    .layout{
      width:100%;
      max-width:1200px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .container {
      background:rgba(15,23,42,.96);
      border-radius:18px;
      border:1px solid rgba(55,65,81,.9);
      box-shadow:0 18px 40px rgba(0,0,0,.75);
      padding:16px 18px 18px;
    }

    h1 {
      margin-top:0;
      color:#ffffff;
      font-size:18px;
      margin-bottom:6px;
    }

    .subtitulo{
      font-size:12px;
      color:var(--text-soft);
      margin-bottom:10px;
    }

    .form-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:10px;
    }
    .form-row > div {
      flex:1;
      min-width:200px;
    }

    label {
      display:block;
      font-size:12px;
      margin-bottom:3px;
      color:#cfd8ff;
    }

    select {
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #293552;
      background:#020617;
      color:#f5f5f5;
      font-size:13px;
    }

    .info-header{
      font-size:12px;
      color:#cfd8ff;
      margin-top:4px;
    }

    .acoes-topo{
      margin-top:4px;
      display:flex;
      justify-content:flex-end;
    }

    .grid-metricas{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(190px,1fr));
      gap:10px;
      margin-top:12px;
    }
    .card-metrica{
      background:#020617;
      border-radius:14px;
      border:1px solid #1f2937;
      padding:10px 12px;
    }
    .card-metrica-titulo{
      font-size:11px;
      color:#9ca3af;
      margin-bottom:4px;
    }
    .card-metrica-valor{
      font-size:22px;
      font-weight:700;
    }
    .badge-status{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      font-size:11px;
      border-radius:999px;
      border:1px solid #374151;
      margin-top:4px;
    }
    .badge-status.atrasado{
      border-color:var(--red);
      color:#fecaca;
    }
    .badge-status.andamento{
      border-color:var(--yellow);
      color:#fef3c7;
    }
    .badge-status.concluido{
      border-color:var(--green);
      color:#bbf7d0;
    }
    .badge-status.nao-iniciado{
      border-color:#4b5563;
      color:#e5e7eb;
    }

    .lista-resumo{
      font-size:12px;
      color:#e5e7eb;
      margin-top:6px;
      line-height:1.5;
    }

    .bloco{
      margin-top:14px;
      background:#020617;
      border-radius:14px;
      border:1px solid #1f2937;
      padding:10px 12px;
    }
    .bloco-titulo{
      font-size:13px;
      font-weight:600;
      margin-bottom:6px;
    }

    .tabela-simples{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin-top:4px;
    }
    .tabela-simples th,
    .tabela-simples td{
      padding:4px 6px;
      border-bottom:1px solid #1f2937;
      text-align:left;
    }
    .tabela-simples th{
      color:#9ca3af;
      font-weight:500;
    }

    .lista-comentarios{
      list-style:none;
      font-size:11px;
      color:#e5e7eb;
      margin-top:4px;
    }
    .lista-comentarios li{
      padding:6px 0;
      border-bottom:1px solid #1f2937;
    }
    .coment-meta{
      font-size:10px;
      color:#9ca3af;
      margin-bottom:2px;
    }

    footer{
      background:#020617;
      color:#9ca3af;
      padding:6px 16px;
      font-size:10px;
    }
    .rodape-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    @media(max-width:900px){
      .container{padding:14px 12px 16px;}
      h1{font-size:16px;}
    }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <span>PLATAFORMA</span>
      <span>ERP √çMPAR ‚Ä¢ Cronograma de Obras</span>
      <span>Status executivo para cliente</span>
    </div>
    <div class="tag-top">
      <button class="pill-btn" type="button" onclick="window.location.href='farol.html'">
        <span class="icn">‚Üê</span> Farol de obras
      </button>
      <button class="pill-btn" type="button" onclick="window.location.href='../index.html'">
        <span class="icn">üè†</span> Menu principal
      </button>
    </div>
  </div>
</header>

<main>
  <div class="layout">
    <!-- PAINEL QUE VIRA PDF -->
    <div class="container" id="painelCliente">
      <h1>Status cliente da obra</h1>
      <div class="subtitulo">
        Vis√£o executiva em um s√≥ painel: planejamento x realizado, atrasos, respons√°veis
        e principais coment√°rios da obra, pronto para apresentar ao cliente.
      </div>

      <div class="form-row">
        <div>
          <label for="obra">Obra</label>
          <select id="obra">
            <option value="">Selecione a obra</option>
          </select>
        </div>
      </div>

      <div class="acoes-topo">
        <button class="pill-btn" type="button" id="btnGerarPdf" disabled>
          <span class="icn">‚¨áÔ∏è</span> PDF / Compartilhar
        </button>
      </div>

      <div class="info-header" id="infoHeader"></div>

      <!-- M√âTRICAS PRINCIPAIS -->
      <div class="grid-metricas" id="gridMetricas" style="display:none;">
        <div class="card-metrica">
          <div class="card-metrica-titulo">Planejado x Real</div>
          <div class="card-metrica-valor" id="metricaPlanejadoReal">0% / 0%</div>
          <div id="badgeStatusObra" class="badge-status nao-iniciado">Situa√ß√£o: N√£o iniciado</div>
        </div>

        <div class="card-metrica">
          <div class="card-metrica-titulo">Atividades do cronograma</div>
          <div class="card-metrica-valor" id="metricaTotalAtv">0</div>
          <div class="lista-resumo" id="resumoAtividades"></div>
        </div>

        <div class="card-metrica">
          <div class="card-metrica-titulo">Janela da obra</div>
          <div class="card-metrica-valor" id="metricaPeriodo">‚Äì</div>
          <div class="lista-resumo" id="resumoPeriodo"></div>
        </div>

        <div class="card-metrica">
          <div class="card-metrica-titulo">Carga do coordenador</div>
          <div class="card-metrica-valor" id="metricaCoordenadorObras">‚Äì</div>
          <div class="lista-resumo" id="resumoCoordenador"></div>
        </div>
      </div>

      <!-- RESPONS√ÅVEIS -->
      <div class="bloco" id="blocoResponsaveis" style="display:none;">
        <div class="bloco-titulo">Distribui√ß√£o de atividades por respons√°vel</div>
        <table class="tabela-simples" id="tabelaResponsaveis">
          <thead>
            <tr>
              <th>Respons√°vel</th>
              <th>Qtde de atividades</th>
              <th>% do total</th>
              <th>Avan√ßo m√©dio</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- COMENT√ÅRIOS -->
      <div class="bloco" id="blocoComentarios" style="display:none;">
        <div class="bloco-titulo">Coment√°rios do cronograma</div>
        <ul class="lista-comentarios" id="listaComentarios"></ul>
      </div>

    </div>
  </div>
</main>

<footer>
  <div class="rodape-inner">
    <span>¬© 2025 ERP √çMPAR ‚Ä¢ M√≥dulo Cronograma de Obras</span>
    <span>Painel executivo para apresenta√ß√£o ao cliente</span>
  </div>
</footer>

<!-- Libs para gerar PDF a partir do HTML -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  // ===== CONFIG API (mesmo padr√£o do cronograma) =====
  const API_BASE = "https://api.erpimpar.com.br/cronograma";
  const API_LOAD_URL = API_BASE + "/carregar_cronograma.php";
  const API_LIST_OBRAS = API_BASE + "/listar_obras.php";

  let atividades = [];
  let resumoDados = null;
  let coordenadorAtual = "";
  let obraSelecionadaObj = null;
  let listaObrasCache = [];

  const { jsPDF } = window.jspdf || {};

  // ===== Utilidades de data (mesmo padr√£o) =====
  function parseDate(str) {
    if (!str) return null;
    const partsDash = str.split("-");
    if (partsDash.length === 3 && partsDash[0].length === 4) {
      const [y, m, d] = partsDash.map(Number);
      return new Date(y, m - 1, d);
    }
    const partsSlash = str.split("/");
    if (partsSlash.length === 3 && partsSlash[2].length === 4) {
      const [d, m, y] = partsSlash.map(Number);
      return new Date(y, m - 1, d);
    }
    const d = new Date(str);
    if (isNaN(d.getTime())) return null;
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }

  function formatDateBr(date) {
    const d = String(date.getDate()).padStart(2, "0");
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const y = date.getFullYear();
    return `${d}/${m}/${y}`;
  }

  function diffInDays(inicio, fim) {
    const ms = fim - inicio;
    return Math.round(ms / (1000*60*60*24)) + 1;
  }

  function dataHoje() {
    const agora = new Date();
    return new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
  }

  function slugify(text){
    return (text || "")
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-zA-Z0-9]+/g,"_")
      .replace(/^_+|_+$/g,"")
      .toLowerCase();
  }

  // ===== Helpers de obra / arquivo =====
  function getObraSelecionadaDrop() {
    const sel = document.getElementById("obra");
    const opt = sel.options[sel.selectedIndex];
    return {
      nome: opt ? opt.textContent.trim() : "",
      id:   opt ? (opt.getAttribute("data-id") || "").trim() : ""
    };
  }

  function getArquivoNome(obraNomeParam, obraIdParam) {
    const { nome, id } = getObraSelecionadaDrop();
    const obraId   = obraIdParam   || id;
    const obraNome = obraNomeParam || nome;

    if (obraId) {
      return "obra_" + String(obraId).padStart(3,"0") + ".json";
    }
    if (!obraNome) return null;
    const slug = obraNome
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-zA-Z0-9]+/g,"_")
      .replace(/^_+|_+$/g,"")
      .toUpperCase();
    return "obra_" + slug + ".json";
  }

  // ===== Monta atividades a partir do JSON "novo" (baseline / real) =====
  function montarAtividadesDeJsonCronograma(json) {
    const obraNome = json.obra || "";
    const obraId   = json.id   || "";
    const coord    = json.coordenador || "";

    let atividadesBase = [];
    if (json.baseline && Array.isArray(json.baseline.versoes) && json.baseline.versoes.length) {
      const ultimaVersao = json.baseline.versoes[json.baseline.versoes.length - 1];
      if (ultimaVersao && Array.isArray(ultimaVersao.atividades)) {
        atividadesBase = ultimaVersao.atividades;
      }
    }

    const realAtividades = (json.real && Array.isArray(json.real.atividades))
      ? json.real.atividades
      : [];

    const mapaReal = {};
    realAtividades.forEach(r => {
      const key =
        r.id != null ? String(r.id) :
        (r.idBaseline != null ? String(r.idBaseline) : null);
      if (key) mapaReal[key] = r;
    });

    const lista = atividadesBase.map((b, idx) => {
      const key = b.id != null ? String(b.id) : String(idx);
      const r   = mapaReal[key] || {};

      const baselineInicioStr = b.inicio || b.inicioStr || "";
      const baselineFimStr    = b.fim    || b.fimStr    || "";

      const inicioRealStr = r.inicio || r.inicioStr || baselineInicioStr;
      const fimRealStr    = r.fim    || r.fimStr    || baselineFimStr;

      const baselineInicio = baselineInicioStr ? parseDate(baselineInicioStr) : null;
      const baselineFim    = baselineFimStr    ? parseDate(baselineFimStr)    : null;
      const inicio         = inicioRealStr ? parseDate(inicioRealStr) : null;
      const fim            = fimRealStr    ? parseDate(fimRealStr)    : null;

      const realPercent = Number(r.realPercent || r.percentual || 0) || 0;

      return {
        id: b.id,
        atividade: b.atividade || "",
        responsavel: (r.responsavel || b.responsavel || "").toString() || "N√£o informado",
        inicio,
        fim,
        inicioStr: inicioRealStr || "",
        fimStr: fimRealStr || "",
        baselineInicio,
        baselineFim,
        baselineInicioStr,
        baselineFimStr,
        baselineDuracaoDias: b.duracaoDias || 0,
        realPercent,
        comentarios: r.comentarios || r.observacoes || b.comentarios || b.observacoes || null
      };
    });

    return {
      atividades: lista,
      obraNome,
      obraId,
      coordenador: coord
    };
  }

  // ===== Resumo da obra (mesma regra de situa√ß√£o) =====
  function calcularResumoObraDados() {
    if (!atividades.length) return null;

    let baselineInicio = null;
    let baselineFim    = null;
    let realInicio     = null;
    let realFim        = null;

    let somaPlan = 0;
    let pesoPlan = 0;
    let somaReal = 0;
    let pesoReal = 0;

    const hoje = dataHoje();

    atividades.forEach(a => {
      if (a.baselineInicio && a.baselineFim) {
        if (!baselineInicio || a.baselineInicio < baselineInicio) baselineInicio = a.baselineInicio;
        if (!baselineFim    || a.baselineFim    > baselineFim)    baselineFim    = a.baselineFim;
      }
      if (a.inicio && a.fim) {
        if (!realInicio || a.inicio < realInicio) realInicio = a.inicio;
        if (!realFim    || a.fim    > realFim)    realFim    = a.fim;
      }

      let plannedPercent = 0;
      if (a.baselineInicio && a.baselineFim) {
        if (hoje <= a.baselineInicio) {
          plannedPercent = 0;
        } else if (hoje >= a.baselineFim) {
          plannedPercent = 100;
        } else {
          const totalMs = a.baselineFim - a.baselineInicio;
          const elapsedMs = hoje - a.baselineInicio;
          let perc = (elapsedMs / totalMs) * 100;
          perc = Math.min(100, Math.max(0, perc));
          plannedPercent = Math.round(perc);
        }
      }

      const durPlan = a.baselineDuracaoDias || 1;
      const durReal = 1;
      const rr = a.realPercent || 0;

      somaPlan += plannedPercent * durPlan;
      pesoPlan += durPlan;
      somaReal += rr * durReal;
      pesoReal += durReal;

      a._plannedPercent = plannedPercent;
    });

    const percPlanejado = pesoPlan ? Math.round(somaPlan / pesoPlan) : 0;
    const percReal      = pesoReal ? Math.round(somaReal / pesoReal) : 0;

    let status = "N√£o iniciado";
    let statusClasse = "nao-iniciado";

    if (percReal >= 100 && percPlanejado >= 100) {
      status = "Conclu√≠do";
      statusClasse = "concluido";
    } else if (percReal < percPlanejado) {
      if (percReal === 0 && percPlanejado === 0) {
        status = "N√£o iniciado";
        statusClasse = "nao-iniciado";
      } else {
        status = "Atrasado";
        statusClasse = "atrasado";
      }
    } else if (percReal === 0 && percPlanejado === 0) {
      status = "N√£o iniciado";
      statusClasse = "nao-iniciado";
    } else {
      status = "Em andamento";
      statusClasse = "andamento";
    }

    return {
      baselineInicio,
      baselineFim,
      realInicio,
      realFim,
      percPlanejado,
      percReal,
      status,
      statusClasse
    };
  }

  // ===== Renderiza√ß√£o do painel =====
  function atualizarPainel() {
    const grid = document.getElementById("gridMetricas");
    const infoHeader = document.getElementById("infoHeader");
    const blocoResp = document.getElementById("blocoResponsaveis");
    const blocoCom  = document.getElementById("blocoComentarios");
    const btnPdf    = document.getElementById("btnGerarPdf");

    if (!atividades.length || !obraSelecionadaObj) {
      grid.style.display = "none";
      blocoResp.style.display = "none";
      blocoCom.style.display = "none";
      infoHeader.textContent = "";
      if (btnPdf) btnPdf.disabled = true;
      return;
    }

    if (btnPdf) btnPdf.disabled = false;

    const { nome } = obraSelecionadaObj;
    const r = resumoDados;

    infoHeader.innerHTML =
      `Obra: <strong>${nome}</strong>` +
      (coordenadorAtual ? ` ‚Ä¢ Coordenador: <strong>${coordenadorAtual}</strong>` : "");

    grid.style.display = "grid";

    // Planejado x real
    document.getElementById("metricaPlanejadoReal").textContent =
      `${r.percPlanejado}% / ${r.percReal}%`;

    const badge = document.getElementById("badgeStatusObra");
    badge.textContent = "Situa√ß√£o: " + r.status;
    badge.className = "badge-status " + r.statusClasse;

    // Totais de atividades
    const total = atividades.length;
    const naoIniciadas = atividades.filter(a => (a.realPercent || 0) === 0).length;
    const concluidas   = atividades.filter(a => (a.realPercent || 0) >= 100).length;
    const atrasadas    = atividades.filter(a => (a.realPercent || 0) < (a._plannedPercent || 0) && (a.realPercent || 0) > 0).length;
    const emAndamento  = total - naoIniciadas - concluidas;

    document.getElementById("metricaTotalAtv").textContent = total;
    document.getElementById("resumoAtividades").innerHTML =
      `Conclu√≠das: <strong>${concluidas}</strong><br>` +
      `Em andamento: <strong>${emAndamento}</strong><br>` +
      `Em atraso: <strong>${atrasadas}</strong><br>` +
      `Ainda n√£o iniciadas: <strong>${naoIniciadas}</strong>`;

    // Per√≠odo
    let periodoStr = "‚Äì";
    if (r.realInicio && r.realFim) {
      periodoStr = `${formatDateBr(r.realInicio)} ‚Üí ${formatDateBr(r.realFim)}`;
    } else if (r.baselineInicio && r.baselineFim) {
      periodoStr = `${formatDateBr(r.baselineInicio)} ‚Üí ${formatDateBr(r.baselineFim)}`;
    }
    document.getElementById("metricaPeriodo").textContent = periodoStr;

    const resumoPeriodo = document.getElementById("resumoPeriodo");
    if (r.baselineInicio && r.baselineFim) {
      const diasBase = diffInDays(r.baselineInicio, r.baselineFim);
      resumoPeriodo.innerHTML =
        `Linha de base: <strong>${diasBase} dias</strong><br>` +
        `Planejado at√© hoje: <strong>${r.percPlanejado}%</strong>`;
    } else {
      resumoPeriodo.textContent = "Linha de base ainda n√£o cadastrada para esta obra.";
    }

    // Carga do coordenador
    const metCoordenador = document.getElementById("metricaCoordenadorObras");
    const resumoCoord    = document.getElementById("resumoCoordenador");
    if (coordenadorAtual && listaObrasCache.length) {
      const obrasMesmoCoord = listaObrasCache.filter(o => {
        const nomeCoord = (o.coordenador || o.coord || "").toString().trim();
        return nomeCoord && nomeCoord === coordenadorAtual;
      });
      metCoordenador.textContent = obrasMesmoCoord.length || "1";
      resumoCoord.innerHTML =
        `Obras sob coordena√ß√£o: <strong>${obrasMesmoCoord.length || 1}</strong><br>` +
        `Esta obra: <strong>${obraSelecionadaObj.nome}</strong>`;
    } else {
      metCoordenador.textContent = "‚Äì";
      resumoCoord.textContent = "Informa√ß√£o de coordenador n√£o dispon√≠vel nas obras.";
    }

    // Respons√°veis
    const mapaResp = {};
    atividades.forEach(a => {
      const nome = a.responsavel || "N√£o informado";
      if (!mapaResp[nome]) {
        mapaResp[nome] = { qtde:0, somaReal:0 };
      }
      mapaResp[nome].qtde += 1;
      mapaResp[nome].somaReal += (a.realPercent || 0);
    });

    const tbody = document.querySelector("#tabelaResponsaveis tbody");
    tbody.innerHTML = "";
    const nomesResp = Object.keys(mapaResp);
    if (nomesResp.length) {
      blocoResp.style.display = "block";
      nomesResp.sort((a,b)=>a.localeCompare(b));
      nomesResp.forEach(nome => {
        const info = mapaResp[nome];
        const media = info.qtde ? Math.round(info.somaReal / info.qtde) : 0;
        const percTotal = total ? Math.round((info.qtde / total)*100) : 0;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${nome}</td>
          <td>${info.qtde}</td>
          <td>${percTotal}%</td>
          <td>${media}%</td>
        `;
        tbody.appendChild(tr);
      });
    } else {
      blocoResp.style.display = "none";
    }

    // Coment√°rios
    const ulCom = document.getElementById("listaComentarios");
    ulCom.innerHTML = "";
    let listaComent = [];
    atividades.forEach(a => {
      if (!a.comentarios) return;
      if (Array.isArray(a.comentarios)) {
        a.comentarios.forEach(c => {
          listaComent.push({
            atividade: a.atividade,
            texto: c.texto || c.comentario || c.obs || "",
            data:  c.data || c.dt || ""
          });
        });
      } else if (typeof a.comentarios === "string") {
        listaComent.push({
          atividade: a.atividade,
          texto: a.comentarios,
          data: ""
        });
      }
    });

    if (listaComent.length) {
      blocoCom.style.display = "block";
      listaComent.slice(-5).reverse().forEach(c => {
        const li = document.createElement("li");
        li.innerHTML = `
          <div class="coment-meta">
            Atividade: <strong>${c.atividade}</strong>
            ${c.data ? ` ‚Ä¢ ${c.data}` : ""}
          </div>
          <div>${c.texto}</div>
        `;
        ulCom.appendChild(li);
      });
    } else {
      blocoCom.style.display = "block";
      const li = document.createElement("li");
      li.textContent = "Ainda n√£o h√° coment√°rios registrados no cronograma desta obra.";
      ulCom.appendChild(li);
    }
  }

  // ===== Carregar obras e cronograma =====
  async function carregarObrasDropdown(idSelecionado) {
    try{
      const resp = await fetch(API_LIST_OBRAS);
      const lista = await resp.json();
      listaObrasCache = Array.isArray(lista) ? lista : [];
      const sel = document.getElementById("obra");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Selecione a obra";
      sel.appendChild(opt0);

      listaObrasCache.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.obra || "";
        opt.textContent = o.obra || ("Obra " + (o.id || ""));
        if (o.id !== undefined && o.id !== null) {
          opt.setAttribute("data-id", o.id);
        }
        if (idSelecionado && String(o.id).padStart(3,"0") === String(idSelecionado).padStart(3,"0")) {
          opt.selected = true;
        }
        sel.appendChild(opt);
      });
    }catch(e){
      console.error("Erro ao carregar obras:", e);
    }
  }

  async function carregarPainelParaObraSelecionada() {
    const drop = getObraSelecionadaDrop();
    if (!drop.nome && !drop.id) {
      atividades = [];
      resumoDados = null;
      coordenadorAtual = "";
      obraSelecionadaObj = null;
      atualizarPainel();
      return;
    }
    obraSelecionadaObj = drop;

    const arquivo = getArquivoNome(drop.nome, drop.id);
    if (!arquivo) {
      atividades = [];
      resumoDados = null;
      atualizarPainel();
      return;
    }

    try{
      const url = API_LOAD_URL + "?arquivo=" + encodeURIComponent(arquivo);
      const resp = await fetch(url);
      const json = await resp.json();

      const dados = montarAtividadesDeJsonCronograma(json);
      atividades = dados.atividades || [];
      coordenadorAtual = dados.coordenador || "";

      resumoDados = calcularResumoObraDados();
      atualizarPainel();
    }catch(e){
      console.error("Erro ao carregar cronograma da obra:", e);
      atividades = [];
      resumoDados = null;
      atualizarPainel();
    }
  }

  // ===== Gerar PDF / Compartilhar =====
  async function gerarPdfStatusCliente(){
    if (!jsPDF || !window.html2canvas) {
      alert("Bibliotecas de gera√ß√£o de PDF n√£o foram carregadas.");
      return;
    }
    if (!obraSelecionadaObj || !atividades.length) {
      alert("Selecione uma obra para gerar o status em PDF.");
      return;
    }

    const painel = document.getElementById("painelCliente");
    if (!painel) {
      alert("Painel n√£o encontrado para exporta√ß√£o.");
      return;
    }

    const nomeObra = obraSelecionadaObj.nome || "obra";
    const fileName = "status_obra_" + slugify(nomeObra) + ".pdf";

    try{
      const canvas = await html2canvas(painel, {scale:2, useCORS:true});
      const imgData = canvas.toDataURL("image/png");

      const pdf = new jsPDF("p","mm","a4");
      const pageWidth  = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgWidth = pageWidth - 20; // margens
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      const posX = 10;
      const posY = 10;
      pdf.addImage(imgData, "PNG", posX, posY, imgWidth, imgHeight, "", "FAST");

      // Blob para compartilhar / baixar
      const pdfBlob = pdf.output("blob");

      // Tenta Web Share API com arquivo (mobile)
      const file = new File([pdfBlob], fileName, { type: "application/pdf" });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          title: "Status da obra - " + nomeObra,
          text: "Status executivo gerado pelo ERP √çMPAR.",
          files: [file]
        });
      } else {
        // Fallback: download normal
        const url = URL.createObjectURL(pdfBlob);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("PDF gerado. Se o compartilhamento nativo n√£o abriu, o arquivo foi baixado para o dispositivo.");
      }
    }catch(e){
      console.error("Erro ao gerar PDF:", e);
      alert("N√£o foi poss√≠vel gerar o PDF desta obra.");
    }
  }

  // ===== INIT =====
  document.addEventListener("DOMContentLoaded", async () => {
    const params = new URLSearchParams(window.location.search);
    const idObraUrl = params.get("id");

    await carregarObrasDropdown(idObraUrl);
    document.getElementById("obra").addEventListener("change", carregarPainelParaObraSelecionada);

    const btnPdf = document.getElementById("btnGerarPdf");
    if (btnPdf) {
      btnPdf.addEventListener("click", gerarPdfStatusCliente);
    }

    // Se veio id na URL (clique direto do Farol)
    if (idObraUrl) {
      await carregarPainelParaObraSelecionada();
    }
  });
</script>

</body>
</html>
