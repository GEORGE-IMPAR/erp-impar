<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>ERP √çMPAR ‚Äì Cronograma de Obras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#020617;
      --card:#020617;
      --border:#1f2937;
      --text:#e5e7eb;
      --text-soft:#9ca3af;
      --blue:#3b82f6;
      --blue-dark:#1d4ed8;
      --green:#22c55e;
      --yellow:#eab308;
      --red:#ef4444;
      --accent:#cc6e00;
    }
    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(circle at top left,#1d4ed8 0,transparent 55%),
        radial-gradient(circle at bottom right,#f97316 0,transparent 55%),
        linear-gradient(120deg,#020617,#020617 60%,#030712);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      padding:10px 16px 4px;
      display:flex;
      justify-content:center;
    }
    .header-inner{
      width:100%;
      max-width:1200px;
      display:flex;
      justify-content:space-between;
      gap:16px;
      align-items:flex-start;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      text-shadow:0 2px 6px rgba(0,0,0,.8);
    }
    .brand span:nth-child(1){
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.22em;
      opacity:.9;
    }
    .brand span:nth-child(2){
      font-size:20px;
      font-weight:800;
    }
    .brand span:nth-child(3){
      font-size:11px;
      opacity:.9;
    }
    .tag-top{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.7);
      color:var(--text-soft);
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:12px;
    }
    .pill-btn{
      border-radius:999px;
      border:1px solid #4b5563;
      background:#020617;
      padding:5px 10px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--text-soft);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .pill-btn span.icn{font-size:12px;}
    .pill-btn:hover{
      border-color:#9ca3af;
      color:#e5e7eb;
    }

    main{
      flex:1 0 auto;
      display:flex;
      justify-content:center;
      padding:6px 12px 16px;
    }
    .layout{
      width:100%;
      max-width:1200px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .container {
      background:rgba(15,23,42,.96);
      border-radius:18px;
      border:1px solid rgba(55,65,81,.9);
      box-shadow:0 18px 40px rgba(0,0,0,.75);
      padding:16px 18px 18px;
    }

    h1 {
      margin-top:0;
      color:#ffffff;
      font-size:18px;
      margin-bottom:6px;
    }

    .subtitulo{
      font-size:12px;
      color:var(--text-soft);
      margin-bottom:10px;
    }

    .form-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:10px;
    }
    .form-row > div {
      flex:1;
      min-width:150px;
    }

    label {
      display:block;
      font-size:12px;
      margin-bottom:3px;
      color:#cfd8ff;
    }

    input, select {
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #293552;
      background:#020617;
      color:#f5f5f5;
      font-size:13px;
    }
    input[type="date"]{color-scheme:dark;}
    input[type="number"]{-moz-appearance:textfield;}
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{
      -webkit-appearance:none;margin:0;
    }

    button {
      border:none;
      border-radius:999px;
      padding:7px 12px;
      font-size:12px;
      cursor:pointer;
      margin-right:6px;
      margin-bottom:6px;
    }
    .btn-primary {
      background:linear-gradient(135deg,#2563eb,#22c55e);
      color:#fff;
      box-shadow:0 10px 24px rgba(0,0,0,.7);
      text-transform:uppercase;
      letter-spacing:.12em;
      font-weight:600;
    }
    .btn-secondary {
      background:#111827;
      color:#fff;
      border:1px solid #374151;
    }
    .btn-danger {
      background:#b00020;
      color:#fff;
    }

    .actions {
      margin-top:4px;
      margin-bottom:10px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .header-info {
      margin-bottom:4px;
      font-size:12px;
      color:#cfd8ff;
    }
    .header-info strong {
      font-weight:600;
    }
    .badge-base {
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:#182648;
      margin-left:6px;
    }

    .table-wrapper {
      overflow-x:auto;
      border-radius:12px;
      border:1px solid #111827;
      margin-top:6px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      background:#020617;
      min-width:820px;
    }
    th, td {
      padding:5px 6px;
      border-bottom:1px solid #1f2937;
      text-align:left;
    }
    th {
      background:#020617;
      position:sticky;
      top:0;
      z-index:1;
      font-weight:600;
    }
    tbody tr:hover {
      background:#111827;
    }

    .tag-dia {
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:#182648;
    }

    .gantt-container {
      margin-top: 14px;
      background: #020617;
      border-radius: 14px;
      padding: 10px;
      border: 1px solid #1f2937;
      overflow: auto;      /* scroll horizontal + vertical */
      max-height: 340px;   /* limita pra n√£o invadir rodap√© */
    }

    .gantt-header {
      font-size:12px;
      margin-bottom:6px;
      color:#cfd8ff;
    }
    .gantt-grid {
      display:grid;
      grid-auto-rows:30px;
      row-gap:6px;
      position:relative;
      font-size:10px;
    }
    .gantt-row-label {
      position:sticky;
      left:0;
      padding-right:6px;
      background:#020617;
      z-index:2;
      white-space:nowrap;
    }
    .gantt-row {
      display:grid;
      column-gap:2px;
      align-items:center;
    }
    .gantt-bar-base {
      height:10px;
      border-radius:999px;
      background:#4fc3f7;
      opacity:.8;
      margin-bottom:2px;
    }
    .gantt-bar-real {
      height:12px;
      border-radius:999px;
      background:#cc6e00;
      box-shadow:0 0 6px rgba(204,110,0,.6);
    }
    .gantt-day-labels {
      display:grid;
      column-gap:2px;
      font-size:9px;
      color:#9fa8da;
      margin-left:110px;
      margin-bottom:4px;
    }

    .footer-crono {
      margin-top:12px;
      font-size:10px;
      color:#9fa8da;
      text-align:right;
    }
    .footer-crono span {
      opacity:.7;
    }

    .no-data {
      font-size:11px;
      color:#9fa8da;
      margin-top:6px;
      font-style:italic;
    }

    .row-editing {
      outline:1px solid var(--accent);
      background:#1d2340 !important;
    }

    .status-nao-iniciado {color:#9fa8da;}
    .status-em-andamento {color:#ffd54f;}
    .status-atrasado {color:#ff8a80;font-weight:bold;}
    .status-concluido {color:#80e27e;font-weight:bold;}

    .check-inline {
      display:flex;
      align-items:center;
      gap:4px;
      margin-top:4px;
      font-size:11px;
      color:#cfd8ff;
    }
    .check-inline input[type="checkbox"]{width:auto;}

    footer{
      background:#020617;
      color:#9ca3af;
      padding:6px 16px;
      font-size:10px;
    }
    .rodape-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    @media(max-width:900px){
      .container{padding:14px 12px 16px;}
      h1{font-size:16px;}
    }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <span>PLATAFORMA</span>
      <span>ERP √çMPAR ‚Ä¢ Cronograma de Obras</span>
      <span>Planejamento detalhado com baseline x real</span>
    </div>
    <div class="tag-top">
      <button class="pill-btn" type="button" id="btnVoltarFarol">
        <span class="icn">‚Üê</span> Farol de obras
      </button>
      <button class="pill-btn" type="button" id="btnVoltarMenu">
        <span class="icn">üè†</span> Menu principal
      </button>
    </div>
  </div>
</header>

<main>
  <div class="layout">
    <div class="container">
      <h1>Cronograma de Atividades - √çMPAR</h1>
      <div class="subtitulo">
        Cadastre as atividades da obra, defina predecessoras, salve a linha de base e acompanhe o avan√ßo real
        integrado ao Farol de Obras.
      </div>

      <!-- Campos de contexto (Obra / Coordenador) -->
      <div class="form-row">
        <div>
          <label for="obra">Obra</label>
          <select id="obra">
            <option value="">Selecione a obra</option>
          </select>
        </div>
        <div>
          <label for="coordenador">Coordenador</label>
          <select id="coordenador">
            <option value="">Selecione o coordenador</option>
          </select>
        </div>
      </div>

      <!-- Formul√°rio principal -->
      <div class="form-row">
        <div>
          <label for="atividade">Atividade</label>
          <input type="text" id="atividade" placeholder="Ex.: Montagem de estrutura">
        </div>
        <div>
          <label for="responsavel">Respons√°vel</label>
          <select id="responsavel">
            <option value="">Selecione o respons√°vel</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="inicio">Data de in√≠cio</label>
          <input type="date" id="inicio">
        </div>
        <div>
          <label for="fim">Data de t√©rmino</label>
          <input type="date" id="fim">
        </div>
        <div>
          <label for="duracao">Dura√ß√£o (dias)</label>
          <input type="number" id="duracao" min="1" placeholder="Ex.: 5">
        </div>
        <div>
          <label for="predecessora">Predecessora</label>
          <select id="predecessora">
            <option value="">Nenhuma</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="check-inline">
            <input type="checkbox" id="diasComerciais" checked>
            <span>Dias √∫teis (seg‚Äìsex)</span>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="btn-add" class="btn-primary" onclick="adicionarAtividade()">Adicionar atividade</button>
        <button id="btn-save" class="btn-primary" style="display:none" onclick="salvarEdicao()">Salvar altera√ß√£o</button>
        <button id="btn-cancel" class="btn-secondary" style="display:none" onclick="cancelarEdicao()">Cancelar edi√ß√£o</button>

        <button class="btn-secondary" onclick="recalcularCronograma()">Recalcular (efeito domin√≥)</button>
        <button class="btn-secondary" onclick="salvarLinhaBase()">Concluir planejamento (salvar linha de base)</button>

        <button class="btn-secondary" onclick="limparFormulario()">Limpar campos</button>
        <button class="btn-secondary" onclick="exportarJSON()">Exportar JSON</button>
      </div>

      <div class="header-info" id="header-info"></div>
      <div class="header-info" id="resumo-obra"></div>

      <div class="table-wrapper">
        <table id="tabela-atividades">
          <thead>
            <tr>
              <th>#</th>
              <th>Atividade</th>
              <th>Respons√°vel</th>
              <th>In√≠cio</th>
              <th>Fim</th>
              <th>Dura√ß√£o</th>
              <th>Modo</th>
              <th>% Plan.</th>
              <th>% Real</th>
              <th>Status</th>
              <th>Predecessora</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="no-data-msg" class="no-data">
        Nenhuma atividade cadastrada ainda.
      </div>

      <div class="gantt-container">
        <div class="gantt-header">
          Vis√£o geral (dias) ‚Äì barras da linha de base (azul) e real (laranja)
          <span id="badge-base" class="badge-base" style="display:none;">Linha de base salva</span>
        </div>
        <div id="gantt-day-labels" class="gantt-day-labels"></div>
        <div id="gantt-grid" class="gantt-grid"></div>
      </div>

      <div class="footer-crono">
        <span>ERP √çMPAR ‚Ä¢ M√≥dulo Cronograma ‚Ä¢ v2.10 (baseline x real, % obra, dura√ß√£o, dias √∫teis, Gantt duplo)</span>
      </div>
    </div>
  </div>
</main>

<footer>
  <div class="rodape-inner">
    <span>¬© 2025 ERP √çMPAR ‚Ä¢ M√≥dulo Cronograma de Obras</span>
    <span>Integra√ß√£o total com Farol de Obras (baseline x real)</span>
  </div>
</footer>

<script>
  // ================== CONFIG API ==================
  const API_BASE = "https://api.erpimpar.com.br/cronograma";
  const API_SAVE_URL = API_BASE + "/salvar_cronograma.php";
  const API_LOAD_URL = API_BASE + "/carregar_cronograma.php";
  const API_LIST_OBRAS = API_BASE + "/listar_obras.php";
  const API_LIST_COORDENADORES = API_BASE + "/listar_coordenadores.php";
  const API_LIST_RESPONSAVEIS = API_BASE + "/listar_responsaveis.php";
  const API_SAVE_BASELINE = API_BASE + "/salvar_baseline.php";
  const API_SAVE_REAL      = API_BASE + "/salvar_real.php";

  let atividades = [];
  let nextId = 1;
  let editingIndex = null;
  let linhaBaseSalva = false;

  let cacheObras = [];
  let cacheCoordenadores = [];
  let cacheResponsaveis = [];

  // -------- navega√ß√£o ----------
  document.getElementById("btnVoltarMenu").addEventListener("click", () => {
    window.location.href = "../index.html";
  });
  document.getElementById("btnVoltarFarol").addEventListener("click", () => {
    window.location.href = "farol.html";
  });


// === API ===
// const API_SAVE_BASELINE = "https://api.erpimpar.com.br/cronograma/salvar_baseline.php";
// const API_LOAD_URL      = "https://api.erpimpar.com.br/cronograma/carregar_cronograma.php";

// Pega info da obra selecionada
function getObraSelecionada() {
  const select = document.getElementById("obra");
  const opt = select.options[select.selectedIndex];
  return {
    id: opt ? (opt.getAttribute("data-id") || "").trim() : "",
    nome: opt ? opt.textContent.trim() : ""
  };
}

// Gera o nome do arquivo usado nos PHPs (ex.: obra_036.json)
// Gera o nome do arquivo usado nos PHPs (ex.: obra_036.json)
function getArquivoNome(obraNomeParam, obraIdParam) {
  // pega o que j√° est√° selecionado na tela
  const { id, nome } = getObraSelecionada();

  const obraId   = obraIdParam   || id;
  const obraNome = obraNomeParam || nome;

  // Prioriza salvar por ID (mant√©m padr√£o: obra_036.json, obra_007.json etc.)
  if (obraId) {
    return "obra_" + String(obraId).padStart(3, "0") + ".json";
  }

  if (!obraNome) return null;

  // fallback: gera slug a partir do nome da obra
  const slug = obraNome
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-zA-Z0-9]+/g, "_")
    .replace(/^_+|_+$/g, "")
    .toUpperCase();

  return "obra_" + slug + ".json";
}


// Gera o nome do arquivo usado pelo backend (carregar_cronograma.php, salvar_cronograma.php etc.)
function slugifyObra(obra) {
  return obra
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // tira acentos
    .replace(/[^a-zA-Z0-9]+/g, "_")                  // troca tudo que n√£o √© letra/n√∫mero por _
    .replace(/^_+|_+$/g, "")                         // tira _ do come√ßo/fim
    .toUpperCase();
}


  // ===== datas =====
  function parseDate(str) {
    if (!str) return null;
    // tenta yyyy-mm-dd
    const partsDash = str.split("-");
    if (partsDash.length === 3 && partsDash[0].length === 4) {
      const [y, m, d] = partsDash.map(Number);
      return new Date(y, m - 1, d);
    }
    // tenta dd/mm/yyyy
    const partsSlash = str.split("/");
    if (partsSlash.length === 3 && partsSlash[2].length === 4) {
      const [d, m, y] = partsSlash.map(Number);
      return new Date(y, m - 1, d);
    }
    // fallback: Date nativo
    const d = new Date(str);
    if (isNaN(d.getTime())) return null;
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }
  function formatDateToInput(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }
  function formatDateBr(date) {
    const d = String(date.getDate()).padStart(2, "0");
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const y = date.getFullYear();
    return `${d}/${m}/${y}`;
  }
  function addDays(date, days) {
    const d = new Date(date.getTime());
    d.setDate(d.getDate() + days);
    return d;
  }
  function diffInDays(inicio, fim) {
    const ms = fim - inicio;
    return Math.round(ms / (1000 * 60 * 60 * 24)) + 1;
  }
  function dataHoje() {
    const agora = new Date();
    return new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
  }

  // ===== dias √∫teis =====
  const FERIADOS_FIXOS = [
    "01-01","04-21","05-01","09-07","10-12","11-02","11-15","12-25"
  ];
  function isHoliday(date) {
    const md = String(date.getMonth() + 1).padStart(2, "0") + "-" +
               String(date.getDate()).padStart(2, "0");
    return FERIADOS_FIXOS.includes(md);
  }
  function isBusinessDay(date) {
    const day = date.getDay();
    if (day === 0 || day === 6) return false;
    if (isHoliday(date)) return false;
    return true;
  }
  function nextBusinessDay(date) {
    let d = addDays(date, 1);
    while (!isBusinessDay(d)) {
      d = addDays(d, 1);
    }
    return d;
  }
  function addBusinessDaysInclusive(start, duracaoDias) {
    if (duracaoDias <= 1) {
      let s = new Date(start.getTime());
      if (!isBusinessDay(s)) s = nextBusinessDay(s);
      return s;
    }
    let current = new Date(start.getTime());
    if (!isBusinessDay(current)) current = nextBusinessDay(current);
    let count = 1;
    while (count < duracaoDias) {
      current = addDays(current, 1);
      if (isBusinessDay(current)) {
        count++;
      }
    }
    return current;
  }
  function diffBusinessDaysInclusive(start, end) {
    if (end < start) return 0;
    let count = 0;
    let current = new Date(start.getTime());
    while (current <= end) {
      if (isBusinessDay(current)) count++;
      current = addDays(current, 1);
    }
    return count;
  }
  function calcularFim(inicio, duracaoDias, diasComerciais) {
    if (diasComerciais) {
      return addBusinessDaysInclusive(inicio, duracaoDias);
    } else {
      return addDays(inicio, duracaoDias - 1);
    }
  }
  function calcularDuracao(inicio, fim, diasComerciais) {
    if (diasComerciais) {
      return diffBusinessDaysInclusive(inicio, fim);
    } else {
      return diffInDays(inicio, fim);
    }
  }

  // ===== UI b√°sica =====
  function toggleModoEdicao(ativo) {
    const btnAdd = document.getElementById("btn-add");
    const btnSave = document.getElementById("btn-save");
    const btnCancel = document.getElementById("btn-cancel");
    if (ativo) {
      btnAdd.style.display = "none";
      btnSave.style.display = "inline-block";
      btnCancel.style.display = "inline-block";
    } else {
      btnAdd.style.display = "inline-block";
      btnSave.style.display = "none";
      btnCancel.style.display = "none";
    }
  }

  function getObraSelecionadaNome() {
    return document.getElementById("obra").value.trim();
  }
  function getObraSelecionadaId() {
    const sel = document.getElementById("obra");
    const opt = sel.options[sel.selectedIndex];
    return opt ? opt.getAttribute("data-id") : null;
  }

  function atualizarHeaderInfo() {
    const obraNome = getObraSelecionadaNome();
    const coord = document.getElementById("coordenador").value.trim();
    const info = document.getElementById("header-info");
    let partes = [];
    if (obraNome) partes.push(`Obra: <strong>${obraNome}</strong>`);
    if (coord) partes.push(`Coordenador: <strong>${coord}</strong>`);
    info.innerHTML = partes.length ? partes.join(" ‚Ä¢ ") : "";
  }

// Novo helper: devolve os dados do resumo para JSON e para a tela
function calcularResumoObraDados() {
  if (atividades.length === 0) {
    return null;
  }

  let baselineInicio = null;
  let baselineFim = null;
  let realInicio = null;
  let realFim = null;

  let totalPlanPeso = 0;
  let somaPlan = 0;
  let totalRealPeso = 0;
  let somaReal = 0;

  atividades.forEach(a => {
    if (a.baselineInicio && a.baselineFim) {
      if (!baselineInicio || a.baselineInicio < baselineInicio) baselineInicio = a.baselineInicio;
      if (!baselineFim || a.baselineFim > baselineFim) baselineFim = a.baselineFim;
    }
    if (!realInicio || a.inicio < realInicio) realInicio = a.inicio;
    if (!realFim || a.fim > realFim) realFim = a.fim;

    const pesoPlan = a.baselineDuracaoDias || a.duracaoDias || 0;
    const pesoReal = a.duracaoDias || 0;
    const pr = a.plannedPercent || 0;
    const rr = a.realPercent || 0;

    if (pesoPlan > 0) {
      somaPlan += pr * pesoPlan;
      totalPlanPeso += pesoPlan;
    }
    if (pesoReal > 0) {
      somaReal += rr * pesoReal;
      totalRealPeso += pesoReal;
    }
  });

  const percPlan = totalPlanPeso ? Math.round(somaPlan / totalPlanPeso) : 0;
  const percReal = totalRealPeso ? Math.round(somaReal / totalRealPeso) : 0;

  let statusObra = "N√£o iniciado";
  let statusClasse = "status-nao-iniciado";

  if (percReal >= 100 && percPlan >= 100) {
    statusObra = "Conclu√≠do";
    statusClasse = "status-concluido";
  } else if (percReal < percPlan) {
    if (percReal === 0 && percPlan === 0) {
      statusObra = "N√£o iniciado";
      statusClasse = "status-nao-iniciado";
    } else {
      statusObra = "Atrasado";
      statusClasse = "status-atrasado";
    }
  } else if (percReal === 0 && percPlan === 0) {
    statusObra = "N√£o iniciado";
    statusClasse = "status-nao-iniciado";
  } else {
    statusObra = "Em andamento";
    statusClasse = "status-em-andamento";
  }

  return {
    baselineInicio,
    baselineFim,
    realInicio,
    realFim,
    percPlanejado: percPlan,
    percReal,
    status: statusObra,
    statusClasse
  };
}


function calcularResumoObraDados() {
  if (!atividades.length) return null;

  let baselineInicio = null;
  let baselineFim    = null;
  let realInicio     = null;
  let realFim        = null;

  let somaPlan = 0;
  let pesoPlan = 0;
  let somaReal = 0;
  let pesoReal = 0;

  atividades.forEach(a => {
    // datas da baseline
    if (a.baselineInicio && a.baselineFim) {
      if (!baselineInicio || a.baselineInicio < baselineInicio) baselineInicio = a.baselineInicio;
      if (!baselineFim    || a.baselineFim    > baselineFim)    baselineFim    = a.baselineFim;
    }

    // datas reais
    if (a.inicio && a.fim) {
      if (!realInicio || a.inicio < realInicio) realInicio = a.inicio;
      if (!realFim    || a.fim    > realFim)    realFim    = a.fim;
    }

    const durPlan = a.baselineDuracaoDias || a.duracaoDias || 0;
    const durReal = a.duracaoDias || 0;
    const pr = a.plannedPercent || 0;
    const rr = a.realPercent || 0;

    if (durPlan > 0) {
      somaPlan += pr * durPlan;
      pesoPlan += durPlan;
    }
    if (durReal > 0) {
      somaReal += rr * durReal;
      pesoReal += durReal;
    }
  });

  const percPlanejado = pesoPlan ? Math.round(somaPlan / pesoPlan) : 0;
  const percReal      = pesoReal ? Math.round(somaReal / pesoReal) : 0;

  let status = "N√£o iniciado";
  let statusClasse = "status-nao-iniciado";

  if (percReal >= 100 && percPlanejado >= 100) {
    status = "Conclu√≠do";
    statusClasse = "status-concluido";
  } else if (percReal < percPlanejado) {
    if (percReal === 0 && percPlanejado === 0) {
      status = "N√£o iniciado";
      statusClasse = "status-nao-iniciado";
    } else {
      status = "Atrasado";
      statusClasse = "status-atrasado";
    }
  } else if (percReal === 0 && percPlanejado === 0) {
    status = "N√£o iniciado";
    statusClasse = "status-nao-iniciado";
  } else {
    status = "Em andamento";
    statusClasse = "status-em-andamento";
  }

  return {
    baselineInicio,
    baselineFim,
    realInicio,
    realFim,
    percPlanejado,
    percReal,
    status,
    statusClasse
  };
}

// Continua tendo a fun√ß√£o que escreve o texto na tela:
function atualizarResumoObra() {
  const resumoEl = document.getElementById("resumo-obra");
  const dados = calcularResumoObraDados();

  if (!dados) {
    resumoEl.innerHTML = "";
    return;
  }

  const {
    baselineInicio,
    baselineFim,
    realInicio,
    realFim,
    percPlanejado,
    percReal,
    status,
    statusClasse
  } = dados;

  let partes = [];
  if (baselineInicio && baselineFim) {
    partes.push(
      `Baseline: <strong>${formatDateBr(baselineInicio)}</strong> ‚Üí <strong>${formatDateBr(baselineFim)}</strong>`
    );
  }
  if (realInicio && realFim) {
    partes.push(
      `Atual: <strong>${formatDateBr(realInicio)}</strong> ‚Üí <strong>${formatDateBr(realFim)}</strong>`
    );
  }

  resumoEl.innerHTML =
    (partes.length ? partes.join(" ‚Ä¢ ") + " ‚Ä¢ " : "") +
    `Planejado: <strong>${percPlanejado}%</strong> ‚Ä¢ ` +
    `Real: <strong>${percReal}%</strong> ‚Ä¢ ` +
    `Situa√ß√£o: <strong class="${statusClasse}">${status}</strong>`;
}


  function atualizarListaPredecessoras() {
    const select = document.getElementById("predecessora");
    const valorAtual = select.value;
    select.innerHTML = "";
    const optNenhuma = document.createElement("option");
    optNenhuma.value = "";
    optNenhuma.textContent = "Nenhuma";
    select.appendChild(optNenhuma);
    atividades.forEach((a, i) => {
      const opt = document.createElement("option");
      opt.value = a.id;
      opt.textContent = `${i + 1} - ${a.atividade}`;
      select.appendChild(opt);
    });
    if (valorAtual && [...select.options].some(o => o.value === valorAtual)) {
      select.value = valorAtual;
    } else {
      select.value = "";
    }
  }

  function onPredecessoraChange() {
    const select = document.getElementById("predecessora");
    const id = select.value;
    const inputInicio = document.getElementById("inicio");
    const diasComerciais = document.getElementById("diasComerciais").checked;

    if (!id) {
      inputInicio.min = "";
      return;
    }
    const pred = atividades.find(a => a.id === Number(id));
    if (!pred) return;

    let newStart = diasComerciais ? nextBusinessDay(pred.fim) : addDays(pred.fim, 1);
    const startStr = formatDateToInput(newStart);
    inputInicio.value = startStr;
    inputInicio.min = startStr;

    const durStr = document.getElementById("duracao").value;
    const dur = Number(durStr);
    if (dur > 0) {
      const end = calcularFim(newStart, dur, diasComerciais);
      document.getElementById("fim").value = formatDateToInput(end);
    }
  }

  function onInicioChange() {
    const inicioStr = document.getElementById("inicio").value;
    const durStr = document.getElementById("duracao").value;
    const diasComerciais = document.getElementById("diasComerciais").checked;

    if (!inicioStr) return;
    const inicio = parseDate(inicioStr);
    const dur = Number(durStr);
    if (dur > 0) {
      const fim = calcularFim(inicio, dur, diasComerciais);
      document.getElementById("fim").value = formatDateToInput(fim);
    } else {
      const fimStr = document.getElementById("fim").value;
      if (fimStr) {
        const fim = parseDate(fimStr);
        const durCalc = calcularDuracao(inicio, fim, diasComerciais);
        document.getElementById("duracao").value = durCalc > 0 ? durCalc : "";
      }
    }
  }

  function onFimChange() {
    const inicioStr = document.getElementById("inicio").value;
    const fimStr = document.getElementById("fim").value;
    const diasComerciais = document.getElementById("diasComerciais").checked;
    if (!inicioStr || !fimStr) return;
    const inicio = parseDate(inicioStr);
    const fim = parseDate(fimStr);
    if (fim < inicio) {
      alert("A data de t√©rmino n√£o pode ser menor que a data de in√≠cio.");
      document.getElementById("fim").value = "";
      return;
    }
    const dur = calcularDuracao(inicio, fim, diasComerciais);
    document.getElementById("duracao").value = dur > 0 ? dur : "";
  }

  function onDuracaoChange() {
    const inicioStr = document.getElementById("inicio").value;
    const diasComerciais = document.getElementById("diasComerciais").checked;
    const durStr = document.getElementById("duracao").value;
    const dur = Number(durStr);
    if (!inicioStr || dur <= 0) return;
    const inicio = parseDate(inicioStr);
    const fim = calcularFim(inicio, dur, diasComerciais);
    document.getElementById("fim").value = formatDateToInput(fim);
  }

  // ===== % planejado / status =====
  function arredondarPercentual(p) {
    const steps = [0, 25, 50, 75, 100];
    let melhor = steps[0];
    let menorDiff = Math.abs(p - steps[0]);
    for (const s of steps) {
      const diff = Math.abs(p - s);
      if (diff < menorDiff) {
        menorDiff = diff;
        melhor = s;
      }
    }
    return melhor;
  }

  function calcularPlanejadoEStatus() {
    const hoje = dataHoje();
    atividades.forEach(a => {
      if (!linhaBaseSalva || !a.baselineInicio || !a.baselineFim) {
        a.plannedPercent = 0;
      } else {
        const inicioBase = a.baselineInicio;
        const fimBase = a.baselineFim;
        if (hoje <= inicioBase) {
          a.plannedPercent = 0;
        } else if (hoje >= fimBase) {
          a.plannedPercent = 100;
        } else {
          const totalMs = fimBase - inicioBase;
          const elapsedMs = hoje - inicioBase;
          let perc = (elapsedMs / totalMs) * 100;
          if (isNaN(perc)) perc = 0;
          perc = Math.min(100, Math.max(0, perc));
          a.plannedPercent = arredondarPercentual(perc);
        }
      }
      if (typeof a.realPercent !== "number") a.realPercent = 0;
      const pr = a.plannedPercent;
      const rr = a.realPercent;
      if (rr === 0 && pr === 0) {
        a.status = "N√£o iniciado";
        a.statusClass = "status-nao-iniciado";
      } else if (rr >= 100 && pr >= 100) {
        a.status = "Conclu√≠do";
        a.statusClass = "status-concluido";
      } else if (rr < pr) {
        a.status = "Atrasado";
        a.statusClass = "status-atrasado";
      } else {
        a.status = "Em andamento";
        a.statusClass = "status-em-andamento";
      }
    });
    atualizarResumoObra();
  }

async function salvarLinhaBase() {
  // 1) Valida√ß√µes b√°sicas
  if (atividades.length === 0) {
    alert("Cadastre pelo menos uma atividade antes de salvar a linha de base.");
    return;
  }

  const { id: obraId, nome: obraNome } = getObraSelecionada();
  const coordenador = document.getElementById("coordenador").value.trim();

  if (!obraNome) {
    alert("Selecione a Obra antes de salvar a linha de base.");
    return;
  }
  if (!coordenador) {
    alert("Selecione o Coordenador antes de salvar a linha de base.");
    return;
  }

  // 2) Congela baseline localmente (isso mant√©m o c√°lculo do planejado funcionando)
  atividades.forEach(a => {
    a.baselineInicio      = new Date(a.inicio.getTime());
    a.baselineFim         = new Date(a.fim.getTime());
    a.baselineDuracaoDias = a.duracaoDias;
    a.baselineInicioStr   = a.inicioStr;
    a.baselineFimStr      = a.fimStr;
  });

  linhaBaseSalva = true;

  const badge = document.getElementById("badge-base");
  if (badge) badge.style.display = "inline-block";

  // Recalcula planejado / status / resumo ANTES de enviar pro servidor
  calcularPlanejadoEStatus();
  renderTabela();
  renderGantt();
  atualizarResumoObra && atualizarResumoObra();

const resumoObra = calcularResumoObraDados();

  // 3) Monta o payload para o PHP
  const arquivo = getArquivoNome(obraNome, obraId);
  if (!arquivo) {
    alert("N√£o foi poss√≠vel definir o nome do arquivo do cronograma.");
    return;
  }

  const atividadesBaseline = atividades.map(a => ({
    id: a.id,
    atividade: a.atividade,
    responsavel: a.responsavel,
    inicio: a.inicioStr,        // "yyyy-mm-dd"
    fim: a.fimStr,              // "yyyy-mm-dd"
    duracaoDias: a.duracaoDias,
    diasUteis: !!a.diasComerciais,
    predecessorId: a.predecessorId || null,
    modo: a.modo || (a.diasComerciais ? "Comercial" : "Corridos")
  }));

  const payloadBaseline = {
    arquivo: arquivo,           // ex: obra_003.json
    id: obraId || "",           // ex: "003"
    obra: obraNome,
    coordenador,
    resumo: resumoObra || null, // >>> NOVO: resumo da obra
    atividades: atividadesBaseline
  };

  console.log("Enviando baseline para salvar_baseline.php:", payloadBaseline);

  // 4) Chama o PHP de baseline
  try {
    const respBase = await fetch(API_SAVE_BASELINE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payloadBaseline)
    });

    // Se o servidor devolver HTML de erro, o .json() vai falhar ‚Äì tratamos isso
    let dataBase = null;
    try {
      dataBase = await respBase.json();
    } catch (e) {
      console.error("Resposta n√£o-JSON do salvar_baseline.php:", e);
    }

    console.log("Resposta salvar_baseline.php:", dataBase);

    if (!respBase.ok || (dataBase && dataBase.error)) {
      alert("Erro ao salvar baseline no servidor: " +
            ((dataBase && dataBase.message) || respBase.statusText));
      return;
    }

    alert("Linha de base salva com sucesso e integrada ao Farol.");
  } catch (e) {
    console.error("Erro ao salvar baseline:", e);
    alert("Falha na comunica√ß√£o com o servidor ao salvar a baseline.");
  }
}




  // ===== CRUD local =====
  function adicionarAtividade() {
    if (editingIndex !== null) {
      alert("Voc√™ est√° editando uma atividade. Salve ou cancele a edi√ß√£o antes de adicionar uma nova.");
      return;
    }
    const obraNome = getObraSelecionadaNome();
    const coordenador = document.getElementById("coordenador").value.trim();
    const atividade = document.getElementById("atividade").value.trim();
    const responsavel = document.getElementById("responsavel").value.trim();
    let inicioStr = document.getElementById("inicio").value;
    let fimStr = document.getElementById("fim").value;
    let durStr = document.getElementById("duracao").value;
    const predecessoraStr = document.getElementById("predecessora").value;
    const diasComerciais = document.getElementById("diasComerciais").checked;

    if (!obraNome) {
      alert("Selecione a Obra.");
      return;
    }
    if (!coordenador) {
      alert("Selecione o Coordenador.");
      return;
    }
    if (!atividade) {
      alert("Preencha o campo Atividade.");
      return;
    }

    let predecessorId = null;
    let inicio = null;
    let fim = null;
    let duracaoDias = 0;

    if (predecessoraStr) {
      predecessorId = Number(predecessoraStr);
      const pred = atividades.find(a => a.id === predecessorId);
      if (pred) {
        inicio = diasComerciais ? nextBusinessDay(pred.fim) : addDays(pred.fim, 1);
        inicioStr = formatDateToInput(inicio);
        document.getElementById("inicio").value = inicioStr;
      }
    }

    const temDur = durStr !== "" && !isNaN(Number(durStr)) && Number(durStr) > 0;
    const temInicio = !!inicioStr;
    const temFim = !!fimStr;

    if (!temInicio && !predecessoraStr) {
      alert("Informe a data de in√≠cio ou selecione uma predecessora.");
      return;
    }
    if (!inicio) inicio = parseDate(inicioStr);

    if (temDur && !temFim) {
      duracaoDias = Number(durStr);
      fim = calcularFim(inicio, duracaoDias, diasComerciais);
      fimStr = formatDateToInput(fim);
      document.getElementById("fim").value = fimStr;
    } else if (!temDur && temFim) {
      fim = parseDate(fimStr);
      if (fim < inicio) {
        alert("A data de t√©rmino n√£o pode ser menor que a data de in√≠cio.");
        return;
      }
      duracaoDias = calcularDuracao(inicio, fim, diasComerciais);
      if (duracaoDias <= 0) {
        alert("N√£o foi poss√≠vel calcular a dura√ß√£o. Verifique as datas.");
        return;
      }
      document.getElementById("duracao").value = duracaoDias;
    } else if (temDur && temFim) {
      fim = parseDate(fimStr);
      if (fim < inicio) {
        alert("A data de t√©rmino n√£o pode ser menor que a data de in√≠cio.");
        return;
      }
      duracaoDias = Number(durStr);
    } else {
      alert("Informe dura√ß√£o e/ou data de t√©rmino.");
      return;
    }

    atividades.push({
      id: nextId++,
      obra: obraNome,
      obraId: getObraSelecionadaId(),
      coordenador,
      atividade,
      responsavel,
      inicioStr,
      fimStr,
      inicio,
      fim,
      duracaoDias,
      predecessorId,
      diasComerciais,
      realPercent: 0,
      plannedPercent: 0,
      status: "N√£o iniciado",
      statusClass: "status-nao-iniciado",
      baselineInicio: null,
      baselineFim: null,
      baselineDuracaoDias: null,
      baselineInicioStr: null,
      baselineFimStr: null
    });

    atualizarHeaderInfo();
    calcularPlanejadoEStatus();
    renderTabela();
    renderGantt();
    atualizarListaPredecessoras();
    limparFormulario();
  }

  function limparFormulario() {
    document.getElementById("atividade").value = "";
    document.getElementById("responsavel").value = "";
    document.getElementById("inicio").value = "";
    document.getElementById("fim").value = "";
    document.getElementById("duracao").value = "";
    document.getElementById("inicio").min = "";
    document.getElementById("predecessora").value = "";
    document.getElementById("diasComerciais").checked = true;
    limparDestaqueEdicao();
  }

  function limparDestaqueEdicao() {
    const linhas = document.querySelectorAll("#tabela-atividades tbody tr");
    linhas.forEach(l => l.classList.remove("row-editing"));
  }

  function iniciarEdicao(index) {
    editingIndex = index;
    toggleModoEdicao(true);
    limparDestaqueEdicao();
    const item = atividades[index];

    const obraSelect = document.getElementById("obra");
    if (item.obraId) {
      for (let i=0;i<obraSelect.options.length;i++){
        if (obraSelect.options[i].getAttribute("data-id") == item.obraId){
          obraSelect.selectedIndex = i;
          break;
        }
      }
    } else if (item.obra) {
      obraSelect.value = item.obra;
    }

    document.getElementById("coordenador").value = item.coordenador || "";
    document.getElementById("atividade").value = item.atividade;
    document.getElementById("responsavel").value = item.responsavel || "";
    document.getElementById("inicio").value = item.inicioStr;
    document.getElementById("fim").value = item.fimStr;
    document.getElementById("duracao").value = item.duracaoDias || "";
    document.getElementById("diasComerciais").checked = !!item.diasComerciais;

    atualizarHeaderInfo();
    atualizarListaPredecessoras();
    const selectPred = document.getElementById("predecessora");
    selectPred.value = item.predecessorId ? String(item.predecessorId) : "";

    const tbody = document.querySelector("#tabela-atividades tbody");
    const linha = tbody.querySelectorAll("tr")[index];
    if (linha) linha.classList.add("row-editing");
  }

  function cancelarEdicao() {
    editingIndex = null;
    toggleModoEdicao(false);
    limparFormulario();
  }

  function salvarEdicao() {
    if (editingIndex === null) return;

    const obraNome = getObraSelecionadaNome();
    const coordenador = document.getElementById("coordenador").value.trim();
    const atividade = document.getElementById("atividade").value.trim();
    const responsavel = document.getElementById("responsavel").value.trim();
    let inicioStr = document.getElementById("inicio").value;
    let fimStr = document.getElementById("fim").value;
    let durStr = document.getElementById("duracao").value;
    const predecessoraStr = document.getElementById("predecessora").value;
    const diasComerciais = document.getElementById("diasComerciais").checked;

    if (!obraNome || !coordenador) {
      alert("Selecione Obra e Coordenador.");
      return;
    }
    if (!atividade) {
      alert("Preencha a Atividade.");
      return;
    }

    const itemOriginal = atividades[editingIndex];
    let predecessorId = null;
    let inicio = null;
    let fim = null;
    let duracaoDias = 0;

    if (predecessoraStr) {
      predecessorId = Number(predecessoraStr);
      if (predecessorId === itemOriginal.id) {
        alert("Uma atividade n√£o pode ser predecessora dela mesma.");
        return;
      }
      const pred = atividades.find(a => a.id === predecessorId);
      if (pred) {
        inicio = diasComerciais ? nextBusinessDay(pred.fim) : addDays(pred.fim, 1);
        inicioStr = formatDateToInput(inicio);
        document.getElementById("inicio").value = inicioStr;
      }
    }

    const temDur = durStr !== "" && !isNaN(Number(durStr)) && Number(durStr) > 0;
    const temInicio = !!inicioStr;
    const temFim = !!fimStr;

    if (!temInicio && !predecessoraStr) {
      alert("Informe a data de in√≠cio ou selecione uma predecessora.");
      return;
    }
    if (!inicio) inicio = parseDate(inicioStr);

    if (temDur && !temFim) {
      duracaoDias = Number(durStr);
      fim = calcularFim(inicio, duracaoDias, diasComerciais);
      fimStr = formatDateToInput(fim);
      document.getElementById("fim").value = fimStr;
    } else if (!temDur && temFim) {
      fim = parseDate(fimStr);
      if (fim < inicio) {
        alert("A data de t√©rmino n√£o pode ser menor que a data de in√≠cio.");
        return;
      }
      duracaoDias = calcularDuracao(inicio, fim, diasComerciais);
      if (duracaoDias <= 0) {
        alert("N√£o foi poss√≠vel calcular a dura√ß√£o. Verifique as datas.");
        return;
      }
      document.getElementById("duracao").value = duracaoDias;
    } else if (temDur && temFim) {
      fim = parseDate(fimStr);
      if (fim < inicio) {
        alert("A data de t√©rmino n√£o pode ser menor que a data de in√≠cio.");
        return;
      }
      duracaoDias = Number(durStr);
    } else {
      alert("Informe dura√ß√£o e/ou data de t√©rmino.");
      return;
    }

    atividades[editingIndex] = {
      ...itemOriginal,
      obra: obraNome,
      obraId: getObraSelecionadaId(),
      coordenador,
      atividade,
      responsavel,
      inicioStr,
      fimStr,
      inicio,
      fim,
      duracaoDias,
      predecessorId,
      diasComerciais
    };

    editingIndex = null;
    toggleModoEdicao(false);
    atualizarHeaderInfo();
    recalcularCronograma();
    limparFormulario();
  }

  function removerAtividade(index) {
    if (!confirm("Remover esta atividade do cronograma?")) return;
    const removida = atividades.splice(index, 1)[0];
    if (removida) {
      atividades.forEach(a => {
        if (a.predecessorId === removida.id) a.predecessorId = null;
      });
    }
    if (editingIndex !== null) {
      if (editingIndex === index) {
        cancelarEdicao();
      } else if (editingIndex > index) {
        editingIndex -= 1;
      }
    }
    calcularPlanejadoEStatus();
    renderTabela();
    renderGantt();
    atualizarListaPredecessoras();
    onPredecessoraChange();
  }

  function alterarReal(index, valor) {
    const perc = Number(valor);
    const a = atividades[index];
    a.realPercent = perc;
    calcularPlanejadoEStatus();
    renderTabela();
    salvarRealNoServidor(a);
  }

  function obterNomePredecessora(item) {
    if (!item.predecessorId) return "-";
    const pred = atividades.find(a => a.id === item.predecessorId);
    return pred ? pred.atividade : "-";
  }

  function renderTabela() {
    const tbody = document.querySelector("#tabela-atividades tbody");
    tbody.innerHTML = "";
    if (atividades.length === 0) {
      document.getElementById("no-data-msg").style.display = "block";
      return;
    } else {
      document.getElementById("no-data-msg").style.display = "none";
    }
    atividades.forEach((item, i) => {
      const tr = document.createElement("tr");
      const duracao = item.duracaoDias || diffInDays(item.inicio, item.fim);
      const nomePredecessora = obterNomePredecessora(item);
      const pr = item.plannedPercent || 0;
      const rr = item.realPercent || 0;
      const modo = item.diasComerciais ? "Comercial" : "Corridos";
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${item.atividade}</td>
        <td>${item.responsavel || "-"}</td>
        <td>${item.inicioStr || ""}</td>
        <td>${item.fimStr || ""}</td>
        <td><span class="tag-dia">${duracao} dia(s)</span></td>
        <td>${modo}</td>
        <td>${pr}%</td>
        <td>
          <select onchange="alterarReal(${i}, this.value)">
            <option value="0" ${rr === 0 ? "selected" : ""}>0%</option>
            <option value="25" ${rr === 25 ? "selected" : ""}>25%</option>
            <option value="50" ${rr === 50 ? "selected" : ""}>50%</option>
            <option value="75" ${rr === 75 ? "selected" : ""}>75%</option>
            <option value="100" ${rr === 100 ? "selected" : ""}>100%</option>
          </select>
        </td>
        <td class="${item.statusClass || ""}">${item.status || "-"}</td>
        <td>${nomePredecessora}</td>
        <td>
          <button class="btn-secondary" onclick="event.stopPropagation(); iniciarEdicao(${i});">Editar</button>
          <button class="btn-danger" onclick="event.stopPropagation(); removerAtividade(${i});">Excluir</button>
        </td>
      `;
      tr.addEventListener("click", () => iniciarEdicao(i));
      if (editingIndex === i) tr.classList.add("row-editing");
      tbody.appendChild(tr);
    });
  }

  function renderGantt() {
    const grid = document.getElementById("gantt-grid");
    const labels = document.getElementById("gantt-day-labels");
    grid.innerHTML = "";
    labels.innerHTML = "";
    if (atividades.length === 0) return;

    let minDate = null;
    let maxDate = null;
    atividades.forEach(a => {
      const candidatosInicio = [];
      const candidatosFim = [];
      if (a.inicio) candidatosInicio.push(a.inicio);
      if (a.fim) candidatosFim.push(a.fim);
      if (a.baselineInicio) candidatosInicio.push(a.baselineInicio);
      if (a.baselineFim) candidatosFim.push(a.baselineFim);
      candidatosInicio.forEach(d => {
        if (!minDate || d < minDate) minDate = d;
      });
      candidatosFim.forEach(d => {
        if (!maxDate || d > maxDate) maxDate = d;
      });
    });
    if (!minDate || !maxDate) return;
    const totalDias = diffInDays(minDate, maxDate);

    labels.style.gridTemplateColumns = `repeat(${totalDias}, 24px)`;
    for (let i = 0; i < totalDias; i++) {
      const span = document.createElement("div");
      span.textContent = "D" + (i + 1);
      labels.appendChild(span);
    }

    atividades.forEach(a => {
      const rowWrapper = document.createElement("div");
      rowWrapper.style.display = "grid";
      rowWrapper.style.gridTemplateColumns = "110px 1fr";
      rowWrapper.style.columnGap = "4px";

      const label = document.createElement("div");
      label.className = "gantt-row-label";
      label.textContent = a.atividade;

      const row = document.createElement("div");
      row.className = "gantt-row";
      row.style.gridTemplateColumns = `repeat(${totalDias}, 24px)`;

      let offsetBase = null;
      let durBase = null;
      if (a.baselineInicio && a.baselineFim) {
        offsetBase = diffInDays(minDate, a.baselineInicio) - 1;
        durBase = a.baselineDuracaoDias || diffInDays(a.baselineInicio, a.baselineFim);
        const barBase = document.createElement("div");
        barBase.className = "gantt-bar-base";
        barBase.style.gridColumn = `${offsetBase + 1} / span ${durBase}`;
        row.appendChild(barBase);
      }

      const rr = a.realPercent || 0;
      if (rr > 0) {
        let offsetReal;
        let totalDiasRef;
        if (a.baselineInicio && a.baselineFim && durBase) {
          offsetReal = offsetBase;
          totalDiasRef = durBase;
        } else if (a.inicio && a.fim) {
          offsetReal = diffInDays(minDate, a.inicio) - 1;
          totalDiasRef = a.duracaoDias || diffInDays(a.inicio, a.fim);
        } else {
          totalDiasRef = 0;
        }
        if (totalDiasRef > 0 && offsetReal != null) {
          let durReal = Math.round(totalDiasRef * rr / 100);
          if (durReal < 1) durReal = 1;
          const barReal = document.createElement("div");
          barReal.className = "gantt-bar-real";
          barReal.style.gridColumn = `${offsetReal + 1} / span ${durReal}`;
          row.appendChild(barReal);
        }
      }

      rowWrapper.appendChild(label);
      rowWrapper.appendChild(row);
      grid.appendChild(rowWrapper);
    });
  }

  function recalcularCronograma() {
    if (atividades.length === 0) {
      alert("N√£o h√° atividades para recalcular.");
      return;
    }
    const maxIter = atividades.length;
    for (let iter = 0; iter < maxIter; iter++) {
      let changed = false;
      atividades.forEach(a => {
        if (!a.predecessorId) return;
        const pred = atividades.find(p => p.id === a.predecessorId);
        if (!pred) {
          a.predecessorId = null;
          return;
        }
        const diasComerciais = !!a.diasComerciais;
        const newStart = diasComerciais ? nextBusinessDay(pred.fim) : addDays(pred.fim, 1);
        const newEnd = calcularFim(newStart, a.duracaoDias, diasComerciais);
        if (a.inicio.getTime() !== newStart.getTime() ||
            a.fim.getTime() !== newEnd.getTime()) {
          a.inicio = newStart;
          a.fim = newEnd;
          a.inicioStr = formatDateToInput(newStart);
          a.fimStr = formatDateToInput(newEnd);
          changed = true;
        }
      });
      if (!changed) break;
    }
    calcularPlanejadoEStatus();
    renderTabela();
    renderGantt();
    alert("Cronograma recalculado com base nas predecessoras (efeito domin√≥).");
  }

async function salvarNoServidor(silencioso = false) {
  const obraNome = getObraSelecionadaNome();
  const obraId   = getObraSelecionadaId();
  const coordenador = document.getElementById("coordenador").value.trim();

  if (!obraNome) {
    if (!silencioso) alert("Selecione a Obra para salvar no servidor.");
    return;
  }
  if (atividades.length === 0) {
    if (!silencioso) alert("N√£o h√° atividades para salvar.");
    return;
  }

  const arquivo = getArquivoNome(obraNome, obraId);
  if (!arquivo) {
    if (!silencioso) alert("N√£o foi poss√≠vel definir o nome do arquivo do cronograma.");
    return;
  }

  const payload = {
    obra: obraNome,
    obraId: obraId || null,
    coordenador,
    linhaBaseSalva,
    arquivo,
    atividades: atividades.map(a => ({
      id: a.id,
      atividade: a.atividade,
      responsavel: a.responsavel,
      inicioStr: a.inicioStr,
      fimStr: a.fimStr,
      duracaoDias: a.duracaoDias,
      diasComerciais: !!a.diasComerciais,
      predecessorId: a.predecessorId,
      realPercent: a.realPercent,
      plannedPercent: a.plannedPercent,
      baselineInicioStr: a.baselineInicioStr,
      baselineFimStr: a.baselineFimStr,
      baselineDuracaoDias: a.baselineDuracaoDias
    }))
  };

  try {
    const resp = await fetch(
      API_SAVE_URL + "?arquivo=" + encodeURIComponent(arquivo),
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }
    );
    const data = await resp.json();
    if (!resp.ok || data.sucesso === false) {
      console.error("salvar_cronograma.php ->", data);
      if (!silencioso) alert("Erro ao salvar cronograma no servidor: " + (data.mensagem || resp.statusText));
      return;
    }
    if (!silencioso) alert("Cronograma salvo no servidor com sucesso.");
  } catch (e) {
    console.error("Erro comunica√ß√£o salvar_cronograma:", e);
    if (!silencioso) alert("Falha na comunica√ß√£o com o servidor ao salvar.");
  }
}


  async function salvarRealNoServidor(atividade) {
    const obraNome = getObraSelecionadaNome();
    const obraId   = getObraSelecionadaId();
    if (!obraNome || !atividade) return;

    const payload = {
      obra: obraNome,
      obraId: obraId || null,
      idAtividade: atividade.id,
      atividade: atividade.atividade,
      realPercent: atividade.realPercent
    };

    try {
      const resp = await fetch(API_SAVE_REAL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if (!resp.ok || data.sucesso === false) {
        console.error("salvar_real.php ->", data);
      }
    } catch (e) {
      console.error("Erro comunica√ß√£o salvar_real:", e);
    }
  }

  function exportarJSON() {
    if (atividades.length === 0) {
      alert("N√£o h√° atividades para exportar.");
      return;
    }
    const dados = atividades.map((a, i) => ({
      ordem: i + 1,
      id: a.id,
      obraId: a.obraId || null,
      obra: a.obra,
      coordenador: a.coordenador,
      atividade: a.atividade,
      responsavel: a.responsavel,
      inicio: a.inicioStr,
      fim: a.fimStr,
      duracaoDias: a.duracaoDias,
      diasComerciais: !!a.diasComerciais,
      status: a.status,
      plannedPercent: a.plannedPercent,
      realPercent: a.realPercent,
      predecessorId: a.predecessorId,
      predecessora: obterNomePredecessora(a),
      baselineInicio: a.baselineInicioStr,
      baselineFim: a.baselineFimStr,
      baselineDuracaoDias: a.baselineDuracaoDias
    }));
    const blob = new Blob([JSON.stringify(dados, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const aTag = document.createElement("a");
    aTag.href = url;
    aTag.download = "cronograma_impar.json";
    aTag.click();
    URL.revokeObjectURL(url);
  }

  // ===== Carregar combos do backend =====
  async function carregarObrasDropdown(idSelecionadoDaURL) {
    try{
      const resp = await fetch(API_LIST_OBRAS);
      const lista = await resp.json();
      if (!Array.isArray(lista)) throw new Error("Resposta inesperada ao listar obras.");
      cacheObras = lista;
      const sel = document.getElementById("obra");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Selecione a obra";
      sel.appendChild(opt0);

      lista.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.obra || "";
        opt.textContent = o.obra || ("Obra " + (o.id || ""));
        if (o.id !== undefined && o.id !== null) {
          opt.setAttribute("data-id", o.id);
        }
        sel.appendChild(opt);
      });

      if (idSelecionadoDaURL) {
        for (let i=0;i<sel.options.length;i++){
          if (sel.options[i].getAttribute("data-id") == idSelecionadoDaURL){
            sel.selectedIndex = i;
            break;
          }
        }
      }
      atualizarHeaderInfo();
    }catch(e){
      console.error(e);
    }
  }

  async function carregarCoordenadoresDropdown() {
    try {
      const resp = await fetch(API_LIST_COORDENADORES);
      const raw = await resp.json();
      console.log("listar_coordenadores.php ->", raw);

      let lista = [];
      if (Array.isArray(raw)) {
        lista = raw;
      } else if (Array.isArray(raw.dados)) {
        lista = raw.dados;
      } else if (Array.isArray(raw.coordenadores)) {
        lista = raw.coordenadores;
      } else if (Array.isArray(raw.lista)) {
        lista = raw.lista;
      }

      if (!Array.isArray(lista)) lista = [];
      cacheCoordenadores = lista;

      const sel = document.getElementById("coordenador");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Selecione o coordenador";
      sel.appendChild(opt0);

      lista.forEach(c => {
        let nome = "";
        if (typeof c === "string") {
          nome = c;
        } else {
          nome =
            c.nome ||
            c.coordenador ||
            c.nome_coordenador ||
            c.label ||
            "";
        }
        if (!nome) return;
        const opt = document.createElement("option");
        opt.value = nome;
        opt.textContent = nome;
        sel.appendChild(opt);
      });
    } catch (e) {
      console.error("Erro ao carregar coordenadores:", e);
    }
  }

  async function carregarResponsaveisDropdown() {
    try {
      const resp = await fetch(API_LIST_RESPONSAVEIS);
      const raw = await resp.json();
      console.log("listar_responsaveis.php ->", raw);

      let lista = [];
      if (Array.isArray(raw)) {
        lista = raw;
      } else if (Array.isArray(raw.dados)) {
        lista = raw.dados;
      } else if (Array.isArray(raw.responsaveis)) {
        lista = raw.responsaveis;
      } else if (Array.isArray(raw.lista)) {
        lista = raw.lista;
      }

      if (!Array.isArray(lista)) lista = [];
      cacheResponsaveis = lista;

      const sel = document.getElementById("responsavel");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Selecione o respons√°vel";
      sel.appendChild(opt0);

      lista.forEach(r => {
        let nome = "";
        if (typeof r === "string") {
          nome = r;
        } else {
          nome =
            r.nome ||
            r.responsavel ||
            r.nome_responsavel ||
            r.label ||
            "";
        }
        if (!nome) return;
        const opt = document.createElement("option");
        opt.value = nome;
        opt.textContent = nome;
        sel.appendChild(opt);
      });
    } catch (e) {
      console.error("Erro ao carregar respons√°veis:", e);
    }
  }

  // ===== Carregar cronograma salvo (carregar_cronograma.php) =====
  function limparCronogramaLocal() {
    atividades = [];
    nextId = 1;
    linhaBaseSalva = false;
    document.getElementById("badge-base").style.display = "none";
    renderTabela();
    renderGantt();
    atualizarListaPredecessoras();
    atualizarResumoObra();
  }

  function mapAtividadeServidor(item, obraNome, obraId, coordenadorPadrao) {
    const atividade = item.atividade || item.nome || item.descricao || "";
    const responsavel = item.responsavel || item.resp || "";
    const inicioStr = item.inicioStr || item.inicio || item.data_inicio;
    const fimStr = item.fimStr || item.fim || item.data_fim;
    const duracaoDias = Number(item.duracaoDias || item.duracao || 0) || null;
    const diasComerciais = !!(item.diasComerciais || item.dias_uteis || item.modo === "Comercial" || item.modo === "Dias √∫teis");
    const predecessorId = item.predecessorId ? Number(item.predecessorId) :
                          (item.predecessora_id ? Number(item.predecessora_id) : null);
    const realPercent = Number(item.realPercent || item.real || item.percentual_real || 0) || 0;
    const plannedPercent = Number(item.plannedPercent || item.planejado || item.percentual_planejado || 0) || 0;

    const baselineInicioStr = item.baselineInicioStr || item.baselineInicio || item.base_inicio;
    const baselineFimStr = item.baselineFimStr || item.baselineFim || item.base_fim;
    const baselineDuracaoDias = Number(item.baselineDuracaoDias || item.baseDuracao || 0) || null;

    const inicio = inicioStr ? parseDate(inicioStr) : null;
    const fim = fimStr ? parseDate(fimStr) : null;
    const baselineInicio = baselineInicioStr ? parseDate(baselineInicioStr) : null;
    const baselineFim = baselineFimStr ? parseDate(baselineFimStr) : null;

    return {
      id: item.id ? Number(item.id) : null,
      obra: obraNome,
      obraId,
      coordenador: item.coordenador || coordenadorPadrao || "",
      atividade,
      responsavel,
      inicioStr: inicioStr || (inicio ? formatDateToInput(inicio) : ""),
      fimStr: fimStr || (fim ? formatDateToInput(fim) : ""),
      inicio,
      fim,
      duracaoDias: duracaoDias || (inicio && fim ? diffInDays(inicio, fim) : 0),
      predecessorId,
      diasComerciais,
      realPercent,
      plannedPercent,
      status: item.status || "N√£o iniciado",
      statusClass: "",
      baselineInicio,
      baselineFim,
      baselineDuracaoDias,
      baselineInicioStr: baselineInicioStr || (baselineInicio ? formatDateToInput(baselineInicio) : null),
      baselineFimStr: baselineFimStr || (baselineFim ? formatDateToInput(baselineFim) : null)
    };
  }

async function carregarCronogramaServidor(obraId, obraNome) {
  if (!obraId && !obraNome) {
    limparCronogramaLocal();
    return;
  }

  const arquivo = getArquivoNome(obraNome, obraId);
  if (!arquivo) {
    limparCronogramaLocal();
    return;
  }

  try {
    const url = API_LOAD_URL + "?arquivo=" + encodeURIComponent(arquivo);
    const resp = await fetch(url);
    const raw = await resp.json();
    console.log("carregar_cronograma.php ->", raw);

    if (raw.error) {
      console.warn("Backend retornou erro:", raw.message);
      limparCronogramaLocal();
      return;
    }

    let lista = [];
    let coord = raw.coordenador || raw.coordinator || "";
    let flagBase = !!(raw.linhaBaseSalva || raw.baselineSalva);

    if (Array.isArray(raw)) {
      lista = raw;
    } else if (Array.isArray(raw.atividades)) {
      lista = raw.atividades;
    } else if (Array.isArray(raw.dados)) {
      lista = raw.dados;
    } else if (Array.isArray(raw.cronograma)) {
      lista = raw.cronograma;
    }

    if (!Array.isArray(lista) || lista.length === 0) {
      limparCronogramaLocal();
      return;
    }

    const mapped = lista.map(item =>
      mapAtividadeServidor(item, obraNome, obraId, coord)
    );

    let maxId = 0;
    mapped.forEach((a, idx) => {
      if (!a.id) a.id = idx + 1;
      if (a.id > maxId) maxId = a.id;
    });

    atividades = mapped;
    nextId = maxId + 1;
    linhaBaseSalva = flagBase || atividades.some(a => a.baselineInicio && a.baselineFim);
    document.getElementById("badge-base").style.display = linhaBaseSalva ? "inline-block" : "none";

    calcularPlanejadoEStatus();
    renderTabela();
    renderGantt();
    atualizarListaPredecessoras();
  } catch (e) {
    console.error("Erro ao carregar cronograma do servidor:", e);
    limparCronogramaLocal();
  }
}


  function carregarCronogramaParaObraSelecionada() {
    const obraNome = getObraSelecionadaNome();
    const obraId   = getObraSelecionadaId();
    if (!obraNome && !obraId) {
      limparCronogramaLocal();
      return;
    }
    carregarCronogramaServidor(obraId, obraNome);
  }

  // ===== init =====
  document.getElementById("predecessora").addEventListener("change", onPredecessoraChange);
  document.getElementById("coordenador").addEventListener("change", atualizarHeaderInfo);
  document.getElementById("inicio").addEventListener("change", onInicioChange);
  document.getElementById("fim").addEventListener("change", onFimChange);
  document.getElementById("duracao").addEventListener("change", onDuracaoChange);

  document.getElementById("obra").addEventListener("change", () => {
    atualizarHeaderInfo();
    carregarCronogramaParaObraSelecionada();
  });

  (async function initCronograma(){
    const params = new URLSearchParams(window.location.search);
    const idObra = params.get("id"); // vindo do Farol
    await Promise.all([
      carregarObrasDropdown(idObra),
      carregarCoordenadoresDropdown(),
      carregarResponsaveisDropdown()
    ]);
    if (idObra) {
      const selObra = document.getElementById("obra");
      const obraNome = selObra.value || getObraSelecionadaNome();
      const obraId = getObraSelecionadaId() || idObra;
      await carregarCronogramaServidor(obraId, obraNome);
    }
  })();
</script>
</body>
</html>

