<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>ERP Ímpar – Cronograma de Obras</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root{
    --bg:#020617;
    --bg2:#020617;
    --card:#020617;
    --border:#1f2937;
    --text:#e5e7eb;
    --text-soft:#9ca3af;
    --blue:#3b82f6;
    --blue-dark:#1d4ed8;
    --orange:#f97316;
    --green:#22c55e;
    --yellow:#eab308;
    --red:#ef4444;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    background:
      radial-gradient(circle at top left,#1d4ed8 0,transparent 55%),
      radial-gradient(circle at bottom right,#f97316 0,transparent 55%),
      linear-gradient(120deg,#020617,#020617 60%,#030712);
    color:var(--text);
    min-height:100vh;
    display:flex;
    flex-direction:column;
  }
  header{
    padding:10px 16px 4px;
    display:flex;
    justify-content:center;
  }
  .header-inner{
    width:100%;
    max-width:1200px;
    display:flex;
    justify-content:space-between;
    gap:16px;
    align-items:flex-start;
  }
  .brand{
    display:flex;
    flex-direction:column;
    gap:2px;
    text-shadow:0 2px 6px rgba(0,0,0,.8);
  }
  .brand span:nth-child(1){
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.22em;
    opacity:.9;
  }
  .brand span:nth-child(2){
    font-size:20px;
    font-weight:800;
  }
  .brand span:nth-child(3){
    font-size:11px;
    opacity:.9;
  }
  .tag-top{
    font-size:11px;
    padding:4px 10px;
    border-radius:999px;
    background:rgba(15,23,42,.9);
    border:1px solid rgba(148,163,184,.7);
    color:var(--text-soft);
    margin-top:12px;          /* <<< adiciona isso */
  }


  main{
    flex:1 0 auto;
    display:flex;
    justify-content:center;
    padding:6px 12px 10px;
  }
  .layout{
    width:100%;
    max-width:1200px;
    display:grid;
    grid-template-columns:minmax(0,1.1fr) minmax(0,1.5fr);
    gap:16px;
    align-items:start;
  }
  @media(max-width:1000px){
    .layout{grid-template-columns:1fr;}
  }

  section{
    background:rgba(15,23,42,.96);
    border-radius:18px;
    border:1px solid rgba(55,65,81,.9);
    box-shadow:0 18px 40px rgba(0,0,0,.75);
    padding:12px;
  }

  h2{font-size:15px;margin-bottom:4px;}
  label{
    font-size:11px;
    color:var(--text-soft);
    display:block;
    margin-bottom:2px;
  }
  select,input[type="date"],input[type="number"],input[type="text"]{
    width:100%;
    padding:4px 6px;
    border-radius:8px;
    border:1px solid #4b5563;
    background:#020617;
    color:var(--text);
    font-size:12px;
  }

  .top-bar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    margin-bottom:6px;
  }
  .top-left{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .top-actions{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    justify-content:flex-end;
  }

  .pill-btn{
    border-radius:999px;
    border:1px solid #4b5563;
    background:#020617;
    padding:5px 10px;
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:.12em;
    color:var(--text-soft);
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .pill-btn span.icn{font-size:12px;}
  .pill-btn:hover{
    border-color:#9ca3af;
    color:#e5e7eb;
  }

  .mode-group{
    display:inline-flex;
    border-radius:999px;
    border:1px solid #4b5563;
    overflow:hidden;
  }
  .mode-btn{
    background:#020617;
    border:0;
    padding:5px 10px;
    font-size:10px;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:var(--text-soft);
    cursor:pointer;
  }
  .mode-btn.active{
    background:linear-gradient(135deg,#2563eb,#22c55e);
    color:#fff;
  }

  .linha-top{
    display:grid;
    grid-template-columns:1.4fr 1.1fr;
    gap:8px;
    margin-bottom:8px;
  }
  @media(max-width:700px){
    .linha-top{grid-template-columns:1fr;}
  }

  .resumo-grid{
    display:grid;
    grid-template-columns:repeat(4,minmax(0,1fr));
    gap:6px;
    margin-bottom:8px;
    font-size:11px;
  }
  @media(max-width:900px){
    .resumo-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
  }
  .resumo-card{
    border-radius:10px;
    border:1px solid #374151;
    background:#020617;
    padding:6px 8px;
  }
  .resumo-card strong{
    display:block;font-size:11px;margin-bottom:2px;
  }
  .resumo-valor{font-size:12px;}

  .status-pill{
    border-radius:999px;
    border:1px solid #4b5563;
    padding:4px 8px;
    font-size:11px;
    display:inline-flex;
    align-items:center;
    gap:6px;
  }
  .status-dot{
    width:8px;height:8px;border-radius:999px;
  }

  .form-ativ{
    border-top:1px dashed #374151;
    margin-top:6px;
    padding-top:6px;
    font-size:12px;
  }
  .form-grid{
    display:grid;
    grid-template-columns:1.6fr 1.2fr;
    gap:8px;
    margin-bottom:6px;
  }
  @media(max-width:700px){
    .form-grid{grid-template-columns:1fr;}
  }
  .form-grid-2{
    display:grid;
    grid-template-columns:repeat(4,minmax(0,1fr));
    gap:8px;
    margin-bottom:6px;
  }
  @media(max-width:950px){
    .form-grid-2{grid-template-columns:repeat(2,minmax(0,1fr));}
  }
  @media(max-width:600px){
    .form-grid-2{grid-template-columns:1fr;}
  }
  .form-actions{
    display:flex;
    gap:6px;
    justify-content:flex-end;
    margin-top:4px;
  }
  .btn{
    border-radius:999px;
    border:0;
    padding:6px 10px;
    font-size:9px;              /* fonte menor */
    letter-spacing:.14em;
    text-transform:uppercase;
    font-weight:700;
    cursor:pointer;
    color:#fff;
    box-shadow:0 10px 24px rgba(0,0,0,.85);
  }

  /* agora o secondary usa a mesma paleta do primary */
  .btn-primary{
    background:linear-gradient(135deg,#2563eb,#22c55e);
  }
  .btn-secondary{
    background:linear-gradient(135deg,#2563eb,#22c55e);
  }
  .btn-danger{
    background:linear-gradient(135deg,#b91c1c,#ef4444);
  }


  .tabela-wrapper{
    border-radius:12px;
    border:1px solid #374151;
    overflow:auto;
    max-height:350px;
    background:#020617;
    margin-bottom:8px;
  }
  table{
    width:100%;
    border-collapse:collapse;
    font-size:11px;
  }
  thead{
    background:#020617;
    position:sticky;
    top:0;
    z-index:2;
  }
  th,td{
    padding:4px 6px;
    border-bottom:1px solid #111827;
    white-space:nowrap;
  }
  th{
    text-align:left;
    color:var(--text-soft);
    font-weight:600;
    font-size:10px;
  }
  tr:nth-child(even) td{background:#020617;}
  tr:nth-child(odd) td{background:#020617;}
  tr:hover td{background:#020617;}
  .acao-link{
    color:#93c5fd;
    cursor:pointer;
    text-decoration:underline;
  }

  .gantt{
    border-radius:12px;
    border:1px solid #374151;
    background:#020617;
    padding:6px 8px;
    font-size:10px;
    max-height:200px;
    overflow:auto;
  }
  .gantt-title{
    margin-bottom:4px;
    color:var(--text-soft);
    font-weight:600;
  }
  .gantt-item{
    margin-bottom:6px;
  }
  .gantt-label{
    margin-bottom:2px;
  }
  .gantt-bars{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .gantt-bar{
    height:6px;
    border-radius:999px;
  }
  .gantt-plan{background:rgba(59,130,246,.95);}
  .gantt-real{background:rgba(249,115,22,.95);}

  footer{
    background:#020617;
    color:#9ca3af;
    padding:6px 16px;
    font-size:10px;
  }
  .rodape-inner{
    max-width:1200px;
    margin:0 auto;
    display:flex;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <span>PLATAFORMA</span>
      <span>ERP ÍMPAR • Cronograma de Obras</span>
      <span>Planejado x Real com linha de base e farol</span>
    </div>
    <div class="tag-top">
      <button class="pill-btn" id="btnVoltarFarol" type="button">
        <span class="icn">←</span>
        Voltar para o Farol
      </button>
    </div>
  </div>
</header>

<main>
  <div class="layout">

    <!-- Painel esquerda: obra + resumo + formulário -->
    <section aria-label="Obra e cadastro de atividades">
      <div class="top-bar">
        <div class="top-left">
          <div style="font-size:12px;color:var(--text-soft);">Selecione a obra e o coordenador</div>
          <div class="linha-top">
            <div>
              <label for="obraSelect">Obra</label>
              <select id="obraSelect">
                <option value="">Selecione...</option>
              </select>
            </div>
            <div>
              <label for="coordSelect">Coordenador</label>
              <select id="coordSelect">
                <option value="">Selecione...</option>
              </select>
            </div>
          </div>
        </div>
        <div class="top-actions">
          <div class="mode-group">
            <button class="mode-btn active" id="btnModoPlanejado" type="button">Planejado</button>
            <button class="mode-btn" id="btnModoReal" type="button">Real</button>
          </div>
        </div>
      </div>

      <div class="resumo-grid">
        <div class="resumo-card">
          <strong>Início da obra (baseline)</strong>
          <div class="resumo-valor" id="resumoInicioBaseline">—</div>
        </div>
        <div class="resumo-card">
          <strong>Término da obra (baseline)</strong>
          <div class="resumo-valor" id="resumoFimBaseline">—</div>
        </div>
        <div class="resumo-card">
          <strong>% planejado (obra)</strong>
          <div class="resumo-valor" id="resumoPercPlanObra">0%</div>
        </div>
        <div class="resumo-card">
          <strong>% real (obra)</strong>
          <div class="resumo-valor" id="resumoPercRealObra">0%</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
        <div class="status-pill">
          <div class="status-dot" id="statusDot" style="background:var(--yellow);"></div>
          <span id="statusTexto">Sem início</span>
        </div>
        <div style="font-size:11px;color:var(--text-soft);">
          Atividades: <span id="qtdAtividades">0</span>
        </div>
      </div>

      <div class="form-ativ">
        <h2>Atividade – <span id="labelModoAtual">Planejado (linha de base)</span></h2>

        <input type="hidden" id="campoIdEdicao" value="">

        <div class="form-grid">
          <div>
            <label for="campoAtividade">Descrição da atividade</label>
            <input type="text" id="campoAtividade" placeholder="Ex.: Estrutura, alvenaria, instalações...">
          </div>
          <div>
            <label for="campoResponsavel">Responsável</label>
            <select id="campoResponsavel">
              <option value="">Selecione...</option>
            </select>
          </div>
        </div>

        <div class="form-grid-2">
          <div>
            <label for="campoPredecessora">Predecessora</label>
            <select id="campoPredecessora">
              <option value="">Nenhuma</option>
            </select>
          </div>
          <div>
            <label for="campoDataInicio">Início</label>
            <input type="date" id="campoDataInicio">
          </div>
          <div>
            <label for="campoDuracao">Duração (dias)</label>
            <input type="number" id="campoDuracao" min="1" value="1">
          </div>
          <div>
            <label for="campoTipoDias">Tipo de dias</label>
            <select id="campoTipoDias">
              <option value="corridos">Dias corridos</option>
              <option value="uteis">Dias úteis (seg-sex)</option>
            </select>
          </div>
        </div>

        <div class="form-grid-2">
         <div>
          <label for="campoPercentualReal">% Conclusão real</label>
          <select id="campoPercentualReal">
            <option value="0">0%</option>
            <option value="25">25%</option>
            <option value="50">50%</option>
            <option value="75">75%</option>
            <option value="100">100%</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end;justify-content:flex-end;">
          <button class="btn btn-primary" id="btnSalvarAtividade" type="button">Salvar atividade</button>
        </div>
       </div>


        <div class="form-actions">
          <button class="btn btn-primary" id="btnSalvarBaseline" type="button" title="Salva uma nova versão da linha de base (v1, v2...)">
            Salvar linha de base
          </button>
          <button class="btn btn-primary" id="btnSalvarReal" type="button" title="Salva o andamento real da obra">
            Salvar andamento real
          </button>
          <button class="btn btn-secondary" id="btnRecalcular" type="button">
            Recalcular
          </button>
          <button class="btn btn-secondary" id="btnExportarJSON" type="button">
            Exportar JSON
          </button>
        </div>
      </div>
    </section>

    <!-- Painel direita: tabela + Gantt -->
    <section aria-label="Atividades e Gantt">
      <h2>Atividades do cronograma</h2>
      <div style="font-size:11px;color:var(--text-soft);margin-bottom:4px;">
        Tabela combinando baseline (planejado) e real. Edição respeita o modo selecionado.
      </div>

      <div class="tabela-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Atividade</th>
              <th>Resp.</th>
              <th>Início (plan)</th>
              <th>Término (plan)</th>
              <th>Dur. (plan)</th>
              <th>Início (real)</th>
              <th>Término (real)</th>
              <th>Dur. (real)</th>
              <th>% Real</th>
              <th>Dias</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tbodyAtividades">
          </tbody>
        </table>
      </div>

      <div class="gantt">
        <div class="gantt-title">
          Visão geral (barra azul = baseline / barra laranja = real proporcional ao %)
        </div>
        <div id="ganttContainer"></div>
      </div>
    </section>

  </div>
</main>

<footer>
  <div class="rodape-inner">
    <span>© 2025 ERP Ímpar • Módulo Cronograma de Obras</span>
    <span>Planejado x Real com linha de base, farol e Gantt simplificado</span>
  </div>
</footer>

<script>
  // Ajuste aqui se o domínio for diferente:
  // Exemplo KingHost: const API_BASE = 'https://api.erpimpar.com.br/cronograma';
  // Exemplo mesmo domínio: const API_BASE = '/api/cronograma';
  const API_BASE = '/api/cronograma';

  // Estado global
  let listaObras = [];
  let listaCoordenadores = [];
  let listaResponsaveis = [];

  let obraSelecionada = null; // {id, obra, arquivo}
  let baselineVersoes = [];   // array de versoes
  let baselineAtividades = []; // última baseline (versão ativa)
  let realAtividades = [];     // atividades reais

  let modoAtual = 'planejado'; // 'planejado' ou 'real'

  // Elementos
  const obraSelect = document.getElementById('obraSelect');
  const coordSelect = document.getElementById('coordSelect');
  const campoAtividade = document.getElementById('campoAtividade');
  const campoResponsavel = document.getElementById('campoResponsavel');
  const campoPredecessora = document.getElementById('campoPredecessora');
  const campoDataInicio = document.getElementById('campoDataInicio');
  const campoDuracao = document.getElementById('campoDuracao');
  const campoTipoDias = document.getElementById('campoTipoDias');
  const campoPercentualReal = document.getElementById('campoPercentualReal');
  const campoIdEdicao = document.getElementById('campoIdEdicao');

  const resumoInicioBaseline = document.getElementById('resumoInicioBaseline');
  const resumoFimBaseline = document.getElementById('resumoFimBaseline');
  const resumoPercPlanObra = document.getElementById('resumoPercPlanObra');
  const resumoPercRealObra = document.getElementById('resumoPercRealObra');
  const statusDot = document.getElementById('statusDot');
  const statusTexto = document.getElementById('statusTexto');
  const qtdAtividadesSpan = document.getElementById('qtdAtividades');
  const labelModoAtual = document.getElementById('labelModoAtual');

  const tbodyAtividades = document.getElementById('tbodyAtividades');
  const ganttContainer = document.getElementById('ganttContainer');

  const btnModoPlanejado = document.getElementById('btnModoPlanejado');
  const btnModoReal = document.getElementById('btnModoReal');
  const btnVoltarFarol = document.getElementById('btnVoltarFarol');
  const btnSalvarAtividade = document.getElementById('btnSalvarAtividade');
  const btnSalvarBaseline = document.getElementById('btnSalvarBaseline');
  const btnSalvarReal = document.getElementById('btnSalvarReal');
  const btnRecalcular = document.getElementById('btnRecalcular');
  const btnExportarJSON = document.getElementById('btnExportarJSON');

  // Util: ler querystring (?id=001)
  function getQueryParam(nome){
    const params = new URLSearchParams(window.location.search);
    return params.get(nome);
  }

  async function carregarListasIniciais() {
    try {
      const [obrasResp, coordsResp, respsResp] = await Promise.all([
        fetch(API_BASE + '/listar_obras.php').then(r => r.json()),
        fetch(API_BASE + '/listar_coordenadores.php').then(r => r.json()),
        fetch(API_BASE + '/listar_responsaveis.php').then(r => r.json())
      ]);
      listaObras = obrasResp || [];
      listaCoordenadores = coordsResp || [];
      listaResponsaveis = respsResp || [];
      preencherCombosBasicos();

      // Se veio id pela URL, pré-seleciona
      const idParam = getQueryParam('id');
      if(idParam){
        const encontrada = listaObras.find(o => o.id === idParam);
        if(encontrada){
          obraSelect.value = encontrada.id;
          obraSelecionada = encontrada;
          await carregarCronogramaDaObra();
        }
      }
    } catch(e){
      console.error(e);
      alert('Erro ao carregar listas iniciais do cronograma.');
    }
  }

  function preencherCombosBasicos(){
    obraSelect.innerHTML = '<option value="">Selecione...</option>';
    listaObras.forEach(o => {
      const opt = document.createElement('option');
      opt.value = o.id;
      opt.textContent = o.id + ' - ' + o.obra;
      opt.dataset.arquivo = o.arquivo;
      obraSelect.appendChild(opt);
    });

    coordSelect.innerHTML = '<option value="">Selecione...</option>';
    listaCoordenadores.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      coordSelect.appendChild(opt);
    });

    campoResponsavel.innerHTML = '<option value="">Selecione...</option>';
    listaResponsaveis.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r;
      opt.textContent = r;
      campoResponsavel.appendChild(opt);
    });
  }

  obraSelect.addEventListener('change', async () => {
    const id = obraSelect.value;
    if(!id){
      obraSelecionada = null;
      baselineVersoes = [];
      baselineAtividades = [];
      realAtividades = [];
      atualizarTela();
      return;
    }
    const ob = listaObras.find(o => o.id === id);
    obraSelecionada = ob || null;
    await carregarCronogramaDaObra();
  });

  async function carregarCronogramaDaObra(){
    if(!obraSelecionada) return;
    try{
      const url = API_BASE + '/carregar_cronograma.php?arquivo=' + encodeURIComponent(obraSelecionada.arquivo);
      const resp = await fetch(url);
      const json = await resp.json();

      baselineVersoes = json.baseline && json.baseline.versoes ? json.baseline.versoes : [];
      if(baselineVersoes.length > 0){
        baselineAtividades = baselineVersoes[baselineVersoes.length - 1].atividades || [];
      } else {
        baselineAtividades = [];
      }

      realAtividades = (json.real && Array.isArray(json.real.atividades)) ? json.real.atividades : [];

      // Coordenador salvo
      if(json.coordenador){
        coordSelect.value = json.coordenador;
      }

      // Se tiver baseline → começa em modo REAL, senão em PLANEJADO
      if(baselineVersoes.length > 0){
        definirModo('real');
      } else {
        definirModo('planejado');
      }

      recalcularTudo();
    } catch(e){
      console.error(e);
      alert('Erro ao carregar cronograma da obra.');
    }
  }

  function definirModo(modo){
    modoAtual = modo;
    if(modoAtual === 'planejado'){
      btnModoPlanejado.classList.add('active');
      btnModoReal.classList.remove('active');
      labelModoAtual.textContent = 'Planejado (linha de base)';
    } else {
      btnModoPlanejado.classList.remove('active');
      btnModoReal.classList.add('active');
      labelModoAtual.textContent = 'Real (andamento da obra)';
    }
    limparFormularioAtividade();
    atualizarTela();
  }

  btnModoPlanejado.addEventListener('click', () => definirModo('planejado'));
  btnModoReal.addEventListener('click', () => definirModo('real'));

  //btnNovaAtividade.addEventListener('click', () => {
  //  limparFormularioAtividade();
  //});

  function limparFormularioAtividade(){
    campoIdEdicao.value = '';
    campoAtividade.value = '';
    campoResponsavel.value = '';
    campoPredecessora.value = '';
    campoDataInicio.value = '';
    campoDuracao.value = 1;
    campoTipoDias.value = 'corridos';
    campoPercentualReal.value = '0';
  }

  function gerarNovoIdAtividade(){
    const ids = new Set();
    baselineAtividades.forEach(a => ids.add(parseInt(a.id || 0,10)));
    realAtividades.forEach(a => ids.add(parseInt(a.id || 0,10)));
    let maxId = 0;
    ids.forEach(v => {
      if(!isNaN(v) && v > maxId) maxId = v;
    });
    return String(maxId + 1);
  }

  function getListaAtualEdicao(){
    return (modoAtual === 'planejado') ? baselineAtividades : realAtividades;
  }

  btnSalvarAtividade.addEventListener('click', () => {
    if(!obraSelecionada){
      alert('Selecione uma obra antes de cadastrar atividades.');
      return;
    }
    const desc = campoAtividade.value.trim();
    if(!desc){
      alert('Informe a descrição da atividade.');
      return;
    }
    const dataIni = campoDataInicio.value;
    const dur = parseInt(campoDuracao.value || '0',10);
    if(!dataIni || isNaN(dur) || dur <= 0){
      alert('Informe a data de início e a duração (dias).');
      return;
    }
    const resp = campoResponsavel.value;
    const pred = campoPredecessora.value;
    const tipoDias = campoTipoDias.value;
    const diasComerciais = (tipoDias === 'uteis');
    const percReal = parseInt(campoPercentualReal.value || '0',10);

    const idEdicao = campoIdEdicao.value;
    const lista = getListaAtualEdicao();

    if(idEdicao){
      const idx = lista.findIndex(a => String(a.id) === String(idEdicao));
      if(idx >= 0){
        const alvo = lista[idx];
        alvo.atividade = desc;
        alvo.responsavel = resp;
        alvo.predecessora = pred || "";
        alvo.inicio = dataIni;
        alvo.duracao = dur;
        alvo.dias_comerciais = diasComerciais;
        if(modoAtual === 'real'){
          alvo.percentual = percReal;
        }
      }
    } else {
      const novoId = gerarNovoIdAtividade();
      const nova = {
        id: novoId,
        atividade: desc,
        responsavel: resp,
        predecessora: pred || "",
        inicio: dataIni,
        duracao: dur,
        dias_comerciais: diasComerciais
      };
      if(modoAtual === 'real'){
        nova.percentual = percReal;
      }
      lista.push(nova);
    }

    limparFormularioAtividade();
    recalcularTudo();
  });

  // Recalcular datas (efeito dominó) no baseline e no real
  btnRecalcular.addEventListener('click', () => {
    recalcularTudo();
  });

  function isDiaUtil(date){
    const d = date.getDay();
    return d !== 0 && d !== 6;
  }

  function adicionarDias(date, dias, diasComerciais){
    const d = new Date(date.getTime());
    let adicionados = 0;
    // duração 1 = fica no mesmo dia
    while(adicionados < dias - 1){
      d.setDate(d.getDate() + 1);
      if(!diasComerciais || isDiaUtil(d)){
        adicionados++;
      }
    }
    return d;
  }

  function recalcularDatas(lista){
    const mapa = {};
    lista.forEach(a => mapa[a.id] = a);

    const ordenadas = [...lista].sort((a,b) => parseInt(a.id||0,10)-parseInt(b.id||0,10));
    ordenadas.forEach(a => {
      const dur = parseInt(a.duracao || '0',10);
      if(!a.inicio || !dur || dur <= 0) return;

      let inicio = new Date(a.inicio + 'T00:00:00');
      if(a.predecessora && mapa[a.predecessora]){
        const pred = mapa[a.predecessora];
        if(pred.fim){
          const fimPred = new Date(pred.fim + 'T00:00:00');
          fimPred.setDate(fimPred.getDate() + 1);
          inicio = fimPred;
        }
      }
      const fim = adicionarDias(inicio, dur, !!a.dias_comerciais);
      a.inicio = inicio.toISOString().substring(0,10);
      a.fim = fim.toISOString().substring(0,10);
    });
  }

  function recalcularTudo(){
    // Efeito dominó nos dois modos
    if(baselineAtividades.length){
      recalcularDatas(baselineAtividades);
    }
    if(realAtividades.length){
      recalcularDatas(realAtividades);
    }
    calcularResumoObra();
    atualizarTela();
  }

  function calcularResumoObra(){
    // baseline: datas de início/fim e % planejado (aproximado por linha do tempo)
    let menor = null;
    let maior = null;
    const hoje = new Date();

    baselineAtividades.forEach(a => {
      if(!a.inicio || !a.fim) return;
      const di = new Date(a.inicio + 'T00:00:00');
      const df = new Date(a.fim + 'T00:00:00');
      if(!menor || di < menor) menor = di;
      if(!maior || df > maior) maior = df;
    });

    // % planejado com base na linha do tempo (simples)
    let somaDurPlan = 0;
    let somaPlan = 0;

    baselineAtividades.forEach(a => {
      if(!a.inicio || !a.fim) return;
      const di = new Date(a.inicio + 'T00:00:00');
      const df = new Date(a.fim + 'T00:00:00');
      const totalDias = Math.max(1, Math.round((df - di)/(1000*60*60*24))+1);

      let percPlanAtiv = 0;
      if(hoje <= di) percPlanAtiv = 0;
      else if(hoje >= df) percPlanAtiv = 100;
      else {
        const dec = Math.round((hoje - di)/(1000*60*60*24))+1;
        percPlanAtiv = Math.round(100*dec/totalDias);
      }

      somaDurPlan += totalDias;
      somaPlan += percPlanAtiv * totalDias;
    });

    let percPlanObra = 0;
    if(somaDurPlan > 0){
      percPlanObra = Math.round(somaPlan / somaDurPlan);
    }

    // % real ponderado por duração real
    let somaDurReal = 0;
    let somaReal = 0;
    realAtividades.forEach(a => {
      const dur = parseInt(a.duracao || '0',10);
      if(!dur) return;
      const perc = parseInt(a.percentual || '0',10);
      somaDurReal += dur;
      somaReal += perc * dur;
    });

    let percRealObra = 0;
    if(somaDurReal > 0){
      percRealObra = Math.round(somaReal / somaDurReal);
    }

    // atualiza globais "derivados"
    if(menor){
      resumoInicioBaseline.textContent = menor.toISOString().substring(0,10);
    } else {
      resumoInicioBaseline.textContent = '—';
    }
    if(maior){
      resumoFimBaseline.textContent = maior.toISOString().substring(0,10);
    } else {
      resumoFimBaseline.textContent = '—';
    }

    resumoPercPlanObra.textContent = percPlanObra + '%';
    resumoPercRealObra.textContent = percRealObra + '%';

    // Status simples
    let status = 'Sem início';
    let cor = 'var(--yellow)';
    if(percPlanObra === 0 && percRealObra === 0){
      status = 'Sem início';
      cor = 'var(--yellow)';
    } else if(percRealObra >= percPlanObra){
      status = 'No prazo / adiantado';
      cor = 'var(--green)';
    } else if(percRealObra >= percPlanObra * 0.8){
      status = 'Atenção';
      cor = 'var(--yellow)';
    } else {
      status = 'Atrasado';
      cor = 'var(--red)';
    }
    statusTexto.textContent = status;
    statusDot.style.background = cor;
  }

  function atualizarTela(){
    // preencher predecessoras (união de IDs)
    const idsSet = new Set();
    baselineAtividades.forEach(a => idsSet.add(a.id));
    realAtividades.forEach(a => idsSet.add(a.id));
    const idsOrdenados = Array.from(idsSet).sort((a,b)=>parseInt(a,10)-parseInt(b,10));

    campoPredecessora.innerHTML = '<option value="">Nenhuma</option>';
    idsOrdenados.forEach(id => {
      const base = baselineAtividades.find(a => String(a.id) === String(id));
      const real = realAtividades.find(a => String(a.id) === String(id));
      const nome = (base && base.atividade) || (real && real.atividade) || ('Atividade ' + id);
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = id + ' - ' + nome;
      campoPredecessora.appendChild(opt);
    });

    // tabela
    tbodyAtividades.innerHTML = '';
    idsOrdenados.forEach(id => {
      const base = baselineAtividades.find(a => String(a.id) === String(id)) || {};
      const real = realAtividades.find(a => String(a.id) === String(id)) || {};

      const tr = document.createElement('tr');
      const tipoDias = base.dias_comerciais ?? real.dias_comerciais;
      const labelDias = tipoDias ? 'Úteis' : 'Corridos';

      tr.innerHTML = `
        <td>${id}</td>
        <td>${base.atividade || real.atividade || ''}</td>
        <td>${base.responsavel || real.responsavel || ''}</td>
        <td>${base.inicio || ''}</td>
        <td>${base.fim || ''}</td>
        <td>${base.duracao || ''}</td>
        <td>${real.inicio || ''}</td>
        <td>${real.fim || ''}</td>
        <td>${real.duracao || ''}</td>
        <td>${real.percentual != null ? real.percentual + '%' : '0%'}</td>
        <td>${labelDias}</td>
        <td>
          <span class="acao-link" data-acao="editar" data-id="${id}">Editar (${modoAtual})</span> |
          <span class="acao-link" data-acao="excluir" data-id="${id}">Excluir (${modoAtual})</span>
        </td>
      `;
      tbodyAtividades.appendChild(tr);
    });

    qtdAtividadesSpan.textContent = idsOrdenados.length;
    atualizarGantt(idsOrdenados);
  }

  tbodyAtividades.addEventListener('click', (e) => {
    const alvo = e.target;
    if(!alvo.classList.contains('acao-link')) return;
    const acao = alvo.dataset.acao;
    const id = alvo.dataset.id;
    if(acao === 'editar'){
      editarAtividade(id);
    } else if(acao === 'excluir'){
      excluirAtividade(id);
    }
  });

  function editarAtividade(id){
    const base = baselineAtividades.find(a => String(a.id) === String(id)) || null;
    let alvo = null;
    if(modoAtual === 'planejado'){
      alvo = base;
    } else {
      const real = realAtividades.find(a => String(a.id) === String(id)) || null;
      if(real){
        alvo = real;
      } else if(base){
        // criar clone no real, se ainda não existir
        const clone = {
          id: base.id,
          atividade: base.atividade,
          responsavel: base.responsavel,
          predecessora: base.predecessora,
          inicio: base.inicio,
          fim: base.fim,
          duracao: base.duracao,
          dias_comerciais: base.dias_comerciais,
          percentual: 0
        };
        realAtividades.push(clone);
        alvo = clone;
      }
    }
    if(!alvo) return;
    campoIdEdicao.value = alvo.id;
    campoAtividade.value = alvo.atividade || '';
    campoResponsavel.value = alvo.responsavel || '';
    campoPredecessora.value = alvo.predecessora || '';
    campoDataInicio.value = alvo.inicio || '';
    campoDuracao.value = alvo.duracao || 1;
    campoTipoDias.value = alvo.dias_comerciais ? 'uteis' : 'corridos';
    campoPercentualReal.value = String(alvo.percentual || 0);
  }

  function excluirAtividade(id){
    if(!confirm('Deseja excluir esta atividade no modo atual ('+modoAtual+')?')) return;
    if(modoAtual === 'planejado'){
      baselineAtividades = baselineAtividades.filter(a => String(a.id) !== String(id));
    } else {
      realAtividades = realAtividades.filter(a => String(a.id) !== String(id));
    }
    limparFormularioAtividade();
    recalcularTudo();
  }

  function atualizarGantt(idsOrdenados){
    ganttContainer.innerHTML = '';
    if(idsOrdenados.length === 0) return;

    let maxDur = 0;
    idsOrdenados.forEach(id => {
      const base = baselineAtividades.find(a => String(a.id) === String(id)) || {};
      const real = realAtividades.find(a => String(a.id) === String(id)) || {};
      const dBase = parseInt(base.duracao || '0',10);
      const dReal = parseInt(real.duracao || '0',10);
      const dMax = Math.max(dBase, dReal);
      if(dMax > maxDur) maxDur = dMax;
    });
    if(maxDur === 0) maxDur = 1;

    idsOrdenados.forEach(id => {
      const base = baselineAtividades.find(a => String(a.id) === String(id)) || {};
      const real = realAtividades.find(a => String(a.id) === String(id)) || {};
      const nome = base.atividade || real.atividade || ('Atividade ' + id);

      const dBase = parseInt(base.duracao || '0',10);
      const dReal = parseInt(real.duracao || '0',10);
      const percReal = parseInt(real.percentual || '0',10);

      const widthBase = (dBase > 0 ? (dBase / maxDur)*100 : 0);
      const baseRealDur = (dReal > 0 ? (dReal / maxDur)*100 : (dBase / maxDur)*100);
      const widthReal = baseRealDur * (percReal/100);

      const item = document.createElement('div');
      item.className = 'gantt-item';

      const label = document.createElement('div');
      label.className = 'gantt-label';
      label.textContent = id + ' - ' + nome;
      item.appendChild(label);

      const bars = document.createElement('div');
      bars.className = 'gantt-bars';

      const barPlan = document.createElement('div');
      barPlan.className = 'gantt-bar gantt-plan';
      barPlan.style.width = Math.max(2,widthBase) + '%';

      const barReal = document.createElement('div');
      barReal.className = 'gantt-bar gantt-real';
      barReal.style.width = Math.max(2,widthReal) + '%';

      bars.appendChild(barPlan);
      bars.appendChild(barReal);
      item.appendChild(bars);
      ganttContainer.appendChild(item);
    });
  }

  // Salvar linha de base
  btnSalvarBaseline.addEventListener('click', async () => {
    if(!obraSelecionada){
      alert('Selecione uma obra.');
      return;
    }
    if(!baselineAtividades.length){
      alert('Nenhuma atividade no planejado para salvar como baseline.');
      return;
    }
    const payload = {
      arquivo: obraSelecionada.arquivo,
      id: obraSelecionada.id,
      obra: obraSelecionada.obra,
      coordenador: coordSelect.value || '',
      atividades: baselineAtividades
    };
    try{
      const resp = await fetch(API_BASE + '/salvar_baseline.php', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      const json = await resp.json();
      if(json && json.success){
        alert('Linha de base salva com sucesso (versão '+json.versao+').');
        await carregarCronogramaDaObra(); // recarrega para atualizar baselineVersoes
      } else {
        alert('Erro ao salvar baseline: ' + (json.message || 'Desconhecido.'));
      }
    } catch(e){
      console.error(e);
      alert('Erro técnico ao salvar linha de base.');
    }
  });

  // Salvar andamento real
  btnSalvarReal.addEventListener('click', async () => {
    if(!obraSelecionada){
      alert('Selecione uma obra.');
      return;
    }
    const payload = {
      arquivo: obraSelecionada.arquivo,
      id: obraSelecionada.id,
      obra: obraSelecionada.obra,
      coordenador: coordSelect.value || '',
      atividades: realAtividades
    };
    try{
      const resp = await fetch(API_BASE + '/salvar_real.php', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      const json = await resp.json();
      if(json && json.success){
        alert('Andamento real salvo com sucesso.');
      } else {
        alert('Erro ao salvar andamento real: ' + (json.message || 'Desconhecido.'));
      }
    } catch(e){
      console.error(e);
      alert('Erro técnico ao salvar andamento real.');
    }
  });

  // Exportar JSON (download para debug/auditoria)
  btnExportarJSON.addEventListener('click', () => {
    if(!obraSelecionada){
      alert('Selecione uma obra antes de exportar.');
      return;
    }
    const objeto = {
      id: obraSelecionada.id,
      obra: obraSelecionada.obra,
      arquivo: obraSelecionada.arquivo,
      coordenador: coordSelect.value || '',
      baseline: { versoes: baselineVersoes.length ? baselineVersoes : (baselineAtividades.length ? [{
        id:'v1_local',
        data_criacao: new Date().toISOString(),
        atividades: baselineAtividades
      }] : []) },
      real: { atividades: realAtividades }
    };
    const conteudo = JSON.stringify(objeto,null,2);
    const blob = new Blob([conteudo], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = obraSelecionada.arquivo.replace('.json','_export.json');
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // Inicialização
  carregarListasIniciais();
</script>

</body>
</html>
