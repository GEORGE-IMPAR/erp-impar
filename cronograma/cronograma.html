<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>ERP √çMPAR ‚Äì Cronograma de Obras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#020617;
      --card:#020617;
      --border:#1f2937;
      --text:#e5e7eb;
      --text-soft:#9ca3af;
      --blue:#3b82f6;
      --blue-dark:#1d4ed8;
      --green:#22c55e;
      --yellow:#eab308;
      --red:#ef4444;
      --accent:#cc6e00;
    }
    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(circle at top left,#1d4ed8 0,transparent 55%),
        radial-gradient(circle at bottom right,#f97316 0,transparent 55%),
        linear-gradient(120deg,#020617,#020617 60%,#030712);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      padding:10px 16px 4px;
      display:flex;
      justify-content:center;
    }
    .header-inner{
      width:100%;
      max-width:1200px;
      display:flex;
      justify-content:space-between;
      gap:16px;
      align-items:flex-start;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      text-shadow:0 2px 6px rgba(0,0,0,.8);
    }
    .brand span:nth-child(1){
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.22em;
      opacity:.9;
    }
    .brand span:nth-child(2){
      font-size:20px;
      font-weight:800;
    }
    .brand span:nth-child(3){
      font-size:11px;
      opacity:.9;
    }
    .tag-top{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.7);
      color:var(--text-soft);
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:12px;
    }
    .pill-btn{
      border-radius:999px;
      border:1px solid #4b5563;
      background:#020617;
      padding:5px 10px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--text-soft);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .pill-btn span.icn{font-size:12px;}
    .pill-btn:hover{
      border-color:#9ca3af;
      color:#e5e7eb;
    }

    main{
      flex:1 0 auto;
      display:flex;
      justify-content:center;
      padding:6px 12px 16px;
    }
    .layout{
      width:100%;
      max-width:1200px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .container {
      background:rgba(15,23,42,.96);
      border-radius:18px;
      border:1px solid rgba(55,65,81,.9);
      box-shadow:0 18px 40px rgba(0,0,0,.75);
      padding:16px 18px 18px;
    }

    h1 {
      margin-top:0;
      color:#ffffff;
      font-size:18px;
      margin-bottom:6px;
    }

    .subtitulo{
      font-size:12px;
      color:var(--text-soft);
      margin-bottom:10px;
    }

    .form-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:10px;
    }
    .form-row > div {
      flex:1;
      min-width:150px;
    }

    label {
      display:block;
      font-size:12px;
      margin-bottom:3px;
      color:#cfd8ff;
    }

    input, select {
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #293552;
      background:#020617;
      color:#f5f5f5;
      font-size:13px;
    }
    input[type="date"]{color-scheme:dark;}
    input[type="number"]{-moz-appearance:textfield;}
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{
      -webkit-appearance:none;margin:0;
    }

    button {
      border:none;
      border-radius:999px;
      padding:7px 12px;
      font-size:12px;
      cursor:pointer;
      margin-right:6px;
      margin-bottom:6px;
    }
    .btn-primary {
      background:linear-gradient(135deg,#2563eb,#22c55e);
      color:#fff;
      box-shadow:0 10px 24px rgba(0,0,0,.7);
      text-transform:uppercase;
      letter-spacing:.12em;
      font-weight:600;
    }
    .btn-secondary {
      background:#111827;
      color:#fff;
      border:1px solid #374151;
    }
    .btn-danger {
      background:#b00020;
      color:#fff;
    }

    .actions {
      margin-top:4px;
      margin-bottom:10px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .header-info {
      margin-bottom:4px;
      font-size:12px;
      color:#cfd8ff;
    }
    .header-info strong {
      font-weight:600;
    }
    .badge-base {
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:#182648;
      margin-left:6px;
    }

    .table-wrapper {
      overflow-x:auto;
      border-radius:12px;
      border:1px solid #111827;
      margin-top:6px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      background:#020617;
      min-width:820px;
    }
    th, td {
      padding:5px 6px;
      border-bottom:1px solid #1f2937;
      text-align:left;
    }
    th {
      background:#020617;
      position:sticky;
      top:0;
      z-index:1;
      font-weight:600;
    }
    tbody tr:hover {
      background:#111827;
    }

    .tag-dia {
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:#182648;
    }

    .gantt-container {
      margin-top:14px;
      background:#020617;
      border-radius:14px;
      padding:10px;
      border:1px solid #1f2937;
    }
    .gantt-header {
      font-size:12px;
      margin-bottom:6px;
      color:#cfd8ff;
    }
    .gantt-grid {
      display:grid;
      grid-auto-rows:30px;
      row-gap:6px;
      position:relative;
      font-size:10px;
    }
    .gantt-row-label {
      position:sticky;
      left:0;
      padding-right:6px;
      background:#020617;
      z-index:2;
      white-space:nowrap;
    }
    .gantt-row {
      display:grid;
      column-gap:2px;
      align-items:center;
    }
    .gantt-bar-base {
      height:10px;
      border-radius:999px;
      background:#4fc3f7;
      opacity:.8;
      margin-bottom:2px;
    }
    .gantt-bar-real {
      height:12px;
      border-radius:999px;
      background:#cc6e00;
      box-shadow:0 0 6px rgba(204,110,0,.6);
    }
    .gantt-day-labels {
      display:grid;
      column-gap:2px;
      font-size:9px;
      color:#9fa8da;
      margin-left:110px;
      margin-bottom:4px;
    }

    .footer-crono {
      margin-top:12px;
      font-size:10px;
      color:#9fa8da;
      text-align:right;
    }
    .footer-crono span {
      opacity:.7;
    }

    .no-data {
      font-size:11px;
      color:#9fa8da;
      margin-top:6px;
      font-style:italic;
    }

    .row-editing {
      outline:1px solid var(--accent);
      background:#1d2340 !important;
    }

    .status-nao-iniciado {color:#9fa8da;}
    .status-em-andamento {color:#ffd54f;}
    .status-atrasado {color:#ff8a80;font-weight:bold;}
    .status-concluido {color:#80e27e;font-weight:bold;}

    .check-inline {
      display:flex;
      align-items:center;
      gap:4px;
      margin-top:4px;
      font-size:11px;
      color:#cfd8ff;
    }
    .check-inline input[type="checkbox"]{width:auto;}

    footer{
      background:#020617;
      color:#9ca3af;
      padding:6px 16px;
      font-size:10px;
    }
    .rodape-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    @media(max-width:900px){
      .container{padding:14px 12px 16px;}
      h1{font-size:16px;}
    }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <span>PLATAFORMA</span>
      <span>ERP √çMPAR ‚Ä¢ Cronograma de Obras</span>
      <span>Planejamento detalhado com baseline x real</span>
    </div>
    <div class="tag-top">
      <button class="pill-btn" type="button" id="btnVoltarFarol">
        <span class="icn">‚Üê</span> Farol de obras
      </button>
      <button class="pill-btn" type="button" id="btnVoltarMenu">
        <span class="icn">üè†</span> Menu principal
      </button>
    </div>
  </div>
</header>

<main>
  <div class="layout">
    <div class="container">
      <h1>Cronograma de Atividades - √çMPAR</h1>
      <div class="subtitulo">
        Cadastre as atividades da obra, defina predecessoras, salve a linha de base e acompanhe o avan√ßo real
        integrado ao Farol de Obras.
      </div>

      <!-- Campos de contexto (Obra / Coordenador) -->
      <div class="form-row">
        <div>
          <label for="obra">Obra</label>
          <!-- dropdown populado via API -->
          <select id="obra">
            <option value="">Selecione a obra</option>
          </select>
        </div>
        <div>
          <label for="coordenador">Coordenador</label>
          <!-- dropdown populado via API -->
          <select id="coordenador">
            <option value="">Selecione o coordenador</option>
          </select>
        </div>
      </div>

      <!-- Formul√°rio principal -->
      <div class="form-row">
        <div>
          <label for="atividade">Atividade</label>
          <input type="text" id="atividade" placeholder="Ex.: Montagem de estrutura">
        </div>
        <div>
          <label for="responsavel">Respons√°vel</label>
          <!-- dropdown populado via API -->
          <select id="responsavel">
            <option value="">Selecione o respons√°vel</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="inicio">Data de in√≠cio</label>
          <input type="date" id="inicio">
        </div>
        <div>
          <label for="fim">Data de t√©rmino</label>
          <input type="date" id="fim">
        </div>
        <div>
          <label for="duracao">Dura√ß√£o (dias)</label>
          <input type="number" id="duracao" min="1" placeholder="Ex.: 5">
        </div>
        <div>
          <label for="predecessora">Predecessora</label>
          <select id="predecessora">
            <option value="">Nenhuma</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="check-inline">
            <input type="checkbox" id="diasComerciais">
            <span>Dias comerciais (seg‚Äìsex)</span>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="btn-add" class="btn-primary" onclick="adicionarAtividade()">Adicionar atividade</button>
        <button id="btn-save" class="btn-primary" style="display:none" onclick="salvarEdicao()">Salvar altera√ß√£o</button>
        <button id="btn-cancel" class="btn-secondary" style="display:none" onclick="cancelarEdicao()">Cancelar edi√ß√£o</button>

        <button class="btn-secondary" onclick="recalcularCronograma()">Recalcular (efeito domin√≥)</button>
        <button class="btn-secondary" onclick="salvarLinhaBase()">Concluir planejamento (salvar linha de base)</button>

        <button class="btn-secondary" onclick="salvarNoServidor()">Salvar no servidor</button>
        <button class="btn-secondary" onclick="carregarDoServidor()">Carregar do servidor</button>

        <button class="btn-secondary" onclick="limparFormulario()">Limpar campos</button>
        <button class="btn-secondary" onclick="exportarJSON()">Exportar JSON</button>
      </div>

      <!-- Info obra -->
      <div class="header-info" id="header-info"></div>
      <div class="header-info" id="resumo-obra"></div>

      <div class="table-wrapper">
        <table id="tabela-atividades">
          <thead>
            <tr>
              <th>#</th>
              <th>Atividade</th>
              <th>Respons√°vel</th>
              <th>In√≠cio</th>
              <th>Fim</th>
              <th>Dura√ß√£o</th>
              <th>Modo</th>
              <th>% Plan.</th>
              <th>% Real</th>
              <th>Status</th>
              <th>Predecessora</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            <!-- linhas via JS -->
          </tbody>
        </table>
      </div>

      <div id="no-data-msg" class="no-data">
        Nenhuma atividade cadastrada ainda.
      </div>

      <!-- Mini-Gantt -->
      <div class="gantt-container">
        <div class="gantt-header">
          Vis√£o geral (dias) ‚Äì barras da linha de base (azul) e real (laranja)
          <span id="badge-base" class="badge-base" style="display:none;">Linha de base salva</span>
        </div>
        <div id="gantt-day-labels" class="gantt-day-labels"></div>
        <div id="gantt-grid" class="gantt-grid"></div>
      </div>

      <div class="footer-crono">
        <span>ERP √çMPAR ‚Ä¢ M√≥dulo Cronograma ‚Ä¢ v2.3 (baseline x real, % obra, dura√ß√£o, dias √∫teis, Gantt duplo)</span>
      </div>
    </div>
  </div>
</main>

<footer>
  <div class="rodape-inner">
    <span>¬© 2025 ERP √çMPAR ‚Ä¢ M√≥dulo Cronograma de Obras</span>
    <span>Integra√ß√£o total com Farol de Obras (baseline x real)</span>
  </div>
</footer>

<script>
  // ================== CONFIG API (mesmo padr√£o do farol) ==================
  const API_BASE = "https://api.erpimpar.com.br/cronograma";
  const API_SAVE_URL = API_BASE + "/salvar_cronograma.php";
  const API_LOAD_URL = API_BASE + "/carregar_cronograma.php";
  const API_LIST_OBRAS = API_BASE + "/listar_obras.php";
  const API_LIST_COORDENADORES = API_BASE + "/listar_coordenadores.php";
  const API_LIST_RESPONSAVEIS = API_BASE + "/listar_responsaveis.php";

  let atividades = [];
  let nextId = 1;
  let editingIndex = null;
  let linhaBaseSalva = false;

  // cache de obras/coordenadores/respons√°veis para mapear id x nome
  let cacheObras = [];
  let cacheCoordenadores = [];
  let cacheResponsaveis = [];

  // -------- navega√ß√£o ----------
  document.getElementById("btnVoltarMenu").addEventListener("click", () => {
    window.location.href = "../index.html";
  });
  document.getElementById("btnVoltarFarol").addEventListener("click", () => {
    window.location.href = "farol.html";
  });

  // ===== Datas =====
  function parseDate(str) {
    if (!str) return null;
    const [y, m, d] = str.split("-").map(Number);
    return new Date(y, m - 1, d);
  }
  function formatDateToInput(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }
  function formatDateBr(date) {
    const d = String(date.getDate()).padStart(2, "0");
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const y = date.getFullYear();
    return `${d}/${m}/${y}`;
  }
  function addDays(date, days) {
    const d = new Date(date.getTime());
    d.setDate(d.getDate() + days);
    return d;
  }
  function diffInDays(inicio, fim) {
    const ms = fim - inicio;
    return Math.round(ms / (1000 * 60 * 60 * 24)) + 1;
  }
  function dataHoje() {
    const agora = new Date();
    return new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
  }

  // ===== Dias comerciais + feriados =====
  const FERIADOS_FIXOS = [
    "01-01","04-21","05-01","09-07","10-12","11-02","11-15","12-25"
  ];
  function isHoliday(date) {
    const md = String(date.getMonth() + 1).padStart(2, "0") + "-" +
               String(date.getDate()).padStart(2, "0");
    return FERIADOS_FIXOS.includes(md);
  }
  function isBusinessDay(date) {
    const day = date.getDay(); // 0 dom, 6 s√°b
    if (day === 0 || day === 6) return false;
    if (isHoliday(date)) return false;
    return true;
  }
  function nextBusinessDay(date) {
    let d = addDays(date, 1);
    while (!isBusinessDay(d)) {
      d = addDays(d, 1);
    }
    return d;
  }
  function addBusinessDaysInclusive(start, duracaoDias) {
    if (duracaoDias <= 1) {
      let s = new Date(start.getTime());
      if (!isBusinessDay(s)) s = nextBusinessDay(s);
      return s;
    }
    let current = new Date(start.getTime());
    if (!isBusinessDay(current)) current = nextBusinessDay(current);
    let count = 1;
    while (count < duracaoDias) {
      current = addDays(current, 1);
      if (isBusinessDay(current)) {
        count++;
      }
    }
    return current;
  }
  function diffBusinessDaysInclusive(start, end) {
    if (end < start) return 0;
    let count = 0;
    let current = new Date(start.getTime());
    while (current <= end) {
      if (isBusinessDay(current)) count++;
      current = addDays(current, 1);
    }
    return count;
  }
  function calcularFim(inicio, duracaoDias, diasComerciais) {
    if (diasComerciais) {
      return addBusinessDaysInclusive(inicio, duracaoDias);
    } else {
      return addDays(inicio, duracaoDias - 1);
    }
  }
  function calcularDuracao(inicio, fim, diasComerciais) {
    if (diasComerciais) {
      return diffBusinessDaysInclusive(inicio, fim);
    } else {
      return diffInDays(inicio, fim);
    }
  }

  // ===== UI b√°sica =====
  function toggleModoEdicao(ativo) {
    const btnAdd = document.getElementById("btn-add");
    const btnSave = document.getElementById("btn-save");
    const btnCancel = document.getElementById("btn-cancel");
    if (ativo) {
      btnAdd.style.display = "none";
      btnSave.style.display = "inline-block";
      btnCancel.style.display = "inline-block";
    } else {
      btnAdd.style.display = "inline-block";
      btnSave.style.display = "none";
      btnCancel.style.display = "none";
    }
  }

  function getObraSelecionadaNome() {
    return document.getElementById("obra").value.trim();
  }
  function getObraSelecionadaId() {
    const sel = document.getElementById("obra");
    const opt = sel.options[sel.selectedIndex];
    return opt ? opt.getAttribute("data-id") : null;
  }

  function atualizarHeaderInfo() {
    const obraNome = getObraSelecionadaNome();
    const coord = document.getElementById("coordenador").value.trim();
    const info = document.getElementById("header-info");
    let partes = [];
    if (obraNome) partes.push(`Obra: <strong>${obraNome}</strong>`);
    if (coord) partes.push(`Coordenador: <strong>${coord}</strong>`);
    info.innerHTML = partes.length ? partes.join(" ‚Ä¢ ") : "";
  }

  function atualizarResumoObra() {
    const resumo = document.getElementById("resumo-obra");
    if (atividades.length === 0) {
      resumo.innerHTML = "";
      return;
    }
    let baselineInicio = null;
    let baselineFim = null;
    let realInicio = null;
    let realFim = null;

    let totalPlanPeso = 0;
    let somaPlan = 0;
    let totalRealPeso = 0;
    let somaReal = 0;

    atividades.forEach(a => {
      if (a.baselineInicio && a.baselineFim) {
        if (!baselineInicio || a.baselineInicio < baselineInicio) baselineInicio = a.baselineInicio;
        if (!baselineFim || a.baselineFim > baselineFim) baselineFim = a.baselineFim;
      }
      if (!realInicio || a.inicio < realInicio) realInicio = a.inicio;
      if (!realFim || a.fim > realFim) realFim = a.fim;

      const pesoPlan = a.baselineDuracaoDias || a.duracaoDias || 0;
      const pesoReal = a.duracaoDias || 0;
      const pr = a.plannedPercent || 0;
      const rr = a.realPercent || 0;

      if (pesoPlan > 0) {
        somaPlan += pr * pesoPlan;
        totalPlanPeso += pesoPlan;
      }
      if (pesoReal > 0) {
        somaReal += rr * pesoReal;
        totalRealPeso += pesoReal;
      }
    });

    const percPlan = totalPlanPeso ? Math.round(somaPlan / totalPlanPeso) : 0;
    const percReal = totalRealPeso ? Math.round(somaReal / totalRealPeso) : 0;

    let statusObra = "N√£o iniciado";
    let statusClasse = "status-nao-iniciado";

    if (percReal >= 100 && percPlan >= 100) {
      statusObra = "Conclu√≠do";
      statusClasse = "status-concluido";
    } else if (percReal < percPlan) {
      if (percReal === 0 && percPlan === 0) {
        statusObra = "N√£o iniciado";
        statusClasse = "status-nao-iniciado";
      } else {
        statusObra = "Atrasado";
        statusClasse = "status-atrasado";
      }
    } else if (percReal === 0 && percPlan === 0) {
      statusObra = "N√£o iniciado";
      statusClasse = "status-nao-iniciado";
    } else {
      statusObra = "Em andamento";
      statusClasse = "status-em-andamento";
    }

    let parteDatas = [];
    if (baselineInicio && baselineFim) {
      parteDatas.push(
        `Baseline: <strong>${formatDateBr(baselineInicio)}</strong> ‚Üí <strong>${formatDateBr(baselineFim)}</strong>`
      );
    }
    if (realInicio && realFim) {
      parteDatas.push(
        `Atual: <strong>${formatDateBr(realInicio)}</strong> ‚Üí <strong>${formatDateBr(realFim)}</strong>`
      );
    }

    resumo.innerHTML =
      (parteDatas.length ? parteDatas.join(" ‚Ä¢ ") + " ‚Ä¢ " : "") +
      `Planejado: <strong>${percPlan}%</strong> ‚Ä¢ Real: <strong>${percReal}%</strong> ‚Ä¢ ` +
      `Situa√ß√£o: <strong class="${statusClasse}">${statusObra}</strong>`;
  }

  function atualizarListaPredecessoras() {
    const select = document.getElementById("predecessora");
    const valorAtual = select.value;
    select.innerHTML = "";
    const optNenhuma = document.createElement("option");
    optNenhuma.value = "";
    optNenhuma.textContent = "Nenhuma";
    select.appendChild(optNenhuma);
    atividades.forEach((a, i) => {
      const opt = document.createElement("option");
      opt.value = a.id;
      opt.textContent = `${i + 1} - ${a.atividade}`;
      select.appendChild(opt);
    });
    if (valorAtual && [...select.options].some(o => o.value === valorAtual)) {
      select.value = valorAtual;
    } else {
      select.value = "";
    }
  }

  function onPredecessoraChange() {
    const select = document.getElementById("predecessora");
    const id = select.value;
    const inputInicio = document.getElementById("inicio");
    const diasComerciais = document.getElementById("diasComerciais").checked;

    if (!id) {
      inputInicio.min = "";
      return;
    }
    const pred = atividades.find(a => a.id === Number(id));
    if (!pred) return;

    let newStart = diasComerciais ? nextBusinessDay(pred.fim) : addDays(pred.fim, 1);
    const startStr = formatDateToInput(newStart);
    inputInicio.value = startStr;
    inputInicio.min = startStr;

    const durStr = document.getElementById("duracao").value;
    const dur = Number(durStr);
    if (dur > 0) {
      const end = calcularFim(newStart, dur, diasComerciais);
      document.getElementById("fim").value = formatDateToInput(end);
    }
  }

  function onInicioChange() {
    const inicioStr = document.getElementById("inicio").value;
    const durStr = document.getElementById("duracao").value;
    const diasComerciais = document.getElementById("diasComerciais").checked;

    if (!inicioStr) return;
    const inicio = parseDate(inicioStr);
    const dur = Number(durStr);
    if (dur > 0) {
      const fim = calcularFim(inicio, dur, diasComerciais);
      document.getElementById("fim").value = formatDateToInput(fim);
    } else {
      const fimStr = document.getElementById("fim").value;
      if (fimStr) {
        const fim = parseDate(fimStr);
        const durCalc = calcularDuracao(inicio, fim, diasComerciais);
        document.getElementById("duracao").value = durCalc > 0 ? durCalc : "";
      }
    }
  }

  function onFimChange() {
    const inicioStr = document.getElementById("inicio").value;
    const fimStr = document.getElementById("fim").value;
    const diasComerciais = document.getElementById("diasComerciais").checked;
    if (!inicioStr || !fimStr) return;
    const inicio = parseDate(inicioStr);
    const fim = parseDate(fimStr);
    if (fim < inicio) {
      alert("A data de t√©rmino n√£o pode ser menor que a data de in√≠cio.");
      document.getElementById("fim").value = "";
      return;
    }
    const dur = calcularDuracao(inicio, fim, diasComerciais);
    document.getElementById("duracao").value = dur > 0 ? dur : "";
  }

  function onDuracaoChange() {
    const inicioStr = document.getElementById("inicio").value;
    const diasComerciais = document.getElementById("diasComerciais").checked;
    const durStr = document.getElementById("duracao").value;
    const dur = Number(durStr);
    if (!inicioStr || dur <= 0) return;
    const inicio = parseDate(inicioStr);
    const fim = calcularFim(inicio, dur, diasComerciais);
    document.getElementById("fim").value = formatDateToInput(fim);
  }

  // ===== % planejado / status =====
  function arredondarPercentual(p) {
    const steps = [0, 25, 50, 75, 100];
    let melhor = steps[0];
    let menorDiff = Math.abs(p - steps[0]);
    for (const s of steps) {
      const diff = Math.abs(p - s);
      if (diff < menorDiff) {
        menorDiff = diff;
        melhor = s;
      }
    }
    return melhor;
  }

  function calcularPlanejadoEStatus() {
    const hoje = dataHoje();
    atividades.forEach(a => {
      if (!linhaBaseSalva || !a.baselineInicio || !a.baselineFim) {
        a.plannedPercent = 0;
      } else {
        const inicioBase = a.baselineInicio;
        const fimBase = a.baselineFim;
        if (hoje <= inicioBase) {
          a.plannedPercent = 0;
        } else if (hoje >= fimBase) {
          a.plannedPercent = 100;
        } else {
          const totalMs = fimBase - inicioBase;
          const elapsedMs = hoje - inicioBase;
          let perc = (elapsedMs / totalMs) * 100;
          if (isNaN(perc)) perc = 0;
          perc = Math.min(100, Math.max(0, perc));
          a.plannedPercent = arredondarPercentual(perc);
        }
      }
      if (typeof a.realPercent !== "number") a.realPercent = 0;
      const pr = a.plannedPercent;
      const rr = a.realPercent;
      if (rr === 0 && pr === 0) {
        a.status = "N√£o iniciado";
        a.statusClass = "status-nao-iniciado";
      } else if (rr >= 100 && pr >= 100) {
        a.status = "Conclu√≠do";
        a.statusClass = "status-concluido";
      } else if (rr < pr) {
        a.status = "Atrasado";
        a.statusClass = "status-atrasado";
      } else {
        a.status = "Em andamento";
        a.statusClass = "status-em-andamento";
      }
    });
    atualizarResumoObra();
  }

  function salvarLinhaBase() {
    if (atividades.length === 0) {
      alert("Cadastre pelo menos uma atividade antes de salvar a linha de base.");
      return;
    }
    atividades.forEach(a => {
      a.baselineInicio = new Date(a.inicio.getTime());
      a.baselineFim = new Date(a.fim.getTime());
      a.baselineDuracaoDias = a.duracaoDias;
      a.baselineInicioStr = a.inicioStr;
      a.baselineFimStr = a.fimStr;
    });
    linhaBaseSalva = true;
    document.getElementById("badge-base").style.display = "inline-block";
    calcularPlanejadoEStatus();
    renderTabela();
    renderGantt();
    alert("Linha de base salva. O % planejado agora √© calculado automaticamente pela data de hoje.");
  }

  // ===== CRUD local =====
  function adicionarAtividade() {
    if (editingIndex !== null) {
      alert("Voc√™ est√° editando uma atividade. Salve ou cancele a edi√ß√£o antes de adicionar uma nova.");
      return;
    }
    const obraNome = getObraSelecionadaNome();
    const coordenador = document.getElementById("coordenador").value.trim();
    const atividade = document.getElementById("atividade").value.trim();
    const responsavel = document.getElementById("responsavel").value.trim();
    let inicioStr = document.getElementById("inicio").value;
    let fimStr = document.getElementById("fim").value;
    let durStr = document.getElementById("duracao").value;
    const predecessoraStr = document.getElementById("predecessora").value;
    const diasComerciais = document.getElementById("diasComerciais").checked;

    if (!obraNome) {
      alert("Selecione a Obra.");
      return;
    }
    if (!coordenador) {
      alert("Selecione o Coordenador.");
      return;
    }
    if (!atividade) {
      alert("Preencha o campo Atividade.");
      return;
    }

    let predecessorId = null;
    let inicio = null;
    let fim = null;
    let duracaoDias = 0;

    if (predecessoraStr) {
      predecessorId = Number(predecessoraStr);
      const pred = atividades.find(a => a.id === predecessorId);
      if (pred) {
        inicio = diasComerciais ? nextBusinessDay(pred.fim) : addDays(pred.fim, 1);
        inicioStr = formatDateToInput(inicio);
        document.getElementById("inicio").value = inicioStr;
      }
    }

    const temDur = durStr !== "" && !isNaN(Number(durStr)) && Number(durStr) > 0;
    const temInicio = !!inicioStr;
    const temFim = !!fimStr;

    if (!temInicio && !predecessoraStr) {
      alert("Informe a data de in√≠cio ou selecione uma predecessora.");
      return;
    }
    if (!inicio) inicio = parseDate(inicioStr);

    if (temDur && !temFim) {
      duracaoDias = Number(durStr);
      fim = calcularFim(inicio, duracaoDias, diasComerciais);
      fimStr = formatDateToInput(fim);
      document.getElementById("fim").value = fimStr;
    } else if (!temDur && temFim) {
      fim = parseDate(fimStr);
      if (fim < inicio) {
        alert("A data de t√©rmino n√£o pode ser menor que a data de in√≠cio.");
        return;
      }
      duracaoDias = calcularDuracao(inicio, fim, diasComerciais);
      if (duracaoDias <= 0) {
        alert("N√£o foi poss√≠vel calcular a dura√ß√£o. Verifique as datas.");
        return;
      }
      document.getElementById("duracao").value = duracaoDias;
    } else if (temDur && temFim) {
      fim = parseDate(fimStr);
      if (fim < inicio) {
        alert("A data de t√©rmino n√£o pode ser menor que a data de in√≠cio.");
        return;
      }
      duracaoDias = Number(durStr);
    } else {
      alert("Informe dura√ß√£o e/ou data de t√©rmino.");
      return;
    }

    atividades.push({
      id: nextId++,
      obra: obraNome,
      obraId: getObraSelecionadaId(),
      coordenador,
      atividade,
      responsavel,
      inicioStr,
      fimStr,
      inicio,
      fim,
      duracaoDias,
      predecessorId,
      diasComerciais,
      realPercent: 0,
      plannedPercent: 0,
      status: "N√£o iniciado",
      statusClass: "status-nao-iniciado",
      baselineInicio: null,
      baselineFim: null,
      baselineDuracaoDias: null,
      baselineInicioStr: null,
      baselineFimStr: null
    });

    atualizarHeaderInfo();
    calcularPlanejadoEStatus();
    renderTabela();
    renderGantt();
    atualizarListaPredecessoras();
    limparFormulario();
  }

  function limparFormulario() {
    document.getElementById("atividade").value = "";
    document.getElementById("responsavel").value = "";
    document.getElementById("inicio").value = "";
    document.getElementById("fim").value = "";
    document.getElementById("duracao").value = "";
    document.getElementById("inicio").min = "";
    document.getElementById("predecessora").value = "";
    document.getElementById("diasComerciais").checked = false;
    limparDestaqueEdicao();
  }

  function limparDestaqueEdicao() {
    const linhas = document.querySelectorAll("#tabela-atividades tbody tr");
    linhas.forEach(l => l.classList.remove("row-editing"));
  }

  function iniciarEdicao(index) {
    editingIndex = index;
    toggleModoEdicao(true);
    limparDestaqueEdicao();
    const item = atividades[index];

    // obra / coordenador permanecem selecionados no topo
    const obraSelect = document.getElementById("obra");
    if (item.obraId) {
      for (let i=0;i<obraSelect.options.length;i++){
        if (obraSelect.options[i].getAttribute("data-id") == item.obraId){
          obraSelect.selectedIndex = i;
          break;
        }
      }
    } else if (item.obra) {
      obraSelect.value = item.obra;
    }

    document.getElementById("coordenador").value = item.coordenador || "";
    document.getElementById("atividade").value = item.atividade;
    document.getElementById("responsavel").value = item.responsavel || "";
    document.getElementById("inicio").value = item.inicioStr;
    document.getElementById("fim").value = item.fimStr;
    document.getElementById("duracao").value = item.duracaoDias || "";
    document.getElementById("diasComerciais").checked = !!item.diasComerciais;

    atualizarHeaderInfo();
    atualizarListaPredecessoras();
    const selectPred = document.getElementById("predecessora");
    selectPred.value = item.predecessorId ? String(item.predecessorId) : "";

    const tbody = document.querySelector("#tabela-atividades tbody");
    const linha = tbody.querySelectorAll("tr")[index];
    if (linha) linha.classList.add("row-editing");
  }

  function cancelarEdicao() {
    editingIndex = null;
    toggleModoEdicao(false);
    limparFormulario();
  }

  function salvarEdicao() {
    if (editingIndex === null) return;

    const obraNome = getObraSelecionadaNome();
    const coordenador = document.getElementById("coordenador").value.trim();
    const atividade = document.getElementById("atividade").value.trim();
    const responsavel = document.getElementById("responsavel").value.trim();
    let inicioStr = document.getElementById("inicio").value;
    let fimStr = document.getElementById("fim").value;
    let durStr = document.getElementById("duracao").value;
    const predecessoraStr = document.getElementById("predecessora").value;
    const diasComerciais = document.getElementById("diasComerciais").checked;

    if (!obraNome || !coordenador) {
      alert("Selecione Obra e Coordenador.");
      return;
    }
    if (!atividade) {
      alert("Preencha a Atividade.");
      return;
    }

    const itemOriginal = atividades[editingIndex];
    let predecessorId = null;
    let inicio = null;
    let fim = null;
    let duracaoDias = 0;

    if (predecessoraStr) {
      predecessorId = Number(predecessoraStr);
      if (predecessorId === itemOriginal.id) {
        alert("Uma atividade n√£o pode ser predecessora dela mesma.");
        return;
      }
      const pred = atividades.find(a => a.id === predecessorId);
      if (pred) {
        inicio = diasComerciais ? nextBusinessDay(pred.fim) : addDays(pred.fim, 1);
        inicioStr = formatDateToInput(inicio);
        document.getElementById("inicio").value = inicioStr;
      }
    }

    const temDur = durStr !== "" && !isNaN(Number(durStr)) && Number(durStr) > 0;
    const temInicio = !!inicioStr;
    const temFim = !!fimStr;

    if (!temInicio && !predecessoraStr) {
      alert("Informe a data de in√≠cio ou selecione uma predecessora.");
      return;
    }
    if (!inicio) inicio = parseDate(inicioStr);

    if (temDur && !temFim) {
      duracaoDias = Number(durStr);
      fim = calcularFim(inicio, duracaoDias, diasComerciais);
      fimStr = formatDateToInput(fim);
      document.getElementById("fim").value = fimStr;
    } else if (!temDur && temFim) {
      fim = parseDate(fimStr);
      if (fim < inicio) {
        alert("A data de t√©rmino n√£o pode ser menor que a data de in√≠cio.");
        return;
      }
      duracaoDias = calcularDuracao(inicio, fim, diasComerciais);
      if (duracaoDias <= 0) {
        alert("N√£o foi poss√≠vel calcular a dura√ß√£o. Verifique as datas.");
        return;
      }
      document.getElementById("duracao").value = duracaoDias;
    } else if (temDur && temFim) {
      fim = parseDate(fimStr);
      if (fim < inicio) {
        alert("A data de t√©rmino n√£o pode ser menor que a data de in√≠cio.");
        return;
      }
      duracaoDias = Number(durStr);
    } else {
      alert("Informe dura√ß√£o e/ou data de t√©rmino.");
      return;
    }

    atividades[editingIndex] = {
      ...itemOriginal,
      obra: obraNome,
      obraId: getObraSelecionadaId(),
      coordenador,
      atividade,
      responsavel,
      inicioStr,
      fimStr,
      inicio,
      fim,
      duracaoDias,
      predecessorId,
      diasComerciais
    };

    editingIndex = null;
    toggleModoEdicao(false);
    atualizarHeaderInfo();
    recalcularCronograma();
    limparFormulario();
  }

  function removerAtividade(index) {
    if (!confirm("Remover esta atividade do cronograma?")) return;
    const removida = atividades.splice(index, 1)[0];
    if (removida) {
      atividades.forEach(a => {
        if (a.predecessorId === removida.id) a.predecessorId = null;
      });
    }
    if (editingIndex !== null) {
      if (editingIndex === index) {
        cancelarEdicao();
      } else if (editingIndex > index) {
        editingIndex -= 1;
      }
    }
    calcularPlanejadoEStatus();
    renderTabela();
    renderGantt();
    atualizarListaPredecessoras();
    onPredecessoraChange();
  }

  function alterarReal(index, valor) {
    const perc = Number(valor);
    const a = atividades[index];
    a.realPercent = perc;
    calcularPlanejadoEStatus();
    renderTabela();
  }

  function obterNomePredecessora(item) {
    if (!item.predecessorId) return "-";
    const pred = atividades.find(a => a.id === item.predecessorId);
    return pred ? pred.atividade : "-";
  }

  function renderTabela() {
    const tbody = document.querySelector("#tabela-atividades tbody");
    tbody.innerHTML = "";
    if (atividades.length === 0) {
      document.getElementById("no-data-msg").style.display = "block";
      return;
    } else {
      document.getElementById("no-data-msg").style.display = "none";
    }
    atividades.forEach((item, i) => {
      const tr = document.createElement("tr");
      const duracao = item.duracaoDias || diffInDays(item.inicio, item.fim);
      const nomePredecessora = obterNomePredecessora(item);
      const pr = item.plannedPercent || 0;
      const rr = item.realPercent || 0;
      const modo = item.diasComerciais ? "Comercial" : "Corridos";
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${item.atividade}</td>
        <td>${item.responsavel || "-"}</td>
        <td>${item.inicioStr}</td>
        <td>${item.fimStr}</td>
        <td><span class="tag-dia">${duracao} dia(s)</span></td>
        <td>${modo}</td>
        <td>${pr}%</td>
        <td>
          <select onchange="alterarReal(${i}, this.value)">
            <option value="0" ${rr === 0 ? "selected" : ""}>0%</option>
            <option value="25" ${rr === 25 ? "selected" : ""}>25%</option>
            <option value="50" ${rr === 50 ? "selected" : ""}>50%</option>
            <option value="75" ${rr === 75 ? "selected" : ""}>75%</option>
            <option value="100" ${rr === 100 ? "selected" : ""}>100%</option>
          </select>
        </td>
        <td class="${item.statusClass || ""}">${item.status || "-"}</td>
        <td>${nomePredecessora}</td>
        <td>
          <button class="btn-secondary" onclick="event.stopPropagation(); iniciarEdicao(${i});">Editar</button>
          <button class="btn-danger" onclick="event.stopPropagation(); removerAtividade(${i});">Excluir</button>
        </td>
      `;
      tr.addEventListener("click", () => iniciarEdicao(i));
      if (editingIndex === i) tr.classList.add("row-editing");
      tbody.appendChild(tr);
    });
  }

  function renderGantt() {
    const grid = document.getElementById("gantt-grid");
    const labels = document.getElementById("gantt-day-labels");
    grid.innerHTML = "";
    labels.innerHTML = "";
    if (atividades.length === 0) return;

    let minDate = null;
    let maxDate = null;
    atividades.forEach(a => {
      const candidatosInicio = [];
      const candidatosFim = [];
      if (a.inicio) candidatosInicio.push(a.inicio);
      if (a.fim) candidatosFim.push(a.fim);
      if (a.baselineInicio) candidatosInicio.push(a.baselineInicio);
      if (a.baselineFim) candidatosFim.push(a.baselineFim);
      candidatosInicio.forEach(d => {
        if (!minDate || d < minDate) minDate = d;
      });
      candidatosFim.forEach(d => {
        if (!maxDate || d > maxDate) maxDate = d;
      });
    });
    if (!minDate || !maxDate) return;
    const totalDias = diffInDays(minDate, maxDate);

    labels.style.gridTemplateColumns = `repeat(${totalDias}, 24px)`;
    for (let i = 0; i < totalDias; i++) {
      const span = document.createElement("div");
      span.textContent = "D" + (i + 1);
      labels.appendChild(span);
    }

    atividades.forEach(a => {
      const rowWrapper = document.createElement("div");
      rowWrapper.style.display = "grid";
      rowWrapper.style.gridTemplateColumns = "110px 1fr";
      rowWrapper.style.columnGap = "4px";

      const label = document.createElement("div");
      label.className = "gantt-row-label";
      label.textContent = a.atividade;

      const row = document.createElement("div");
      row.className = "gantt-row";
      row.style.gridTemplateColumns = `repeat(${totalDias}, 24px)`;

      let offsetBase = null;
      let durBase = null;
      if (a.baselineInicio && a.baselineFim) {
        offsetBase = diffInDays(minDate, a.baselineInicio) - 1;
        durBase = a.baselineDuracaoDias || diffInDays(a.baselineInicio, a.baselineFim);
        const barBase = document.createElement("div");
        barBase.className = "gantt-bar-base";
        barBase.style.gridColumn = `${offsetBase + 1} / span ${durBase}`;
        row.appendChild(barBase);
      }

      const rr = a.realPercent || 0;
      if (rr > 0) {
        let offsetReal;
        let totalDiasRef;
        if (a.baselineInicio && a.baselineFim && durBase) {
          offsetReal = offsetBase;
          totalDiasRef = durBase;
        } else if (a.inicio && a.fim) {
          offsetReal = diffInDays(minDate, a.inicio) - 1;
          totalDiasRef = a.duracaoDias || diffInDays(a.inicio, a.fim);
        } else {
          totalDiasRef = 0;
        }
        if (totalDiasRef > 0 && offsetReal != null) {
          let durReal = Math.round(totalDiasRef * rr / 100);
          if (durReal < 1) durReal = 1;
          const barReal = document.createElement("div");
          barReal.className = "gantt-bar-real";
          barReal.style.gridColumn = `${offsetReal + 1} / span ${durReal}`;
          row.appendChild(barReal);
        }
      }

      rowWrapper.appendChild(label);
      rowWrapper.appendChild(row);
      grid.appendChild(rowWrapper);
    });
  }

  function recalcularCronograma() {
    if (atividades.length === 0) {
      alert("N√£o h√° atividades para recalcular.");
      return;
    }
    const maxIter = atividades.length;
    for (let iter = 0; iter < maxIter; iter++) {
      let changed = false;
      atividades.forEach(a => {
        if (!a.predecessorId) return;
        const pred = atividades.find(p => p.id === a.predecessorId);
        if (!pred) {
          a.predecessorId = null;
          return;
        }
        const diasComerciais = !!a.diasComerciais;
        const newStart = diasComerciais ? nextBusinessDay(pred.fim) : addDays(pred.fim, 1);
        const newEnd = calcularFim(newStart, a.duracaoDias, diasComerciais);
        if (a.inicio.getTime() !== newStart.getTime() ||
            a.fim.getTime() !== newEnd.getTime()) {
          a.inicio = newStart;
          a.fim = newEnd;
          a.inicioStr = formatDateToInput(newStart);
          a.fimStr = formatDateToInput(newEnd);
          changed = true;
        }
      });
      if (!changed) break;
    }
    calcularPlanejadoEStatus();
    renderTabela();
    renderGantt();
    alert("Cronograma recalculado com base nas predecessoras (efeito domin√≥).");
  }

  function exportarJSON() {
    if (atividades.length === 0) {
      alert("N√£o h√° atividades para exportar.");
      return;
    }
    const dados = atividades.map((a, i) => ({
      ordem: i + 1,
      id: a.id,
      obraId: a.obraId || null,
      obra: a.obra,
      coordenador: a.coordenador,
      atividade: a.atividade,
      responsavel: a.responsavel,
      inicio: a.inicioStr,
      fim: a.fimStr,
      duracaoDias: a.duracaoDias,
      diasComerciais: !!a.diasComerciais,
      status: a.status,
      plannedPercent: a.plannedPercent,
      realPercent: a.realPercent,
      predecessorId: a.predecessorId,
      predecessora: obterNomePredecessora(a),
      baselineInicio: a.baselineInicioStr,
      baselineFim: a.baselineFimStr,
      baselineDuracaoDias: a.baselineDuracaoDias
    }));
    const blob = new Blob([JSON.stringify(dados, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const aTag = document.createElement("a");
    aTag.href = url;
    aTag.download = "cronograma_impar.json";
    aTag.click();
    URL.revokeObjectURL(url);
  }

  // ===== Integra√ß√£o com servidor =====
  async function salvarNoServidor() {
    const obraNome = getObraSelecionadaNome();
    const obraId = getObraSelecionadaId();
    const coordenador = document.getElementById("coordenador").value.trim();

    if (!obraNome) {
      alert("Selecione a Obra para salvar no servidor.");
      return;
    }
    if (atividades.length === 0) {
      alert("N√£o h√° atividades para salvar.");
      return;
    }

    const payload = {
      obra: obraNome,
      obraId: obraId || null,
      coordenador,
      linhaBaseSalva,
      atividades: atividades.map(a => ({
        id: a.id,
        atividade: a.atividade,
        responsavel: a.responsavel,
        inicioStr: a.inicioStr,
        fimStr: a.fimStr,
        duracaoDias: a.duracaoDias,
        diasComerciais: !!a.diasComerciais,
        predecessorId: a.predecessorId,
        realPercent: a.realPercent,
        plannedPercent: a.plannedPercent,
        baselineInicioStr: a.baselineInicioStr,
        baselineFimStr: a.baselineFimStr,
        baselineDuracaoDias: a.baselineDuracaoDias
      }))
    };

    try {
      const resp = await fetch(API_SAVE_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if (!resp.ok || data.sucesso === false) {
        alert("Erro ao salvar no servidor: " + (data.mensagem || resp.statusText));
        return;
      }
      alert("Cronograma salvo no servidor com sucesso.");
    } catch(e) {
      console.error(e);
      alert("Falha na comunica√ß√£o com o servidor ao salvar.");
    }
  }

  async function carregarDoServidor(idObraOpcional) {
    let url = API_LOAD_URL;
    if (idObraOpcional) {
      url += "?id=" + encodeURIComponent(idObraOpcional);
    } else {
      const obraNome = getObraSelecionadaNome();
      if (!obraNome) {
        alert("Selecione a Obra para carregar o cronograma do servidor.");
        return;
      }
      url += "?obra=" + encodeURIComponent(obraNome);
    }

    try {
      const resp = await fetch(url, { method:"GET" });
      const data = await resp.json();
      if (!resp.ok || data.sucesso === false) {
        alert("Erro ao carregar do servidor: " + (data.mensagem || resp.statusText));
        return;
      }

      const obraNome = data.obra || getObraSelecionadaNome();
      const coordenador = data.coordenador || "";
      const atividadesServidor = data.atividades || [];
      linhaBaseSalva = !!data.linhaBaseSalva;

      // posiciona dropdown de obra se vier id
      if (data.obraId) {
        const obraSelect = document.getElementById("obra");
        for (let i=0;i<obraSelect.options.length;i++){
          if (obraSelect.options[i].getAttribute("data-id") == data.obraId){
            obraSelect.selectedIndex = i;
            break;
          }
        }
      }
      document.getElementById("coordenador").value = coordenador;

      atividades = atividadesServidor.map(a => {
        const inicio = parseDate(a.inicioStr);
        const fim = parseDate(a.fimStr);
        const diasComerciais = !!a.diasComerciais;
        const duracaoDias = a.duracaoDias || (inicio && fim ? calcularDuracao(inicio, fim, diasComerciais) : 0);
        let baselineInicio = null;
        let baselineFim = null;
        if (a.baselineInicioStr && a.baselineFimStr) {
          baselineInicio = parseDate(a.baselineInicioStr);
          baselineFim = parseDate(a.baselineFimStr);
        }
        return {
          id: a.id,
          obra: obraNome,
          obraId: a.obraId || data.obraId || null,
          coordenador,
          atividade: a.atividade,
          responsavel: a.responsavel || "",
          inicioStr: a.inicioStr,
          fimStr: a.fimStr,
          inicio,
          fim,
          duracaoDias,
          diasComerciais,
          predecessorId: a.predecessorId || null,
          realPercent: typeof a.realPercent === "number" ? a.realPercent : 0,
          plannedPercent: 0,
          status: "N√£o iniciado",
          statusClass: "status-nao-iniciado",
          baselineInicio,
          baselineFim,
          baselineDuracaoDias: a.baselineDuracaoDias || null,
          baselineInicioStr: a.baselineInicioStr || null,
          baselineFimStr: a.baselineFimStr || null
        };
      });

      let maxId = 0;
      atividades.forEach(a => { if (a.id > maxId) maxId = a.id; });
      nextId = maxId + 1;

      atualizarHeaderInfo();
      atualizarListaPredecessoras();
      calcularPlanejadoEStatus();
      renderTabela();
      renderGantt();
      document.getElementById("badge-base").style.display =
        linhaBaseSalva ? "inline-block" : "none";

      if (!idObraOpcional) {
        alert("Cronograma da obra carregado do servidor.");
      }
    } catch(e) {
      console.error(e);
      alert("Falha na comunica√ß√£o com o servidor ao carregar.");
    }
  }

  // ===== Carregar combos do backend =====
  async function carregarObrasDropdown(idSelecionadoDaURL) {
    try{
      const resp = await fetch(API_LIST_OBRAS);
      const lista = await resp.json();
      if (!Array.isArray(lista)) throw new Error("Resposta inesperada ao listar obras.");
      cacheObras = lista;
      const sel = document.getElementById("obra");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Selecione a obra";
      sel.appendChild(opt0);

      lista.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.obra || "";
        opt.textContent = o.obra || ("Obra " + (o.id || ""));
        if (o.id !== undefined && o.id !== null) {
          opt.setAttribute("data-id", o.id);
        }
        sel.appendChild(opt);
      });

      if (idSelecionadoDaURL) {
        for (let i=0;i<sel.options.length;i++){
          if (sel.options[i].getAttribute("data-id") == idSelecionadoDaURL){
            sel.selectedIndex = i;
            break;
          }
        }
      }
      atualizarHeaderInfo();
    }catch(e){
      console.error(e);
    }
  }

  async function carregarCoordenadoresDropdown() {
    try{
      const resp = await fetch(API_LIST_COORDENADORES);
      const lista = await resp.json();
      if (!Array.isArray(lista)) throw new Error("Resposta inesperada ao listar coordenadores.");
      cacheCoordenadores = lista;
      const sel = document.getElementById("coordenador");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Selecione o coordenador";
      sel.appendChild(opt0);
      lista.forEach(c => {
        const nome = c.nome || c.coordenador || c.label || "";
        const opt = document.createElement("option");
        opt.value = nome;
        opt.textContent = nome;
        sel.appendChild(opt);
      });
    }catch(e){
      console.error(e);
    }
  }

  async function carregarResponsaveisDropdown() {
    try{
      const resp = await fetch(API_LIST_RESPONSAVEIS);
      const lista = await resp.json();
      if (!Array.isArray(lista)) throw new Error("Resposta inesperada ao listar respons√°veis.");
      cacheResponsaveis = lista;
      const sel = document.getElementById("responsavel");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Selecione o respons√°vel";
      sel.appendChild(opt0);
      lista.forEach(r => {
        const nome = r.nome || r.responsavel || r.label || "";
        const opt = document.createElement("option");
        opt.value = nome;
        opt.textContent = nome;
        sel.appendChild(opt);
      });
    }catch(e){
      console.error(e);
    }
  }

  // ===== init =====
  document.getElementById("predecessora").addEventListener("change", onPredecessoraChange);
  document.getElementById("obra").addEventListener("change", atualizarHeaderInfo);
  document.getElementById("coordenador").addEventListener("change", atualizarHeaderInfo);
  document.getElementById("inicio").addEventListener("change", onInicioChange);
  document.getElementById("fim").addEventListener("change", onFimChange);
  document.getElementById("duracao").addEventListener("change", onDuracaoChange);

  (async function initCronograma(){
    const params = new URLSearchParams(window.location.search);
    const idObra = params.get("id"); // vindo do farol
    await Promise.all([
      carregarObrasDropdown(idObra),
      carregarCoordenadoresDropdown(),
      carregarResponsaveisDropdown()
    ]);
    if (idObra) {
      // se veio do farol, j√° tenta carregar o cronograma dessa obra
      carregarDoServidor(idObra);
    }
  })();
</script>
</body>
</html>
