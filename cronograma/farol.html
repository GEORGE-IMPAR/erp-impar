<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>ERP √çmpar ‚Äì Farol de Obras</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root{
    --bg:#020617;
    --card:#020617;
    --border:#1f2937;
    --text:#e5e7eb;
    --text-soft:#9ca3af;
    --blue:#3b82f6;
    --blue-dark:#1d4ed8;
    --green:#22c55e;
    --yellow:#eab308;
    --red:#ef4444;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    background:
      radial-gradient(circle at top left,#1d4ed8 0,transparent 55%),
      radial-gradient(circle at bottom right,#f97316 0,transparent 55%),
      linear-gradient(120deg,#020617,#020617 60%,#030712);
    color:var(--text);
    min-height:100vh;
    display:flex;
    flex-direction:column;
  }
  header{
    padding:10px 16px 4px;
    display:flex;
    justify-content:center;
  }
  .header-inner{
    width:100%;
    max-width:1200px;
    display:flex;
    justify-content:space-between;
    gap:16px;
    align-items:flex-start;
  }
  .brand{
    display:flex;
    flex-direction:column;
    gap:2px;
    text-shadow:0 2px 6px rgba(0,0,0,.8);
  }
  .brand span:nth-child(1){
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.22em;
    opacity:.9;
  }
  .brand span:nth-child(2){
    font-size:20px;
    font-weight:800;
  }
  .brand span:nth-child(3){
    font-size:11px;
    opacity:.9;
  }
  .tag-top{
    font-size:11px;
    padding:4px 10px;
    border-radius:999px;
    background:rgba(15,23,42,.9);
    border:1px solid rgba(148,163,184,.7);
    color:var(--text-soft);
    display:flex;
    gap:8px;
    align-items:center;
    margin-top:12px;   /* descola do topo/m√≥dulo */
  }
  .pill-btn{
    border-radius:999px;
    border:1px solid #4b5563;
    background:#020617;
    padding:5px 10px;
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:.12em;
    color:var(--text-soft);
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:5px;
  }
  .pill-btn span.icn{font-size:12px;}
  .pill-btn:hover{
    border-color:#9ca3af;
    color:#e5e7eb;
  }

  main{
    flex:1 0 auto;
    display:flex;
    justify-content:center;
    padding:6px 12px 10px;
  }
  .layout{
    width:100%;
    max-width:1200px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .top-info{
    background:rgba(15,23,42,.96);
    border-radius:18px;
    border:1px solid rgba(55,65,81,.9);
    box-shadow:0 18px 40px rgba(0,0,0,.75);
    padding:10px 12px;
    font-size:12px;
    display:flex;
    justify-content:space-between;
    gap:8px;
    flex-wrap:wrap;
  }
  .legend{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    font-size:11px;
    color:var(--text-soft);
    align-items:center;
  }
  .leg-item{
    display:inline-flex;
    align-items:center;
    gap:4px;
  }
  .leg-dot{
    width:10px;height:10px;border-radius:999px;
  }

  .grid-obras-wrapper{
    background:rgba(15,23,42,.96);
    border-radius:18px;
    border:1px solid rgba(55,65,81,.9);
    box-shadow:0 18px 40px rgba(0,0,0,.75);
    padding:10px 12px 12px;
  }

  .grid-obras-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:8px;
    font-size:12px;
    color:var(--text-soft);
  }

  .grid-obras{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:10px;
  }
  @media(max-width:900px){
    .grid-obras{grid-template-columns:repeat(2,minmax(0,1fr));}
  }
  @media(max-width:600px){
    .grid-obras{grid-template-columns:1fr;}
  }

  .obra-card{
    position:relative;
    background:#020617;
    border-radius:14px;
    border:1px solid #1f2937;
    padding:8px 9px 9px;
    box-shadow:0 16px 34px rgba(0,0,0,.75);
    cursor:pointer;
    transition:transform .15s ease,box-shadow .15s ease,border-color .15s ease,background .15s ease;
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .obra-card:hover{
    transform:translateY(-3px);
    box-shadow:0 22px 46px rgba(0,0,0,.9);
    border-color:#93c5fd;
    background:#020617;
  }

  /* Card especial quando n√£o h√° nenhuma obra com cronograma */
  .obra-card-empty{
    align-items:flex-start;
    gap:8px;
  }
  .obra-card-empty p{
    font-size:12px;
    color:var(--text-soft);
  }

  .btn-primario{
    border-radius:999px;
    border:0;
    padding:6px 12px;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.12em;
    font-weight:700;
    cursor:pointer;
    color:#fff;
    background:linear-gradient(135deg,#2563eb,#22c55e);
    box-shadow:0 10px 24px rgba(0,0,0,.7);
  }
  .btn-primario:hover{
    filter:brightness(1.05);
  }

  .status-strip{
    position:absolute;
    inset:0;
    pointer-events:none;
    border-radius:14px;
    border-width:2px;
    border-style:solid;
    opacity:.6;
  }

  .obra-id{
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:.18em;
    color:var(--text-soft);
  }
  .obra-nome{
    font-size:13px;
    font-weight:700;
  }
  .obra-status{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:11px;
    color:var(--text-soft);
  }
  .status-dot{
    width:9px;height:9px;border-radius:999px;
  }
  .obra-bars{
    margin-top:3px;
    font-size:10px;
  }
  .barra-labels{
    display:flex;
    justify-content:space-between;
    margin-bottom:2px;
  }
  .barra-track{
    width:100%;
    height:6px;
    border-radius:999px;
    background:#020617;
    border:1px solid #111827;
    overflow:hidden;
  }
  .barra-plan{
    height:100%;
    background:rgba(59,130,246,.95);
  }
  .barra-real{
    height:100%;
    background:rgba(249,115,22,.95);
  }

  .obra-footer{
    margin-top:4px;
    display:flex;
    justify-content:space-between;
    font-size:10px;
    color:var(--text-soft);
  }

  footer{
    background:#020617;
    color:#9ca3af;
    padding:6px 16px;
    font-size:10px;
  }
  .rodape-inner{
    max-width:1200px;
    margin:0 auto;
    display:flex;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <span>PLATAFORMA</span>
      <span>ERP √çMPAR ‚Ä¢ Farol de Obras</span>
      <span>Vis√£o geral do planejado x real por obra</span>
    </div>
    <div class="tag-top">
      <button class="pill-btn" id="btnVoltarMenu" type="button">
        <span class="icn">‚Üê</span>
        Menu principal
      </button>
    </div>
  </div>
</header>

<main>
  <div class="layout">

    <div class="top-info">
      <div>
        <div style="font-size:13px;font-weight:600;margin-bottom:2px;">
          Farol de obras
        </div>
        <div>
          Acompanhe rapidamente o status de cada obra, comparando o percentual
          planejado x real. Clique em uma obra para abrir o cronograma detalhado
          ou cadastre um novo cronograma.
        </div>
      </div>
      <div class="legend">
        <span>Legenda:</span>
        <span class="leg-item">
          <span class="leg-dot" style="background:var(--green);"></span> Adiantado / no prazo
        </span>
        <span class="leg-item">
          <span class="leg-dot" style="background:var(--yellow);"></span> Aten√ß√£o
        </span>
        <span class="leg-item">
          <span class="leg-dot" style="background:var(--red);"></span> Atrasado
        </span>
        <span class="leg-item">
          <span class="leg-dot" style="background:var(--blue);"></span> Sem in√≠cio / sem baseline
        </span>
      </div>
    </div>

    <div class="grid-obras-wrapper">
      <div class="grid-obras-header">
        <div>Obras com cronograma</div>
        <div id="infoResumoObras">Carregando...</div>
      </div>
      <div class="grid-obras" id="gridObras"></div>
    </div>

  </div>
</main>

<footer>
  <div class="rodape-inner">
    <span>¬© 2025 ERP √çMPAR ‚Ä¢ M√≥dulo Farol de Obras</span>
    <span>Integra√ß√£o total com cronograma (baseline x real) v1.1</span>
  </div>
</footer>

<script>
  // MESMO PADR√ÉO DO GERADOR: api.erpimpar.com.br/cronograma/...
  const API_BASE = 'https://api.erpimpar.com.br/cronograma';

  const gridObras = document.getElementById('gridObras');
  const infoResumoObras = document.getElementById('infoResumoObras');
  const btnVoltarMenu = document.getElementById('btnVoltarMenu');

  btnVoltarMenu.addEventListener('click', () => {
    window.location.href = '../index.html';
  });

  async function carregarFarol(){
    try{
      const resp = await fetch(API_BASE + '/listar_obras_farol.php');
      const lista = await resp.json();
      if(!Array.isArray(lista)){
        throw new Error('Resposta inesperada da API do farol.');
      }

      // üî† ORDENAR POR NOME DA OBRA (A-Z)
      const ordenada = lista.slice().sort((a,b) => {
        const nomeA = (a.obra || '').toLocaleUpperCase('pt-BR');
        const nomeB = (b.obra || '').toLocaleUpperCase('pt-BR');
        if (nomeA < nomeB) return -1;
        if (nomeA > nomeB) return 1;
        return 0;
      });

      if (ordenada.length === 0){
        renderizarSemObras();
        return;
      }

      renderizarObras(ordenada);
    }catch(e){
      console.error(e);
      infoResumoObras.textContent = 'Erro ao carregar obras.';
      gridObras.innerHTML = '';
    }
  }

  function renderizarCardNovoCronograma(temObras){
    const card = document.createElement('div');
    card.className = 'obra-card obra-card-empty';

    const titulo = document.createElement('div');
    titulo.className = 'obra-nome';
    titulo.textContent = temObras
      ? 'Cadastrar cronograma de uma nova obra?'
      : 'Nenhuma obra com cronograma';

    const p1 = document.createElement('p');
    p1.textContent = temObras
      ? 'Voc√™ j√° possui obras com cronograma cadastrado. Use o bot√£o abaixo para cadastrar o cronograma de uma nova obra.'
      : 'Voc√™ ainda n√£o cadastrou nenhum cronograma de obra.';

    const p2 = document.createElement('p');
    p2.textContent = temObras
      ? 'Clique no bot√£o abaixo para criar o planejamento da pr√≥xima obra.'
      : 'Clique no bot√£o abaixo para criar o primeiro planejamento.';

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn-primario';
    btn.id = 'btnNovoCronograma';
    btn.textContent = 'Cadastrar novo cronograma';

    btn.addEventListener('click', () => {
      // Farol e cronograma est√£o na mesma pasta /cronograma/
      window.location.href = 'cronograma.html';
    });

    card.appendChild(titulo);
    card.appendChild(p1);
    card.appendChild(p2);
    card.appendChild(btn);

    gridObras.appendChild(card);
  }

  function renderizarSemObras(){
    infoResumoObras.textContent = 'Nenhuma obra com cronograma cadastrado.';
    gridObras.innerHTML = '';
    renderizarCardNovoCronograma(false);
  }

  function renderizarObras(obras){
    gridObras.innerHTML = '';
    if(obras.length === 0){
      renderizarSemObras();
      return;
    }

    infoResumoObras.textContent = obras.length + ' obras com cronograma';

    // Card fixo para cadastrar cronograma de uma nova obra
    renderizarCardNovoCronograma(true);

    obras.forEach(o => {
      const card = document.createElement('div');
      card.className = 'obra-card';

      const { borda, dotCor } = getCoresStatus(o);

      const strip = document.createElement('div');
      strip.className = 'status-strip';
      strip.style.borderColor = borda;
      card.appendChild(strip);

      const idSpan = document.createElement('div');
      idSpan.className = 'obra-id';
      idSpan.textContent = 'Obra ' + (o.id || '');
      card.appendChild(idSpan);

      const nomeSpan = document.createElement('div');
      nomeSpan.className = 'obra-nome';
      nomeSpan.textContent = o.obra || 'Obra sem nome';
      card.appendChild(nomeSpan);

      const statusDiv = document.createElement('div');
      statusDiv.className = 'obra-status';
      const dot = document.createElement('span');
      dot.className = 'status-dot';
      dot.style.background = dotCor;
      const txt = document.createElement('span');
      txt.textContent = o.status || 'SEM IN√çCIO';
      statusDiv.appendChild(dot);
      statusDiv.appendChild(txt);
      card.appendChild(statusDiv);

      const barrasDiv = document.createElement('div');
      barrasDiv.className = 'obra-bars';

      const pl = isNaN(o.planejado) ? 0 : Number(o.planejado);
      const re = isNaN(o.real) ? 0 : Number(o.real);

      const lbls = document.createElement('div');
      lbls.className = 'barra-labels';
      lbls.innerHTML = `
        <span>Planejado: <strong>${pl}%</strong></span>
        <span>Real: <strong>${re}%</strong></span>
      `;
      const trackPlan = document.createElement('div');
      trackPlan.className = 'barra-track';
      const barPlan = document.createElement('div');
      barPlan.className = 'barra-plan';
      barPlan.style.width = Math.max(2, Math.min(100, pl)) + '%';
      trackPlan.appendChild(barPlan);

      const trackReal = document.createElement('div');
      

trackReal.className = 'barra-track';
      const barReal = document.createElement('div');
      barReal.className = 'barra-real';
      barReal.style.width = Math.max(2, Math.min(100, re)) + '%';
      trackReal.appendChild(barReal);

      barrasDiv.appendChild(lbls);
      barrasDiv.appendChild(trackPlan);
      barrasDiv.appendChild(trackReal);
      card.appendChild(barrasDiv);

      const footer = document.createElement('div');
      footer.className = 'obra-footer';
      footer.innerHTML = `
        <span>${o.tem_baseline ? 'Com linha de base' : 'Sem linha de base'}</span>
        <span>${o.tem_real ? 'Com andamento real' : 'Sem andamento real'}</span>
      `;
      card.appendChild(footer);

      card.addEventListener('click', () => {
          // objeto "o" da obra dentro do forEach / map
          const obraId = o.id || o.id_obra || o.obra_id || o.obraId;
	  if (obraId) {
              window.location.href = 'cronograma.html?id=' + encodeURIComponent(obraId);
  	  } else {
              window.location.href = 'cronograma.html';        
          }
        });

      gridObras.appendChild(card);
    });
  }

  function getCoresStatus(o){
    const pl = isNaN(o.planejado) ? 0 : Number(o.planejado);
    const re = isNaN(o.real) ? 0 : Number(o.real);

    let borda = 'var(--blue)';
    let dotCor = 'var(--blue)';

    if(pl === 0 && re === 0 && !o.tem_baseline){
      borda = 'var(--blue)';
      dotCor = 'var(--blue)';
    } else if(re >= pl){
      borda = 'var(--green)';
      dotCor = 'var(--green)';
    } else if(re >= pl * 0.8){
      borda = 'var(--yellow)';
      dotCor = 'var(--yellow)';
    } else {
      borda = 'var(--red)';
      dotCor = 'var(--red)';
    }

    return { borda, dotCor };
  }

  carregarFarol();
</script>

</body>
</html>

