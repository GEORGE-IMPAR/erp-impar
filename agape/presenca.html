<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#071a2b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./favicon.ico">
  <title>Lista de Presença • Ágape</title>

  <style>
    :root{
      --bg1:#071a2b;
      --bg2:#0c3a56;
      --glass: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.60);
      --good:#33d07a;
      --bad:#ff3b30;
      --blue:#2d8cff;
      --yellow: rgba(255,215,0,.20);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg1); color:var(--text);}
    body{overflow:hidden}
    .safe{padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right);}
    .screen{
      position:fixed; inset:0;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      background: radial-gradient(1200px 900px at 50% 0%, var(--bg2), var(--bg1));
    }
    .wrap{width:min(420px, 100%); margin:0 auto; padding:16px;}
    .card{
      margin-top:14px;
      padding:16px;
      border-radius:22px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 24px 55px rgba(0,0,0,.32);
      position:relative;
    }

    .topBrand{
      display:flex; gap:12px; align-items:center;
      padding:14px 14px;
      border-radius:18px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 12px 40px rgba(0,0,0,.25);
    }
    .bLogo{width:46px;height:46px;border-radius:12px;background:rgba(255,255,255,.10); overflow:hidden; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,.12);}
    .bLogo img{width:100%;height:100%;object-fit:cover;display:block;}
    .bTxt{line-height:1.15}
    .bTitle{font-weight:900; font-size:18px; line-height:1.1;}
    .bSub{font-size:12px; opacity:.85; margin-top:2px;}

    .sessionBar{
      margin-top:12px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border-radius:14px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .dotBig{
      width:16px;height:16px;border-radius:50%;
      background:var(--bad);
      box-shadow:0 0 0 4px rgba(255,0,0,.10);
      flex:0 0 auto;
    }
    .sessionLine{font-weight:900; font-size:14px; letter-spacing:.2px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

    .tabs{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .tabBtn{
      flex:1;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .tabBtn.active{
      background: rgba(45,140,255,.22);
      border-color: rgba(45,140,255,.40);
    }

    /* Resumo (amarelo premium) */
    .resume{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      background: rgba(230,204,24,.92);
      color:#061a2b;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 45px rgba(0,0,0,.28);
    }
    .resumeTitle{font-weight:1000; font-size:14px;}
    .resumeList{margin:8px 0 0 0; padding-left:18px; font-weight:900;}
    .resumeList li{margin:4px 0; font-size:13px;}

    /* Lista */
    .list{
      margin-top:12px;
      max-height: 50vh;
      overflow:auto;
      padding-right:6px;
      -webkit-overflow-scrolling: touch;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      margin-bottom:10px;
    }
    .left{min-width:0; flex:1 1 auto;}
    .name{font-weight:1000; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .meta{margin-top:2px; font-size:12px; color:var(--muted);}

    .toggles{display:flex; gap:8px; flex:0 0 auto;}
    .tg{
      min-width:86px;
      padding:9px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:1000;
      font-size:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      user-select:none;
    }
    .tg.onS{background: rgba(51,208,122,.22); border-color: rgba(51,208,122,.35);}
    .tg.onA{background: rgba(45,140,255,.22); border-color: rgba(45,140,255,.40);}
    .tg.pend{background: rgba(255,255,255,.06); border-style:dashed; opacity:.95;}

    .footerBtns{
      margin-top:12px;
      display:flex;
      gap:10px;
    }
    .btn{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:none;
      background: linear-gradient(90deg, #19baff, #3a66ff);
      color:#001018;
      font-weight:1000;
      font-size:16px;
      line-height:1.1;
      cursor:pointer;
    }
    .btnRed{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:none;
      background: rgba(255,0,0,.55);
      color:#fff;
      font-weight:1000;
      font-size:16px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
    }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.75);
      color:white; padding:10px 14px;
      border-radius:14px;
      opacity:0; pointer-events:none;
      transition: opacity .25s ease;
      font-weight:800;
      z-index:99;
    }
    .toast.show{opacity:1}

    @media (min-width:900px){
      body{display:flex; align-items:center; justify-content:center; background:#081b2c;}
      .screen{position:relative; width:420px; height:860px; border-radius:26px; overflow:hidden; box-shadow: 0 30px 80px rgba(0,0,0,.55);}
      .list{max-height: 52vh;}
    }
  </style>
</head>

<body>
  <div id="toast" class="toast"></div>

  <section class="screen safe">
    <div class="wrap">
      <div class="card">

        <div class="topBrand">
          <div class="bLogo"><img id="brandLogo" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/></div>
          <div class="bTxt">
            <div class="bTitle" id="lojaNome">Lista de Presença</div>
            <div class="bSub" id="lojaSub">Sessão e Ágape</div>
          </div>
        </div>

        <div class="sessionBar">
          <div class="dotBig" id="sessaoDot"></div>
          <div class="sessionLine" id="sessaoLine">Sessão —</div>
        </div>

        <div class="tabs">
          <button class="tabBtn active" data-tab="todos">Sessão e Ágape</button>
          <button class="tabBtn" data-tab="sessao">Somente sessão</button>
          <button class="tabBtn" data-tab="agape">Somente ágape</button>
        </div>

        <div class="resume">
          <div class="resumeTitle">Resumo:</div>
          <ul class="resumeList">
            <li>Total respondidos: <b id="resRespondidos">0</b></li>
            <li>Sessão e Ágape: <b id="resAmbos">0</b></li>
            <li>Somente sessão: <b id="resSoSessao">0</b></li>
            <li>Somente ágape: <b id="resSoAgape">0</b></li>
            <li>Faltam responder: <b id="resPendentes">0</b></li>
          </ul>
        </div>

        <div id="list" class="list"></div>

        <div class="footerBtns">
          <button class="btnRed" id="btnVoltar" type="button">Voltar</button>
          <button class="btn" id="btnLimpar" type="button">Limpar marcações</button>
        </div>

      </div>
    </div>
  </section>

<script>
  // ===== CONFIG =====
  const CONFIG_URL = "./agape_config.json?v=23";
  const LS_PRESENCE = "agape_presence_v1";

  const $ = (s)=>document.querySelector(s);
  function toast(msg){
    const t=$("#toast");
    if(!t) return;
    t.textContent=msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1700);
  }

  let CFG = null;
  let TAB = "todos"; // todos|sessao|agape

  async function loadConfig(){
    const r = await fetch(CONFIG_URL, {cache:"no-store"});
    if(!r.ok) throw new Error("config");
    return await r.json();
  }

  function sessionIsOpen(){
    return (CFG?.sessao?.status||"").toLowerCase()==="aberta";
  }

  function sessionKey(){
    const d = String(CFG?.sessao?.data || "sem_data").trim();
    // chave por data (ex: 01/02/2026) para não misturar sessões
    return "p_" + d.replaceAll("/","-");
  }

  function getAllPresence(){
    try{ return JSON.parse(localStorage.getItem(LS_PRESENCE) || "{}"); }
    catch(_){ return {}; }
  }

  function setAllPresence(obj){
    try{ localStorage.setItem(LS_PRESENCE, JSON.stringify(obj || {})); }catch(_){}
  }

  function getPresenceMap(){
    const all = getAllPresence();
    return all[sessionKey()] || {}; // { cim: {sessao:boolean, agape:boolean} }
  }

  function setPresenceMap(map){
    const all = getAllPresence();
    all[sessionKey()] = map || {};
    setAllPresence(all);
  }

  function applyBrand(){
    const logoUrl = (CFG?.loja?.logo_url) ? CFG.loja.logo_url : "./assets/logo-Clementino-Brito.jpeg";
    const img = document.getElementById("brandLogo");
    if(img) img.src = logoUrl;

    const lojaNome = document.getElementById("lojaNome");
    if(lojaNome) lojaNome.textContent = (CFG?.loja?.nome || "Loja") + " • Presença";

    const lojaSub = document.getElementById("lojaSub");
    if(lojaSub) lojaSub.textContent = "Sessão e Ágape";

    const now = new Date();
    const hh = String(now.getHours()).padStart(2,"0");
    const mm = String(now.getMinutes()).padStart(2,"0");
    const ss = String(now.getSeconds()).padStart(2,"0");
    const nowStr = `${hh}:${mm}:${ss}`;

    const d = (CFG?.sessao?.data || "").trim();
    const status = sessionIsOpen() ? "Sessão aberta" : "Sessão fechada";
    const line = `${status} — ${d ? d + " — " : ""}${nowStr}`;

    const sessLine = document.getElementById("sessaoLine");
    if(sessLine) sessLine.textContent = line;

    const dot = document.getElementById("sessaoDot");
    if(dot){
      dot.style.background = sessionIsOpen() ? "var(--good)" : "var(--bad)";
      dot.style.boxShadow = sessionIsOpen()
        ? "0 0 0 4px rgba(0,255,140,.10)"
        : "0 0 0 4px rgba(255,0,0,.10)";
    }
  }

  function setText(id, val){
    const el = document.getElementById(id);
    if(el) el.textContent = String(val);
  }

  function computeSummary(map){
    const irmaos = Array.isArray(CFG?.irmaos) ? CFG.irmaos : [];
    let ambos=0, soS=0, soA=0, pend=0;
    for(const i of irmaos){
      const cim = String(i.cim||"").trim();
      const st = map[cim] || {sessao:false, agape:false};
      if(st.sessao && st.agape) ambos++;
      else if(st.sessao) soS++;
      else if(st.agape) soA++;
      else pend++;
    }
    const respondidos = ambos + soS + soA;
    return {respondidos, ambos, soS, soA, pend, total: irmaos.length};
  }

  function render(){
    const list = document.getElementById("list");
    if(!list) return;

    const irmaos = Array.isArray(CFG?.irmaos) ? CFG.irmaos.slice() : [];
    const map = getPresenceMap();
    const sum = computeSummary(map);

    setText("resRespondidos", sum.respondidos);
    setText("resAmbos", sum.ambos);
    setText("resSoSessao", sum.soS);
    setText("resSoAgape", sum.soA);
    setText("resPendentes", sum.pend);

    // filtro
    const filtered = irmaos.filter(i=>{
      const cim = String(i.cim||"").trim();
      const st = map[cim] || {sessao:false, agape:false};
      if(TAB === "sessao") return st.sessao === true && st.agape === false; // somente sessão
      if(TAB === "agape")  return st.agape === true && st.sessao === false; // somente ágape
      return true; // todos
    });

    list.innerHTML = filtered.map(i=>{
      const cim = String(i.cim||"").trim();
      const st = map[cim] || {sessao:false, agape:false};

      const sOn = st.sessao === true;
      const aOn = st.agape === true;

      // “pendente”: nenhum marcado ainda
      const pend = !sOn && !aOn;

      const clsS = pend ? "tg pend" : (sOn ? "tg onS" : "tg");
      const clsA = pend ? "tg pend" : (aOn ? "tg onA" : "tg");

      const labelS = sOn ? "Sessão ✅" : "Sessão";
      const labelA = aOn ? "Ágape ✅" : "Ágape";

      return `
        <div class="row" data-cim="${cim}">
          <div class="left">
            <div class="name">${escapeHtml(i.nome || "Irmão")}</div>
            <div class="meta">CIM: ${escapeHtml(cim)} ${pend ? "• Pendente" : ""}</div>
          </div>
          <div class="toggles">
            <button class="${clsS}" data-t="sessao" type="button">${labelS}</button>
            <button class="${clsA}" data-t="agape" type="button">${labelA}</button>
          </div>
        </div>
      `;
    }).join("");

    // binds toggle
    list.querySelectorAll("button[data-t]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const row = btn.closest(".row");
        const cim = row?.getAttribute("data-cim");
        const t = btn.getAttribute("data-t"); // sessao|agape
        if(!cim || !t) return;

        const map = getPresenceMap();
        const st = map[cim] || {sessao:false, agape:false};

        // toggle
        st[t] = !st[t];

        // REGRA: não deixar ficar “nenhum marcado” depois que já começou a responder
        const willBeNone = (st.sessao !== true) && (st.agape !== true);
        if(willBeNone){
          // se estava “pendente” e clicou, isso não acontece.
          // isso só acontece quando tenta desmarcar o último ativo
          st[t] = true;
          toast("Selecione ao menos Sessão ou Ágape");
          return;
        }

        map[cim] = st;
        setPresenceMap(map);
        render();
      });
    });
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function setTab(tab){
    TAB = tab;
    document.querySelectorAll(".tabBtn").forEach(b=>{
      b.classList.toggle("active", (b.getAttribute("data-tab")||"") === tab);
    });
    render();
  }

  async function boot(){
    try{
      CFG = await loadConfig();
    }catch(e){
      CFG = {loja:{nome:"Loja",subtitulo:"",logo_url:"./assets/logo-Clementino-Brito.jpeg"}, sessao:{status:"fechada",data:""}, irmaos:[]};
      toast("Não foi possível carregar o config");
    }

    applyBrand();
    render();

    // tabs
    document.querySelectorAll(".tabBtn").forEach(b=>{
      b.addEventListener("click", ()=>{
        setTab(b.getAttribute("data-tab") || "todos");
      });
    });

    // voltar
    document.getElementById("btnVoltar")?.addEventListener("click", ()=>{
      window.location.href = "./index.html";
    });

    // limpar marcações (somente desta data)
    document.getElementById("btnLimpar")?.addEventListener("click", ()=>{
      if(!confirm("Limpar todas as marcações desta sessão?")) return;
      setPresenceMap({});
      render();
      toast("Marcações limpas");
    });

    // atualiza linha do relógio a cada 5s (só visual)
    setInterval(()=>applyBrand(), 5000);
  }

  boot();
</script>
</body>
</html>
