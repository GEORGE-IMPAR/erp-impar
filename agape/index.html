<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#071a2b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQEAYAAABPYyMiAAAABmJLR0T///////8JWPfcAAAACXBIWXMAAABIAAAASABGyWs+AAAAF0lEQVRIx2NgGAWjYBSMglEwCkbBSAcACBAAAeaR9cIAAAAASUVORK5CYII=">
  <title>Sistema Agape</title>

  <style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ÃGAPE v15 - REDESIGN MODERNO
   Baseado em teste.html com paleta de cores moderna
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

* { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-dark: #0a1929;
  --bg-card: rgba(255,255,255,0.05);
  --border-light: rgba(255,255,255,0.1);
  --primary: #4fc3f7;
  --secondary: #81c784;
  --success: #4caf50;
  --warning: #ff9800;
  --danger: #f44336;
  --text-primary: #fff;
  --text-secondary: rgba(255,255,255,0.7);
}

body {
  font-family: system-ui, -apple-system, sans-serif;
  background: var(--bg-dark);
  color: var(--text-primary);
  line-height: 1.6;
  margin: 0;
  padding: 0;
}

/* â•â•â• CONTAINER â•â•â• */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* â•â•â• CARDS GLASSMORPHISM â•â•â• */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: 16px;
  padding: 20px;
  margin: 16px 0;
  backdrop-filter: blur(10px);
}

/* â•â•â• BOTÃ•ES â•â•â• */
button, .btn {
  background: linear-gradient(90deg, #1bb3ff, #3b6cff);
  color: #001018;
  border: none;
  padding: 12px 24px;
  border-radius: 12px;
  font-weight: 700;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s;
  min-height: 48px;
}

button:hover, .btn:hover { opacity: 0.9; transform: translateY(-2px); }
button:active, .btn:active { transform: scale(0.98); }
button:disabled { opacity: 0.5; cursor: not-allowed; }

/* â•â•â• INPUTS â•â•â• */
input, textarea, select {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid var(--border-light);
  border-radius: 8px;
  background: rgba(0,0,0,0.3);
  color: var(--text-primary);
  font-size: 14px;
  font-family: inherit;
  transition: all 0.3s;
}

input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: var(--primary);
  background: rgba(0,0,0,0.5);
}

/* â•â•â• TABELAS â•â•â• */
table {
  width: 100%;
  border-collapse: collapse;
  margin: 16px 0;
}

thead {
  background: rgba(0,0,0,0.3);
  border-bottom: 2px solid var(--primary);
}

th {
  padding: 12px;
  text-align: left;
  font-weight: 700;
  color: var(--primary);
  font-size: 14px;
  text-transform: uppercase;
}

td {
  padding: 12px;
  border-bottom: 1px solid var(--border-light);
}

tr:hover {
  background: rgba(255,255,255,0.02);
}

/* â•â•â• BADGES/PILLS â•â•â• */
.badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
}

.badge-success { background: rgba(76, 175, 80, 0.2); color: #a5d6a7; border: 1px solid rgba(76, 175, 80, 0.5); }
.badge-warning { background: rgba(255, 152, 0, 0.2); color: #ffcc80; border: 1px solid rgba(255, 152, 0, 0.5); }
.badge-danger { background: rgba(244, 67, 54, 0.2); color: #ef9a9a; border: 1px solid rgba(244, 67, 54, 0.5); }
.badge-info { background: rgba(33, 150, 243, 0.2); color: #64b5f6; border: 1px solid rgba(33, 150, 243, 0.5); }

/* â•â•â• ADMIN â•â•â• */
.adminScreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(10, 25, 41, 0.95);
  backdrop-filter: blur(20px);
  z-index: 9999;
  overflow-y: auto;
  padding: 20px;
}

.adminPanel {
  max-width: 1000px;
  margin: 0 auto;
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: 16px;
  padding: 24px;
}

.adminTabs {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
  border-bottom: 2px solid var(--border-light);
  padding-bottom: 8px;
}

.adminTab {
  padding: 12px 24px;
  background: transparent;
  color: var(--text-secondary);
  border: none;
  border-radius: 8px 8px 0 0;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
}

.adminTab.active {
  background: var(--primary);
  color: #001018;
}

.adminView {
  display: none;
}

.adminView:not(.hidden) {
  display: block;
}

.aLabel {
  display: block;
  margin: 16px 0 8px;
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 600;
}

.aInput, .aSelect {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid var(--border-light);
  border-radius: 8px;
  background: rgba(0,0,0,0.3);
  color: var(--text-primary);
  font-size: 14px;
}

/* â•â•â• CHECKBOXES â•â•â• */
input[type="checkbox"] {
  width: auto;
  margin-right: 8px;
  cursor: pointer;
}

/* â•â•â• RESUMO STATS â•â•â• */
.statsGrid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 16px;
  margin: 24px 0;
}

.statCard {
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--border-light);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
}

.statValue {
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 8px;
}

.statLabel {
  font-size: 11px;
  text-transform: uppercase;
  opacity: 0.7;
  letter-spacing: 0.5px;
}

/* â•â•â• RESPONSIVO â•â•â• */
@media (max-width: 768px) {
  .adminTabs {
    flex-direction: column;
  }
  
  .statsGrid {
    grid-template-columns: 1fr;
  }
  
  table {
    font-size: 12px;
  }
  
  th, td {
    padding: 8px 4px;
  }
}

/* â•â•â• HIDDEN â•â•â• */
.hidden {
  display: none !important;
}

/* â•â•â• SCROLL â•â•â• */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.2);
}

::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--secondary);
}
</style>
</head>

<body>
  <div id="toast" class="toast"></div>

  <!-- Splash 1 -->
  <section id="scr_splash1" class="screen active safe">
    <div class="splashCenter">
      <img id="splashSymbol" class="splashSymbol" src="./assets/maconaria.png" alt="Carregando" style="width:160px;height:160px;object-fit:contain;">
      <div class="splashLoading" style="margin-top:6px;font-weight:900;font-size:18px;opacity:.95;">Carregandoâ€¦..</div>
    </div>
  </section>

  <!-- Splash 2 -->
  <section id="scr_splash2" class="screen safe">
    <div class="splashCenter">
      <div class="logoWrap">
        <img id="splashLogo" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/>
      </div>
      <div class="brandText">Sistema Agape</div>
    </div>
  </section>

  <!-- Wait -->
  <section id="scr_wait" class="screen safe">
    <div class="wrap">
      <div class="card waitCard">
        <div class="topBrand">
          <div class="bLogo">
            <img id="brandLogoWait" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/>
          </div>
          <div class="bTxt">
            <div class="bTitle" id="lojaNomeWait">Loja</div>
            <div class="bSub" id="lojaSubWait">App Agape â€¢ Consumo & Pagamento</div>
          </div>
        </div>

        <div class="sessionBar">
          <div class="dotBig" id="sessaoDotWait"></div>
          <div class="sessionLine" id="sessaoLineWait">SessÃ£o fechada â€” â€”</div>
          <button class="msgBtn" id="btnEnvelope" type="button" aria-label="Mensagem do VenerÃ¡vel">
            <img src="./assets/icon-envelope.png" alt="" class="msgIcon">
            <span class="msgBadge hidden" id="badgeConvocacao">!</span>
          </button>
        </div>

        <div class="pixBar" style="margin-top:12px;">
          <div class="pixBadge"><img src="./assets/logo-pix.jpg" alt="Pix"></div>
          <div class="pixKey" id="pixChaveWait">â€”</div>
        </div>

        <div class="infoCard">
          <div class="infoTitle">SessÃ£o ainda nÃ£o liberada ğŸ”’</div>
          <div class="infoText">A sessÃ£o ainda nÃ£o foi aberta pelo responsÃ¡vel, mas nÃ£o se preocupe. Quando liberar a sessÃ£o, automaticamente aparecerÃ¡ a tela de login.</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;">
            <div style="padding:12px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);">
              <div style="font-size:12px;opacity:.75;">Ãšltima verificaÃ§Ã£o</div>
              <div style="margin-top:4px;font-weight:900;font-size:16px;" id="lastCheck">â€”</div>
            </div>
            <div style="padding:12px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);">
              <div style="font-size:12px;opacity:.75;">SessÃ£o</div>
              <div style="margin-top:4px;font-weight:900;font-size:16px;" id="sessaoStatus">Fechada</div>
            </div>
          </div>
          <button class="miniBtn" id="btnSairWait" type="button" style="margin-top:12px;background:#e53935;border-color:#e53935;color:#fff;">
            Sair do aplicativo
          </button>
        </div>

<!-- 1) COLE ISTO DENTRO DO #scr_wait (ex: logo abaixo do infoCard ou antes do hint) -->
<div id="waitPresencaOk" class="waitPresencaOk hidden">âœ… PRESENÃ‡A JÃ CONFIRMADA</div>

        <div class="hint">
          <div style="font-weight:900;font-size:14px;">Modo tesoureiro</div>
          <div style="font-size:13px;opacity:.95;margin-top:4px;">toque 5x no logo para abrir Admin (sessÃ£o, caixa, produtos, Pix).</div>
        </div>
      </div>
    </div>
  </section>

  <!-- PresenÃ§a -->
  <section id="scr_presenca" class="screen safe">
    <div class="wrap">
      <div class="card presCard">

        <div class="topBrand presTop">
          <div class="bLogo">
            <img id="brandLogoPres" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/>
          </div>
          <div class="bTxt">
            <div class="bTitle" id="lojaNomePres">Loja</div>
            <div class="bSub">PresenÃ§a â€¢ SessÃ£o & Agape</div>
          </div>
        </div>

        <div class="sessionBar presSessionBar">
          <div class="dotBig" id="sessaoDotPres"></div>
          <div class="sessionLine" id="sessaoLinePres">SessÃ£o fechada</div>
        </div>

        <div class="infoCard presMsg">
          <div class="infoTitle">Chamado do VenerÃ¡vel</div>
          <div class="infoText" id="presTexto">Carregando...</div>
        </div>

        <div class="presBtnsRow">
          <button class="payBtn primary" id="btnRespSessaoAgape" type="button">SessÃ£o e Agape</button>
          <button class="payBtn" id="btnRespSessao" type="button">Somente sessÃ£o</button>
          <button class="payBtn" id="btnRespAgape" type="button">Somente Ã¡gape</button>
        </div>

        <div class="hint" id="presStatusLine">VocÃª ainda nÃ£o respondeu.</div>

        <div class="presResumo">
          <div class="presResumoLeft">
            <div class="presResumoTitle">Resumo:</div>
            <div class="presResumoLine"><span>SessÃ£o e Agape:</span><b id="rSA">0</b></div>
            <div class="presResumoLine"><span>Somente sessÃ£o:</span><b id="rS">0</b></div>
            <div class="presResumoLine"><span>Somente Ã¡gape:</span><b id="rA">0</b></div>
            <div class="presResumoLine"><span>Total respondidos:</span><b id="rT">0</b></div>
            <div class="presResumoLine"><span>Total nÃ£o respondidos:</span><b id="rN">0</b></div>
          </div>

          <div class="presResumoRight" style="display:flex;flex-direction:column;align-items:center;justify-content:center;">
            <div class="barBox">
              <div class="barTop" id="barNao">0</div>
              <div class="barBottom" id="barSim">0</div>
            </div>
            <div class="barLegend">
              <span class="lgNo" style="display:inline-flex;gap:6px;align-items:center;"><i></i>NÃ£o</span>
              <span class="lgYes" style="display:inline-flex;gap:6px;align-items:center;"><i></i>Sim</span>
            </div>
          </div>
        </div>

        <button class="btn2" id="btnFecharPresenca" type="button">Fechar</button>
      </div>
    </div>
  </section>

   
  <!-- Login -->
  <section id="scr_login" class="screen safe">
    <div class="wrap">
      <div class="topBrand" id="brandBar">
        <div class="bLogo"><img id="brandLogo" alt="logo"/></div>
        <div class="bTxt">
          <div class="bTitle" id="lojaNome">Loja</div>
          <div class="bSub" id="lojaSub"></div>
        </div>
      </div>

      <div class="sessionBar" id="sessionBarLogin">
        <span class="dotBig" id="sessaoDotLogin" style="width:16px;height:16px;border-radius:50%;"></span>
        <div class="sessionLine" id="sessaoLineLogin">SessÃ£o â€”</div>
      </div>

      <div class="pixBar">
        <div class="pixBadge"><img src="./assets/logo-pix.jpg" alt="Pix"></div>
        <div class="pixKey" id="pixChave">â€”</div>
      </div>

      <div class="card" id="loginCard">
        <h2 id="welcomeTitle" style="margin:0 0 6px 0; font-size:34px; letter-spacing:.2px">Bem-vindo ğŸ‘‹</h2>
        <p style="margin:0 0 14px 0; color:var(--muted)">Digite seu <strong>CIM</strong> para entrar. BotÃµes grandes e tudo bem simples.</p>

        <div id="telWrap">
          <label style="display:block; font-weight:700; margin:10px 0 6px 0; font-size:15px">Telefone</label>
          <input id="inpTel" inputmode="tel" placeholder="Ex: 48999990000" style="width:100%;padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);color:var(--text);outline:none;font-size:16px;" />
        </div>

        <label style="display:block; font-weight:700; margin:10px 0 6px 0; font-size:15px">CIM (senha)</label>
        <input id="inpCIM" inputmode="numeric" placeholder="Digite seu CIM" style="width:100%;padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);color:var(--text);outline:none;font-size:16px;" />

        <button class="btn" id="btnEntrar">Entrar</button>
        <button class="miniBtn" id="btnSairLogin" style="width:100%;margin-top:10px;">Sair do aplicativo</button>

        <div style="margin-top:10px; color: rgba(255,255,255,.65)">Admin: toque 5x no logo.</div>
      </div>
    </div>
  </section>

  <!-- Consumo -->
  <section id="scr_consumo" class="screen safe">
    <div class="page">
      <div class="topBrand">
        <div class="bLogo"><img id="brandLogoCons" src="./assets/logo-Clementino-Brito.jpeg" alt="logo"/></div>
        <div class="bTxt">
          <div class="bTitle" id="consLoja">Loja</div>
          <div class="bSub" id="consSub"></div>
        </div>
      </div>

      <div class="sessionBar">
        <span class="dotBig" id="sessaoDotCons"></span>
        <div class="sessionLine" id="sessaoLineCons">SessÃ£o â€”</div>
      </div>

      <div class="cashBar" id="cashBar">
        <div class="cashText">Valor em caixa: <span id="cashValue">R$ 0,00</span></div>
      </div>

      <div class="pixBar">
        <div class="pixKey" >Meu Consumo</div>
        <button class="miniBtn" id="btnSair">Sair</button>
      </div>

      <div class="prodScroll" id="prodScroll">
        <div id="prodList"></div>
      </div>

      <div class="consFooter">
        <div class="totalBox">
          <div class="tLbl">Total</div>
          <div class="tVal" id="totalValue">R$ 0,00</div>
        </div>
        <button class="btn2" id="btnFechar">Fechar e pagar</button>
      </div>
    </div>
  </section>

   <!-- Pagamento -->
  <section id="scr_pagamento" class="screen safe">
    <div class="wrap">
      <div class="topBrand" id="payBrandBar">
        <div class="bLogo"><img id="payLogo" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/></div>
        <div class="bTxt">
          <div class="bTitle" id="payLoja">Loja</div>
          <div class="bSub">App Agape â€¢ Consumo & Pagamento</div>
        </div>
      </div>

      <div class="sessionBar">
        <span class="dotbig" id="paySessaoDot" style="width:12px;height:12px;border-radius:99px;"></span>
        <div class="sessionLine" id="paySessaoLine">SessÃ£o â€”</div>
      </div>

      <div class="payCard">
        <div class="payMsg">
          <div class="payHello" id="payHello">Oi meu irmÃ£o,</div>
          <div class="payTotal">Sua conta totalizou <span id="payTotal">R$ 0,00</span>:</div><br>
        </div>

        <div id="payItems" class="payItems"></div>
              
        <div class="payQ"><br>Como deseja pagar?</div><br>

        <div class="payIconRow" aria-label="Formas de pagamento">
          <button class="payIconBtn" id="btnPix" type="button" data-tip="Pix">
            <img src="./assets/logo-pix.jpg" alt="Pix" class="payIconImg"/>
          </button>

          <button class="payIconBtn" id="btnDinheiro" type="button" data-tip="Dinheiro">
            <span class="paySvg" aria-hidden="true">ğŸ’µ</span>
          </button>

          <button class="payIconBtn" id="btnProxima" type="button" data-tip="PrÃ³xima sessÃ£o">
            <span class="paySvg" aria-hidden="true">ğŸ“…</span>
          </button>
        </div>

        <button class="btn2 payBack" id="btnVoltarConsumo" type="button">Voltar para comanda</button>
        <div class="payHint">Ao pagar, registramos e voltamos para o login.</div>
      </div>
    </div>


    <!-- Modal Pix -->
    <div id="pixModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="pixTitle">
      <div class="modalCard">
        <div class="modalTop">
          <div class="modalTitle" id="pixTitle">Pix</div>
          <button class="modalX" id="btnPixCancel" type="button" aria-label="Fechar">âœ•</button>
        </div>

        <div class="modalText">Copie a chave e faÃ§a a transferÃªncia do valor exato.</div>

        <div class="pixValueRow">
          <div class="pixValueLbl">Valor</div>
          <div class="pixValue" id="pixValor">R$ 0,00</div>
        </div>

        <div class="pixKeyRow">
          <div class="pixKeyText" id="pixChaveModal">â€”</div>
          <button class="pixCopyBtn" id="btnCopyPix" type="button" title="Copiar">ğŸ“‹</button>
        </div>

        <button class="btn2 modalOk" id="btnPixOk" type="button">OK, transferi</button>
        <button class="modalCancel" id="btnPixCancel2" type="button">Cancelar</button>
      </div>
    </div>

    <!-- Sucesso -->
    <div id="paySuccess" class="hidden" style="position:fixed;inset:0;background:rgba(230,204,24,.96);display:flex;align-items:center;justify-content:center;z-index:9999;">
      <div style="display:flex;flex-direction:column;align-items:center;gap:14px;text-align:center;">
        <img id="payGif" src="./assets/check.gif" alt="Pago" style="width:160px;height:160px;object-fit:contain;filter:drop-shadow(0 12px 26px rgba(0,0,0,.25));">
        <div style="font-weight:1000;font-size:22px;color:#053018;text-shadow:0 1px 0 rgba(255,255,255,.35);">Pagamento registrado</div>
      </div>
    </div>
  </section>
  <div id="presSuccess" class="presSuccess hidden" aria-hidden="true">
     <div class="presSuccessInner">
       <img id="presGif" src="./assets/presenca.gif" alt="Confirmado">
       <div class="presOkText">PRESENÃ‡A CONFIRMADA!!!!!!!!!</div>
    </div>
  </div>

<!-- ==========================
     ADMIN (SUBSTITUIR O SECTION INTEIRO)
     ========================== -->
<section id="scr_admin" class="screen">
  <div class="adminWrap">
    <div class="adminHeader">
      <img id="adminLogo" src="./assets/logo-Clementino-Brito.jpeg" alt="logo">
      <div>
        <div class="t1">Admin</div>
        <div class="t2">ConfiguraÃ§Ã£o â€¢ SessÃ£o â€¢ IrmÃ£os</div>
      </div>
    </div>

    <div class="adminTabs">
      <button class="adminTab" id="tabCfg" type="button">CONFIGURAÃ‡ÃƒO</button>
      <button class="adminTab active" id="tabSessao" type="button">SESSÃƒO</button>
      <button class="adminTab" id="tabIrmaos" type="button">IRMÃƒOS</button>
    </div>

    <div class="adminPanel">
      <div class="adminScroll">

                <!-- ABA SESSAO -->
        <div id="adminViewSessao" class="hidden">
          <div class="adminGrid2">
            <div>
              <div class="aLabel">Status</div>
              <select class="aSelect" id="a_sessao_status">
                <option value="aberta">aberta</option>
                <option value="fechada">fechada</option>
              </select>
            </div>
            <div>
              <div class="aLabel">Data</div>
              <input class="aInput" id="a_sessao_data" placeholder="dd/mm/aaaa">
            </div>
          </div>

          <div class="adminGrid2">
            <div>
              <div class="aLabel">Caixa inicial</div>
              <input class="aInput" id="a_sessao_caixa" placeholder="0" inputmode="decimal">
            </div>
            <div>
              <div class="aLabel">SessÃ£o ID (convocaÃ§Ã£o)</div>
              <input class="aInput" id="a_conv_id" placeholder="2026-02-07-001">
            </div>
          </div>

          <div class="aLabel">Chamado</div>
          <input class="aInput" id="a_sessao_chamado" placeholder="Texto do chamado">
        
        <!-- CONVOCAÃ‡ÃƒO -->
        <div class="adminRow">
          <label class="aLabel">
            <input type="checkbox" class="aCheckbox" id="a_conv_on" />
            ConvocaÃ§Ã£o ativa
          </label>
        </div>
        <div class="adminRow">
          <label class="aLabel">ID ConvocaÃ§Ã£o</label>
          <input class="aInput" id="a_conv_id" placeholder="CONV_2025_01" />
        </div>
        <div class="adminRow">
          <label class="aLabel">TÃ­tulo ConvocaÃ§Ã£o</label>
          <input class="aInput" id="a_conv_titulo" placeholder="ConvocaÃ§Ã£o extraordinÃ¡ria" />
        </div>
        <div class="adminRow">
          <label class="aLabel">Texto ConvocaÃ§Ã£o</label>
          <textarea class="aInput" id="a_conv_texto" rows="3" placeholder="Pauta: discussÃ£o financeira..."></textarea>
        </div>

        <!-- PUSH NOTIFICATION -->
        <div class="adminRow">
          <label class="aLabel">
            <input type="checkbox" class="aCheckbox" id="a_push_on" />
            Push notification ativo
          </label>
        </div>
        <div class="adminRow">
          <label class="aLabel">TÃ­tulo Push</label>
          <input class="aInput" id="a_push_titulo" placeholder="SessÃ£o Convocada!" />
        </div>
        <div class="adminRow">
          <label class="aLabel">Mensagem Push</label>
          <textarea class="aInput" id="a_push_msg" rows="2" placeholder="Nova sessÃ£o disponÃ­vel"></textarea>
        </div>
        <div class="adminRow">
          <label class="aLabel">URL Push</label>
          <input class="aInput" id="a_push_url" placeholder="https://www.erpimpar.com.br/agape/" />
        </div>
        </div>

        <!-- ABA CFG -->
        <div id="adminViewCfg">
          <div class="aLabel">Nome da loja</div>
          <input class="aInput" id="a_loja_nome" placeholder="Nome da loja">
          <div class="aLabel">SubtÃ­tulo</div>
          <input class="aInput" id="a_loja_sub" placeholder="SubtÃ­tulo">
          <div class="aLabel">PIX</div>
          <input class="aInput" id="a_loja_pix" placeholder="Chave PIX">
          <div class="aLabel">WhatsApp Tesoureiro (senha)</div>
          <input class="aInput" id="a_loja_tes" placeholder="55...">
          <div class="aLabel">Logo URL (GitHub)</div>
          <input class="aInput" id="a_logo_url" placeholder="./assets/logo...">
        </div>


        <!-- ABA IRMAOS (ONLINE) -->
        <div id="adminViewIrmaos" class="hidden">
          <div class="aLabel">Status: NÃ£o confirmado â€¢ Somente sessÃ£o â€¢ Somente Ã¡gape â€¢ SessÃ£o e Ã¡gape</div>
          <table class="adminTable" id="adminTableIrmaos">
            <thead>
              <tr>
                <th style="width:40px;">#</th>
                <th>IRMÃƒO</th>
                <th style="width:130px;">STATUS</th>
                <th style="width:90px;">PAGOU</th>
              </tr>
            </thead>
            <tbody id="adminIrmaosBody"></tbody>
          </table>

          <div class="adminResumo" id="adminResumoBox">
            <div class="rTitle">Resumo (online)</div>
            <div class="rLine"><span class="k">Total de irmÃ£os na sessÃ£o</span><span class="v" id="r_total_irmaos">â€”</span></div>
            <div class="rLine"><span class="k">NÃ£o confirmaram</span><span class="v" id="r_nao_confirm">â€”</span></div>
            <div class="rLine"><span class="k">Recebido em DINHEIRO</span><span class="v" id="r_din">â€”</span></div>
            <div class="rLine"><span class="k">Recebido em PIX</span><span class="v" id="r_pix">â€”</span></div>
            <div class="rLine"><span class="k">PrÃ³xima sessÃ£o (pendÃªncia)</span><span class="v" id="r_prox">â€”</span></div>
            <div class="rLine"><span class="k">Total em caixa (fÃ­sico)</span><span class="v" id="r_caixa">â€”</span></div>
          </div>

          <div class="adminResumo" id="adminProdutosBox">
            <div class="rTitle">Consumo por produto (total)</div>
            <div id="r_prod_list" style="font-size:12px; opacity:.9;">â€”</div>
          </div>
        </div>
      </div>

      <div class="adminFooter">
        <button class="btnAdminPrimary" id="btnAdminSalvar" type="button">CONFIRMAR</button>
        <button class="btnAdminDanger" id="btnAdminSair" type="button">SAIR</button>
      </div>
    </div>
  </div>
</section>

<!-- MODAL/DETALHE IRMÃƒO -->
<div class="adminModal" id="adminModal">
  <div class="adminSheet">
    <div class="sheetHead">
      <div>
        <div class="h1" id="m_nome">IrmÃ£o</div>
        <div style="font-size:11px;opacity:.75" id="m_meta">â€”</div>
      </div>
      <button class="sheetClose" id="m_close" type="button">Fechar</button>
    </div>

    <div class="sheetBlock">
      <div class="sheetRow"><span>Status</span><b id="m_status">â€”</b></div>
      <div class="sheetRow"><span>Pagamentos</span><b id="m_pag">â€”</b></div>
    </div>

    <div class="sheetBlock">
      <div style="font-weight:900; font-size:12px; margin-bottom:8px;">Consumo (descriÃ§Ã£o + qtd)</div>
      <div id="m_cons" style="font-size:12px; opacity:.92;">â€”</div>
    </div>

    <div class="sheetBlock">
      <div style="font-weight:900; font-size:12px; margin-bottom:8px;">LanÃ§ar pagamento (online)</div>
      <div class="adminGrid2">
        <input class="aInput" id="m_valor" placeholder="Valor (ex: 10)" inputmode="decimal">
        <select class="aSelect" id="m_forma">
          <option value="DINHEIRO">DINHEIRO</option>
          <option value="PIX">PIX</option>
          <option value="PROXIMA_SESSAO">PROXIMA_SESSAO</option>
        </select>
      </div>
      <button class="btnAdminPrimary" id="m_btn_pagar" type="button" style="margin-top:10px;">Registrar pagamento</button>
    </div>
  </div>
</div>
</section>
 
<script>
/* ==========================
   CONFIG / HELPERS
========================== */
const LS_CART  = "agape_cart_v14";
const LS_USER  = "agape_user_v14";
const LS_CASH = "agape_cash_v1";
const LS_CASH_DATE = "agape_cash_date_v1";
const LS_PRES_LIDA = "agape_presenca_lida_v1";
const LS_PRES_RESP = "agape_presenca_resp_v1";
const GIF_TIME   = 6000;
const ZOOM_TIME  = 6000;

const $ = (s)=>document.querySelector(s);

function setText(sel, val){
  if(!sel) return;
  const isCSS =
    sel.startsWith("#") || sel.startsWith(".") ||
    sel.includes(" ") || sel.includes(",") ||
    sel.includes("[") || sel.includes(">") || sel.includes(":");
  const q = isCSS ? sel : ("#" + sel);
  const el = document.querySelector(q);
  if(el) el.textContent = (val ?? "");
}

const fmtBRL = (v)=>Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

let CFG=null;
let lastTotal = 0;
let currentScreen="scr_splash1";
let waitTimer=null;
let waitOpenTimer=null;
let waitPollingStarted=false;
let payReady = true;
let adminTapCount=0;
let adminTapTimer=null;

function toast(msg){
  const t=$("#toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1700);
}

function showScreen(id, dir="forward"){
  const from=document.getElementById(currentScreen);
  const to=document.getElementById(id);
  if(!from||!to||id===currentScreen) return;

  to.classList.remove("exit-left","exit-right","enter-left","enter-right");
  from.classList.remove("exit-left","exit-right","enter-left","enter-right");

  if(dir==="forward") to.classList.add("enter-left"); else to.classList.add("enter-right");
  to.classList.add("active");
  to.classList.remove("hidden");

  if (id === "scr_splash2") {
    const lw = to.querySelector(".logoWrap");
    const bt = to.querySelector(".brandText");
    [lw, bt].forEach(el => {
      if (!el) return;
      el.style.animation = "none";
      void el.offsetHeight;
      el.style.animation = "";
    });
  }

  void to.offsetWidth;
  to.classList.remove("enter-left","enter-right");

  if(dir==="forward") from.classList.add("exit-left"); else from.classList.add("exit-right");

  setTimeout(()=>{
    from.classList.remove("active","exit-left","exit-right");
    currentScreen=id;
  }, 460);
}

async function loadConfig(){
  const r=await fetch("https://api.erpimpar.com.br/agape/consumo/agape_config.json");
  if(!r.ok) throw new Error("config");
  return await r.json();
}

function sessionIsOpen(){
  return (CFG?.sessao?.status||"").toLowerCase()==="aberta";
}

/* ==========================
   STORAGE: CART / USER / CASH
========================== */

/* âœ… FIX mÃ­nimo: sua funÃ§Ã£o tinha recursÃ£o (chamava ela mesma) */
function resetPresencaState(){
  localStorage.removeItem(LS_PRES_LIDA);
  localStorage.removeItem(LS_PRES_RESP);

  // se houver convocaÃ§Ã£o e o ID mudar, limpa estado de presenÃ§a
  if(CFG?.convocacao?.ativa){
    const lastId = localStorage.getItem("agape_conv_id");
    if(lastId !== CFG.convocacao.id){
      localStorage.removeItem(LS_PRES_LIDA);
      localStorage.removeItem(LS_PRES_RESP);
      localStorage.setItem("agape_conv_id", CFG.convocacao.id);
    }
  }
}

function getCart(){ try{return JSON.parse(localStorage.getItem(LS_CART)||"{}")}catch(_){return {}} }
function setCart(c){ localStorage.setItem(LS_CART, JSON.stringify(c)); }
function clearCart(){ localStorage.removeItem(LS_CART); }

function getUser(){ try { return JSON.parse(localStorage.getItem(LS_USER) || "null"); } catch(e){ return null; } }
function setUser(u){ localStorage.setItem(LS_USER, JSON.stringify(u)); }
//function clearUser(){ localStorage.removeItem(LS_USER); }

function getCashFromCFG(){
  const n = Number(CFG?.sessao?.caixa_inicial);
  return Number.isFinite(n) ? n : 0;
}
function getCash(){
  const n = Number(localStorage.getItem(LS_CASH));
  return Number.isFinite(n) ? n : getCashFromCFG();
}
function setCash(n){
  localStorage.setItem(LS_CASH, String(Number(n) || 0));
}
function initCashFromConfig(){
  const sessionDate = String(CFG?.sessao?.data || "").trim();
  const savedDate   = localStorage.getItem(LS_CASH_DATE);
  const hasCash     = localStorage.getItem(LS_CASH) !== null;

  if(!hasCash || (sessionDate && savedDate !== sessionDate)){
    setCash(getCashFromCFG());
    localStorage.setItem(LS_CASH_DATE, sessionDate);
  }
}
function renderCash(){
  const el = document.getElementById("cashValue");
  if(el) el.textContent = fmtBRL(getCash());
}

/* ==========================
   ===== PRESENÃ‡A (ÃšNICA) =====
========================== */
const LS_PRESENCA_ANS  = "agape_presenca_ans_v1";
const LS_PRESENCA_READ = "agape_presenca_read_v1";

function sessaoKey(){
  return String(CFG?.sessao?.data || "").trim();
}
function getPresencaMap(){
  try{ return JSON.parse(localStorage.getItem(LS_PRESENCA_ANS) || "{}"); }
  catch(_){ return {}; }
}
function getPresencaAns(){
  const key = sessaoKey();
  if(!key) return "";
  return String(getPresencaMap()[key] || "");
}
async function setPresencaAns(ans){
  const key = sessaoKey();
  if(!key) return;
  
  // 1. Salva local (compatibilidade)
  const map = getPresencaMap();
  map[key] = ans;
  localStorage.setItem(LS_PRESENCA_ANS, JSON.stringify(map));
  
  // 2. Envia para o servidor
  const userTel = (typeof LOGGED_USER !== "undefined" && LOGGED_USER) ? LOGGED_USER.telefone : "";
  const userName = (typeof LOGGED_USER !== "undefined" && LOGGED_USER) ? LOGGED_USER.nome : "";
  
  if(!userTel){ console.warn("setPresencaAns: usuÃ¡rio nÃ£o logado"); return; }
  
  const evt = { type: "confirmacao_presenca", status: ans || "NAO_CONFIRMADO", telefone: userTel, nome: userName, ts: Math.floor(Date.now()/1000) };
  const payload = { sessao_id: key, event: evt };
  
  try {
    const response = await fetch("https://api.erpimpar.com.br/agape/consumo/presenca_confirm.php", {
      method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
    });
    if(!response.ok) throw new Error("HTTP " + response.status);
    const result = await response.json();
    console.log("[OK] Presenca confirmada:", result);
    
    // Enviar push notification
    try {
      if('serviceWorker' in navigator && 'PushManager' in window) {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        if(subscription) {
          await fetch("https://api.erpimpar.com.br/agape/consumo/send_push.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              title: "PresenÃ§a Confirmada âœ…", 
              body: `${userName} confirmou presenÃ§a`,
              icon: "./assets/icon-192.png"
            })
          });
          console.log("[OK] Push enviado");
        }
      }
    } catch(pushErr) {
      console.warn("[WARN] Erro ao enviar push:", pushErr);
    }
    if(typeof showPresSuccess === "function"){ showPresSuccess(); setTimeout(() => { if(typeof hidePresSuccess === "function") hidePresSuccess(); }, PRES_SUCCESS_MS || 6000); }
    if(typeof toast === "function") toast("PresenÃ§a confirmada!");
  } catch(e) {
    console.warn("[ERRO] Erro ao enviar presenca:", e);
    if(typeof offEnqueue === "function"){ offEnqueue(payload); if(typeof toast === "function") toast("Sem rede: presenÃ§a salva localmente"); }
  }
}
function setReadPresenca(){
  const key = sessaoKey();
  if(!key) return;
  localStorage.setItem(LS_PRESENCA_READ, key);
}
function isReadPresenca(){
  const key = sessaoKey();
  return !!key && localStorage.getItem(LS_PRESENCA_READ) === key;
}

function refreshPresenceUI(){
  const totalIrmaos = Array.isArray(CFG?.irmaos) ? CFG.irmaos.length : 0;
  const ans = getPresencaAns();

  const nSA = ans === "sessao_agape"   ? 1 : 0;
  const nSS = ans === "somente_sessao" ? 1 : 0;
  const nAG = ans === "somente_agape"  ? 1 : 0;

  const totalResp = ans ? 1 : 0;
  const totalNao  = Math.max(0, totalIrmaos - totalResp);

  const setNum = (id, v)=>{ const el=document.getElementById(id); if(el) el.textContent = String(v); };

  setNum("rSA", nSA);
  setNum("rS",  nSS);
  setNum("rA",  nAG);
  setNum("rT",  totalResp);
  setNum("rN",  totalNao);

  setNum("barNao", totalNao);
  setNum("barSim", totalResp);

  const line = document.getElementById("presStatusLine");
  if(line){
    const label =
      ans === "sessao_agape" ? "SessÃ£o e Agape" :
      ans === "somente_sessao" ? "Somente sessÃ£o" :
      ans === "somente_agape" ? "Somente Ã¡gape" : "";
    line.textContent = ans ? `VocÃª respondeu: ${label}.` : "VocÃª ainda nÃ£o respondeu.";
  }

  ["btnRespSessaoAgape","btnRespSessao","btnRespAgape"].forEach(id=>{
    const b = document.getElementById(id);
    if(b) b.classList.remove("isChosen");
  });
  const chosenId =
    ans === "sessao_agape" ? "btnRespSessaoAgape" :
    ans === "somente_sessao" ? "btnRespSessao" :
    ans === "somente_agape" ? "btnRespAgape" : "";
  if(chosenId){
    const b = document.getElementById(chosenId);
    if(b) b.classList.add("isChosen");
  }
}

const LS_CONVOCACAO_READ = "agape_convocacao_read_v1";

function getConvocacaoObj(){
  // aceita convocacao na raiz OU dentro de sessao (compatÃ­vel com os 2 formatos)
  return (CFG && (CFG.convocacao || (CFG.sessao && CFG.sessao.convocacao))) || null;
}

function getConvocacaoId(){
  const c = getConvocacaoObj();
  return String(c?.id || "").trim();
}

function isConvocacaoAtiva(){
  const c = getConvocacaoObj();
  return c?.ativa === true;
}

function isConvocacaoLida(){
  const id = getConvocacaoId();
  if(!id) return false;
  return localStorage.getItem(LS_CONVOCACAO_READ) === id;
}

function marcarConvocacaoLida(){
  const id = getConvocacaoId();
  if(!id) return;
  localStorage.setItem(LS_CONVOCACAO_READ, id);
}

/** Atualiza a bolinha do envelope (id correto: badgeConvocacao) */
function updateConvocacaoBadge(){
  const badge = document.getElementById("badgeConvocacao");
  if(!badge) return;

  const show = isConvocacaoAtiva() && !isConvocacaoLida();
  badge.classList.toggle("hidden", !show);
  badge.textContent = "!";
}

/** MantÃ©m compatibilidade com chamadas antigas */
function updateEnvelopeUI(){
  updateConvocacaoBadge();
}

function choosePresenca(val){
  setPresencaAns(val);
  setReadPresenca();
  refreshPresenceUI();
  updateEnvelopeUI();
}

function openPresenca(){
  if(!CFG?.sessao) return;

  marcarConvocacaoLida();
  updateConvocacaoBadge();

  const elTxt = document.getElementById("presTexto");
  if(elTxt){
    elTxt.textContent = CFG.sessao.chamado || "Mensagem nÃ£o configurada.";
  }

  setPresencaLida();
  updateEnvelopeUI();

  showScreen("scr_presenca","forward");
  refreshPresenceUI();
}

// ===== Pagamento v25 flow =====
const PAY_SUCCESS_MS = 2200;

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function cartEntries(cart){
  if(!cart) return [];
  if(!Array.isArray(cart) && typeof cart==="object"){
    return Object.entries(cart).map(([id,q])=>({id:String(id), qtd:Number(q||0)}));
  }
  if(Array.isArray(cart)){
    return cart.map(it=>({id:String(it.id), qtd:Number(it.qtd||it.qtd||0)}));
  }
  return [];
}

// ===== PIX =====
function emv(id, value){
  const v = String(value);
  const len = String(v.length).padStart(2,"0");
  return `${id}${len}${v}`;
}

function crc16(payload){
  let crc = 0xFFFF;
  for(let i=0;i<payload.length;i++){
    crc ^= (payload.charCodeAt(i) << 8);
    for(let j=0;j<8;j++){
      crc = (crc & 0x8000) ? (((crc << 1) ^ 0x1021) & 0xFFFF) : ((crc << 1) & 0xFFFF);
    }
  }
  return crc.toString(16).toUpperCase().padStart(4,"0");
}

function buildPixPayload({ key, amount, merchantName, merchantCity, txid }){
  const k = String(key||"").trim();
  const a = Number(amount||0).toFixed(2);

  const mName = String(merchantName || "AGAPE").slice(0,25);
  const mCity = String(merchantCity || "BRASIL").slice(0,15);
  const tId   = String(txid || "AGAPE").slice(0,25);

  const gui = emv("00","BR.GOV.BCB.PIX");
  const chave = emv("01", k);
  const mai = emv("26", gui + chave);

  const payloadNoCrc =
    emv("00","01") +
    emv("01","12") +
    mai +
    emv("52","0000") +
    emv("53","986") +
    emv("54", a) +
    emv("58","BR") +
    emv("59", mName) +
    emv("60", mCity) +
    emv("62", emv("05", tId)) +
    "6304";

  return payloadNoCrc + crc16(payloadNoCrc);
}

function closePresenca(){
  updateEnvelopeUI();
  updatePresenceConfirmedWait(); // mostra no wait imediatamente
  showScreen("scr_wait","back");
}

function isPresencaLida(){
  return localStorage.getItem(LS_PRES_LIDA) === "1";
}
function setPresencaLida(){
  localStorage.setItem(LS_PRES_LIDA, "1");
}
function isPresencaRespondida(){
  return localStorage.getItem(LS_PRES_RESP) === "1";
}
function setPresencaRespondida(){
  localStorage.setItem(LS_PRES_RESP, "1");
}

function bindPresencaUI(){
  const b1 = document.getElementById("btnRespSessaoAgape");
  const b2 = document.getElementById("btnRespSessao");
  const b3 = document.getElementById("btnRespAgape");

  const bind = (btn, val)=>{
    if(!btn || btn.dataset.bound) return;
    btn.dataset.bound = "1";

    const handler = (e)=>{
      e?.preventDefault?.();
      choosePresenca(val);
    };

    btn.addEventListener("click", handler);
    btn.addEventListener("touchend", (e)=>{ e.preventDefault(); handler(e); }, {passive:false});
  };

  bind(b1, "sessao_agape");
  bind(b2, "somente_sessao");
  bind(b3, "somente_agape");

  const env = document.getElementById("btnEnvelope");
  if(env && !env.dataset.bound){
    env.dataset.bound="1";
    env.addEventListener("click", openPresenca);
    env.addEventListener("touchend", (e)=>{ e.preventDefault(); openPresenca(); }, {passive:false});
  }

  const fechar = document.getElementById("btnFecharPresenca");
  if(fechar && !fechar.dataset.bound){
    fechar.dataset.bound="1";
    fechar.addEventListener("click", closePresenca);
    fechar.addEventListener("touchend", (e)=>{ e.preventDefault(); closePresenca(); }, {passive:false});
  }
}

/* ==========================
   BRAND / UI
========================== */
function applyBrand(){
  const setTextId = (id, val) => { const el=document.getElementById(id); if(el) el.textContent = val; };
  const setSrc  = (id, src) => { const el=document.getElementById(id); if(el && src) el.src = src; };

  const logoUrl = (CFG?.ui?.logo_url) ? CFG.ui.logo_url : "./assets/logo-Clementino-Brito.jpeg";

  ["brandLogo","brandLogoWait","brandLogoCons","brandLogoPres","payLogo"].forEach(id=>setSrc(id, logoUrl));

  setTextId("lojaNome", CFG?.loja?.nome || "Loja");
  setTextId("lojaSub",  CFG?.loja?.subtitulo || "");
  setTextId("lojaNomeWait", CFG?.loja?.nome || "Loja");
  setTextId("lojaSubWait",  CFG?.loja?.subtitulo || "");
  setTextId("consLoja", CFG?.loja?.nome || "Loja");
  setTextId("consSub",  CFG?.loja?.subtitulo || "");
  setTextId("lojaNomePres", CFG?.loja?.nome || "Loja");
  setTextId("payLoja", CFG?.loja?.nome || "Loja");

  const pix = (CFG?.loja?.pix_chave || "").trim();
  setTextId("pixChave", pix || "â€”");
  setTextId("pixChaveWait", pix || "â€”");

  const opened = (CFG?.sessao?.status || "").toLowerCase() === "aberta";

  const now = new Date();
  const hh = String(now.getHours()).padStart(2,"0");
  const mm = String(now.getMinutes()).padStart(2,"0");
  const ss = String(now.getSeconds()).padStart(2,"0");
  const nowStr = `${hh}:${mm}:${ss}`;
  const d = (CFG?.sessao?.data || "").trim();
  const sessaoStr = d ? `${d} â€” ${nowStr}` : `â€” â€” ${nowStr}`;

  const dotColor = opened ? "var(--good)" : "var(--bad)";
  ["sessaoDotLogin","sessaoDotCons","paySessaoDot","sessaoDotWait","sessaoDotPres"].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.background = dotColor;
  });

  const sessaoLabel = opened ? "SessÃ£o aberta" : "SessÃ£o fechada";
  const sessaoLine = `${sessaoLabel} â€” ${sessaoStr}`;
  setTextId("sessaoLineLogin", sessaoLine);
  setTextId("sessaoLineCons", sessaoLine);
  setTextId("paySessaoLine", sessaoLine);
  setTextId("sessaoLineWait", sessaoLine);
  setTextId("sessaoLinePres", sessaoLine);
  setTextId("sessaoStatus", opened ? "Aberta" : "Fechada");
  setTextId("lastCheck", now.toLocaleString("pt-BR"));

  updateEnvelopeUI();
}

applyBrand();
updateConvocacaoBadge();

/* ==========================
   PRODUCTS / TOTAL
========================== */
function animateTotal(to){
  const el1 = $("#totalValue");
  const el2 = $("#payTotal");
  const el3 = $("#pixValor");
  if(!el1 || !el2 || !el3 ) { lastTotal = to; return; }

  const from = Math.round(lastTotal);
  const target = Math.round(to);

  if(from === target){
    el1.textContent = fmtBRL(to);
    el2.textContent = fmtBRL(to);
    el3.textContent = fmtBRL(to);
    lastTotal = to;
    return;
  }
  const dir = target > from ? 1 : -1;
  let cur = from;
  const stepMs = 18;
  const timer = setInterval(()=>{
    cur += dir;
    el1.textContent = fmtBRL(cur);
    el2.textContent = fmtBRL(cur);
    el3.textContent = fmtBRL(cur);

    if(cur === target){
      clearInterval(timer);
      el1.textContent = fmtBRL(to);
      el2.textContent = fmtBRL(to);
      el3.textContent = fmtBRL(to);
      lastTotal = to;
    }
  }, stepMs);
}

function renderProducts(){
  const list=$("#prodList");
  list.innerHTML="";
  const produtos=Array.isArray(CFG?.produtos)?CFG.produtos:[];
  const cart=getCart();

  if(produtos.length===0){
    list.innerHTML='<div style="color:rgba(255,255,255,.65)">Sem produtos no JSON.</div>';
    return;
  }

  for(const p of produtos){
    const q=Number(cart[p.id]||0);
    const row=document.createElement("div");
    row.className="prodRow";
    row.innerHTML=`
      <div class="pIcon"><img src="${p.icon || './assets/icon-192.png'}" alt=""></div>
      <div class="pMid">
        <div class="pName">${p.nome||"Produto"}</div>
        <div class="pDesc">${p.desc||""}</div>
        <div class="pPrice">${fmtBRL(Number(p.preco||0))}</div>
      </div>
      <div class="qtyWrap">
        <button class="qtyBtn" data-act="dec" data-id="${p.id}">âˆ’</button>
        <div class="qty" id="qty_${p.id}">${q}</div>
        <button class="qtyBtn" data-act="inc" data-id="${p.id}">+</button>
      </div>
    `;
    list.appendChild(row);
  }
  updateTotal();
}

function updateTotal(){
  const cart=getCart();
  const produtos=Array.isArray(CFG?.produtos)?CFG.produtos:[];
  let total=0;
  for(const p of produtos){
    total += Number(cart[p.id]||0)*Number(p.preco||0);
  }
  animateTotal(total);
  return total;
}

function findIrmao(tel,cim){
  tel=String(tel||"").replace(/\D/g,"");
  cim=String(cim||"").trim();
  return (Array.isArray(CFG?.irmaos)?CFG.irmaos:[]).find(i =>
    String(i.telefone||"").replace(/\D/g,"")===tel &&
    String(i.cim||"").trim()===cim
  );
}

function applyRememberedUser(){
  const u = getUser();
  const telWrap = document.getElementById("telWrap");
  const telInp  = document.getElementById("inpTel");
  const welcome = document.getElementById("welcomeTitle");
  const hasPhone = !!(u && u.telefone && String(u.telefone).trim());

  if (hasPhone){
    if (telWrap) telWrap.style.display = "none";
    if (telInp) {
      telInp.value = String(u.telefone);
      telInp.disabled = true;
    }
    if (welcome && u.nome) welcome.textContent = `Bem-vindo, ${u.nome} ğŸ‘‹`;
  } else {
    if (telWrap) telWrap.style.display = "";
    if (telInp) {
      telInp.disabled = false;
    }
    if (welcome) welcome.textContent = "Bem-vindo ğŸ‘‹";
  }
}

function setupAdminTap(){
  const logos = [$("#brandLogo"), $("#brandLogoWait")].filter(Boolean);
  for(const el of logos){
    el.addEventListener("click", ()=>{
      adminTapCount++;
      clearTimeout(adminTapTimer);
      adminTapTimer=setTimeout(()=>adminTapCount=0, 1200);
      if(adminTapCount>=2){
        adminTapCount=0;
        openAdmin();
      }
    });
  }
}

/* ==========================
   WAIT POLLING
========================== */
function nowDT(){ return new Date().toLocaleString("pt-BR"); }

function stopWaitPolling(){
  if(waitTimer){ clearInterval(waitTimer); waitTimer=null; }
  if(waitOpenTimer){ clearInterval(waitOpenTimer); waitOpenTimer=null; }
  waitPollingStarted=false;
}

function startWaitPolling(){
  if(waitPollingStarted) return;
  waitPollingStarted=true;
  stopWaitPolling();

  const tick = async ()=>{
    try{
      setText('lastCheck', nowDT());
      CFG = await loadConfig();
      updateConvocacaoBadge();
      initCashFromConfig();
      applyBrand();
      
      try{ updatePresenceConfirmedWait(); }catch(_){}
      try{ if(typeof startWaitPresencaFX==="function") startWaitPresencaFX(); }catch(_){}
      
      renderCash();

      if(sessionIsOpen()){
        stopWaitPolling();
        showScreen("scr_login","forward");
      }
    }catch(_){}
  };

  tick();
  waitTimer = setInterval(tick, 6000);

  waitOpenTimer = setInterval(async ()=>{
    if(currentScreen !== 'scr_wait') return;
    try{
      CFG = await loadConfig();
      applyBrand();
      if(sessionIsOpen()){
        stopWaitPolling();
        showScreen('scr_login','forward');
      }
    }catch(_){}
  }, 15000);
}

/* ==========================
   PAY FLOW
========================== */
function buildPayScreen(){
  payReady = false;
  setTimeout(()=>{ payReady = true; }, 350);

  applyBrand();

  const u = getUser() || {};
  const nome = (u.nome||"").trim();
  setText("payHello", nome ? `Oi meu irmÃ£o, ${nome}!` : "Oi meu irmÃ£o!");

  const total = updateTotal();
  setText("payTotal", fmtBRL(total));
  setText("pixValor", fmtBRL(total));

  const cart = getCart();
  const entries = cartEntries(cart).filter(x=>x.qtd>0);

  const prods = (CFG && Array.isArray(CFG.produtos)) ? CFG.produtos : [];
  const byId = Object.fromEntries(prods.map(p=>[String(p.id), p]));

  const lines = entries.map(e=>{
    const p = byId[e.id] || {};
    const nomeP = p.nome || `Item ${e.id}`;
    const preco = Number(p.preco||0);
    const sub = e.qtd * preco;
    return {q:e.qtd, nome:nomeP, sub};
  });

  const box = document.getElementById("payItems");
  if(box){
    if(lines.length===0){
      box.innerHTML = `<div style="opacity:.75;font-weight:900">Nenhum item selecionado.</div>`;
    }else{
      box.innerHTML = lines.map(l=>{
        const left = `${l.q} ${l.nome}`;
        const right = fmtBRL(l.sub);
        return `<div class="payItemRow"><div class="payItemLeft">${escapeHtml(left)}</div><div class="payItemDots"></div><div class="payItemRight">${escapeHtml(right)}</div></div>`;
      }).join("");
    }
  }
}

function openPixModal(){
  const total = updateTotal();
  const key = (CFG && CFG.loja && CFG.loja.pix_chave) ? String(CFG.loja.pix_chave).trim() : "";
  if(!key){ toast("Chave Pix nÃ£o configurada"); return; }

  const elValor = document.getElementById("pixValor");
  if(elValor) elValor.textContent = fmtBRL(total);

  const payload = buildPixPayload({
    key,
    amount: total,
    merchantName: (CFG && CFG.loja && CFG.loja.nome) ? CFG.loja.nome : "AGAPE",
    merchantCity: (CFG && CFG.loja && CFG.loja.cidade) ? CFG.loja.cidade : "BRASIL",
    txid: "AGAPE"
  });

  const elCode =
    document.getElementById("pixChaveModal") ||
    document.getElementById("pixChave") ||
    document.getElementById("pixKeyText") ||
    null;

  if(elCode) elCode.textContent = payload;

  const modal = document.getElementById("pixModal");
  if(modal) modal.classList.remove("hidden");
}

function closePixModal(){
  const modal = document.getElementById("pixModal");
  if(modal) modal.classList.add("hidden");
}

async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); toast("Copiado âœ…"); }
  catch(_){
    const ta=document.createElement("textarea");
    ta.value=txt; ta.style.position="fixed"; ta.style.left="-9999px";
    document.body.appendChild(ta); ta.focus(); ta.select();
    try{ document.execCommand("copy"); toast("Copiado âœ…"); } catch(__){ toast("NÃ£o foi possÃ­vel copiar"); }
    document.body.removeChild(ta);
  }
}

function showPaySuccess(){
  const ps = document.getElementById("paySuccess");
  if(ps) ps.classList.remove("hidden");
  const gif = document.getElementById("payGif");
  if(gif){
    const src = gif.getAttribute("src") || "./assets/check.gif";
    gif.setAttribute("src", src.split("?")[0] + "?t=" + Date.now());
  }
  try{
    const a = new Audio("./assets/coin.mp3");
    a.play().catch(()=>{});
  }catch(e){}
}

function hidePaySuccess(){
  const ps = document.getElementById("paySuccess");
  if(ps) ps.classList.add("hidden");
}

function finalizePayment(tipo, msg){
  const total = updateTotal();
  if(tipo === "dinheiro" || tipo === "pix"){
    setCash(getCash() + Number(total || 0));
    renderCash();
  }

  toast(msg);
  clearCart();
  updateTotal();
  closePixModal();
  showPaySuccess();

  setTimeout(()=>{
    hidePaySuccess();
    showScreen("scr_login","back");
  }, 2200);
}

/* ==========================
   EXIT
========================== */
function sairDoAplicativo(){
  //try{ localStorage.removeItem(LS_USER); }catch(_){}
  try{ localStorage.removeItem(LS_CART); }catch(_){}
  try{ sessionStorage.clear(); }catch(_){}
  setTimeout(()=>{
    try{ window.location.href = "about:blank"; }catch(_){}
    try{ window.close(); }catch(_){}
  }, 80);
}

/* ==========================
   PUSH HELPERS (âœ… agora no lugar certo)
========================== */
function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

const VAPID_PUBLIC_KEY = "BCtLtf7ypOpSkMuuN_OmoV-jm7t6Fk34uMkK3wtjZUaw5hUBZwfs2XfGOb5WL1UzE-5uRDf_jSCYlu35wcFtRY4";
const PUSH_SUBSCRIBE_URL = "https://api.erpimpar.com.br/agape/push/push_subscribe.php";

/* ==========================
   REGISTER PUSH (âœ… mÃ­nimo + sem duplicar inscriÃ§Ã£o)
========================== */
async function registerPush() {
  if (!("serviceWorker" in navigator)) return;

  const reg = await navigator.serviceWorker.ready;

  const permission = await Notification.requestPermission();
  if (permission !== "granted") {
    console.warn("PermissÃ£o de notificaÃ§Ã£o negada");
    return;
  }

  // evita duplicar / re-assinar toda vez
  let subscription = await reg.pushManager.getSubscription();

  if (!subscription) {
    subscription = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
    });
  }

  const sub = subscription.toJSON();

  await fetch(PUSH_SUBSCRIBE_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(sub)
  });

  console.log("Push registrado com sucesso");
}

/* ==========================
   BOOT
========================== */
async function boot(){
  // 1) Service Worker
  if("serviceWorker" in navigator){
    try{
      await navigator.serviceWorker.register("./service-worker.js");
      console.log("SW registrado");
    }catch(e){
      console.warn("Erro SW", e);
    }
  }

  // 2) Config primeiro
try{
  CFG = await loadConfig();   // <- mantenha assim
  try{ updatePresenceConfirmedWait(); }catch(_){}
  try{ if(typeof startWaitPresencaFX==="function") startWaitPresencaFX(); }catch(_){}
  try{ updateConvocacaoBadge(); }catch(_){}
}catch(_){
  // fallback, se precisar
}


  // 3) SÃ³ tenta push se estiver habilitado no JSON
  try{
    if (CFG?.push?.habilitado === true) {
      await registerPush();
    }
  }catch(e){
    console.warn("Push nÃ£o registrado", e);
  }

  setTimeout(()=>{
    const img = document.getElementById("splashSymbol");
    if(img) img.src = "./assets/maconaria.gif";
  }, 1200);

  setTimeout(()=>{ showScreen("scr_splash2","forward"); }, GIF_TIME);

  setTimeout(()=>{
    applyBrand();
    initCashFromConfig();
    renderCash();
    applyRememberedUser();
    setupAdminTap();
    bindPresencaUI();
    refreshPresenceUI();
    updateEnvelopeUI();

    if(sessionIsOpen()){
      showScreen("scr_login","forward");
    }else{
      showScreen("scr_wait","forward");
      startWaitPolling();
    }
  }, GIF_TIME + ZOOM_TIME);

  // LOGIN
  document.getElementById("btnEntrar")?.addEventListener("click", async ()=>{
    const u = getUser();
    const savedTel = u?.telefone ? String(u.telefone).replace(/\D/g,"") : "";

    const telInp = document.getElementById("inpTel");
    const tel = savedTel || (telInp ? String(telInp.value||"").replace(/\D/g,"") : "");

    const cimInp = document.getElementById("inpCIM");
    const cim = cimInp ? String(cimInp.value||"").trim() : "";

    if(!tel){ toast("Digite o telefone"); return; }
    if(!cim){ toast("Digite o CIM"); return; }

    try{ CFG = await loadConfig(); }catch(_){}
    applyBrand();

    const irmao = findIrmao(tel, cim);
    if(!irmao){ toast("CIM invÃ¡lido"); return; }

    setUser({ nome: irmao.nome, telefone: String(irmao.telefone).replace(/\D/g,"") });
    applyRememberedUser();

    if(!sessionIsOpen()){
      toast("SessÃ£o fechada (tesoureiro precisa abrir)");
      showScreen("scr_wait","forward");
      startWaitPolling();
      return;
    }

    renderProducts();
    lastTotal = 0;
    updateTotal();
    initCashFromConfig();
    renderCash();
    showScreen("scr_consumo","forward");
  });

  // QTY
  document.addEventListener("click",(e)=>{
    const btn=e.target.closest(".qtyBtn");
    if(!btn) return;
    const id=btn.getAttribute("data-id");
    const act=btn.getAttribute("data-act");
    const cart=getCart();
    const cur=Number(cart[id]||0);
    cart[id]= act==="inc" ? cur+1 : Math.max(0, cur-1);
    setCart(cart);
    const el=document.getElementById("qty_"+id);
    if(el) el.textContent=String(cart[id]);
    updateTotal();
  });

  // FECHAR -> PAGAMENTO
  document.getElementById("btnFechar")?.addEventListener("click", ()=>{
    const total = updateTotal();
    if(total<=0){ toast("Selecione ao menos 1 item"); return; }
    buildPayScreen();
    hidePaySuccess();
    closePixModal();
    showScreen("scr_pagamento","forward");
  });

  document.getElementById("btnVoltarConsumo")?.addEventListener("click", ()=>{
    closePixModal();
    hidePaySuccess();
    showScreen("scr_consumo","back");
  });

  document.getElementById("btnSair")?.addEventListener("click", ()=>{
    closePixModal();
    hidePaySuccess();
    clearCart();
    const cim = document.getElementById("inpCIM"); if(cim) cim.value="";
    showScreen("scr_login","back");
    toast("Saiu");
  });

  document.getElementById("btnSairWait")?.addEventListener("click", ()=>{
    if(confirm("Deseja sair do aplicativo?")) sairDoAplicativo();
  });

  document.getElementById("btnSairLogin")?.addEventListener("click", sairDoAplicativo);

  // PAY
  document.getElementById("btnPix")?.addEventListener("click", ()=>{
    if(!payReady) return;
    openPixModal();
  });
  document.getElementById("btnDinheiro")?.addEventListener("click", ()=>{
    if(!payReady) return;
    finalizePayment("dinheiro", "Registrado: dinheiro");
  });
  document.getElementById("btnProxima")?.addEventListener("click", ()=>{
    if(!payReady) return;
    finalizePayment("proxima", "Registrado: prÃ³xima sessÃ£o");
  });

  document.getElementById("btnCopyPix")?.addEventListener("click", ()=>{
    const el = document.getElementById("pixChaveModal");
    const payload = el ? (el.textContent || "").trim() : "";
    if(!payload){ toast("CÃ³digo Pix vazio"); return; }
    copyText(payload);
  });

  ["btnPixCancel","btnPixCancel2"].forEach(id=>{
    const b = document.getElementById(id);
    if(b) b.addEventListener("click", closePixModal);
  });

  document.getElementById("btnPixOk")?.addEventListener("click", ()=>{
    if(!payReady) return;
    finalizePayment("pix", "Registrado: pix");
  });
}

/* ======== PRESENÃ‡A (mantido como vocÃª tinha) ======== */
function highlightPresenceChoice(chosenId){
  const ids = ["btnRespSessaoAgape","btnRespSessao","btnRespAgape"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove("isChosen");
  });

  const chosen = document.getElementById(chosenId);
  if(chosen) chosen.classList.add("isChosen");
}
document.getElementById("btnRespSessaoAgape")?.addEventListener("click", ()=>{
  setPresencaAns("sessao_agape");
  highlightPresenceChoice("btnRespSessaoAgape");
  refreshPresenceUI();
  updateEnvelopeUI();
});

document.getElementById("btnRespSessao")?.addEventListener("click", ()=>{
  setPresencaAns("somente_sessao");
  highlightPresenceChoice("btnRespSessao");
  refreshPresenceUI();
  updateEnvelopeUI();
});

document.getElementById("btnRespAgape")?.addEventListener("click", ()=>{
  setPresencaAns("somente_agape");
  highlightPresenceChoice("btnRespAgape");
  refreshPresenceUI();
  updateEnvelopeUI();
});

const PRES_SUCCESS_MS = 6000;

function highlightPresenceChoiceByVal(ans){
  const map = {
    "sessao_agape": "btnRespSessaoAgape",
    "somente_sessao": "btnRespSessao",
    "somente_agape": "btnRespAgape",
  };
  const chosenId = map[String(ans||"")];
  const ids = ["btnRespSessaoAgape","btnRespSessao","btnRespAgape"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove("isChosen");
  });
  if(chosenId){
    const chosen = document.getElementById(chosenId);
    if(chosen) chosen.classList.add("isChosen");
  }
}

function showPresSuccess(){
  const ov = document.getElementById("presSuccess");
  if(ov) ov.classList.remove("hidden");

  const gif = document.getElementById("presGif");
  if(gif){
    const src = gif.getAttribute("src") || "./assets/presenca.gif";
    gif.setAttribute("src", src.split("?")[0] + "?t=" + Date.now());
  }
}
function hidePresSuccess(){
  const ov = document.getElementById("presSuccess");
  if(ov) ov.classList.add("hidden");
}

function updatePresenceConfirmedWait(){
  const el = document.getElementById("waitPresencaOk");
  if(!el) return;
  const ans = (typeof getPresencaAns === "function") ? (getPresencaAns() || "") : "";
  el.classList.toggle("hidden", !ans);
  startWaitPresencaFX();
}

let _waitPresFxTimer = null;  
  
function startWaitPresencaFX(){
  const el = document.getElementById("waitPresencaOk");
  if(!el) return;

  // evita duplicar timers
  if(_waitPresFxTimer){ clearInterval(_waitPresFxTimer); _waitPresFxTimer = null; }

  const pick = (arr)=> arr[Math.floor(Math.random()*arr.length)];

  const applyOnce = ()=>{
    // sÃ³ anima se realmente tem resposta
    const ans = (typeof getPresencaAns === "function") ? (getPresencaAns() || "") : "";
    if(!ans || el.classList.contains("hidden")){
      el.classList.remove("pulse","blink");
      return;
    }

    const label =
      ans === "sessao_agape" ? "SESSÃƒO E ÃGAPE" :
      ans === "somente_sessao" ? "SOMENTE SESSÃƒO" :
      ans === "somente_agape" ? "SOMENTE ÃGAPE" : "â€”";

    // alterna texto (aleatÃ³rio)
    el.textContent = pick([
      "âœ… PRESENÃ‡A JÃ CONFIRMADA",
      `[OK] ESCOLHIDO: ${label}`,
      "âœ… CONFIRMADO COM SUCESSO"
    ]);

    // alterna efeito (aleatÃ³rio)
    el.classList.remove("pulse","blink");
    el.classList.add(pick(["pulse","blink"]));

    // alterna fundo/borda (azuis claros transparentes, aleatÃ³rio)
// alterna fundo/borda (multicores transparentes, aleatÃ³rio)
const bg = pick([
  // AZUIS
  "rgba(80,170,255,.14)",
  "rgba(100,190,255,.18)",
  "rgba(60,160,255,.12)",
  "rgba(120,210,255,.16)",

  // VERDES
  "rgba(60,200,120,.14)",
  "rgba(80,220,150,.18)",
  "rgba(40,180,110,.12)",
  "rgba(100,240,190,.16)",

  // AMARELOS (dourado suave)
  "rgba(255,215,0,.14)",
  "rgba(255,200,60,.16)",

  // VERMELHO SUAVE (alerta leve, sem assustar)
  "rgba(255,80,80,.10)",
  "rgba(255,120,120,.12)"
]);

const bd = pick([
  // AZUIS
  "rgba(140,210,255,.26)",
  "rgba(170,230,255,.30)",
  "rgba(120,200,255,.22)",
  "rgba(190,240,255,.28)",

  // VERDES
  "rgba(120,255,210,.25)",
  "rgba(150,255,220,.28)",
  "rgba(100,240,190,.22)",

  // AMARELOS
  "rgba(255,215,0,.28)",
  "rgba(255,230,120,.22)",

  // VERMELHO SUAVE
  "rgba(255,120,120,.22)",
  "rgba(255,160,160,.18)"
]);

    el.style.background = bg;
    el.style.borderColor = bd;

    // sombra leve Ã s vezes
    el.style.boxShadow = pick([
      "0 10px 26px rgba(0,0,0,.18)",
      "0 8px 20px rgba(0,0,0,.14)",
      "0 0 0 rgba(0,0,0,0)"
    ]);
  };

  // aplica agora e depois em intervalos variÃ¡veis
  applyOnce();
  _waitPresFxTimer = setInterval(applyOnce, pick([1200, 1500, 1800, 2200, 2600]));
}

function confirmPresenca(ans){
  setPresencaRespondida();

  if(typeof setPresencaAns === "function") setPresencaAns(ans);

  refreshPresenceUI();            // retÃ¢ngulo / texto atualiza na hora
  updateEnvelopeUI();
  updatePresenceConfirmedWait();  // garante o aviso no wait

  showPresSuccess();
  setTimeout(()=>{
    hidePresSuccess();
    showScreen("scr_wait","back");
  }, 3000);
}


function bindPresBtn(id, ans){
  const btn = document.getElementById(id);
  if(!btn || btn.dataset.presBound) return;
  btn.dataset.presBound = "1";

  const handler = (e)=>{
    e?.preventDefault?.();
    confirmPresenca(ans);
  };

  btn.addEventListener("click", handler);
  btn.addEventListener("touchend", (e)=>{ e.preventDefault(); handler(e); }, {passive:false});
}

function initPresencaBlock(){
  bindPresBtn("btnRespSessaoAgape","sessao_agape");
  bindPresBtn("btnRespSessao","somente_sessao");
  bindPresBtn("btnRespAgape","somente_agape");

  try{
    const ans = (typeof getPresencaAns === "function") ? getPresencaAns() : "";
    highlightPresenceChoiceByVal(ans);
  }catch(_){}

  updatePresenceConfirmedWait();
}

initPresencaBlock();

const _oldOpenPresenca = (typeof openPresenca === "function") ? openPresenca : null;
if(_oldOpenPresenca){
  window.openPresenca = function(){
    _oldOpenPresenca();
    try{
      const ans = (typeof getPresencaAns === "function") ? getPresencaAns() : "";
      highlightPresenceChoiceByVal(ans);
      updatePresenceConfirmedWait();
    }catch(_){}
  };
}
// ==========================
// ADMIN (tela completa) - SCRIPT
// Cole no FINAL do seu <script>
// ==========================

// estado
let ADMIN_CFG = null;
let ADMIN_TAB = "cfg";
let ADMIN_BOUND = false;

// opcional: se vocÃª tiver endpoint depois, preencha aqui
const ADMIN_SAVE_URL = "https://api.erpimpar.com.br/agape/consumo/admin_save_config.php";

// ---- helpers seguros (nÃ£o quebram) ----
function adminToastOk(msg){ (typeof toast==="function") ? toast(msg) : alert(msg); }
function adminToastErr(msg){ (typeof toast==="function") ? toast(msg) : alert(msg); }
function adminShow(screen, dir){
  if(typeof showScreen === "function") showScreen(screen, dir || "forward");
  else document.getElementById(screen)?.classList.remove("hidden");
}
function adminHide(screen){
  document.getElementById(screen)?.classList.add("hidden");
}
function adminEl(id){ return document.getElementById(id); }
function adminVal(id){ return (adminEl(id)?.value ?? "").trim(); }
function adminSetVal(id, v){
  const el = adminEl(id);
  if(!el) return;
  el.value = (v ?? "");
}
function adminSanTel(s){
  return String(s || "").replace(/\D+/g,"");
}
function adminJsonPretty(o){
  try{ return JSON.stringify(o, null, 2); }catch(_){ return String(o); }
}
function adminDownloadJson(filename, obj){
  const blob = new Blob([adminJsonPretty(obj)], {type:"application/json;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename || "agape_config.json";
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 300);
}

// ---- Tabs / Panels ----

// Carrega dados do ADMIN_CFG para os campos da aba atual
function adminSyncTabToCfg() {
  console.log("[adminSyncTabToCfg] - Aba:", ADMIN_TAB);
  if(!ADMIN_CFG) { console.warn("âš ï¸ ADMIN_CFG vazio"); return; }
  if(ADMIN_TAB === "cfg") adminSyncCfgTab();
  else if(ADMIN_TAB === "sessao") adminSyncSessaoTab();
  else if(ADMIN_TAB === "irmaos") adminSyncIrmaosTab();
}

function adminSyncCfgTab() {
  if(!ADMIN_CFG) return;
  adminSetVal("a_loja_nome", ADMIN_CFG?.loja?.nome || "");
  adminSetVal("a_loja_sub", ADMIN_CFG?.loja?.subtitulo || "");
  adminSetVal("a_loja_pix", ADMIN_CFG?.loja?.pix_chave || "");
  adminSetVal("a_loja_tes", ADMIN_CFG?.loja?.tesoureiro_whatsapp || "");
  adminSetVal("a_logo_url", ADMIN_CFG?.loja?.logo_url || ADMIN_CFG?.loja?.logo || "");
  const logoUrl = adminVal("a_logo_url") || "./assets/logo-Clementino-Brito.jpeg";
  const logoPreview = document.getElementById("a_logo_preview");
  if(logoPreview) logoPreview.src = logoUrl;
  console.log("[OK] Aba CONFIGURACAO carregada");
}

function adminSyncSessaoTab() {
  if(!ADMIN_CFG) return;
  adminSetVal("a_sessao_status", ADMIN_CFG?.sessao?.status || "fechada");
  adminSetVal("a_sessao_data", ADMIN_CFG?.sessao?.data || "");
  adminSetVal("a_sessao_caixa", ADMIN_CFG?.sessao?.caixa_inicial ?? 0);
  adminSetVal("a_sessao_chamado", ADMIN_CFG?.sessao?.chamado || "");
  adminSetVal("a_conv_on", String(!!ADMIN_CFG?.convocacao?.ativa));
  adminSetVal("a_conv_id", ADMIN_CFG?.convocacao?.id || "");
  adminSetVal("a_conv_titulo", ADMIN_CFG?.convocacao?.titulo || "");
  adminSetVal("a_conv_texto", ADMIN_CFG?.convocacao?.texto || "");
  adminSetVal("a_push_on", String(!!ADMIN_CFG?.push?.habilitado));
  adminSetVal("a_push_titulo", ADMIN_CFG?.push?.titulo || "");
  adminSetVal("a_push_msg", ADMIN_CFG?.push?.mensagem || "");
  adminSetVal("a_push_url", ADMIN_CFG?.push?.url || "");
  console.log("[OK] Aba SESSAO carregada");
}

function adminSyncIrmaosTab() {
  if(!ADMIN_CFG) return;
  const irmaos = Array.isArray(ADMIN_CFG.irmaos) ? ADMIN_CFG.irmaos : [];
  const tbody = document.querySelector("#adminTableIrmaos tbody");
  if(!tbody) { console.warn("âš ï¸ Tabela irmÃ£os nÃ£o encontrada"); return; }
  tbody.innerHTML = "";
  if(irmaos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;opacity:0.6;">Nenhum irmÃ£o cadastrado</td></tr>';
    return;
  }
  irmaos.forEach((irmao, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${idx + 1}</td><td>${irmao.nome || "â€”"}</td><td>${irmao.cim || "â€”"}</td><td>${irmao.telefone || "â€”"}</td>`;
    tbody.appendChild(tr);
  });
  console.log("[OK] Aba IRMAOS carregada - Total: " + irmaos.length);
}


function adminSetActiveTab(tab){
  ADMIN_TAB = tab;

  // ativa botÃµes
  document.querySelectorAll("#scr_admin .adminTab").forEach(b=>b.classList.remove("active"));
  if(tab==="cfg") adminEl("tabCfg")?.classList.add("active");
  if(tab==="sessao") adminEl("tabSessao")?.classList.add("active");
  if(tab==="irmaos") adminEl("tabIrmaos")?.classList.add("active");

  // mostra painÃ©is
  adminEl("adminViewCfg")?.classList.toggle("hidden", tab!=="cfg");
  adminEl("adminViewSessao")?.classList.toggle("hidden", tab!=="sessao");
  adminEl("adminViewIrmaos")?.classList.toggle("hidden", tab!=="irmaos");

  // render
  if(tab==="cfg") adminRenderCfg();
  if(tab==="sessao") adminRenderSessao();
  if(tab==="irmaos") adminRenderIrmaos();
}

// ---- Render (preencher inputs) ----
function adminRenderCfg(){
  if(!ADMIN_CFG) return;

  adminSetVal("a_loja_nome", ADMIN_CFG?.loja?.nome || "");
  adminSetVal("a_loja_sub", ADMIN_CFG?.loja?.subtitulo || "");
  adminSetVal("a_loja_pix", ADMIN_CFG?.loja?.pix_chave || "");
  adminSetVal("a_loja_tes", ADMIN_CFG?.loja?.tesoureiro_whatsapp || "");
  adminSetVal("a_logo_url", ADMIN_CFG?.ui?.logo_url || ADMIN_CFG?.loja?.logo || "");

  // logo preview
  const logoUrl = adminVal("a_logo_url") || ADMIN_CFG?.ui?.logo_url || "./assets/logo-Clementino-Brito.jpeg";
  const img = adminEl("adminLogo");
  if(img) img.src = logoUrl;
}

function adminRenderSessao(){
  if(!ADMIN_CFG || !ADMIN_CFG.sessao) return;

  adminSetVal("a_sessao_status", ADMIN_CFG.sessao.status || "aberta");
  adminSetVal("a_sessao_data", ADMIN_CFG.sessao.data || "");
  adminSetVal("a_sessao_caixa", String(ADMIN_CFG.sessao.caixa_inicial || 0));
  adminSetVal("a_sessao_chamado", ADMIN_CFG.sessao.chamado || "");

  if(!ADMIN_CFG.convocacao) ADMIN_CFG.convocacao = {};
  if(!ADMIN_CFG.push) ADMIN_CFG.push = {};

  adminSetVal("a_conv_id", ADMIN_CFG.convocacao.id || "");
  adminSetVal("a_conv_titulo", ADMIN_CFG.convocacao.titulo || "");
  adminSetVal("a_conv_texto", ADMIN_CFG.convocacao.texto || "");

  const convCheckbox = document.getElementById("a_conv_on");
  if(convCheckbox) convCheckbox.checked = !!ADMIN_CFG.convocacao.ativa;

  adminSetVal("a_push_titulo", ADMIN_CFG.push.titulo || "");
  adminSetVal("a_push_msg", ADMIN_CFG.push.mensagem || "");
  adminSetVal("a_push_url", ADMIN_CFG.push.url || "");

  const pushCheckbox = document.getElementById("a_push_on");
  if(pushCheckbox) pushCheckbox.checked = !!ADMIN_CFG.push.habilitado;
}

function adminStatusPill(status){
  const s = String(status || "").toLowerCase();
  if(s.includes("sessÃ£o e Ã¡gape") || s.includes("sessao e agape")) return `<span class="pill ok">SESSÃƒO E ÃGAPE</span>`;
  if(s.includes("somente Ã¡gape") || s.includes("somente agape")) return `<span class="pill warn">SOMENTE ÃGAPE</span>`;
  if(s.includes("somente sessÃ£o") || s.includes("somente sessao")) return `<span class="pill warn">SOMENTE SESSÃƒO</span>`;
  if(s.includes("nÃ£o confirmado") || s.includes("nao confirmado")) return `<span class="pill bad">NÃƒO CONFIRMADO</span>`;
  return `<span class="pill">${status || "-"}</span>`;
}

function adminRenderIrmaos(){
  const wrap = document.getElementById("adminIrmaosWrap");
  if(!wrap) return;
  if(!ADMIN_CFG || !ADMIN_CFG.irmaos){
    wrap.innerHTML = "<p style="color:#999;">Nenhum irmÃ£o cadastrado.</p>";
    return;
  }

  const irmaos = ADMIN_CFG.irmaos || [];
  let presencaMap = {};
  try{
    presencaMap = JSON.parse(localStorage.getItem("agape_presenca_v1") || "{}");
  } catch {}

  let totalConfirmados = 0;
  let totalSessaoAgape = 0;
  let totalSomenteSessao = 0;
  let totalSomenteAgape = 0;

  const rows = irmaos.map((irmao, i) => {
    const nome = irmao.nome || "Sem nome";
    const tel = irmao.telefone || "â€”";
    let statusStr = "NÃ£o confirmou";
    let statusClass = "status-nao";

    const ans = presencaMap[tel];
    if(ans){
      totalConfirmados++;
      if(ans === "sessao_e_agape"){
        statusStr = "SessÃ£o e Ãgape";
        statusClass = "status-ok";
        totalSessaoAgape++;
      } else if(ans === "somente_sessao"){
        statusStr = "Somente SessÃ£o";
        statusClass = "status-parcial";
        totalSomenteSessao++;
      } else if(ans === "somente_agape"){
        statusStr = "Somente Ãgape";
        statusClass = "status-parcial";
        totalSomenteAgape++;
      }
    }
    return `<tr><td>${i+1}</td><td>${nome}</td><td>${tel}</td><td><span class="${statusClass}">${statusStr}</span></td></tr>`;
  }).join("");

  wrap.innerHTML = `
<style>
  .adminResumo { margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; }
  .rTitle { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
  .rLine { display: flex; justify-content: space-between; margin: 0.25rem 0; font-size: 0.9rem; }
  .rLabel { opacity: 0.8; }
  .rValue { font-weight: 600; }
  .status-ok { color: #10b981; font-weight: 600; }
  .status-parcial { color: #f59e0b; font-weight: 600; }
  .status-nao { color: #ef4444; font-weight: 400; }
</style>
<div class="adminResumo">
  <div class="rTitle">Resumo de PresenÃ§a</div>
  <div class="rLine"><span class="rLabel">Confirmados:</span><span class="rValue">${totalConfirmados}</span></div>
  <div class="rLine"><span class="rLabel">NÃ£o confirmaram:</span><span class="rValue">${irmaos.length - totalConfirmados}</span></div>
  <div class="rLine"><span class="rLabel">SessÃ£o e Ãgape:</span><span class="rValue">${totalSessaoAgape}</span></div>
  <div class="rLine"><span class="rLabel">Somente SessÃ£o:</span><span class="rValue">${totalSomenteSessao}</span></div>
  <div class="rLine"><span class="rLabel">Somente Ãgape:</span><span class="rValue">${totalSomenteAgape}</span></div>
</div>
<table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">
  <thead>
    <tr style="background: rgba(255,255,255,0.1);">
      <th style="padding:0.5rem; text-align:left;">#</th>
      <th style="padding:0.5rem; text-align:left;">Nome</th>
      <th style="padding:0.5rem; text-align:left;">Telefone</th>
      <th style="padding:0.5rem; text-align:left;">Status</th>
    </tr>
  </thead>
  <tbody>
    ${rows}
  </tbody>
</table>
`;
}

// ---- Coletar alteraÃ§Ãµes do painel atual ----
function adminApplyCurrentTabToCfg(){
  if(!ADMIN_CFG) return;
  const tab = ADMIN_CURRENT_TAB;

  if(tab === "cfg"){
    if(!ADMIN_CFG.loja) ADMIN_CFG.loja = {};
    if(!ADMIN_CFG.ui) ADMIN_CFG.ui = {};
    ADMIN_CFG.loja.nome = adminVal("a_loja_nome");
    ADMIN_CFG.loja.subtitulo = adminVal("a_loja_sub");
    ADMIN_CFG.loja.pix = adminVal("a_loja_pix");
    ADMIN_CFG.loja.tesoureiro_whatsapp = adminVal("a_loja_tes");
    const logoUrl = adminVal("a_logo_url");
    if(logoUrl) ADMIN_CFG.ui.logo_url = logoUrl;
  }

  if(tab === "sessao"){
    if(!ADMIN_CFG.sessao) ADMIN_CFG.sessao = {};
    if(!ADMIN_CFG.push) ADMIN_CFG.push = {};
    if(!ADMIN_CFG.convocacao) ADMIN_CFG.convocacao = {};

    ADMIN_CFG.sessao.status = adminVal("a_sessao_status");
    ADMIN_CFG.sessao.data = adminVal("a_sessao_data");
    ADMIN_CFG.sessao.caixa_inicial = parseFloat(adminVal("a_sessao_caixa") || "0");
    ADMIN_CFG.sessao.chamado = adminVal("a_sessao_chamado");

    const pushCheckbox = document.getElementById("a_push_on");
    ADMIN_CFG.push.habilitado = pushCheckbox ? pushCheckbox.checked : false;
    ADMIN_CFG.push.titulo = adminVal("a_push_titulo");
    ADMIN_CFG.push.mensagem = adminVal("a_push_msg");
    ADMIN_CFG.push.url = adminVal("a_push_url");

    const convCheckbox = document.getElementById("a_conv_on");
    ADMIN_CFG.convocacao.ativa = convCheckbox ? convCheckbox.checked : false;
    ADMIN_CFG.convocacao.id = adminVal("a_conv_id");
    ADMIN_CFG.convocacao.titulo = adminVal("a_conv_titulo");
    ADMIN_CFG.convocacao.texto = adminVal("a_conv_texto");
  }
}

// async function adminLoadResumoConsumo(sessao_id){
//   try{
//     const r = await fetch("https://api.erpimpar.com.br/agape/consumo/agape_config.json");
//     if(!r.ok) throw new Error("HTTP " + r.status);
//     const j = await r.json().catch(()=> ({}));
// 
//     // aqui vocÃª decide o formato do JSON retornado.
//     // Vou assumir algo assim:
//     // { ok:true, totals:{irmaos_total:31, nao_confirmaram:25, por_pagamento:{dinheiro:10,pix:20,pendente:5}, caixa:10}, produtos:[{desc,qtd}] }
// 
//     if(!j || j.ok !== true){
//       console.warn("resumo invÃ¡lido", j);
//       return;
//     }
// 
//     // joga no HTML (ids que vocÃª vai criar no layout)
//     setText("adm_tot_irmaos", j.totals?.irmaos_total ?? "â€”");
//     setText("adm_tot_nao", j.totals?.nao_confirmaram ?? "â€”");
// 
//     setText("adm_tot_dinheiro", money(j.totals?.por_pagamento?.dinheiro ?? 0));
//     setText("adm_tot_pix",      money(j.totals?.por_pagamento?.pix ?? 0));
//     setText("adm_tot_pendente", money(j.totals?.por_pagamento?.pendente ?? 0));
//     setText("adm_tot_caixa",    money(j.totals?.caixa ?? 0));
// 
//   }catch(e){
//     console.warn("admin resumo erro", e);
//   }
// }
// 
// function setText(id, v){
//   const el = document.getElementById(id);
//   if(el) el.textContent = String(v);
// }
// 
// function money(n){
//   const x = Number(n||0);
//   return x.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
// }
// 
//   
// ---- Load (OpÃ§Ã£o A: CFG puro) ----
async function adminLoadFromServer(){
  try{
    // lÃª o MESMO JSON cru que o app jÃ¡ lÃª
    const r = await fetch("https://api.erpimpar.com.br/agape/consumo/agape_config.json");
    if(!r.ok){
      console.warn("admin_get_config fail", r.status);
      adminToastErr("NÃ£o carregou config do servidor" + a_conv_id + ADMIN_CFG?.convocacao?.id);
      return;
    }
    const j = await r.json().catch(()=> ({}));
    ADMIN_CFG = j;

    // default tab
    ADMIN_TAB = "cfg";
    adminSetActiveTab("cfg");

    adminToastOk("Admin pronto âœ…" + a_conv_id + ADMIN_CFG?.convocacao?.id);
  }catch(e){
    console.warn(e);
    adminToastErr("Erro carregando Admin");
  }
  // adminLoadResumoConsumo removido - causava erro "resumo invÃ¡lido"
}

// ---- Save (seguro) ----
async function adminSave(){
  if(!ADMIN_CFG) return;

  // aplica alteraÃ§Ãµes
  adminApplyCurrentTabToCfg();

  // sempre guarda draft local (pra nÃ£o perder nada ao sair)
  localStorage.setItem("AGAPE_ADMIN_DRAFT", adminJsonPretty(ADMIN_CFG));

  // mostra JSON na tela (copiar/baixar)
  const box = adminEl("adminJsonBox");
  if(box){
    box.classList.remove("hidden");
    box.textContent = adminJsonPretty(ADMIN_CFG);
  }

  // se tiver endpoint, tenta postar
  if(typeof ADMIN_SAVE_URL === "string" && ADMIN_SAVE_URL){
    try{
      const rr = await fetch(ADMIN_SAVE_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ config: ADMIN_CFG })
      });
      if(!rr.ok) throw new Error("HTTP " + rr.status);
      adminToastOk("Salvo no servidor âœ…");
      return;
    }catch(e){
      console.warn("ADMIN_SAVE_URL falhou, mantendo rascunho local", e);
      adminToastErr("NÃ£o salvou no servidor (mantido rascunho local)");
      return;
    }
  }

  // sem endpoint: oferece download
  adminToastOk("Rascunho salvo âœ… (local) â€” JSON pronto para copiar/baixar");
}

// ---- Bind UI (apenas 1x) ----
function adminBindUI(){
  if(ADMIN_BOUND) return;
  ADMIN_BOUND = true;

  adminEl("tabCfg")?.addEventListener("click", ()=>adminSetActiveTab("cfg"));
  adminEl("tabSessao")?.addEventListener("click", ()=>adminSetActiveTab("sessao"));
  adminEl("tabIrmaos")?.addEventListener("click", ()=>adminSetActiveTab("irmaos"));

  adminEl("btnAdminSair")?.addEventListener("click", ()=>{
    // sair NÃƒO salva no servidor. MantÃ©m rascunho local (draft) automaticamente.
    adminHide("scr_admin");
    if(typeof showScreen==="function") showScreen("scr_login","back");
  });

  adminEl("btnAdminSalvar")?.addEventListener("click", async ()=>{
    await adminSave();
  });

  // duplo clique no JSON abre download
  adminEl("adminJsonBox")?.addEventListener("dblclick", ()=>{
    if(!ADMIN_CFG) return;
    adminDownloadJson("agape_config.json", ADMIN_CFG);
  });
}

// ---- Entrar no Admin (senha antes) ----
async function openAdmin(){
  // garante binds
  adminBindUI();

  // garante CFG para pegar telefone (senha)
  let cfgLocal = null;

  if(typeof CFG !== "undefined" && CFG) cfgLocal = CFG;
  else if(typeof loadConfig === "function"){
    try{ cfgLocal = await loadConfig(); }catch(_){}
  }else{
    try{
      const r = await fetch("https://api.erpimpar.com.br/agape/consumo/agape_config.json");
      if(r.ok) cfgLocal = await r.json();
    }catch(_){}
  }

  const telTes = adminSanTel(cfgLocal?.loja?.tesoureiro_whatsapp || "");
  if(!telTes){
    adminToastErr("Falta loja.tesoureiro_whatsapp no JSON");
    return;
  }

  const typed = adminSanTel(prompt("Senha do Admin (telefone do tesoureiro):") || "");
  if(!typed || typed !== telTes){
    adminToastErr("Senha invÃ¡lida");
    return;
  }

  // entrou: mostra tela e carrega dados (OpÃ§Ã£o A)
  showScreen("scr_admin","forward");

  // carrega (com fallback e sem quebrar)
  try{
    await adminLoadFromServer();
    adminToastOk("Admin pronto âœ…");
  }catch(e){
    console.warn(e);
    adminToastErr("Falha ao carregar admin");
    ADMIN_CFG = ADMIN_CFG || {loja:{}, sessao:{}, push:{}, convocacao:{}, irmaos:[], ui:{}};
    adminSetActiveTab("cfg");
  }
}

boot();

</script>
</body>
</html>
