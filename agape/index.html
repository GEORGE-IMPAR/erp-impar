<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#071a2b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./favicon.ico">
  <title>Sistema √Ågape</title>

  <style>
    :root{
      --bad: #ff3b30;
      --bg1:#071a2b;
      --bg2:#0c3a56;
      --glass: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.60);
      --good:#33d07a;
      --blue:#2d8cff;
      --yellow: rgba(255,215,0,.20);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg1); color:var(--text);}
    body{overflow:hidden}

/* ===== Pagamento v25 (top) ===== */
.payCard{
  margin-top:12px;
  padding:16px;
  border-radius:22px;
  background: rgba(0,0,0,.18);
  border:1px solid rgba(255,255,255,.12);
  box-shadow: 0 24px 55px rgba(0,0,0,.32);
}
.payMsg{line-height:1.2}
.payHello{font-weight:1000; font-size:28px; margin-bottom:6px}
.payTotal{font-weight:800; opacity:.95}
/* === Confer√™ncia: limita a lista e cria scroll interno === */
/* === Confer√™ncia: limita a lista e cria scroll interno (6 itens vis√≠veis) === */
#payItems{
  max-height: calc(4 * 36px);      /* 4 linhas */
  overflow-y: auto;               /* scroll √† direita */
  overflow-x: hidden;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
  padding-right: 4px;             /* respiro pro scrollbar */
}
 .background: rgba(255,255,255,.25); border:1px solid rgba(255,255,255,.10);}
.payItemRow{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 0;
  min-height:36px;               /* casa com o calc(6 * 36px) */
}
.payItemLeft{
  font-weight:900;

  flex: 1 1 auto;        /* ocupa s√≥ o espa√ßo dispon√≠vel */
  min-width: 0;          /* üî¥ ESSENCIAL para funcionar com flex */
  
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.payItemDots{flex:1; border-bottom: 2px dotted rgba(255,255,255,.25); height:0; opacity:.9}
.payItemRight{
  font-weight:1000;
  white-space:nowrap;
  flex: 0 0 auto;
}
.payQ{font-weight:1000; font-size:22px; margin:4px 0 12px}
.payIconRow{display:flex; gap:14px; justify-content:center; margin:10px 0 14px}
.payIconBtn{
  width:74px; height:54px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  color:var(--text);
  display:flex; align-items:center; justify-content:center;
  position:relative;
  box-shadow: 0 16px 35px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.06);
  transition: transform .16s ease, box-shadow .16s ease, filter .16s ease;
  cursor:pointer;
}
.payIconBtn:hover{transform: translateY(-1px) scale(1.03); filter:brightness(1.05)}
.payIconBtn:active{transform: translateY(0) scale(.98)}
.payIconBtn::after{
  content: attr(data-tip);
  position:absolute;
  left:50%; top:-10px;
  transform: translate(-50%,-100%);
  padding:6px 10px;
  border-radius:999px;
  background: rgba(0,0,0,.72);
  border:1px solid rgba(255,255,255,.12);
  color:#fff;
  font-weight:900;
  font-size:12px;
  opacity:0;
  pointer-events:none;
  transition: opacity .15s ease, transform .15s ease;
  white-space:nowrap;
}
.payIconBtn:hover::after{opacity:1; transform: translate(-50%,-115%)}
.payIconImg{width:62px; height:30px; object-fit:contain; display:block; filter:drop-shadow(0 2px 8px rgba(0,0,0,.25));}
.paySvg{font-size:26px; line-height:1}
.payBack{margin-top:8px}
.payHint{margin-top:10px; opacity:.70; font-size:12px}

/* Modal */
.modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:999;}
.modal.hidden{display:none;}
.modal::before{content:""; position:absolute; inset:0; background: rgba(0,0,0,.55); backdrop-filter: blur(4px);}
.modalCard{
  position:relative;
  width:min(420px, calc(100% - 36px));
  border-radius:20px;
  padding:16px;
  background: rgba(10,20,32,.92);
  border:1px solid rgba(255,255,255,.14);
  box-shadow: 0 30px 80px rgba(0,0,0,.55);
}
.modalTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
.modalTitle{font-weight:1000; font-size:20px}
.modalX{border:none; background: rgba(255,255,255,.06); color:var(--text); border-radius:12px; padding:8px 10px; font-weight:1000}
.modalText{margin-top:8px; opacity:.85; font-size:13px; line-height:1.35}
.pixValueRow{display:flex; align-items:center; justify-content:space-between; margin-top:14px;
  padding:12px; border-radius:16px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);}
.pixValueLbl{opacity:.80; font-weight:900}
.pixValue{font-weight:1000; font-size:18px}
.pixKeyRow{display:flex; align-items:center; gap:10px; margin-top:12px;
  padding:12px; border-radius:16px; background: rgba(10,200,160,.12); border:1px solid rgba(100,255,230,.25);}
.pixKeyText{flex:1; font-weight:1000; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
.pixCopyBtn{
  width:44px; height:44px; border-radius:14px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
  color:var(--text);
  font-size:20px;
  cursor:pointer;
}
.modalOk{margin-top:14px}
.modalCancel{
  width:100%;
  margin-top:10px;
  padding:12px;
  border-radius:16px;
  border:1px solid red;
  background: rgba(255,0,0,0.5);
  color:var(--text);
  font-weight:900;
}

/* Success overlay */
.paySuccess{
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  width:100vw; height:100vh;
  background: rgba(230,204,24,.96);
}
.paySuccess.hidden{display:none;}
.paySuccessBox{
  background: rgba(255,255,255,.75);
  border-radius:18px;
  padding:16px 18px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  box-shadow: 0 22px 70px rgba(0,0,0,.35);
}
.paySuccessGif{width:140px; height:140px; object-fit:contain; display:block}
.payOkText{font-weight:1000; color:#083018}

/* === v25 pay success overlay (yellow full, gif + text only) === */
.paySuccess{position:fixed; inset:0; background:rgba(230,204,24,.96); display:flex; align-items:center; justify-content:center; z-index:9999;}
.paySuccess.hidden{display:none;}
.paySuccessInner{display:flex; flex-direction:column; align-items:center; gap:14px; text-align:center;}
#payGif{width:160px; height:160px; object-fit:contain; filter:drop-shadow(0 12px 26px rgba(0,0,0,.25));}
.payOkText{font-weight:1000; font-size:22px; color:#053018; text-shadow:0 1px 0 rgba(255,255,255,.35);}


    
    .safe{
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    .screen{
      position:fixed; inset:0;
      display:none;
      background: radial-gradient(1200px 900px at 50% 0%, var(--bg2), var(--bg1));
    }
    .screen.active{display:flex}

    /* Slide transitions */
    .enter-left{transform:translateX(100%); opacity:1}
    .enter-right{transform:translateX(-100%); opacity:1}
    .exit-left{transform:translateX(-100%); opacity:1}
    .exit-right{transform:translateX(100%); opacity:1}
    .screen{transition: transform .46s ease, opacity .46s ease;}
    .screen.active{transform:translateX(0); opacity:1}
    .screen.exit-left,.screen.exit-right,.screen.enter-left,.screen.enter-right{display:flex}

    /* Splash 1 */
    #scr_splash1{
      background:#000 !important;
      align-items:center;
      justify-content:center;
    }

    /* Splash 2 */
    #scr_splash2{align-items:center; justify-content:center; background:#061a2b !important;}
    .splashCenter{display:flex; flex-direction:column; align-items:center; gap:18px; text-align:center; padding:24px;}
    .logoWrap{
      width:92px; height:92px; border-radius:22px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      transform: scale(.78);
      opacity:0;
      animation: logoZoom 3.0s ease forwards;
    }
    .logoWrap img{width:100%; height:100%; object-fit:cover; display:block}
    .brandText{
      font-weight:800; letter-spacing:.3px;
      font-size: 34px;
      transform: scale(.96);
      opacity:0;
      animation: textZoom 3.0s ease forwards;
      animation-delay: .05s;
    }
    @keyframes logoZoom{
      0%{transform:scale(.78); opacity:0}
      30%{opacity:1}
      100%{transform:scale(1.00); opacity:1}
    }
    @keyframes textZoom{
      0%{transform:scale(.96); opacity:0}
      35%{opacity:1}
      100%{transform:scale(1.00); opacity:1}
    }

    /* Card layout */
    .wrap{width:min(420px, 100%); margin:0 auto; padding:16px;}
    .topBrand{
      display:flex; gap:12px; align-items:center;
      padding:14px 16px;
      border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
    }
    .topBrand .bLogo{
      width:46px;height:46px;border-radius:12px; overflow:hidden;
      border:1px solid rgba(255,255,255,.15);
      flex:0 0 auto;
      background: rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center;
    }
    .topBrand .bLogo img{width:100%; height:100%; object-fit:cover; display:block}
    .topBrand .bTxt{line-height:1.15}
    .topBrand .bTxt .bTitle{font-weight:800; font-size:18px; line-height:1.1;}
    .topBrand .bTxt .bSub{font-size:12px; opacity:.85; margin-top:2px;}

    .sessionBar{
      margin-top:14px; display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:14px;
      background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10);
    }
    .dotBig{width:16px;height:16px;border-radius:50%; background:var(--bad); box-shadow:0 0 0 4px rgba(255,0,0,.10);}
    .sessionLine{font-weight:800; font-size:15px; letter-spacing:.2px; flex:1; min-width:0;}

    .card{
      margin-top:14px;
      padding:16px;
      border-radius:22px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 24px 55px rgba(0,0,0,.32);
    }

    .btn{
      width:100%;
      margin-top:14px;
      padding:11px 12px;
      border-radius:14px;
      border:none;
      background: linear-gradient(90deg, #1bb3ff, #3b6cff);
      color:#001018;
      font-weight:900;
      font-size:17px;
      line-height: 1.1 !important;
    }

    .btn2{
      width:100%;
      padding:11px 12px;
      border:none;
      border-radius:14px;
      background: linear-gradient(90deg, #19baff, #3a66ff);
      color:#001018;
      font-weight:1000;
      font-size:17px;
      line-height: 1.1 !important;
    }

    .miniBtn{
      border:1px solid red;
      background: rgba(255,0,0,0.5);
      color: var(--text);
      padding:10px 14px;
      border-radius:14px;
      font-weight:800;
    }


    /* Pix bar */
    .pixBar{
      margin-top:10px; display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px; border-radius:14px;
      background:rgba(10,200,160,.16); border:1px solid rgba(100,255,230,.25);
    }
    .pixBadge{width:64px; height:36px; border-radius:10px; background:rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:center;}
    .pixBadge img{width:70px;height:26px;object-fit:contain;display:block;filter:drop-shadow(0 2px 8px rgba(0,0,0,.25));}
    .pixKey{font-weight:900; font-size:16px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1; min-width:0;}

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.75);
      color:white; padding:10px 14px;
      border-radius:14px;
      opacity:0; pointer-events:none;
      transition: opacity .25s ease;
      font-weight:800;
      z-index:99999;
    }
    .toast.show{opacity:1}

    /* Wait envelope */
    .waitCard{ position:relative; }
    .msgBtn{
      position:relative;
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      flex:0 0 auto;
    }
    .msgIcon{width:24px; height:24px; object-fit:contain; opacity:.95; filter:drop-shadow(0 2px 6px rgba(0,0,0,.35));}
    .msgBadge{
      position:absolute;
      top:-6px; right:-6px;
      width:18px; height:18px;
      border-radius:999px;
      background:#ff3b30;
      border:2px solid rgba(6,26,43,1);
      color:#fff;
      font-weight:1000;
      font-size:12px;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .hidden{display:none !important;}
    @keyframes pulseBadge{
      0%{transform:scale(1); filter:brightness(1);}
      50%{transform:scale(1.12); filter:brightness(1.2);}
      100%{transform:scale(1); filter:brightness(1);}
    }
    .msgBadge.pulse{animation:pulseBadge 1.1s ease-in-out infinite;}

    /* ===== PRESEN√áA (bonitona) ===== */
    #scr_presenca{
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      padding:16px 0;
    }
    #scr_presenca .wrap{min-height:100%; height:auto !important; align-items:flex-start;}
    #scr_presenca .card{max-height: calc(100vh - 32px); overflow-y:auto; -webkit-overflow-scrolling:touch;}

    .hint{
      margin-top:12px; padding:12px 14px; border-radius:14px;
      background:linear-gradient(90deg, rgba(60,170,120,.35), rgba(80,210,160,.22));
      border:1px solid rgba(150,255,210,.25);
    }

    .presResumo{
      display:grid;
      grid-template-columns: 1fr 120px;
      gap:12px;
      border-radius:14px;
      border:2px solid rgba(255, 220, 40, .55);
      background: rgba(180, 150, 0, .25);
      padding:10px;
      margin: 12px 0;
    }
    .presResumoTitle{font-weight:900; margin-bottom:6px;}
    .presResumoLine{display:flex; justify-content:space-between; gap:10px; font-size:12px; padding:2px 0;}
    .barBox{
      width:86px;
      height:130px;
      border-radius:10px;
      overflow:hidden;
      border:2px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
    }
    .barTop{
      background: rgba(255,120,0,.85);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; font-size:13px;
      flex:1;
    }
    .barBottom{
      background: rgba(70,190,120,.85);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; font-size:13px;
      flex:1;
    }
    .barLegend{display:flex; gap:10px; margin-top:8px; font-size:11px; opacity:.95; justify-content:center;}
    .barLegend i{width:10px;height:10px;border-radius:3px;display:inline-block;}
    .lgNo i{background: rgba(255,120,0,.85);}
    .lgYes i{background: rgba(70,190,120,.85);}

    /* ===== CONSUMO (layout simples e est√°vel) ===== */
    #scr_consumo{align-items:stretch; justify-content:center;}
    .page{
      display:flex;
      flex-direction:column;
      height:100%;
      width:min(440px, 100%);
      margin:0 auto;
      padding:16px;
      gap:12px;
    }
    .cashBar{
      display:flex; align-items:center; gap:12px;
      padding:12px 14px; border-radius:14px;
      background: rgba(255,165,0,.22);
      border: 1px solid rgba(255,200,120,.22);
    }
    .cashText{font-weight:1000; font-size:14px;}
    #cashValue{font-weight:1000;}

    .prodScroll{
      flex:1;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding: 4px 0;
    }
    .prodRow{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 14px;
      border-radius:18px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      margin-bottom:12px;
    }
    .pIcon{
      width:50px;height:50px;border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
    }
    .pIcon img{background:#fff;width:100%; height:100%; object-fit:contain; display:block}
    .pMid{flex:1; min-width:0}
    .pName{font-weight:900}
    .pDesc{font-size:12px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .pPrice{margin-top:6px; font-weight:900}
    .qtyWrap{display:flex; align-items:center; gap:10px; flex:0 0 auto;}
    .qtyBtn{
      width:40px;height:40px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-size:22px;
      line-height:1;
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      cursor:pointer;
    }
    .qty{min-width:20px; text-align:center; font-weight:900}

    .consFooter{
      padding: 10px 0 0 0;
      background: linear-gradient(180deg, rgba(7,26,43,0) 0%, rgba(7,26,43,.65) 30%, rgba(7,26,43,.92) 100%);
      border-radius:18px;
    }
    .totalBox{
      padding:14px 14px;
      border-radius:18px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      margin-bottom:12px;
    }
    .totalBox .tLbl{font-size:12px; color:var(--muted)}
    .totalBox .tVal{font-size:28px; font-weight:1000; margin-top:6px}

    /* desktop center */
    @media (min-width:900px){
      body{display:flex; align-items:center; justify-content:center; background:#081b2c;}
      .screen{position:relative; width:420px; height:860px; border-radius:26px; overflow:hidden; box-shadow: 0 30px 80px rgba(0,0,0,.55);}
    }
    .payIconBtn:hover::after{opacity:1; transform: translate(-50%,-115%)}
    .payIconImg{width:62px; height:30px; object-fit:contain; display:block; filter:drop-shadow(0 2px 8px rgba(0,0,0,.25));}
    .paySvg{font-size:26px; line-height:1}
    .payBack{margin-top:8px}
    .payHint{margin-top:10px; opacity:.70; font-size:12px}

    /* FIX: n√£o quebrar linha dentro do #payItems (trunca descri√ß√£o e mant√©m pre√ßo na mesma linha) */
#payItems{
  max-height: calc(4 * 36px);
  overflow-y: auto;
  overflow-x: hidden;
  padding-right: 4px;
  color: #FFD700; /* Amarelo ouro forte */
  font-weight: bold;
}

#payItems .payItemRow{
  display: flex !important;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  min-height: 36px;
  flex-wrap: nowrap !important;     /* nunca quebra */
}

#payItems .payItemLeft{
  flex: 1 1 auto !important;
  min-width: 0 !important;          /* ESSENCIAL pro "..." funcionar no flex */
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
}

#payItems .payItemDots{
  flex: 1 1 auto !important;        /* pontilhado ocupa o meio */
  min-width: 16px;
}

#payItems .payItemRight{
  flex: 0 0 auto !important;
  white-space: nowrap !important;
}

    /* Pagamento */
    #scr_pagamento{align-items:flex-start; justify-content:center;}
    .payBtns{display:flex; flex-direction:column; gap:12px; margin-top:12px}
    /* .payBtn{
      padding:16px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      font-size:18px;
      text-align:center;
    }
    .payBtn.primary{background: rgba(51,208,122,.18); border-color: rgba(51,208,122,.35)}
    .payBtn.warn{background: rgba(255,215,0,.14); border-color: rgba(255,215,0,.25)}*/
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.75);
      color:white; padding:10px 14px;
      border-radius:14px;
      opacity:0; pointer-events:none;
      transition: opacity .25s ease;
      font-weight:800;
      z-index:99;
    }
    .toast.show{opacity:1}

    /* desktop center */
    @media (min-width:900px){
      body{display:flex; align-items:center; justify-content:center; background:#081b2c;}
      .screen{position:relative; width:420px; height:860px; border-radius:26px; overflow:hidden; box-shadow: 0 30px 80px rgba(0,0,0,.55);}
    }
  

/* v15 fixes */
.panel{flex:1;display:flex;flex-direction:column;min-height:0;}
.prodScroll{flex:1;min-height:0;-webkit-overflow-scrolling:touch;}

.pIconImg{width:28px;height:28px;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,.25));}
/* bot√£o selecionado = contorno azul brilhante */
.payBtn.isChosen{
  border: 2px solid rgba(45,140,255,.95) !important;
  box-shadow:
    0 0 0 3px rgba(45,140,255,.22),
    0 0 18px rgba(45,140,255,.45) !important;
  filter: brightness(1.06);
}
    .presCard{padding:14px; max-width:420px;}
    .presMsg{
      border: 2px solid rgba(70, 190, 120, .55);
      background: rgba(0,0,0,.18);
      margin: 12px 0;
    }
    .presMsg .infoText{
      font-size: 12px;
      line-height: 1.35;
      max-height: 170px;
      overflow: auto;
      padding-right: 6px;
    }
    .infoCard{margin-top:12px; padding:14px; border-radius:16px; background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.10);}
    .infoTitle{font-weight:900; font-size:18px;}
    .infoText{margin-top:6px; font-size:13px; opacity:.90; line-height:1.35;}

    .presBtnsRow{display:flex; gap:10px;}
    .payBtn{
      flex:1;
      min-height:44px;
      padding:10px 8px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      font-size:8px;
      text-align:center;
      cursor:pointer;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      line-height:1.1;
    }
    .payBtn.primary{background: rgba(51,208,122,.18); border-color: rgba(51,208,122,.35)}
    .payBtn.isChosen{outline:2px solid rgba(255,255,255,.35);}

/* ===== BOT√ÉO ESCOLHIDO: BORDA AMARELA BRILHANTE ===== */
.presBtnsRow .payBtn.isChosen{
  border: 2px solid rgba(255,215,0,.98) !important;
  box-shadow:
    0 0 0 3px rgba(255,215,0,.22),
    0 0 18px rgba(255,215,0,.45) !important;
  filter: brightness(1.06);
}

/* ===== STATUS (ret√¢ngulo preto j√° no seu #presStatusLine) ===== */
#presStatusLine{
  background: rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 12px;
  padding: 10px 12px;
  font-weight: 900;
}

/* ===== OVERLAY: PRESEN√áA CONFIRMADA (preto full) ===== */
.presSuccess{
  position:fixed;
  inset:0;
  width:100vw;
  height:100dvh;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999999;
}
.presSuccess.hidden{display:none;}
.presSuccessInner{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:14px;
  text-align:center;
  padding: 18px;
}
#presGif{
  width:220px;
  max-width:70vw;
  height:auto;
  object-fit:contain;
  filter: drop-shadow(0 14px 30px rgba(0,0,0,.55));
}
.presOkText{
  font-weight:1000;
  font-size:22px;
  color:#fff;
  text-shadow:0 2px 12px rgba(0,0,0,.6);
}

/* ===== WAIT: AVISO PRESEN√áA J√Å CONFIRMADA ===== */
.waitPresencaOk{
  margin-top:8px;
  padding:7px 10px;              /* menor */
  border-radius:12px;
  background: rgba(80,170,255,.16);  /* azul claro transparente */
  border: 1px solid rgba(140,210,255,.28);
  font-weight:900;
  font-size:12px;                /* menor (ajuda no celular) */
  line-height:1.05;              /* mais baixo */
  text-align:center;
  letter-spacing:.2px;

  transition: transform .35s ease, filter .35s ease, background .35s ease, border-color .35s ease, box-shadow .35s ease, opacity .35s ease;
  will-change: transform, filter;
}

.waitPresencaOk.pulse{
  animation: presPulse 1.15s ease-in-out infinite;
}

@keyframes presPulse{
  0%   { transform: scale(1);    filter: brightness(1);   }
  50%  { transform: scale(1.04); filter: brightness(1.15);}
  100% { transform: scale(1);    filter: brightness(1);   }
}

@keyframes presBlink{
  0%   { opacity:1; }
  50%  { opacity:.82; }
  100% { opacity:1; }
}

.waitPresencaOk.blink{
  animation: presBlink 1.0s ease-in-out infinite;
}

.waitPresencaOk.hidden{display:none;}

/* bolinha vermelha */
.msgBtn{ position:relative; }

.msgBadge{
  position:absolute;
  top:-6px; right:-6px;
  width:18px; height:18px;
  border-radius:999px;
  background:#ff3b30;
  border:2px solid rgba(6,26,43,1);
  color:#fff;
  font-weight:1000;
  font-size:12px;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 10px 24px rgba(0,0,0,.35);
}

.msgBadge.hidden{ display:none !important; }

/* ===== ADMIN ===== */
#scr_admin{align-items:stretch; justify-content:center;}
.adminWrap{
  width:min(440px, 100%);
  margin:0 auto;
  padding:16px;
  display:flex;
  flex-direction:column;
  height:100%;
  gap:12px;
}

.adminTabs{
  display:flex; gap:8px;
}
.adminTab{
  flex:1;
  padding:10px 8px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color:var(--text);
  font-weight:1000;
  cursor:pointer;
}
.adminTab.active{
  border:2px solid rgba(255,215,0,.85);
  box-shadow:0 0 0 3px rgba(255,215,0,.18);
}

.adminPanel{
  flex:1;
  min-height:0;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  padding:14px;
  border-radius:22px;
  background: rgba(0,0,0,.18);
  border:1px solid rgba(255,255,255,.12);
  box-shadow: 0 24px 55px rgba(0,0,0,.32);
}

.aRow{display:flex; gap:10px; align-items:center; margin-top:10px;}
.aRow > *{flex:1; min-width:0;}
.aLbl{font-size:12px; opacity:.75; font-weight:900; margin-top:12px;}
.aInp, .aTxt{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color:var(--text);
  outline:none;
  font-size:14px;
}
.aTxt{min-height:90px; resize:vertical;}

.aMini{
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color:var(--text);
  font-weight:1000;
  cursor:pointer;
}

.adminFooter{
  display:flex;
  gap:10px;
}
.adminFooter .btn2{margin-top:0}
.adminFooter .miniBtn{margin-top:0}

.adminTable{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:12px;
}
.adminTable th, .adminTable td{
  border-bottom:1px solid rgba(255,255,255,.10);
  padding:8px 6px;
  text-align:left;
}
.adminTable th{opacity:.75; font-weight:1000;}
.adminBadge{
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  font-weight:1000;
  font-size:11px;
  background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.12);
}
    
  </style>
</head>

<body>
  <div id="toast" class="toast"></div>

  <!-- Splash 1 -->
  <section id="scr_splash1" class="screen active safe">
    <div class="splashCenter">
      <img id="splashSymbol" class="splashSymbol" src="./assets/maconaria.png" alt="Carregando" style="width:160px;height:160px;object-fit:contain;">
      <div class="splashLoading" style="margin-top:6px;font-weight:900;font-size:18px;opacity:.95;">Carregando‚Ä¶..</div>
    </div>
  </section>

  <!-- Splash 2 -->
  <section id="scr_splash2" class="screen safe">
    <div class="splashCenter">
      <div class="logoWrap">
        <img id="splashLogo" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/>
      </div>
      <div class="brandText">Sistema √Ågape</div>
    </div>
  </section>

  <!-- Wait -->
  <section id="scr_wait" class="screen safe">
    <div class="wrap">
      <div class="card waitCard">
        <div class="topBrand">
          <div class="bLogo">
            <img id="brandLogoWait" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/>
          </div>
          <div class="bTxt">
            <div class="bTitle" id="lojaNomeWait">Loja</div>
            <div class="bSub" id="lojaSubWait">App √Ågape ‚Ä¢ Consumo & Pagamento</div>
          </div>
        </div>

        <div class="sessionBar">
          <div class="dotBig" id="sessaoDotWait"></div>
          <div class="sessionLine" id="sessaoLineWait">Sess√£o fechada ‚Äî ‚Äî</div>
          <button class="msgBtn" id="btnEnvelope" type="button" aria-label="Mensagem do Vener√°vel">
            <img src="./assets/icon-envelope.png" alt="" class="msgIcon">
            <span class="msgBadge hidden" id="badgeConvocacao">!</span>
          </button>
        </div>

        <div class="pixBar" style="margin-top:12px;">
          <div class="pixBadge"><img src="./assets/logo-pix.jpg" alt="Pix"></div>
          <div class="pixKey" id="pixChaveWait">‚Äî</div>
        </div>

        <div class="infoCard">
          <div class="infoTitle">Sess√£o ainda n√£o liberada üîí</div>
          <div class="infoText">A sess√£o ainda n√£o foi aberta pelo respons√°vel, mas n√£o se preocupe. Quando liberar a sess√£o, automaticamente aparecer√° a tela de login.</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;">
            <div style="padding:12px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);">
              <div style="font-size:12px;opacity:.75;">√öltima verifica√ß√£o</div>
              <div style="margin-top:4px;font-weight:900;font-size:16px;" id="lastCheck">‚Äî</div>
            </div>
            <div style="padding:12px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);">
              <div style="font-size:12px;opacity:.75;">Sess√£o</div>
              <div style="margin-top:4px;font-weight:900;font-size:16px;" id="sessaoStatus">Fechada</div>
            </div>
          </div>
          <button class="miniBtn" id="btnSairWait" type="button" style="margin-top:12px;background:#e53935;border-color:#e53935;color:#fff;">
            Sair do aplicativo
          </button>
        </div>

<!-- 1) COLE ISTO DENTRO DO #scr_wait (ex: logo abaixo do infoCard ou antes do hint) -->
<div id="waitPresencaOk" class="waitPresencaOk hidden">‚úÖ PRESEN√áA J√Å CONFIRMADA</div>

        <div class="hint">
          <div style="font-weight:900;font-size:14px;">Modo tesoureiro</div>
          <div style="font-size:13px;opacity:.95;margin-top:4px;">toque 5x no logo para abrir Admin (sess√£o, caixa, produtos, Pix).</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Presen√ßa -->
  <section id="scr_presenca" class="screen safe">
    <div class="wrap">
      <div class="card presCard">

        <div class="topBrand presTop">
          <div class="bLogo">
            <img id="brandLogoPres" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/>
          </div>
          <div class="bTxt">
            <div class="bTitle" id="lojaNomePres">Loja</div>
            <div class="bSub">Presen√ßa ‚Ä¢ Sess√£o & √Ågape</div>
          </div>
        </div>

        <div class="sessionBar presSessionBar">
          <div class="dotBig" id="sessaoDotPres"></div>
          <div class="sessionLine" id="sessaoLinePres">Sess√£o fechada</div>
        </div>

        <div class="infoCard presMsg">
          <div class="infoTitle">Chamado do Vener√°vel</div>
          <div class="infoText" id="presTexto">Carregando...</div>
        </div>

        <div class="presBtnsRow">
          <button class="payBtn primary" id="btnRespSessaoAgape" type="button">Sess√£o e √Ågape</button>
          <button class="payBtn" id="btnRespSessao" type="button">Somente sess√£o</button>
          <button class="payBtn" id="btnRespAgape" type="button">Somente √°gape</button>
        </div>

        <div class="hint" id="presStatusLine">Voc√™ ainda n√£o respondeu.</div>

        <div class="presResumo">
          <div class="presResumoLeft">
            <div class="presResumoTitle">Resumo:</div>
            <div class="presResumoLine"><span>Sess√£o e √Ågape:</span><b id="rSA">0</b></div>
            <div class="presResumoLine"><span>Somente sess√£o:</span><b id="rS">0</b></div>
            <div class="presResumoLine"><span>Somente √°gape:</span><b id="rA">0</b></div>
            <div class="presResumoLine"><span>Total respondidos:</span><b id="rT">0</b></div>
            <div class="presResumoLine"><span>Total n√£o respondidos:</span><b id="rN">0</b></div>
          </div>

          <div class="presResumoRight" style="display:flex;flex-direction:column;align-items:center;justify-content:center;">
            <div class="barBox">
              <div class="barTop" id="barNao">0</div>
              <div class="barBottom" id="barSim">0</div>
            </div>
            <div class="barLegend">
              <span class="lgNo" style="display:inline-flex;gap:6px;align-items:center;"><i></i>N√£o</span>
              <span class="lgYes" style="display:inline-flex;gap:6px;align-items:center;"><i></i>Sim</span>
            </div>
          </div>
        </div>

        <button class="btn2" id="btnFecharPresenca" type="button">Fechar</button>
      </div>
    </div>
  </section>

   
  <!-- Login -->
  <section id="scr_login" class="screen safe">
    <div class="wrap">
      <div class="topBrand" id="brandBar">
        <div class="bLogo"><img id="brandLogo" alt="logo"/></div>
        <div class="bTxt">
          <div class="bTitle" id="lojaNome">Loja</div>
          <div class="bSub" id="lojaSub"></div>
        </div>
      </div>

      <div class="sessionBar" id="sessionBarLogin">
        <span class="dotBig" id="sessaoDotLogin" style="width:16px;height:16px;border-radius:50%;"></span>
        <div class="sessionLine" id="sessaoLineLogin">Sess√£o ‚Äî</div>
      </div>

      <div class="pixBar">
        <div class="pixBadge"><img src="./assets/logo-pix.jpg" alt="Pix"></div>
        <div class="pixKey" id="pixChave">‚Äî</div>
      </div>

      <div class="card" id="loginCard">
        <h2 id="welcomeTitle" style="margin:0 0 6px 0; font-size:34px; letter-spacing:.2px">Bem-vindo üëã</h2>
        <p style="margin:0 0 14px 0; color:var(--muted)">Digite seu <strong>CIM</strong> para entrar. Bot√µes grandes e tudo bem simples.</p>

        <div id="telWrap">
          <label style="display:block; font-weight:700; margin:10px 0 6px 0; font-size:15px">Telefone</label>
          <input id="inpTel" inputmode="tel" placeholder="Ex: 48999990000" style="width:100%;padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);color:var(--text);outline:none;font-size:16px;" />
        </div>

        <label style="display:block; font-weight:700; margin:10px 0 6px 0; font-size:15px">CIM (senha)</label>
        <input id="inpCIM" inputmode="numeric" placeholder="Digite seu CIM" style="width:100%;padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);color:var(--text);outline:none;font-size:16px;" />

        <button class="btn" id="btnEntrar">Entrar</button>
        <button class="miniBtn" id="btnSairLogin" style="width:100%;margin-top:10px;">Sair do aplicativo</button>

        <div style="margin-top:10px; color: rgba(255,255,255,.65)">Admin: toque 5x no logo.</div>
      </div>
    </div>
  </section>

  <!-- Consumo -->
  <section id="scr_consumo" class="screen safe">
    <div class="page">
      <div class="topBrand">
        <div class="bLogo"><img id="brandLogoCons" src="./assets/logo-Clementino-Brito.jpeg" alt="logo"/></div>
        <div class="bTxt">
          <div class="bTitle" id="consLoja">Loja</div>
          <div class="bSub" id="consSub"></div>
        </div>
      </div>

      <div class="sessionBar">
        <span class="dotBig" id="sessaoDotCons"></span>
        <div class="sessionLine" id="sessaoLineCons">Sess√£o ‚Äî</div>
      </div>

      <div class="cashBar" id="cashBar">
        <div class="cashText">Valor em caixa: <span id="cashValue">R$ 0,00</span></div>
      </div>

      <div class="pixBar">
        <div class="pixKey" >Meu Consumo</div>
        <button class="miniBtn" id="btnSair">Sair</button>
      </div>

      <div class="prodScroll" id="prodScroll">
        <div id="prodList"></div>
      </div>

      <div class="consFooter">
        <div class="totalBox">
          <div class="tLbl">Total</div>
          <div class="tVal" id="totalValue">R$ 0,00</div>
        </div>
        <button class="btn2" id="btnFechar">Fechar e pagar</button>
      </div>
    </div>
  </section>

   <!-- Pagamento -->
  <section id="scr_pagamento" class="screen safe">
    <div class="wrap">
      <div class="topBrand" id="payBrandBar">
        <div class="bLogo"><img id="payLogo" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/></div>
        <div class="bTxt">
          <div class="bTitle" id="payLoja">Loja</div>
          <div class="bSub">App √Ågape ‚Ä¢ Consumo & Pagamento</div>
        </div>
      </div>

      <div class="sessionBar">
        <span class="dotbig" id="paySessaoDot" style="width:12px;height:12px;border-radius:99px;"></span>
        <div class="sessionLine" id="paySessaoLine">Sess√£o ‚Äî</div>
      </div>

      <div class="payCard">
        <div class="payMsg">
          <div class="payHello" id="payHello">Oi meu irm√£o,</div>
          <div class="payTotal">Sua conta totalizou <span id="payTotal">R$ 0,00</span>:</div><br>
        </div>

        <div id="payItems" class="payItems"></div>
              
        <div class="payQ"><br>Como deseja pagar?</div><br>

        <div class="payIconRow" aria-label="Formas de pagamento">
          <button class="payIconBtn" id="btnPix" type="button" data-tip="Pix">
            <img src="./assets/logo-pix.jpg" alt="Pix" class="payIconImg"/>
          </button>

          <button class="payIconBtn" id="btnDinheiro" type="button" data-tip="Dinheiro">
            <span class="paySvg" aria-hidden="true">üíµ</span>
          </button>

          <button class="payIconBtn" id="btnProxima" type="button" data-tip="Pr√≥xima sess√£o">
            <span class="paySvg" aria-hidden="true">üìÖ</span>
          </button>
        </div>

        <button class="btn2 payBack" id="btnVoltarConsumo" type="button">Voltar para comanda</button>
        <div class="payHint">Ao pagar, registramos e voltamos para o login.</div>
      </div>
    </div>


    <!-- Modal Pix -->
    <div id="pixModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="pixTitle">
      <div class="modalCard">
        <div class="modalTop">
          <div class="modalTitle" id="pixTitle">Pix</div>
          <button class="modalX" id="btnPixCancel" type="button" aria-label="Fechar">‚úï</button>
        </div>

        <div class="modalText">Copie a chave e fa√ßa a transfer√™ncia do valor exato.</div>

        <div class="pixValueRow">
          <div class="pixValueLbl">Valor</div>
          <div class="pixValue" id="pixValor">R$ 0,00</div>
        </div>

        <div class="pixKeyRow">
          <div class="pixKeyText" id="pixChaveModal">‚Äî</div>
          <button class="pixCopyBtn" id="btnCopyPix" type="button" title="Copiar">üìã</button>
        </div>

        <button class="btn2 modalOk" id="btnPixOk" type="button">OK, transferi</button>
        <button class="modalCancel" id="btnPixCancel2" type="button">Cancelar</button>
      </div>
    </div>

    <!-- Sucesso -->
    <div id="paySuccess" class="hidden" style="position:fixed;inset:0;background:rgba(230,204,24,.96);display:flex;align-items:center;justify-content:center;z-index:9999;">
      <div style="display:flex;flex-direction:column;align-items:center;gap:14px;text-align:center;">
        <img id="payGif" src="./assets/check.gif" alt="Pago" style="width:160px;height:160px;object-fit:contain;filter:drop-shadow(0 12px 26px rgba(0,0,0,.25));">
        <div style="font-weight:1000;font-size:22px;color:#053018;text-shadow:0 1px 0 rgba(255,255,255,.35);">Pagamento registrado</div>
      </div>
    </div>
  </section>
  <div id="presSuccess" class="presSuccess hidden" aria-hidden="true">
     <div class="presSuccessInner">
       <img id="presGif" src="./assets/presenca.gif" alt="Confirmado">
       <div class="presOkText">PRESEN√áA CONFIRMADA!!!!!!!!!</div>
    </div>
  </div>

<!-- ADMIN -->
<section id="scr_admin" class="screen safe">
  <div class="adminWrap">
    <div class="topBrand">
      <div class="bLogo"><img id="adminLogo" src="./assets/logo-Clementino-Brito.jpeg" alt="logo"/></div>
      <div class="bTxt">
        <div class="bTitle">Admin</div>
        <div class="bSub" id="adminSub">Configura√ß√£o ‚Ä¢ Sess√£o ‚Ä¢ Irm√£os</div>
      </div>
    </div>

    <div class="adminTabs">
      <button class="adminTab active" id="tabCfg" type="button">CONFIGURA√á√ÉO</button>
      <button class="adminTab" id="tabSessao" type="button">SESS√ÉO</button>
      <button class="adminTab" id="tabIrmaos" type="button">IRM√ÉOS</button>
    </div>

    <div class="adminPanel" id="adminPanel"></div>

    <div class="adminFooter">
      <button class="btn2" id="btnAdminSalvar" type="button">CONFIRMAR</button>
      <button class="miniBtn" id="btnAdminSair" type="button">SAIR</button>
    </div>
  </div>
</section>
  
<script>
/* ==========================
   CONFIG / HELPERS
========================== */
const CONFIG_URL = "./agape_config.json?v=" + Date.now();
const LS_CART  = "agape_cart_v14";
const LS_USER  = "agape_user_v14";
const LS_CASH = "agape_cash_v1";
const LS_CASH_DATE = "agape_cash_date_v1";
const LS_PRES_LIDA = "agape_presenca_lida_v1";
const LS_PRES_RESP = "agape_presenca_resp_v1";
const GIF_TIME   = 6000;
const ZOOM_TIME  = 6000;
const CONSUMO_RESUMO_URL = "https://api.erpimpar.com.br/agape/consumo/resumo.php";

const $ = (s)=>document.querySelector(s);

function setText(sel, val){
  if(!sel) return;
  const isCSS =
    sel.startsWith("#") || sel.startsWith(".") ||
    sel.includes(" ") || sel.includes(",") ||
    sel.includes("[") || sel.includes(">") || sel.includes(":");
  const q = isCSS ? sel : ("#" + sel);
  const el = document.querySelector(q);
  if(el) el.textContent = (val ?? "");
}

const fmtBRL = (v)=>Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

let CFG=null;
let lastTotal = 0;
let currentScreen="scr_splash1";
let waitTimer=null;
let waitOpenTimer=null;
let waitPollingStarted=false;
let payReady = true;
let adminTapCount=0;
let adminTapTimer=null;

function toast(msg){
  const t=$("#toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1700);
}

function showScreen(id, dir="forward"){
  const from=document.getElementById(currentScreen);
  const to=document.getElementById(id);
  if(!from||!to||id===currentScreen) return;

  to.classList.remove("exit-left","exit-right","enter-left","enter-right");
  from.classList.remove("exit-left","exit-right","enter-left","enter-right");

  if(dir==="forward") to.classList.add("enter-left"); else to.classList.add("enter-right");
  to.classList.add("active");

  if (id === "scr_splash2") {
    const lw = to.querySelector(".logoWrap");
    const bt = to.querySelector(".brandText");
    [lw, bt].forEach(el => {
      if (!el) return;
      el.style.animation = "none";
      void el.offsetHeight;
      el.style.animation = "";
    });
  }

  void to.offsetWidth;
  to.classList.remove("enter-left","enter-right");

  if(dir==="forward") from.classList.add("exit-left"); else from.classList.add("exit-right");

  setTimeout(()=>{
    from.classList.remove("active","exit-left","exit-right");
    currentScreen=id;
  }, 460);
}

async function loadConfig(){
  const r=await fetch("./agape_config.json?v=" + Date.now(),{cache:"no-store"});
  if(!r.ok) throw new Error("config");
  return await r.json();
}

function sessionIsOpen(){
  return (CFG?.sessao?.status||"").toLowerCase()==="aberta";
}

/* ==========================
   STORAGE: CART / USER / CASH
========================== */

/* ‚úÖ FIX m√≠nimo: sua fun√ß√£o tinha recurs√£o (chamava ela mesma) */
function resetPresencaState(){
  localStorage.removeItem(LS_PRES_LIDA);
  localStorage.removeItem(LS_PRES_RESP);

  // se houver convoca√ß√£o e o ID mudar, limpa estado de presen√ßa
  if(CFG?.convocacao?.ativa){
    const lastId = localStorage.getItem("agape_conv_id");
    if(lastId !== CFG.convocacao.id){
      localStorage.removeItem(LS_PRES_LIDA);
      localStorage.removeItem(LS_PRES_RESP);
      localStorage.setItem("agape_conv_id", CFG.convocacao.id);
    }
  }
}

function getCart(){ try{return JSON.parse(localStorage.getItem(LS_CART)||"{}")}catch(_){return {}} }
function setCart(c){ localStorage.setItem(LS_CART, JSON.stringify(c)); }
function clearCart(){ localStorage.removeItem(LS_CART); }

function getUser(){ try { return JSON.parse(localStorage.getItem(LS_USER) || "null"); } catch(e){ return null; } }
function setUser(u){ localStorage.setItem(LS_USER, JSON.stringify(u)); }
//function clearUser(){ localStorage.removeItem(LS_USER); }

function getCashFromCFG(){
  const n = Number(CFG?.sessao?.caixa_inicial);
  return Number.isFinite(n) ? n : 0;
}
function getCash(){
  const n = Number(localStorage.getItem(LS_CASH));
  return Number.isFinite(n) ? n : getCashFromCFG();
}
function setCash(n){
  localStorage.setItem(LS_CASH, String(Number(n) || 0));
}
function initCashFromConfig(){
  const sessionDate = String(CFG?.sessao?.data || "").trim();
  const savedDate   = localStorage.getItem(LS_CASH_DATE);
  const hasCash     = localStorage.getItem(LS_CASH) !== null;

  if(!hasCash || (sessionDate && savedDate !== sessionDate)){
    setCash(getCashFromCFG());
    localStorage.setItem(LS_CASH_DATE, sessionDate);
  }
}
function renderCash(){
  const el = document.getElementById("cashValue");
  if(el) el.textContent = fmtBRL(getCash());
}

/* ==========================
   ===== PRESEN√áA (√öNICA) =====
========================== */
const LS_PRESENCA_ANS  = "agape_presenca_ans_v1";
const LS_PRESENCA_READ = "agape_presenca_read_v1";

function sessaoKey(){
  return String(CFG?.sessao?.data || "").trim();
}
function getPresencaMap(){
  try{ return JSON.parse(localStorage.getItem(LS_PRESENCA_ANS) || "{}"); }
  catch(_){ return {}; }
}
function getPresencaAns(){
  const key = sessaoKey();
  if(!key) return "";
  return String(getPresencaMap()[key] || "");
}
function setPresencaAns(ans){
  const key = sessaoKey();
  if(!key) return;
  const map = getPresencaMap();
  map[key] = ans;
  localStorage.setItem(LS_PRESENCA_ANS, JSON.stringify(map));
}
function setReadPresenca(){
  const key = sessaoKey();
  if(!key) return;
  localStorage.setItem(LS_PRESENCA_READ, key);
}
function isReadPresenca(){
  const key = sessaoKey();
  return !!key && localStorage.getItem(LS_PRESENCA_READ) === key;
}

function refreshPresenceUI(){
  const totalIrmaos = Array.isArray(CFG?.irmaos) ? CFG.irmaos.length : 0;
  const ans = getPresencaAns();

  const nSA = ans === "sessao_agape"   ? 1 : 0;
  const nSS = ans === "somente_sessao" ? 1 : 0;
  const nAG = ans === "somente_agape"  ? 1 : 0;

  const totalResp = ans ? 1 : 0;
  const totalNao  = Math.max(0, totalIrmaos - totalResp);

  const setNum = (id, v)=>{ const el=document.getElementById(id); if(el) el.textContent = String(v); };

  setNum("rSA", nSA);
  setNum("rS",  nSS);
  setNum("rA",  nAG);
  setNum("rT",  totalResp);
  setNum("rN",  totalNao);

  setNum("barNao", totalNao);
  setNum("barSim", totalResp);

  const line = document.getElementById("presStatusLine");
  if(line){
    const label =
      ans === "sessao_agape" ? "Sess√£o e √Ågape" :
      ans === "somente_sessao" ? "Somente sess√£o" :
      ans === "somente_agape" ? "Somente √°gape" : "";
    line.textContent = ans ? `Voc√™ respondeu: ${label}.` : "Voc√™ ainda n√£o respondeu.";
  }

  ["btnRespSessaoAgape","btnRespSessao","btnRespAgape"].forEach(id=>{
    const b = document.getElementById(id);
    if(b) b.classList.remove("isChosen");
  });
  const chosenId =
    ans === "sessao_agape" ? "btnRespSessaoAgape" :
    ans === "somente_sessao" ? "btnRespSessao" :
    ans === "somente_agape" ? "btnRespAgape" : "";
  if(chosenId){
    const b = document.getElementById(chosenId);
    if(b) b.classList.add("isChosen");
  }
}

const LS_CONVOCACAO_READ = "agape_convocacao_read_v1";

function getConvocacaoObj(){
  // aceita convocacao na raiz OU dentro de sessao (compat√≠vel com os 2 formatos)
  return (CFG && (CFG.convocacao || (CFG.sessao && CFG.sessao.convocacao))) || null;
}

function getConvocacaoId(){
  const c = getConvocacaoObj();
  return String(c?.id || "").trim();
}

function isConvocacaoAtiva(){
  const c = getConvocacaoObj();
  return c?.ativa === true;
}

function isConvocacaoLida(){
  const id = getConvocacaoId();
  if(!id) return false;
  return localStorage.getItem(LS_CONVOCACAO_READ) === id;
}

function marcarConvocacaoLida(){
  const id = getConvocacaoId();
  if(!id) return;
  localStorage.setItem(LS_CONVOCACAO_READ, id);
}

/** Atualiza a bolinha do envelope (id correto: badgeConvocacao) */
function updateConvocacaoBadge(){
  const badge = document.getElementById("badgeConvocacao");
  if(!badge) return;

  const show = isConvocacaoAtiva() && !isConvocacaoLida();
  badge.classList.toggle("hidden", !show);
  badge.textContent = "!";
}

/** Mant√©m compatibilidade com chamadas antigas */
function updateEnvelopeUI(){
  updateConvocacaoBadge();
}

function choosePresenca(val){
  setPresencaAns(val);
  setReadPresenca();
  refreshPresenceUI();
  updateEnvelopeUI();
}

function openPresenca(){
  if(!CFG?.sessao) return;

  marcarConvocacaoLida();
  updateConvocacaoBadge();

  const elTxt = document.getElementById("presTexto");
  if(elTxt){
    elTxt.textContent = CFG.sessao.chamado || "Mensagem n√£o configurada.";
  }

  setPresencaLida();
  updateEnvelopeUI();

  showScreen("scr_presenca","forward");
  refreshPresenceUI();
}

// ===== Pagamento v25 flow =====
const PAY_SUCCESS_MS = 2200;

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function cartEntries(cart){
  if(!cart) return [];
  if(!Array.isArray(cart) && typeof cart==="object"){
    return Object.entries(cart).map(([id,q])=>({id:String(id), qtd:Number(q||0)}));
  }
  if(Array.isArray(cart)){
    return cart.map(it=>({id:String(it.id), qtd:Number(it.qtd||it.qtd||0)}));
  }
  return [];
}

// ===== PIX =====
function emv(id, value){
  const v = String(value);
  const len = String(v.length).padStart(2,"0");
  return `${id}${len}${v}`;
}

function crc16(payload){
  let crc = 0xFFFF;
  for(let i=0;i<payload.length;i++){
    crc ^= (payload.charCodeAt(i) << 8);
    for(let j=0;j<8;j++){
      crc = (crc & 0x8000) ? (((crc << 1) ^ 0x1021) & 0xFFFF) : ((crc << 1) & 0xFFFF);
    }
  }
  return crc.toString(16).toUpperCase().padStart(4,"0");
}

function buildPixPayload({ key, amount, merchantName, merchantCity, txid }){
  const k = String(key||"").trim();
  const a = Number(amount||0).toFixed(2);

  const mName = String(merchantName || "AGAPE").slice(0,25);
  const mCity = String(merchantCity || "BRASIL").slice(0,15);
  const tId   = String(txid || "AGAPE").slice(0,25);

  const gui = emv("00","BR.GOV.BCB.PIX");
  const chave = emv("01", k);
  const mai = emv("26", gui + chave);

  const payloadNoCrc =
    emv("00","01") +
    emv("01","12") +
    mai +
    emv("52","0000") +
    emv("53","986") +
    emv("54", a) +
    emv("58","BR") +
    emv("59", mName) +
    emv("60", mCity) +
    emv("62", emv("05", tId)) +
    "6304";

  return payloadNoCrc + crc16(payloadNoCrc);
}

function closePresenca(){
  updateEnvelopeUI();
  updatePresenceConfirmedWait(); // ‚úÖ mostra no wait imediatamente
  showScreen("scr_wait","back");
}

function isPresencaLida(){
  return localStorage.getItem(LS_PRES_LIDA) === "1";
}
function setPresencaLida(){
  localStorage.setItem(LS_PRES_LIDA, "1");
}
function isPresencaRespondida(){
  return localStorage.getItem(LS_PRES_RESP) === "1";
}
function setPresencaRespondida(){
  localStorage.setItem(LS_PRES_RESP, "1");
}

function bindPresencaUI(){
  const b1 = document.getElementById("btnRespSessaoAgape");
  const b2 = document.getElementById("btnRespSessao");
  const b3 = document.getElementById("btnRespAgape");

  const bind = (btn, val)=>{
    if(!btn || btn.dataset.bound) return;
    btn.dataset.bound = "1";

    const handler = (e)=>{
      e?.preventDefault?.();
      choosePresenca(val);
    };

    btn.addEventListener("click", handler);
    btn.addEventListener("touchend", (e)=>{ e.preventDefault(); handler(e); }, {passive:false});
  };

  bind(b1, "sessao_agape");
  bind(b2, "somente_sessao");
  bind(b3, "somente_agape");

  const env = document.getElementById("btnEnvelope");
  if(env && !env.dataset.bound){
    env.dataset.bound="1";
    env.addEventListener("click", openPresenca);
    env.addEventListener("touchend", (e)=>{ e.preventDefault(); openPresenca(); }, {passive:false});
  }

  const fechar = document.getElementById("btnFecharPresenca");
  if(fechar && !fechar.dataset.bound){
    fechar.dataset.bound="1";
    fechar.addEventListener("click", closePresenca);
    fechar.addEventListener("touchend", (e)=>{ e.preventDefault(); closePresenca(); }, {passive:false});
  }
}

/* ==========================
   BRAND / UI
========================== */
function applyBrand(){
  const setTextId = (id, val) => { const el=document.getElementById(id); if(el) el.textContent = val; };
  const setSrc  = (id, src) => { const el=document.getElementById(id); if(el && src) el.src = src; };

  const logoUrl = (CFG?.ui?.logo_url) ? CFG.ui.logo_url : "./assets/logo-Clementino-Brito.jpeg";

  ["brandLogo","brandLogoWait","brandLogoCons","brandLogoPres","payLogo"].forEach(id=>setSrc(id, logoUrl));

  setTextId("lojaNome", CFG?.loja?.nome || "Loja");
  setTextId("lojaSub",  CFG?.loja?.subtitulo || "");
  setTextId("lojaNomeWait", CFG?.loja?.nome || "Loja");
  setTextId("lojaSubWait",  CFG?.loja?.subtitulo || "");
  setTextId("consLoja", CFG?.loja?.nome || "Loja");
  setTextId("consSub",  CFG?.loja?.subtitulo || "");
  setTextId("lojaNomePres", CFG?.loja?.nome || "Loja");
  setTextId("payLoja", CFG?.loja?.nome || "Loja");

  const pix = (CFG?.loja?.pix_chave || "").trim();
  setTextId("pixChave", pix || "‚Äî");
  setTextId("pixChaveWait", pix || "‚Äî");

  const opened = (CFG?.sessao?.status || "").toLowerCase() === "aberta";

  const now = new Date();
  const hh = String(now.getHours()).padStart(2,"0");
  const mm = String(now.getMinutes()).padStart(2,"0");
  const ss = String(now.getSeconds()).padStart(2,"0");
  const nowStr = `${hh}:${mm}:${ss}`;
  const d = (CFG?.sessao?.data || "").trim();
  const sessaoStr = d ? `${d} ‚Äî ${nowStr}` : `‚Äî ‚Äî ${nowStr}`;

  const dotColor = opened ? "var(--good)" : "var(--bad)";
  ["sessaoDotLogin","sessaoDotCons","paySessaoDot","sessaoDotWait","sessaoDotPres"].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.background = dotColor;
  });

  const sessaoLabel = opened ? "Sess√£o aberta" : "Sess√£o fechada";
  const sessaoLine = `${sessaoLabel} ‚Äî ${sessaoStr}`;
  setTextId("sessaoLineLogin", sessaoLine);
  setTextId("sessaoLineCons", sessaoLine);
  setTextId("paySessaoLine", sessaoLine);
  setTextId("sessaoLineWait", sessaoLine);
  setTextId("sessaoLinePres", sessaoLine);
  setTextId("sessaoStatus", opened ? "Aberta" : "Fechada");
  setTextId("lastCheck", now.toLocaleString("pt-BR"));

  updateEnvelopeUI();
}

applyBrand();
updateConvocacaoBadge();

/* ==========================
   PRODUCTS / TOTAL
========================== */
function animateTotal(to){
  const el1 = $("#totalValue");
  const el2 = $("#payTotal");
  const el3 = $("#pixValor");
  if(!el1 || !el2 || !el3 ) { lastTotal = to; return; }

  const from = Math.round(lastTotal);
  const target = Math.round(to);

  if(from === target){
    el1.textContent = fmtBRL(to);
    el2.textContent = fmtBRL(to);
    el3.textContent = fmtBRL(to);
    lastTotal = to;
    return;
  }
  const dir = target > from ? 1 : -1;
  let cur = from;
  const stepMs = 18;
  const timer = setInterval(()=>{
    cur += dir;
    el1.textContent = fmtBRL(cur);
    el2.textContent = fmtBRL(cur);
    el3.textContent = fmtBRL(cur);

    if(cur === target){
      clearInterval(timer);
      el1.textContent = fmtBRL(to);
      el2.textContent = fmtBRL(to);
      el3.textContent = fmtBRL(to);
      lastTotal = to;
    }
  }, stepMs);
}

function renderProducts(){
  const list=$("#prodList");
  list.innerHTML="";
  const produtos=Array.isArray(CFG?.produtos)?CFG.produtos:[];
  const cart=getCart();

  if(produtos.length===0){
    list.innerHTML='<div style="color:rgba(255,255,255,.65)">Sem produtos no JSON.</div>';
    return;
  }

  for(const p of produtos){
    const q=Number(cart[p.id]||0);
    const row=document.createElement("div");
    row.className="prodRow";
    row.innerHTML=`
      <div class="pIcon"><img src="${p.icon || './assets/icon-192.png'}" alt=""></div>
      <div class="pMid">
        <div class="pName">${p.nome||"Produto"}</div>
        <div class="pDesc">${p.desc||""}</div>
        <div class="pPrice">${fmtBRL(Number(p.preco||0))}</div>
      </div>
      <div class="qtyWrap">
        <button class="qtyBtn" data-act="dec" data-id="${p.id}">‚àí</button>
        <div class="qty" id="qty_${p.id}">${q}</div>
        <button class="qtyBtn" data-act="inc" data-id="${p.id}">+</button>
      </div>
    `;
    list.appendChild(row);
  }
  updateTotal();
}

function updateTotal(){
  const cart=getCart();
  const produtos=Array.isArray(CFG?.produtos)?CFG.produtos:[];
  let total=0;
  for(const p of produtos){
    total += Number(cart[p.id]||0)*Number(p.preco||0);
  }
  animateTotal(total);
  return total;
}

function findIrmao(tel,cim){
  tel=String(tel||"").replace(/\D/g,"");
  cim=String(cim||"").trim();
  return (Array.isArray(CFG?.irmaos)?CFG.irmaos:[]).find(i =>
    String(i.telefone||"").replace(/\D/g,"")===tel &&
    String(i.cim||"").trim()===cim
  );
}

function applyRememberedUser(){
  const u = getUser();
  const telWrap = document.getElementById("telWrap");
  const telInp  = document.getElementById("inpTel");
  const welcome = document.getElementById("welcomeTitle");
  const hasPhone = !!(u && u.telefone && String(u.telefone).trim());

  if (hasPhone){
    if (telWrap) telWrap.style.display = "none";
    if (telInp) {
      telInp.value = String(u.telefone);
      telInp.disabled = true;
    }
    if (welcome && u.nome) welcome.textContent = `Bem-vindo, ${u.nome} üëã`;
  } else {
    if (telWrap) telWrap.style.display = "";
    if (telInp) {
      telInp.disabled = false;
    }
    if (welcome) welcome.textContent = "Bem-vindo üëã";
  }
}

// ==========================
// ADMIN - DEPEND√äNCIAS M√çNIMAS (pra n√£o quebrar)
// ==========================
let ADMIN_CFG = null;
let ADMIN_TAB = "cfg";

// toast de erro (m√≠nimo)
function adminToastErr(msg){
  try { toast(msg || "Erro"); } catch(_) { console.warn(msg); }
}

// sanitiza telefone
function adminSanTel(s){
  return String(s || "").replace(/\D/g, "");
}

// set tab ativo (sem l√≥gica extra, s√≥ mostra/esconde)
function adminSetActiveTab(tab){
  ADMIN_TAB = tab || "cfg";

  document.getElementById("tabCfg")?.classList.toggle("active", ADMIN_TAB==="cfg");
  document.getElementById("tabSessao")?.classList.toggle("active", ADMIN_TAB==="sessao");
  document.getElementById("tabIrmaos")?.classList.toggle("active", ADMIN_TAB==="irmaos");

  document.getElementById("adminPanelCfg")?.classList.toggle("hidden", ADMIN_TAB!=="cfg");
  document.getElementById("adminPanelSessao")?.classList.toggle("hidden", ADMIN_TAB!=="sessao");
  document.getElementById("adminPanelIrmaos")?.classList.toggle("hidden", ADMIN_TAB!=="irmaos");
}


function setupAdminTap(){
  const logos = [$("#brandLogo"), $("#brandLogoWait")].filter(Boolean);
  for(const el of logos){
    el.addEventListener("click", ()=>{
      adminTapCount++;
      clearTimeout(adminTapTimer);
      adminTapTimer=setTimeout(()=>adminTapCount=0, 1200);
      if(adminTapCount>=5){
        adminTapCount=0;
        openAdmin();
      }
    });
  }
}
  
// carrega o json sempre do server (como voc√™ pediu)
async function adminLoadFromServer(){
  try{
    const r = await fetch("./agape_config.json?v=" + Date.now(), {
      cache: "no-store"
    });

    if(!r.ok){
      console.warn("admin_get_config http fail", r.status);
      adminToastErr("N√£o carregou config do servidor");
      return;
    }

    const j = await r.json();
    ADMIN_CFG = j; // <<< JSON PURO, SEM ENVELOPE

  }catch(e){
    console.warn("adminLoadFromServer error", e);
    adminToastErr("Erro ao carregar config");
  }
}
  
function adminSanTel(v){
  return String(v ?? "").replace(/\D+/g, ""); // s√≥ n√∫meros
}

async function openAdmin(){
  // 1) Garante CFG (pra senha). Se falhar, ainda d√° pra entrar com fallback.
  try{
    if(!window.CFG) window.CFG = await loadConfig();
  }catch(_){}

  // 2) Valida senha (telefone do tesoureiro). Se n√£o tiver, usa fallback s√≥ pra teste.
  const telTes = adminSanTel(window.CFG?.loja?.tesoureiro_whatsapp || "");
  const s = prompt("Senha do Admin (telefone do tesoureiro):");
  if(s === null) return; // cancelou
  const typed = adminSanTel(s);

  // fallback (S√ì PRA TESTE): se JSON n√£o tem tesoureiro, permite 1234 pra voc√™ validar UI
  const ok = telTes ? (typed === telTes) : (typed === "1234");
  if(!ok){
    toast("Senha inv√°lida");
    return;
  }

  // 3) Entra na tela e injeta FAKE CONFIG
  showScreen("scr_admin","forward");

  // CONFIG FAKE (m√≠nima) s√≥ pra renderizar tudo
  ADMIN_CFG = {
    loja: {
      nome: "Loja Prof. Clementino Brito",
      subtitulo: "App √Ågape ‚Ä¢ Consumo & Pagamento",
      pix_chave: "comissao.agape@gmail.com",
      tesoureiro_whatsapp: "5547992204527"
    },
    ui: {
      logo_url: "./assets/logo-Clementino-Brito.jpeg"
    },
    sessao: {
      status: "fechada",
      data: "01/02/2026",
      caixa_inicial: 500,
      chamado: "BOA NOITE MEUS QUERIDOS IRM√ÉOS! Sess√£o convocada. Toque para confirmar presen√ßa."
    },
    push: {
      habilitado: true,
      titulo: "Convoca√ß√£o",
      mensagem: "Sess√£o convocada. Toque para confirmar presen√ßa.",
      url: "/agape/index.html#presenca"
    },
    convocacao: {
      ativa: true,
      id: "2026-02-07-001",
      titulo: "Convoca√ß√£o",
      texto: "Sess√£o convocada. Confirme sua presen√ßa."
    },
    irmaos: [
      {nome:"Edson Do Carmo", telefone:"48992204527", cim:"825955"},
      {nome:"George Peterson Ramos", telefone:"47992204527", cim:"825958"},
      {nome:"Helder Souza", telefone:"48992204552", cim:"825960"}
    ],
    produtos: [
      {id:"agua", nome:"√Ågua", desc:"Garrafinha", preco:5.0, icon:"./assets/agua.jpg", img:"./assets/agua.jpg"},
      {id:"carvao", nome:"Carv√£o", desc:"Saco 5kg", preco:35.0, icon:"./assets/carvao.jpg", img:"./assets/carvao.jpg"}
    ]
  };

  // 4) Agora sim: bind + render
  adminBindUI?.();
  adminSetActiveTab?.("cfg"); // for√ßa render/realce da aba
  toast("Admin (modo teste) ‚úÖ");
}

async function adminLoadFromServer(){
  try{
    const r=await fetch("./agape_config.json?v=" + Date.now(),{cache:"no-store"});
    const j = await r.json().catch(()=> ({}));
    if(!r.ok || !j.ok || !j.config){
      console.warn("admin_get_config fail", r.status, j);
      adminToastErr("N√£o carregou config do servidor");
      return;
    }
    ADMIN_CFG = r.config;

    // espelha logo
    const logoUrl = (ADMIN_CFG?.ui?.logo_url) ? ADMIN_CFG.ui.logo_url : "./assets/logo-Clementino-Brito.jpeg";
    const adminLogo = document.getElementById("adminLogo");
    if(adminLogo) adminLogo.src = logoUrl;

    ADMIN_TAB = "cfg";
    adminSetActiveTab("cfg");
    toast("Admin (modo teste) ‚úÖ");
  }catch(e){
    console.warn(e);
    adminToastErr("Erro carregando Admin");
  }
}

async function adminSaveToServer(){
  if(!ADMIN_CFG) return;

  try{
    const r = await fetch(ADMIN_SAVE_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ senha: ADMIN_SENHA, config: ADMIN_CFG })
    });
    const j = await r.json().catch(()=> ({}));
    if(!r.ok || !j.ok){
      console.warn("admin_save fail", r.status, j);
      adminToastErr("Falha ao salvar");
      return;
    }

    // atualiza CFG local tamb√©m (sem limpar storage)
    CFG = ADMIN_CFG;
    applyBrand();
    renderProducts();
    refreshPresenceUI();
    updateConvocacaoBadge();
    updatePresenceConfirmedWait?.();

    toast("Admin (modo teste) ‚úÖ");
  }catch(e){
    console.warn(e);
    adminToastErr("Erro ao salvar");
  }
}

async function adminUploadLogo(file){
  if(!file) return;
  try{
    const fd = new FormData();
    fd.append("senha", ADMIN_SENHA);
    fd.append("file", file);

    const r = await fetch(ADMIN_UPLOAD_URL, { method:"POST", body: fd });
    const j = await r.json().catch(()=> ({}));
    if(!r.ok || !j.ok || !j.url){
      console.warn("upload fail", r.status, j);
      adminToastErr("Falha upload");
      return;
    }

    if(!ADMIN_CFG.ui) ADMIN_CFG.ui = {};
    ADMIN_CFG.ui.logo_url = j.url;

    // re-render
    adminRender();
    toast("Admin (modo teste) ‚úÖ");
  }catch(e){
    console.warn(e);
    adminToastErr("Erro upload");
  }
}

function adminRender(){
  const p = document.getElementById("adminPanel");
  if(!p) return;

  if(!ADMIN_CFG){
    p.innerHTML = `<div style="opacity:.75;font-weight:900">Carregando...</div>`;
    return;
  }

  if(ADMIN_TAB==="cfg"){
    const loja = ADMIN_CFG.loja || {};
    const ui = ADMIN_CFG.ui || {};
    p.innerHTML = `
      <div class="aLbl">Nome da Loja</div>
      <input class="aInp" id="a_loja_nome" value="${escapeHtml(loja.nome||"")}" />

      <div class="aLbl">Subt√≠tulo</div>
      <input class="aInp" id="a_loja_sub" value="${escapeHtml(loja.subtitulo||"")}" />

      <div class="aLbl">Chave Pix</div>
      <input class="aInp" id="a_loja_pix" value="${escapeHtml(loja.pix_chave||"")}" />

      <div class="aLbl">Telefone do tesoureiro (senha do Admin)</div>
      <input class="aInp" id="a_loja_tes" value="${escapeHtml(loja.tesoureiro_whatsapp||"")}" />

      <div class="aLbl">Logo (upload)</div>
      <div class="aRow">
        <input class="aInp" id="a_logo_url" value="${escapeHtml(ui.logo_url||"")}" placeholder="/assets/logo.png" />
        <input class="aInp" id="a_logo_file" type="file" accept="image/*" />
      </div>
      <div style="margin-top:8px; opacity:.75; font-size:12px;">Ao escolher arquivo, ele faz upload em /assets e grava ui.logo_url.</div>
    `;

    const f = document.getElementById("a_logo_file");
    if(f){
      f.onchange = ()=> {
        const file = f.files && f.files[0];
        if(file) adminUploadLogo(file);
      };
    }
    return;
  }

  if(ADMIN_TAB==="sessao"){
    const sessao = ADMIN_CFG.sessao || {};
    const push = ADMIN_CFG.push || {};
    const conv = ADMIN_CFG.convocacao || {};

    p.innerHTML = `
      <div class="aLbl">Status da Sess√£o</div>
      <select class="aInp" id="a_sessao_status">
        <option value="fechada" ${String(sessao.status||"").toLowerCase()==="fechada"?"selected":""}>Fechada</option>
        <option value="aberta" ${String(sessao.status||"").toLowerCase()==="aberta"?"selected":""}>Aberta</option>
      </select>

      <div class="aLbl">Data da sess√£o (DD/MM/AAAA)</div>
      <input class="aInp" id="a_sessao_data" value="${escapeHtml(sessao.data||"")}" placeholder="01/02/2026" />

      <div class="aLbl">Caixa inicial (R$)</div>
      <input class="aInp" id="a_sessao_caixa" value="${escapeHtml(String(sessao.caixa_inicial ?? ""))}" placeholder="500" />

      <div class="aLbl">Chamado do Vener√°vel (texto)</div>
      <textarea class="aTxt" id="a_sessao_chamado">${escapeHtml(sessao.chamado||"")}</textarea>

      <div class="aLbl">PUSH</div>
      <div class="aRow">
        <select class="aInp" id="a_push_on">
          <option value="true" ${push.habilitado===true?"selected":""}>Ativado</option>
          <option value="false" ${push.habilitado!==true?"selected":""}>Desativado</option>
        </select>
        <input class="aInp" id="a_push_titulo" value="${escapeHtml(push.titulo||"Convoca√ß√£o")}" placeholder="T√≠tulo" />
      </div>

      <div class="aLbl">Mensagem do PUSH</div>
      <input class="aInp" id="a_push_msg" value="${escapeHtml(push.mensagem||"")}" />

      <div class="aLbl">URL ao tocar</div>
      <input class="aInp" id="a_push_url" value="${escapeHtml(push.url||"/agape/index.html#presenca")}" />

      <div class="aLbl">CONVOCA√á√ÉO</div>
      <div class="aRow">
        <select class="aInp" id="a_conv_on">
          <option value="true" ${conv.ativa===true?"selected":""}>Ativada</option>
          <option value="false" ${conv.ativa!==true?"selected":""}>Desativada</option>
        </select>
        <input class="aInp" id="a_conv_id" value="${escapeHtml(conv.id||"")}" placeholder="2026-02-07-001" />
      </div>
      <div class="aRow">
        <input class="aInp" id="a_conv_titulo" value="${escapeHtml(conv.titulo||"Convoca√ß√£o")}" placeholder="T√≠tulo (convoca√ß√£o)" />
        <input class="aInp" id="a_conv_texto" value="${escapeHtml(conv.texto||"")}" placeholder="Texto (convoca√ß√£o)" />
      </div>

      <div class="aRow" style="margin-top:12px;">
        <button class="aMini" id="btnAdminEnviarPush" type="button">DISPARAR NOTIFICA√á√ÉO</button>
        <button class="aMini" id="btnAdminResumo" type="button">ATUALIZAR RESUMO</button>
      </div>

      <div class="aLbl">Resumo do Consumo (online)</div>
      <div id="adminResumoBox" style="margin-top:10px; opacity:.85;">‚Äî</div>
    `;

    document.getElementById("btnAdminEnviarPush")?.addEventListener("click", adminSendPushNow);
    document.getElementById("btnAdminResumo")?.addEventListener("click", adminLoadResumoConsumo);

    // carrega resumo automaticamente
    adminLoadResumoConsumo();
    return;
  }

  if(ADMIN_TAB==="irmaos"){
    const arr = Array.isArray(ADMIN_CFG.irmaos) ? ADMIN_CFG.irmaos : [];
    const rows = arr.map((it, idx)=>`
      <tr>
        <td><input class="aInp" data-i="${idx}" data-k="nome" value="${escapeHtml(it.nome||"")}" /></td>
        <td><input class="aInp" data-i="${idx}" data-k="telefone" value="${escapeHtml(it.telefone||"")}" /></td>
        <td><input class="aInp" data-i="${idx}" data-k="cim" value="${escapeHtml(it.cim||"")}" /></td>
        <td><button class="aMini" data-del="${idx}" type="button">X</button></td>
      </tr>
    `).join("");

    p.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
        <div style="font-weight:1000;">Irm√£os cadastrados: ${arr.length}</div>
        <button class="aMini" id="btnAddIrmao" type="button">+ Adicionar</button>
      </div>

      <table class="adminTable">
        <thead>
          <tr><th>Nome</th><th>Telefone</th><th>CIM</th><th></th></tr>
        </thead>
        <tbody id="tbIrmaos">${rows || `<tr><td colspan="4" style="opacity:.75">Nenhum irm√£o no JSON.</td></tr>`}</tbody>
      </table>

      <div style="margin-top:10px; opacity:.75; font-size:12px;">
        Status (Admin): N√£o confirmado / Somente sess√£o / Somente √°gape / Sess√£o e √°gape (isso aparece no painel de presen√ßa do app).
      </div>
    `;

    document.getElementById("btnAddIrmao")?.addEventListener("click", ()=>{
      if(!Array.isArray(ADMIN_CFG.irmaos)) ADMIN_CFG.irmaos = [];
      ADMIN_CFG.irmaos.push({nome:"", telefone:"", cim:""});
      adminRender();
    });

    // binds: inputs
    p.querySelectorAll("input[data-i][data-k]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const i = Number(inp.getAttribute("data-i"));
        const k = inp.getAttribute("data-k");
        if(!Array.isArray(ADMIN_CFG.irmaos) || !ADMIN_CFG.irmaos[i]) return;
        ADMIN_CFG.irmaos[i][k] = inp.value;
      });
    });

    // delete
    p.querySelectorAll("button[data-del]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const i = Number(b.getAttribute("data-del"));
        if(!Array.isArray(ADMIN_CFG.irmaos)) return;
        ADMIN_CFG.irmaos.splice(i,1);
        adminRender();
      });
    });

    return;
  }
}

async function adminLoadResumoConsumo(){
  try{
    const data = adminVal("a_sessao_data") || (ADMIN_CFG?.sessao?.data || "");
    const sessao_id = adminSessaoIdFromData(data);

    const r= await fetch(`${CONSUMO_RESUMO_URL}?sessao_id=${encodeURIComponent(sessao_id)}`, {cache:"no-store"});
    const j = await r.json().catch(()=> ({}));

    const box = document.getElementById("adminResumoBox");
    if(!box) return;

    if(!r.ok || !j.ok){
      box.innerHTML = `<div style="opacity:.75">Falha ao ler resumo.</div>`;
      return;
    }

    const tp = j.totais_pagamento || {};
    const din = Number(tp.dinheiro||0), pix = Number(tp.pix||0), prox = Number(tp.proxima||0);
    const caixaDin = Number(j.caixa_dinheiro||0);

    const topProds = Array.isArray(j.produtos) ? j.produtos.slice(0,8) : [];
    const pend = Array.isArray(j.pendencias) ? j.pendencias : [];

    box.innerHTML = `
      <div class="aRow">
        <div><span class="adminBadge">Dinheiro</span> <b>${fmtBRL(din)}</b></div>
        <div><span class="adminBadge">Pix</span> <b>${fmtBRL(pix)}</b></div>
      </div>
      <div class="aRow">
        <div><span class="adminBadge">Pr√≥xima</span> <b>${fmtBRL(prox)}</b></div>
        <div><span class="adminBadge">Caixa (DIN)</span> <b>${fmtBRL(caixaDin)}</b></div>
      </div>

      <div class="aLbl">Top produtos (qtd / total)</div>
      ${topProds.length ? `
        <table class="adminTable">
          <thead><tr><th>Produto</th><th>Qtd</th><th>Total</th></tr></thead>
          <tbody>
            ${topProds.map(p=>`
              <tr>
                <td>${escapeHtml(p.desc||p.id)}</td>
                <td><b>${String(p.qtd||0)}</b></td>
                <td><b>${fmtBRL(Number(p.total||0))}</b></td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      ` : `<div style="opacity:.75">Nenhum consumo registrado ainda.</div>`}

      <div class="aLbl">Pend√™ncias (pr√≥xima sess√£o)</div>
      ${pend.length ? `
        <table class="adminTable">
          <thead><tr><th>Irm√£o</th><th>Telefone</th><th>Total</th></tr></thead>
          <tbody>
            ${pend.slice(0,12).map(x=>`
              <tr>
                <td>${escapeHtml(x.nome||"")}</td>
                <td>${escapeHtml(x.telefone||"")}</td>
                <td><b>${fmtBRL(Number(x.total||0))}</b></td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      ` : `<div style="opacity:.75">Sem pend√™ncias.</div>`}
    `;
  }catch(e){
    console.warn(e);
  }
}

async function adminSendPushNow(){
  try{
    // respeita regra: se push e convocacao estiverem ativos
    const pushOn = adminVal("a_push_on")==="true";
    const convOn = adminVal("a_conv_on")==="true";
    if(!pushOn || !convOn){
      toast("Ative PUSH e CONVOCA√á√ÉO para disparar");
      return;
    }

    const title = adminVal("a_push_titulo") || "Convoca√ß√£o";
    const body  = adminVal("a_push_msg") || "Sess√£o convocada. Confirme sua presen√ßa.";
    const url   = adminVal("a_push_url") || "/agape/index.html#presenca";

    const r = await fetch("https://api.erpimpar.com.br/agape/push/push_send.php", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ title, body, url })
    });

    const j = await r.json().catch(()=> ({}));
    if(r.ok && j.ok) toast(`Notifica√ß√£o enviada ‚úÖ (${j.sent||0})`);
    else toast("Falha ao enviar notifica√ß√£o");
  }catch(e){
    console.warn(e);
    toast("Erro ao enviar notifica√ß√£o");
  }
}

function adminBindUI(){
  document.getElementById("tabCfg")?.addEventListener("click", ()=>adminSetActiveTab("cfg"));
  document.getElementById("tabSessao")?.addEventListener("click", ()=>adminSetActiveTab("sessao"));
  document.getElementById("tabIrmaos")?.addEventListener("click", ()=>adminSetActiveTab("irmaos"));

  document.getElementById("btnAdminSair")?.addEventListener("click", ()=>{
    // sair N√ÉO salva nada
    showScreen("scr_login","back");
  });

  document.getElementById("btnAdminSalvar")?.addEventListener("click", ()=>{
    if(!ADMIN_CFG) return;

    // aplica changes da aba atual no ADMIN_CFG (m√≠nimo)
    if(ADMIN_TAB==="cfg"){
      if(!ADMIN_CFG.loja) ADMIN_CFG.loja = {};
      if(!ADMIN_CFG.ui) ADMIN_CFG.ui = {};
      ADMIN_CFG.loja.nome = adminVal("a_loja_nome");
      ADMIN_CFG.loja.subtitulo = adminVal("a_loja_sub");
      ADMIN_CFG.loja.pix_chave = adminVal("a_loja_pix");
      ADMIN_CFG.loja.tesoureiro_whatsapp = adminVal("a_loja_tes");
      ADMIN_CFG.ui.logo_url = adminVal("a_logo_url") || ADMIN_CFG.ui.logo_url;
    }

    if(ADMIN_TAB==="sessao"){
      if(!ADMIN_CFG.sessao) ADMIN_CFG.sessao = {};
      if(!ADMIN_CFG.push) ADMIN_CFG.push = {};
      if(!ADMIN_CFG.convocacao) ADMIN_CFG.convocacao = {};

      ADMIN_CFG.sessao.status = adminVal("a_sessao_status");
      ADMIN_CFG.sessao.data = adminVal("a_sessao_data");
      ADMIN_CFG.sessao.caixa_inicial = Number(adminVal("a_sessao_caixa")||0);
      ADMIN_CFG.sessao.chamado = adminVal("a_sessao_chamado");

      ADMIN_CFG.push.habilitado = (adminVal("a_push_on")==="true");
      ADMIN_CFG.push.titulo = adminVal("a_push_titulo");
      ADMIN_CFG.push.mensagem = adminVal("a_push_msg");
      ADMIN_CFG.push.url = adminVal("a_push_url");

      ADMIN_CFG.convocacao.ativa = (adminVal("a_conv_on")==="true");
      ADMIN_CFG.convocacao.id = adminVal("a_conv_id");
      ADMIN_CFG.convocacao.titulo = adminVal("a_conv_titulo");
      ADMIN_CFG.convocacao.texto = adminVal("a_conv_texto");
    }

    // salva no servidor
    adminSaveToServer();
  });
}
  
/* ==========================
   WAIT POLLING
========================== */
function nowDT(){ return new Date().toLocaleString("pt-BR"); }

function stopWaitPolling(){
  if(waitTimer){ clearInterval(waitTimer); waitTimer=null; }
  if(waitOpenTimer){ clearInterval(waitOpenTimer); waitOpenTimer=null; }
  waitPollingStarted=false;
}

function startWaitPolling(){
  if(waitPollingStarted) return;
  waitPollingStarted=true;
  stopWaitPolling();

  const tick = async ()=>{
    try{
      setText('lastCheck', nowDT());
      CFG = await loadConfig();
      updateConvocacaoBadge();
      initCashFromConfig();
      applyBrand();
      
      try{ updatePresenceConfirmedWait(); }catch(_){}
      try{ if(typeof startWaitPresencaFX==="function") startWaitPresencaFX(); }catch(_){}
      
      renderCash();

      if(sessionIsOpen()){
        stopWaitPolling();
        showScreen("scr_login","forward");
      }
    }catch(_){}
  };

  tick();
  waitTimer = setInterval(tick, 6000);

  waitOpenTimer = setInterval(async ()=>{
    if(currentScreen !== 'scr_wait') return;
    try{
      CFG = await loadConfig();
      applyBrand();
      if(sessionIsOpen()){
        stopWaitPolling();
        showScreen('scr_login','forward');
      }
    }catch(_){}
  }, 15000);
}

/* ==========================
   PAY FLOW
========================== */
function buildPayScreen(){
  payReady = false;
  setTimeout(()=>{ payReady = true; }, 350);

  applyBrand();

  const u = getUser() || {};
  const nome = (u.nome||"").trim();
  setText("payHello", nome ? `Oi meu irm√£o, ${nome}!` : "Oi meu irm√£o!");

  const total = updateTotal();
  setText("payTotal", fmtBRL(total));
  setText("pixValor", fmtBRL(total));

  const cart = getCart();
  const entries = cartEntries(cart).filter(x=>x.qtd>0);

  const prods = (CFG && Array.isArray(CFG.produtos)) ? CFG.produtos : [];
  const byId = Object.fromEntries(prods.map(p=>[String(p.id), p]));

  const lines = entries.map(e=>{
    const p = byId[e.id] || {};
    const nomeP = p.nome || `Item ${e.id}`;
    const preco = Number(p.preco||0);
    const sub = e.qtd * preco;
    return {q:e.qtd, nome:nomeP, sub};
  });

  const box = document.getElementById("payItems");
  if(box){
    if(lines.length===0){
      box.innerHTML = `<div style="opacity:.75;font-weight:900">Nenhum item selecionado.</div>`;
    }else{
      box.innerHTML = lines.map(l=>{
        const left = `${l.q} ${l.nome}`;
        const right = fmtBRL(l.sub);
        return `<div class="payItemRow"><div class="payItemLeft">${escapeHtml(left)}</div><div class="payItemDots"></div><div class="payItemRight">${escapeHtml(right)}</div></div>`;
      }).join("");
    }
  }
}

function openPixModal(){
  const total = updateTotal();
  const key = (CFG && CFG.loja && CFG.loja.pix_chave) ? String(CFG.loja.pix_chave).trim() : "";
  if(!key){ toast("Chave Pix n√£o configurada"); return; }

  const elValor = document.getElementById("pixValor");
  if(elValor) elValor.textContent = fmtBRL(total);

  const payload = buildPixPayload({
    key,
    amount: total,
    merchantName: (CFG && CFG.loja && CFG.loja.nome) ? CFG.loja.nome : "AGAPE",
    merchantCity: (CFG && CFG.loja && CFG.loja.cidade) ? CFG.loja.cidade : "BRASIL",
    txid: "AGAPE"
  });

  const elCode =
    document.getElementById("pixChaveModal") ||
    document.getElementById("pixChave") ||
    document.getElementById("pixKeyText") ||
    null;

  if(elCode) elCode.textContent = payload;

  const modal = document.getElementById("pixModal");
  if(modal) modal.classList.remove("hidden");
}

function closePixModal(){
  const modal = document.getElementById("pixModal");
  if(modal) modal.classList.add("hidden");
}

async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); toast("Copiado ‚úÖ"); }
  catch(_){
    const ta=document.createElement("textarea");
    ta.value=txt; ta.style.position="fixed"; ta.style.left="-9999px";
    document.body.appendChild(ta); ta.focus(); ta.select();
    try{ document.execCommand("copy"); toast("Copiado ‚úÖ"); } catch(__){ toast("N√£o foi poss√≠vel copiar"); }
    document.body.removeChild(ta);
  }
}

function showPaySuccess(){
  const ps = document.getElementById("paySuccess");
  if(ps) ps.classList.remove("hidden");
  const gif = document.getElementById("payGif");
  if(gif){
    const src = gif.getAttribute("src") || "./assets/check.gif";
    gif.setAttribute("src", src.split("?")[0] + "?t=" + Date.now());
  }
  try{
    const a = new Audio("./assets/coin.mp3");
    a.play().catch(()=>{});
  }catch(e){}
}

function hidePaySuccess(){
  const ps = document.getElementById("paySuccess");
  if(ps) ps.classList.add("hidden");
}

const CONSUMO_LOG_URL = "https://api.erpimpar.com.br/agape/consumo/consumo_log.php";

function makeSessaoId(){
  // transforma "01/02/2026" -> "2026-02-01"
  const d = String(CFG?.sessao?.data || "").trim();
  const m = d.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  return m ? `${m[3]}-${m[2]}-${m[1]}` : d.replaceAll("/", "-");
}

function buildConsumoPayload(tipo){
  const u = getUser() || {};
  const cart = getCart();
  const entries = cartEntries(cart).filter(x => x.qtd > 0);

  const prods = (CFG && Array.isArray(CFG.produtos)) ? CFG.produtos : [];
  const byId = Object.fromEntries(prods.map(p => [String(p.id), p]));

  const itens = entries.map(e=>{
    const p = byId[e.id] || {};
    const preco = Number(p.preco || 0);
    const subtotal = Number(e.qtd || 0) * preco;
    return {
      id: String(e.id),
      desc: String(p.nome || p.desc || `Item ${e.id}`),
      qtd: Number(e.qtd || 0),
      preco: preco,
      subtotal: subtotal
    };
  });

  const total = itens.reduce((s,it)=> s + Number(it.subtotal||0), 0);

  const sessao_id = makeSessaoId();
  const tel = String(u.telefone || "").replace(/\D/g,"");
  const txid = `${sessao_id}-${tel || "semfone"}-${Date.now()}`;

  return {
    sessao_id,
    sessao_data: String(CFG?.sessao?.data || "").trim(),
    loja: String(CFG?.loja?.nome || "Loja"),
    timestamp: new Date().toISOString(),
    pagamento: String(tipo),
    irmao: { nome: String(u.nome || ""), telefone: tel },
    total,
    itens,
    txid
  };
}

async function logConsumoOnline(tipo){
  try{
    const payload = buildConsumoPayload(tipo);

    // se n√£o tem itens, n√£o grava
    if(!payload.itens || payload.itens.length === 0) return;

    const r = await fetch(CONSUMO_LOG_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    // n√£o quebra o app se falhar
    const j = await r.json().catch(()=> ({}));
    if(!r.ok || !j.ok){
      console.warn("Falha ao logar consumo", r.status, j);
    }
  }catch(e){
    console.warn("Erro ao logar consumo", e);
  }
}

  
function finalizePayment(tipo, msg){
  const total = updateTotal();

  logConsumoOnline(tipo);
  
  if(tipo === "dinheiro" || tipo === "pix"){
    setCash(getCash() + Number(total || 0));
    renderCash();
  }

  toast(msg);
  clearCart();
  updateTotal();
  closePixModal();
  showPaySuccess();

  setTimeout(()=>{
    hidePaySuccess();
    showScreen("scr_login","back");
  }, 2200);
}

/* ==========================
   EXIT
========================== */
function sairDoAplicativo(){
  //try{ localStorage.removeItem(LS_USER); }catch(_){}
  try{ localStorage.removeItem(LS_CART); }catch(_){}
  try{ sessionStorage.clear(); }catch(_){}
  setTimeout(()=>{
    try{ window.location.href = "about:blank"; }catch(_){}
    try{ window.close(); }catch(_){}
  }, 80);
}

/* ==========================
   PUSH HELPERS (‚úÖ agora no lugar certo)
========================== */
function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

const VAPID_PUBLIC_KEY = "BCtLtf7ypOpSkMuuN_OmoV-jm7t6Fk34uMkK3wtjZUaw5hUBZwfs2XfGOb5WL1UzE-5uRDf_jSCYlu35wcFtRY4";
const PUSH_SUBSCRIBE_URL = "https://api.erpimpar.com.br/agape/push/push_subscribe.php";

/* ==========================
   REGISTER PUSH (‚úÖ m√≠nimo + sem duplicar inscri√ß√£o)
========================== */
async function registerPush() {
  if (!("serviceWorker" in navigator)) return;

  const reg = await navigator.serviceWorker.ready;

  const permission = await Notification.requestPermission();
  if (permission !== "granted") {
    console.warn("Permiss√£o de notifica√ß√£o negada");
    return;
  }

  // ‚úÖ evita duplicar / re-assinar toda vez
  let subscription = await reg.pushManager.getSubscription();

  if (!subscription) {
    subscription = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
    });
  }

  const sub = subscription.toJSON();

  await fetch(PUSH_SUBSCRIBE_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(sub)
  });

  console.log("Push registrado com sucesso");
}

/* ==========================
   BOOT
========================== */
async function boot(){
  // 1) Service Worker
  if("serviceWorker" in navigator){
    try{
      await navigator.serviceWorker.register("./service-worker.js");
      console.log("SW registrado");
    }catch(e){
      console.warn("Erro SW", e);
    }
  }

  // 2) Config primeiro
try{
  CFG = await loadConfig();   // <- mantenha assim
  try{ updatePresenceConfirmedWait(); }catch(_){}
  try{ if(typeof startWaitPresencaFX==="function") startWaitPresencaFX(); }catch(_){}
  try{ updateConvocacaoBadge(); }catch(_){}
}catch(_){
  // fallback, se precisar
}


  // 3) S√≥ tenta push se estiver habilitado no JSON
  try{
    if (CFG?.push?.habilitado === true) {
      await registerPush();
    }
  }catch(e){
    console.warn("Push n√£o registrado", e);
  }

  setTimeout(()=>{
    const img = document.getElementById("splashSymbol");
    if(img) img.src = "./assets/maconaria.gif";
  }, 1200);

  setTimeout(()=>{ showScreen("scr_splash2","forward"); }, GIF_TIME);

  setTimeout(()=>{
    applyBrand();
    initCashFromConfig();
    renderCash();
    applyRememberedUser();
    setupAdminTap();
    bindPresencaUI();
    refreshPresenceUI();
    updateEnvelopeUI();
    adminBindUI();

    if(sessionIsOpen()){
      showScreen("scr_login","forward");
    }else{
      showScreen("scr_wait","forward");
      startWaitPolling();
    }
  }, GIF_TIME + ZOOM_TIME);

  // LOGIN
  document.getElementById("btnEntrar")?.addEventListener("click", async ()=>{
    const u = getUser();
    const savedTel = u?.telefone ? String(u.telefone).replace(/\D/g,"") : "";

    const telInp = document.getElementById("inpTel");
    const tel = savedTel || (telInp ? String(telInp.value||"").replace(/\D/g,"") : "");

    const cimInp = document.getElementById("inpCIM");
    const cim = cimInp ? String(cimInp.value||"").trim() : "";

    if(!tel){ toast("Digite o telefone"); return; }
    if(!cim){ toast("Digite o CIM"); return; }

    try{ CFG = await loadConfig(); }catch(_){}
    applyBrand();

    const irmao = findIrmao(tel, cim);
    if(!irmao){ toast("CIM inv√°lido"); return; }

    setUser({ nome: irmao.nome, telefone: String(irmao.telefone).replace(/\D/g,"") });
    applyRememberedUser();

    if(!sessionIsOpen()){
      toast("Sess√£o fechada (tesoureiro precisa abrir)");
      showScreen("scr_wait","forward");
      startWaitPolling();
      return;
    }

    renderProducts();
    lastTotal = 0;
    updateTotal();
    initCashFromConfig();
    renderCash();
    showScreen("scr_consumo","forward");
  });

  // QTY
  document.addEventListener("click",(e)=>{
    const btn=e.target.closest(".qtyBtn");
    if(!btn) return;
    const id=btn.getAttribute("data-id");
    const act=btn.getAttribute("data-act");
    const cart=getCart();
    const cur=Number(cart[id]||0);
    cart[id]= act==="inc" ? cur+1 : Math.max(0, cur-1);
    setCart(cart);
    const el=document.getElementById("qty_"+id);
    if(el) el.textContent=String(cart[id]);
    updateTotal();
  });

  // FECHAR -> PAGAMENTO
  document.getElementById("btnFechar")?.addEventListener("click", ()=>{
    const total = updateTotal();
    if(total<=0){ toast("Selecione ao menos 1 item"); return; }
    buildPayScreen();
    hidePaySuccess();
    closePixModal();
    showScreen("scr_pagamento","forward");
  });

  document.getElementById("btnVoltarConsumo")?.addEventListener("click", ()=>{
    closePixModal();
    hidePaySuccess();
    showScreen("scr_consumo","back");
  });

  document.getElementById("btnSair")?.addEventListener("click", ()=>{
    closePixModal();
    hidePaySuccess();
    clearCart();
    const cim = document.getElementById("inpCIM"); if(cim) cim.value="";
    showScreen("scr_login","back");
    toast("Saiu");
  });

  document.getElementById("btnSairWait")?.addEventListener("click", ()=>{
    if(confirm("Deseja sair do aplicativo?")) sairDoAplicativo();
  });

  document.getElementById("btnSairLogin")?.addEventListener("click", sairDoAplicativo);

  // PAY
  document.getElementById("btnPix")?.addEventListener("click", ()=>{
    if(!payReady) return;
    openPixModal();
  });
  document.getElementById("btnDinheiro")?.addEventListener("click", ()=>{
    if(!payReady) return;
    finalizePayment("dinheiro", "Registrado: dinheiro");
  });
  document.getElementById("btnProxima")?.addEventListener("click", ()=>{
    if(!payReady) return;
    finalizePayment("proxima", "Registrado: pr√≥xima sess√£o");
  });

  document.getElementById("btnCopyPix")?.addEventListener("click", ()=>{
    const el = document.getElementById("pixChaveModal");
    const payload = el ? (el.textContent || "").trim() : "";
    if(!payload){ toast("C√≥digo Pix vazio"); return; }
    copyText(payload);
  });

  ["btnPixCancel","btnPixCancel2"].forEach(id=>{
    const b = document.getElementById(id);
    if(b) b.addEventListener("click", closePixModal);
  });

  document.getElementById("btnPixOk")?.addEventListener("click", ()=>{
    if(!payReady) return;
    finalizePayment("pix", "Registrado: pix");
  });
}

/* ======== PRESEN√áA (mantido como voc√™ tinha) ======== */
function highlightPresenceChoice(chosenId){
  const ids = ["btnRespSessaoAgape","btnRespSessao","btnRespAgape"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove("isChosen");
  });

  const chosen = document.getElementById(chosenId);
  if(chosen) chosen.classList.add("isChosen");
}
document.getElementById("btnRespSessaoAgape")?.addEventListener("click", ()=>{
  setPresencaAns("sessao_agape");
  highlightPresenceChoice("btnRespSessaoAgape");
  refreshPresenceUI();
  updateEnvelopeUI();
});

document.getElementById("btnRespSessao")?.addEventListener("click", ()=>{
  setPresencaAns("somente_sessao");
  highlightPresenceChoice("btnRespSessao");
  refreshPresenceUI();
  updateEnvelopeUI();
});

document.getElementById("btnRespAgape")?.addEventListener("click", ()=>{
  setPresencaAns("somente_agape");
  highlightPresenceChoice("btnRespAgape");
  refreshPresenceUI();
  updateEnvelopeUI();
});

const PRES_SUCCESS_MS = 6000;

function highlightPresenceChoiceByVal(ans){
  const map = {
    "sessao_agape": "btnRespSessaoAgape",
    "somente_sessao": "btnRespSessao",
    "somente_agape": "btnRespAgape",
  };
  const chosenId = map[String(ans||"")];
  const ids = ["btnRespSessaoAgape","btnRespSessao","btnRespAgape"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove("isChosen");
  });
  if(chosenId){
    const chosen = document.getElementById(chosenId);
    if(chosen) chosen.classList.add("isChosen");
  }
}

function showPresSuccess(){
  const ov = document.getElementById("presSuccess");
  if(ov) ov.classList.remove("hidden");

  const gif = document.getElementById("presGif");
  if(gif){
    const src = gif.getAttribute("src") || "./assets/presenca.gif";
    gif.setAttribute("src", src.split("?")[0] + "?t=" + Date.now());
  }
}
function hidePresSuccess(){
  const ov = document.getElementById("presSuccess");
  if(ov) ov.classList.add("hidden");
}

function updatePresenceConfirmedWait(){
  const el = document.getElementById("waitPresencaOk");
  if(!el) return;
  const ans = (typeof getPresencaAns === "function") ? (getPresencaAns() || "") : "";
  el.classList.toggle("hidden", !ans);
  startWaitPresencaFX();
}

let _waitPresFxTimer = null;  
  
function startWaitPresencaFX(){
  const el = document.getElementById("waitPresencaOk");
  if(!el) return;

  // evita duplicar timers
  if(_waitPresFxTimer){ clearInterval(_waitPresFxTimer); _waitPresFxTimer = null; }

  const pick = (arr)=> arr[Math.floor(Math.random()*arr.length)];

  const applyOnce = ()=>{
    // s√≥ anima se realmente tem resposta
    const ans = (typeof getPresencaAns === "function") ? (getPresencaAns() || "") : "";
    if(!ans || el.classList.contains("hidden")){
      el.classList.remove("pulse","blink");
      return;
    }

    const label =
      ans === "sessao_agape" ? "SESS√ÉO E √ÅGAPE" :
      ans === "somente_sessao" ? "SOMENTE SESS√ÉO" :
      ans === "somente_agape" ? "SOMENTE √ÅGAPE" : "‚Äî";

    // alterna texto (aleat√≥rio)
    el.textContent = pick([
      "‚úÖ PRESEN√áA J√Å CONFIRMADA",
      `‚úÖ ESCOLHIDO: ${label}`,
      "‚úÖ CONFIRMADO COM SUCESSO"
    ]);

    // alterna efeito (aleat√≥rio)
    el.classList.remove("pulse","blink");
    el.classList.add(pick(["pulse","blink"]));

    // alterna fundo/borda (azuis claros transparentes, aleat√≥rio)
// alterna fundo/borda (multicores transparentes, aleat√≥rio)
const bg = pick([
  // AZUIS
  "rgba(80,170,255,.14)",
  "rgba(100,190,255,.18)",
  "rgba(60,160,255,.12)",
  "rgba(120,210,255,.16)",

  // VERDES
  "rgba(60,200,120,.14)",
  "rgba(80,220,150,.18)",
  "rgba(40,180,110,.12)",
  "rgba(100,240,190,.16)",

  // AMARELOS (dourado suave)
  "rgba(255,215,0,.14)",
  "rgba(255,200,60,.16)",

  // VERMELHO SUAVE (alerta leve, sem assustar)
  "rgba(255,80,80,.10)",
  "rgba(255,120,120,.12)"
]);

const bd = pick([
  // AZUIS
  "rgba(140,210,255,.26)",
  "rgba(170,230,255,.30)",
  "rgba(120,200,255,.22)",
  "rgba(190,240,255,.28)",

  // VERDES
  "rgba(120,255,210,.25)",
  "rgba(150,255,220,.28)",
  "rgba(100,240,190,.22)",

  // AMARELOS
  "rgba(255,215,0,.28)",
  "rgba(255,230,120,.22)",

  // VERMELHO SUAVE
  "rgba(255,120,120,.22)",
  "rgba(255,160,160,.18)"
]);

    el.style.background = bg;
    el.style.borderColor = bd;

    // sombra leve √†s vezes
    el.style.boxShadow = pick([
      "0 10px 26px rgba(0,0,0,.18)",
      "0 8px 20px rgba(0,0,0,.14)",
      "0 0 0 rgba(0,0,0,0)"
    ]);
  };

  // aplica agora e depois em intervalos vari√°veis
  applyOnce();
  _waitPresFxTimer = setInterval(applyOnce, pick([1200, 1500, 1800, 2200, 2600]));
}

function confirmPresenca(ans){
  setPresencaRespondida();

  if(typeof setPresencaAns === "function") setPresencaAns(ans);

  refreshPresenceUI();            // ‚úÖ ret√¢ngulo / texto atualiza na hora
  updateEnvelopeUI();
  updatePresenceConfirmedWait();  // ‚úÖ garante o aviso no wait

  showPresSuccess();
  setTimeout(()=>{
    hidePresSuccess();
    showScreen("scr_wait","back");
  }, 3000);
}


function bindPresBtn(id, ans){
  const btn = document.getElementById(id);
  if(!btn || btn.dataset.presBound) return;
  btn.dataset.presBound = "1";

  const handler = (e)=>{
    e?.preventDefault?.();
    confirmPresenca(ans);
  };

  btn.addEventListener("click", handler);
  btn.addEventListener("touchend", (e)=>{ e.preventDefault(); handler(e); }, {passive:false});
}

function initPresencaBlock(){
  bindPresBtn("btnRespSessaoAgape","sessao_agape");
  bindPresBtn("btnRespSessao","somente_sessao");
  bindPresBtn("btnRespAgape","somente_agape");

  try{
    const ans = (typeof getPresencaAns === "function") ? getPresencaAns() : "";
    highlightPresenceChoiceByVal(ans);
  }catch(_){}

  updatePresenceConfirmedWait();
}

initPresencaBlock();

const _oldOpenPresenca = (typeof openPresenca === "function") ? openPresenca : null;
if(_oldOpenPresenca){
  window.openPresenca = function(){
    _oldOpenPresenca();
    try{
      const ans = (typeof getPresencaAns === "function") ? getPresencaAns() : "";
      highlightPresenceChoiceByVal(ans);
      updatePresenceConfirmedWait();
    }catch(_){}
  };
}

boot();
</script>

























