<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#071a2b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./favicon.ico">
  <title>Sistema √Ågape</title>

  <style>
    :root{
      --bad: #ff3b30;
      --bg1:#071a2b;
      --bg2:#0c3a56;
      --glass: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.60);
      --good:#33d07a;
      --blue:#2d8cff;
      --yellow: rgba(255,215,0,.20);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg1); color:var(--text);}
    body{overflow:hidden}

/* ===== Pagamento v25 (top) ===== */
.payCard{
  margin-top:12px;
  padding:16px;
  border-radius:22px;
  background: rgba(0,0,0,.18);
  border:1px solid rgba(255,255,255,.12);
  box-shadow: 0 24px 55px rgba(0,0,0,.32);
}
.payMsg{line-height:1.2}
.payHello{font-weight:1000; font-size:28px; margin-bottom:6px}
.payTotal{font-weight:800; opacity:.95}
/* === Confer√™ncia: limita a lista e cria scroll interno === */
/* === Confer√™ncia: limita a lista e cria scroll interno (6 itens vis√≠veis) === */
#payItems{
  max-height: calc(4 * 36px);      /* 4 linhas */
  overflow-y: auto;               /* scroll √† direita */
  overflow-x: hidden;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
  padding-right: 4px;             /* respiro pro scrollbar */
}
 .background: rgba(255,255,255,.25); border:1px solid rgba(255,255,255,.10);}
.payItemRow{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 0;
  min-height:36px;               /* casa com o calc(6 * 36px) */
}
.payItemLeft{
  font-weight:900;

  flex: 1 1 auto;        /* ocupa s√≥ o espa√ßo dispon√≠vel */
  min-width: 0;          /* üî¥ ESSENCIAL para funcionar com flex */
  
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.payItemDots{flex:1; border-bottom: 2px dotted rgba(255,255,255,.25); height:0; opacity:.9}
.payItemRight{
  font-weight:1000;
  white-space:nowrap;
  flex: 0 0 auto;
}
.payQ{font-weight:1000; font-size:22px; margin:4px 0 12px}
.payIconRow{display:flex; gap:14px; justify-content:center; margin:10px 0 14px}
.payIconBtn{
  width:74px; height:54px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  color:var(--text);
  display:flex; align-items:center; justify-content:center;
  position:relative;
  box-shadow: 0 16px 35px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.06);
  transition: transform .16s ease, box-shadow .16s ease, filter .16s ease;
  cursor:pointer;
}
.payIconBtn:hover{transform: translateY(-1px) scale(1.03); filter:brightness(1.05)}
.payIconBtn:active{transform: translateY(0) scale(.98)}
.payIconBtn::after{
  content: attr(data-tip);
  position:absolute;
  left:50%; top:-10px;
  transform: translate(-50%,-100%);
  padding:6px 10px;
  border-radius:999px;
  background: rgba(0,0,0,.72);
  border:1px solid rgba(255,255,255,.12);
  color:#fff;
  font-weight:900;
  font-size:12px;
  opacity:0;
  pointer-events:none;
  transition: opacity .15s ease, transform .15s ease;
  white-space:nowrap;
}
.payIconBtn:hover::after{opacity:1; transform: translate(-50%,-115%)}
.payIconImg{width:62px; height:30px; object-fit:contain; display:block; filter:drop-shadow(0 2px 8px rgba(0,0,0,.25));}
.paySvg{font-size:26px; line-height:1}
.payBack{margin-top:8px}
.payHint{margin-top:10px; opacity:.70; font-size:12px}

/* Modal */
.modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:999;}
.modal.hidden{display:none;}
.modal::before{content:""; position:absolute; inset:0; background: rgba(0,0,0,.55); backdrop-filter: blur(4px);}
.modalCard{
  position:relative;
  width:min(420px, calc(100% - 36px));
  border-radius:20px;
  padding:16px;
  background: rgba(10,20,32,.92);
  border:1px solid rgba(255,255,255,.14);
  box-shadow: 0 30px 80px rgba(0,0,0,.55);
}
.modalTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
.modalTitle{font-weight:1000; font-size:20px}
.modalX{border:none; background: rgba(255,255,255,.06); color:var(--text); border-radius:12px; padding:8px 10px; font-weight:1000}
.modalText{margin-top:8px; opacity:.85; font-size:13px; line-height:1.35}
.pixValueRow{display:flex; align-items:center; justify-content:space-between; margin-top:14px;
  padding:12px; border-radius:16px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);}
.pixValueLbl{opacity:.80; font-weight:900}
.pixValue{font-weight:1000; font-size:18px}
.pixKeyRow{display:flex; align-items:center; gap:10px; margin-top:12px;
  padding:12px; border-radius:16px; background: rgba(10,200,160,.12); border:1px solid rgba(100,255,230,.25);}
.pixKeyText{flex:1; font-weight:1000; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
.pixCopyBtn{
  width:44px; height:44px; border-radius:14px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
  color:var(--text);
  font-size:20px;
  cursor:pointer;
}
.modalOk{margin-top:14px}
.modalCancel{
  width:100%;
  margin-top:10px;
  padding:12px;
  border-radius:16px;
  border:1px solid red;
  background: rgba(255,0,0,0.5);
  color:var(--text);
  font-weight:900;
}

/* Success overlay */
.paySuccess{
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  width:100vw; height:100vh;
  background: rgba(230,204,24,.96);
}
.paySuccess.hidden{display:none;}
.paySuccessBox{
  background: rgba(255,255,255,.75);
  border-radius:18px;
  padding:16px 18px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  box-shadow: 0 22px 70px rgba(0,0,0,.35);
}
.paySuccessGif{width:140px; height:140px; object-fit:contain; display:block}
.payOkText{font-weight:1000; color:#083018}

/* === v25 pay success overlay (yellow full, gif + text only) === */
.paySuccess{position:fixed; inset:0; background:rgba(230,204,24,.96); display:flex; align-items:center; justify-content:center; z-index:9999;}
.paySuccess.hidden{display:none;}
.paySuccessInner{display:flex; flex-direction:column; align-items:center; gap:14px; text-align:center;}
#payGif{width:160px; height:160px; object-fit:contain; filter:drop-shadow(0 12px 26px rgba(0,0,0,.25));}
.payOkText{font-weight:1000; font-size:22px; color:#053018; text-shadow:0 1px 0 rgba(255,255,255,.35);}


    
    .safe{
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    .screen{
      position:fixed; inset:0;
      display:none;
      background: radial-gradient(1200px 900px at 50% 0%, var(--bg2), var(--bg1));
    }
    .screen.active{display:flex}

    /* Slide transitions */
    .enter-left{transform:translateX(100%); opacity:1}
    .enter-right{transform:translateX(-100%); opacity:1}
    .exit-left{transform:translateX(-100%); opacity:1}
    .exit-right{transform:translateX(100%); opacity:1}
    .screen{transition: transform .46s ease, opacity .46s ease;}
    .screen.active{transform:translateX(0); opacity:1}
    .screen.exit-left,.screen.exit-right,.screen.enter-left,.screen.enter-right{display:flex}

    /* Splash 1 */
    #scr_splash1{
      background:#000 !important;
      align-items:center;
      justify-content:center;
    }

    /* Splash 2 */
    #scr_splash2{align-items:center; justify-content:center; background:#061a2b !important;}
    .splashCenter{display:flex; flex-direction:column; align-items:center; gap:18px; text-align:center; padding:24px;}
    .logoWrap{
      width:92px; height:92px; border-radius:22px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      transform: scale(.78);
      opacity:0;
      animation: logoZoom 3.0s ease forwards;
    }
    .logoWrap img{width:100%; height:100%; object-fit:cover; display:block}
    .brandText{
      font-weight:800; letter-spacing:.3px;
      font-size: 34px;
      transform: scale(.96);
      opacity:0;
      animation: textZoom 3.0s ease forwards;
      animation-delay: .05s;
    }
    @keyframes logoZoom{
      0%{transform:scale(.78); opacity:0}
      30%{opacity:1}
      100%{transform:scale(1.00); opacity:1}
    }
    @keyframes textZoom{
      0%{transform:scale(.96); opacity:0}
      35%{opacity:1}
      100%{transform:scale(1.00); opacity:1}
    }

    /* Card layout */
    .wrap{width:min(420px, 100%); margin:0 auto; padding:16px;}
    .topBrand{
      display:flex; gap:12px; align-items:center;
      padding:14px 16px;
      border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
    }
    .topBrand .bLogo{
      width:46px;height:46px;border-radius:12px; overflow:hidden;
      border:1px solid rgba(255,255,255,.15);
      flex:0 0 auto;
      background: rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center;
    }
    .topBrand .bLogo img{width:100%; height:100%; object-fit:cover; display:block}
    .topBrand .bTxt{line-height:1.15}
    .topBrand .bTxt .bTitle{font-weight:800; font-size:18px; line-height:1.1;}
    .topBrand .bTxt .bSub{font-size:12px; opacity:.85; margin-top:2px;}

    .sessionBar{
      margin-top:14px; display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:14px;
      background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10);
    }
    .dotBig{width:16px;height:16px;border-radius:50%; background:var(--bad); box-shadow:0 0 0 4px rgba(255,0,0,.10);}
    .sessionLine{font-weight:800; font-size:15px; letter-spacing:.2px; flex:1; min-width:0;}

    .card{
      margin-top:14px;
      padding:16px;
      border-radius:22px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 24px 55px rgba(0,0,0,.32);
    }

    .btn{
      width:100%;
      margin-top:14px;
      padding:11px 12px;
      border-radius:14px;
      border:none;
      background: linear-gradient(90deg, #1bb3ff, #3b6cff);
      color:#001018;
      font-weight:900;
      font-size:17px;
      line-height: 1.1 !important;
    }

    .btn2{
      width:100%;
      padding:11px 12px;
      border:none;
      border-radius:14px;
      background: linear-gradient(90deg, #19baff, #3a66ff);
      color:#001018;
      font-weight:1000;
      font-size:17px;
      line-height: 1.1 !important;
    }

    .miniBtn{
      border:1px solid red;
      background: rgba(255,0,0,0.5);
      color: var(--text);
      padding:10px 14px;
      border-radius:14px;
      font-weight:800;
    }


    /* Pix bar */
    .pixBar{
      margin-top:10px; display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px; border-radius:14px;
      background:rgba(10,200,160,.16); border:1px solid rgba(100,255,230,.25);
    }
    .pixBadge{width:64px; height:36px; border-radius:10px; background:rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:center;}
    .pixBadge img{width:70px;height:26px;object-fit:contain;display:block;filter:drop-shadow(0 2px 8px rgba(0,0,0,.25));}
    .pixKey{font-weight:900; font-size:16px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1; min-width:0;}

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.75);
      color:white; padding:10px 14px;
      border-radius:14px;
      opacity:0; pointer-events:none;
      transition: opacity .25s ease;
      font-weight:800;
      z-index:99999;
    }
    .toast.show{opacity:1}

    /* Wait envelope */
    .waitCard{ position:relative; }
    .msgBtn{
      position:relative;
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      flex:0 0 auto;
    }
    .msgIcon{width:24px; height:24px; object-fit:contain; opacity:.95; filter:drop-shadow(0 2px 6px rgba(0,0,0,.35));}
    .msgBadge{
      position:absolute;
      top:-6px; right:-6px;
      width:18px; height:18px;
      border-radius:999px;
      background:#ff3b30;
      border:2px solid rgba(6,26,43,1);
      color:#fff;
      font-weight:1000;
      font-size:12px;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .hidden{display:none !important;}
    @keyframes pulseBadge{
      0%{transform:scale(1); filter:brightness(1);}
      50%{transform:scale(1.12); filter:brightness(1.2);}
      100%{transform:scale(1); filter:brightness(1);}
    }
    .msgBadge.pulse{animation:pulseBadge 1.1s ease-in-out infinite;}

    /* ===== PRESEN√áA (bonitona) ===== */
    #scr_presenca{
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      padding:16px 0;
    }
    #scr_presenca .wrap{min-height:100%; height:auto !important; align-items:flex-start;}
    #scr_presenca .card{max-height: calc(100vh - 32px); overflow-y:auto; -webkit-overflow-scrolling:touch;}

    .hint{
      margin-top:12px; padding:12px 14px; border-radius:14px;
      background:linear-gradient(90deg, rgba(60,170,120,.35), rgba(80,210,160,.22));
      border:1px solid rgba(150,255,210,.25);
    }

    .presResumo{
      display:grid;
      grid-template-columns: 1fr 120px;
      gap:12px;
      border-radius:14px;
      border:2px solid rgba(255, 220, 40, .55);
      background: rgba(180, 150, 0, .25);
      padding:10px;
      margin: 12px 0;
    }
    .presResumoTitle{font-weight:900; margin-bottom:6px;}
    .presResumoLine{display:flex; justify-content:space-between; gap:10px; font-size:12px; padding:2px 0;}
    .barBox{
      width:86px;
      height:130px;
      border-radius:10px;
      overflow:hidden;
      border:2px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
    }
    .barTop{
      background: rgba(255,120,0,.85);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; font-size:13px;
      flex:1;
    }
    .barBottom{
      background: rgba(70,190,120,.85);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; font-size:13px;
      flex:1;
    }
    .barLegend{display:flex; gap:10px; margin-top:8px; font-size:11px; opacity:.95; justify-content:center;}
    .barLegend i{width:10px;height:10px;border-radius:3px;display:inline-block;}
    .lgNo i{background: rgba(255,120,0,.85);}
    .lgYes i{background: rgba(70,190,120,.85);}

    /* ===== CONSUMO (layout simples e est√°vel) ===== */
    #scr_consumo{align-items:stretch; justify-content:center;}
    .page{
      display:flex;
      flex-direction:column;
      height:100%;
      width:min(440px, 100%);
      margin:0 auto;
      padding:16px;
      gap:12px;
    }
    .cashBar{
      display:flex; align-items:center; gap:12px;
      padding:12px 14px; border-radius:14px;
      background: rgba(255,165,0,.22);
      border: 1px solid rgba(255,200,120,.22);
    }
    .cashText{font-weight:1000; font-size:14px;}
    #cashValue{font-weight:1000;}

    .prodScroll{
      flex:1;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding: 4px 0;
    }
    .prodRow{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 14px;
      border-radius:18px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      margin-bottom:12px;
    }
    .pIcon{
      width:50px;height:50px;border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
    }
    .pIcon img{background:#fff;width:100%; height:100%; object-fit:contain; display:block}
    .pMid{flex:1; min-width:0}
    .pName{font-weight:900}
    .pDesc{font-size:12px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .pPrice{margin-top:6px; font-weight:900}
    .qtyWrap{display:flex; align-items:center; gap:10px; flex:0 0 auto;}
    .qtyBtn{
      width:40px;height:40px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-size:22px;
      line-height:1;
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      cursor:pointer;
    }
    .qty{min-width:20px; text-align:center; font-weight:900}

    .consFooter{
      padding: 10px 0 0 0;
      background: linear-gradient(180deg, rgba(7,26,43,0) 0%, rgba(7,26,43,.65) 30%, rgba(7,26,43,.92) 100%);
      border-radius:18px;
    }
    .totalBox{
      padding:14px 14px;
      border-radius:18px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      margin-bottom:12px;
    }
    .totalBox .tLbl{font-size:12px; color:var(--muted)}
    .totalBox .tVal{font-size:28px; font-weight:1000; margin-top:6px}

    /* desktop center */
    @media (min-width:900px){
      body{display:flex; align-items:center; justify-content:center; background:#081b2c;}
      .screen{position:relative; width:420px; height:860px; border-radius:26px; overflow:hidden; box-shadow: 0 30px 80px rgba(0,0,0,.55);}
    }
    .payIconBtn:hover::after{opacity:1; transform: translate(-50%,-115%)}
    .payIconImg{width:62px; height:30px; object-fit:contain; display:block; filter:drop-shadow(0 2px 8px rgba(0,0,0,.25));}
    .paySvg{font-size:26px; line-height:1}
    .payBack{margin-top:8px}
    .payHint{margin-top:10px; opacity:.70; font-size:12px}

    /* FIX: n√£o quebrar linha dentro do #payItems (trunca descri√ß√£o e mant√©m pre√ßo na mesma linha) */
#payItems{
  max-height: calc(4 * 36px);
  overflow-y: auto;
  overflow-x: hidden;
  padding-right: 4px;
  color: #FFD700; /* Amarelo ouro forte */
  font-weight: bold;
}

#payItems .payItemRow{
  display: flex !important;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  min-height: 36px;
  flex-wrap: nowrap !important;     /* nunca quebra */
}

#payItems .payItemLeft{
  flex: 1 1 auto !important;
  min-width: 0 !important;          /* ESSENCIAL pro "..." funcionar no flex */
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
}

#payItems .payItemDots{
  flex: 1 1 auto !important;        /* pontilhado ocupa o meio */
  min-width: 16px;
}

#payItems .payItemRight{
  flex: 0 0 auto !important;
  white-space: nowrap !important;
}

    /* Pagamento */
    #scr_pagamento{align-items:flex-start; justify-content:center;}
    .payBtns{display:flex; flex-direction:column; gap:12px; margin-top:12px}
    /* .payBtn{
      padding:16px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      font-size:18px;
      text-align:center;
    }
    .payBtn.primary{background: rgba(51,208,122,.18); border-color: rgba(51,208,122,.35)}
    .payBtn.warn{background: rgba(255,215,0,.14); border-color: rgba(255,215,0,.25)}*/
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.75);
      color:white; padding:10px 14px;
      border-radius:14px;
      opacity:0; pointer-events:none;
      transition: opacity .25s ease;
      font-weight:800;
      z-index:99;
    }
    .toast.show{opacity:1}

    /* desktop center */
    @media (min-width:900px){
      body{display:flex; align-items:center; justify-content:center; background:#081b2c;}
      .screen{position:relative; width:420px; height:860px; border-radius:26px; overflow:hidden; box-shadow: 0 30px 80px rgba(0,0,0,.55);}
    }
  

/* v15 fixes */
.panel{flex:1;display:flex;flex-direction:column;min-height:0;}
.prodScroll{flex:1;min-height:0;-webkit-overflow-scrolling:touch;}

.pIconImg{width:28px;height:28px;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,.25));}
/* bot√£o selecionado = contorno azul brilhante */
.payBtn.isChosen{
  border: 2px solid rgba(45,140,255,.95) !important;
  box-shadow:
    0 0 0 3px rgba(45,140,255,.22),
    0 0 18px rgba(45,140,255,.45) !important;
  filter: brightness(1.06);
}
    .presCard{padding:14px; max-width:420px;}
    .presMsg{
      border: 2px solid rgba(70, 190, 120, .55);
      background: rgba(0,0,0,.18);
      margin: 12px 0;
    }
    .presMsg .infoText{
      font-size: 12px;
      line-height: 1.35;
      max-height: 170px;
      overflow: auto;
      padding-right: 6px;
    }
    .infoCard{margin-top:12px; padding:14px; border-radius:16px; background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.10);}
    .infoTitle{font-weight:900; font-size:18px;}
    .infoText{margin-top:6px; font-size:13px; opacity:.90; line-height:1.35;}

    .presBtnsRow{display:flex; gap:10px;}
    .payBtn{
      flex:1;
      min-height:44px;
      padding:10px 8px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      font-size:8px;
      text-align:center;
      cursor:pointer;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      line-height:1.1;
    }
    .payBtn.primary{background: rgba(51,208,122,.18); border-color: rgba(51,208,122,.35)}
    .payBtn.isChosen{outline:2px solid rgba(255,255,255,.35);}

/* ===== BOT√ÉO ESCOLHIDO: BORDA AMARELA BRILHANTE ===== */

.presBtnsRow .payBtn.isChosen{
  border: 2px solid rgba(255,215,0,.98) !important;
  box-shadow:
    0 0 0 3px rgba(255,215,0,.22),
    0 0 18px rgba(255,215,0,.45) !important;
  filter: brightness(1.06);
}

/* ===== STATUS (ret√¢ngulo preto j√° no seu #presStatusLine) ===== */
#presStatusLine{
  background: rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 12px;
  padding: 10px 12px;
  font-weight: 900;
}

/* ===== OVERLAY: PRESEN√áA CONFIRMADA (preto full) ===== */
.presSuccess{
  position:fixed;
  inset:0;
  width:100vw;
  height:100dvh;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999999;
}
.presSuccess.hidden{display:none;}
.presSuccessInner{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:14px;
  text-align:center;
  padding: 18px;
}
#presGif{
  width:220px;
  max-width:70vw;
  height:auto;
  object-fit:contain;
  filter: drop-shadow(0 14px 30px rgba(0,0,0,.55));
}
.presOkText{
  font-weight:1000;
  font-size:22px;
  color:#fff;
  text-shadow:0 2px 12px rgba(0,0,0,.6);
}

/* ===== WAIT: AVISO PRESEN√áA J√Å CONFIRMADA ===== */
.waitPresencaOk{
  margin-top:10px;
  padding:10px 12px;
  border-radius:12px;
  background: rgba(30,200,120,.20);
  border: 1px solid rgba(120,255,210,.25);
  font-weight:1000;
  text-align:center;
}
.waitPresencaOk.hidden{display:none;}
    
  </style>
</head>

<body>
  <div id="toast" class="toast"></div>

  <!-- Splash 1 -->
  <section id="scr_splash1" class="screen active safe">
    <div class="splashCenter">
      <img id="splashSymbol" class="splashSymbol" src="./assets/maconaria.png" alt="Carregando" style="width:160px;height:160px;object-fit:contain;">
      <div class="splashLoading" style="margin-top:6px;font-weight:900;font-size:18px;opacity:.95;">Carregando‚Ä¶..</div>
    </div>
  </section>

  <!-- Splash 2 -->
  <section id="scr_splash2" class="screen safe">
    <div class="splashCenter">
      <div class="logoWrap">
        <img id="splashLogo" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/>
      </div>
      <div class="brandText">Sistema √Ågape</div>
    </div>
  </section>

  <!-- Wait -->
  <section id="scr_wait" class="screen safe">
    <div class="wrap">
      <div class="card waitCard">
        <div class="topBrand">
          <div class="bLogo">
            <img id="brandLogoWait" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/>
          </div>
          <div class="bTxt">
            <div class="bTitle" id="lojaNomeWait">Loja</div>
            <div class="bSub" id="lojaSubWait">App √Ågape ‚Ä¢ Consumo & Pagamento</div>
          </div>
        </div>

        <div class="sessionBar">
          <div class="dotBig" id="sessaoDotWait"></div>
          <div class="sessionLine" id="sessaoLineWait">Sess√£o fechada ‚Äî ‚Äî</div>
          <button class="msgBtn" id="btnEnvelope" type="button" aria-label="Mensagem do Vener√°vel">
            <img src="./assets/icon-envelope.png" alt="" class="msgIcon">
            <span class="msgBadge hidden" id="msgBadge">!</span>
          </button>
        </div>

        <div class="pixBar" style="margin-top:12px;">
          <div class="pixBadge"><img src="./assets/logo-pix.jpg" alt="Pix"></div>
          <div class="pixKey" id="pixChaveWait">‚Äî</div>
        </div>

        <div class="infoCard">
          <div class="infoTitle">Sess√£o ainda n√£o liberada üîí</div>
          <div class="infoText">A sess√£o ainda n√£o foi aberta pelo respons√°vel, mas n√£o se preocupe. Quando liberar a sess√£o, automaticamente aparecer√° a tela de login.</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;">
            <div style="padding:12px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);">
              <div style="font-size:12px;opacity:.75;">√öltima verifica√ß√£o</div>
              <div style="margin-top:4px;font-weight:900;font-size:16px;" id="lastCheck">‚Äî</div>
            </div>
            <div style="padding:12px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);">
              <div style="font-size:12px;opacity:.75;">Sess√£o</div>
              <div style="margin-top:4px;font-weight:900;font-size:16px;" id="sessaoStatus">Fechada</div>
            </div>
          </div>
          <button class="miniBtn" id="btnSairWait" type="button" style="margin-top:12px;background:#e53935;border-color:#e53935;color:#fff;">
            Sair do aplicativo
          </button>
        </div>

<!-- =======================
     BLOCO PRESEN√áA (PRONTO)
     - borda amarela brilhante no bot√£o escolhido
     - overlay preto com presenca.gif por 3s
     - volta para scr_wait
     - aviso "PRESEN√áA J√Å CONFIRMADA" na WAIT
     ======================= -->

<!-- 1) COLE ISTO DENTRO DO #scr_wait (ex: logo abaixo do infoCard ou antes do hint) -->
<div id="waitPresencaOk" class="waitPresencaOk hidden">‚úÖ PRESEN√áA J√Å CONFIRMADA</div>

        <div class="hint">
          <div style="font-weight:900;font-size:14px;">Modo tesoureiro</div>
          <div style="font-size:13px;opacity:.95;margin-top:4px;">toque 5x no logo para abrir Admin (sess√£o, caixa, produtos, Pix).</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Presen√ßa -->
  <section id="scr_presenca" class="screen safe">
    <div class="wrap">
      <div class="card presCard">

        <div class="topBrand presTop">
          <div class="bLogo">
            <img id="brandLogoPres" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/>
          </div>
          <div class="bTxt">
            <div class="bTitle" id="lojaNomePres">Loja</div>
            <div class="bSub">Presen√ßa ‚Ä¢ Sess√£o & √Ågape</div>
          </div>
        </div>

        <div class="sessionBar presSessionBar">
          <div class="dotBig" id="sessaoDotPres"></div>
          <div class="sessionLine" id="sessaoLinePres">Sess√£o fechada</div>
        </div>

        <div class="infoCard presMsg">
          <div class="infoTitle">Chamado do Vener√°vel</div>
          <div class="infoText" id="presTexto">Carregando...</div>
        </div>

        <div class="presBtnsRow">
          <button class="payBtn primary" id="btnRespSessaoAgape" type="button">Sess√£o e √Ågape</button>
          <button class="payBtn" id="btnRespSessao" type="button">Somente sess√£o</button>
          <button class="payBtn" id="btnRespAgape" type="button">Somente √°gape</button>
        </div>

        <div class="hint" id="presStatusLine">Voc√™ ainda n√£o respondeu.</div>

        <div class="presResumo">
          <div class="presResumoLeft">
            <div class="presResumoTitle">Resumo:</div>
            <div class="presResumoLine"><span>Sess√£o e √Ågape:</span><b id="rSA">0</b></div>
            <div class="presResumoLine"><span>Somente sess√£o:</span><b id="rS">0</b></div>
            <div class="presResumoLine"><span>Somente √°gape:</span><b id="rA">0</b></div>
            <div class="presResumoLine"><span>Total respondidos:</span><b id="rT">0</b></div>
            <div class="presResumoLine"><span>Total n√£o respondidos:</span><b id="rN">0</b></div>
          </div>

          <div class="presResumoRight" style="display:flex;flex-direction:column;align-items:center;justify-content:center;">
            <div class="barBox">
              <div class="barTop" id="barNao">0</div>
              <div class="barBottom" id="barSim">0</div>
            </div>
            <div class="barLegend">
              <span class="lgNo" style="display:inline-flex;gap:6px;align-items:center;"><i></i>N√£o</span>
              <span class="lgYes" style="display:inline-flex;gap:6px;align-items:center;"><i></i>Sim</span>
            </div>
          </div>
        </div>

        <button class="btn2" id="btnFecharPresenca" type="button">Fechar</button>
      </div>
    </div>
  </section>

  <!-- Login -->
  <section id="scr_login" class="screen safe">
    <div class="wrap">
      <div class="topBrand" id="brandBar">
        <div class="bLogo"><img id="brandLogo" alt="logo"/></div>
        <div class="bTxt">
          <div class="bTitle" id="lojaNome">Loja</div>
          <div class="bSub" id="lojaSub"></div>
        </div>
      </div>

      <div class="sessionBar" id="sessionBarLogin">
        <span class="dotBig" id="sessaoDotLogin" style="width:16px;height:16px;border-radius:50%;"></span>
        <div class="sessionLine" id="sessaoLineLogin">Sess√£o ‚Äî</div>
      </div>

      <div class="pixBar">
        <div class="pixBadge"><img src="./assets/logo-pix.jpg" alt="Pix"></div>
        <div class="pixKey" id="pixChave">‚Äî</div>
      </div>

      <div class="card" id="loginCard">
        <h2 id="welcomeTitle" style="margin:0 0 6px 0; font-size:34px; letter-spacing:.2px">Bem-vindo üëã</h2>
        <p style="margin:0 0 14px 0; color:var(--muted)">Digite seu <strong>CIM</strong> para entrar. Bot√µes grandes e tudo bem simples.</p>

        <div id="telWrap">
          <label style="display:block; font-weight:700; margin:10px 0 6px 0; font-size:15px">Telefone</label>
          <input id="inpTel" inputmode="tel" placeholder="Ex: 48999990000" style="width:100%;padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);color:var(--text);outline:none;font-size:16px;" />
        </div>

        <label style="display:block; font-weight:700; margin:10px 0 6px 0; font-size:15px">CIM (senha)</label>
        <input id="inpCIM" inputmode="numeric" placeholder="Digite seu CIM" style="width:100%;padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);color:var(--text);outline:none;font-size:16px;" />

        <button class="btn" id="btnEntrar">Entrar</button>
        <button class="miniBtn" id="btnSairLogin" style="width:100%;margin-top:10px;">Sair do aplicativo</button>

        <div style="margin-top:10px; color: rgba(255,255,255,.65)">Admin: toque 5x no logo.</div>
      </div>
    </div>
  </section>

  <!-- Consumo -->
  <section id="scr_consumo" class="screen safe">
    <div class="page">
      <div class="topBrand">
        <div class="bLogo"><img id="brandLogoCons" src="./assets/logo-Clementino-Brito.jpeg" alt="logo"/></div>
        <div class="bTxt">
          <div class="bTitle" id="consLoja">Loja</div>
          <div class="bSub" id="consSub"></div>
        </div>
      </div>

      <div class="sessionBar">
        <span class="dotBig" id="sessaoDotCons"></span>
        <div class="sessionLine" id="sessaoLineCons">Sess√£o ‚Äî</div>
      </div>

      <div class="cashBar" id="cashBar">
        <div class="cashText">Valor em caixa: <span id="cashValue">R$ 0,00</span></div>
      </div>

      <div class="pixBar">
        <div class="pixKey" >Meu Consumo</div>
        <button class="miniBtn" id="btnSair">Sair</button>
      </div>

      <div class="prodScroll" id="prodScroll">
        <div id="prodList"></div>
      </div>

      <div class="consFooter">
        <div class="totalBox">
          <div class="tLbl">Total</div>
          <div class="tVal" id="totalValue">R$ 0,00</div>
        </div>
        <button class="btn2" id="btnFechar">Fechar e pagar</button>
      </div>
    </div>
  </section>

   <!-- Pagamento -->
  <section id="scr_pagamento" class="screen safe">
    <div class="wrap">
      <div class="topBrand" id="payBrandBar">
        <div class="bLogo"><img id="payLogo" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/></div>
        <div class="bTxt">
          <div class="bTitle" id="payLoja">Loja</div>
          <div class="bSub">App √Ågape ‚Ä¢ Consumo & Pagamento</div>
        </div>
      </div>

      <div class="sessionBar">
        <span class="dotbig" id="paySessaoDot" style="width:12px;height:12px;border-radius:99px;"></span>
        <div class="sessionLine" id="paySessaoLine">Sess√£o ‚Äî</div>
      </div>

      <div class="payCard">
        <div class="payMsg">
          <div class="payHello" id="payHello">Oi meu irm√£o,</div>
          <div class="payTotal">Sua conta totalizou <span id="payTotal">R$ 0,00</span>:</div><br>
        </div>

        <div id="payItems" class="payItems"></div>
              
        <div class="payQ"><br>Como deseja pagar?</div><br>

        <div class="payIconRow" aria-label="Formas de pagamento">
          <button class="payIconBtn" id="btnPix" type="button" data-tip="Pix">
            <img src="./assets/logo-pix.jpg" alt="Pix" class="payIconImg"/>
          </button>

          <button class="payIconBtn" id="btnDinheiro" type="button" data-tip="Dinheiro">
            <span class="paySvg" aria-hidden="true">üíµ</span>
          </button>

          <button class="payIconBtn" id="btnProxima" type="button" data-tip="Pr√≥xima sess√£o">
            <span class="paySvg" aria-hidden="true">üìÖ</span>
          </button>
        </div>

        <button class="btn2 payBack" id="btnVoltarConsumo" type="button">Voltar para comanda</button>
        <div class="payHint">Ao pagar, registramos e voltamos para o login.</div>
      </div>
    </div>


    <!-- Modal Pix -->
    <div id="pixModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="pixTitle">
      <div class="modalCard">
        <div class="modalTop">
          <div class="modalTitle" id="pixTitle">Pix</div>
          <button class="modalX" id="btnPixCancel" type="button" aria-label="Fechar">‚úï</button>
        </div>

        <div class="modalText">Copie a chave e fa√ßa a transfer√™ncia do valor exato.</div>

        <div class="pixValueRow">
          <div class="pixValueLbl">Valor</div>
          <div class="pixValue" id="pixValor">R$ 0,00</div>
        </div>

        <div class="pixKeyRow">
          <div class="pixKeyText" id="pixChaveModal">‚Äî</div>
          <button class="pixCopyBtn" id="btnCopyPix" type="button" title="Copiar">üìã</button>
        </div>

        <button class="btn2 modalOk" id="btnPixOk" type="button">OK, transferi</button>
        <button class="modalCancel" id="btnPixCancel2" type="button">Cancelar</button>
      </div>
    </div>

    <!-- Sucesso -->
    <div id="paySuccess" class="hidden" style="position:fixed;inset:0;background:rgba(230,204,24,.96);display:flex;align-items:center;justify-content:center;z-index:9999;">
      <div style="display:flex;flex-direction:column;align-items:center;gap:14px;text-align:center;">
        <img id="payGif" src="./assets/check.gif" alt="Pago" style="width:160px;height:160px;object-fit:contain;filter:drop-shadow(0 12px 26px rgba(0,0,0,.25));">
        <div style="font-weight:1000;font-size:22px;color:#053018;text-shadow:0 1px 0 rgba(255,255,255,.35);">Pagamento registrado</div>
      </div>
    </div>
  </section>

<div id="presSuccess" class="presSuccess hidden" aria-hidden="true">
  <div class="presSuccessInner">
    <img id="presGif" src="./assets/presenca.gif" alt="Confirmado">
    <div class="presOkText">PRESEN√áA CONFIRMADA!!!!!!!!!</div>
  </div>
</div>  
  
<script>
/* ==========================
   CONFIG / HELPERS
========================== */
const CONFIG_URL = "./agape_config.json?v=24";
const LS_CART  = "agape_cart_v14";
const LS_USER  = "agape_user_v14";
const LS_CASH = "agape_cash_v1";
const LS_CASH_DATE = "agape_cash_date_v1";
const GIF_TIME   = 6000;
const ZOOM_TIME  = 6000;

const $ = (s)=>document.querySelector(s);

function setText(sel, val){
  if(!sel) return;
  const isCSS =
    sel.startsWith("#") || sel.startsWith(".") ||
    sel.includes(" ") || sel.includes(",") ||
    sel.includes("[") || sel.includes(">") || sel.includes(":");
  const q = isCSS ? sel : ("#" + sel);
  const el = document.querySelector(q);
  if(el) el.textContent = (val ?? "");
}

const fmtBRL = (v)=>Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

let CFG=null;
let lastTotal = 0;
let currentScreen="scr_splash1";
let waitTimer=null;
let waitOpenTimer=null;
let waitPollingStarted=false;
let payReady = true;
let adminTapCount=0;
let adminTapTimer=null;

function toast(msg){
  const t=$("#toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1700);
}

function showScreen(id, dir="forward"){
  const from=document.getElementById(currentScreen);
  const to=document.getElementById(id);
  if(!from||!to||id===currentScreen) return;

  to.classList.remove("exit-left","exit-right","enter-left","enter-right");
  from.classList.remove("exit-left","exit-right","enter-left","enter-right");

  if(dir==="forward") to.classList.add("enter-left"); else to.classList.add("enter-right");
  to.classList.add("active");

  if (id === "scr_splash2") {
    const lw = to.querySelector(".logoWrap");
    const bt = to.querySelector(".brandText");
    [lw, bt].forEach(el => {
      if (!el) return;
      el.style.animation = "none";
      void el.offsetHeight;
      el.style.animation = "";
    });
  }

  void to.offsetWidth;
  to.classList.remove("enter-left","enter-right");

  if(dir==="forward") from.classList.add("exit-left"); else from.classList.add("exit-right");

  setTimeout(()=>{
    from.classList.remove("active","exit-left","exit-right");
    currentScreen=id;
  }, 460);
}

async function loadConfig(){
  const r=await fetch(CONFIG_URL,{cache:"no-store"});
  if(!r.ok) throw new Error("config");
  return await r.json();
}

function sessionIsOpen(){
  return (CFG?.sessao?.status||"").toLowerCase()==="aberta";
}

/* ==========================
   STORAGE: CART / USER / CASH
========================== */
function getCart(){ try{return JSON.parse(localStorage.getItem(LS_CART)||"{}")}catch(_){return {}} }
function setCart(c){ localStorage.setItem(LS_CART, JSON.stringify(c)); }
function clearCart(){ localStorage.removeItem(LS_CART); }

function getUser(){ try { return JSON.parse(localStorage.getItem(LS_USER) || "null"); } catch(e){ return null; } }
function setUser(u){ localStorage.setItem(LS_USER, JSON.stringify(u)); }
function clearUser(){ localStorage.removeItem(LS_USER); }

function getCashFromCFG(){
  const n = Number(CFG?.sessao?.caixa_inicial);
  return Number.isFinite(n) ? n : 0;
}
function getCash(){
  const n = Number(localStorage.getItem(LS_CASH));
  return Number.isFinite(n) ? n : getCashFromCFG();
}
function setCash(n){
  localStorage.setItem(LS_CASH, String(Number(n) || 0));
}
function initCashFromConfig(){
  const sessionDate = String(CFG?.sessao?.data || "").trim();
  const savedDate   = localStorage.getItem(LS_CASH_DATE);
  const hasCash     = localStorage.getItem(LS_CASH) !== null;

  if(!hasCash || (sessionDate && savedDate !== sessionDate)){
    setCash(getCashFromCFG());
    localStorage.setItem(LS_CASH_DATE, sessionDate);
  }
}
function renderCash(){
  const el = document.getElementById("cashValue");
  if(el) el.textContent = fmtBRL(getCash());
}

/* ==========================
   ===== PRESEN√áA (√öNICA) =====
========================== */
const LS_PRESENCA_ANS  = "agape_presenca_ans_v1";
const LS_PRESENCA_READ = "agape_presenca_read_v1";

function sessaoKey(){
  return String(CFG?.sessao?.data || "").trim();
}
function getPresencaMap(){
  try{ return JSON.parse(localStorage.getItem(LS_PRESENCA_ANS) || "{}"); }
  catch(_){ return {}; }
}
function getPresencaAns(){
  const key = sessaoKey();
  if(!key) return "";
  return String(getPresencaMap()[key] || "");
}
function setPresencaAns(ans){
  const key = sessaoKey();
  if(!key) return;
  const map = getPresencaMap();
  map[key] = ans;
  localStorage.setItem(LS_PRESENCA_ANS, JSON.stringify(map));
}
function setReadPresenca(){
  const key = sessaoKey();
  if(!key) return;
  localStorage.setItem(LS_PRESENCA_READ, key);
}
function isReadPresenca(){
  const key = sessaoKey();
  return !!key && localStorage.getItem(LS_PRESENCA_READ) === key;
}

function refreshPresenceUI(){
  const totalIrmaos = Array.isArray(CFG?.irmaos) ? CFG.irmaos.length : 0;
  const ans = getPresencaAns();

  const nSA = ans === "sessao_agape"   ? 1 : 0;
  const nSS = ans === "somente_sessao" ? 1 : 0;
  const nAG = ans === "somente_agape"  ? 1 : 0;

  const totalResp = ans ? 1 : 0;
  const totalNao  = Math.max(0, totalIrmaos - totalResp);

  const setNum = (id, v)=>{ const el=document.getElementById(id); if(el) el.textContent = String(v); };

  setNum("rSA", nSA);
  setNum("rS",  nSS);
  setNum("rA",  nAG);
  setNum("rT",  totalResp);
  setNum("rN",  totalNao);

  setNum("barNao", totalNao);
  setNum("barSim", totalResp);

  const line = document.getElementById("presStatusLine");
  if(line){
    const label =
      ans === "sessao_agape" ? "Sess√£o e √Ågape" :
      ans === "somente_sessao" ? "Somente sess√£o" :
      ans === "somente_agape" ? "Somente √°gape" : "";
    line.textContent = ans ? `Voc√™ respondeu: ${label}.` : "Voc√™ ainda n√£o respondeu.";
  }

  ["btnRespSessaoAgape","btnRespSessao","btnRespAgape"].forEach(id=>{
    const b = document.getElementById(id);
    if(b) b.classList.remove("isChosen");
  });
  const chosenId =
    ans === "sessao_agape" ? "btnRespSessaoAgape" :
    ans === "somente_sessao" ? "btnRespSessao" :
    ans === "somente_agape" ? "btnRespAgape" : "";
  if(chosenId){
    const b = document.getElementById(chosenId);
    if(b) b.classList.add("isChosen");
  }
}

function updateEnvelopeUI(){
  const badge = document.getElementById("msgBadge");
  if(!badge) return;

  const ans  = getPresencaAns();
  const read = isReadPresenca();

  const show = (!read) || (!ans);
  badge.classList.toggle("hidden", !show);

  badge.classList.toggle("pulse", !read);
  badge.textContent = !ans ? "!" : "‚Ä¢";
}

function choosePresenca(val){
  setPresencaAns(val);
  setReadPresenca();
  refreshPresenceUI();
  updateEnvelopeUI();
}

function openPresenca(){
const _oldOpenPresenca = (typeof openPresenca === "function") ? openPresenca : null;
if(_oldOpenPresenca){
  window.openPresenca = function(){
    _oldOpenPresenca();
    try{
      const ans = (typeof getPresencaAns === "function") ? getPresencaAns() : "";
      highlightPresenceChoiceByVal(ans);
      updatePresenceConfirmedWait();
    }catch(_){}
  };
}
  // ===== Pagamento v25 flow =====
  // ===== Pagamento v25 flow =====
  const PAY_SUCCESS_MS = 2200; // tempo para o GIF completar um ciclo (ajuste se quiser)

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function cartEntries(cart){
    if(!cart) return [];
    // objeto {id: qtd}
    if(!Array.isArray(cart) && typeof cart==="object"){
      return Object.entries(cart).map(([id,q])=>({id:String(id), qtd:Number(q||0)}));
    }
    // array [{id,qtd}] (fallback)
    if(Array.isArray(cart)){
      return cart.map(it=>({id:String(it.id), qtd:Number(it.qtd||it.qtd||0)}));
    }
    return [];
  }

// ===== PIX COPIA E COLA (EMV / BR Code) =====
function emv(id, value){
  const v = String(value);
  const len = String(v.length).padStart(2,"0");
  return `${id}${len}${v}`;
}

function crc16(payload){
  let crc = 0xFFFF;
  for(let i=0;i<payload.length;i++){
    crc ^= (payload.charCodeAt(i) << 8);
    for(let j=0;j<8;j++){
      crc = (crc & 0x8000) ? (((crc << 1) ^ 0x1021) & 0xFFFF) : ((crc << 1) & 0xFFFF);
    }
  }
  return crc.toString(16).toUpperCase().padStart(4,"0");
}

/**
 * Gera o PIX Copia e Cola (payload do QRCode) a partir da chave Pix + valor.
 * key: email/cpf/cnpj/telefone/chave aleat√≥ria (CFG.loja.pix_chave)
 */
function buildPixPayload({ key, amount, merchantName, merchantCity, txid }){
  const k = String(key||"").trim();
  const a = Number(amount||0).toFixed(2);

  // defaults seguros (ajuste se quiser)
  const mName = String(merchantName || "AGAPE").slice(0,25);
  const mCity = String(merchantCity || "BRASIL").slice(0,15);
  const tId   = String(txid || "AGAPE").slice(0,25);

  // Merchant Account Information (26)
  const gui = emv("00","BR.GOV.BCB.PIX");
  const chave = emv("01", k);
  const mai = emv("26", gui + chave);

  // Payload sem CRC
  const payloadNoCrc =
    emv("00","01") +          // Payload Format Indicator
    emv("01","12") +          // Point of Initiation Method (din√¢mico)
    mai +
    emv("52","0000") +        // Merchant Category Code
    emv("53","986") +         // BRL
    emv("54", a) +            // Amount
    emv("58","BR") +
    emv("59", mName) +
    emv("60", mCity) +
    emv("62", emv("05", tId)) +
    "6304";                   // CRC placeholder

  return payloadNoCrc + crc16(payloadNoCrc);
}

function closePresenca(){
  updateEnvelopeUI();
  showScreen("scr_wait","back");
}

function bindPresencaUI(){
  const b1 = document.getElementById("btnRespSessaoAgape");
  const b2 = document.getElementById("btnRespSessao");
  const b3 = document.getElementById("btnRespAgape");

  const bind = (btn, val)=>{
    if(!btn || btn.dataset.bound) return;
    btn.dataset.bound = "1";

    const handler = (e)=>{
      e?.preventDefault?.();
      choosePresenca(val);
    };

    btn.addEventListener("click", handler);
    btn.addEventListener("touchend", (e)=>{ e.preventDefault(); handler(e); }, {passive:false});
  };

  bind(b1, "sessao_agape");
  bind(b2, "somente_sessao");
  bind(b3, "somente_agape");

  const env = document.getElementById("btnEnvelope");
  if(env && !env.dataset.bound){
    env.dataset.bound="1";
    env.addEventListener("click", openPresenca);
    env.addEventListener("touchend", (e)=>{ e.preventDefault(); openPresenca(); }, {passive:false});
  }

  const fechar = document.getElementById("btnFecharPresenca");
  if(fechar && !fechar.dataset.bound){
    fechar.dataset.bound="1";
    fechar.addEventListener("click", closePresenca);
    fechar.addEventListener("touchend", (e)=>{ e.preventDefault(); closePresenca(); }, {passive:false});
  }
}

/* ==========================
   BRAND / UI
========================== */
function applyBrand(){
  const setTextId = (id, val) => { const el=document.getElementById(id); if(el) el.textContent = val; };
  const setSrc  = (id, src) => { const el=document.getElementById(id); if(el && src) el.src = src; };

  const logoUrl = (CFG?.ui?.logo_url) ? CFG.ui.logo_url : "./assets/logo-Clementino-Brito.jpeg";

  ["brandLogo","brandLogoWait","brandLogoCons","brandLogoPres","payLogo"].forEach(id=>setSrc(id, logoUrl));

  setTextId("lojaNome", CFG?.loja?.nome || "Loja");
  setTextId("lojaSub",  CFG?.loja?.subtitulo || "");
  setTextId("lojaNomeWait", CFG?.loja?.nome || "Loja");
  setTextId("lojaSubWait",  CFG?.loja?.subtitulo || "");
  setTextId("consLoja", CFG?.loja?.nome || "Loja");
  setTextId("consSub",  CFG?.loja?.subtitulo || "");
  setTextId("lojaNomePres", CFG?.loja?.nome || "Loja");
  setTextId("payLoja", CFG?.loja?.nome || "Loja");

  const pix = (CFG?.loja?.pix_chave || "").trim();
  setTextId("pixChave", pix || "‚Äî");
  setTextId("pixChaveWait", pix || "‚Äî");

  const opened = (CFG?.sessao?.status || "").toLowerCase() === "aberta";

  const now = new Date();
  const hh = String(now.getHours()).padStart(2,"0");
  const mm = String(now.getMinutes()).padStart(2,"0");
  const ss = String(now.getSeconds()).padStart(2,"0");
  const nowStr = `${hh}:${mm}:${ss}`;
  const d = (CFG?.sessao?.data || "").trim();
  const sessaoStr = d ? `${d} ‚Äî ${nowStr}` : `‚Äî ‚Äî ${nowStr}`;

  const dotColor = opened ? "var(--good)" : "var(--bad)";
  ["sessaoDotLogin","sessaoDotCons","paySessaoDot","sessaoDotWait","sessaoDotPres"].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.background = dotColor;
  });

  const sessaoLabel = opened ? "Sess√£o aberta" : "Sess√£o fechada";
  const sessaoLine = `${sessaoLabel} ‚Äî ${sessaoStr}`;
  setTextId("sessaoLineLogin", sessaoLine);
  setTextId("sessaoLineCons", sessaoLine);
  setTextId("paySessaoLine", sessaoLine);
  setTextId("sessaoLineWait", sessaoLine);
  setTextId("sessaoLinePres", sessaoLine);
  setTextId("sessaoStatus", opened ? "Aberta" : "Fechada");
  setTextId("lastCheck", now.toLocaleString("pt-BR"));

  updateEnvelopeUI();
}

/* ==========================
   PRODUCTS / TOTAL
========================== */
function animateTotal(to){
  const el1 = $("#totalValue");
  const el2 = $("#payTotal");
  const el3 = $("#pixValor");
  if(!el1 || !el2 || !el3 ) { lastTotal = to; return; }

  const from = Math.round(lastTotal);
  const target = Math.round(to);

  if(from === target){
    el1.textContent = fmtBRL(to);
    el2.textContent = fmtBRL(to);
    el3.textContent = fmtBRL(to);
    lastTotal = to;
    return;
  }
  const dir = target > from ? 1 : -1;
  let cur = from;
  const stepMs = 18;
  const timer = setInterval(()=>{
    cur += dir;
    el1.textContent = fmtBRL(cur);
    el2.textContent = fmtBRL(cur);
    el3.textContent = fmtBRL(cur);

    if(cur === target){
      clearInterval(timer);
      el1.textContent = fmtBRL(to);
      el2.textContent = fmtBRL(to);
      el3.textContent = fmtBRL(to);
      lastTotal = to;
    }
  }, stepMs);
}

function renderProducts(){
  const list=$("#prodList");
  list.innerHTML="";
  const produtos=Array.isArray(CFG?.produtos)?CFG.produtos:[];
  const cart=getCart();

  if(produtos.length===0){
    list.innerHTML='<div style="color:rgba(255,255,255,.65)">Sem produtos no JSON.</div>';
    return;
  }

  for(const p of produtos){
    const q=Number(cart[p.id]||0);
    const row=document.createElement("div");
    row.className="prodRow";
    row.innerHTML=`
      <div class="pIcon"><img src="${p.icon || './assets/icon-192.png'}" alt=""></div>
      <div class="pMid">
        <div class="pName">${p.nome||"Produto"}</div>
        <div class="pDesc">${p.desc||""}</div>
        <div class="pPrice">${fmtBRL(Number(p.preco||0))}</div>
      </div>
      <div class="qtyWrap">
        <button class="qtyBtn" data-act="dec" data-id="${p.id}">‚àí</button>
        <div class="qty" id="qty_${p.id}">${q}</div>
        <button class="qtyBtn" data-act="inc" data-id="${p.id}">+</button>
      </div>
    `;
    list.appendChild(row);
  }
  updateTotal();
}

function updateTotal(){
  const cart=getCart();
  const produtos=Array.isArray(CFG?.produtos)?CFG.produtos:[];
  let total=0;
  for(const p of produtos){
    total += Number(cart[p.id]||0)*Number(p.preco||0);
  }
  animateTotal(total);
  return total;
}

function findIrmao(tel,cim){
  tel=String(tel||"").replace(/\D/g,"");
  cim=String(cim||"").trim();
  return (Array.isArray(CFG?.irmaos)?CFG.irmaos:[]).find(i =>
    String(i.telefone||"").replace(/\D/g,"")===tel &&
    String(i.cim||"").trim()===cim
  );
}

function applyRememberedUser(){
  const u = getUser();
  const telWrap = document.getElementById("telWrap");
  const telInp  = document.getElementById("inpTel");
  const welcome = document.getElementById("welcomeTitle");
  const hasPhone = !!(u && u.telefone && String(u.telefone).trim());

  if (hasPhone){
    if (telWrap) telWrap.style.display = "none";
    if (telInp) {
      telInp.value = String(u.telefone);
      telInp.disabled = true;
    }
    if (welcome && u.nome) welcome.textContent = `Bem-vindo, ${u.nome} üëã`;
  } else {
    if (telWrap) telWrap.style.display = "";
    if (telInp) {
      telInp.disabled = false;
    }
    if (welcome) welcome.textContent = "Bem-vindo üëã";
  }
}

function setupAdminTap(){
  const logos = [$("#brandLogo"), $("#brandLogoWait")].filter(Boolean);
  for(const el of logos){
    el.addEventListener("click", ()=>{
      adminTapCount++;
      clearTimeout(adminTapTimer);
      adminTapTimer=setTimeout(()=>adminTapCount=0, 1200);
      if(adminTapCount>=5){
        adminTapCount=0;
        toast("Admin (em breve) ‚úÖ");
      }
    });
  }
}

/* ==========================
   WAIT POLLING
========================== */
function nowDT(){ return new Date().toLocaleString("pt-BR"); }

function stopWaitPolling(){
  if(waitTimer){ clearInterval(waitTimer); waitTimer=null; }
  if(waitOpenTimer){ clearInterval(waitOpenTimer); waitOpenTimer=null; }
  waitPollingStarted=false;
}

function startWaitPolling(){
  if(waitPollingStarted) return;
  waitPollingStarted=true;
  stopWaitPolling();

  const tick = async ()=>{
    try{
      setText('lastCheck', nowDT());
      CFG = await loadConfig();
      initCashFromConfig();
      applyBrand();
      renderCash();

      if(sessionIsOpen()){
        stopWaitPolling();
        showScreen("scr_login","forward");
      }
    }catch(_){}
  };

  tick();
  waitTimer = setInterval(tick, 3000);

  waitOpenTimer = setInterval(async ()=>{
    if(currentScreen !== 'scr_wait') return;
    try{
      CFG = await loadConfig();
      applyBrand();
      if(sessionIsOpen()){
        stopWaitPolling();
        showScreen('scr_login','forward');
      }
    }catch(_){}
  }, 15000);
}  

/* ==========================
   PAY FLOW (simplificado)
========================== */
  function buildPayScreen(){
  payReady = false;
  setTimeout(()=>{ payReady = true; }, 350);

    applyBrand();

    const u = getUser() || {};
    const nome = (u.nome||"").trim();
    setText("payHello", nome ? `Oi meu irm√£o, ${nome}!` : "Oi meu irm√£o!");

    const total = updateTotal();
    setText("payTotal", fmtBRL(total));
    setText("pixValor", fmtBRL(total));
    
    // lista itens para confer√™ncia
    const cart = getCart();
    const entries = cartEntries(cart).filter(x=>x.qtd>0);

    const prods = (CFG && Array.isArray(CFG.produtos)) ? CFG.produtos : [];
    const byId = Object.fromEntries(prods.map(p=>[String(p.id), p]));

    const lines = entries.map(e=>{
      const p = byId[e.id] || {};
      const nomeP = p.nome || `Item ${e.id}`;
      const preco = Number(p.preco||0);
      const sub = e.qtd * preco;
      return {q:e.qtd, nome:nomeP, sub};
    });

    const box = document.getElementById("payItems");
    if(box){
      if(lines.length===0){
        box.innerHTML = `<div style="opacity:.75;font-weight:900">Nenhum item selecionado.</div>`;
      }else{
        box.innerHTML = lines.map(l=>{
          const left = `${l.q} ${l.nome}`;
          const right = fmtBRL(l.sub);
          return `<div class="payItemRow"><div class="payItemLeft">${escapeHtml(left)}</div><div class="payItemDots"></div><div class="payItemRight">${escapeHtml(right)}</div></div>`;
        }).join("");
      }
    }
  }
function openPixModal(){
  const total = updateTotal();

  const key = (CFG && CFG.loja && CFG.loja.pix_chave) ? String(CFG.loja.pix_chave).trim() : "";
  if(!key){ toast("Chave Pix n√£o configurada"); return; }

  // valor no modal
  const elValor = document.getElementById("pixValor");
  if(elValor) elValor.textContent = fmtBRL(total);

  // gera o PIX Copia e Cola (payload)
  const payload = buildPixPayload({
    key,
    amount: total,
    merchantName: (CFG && CFG.loja && CFG.loja.nome) ? CFG.loja.nome : "AGAPE",
    merchantCity: (CFG && CFG.loja && CFG.loja.cidade) ? CFG.loja.cidade : "BRASIL",
    txid: "AGAPE"
  });

  // joga no campo do c√≥digo (tenta os ids poss√≠veis)
  const elCode =
    document.getElementById("pixChaveModal") ||
    document.getElementById("pixChave") ||
    document.getElementById("pixKeyText") ||
    null;

  if(elCode) elCode.textContent = payload;

  const modal = document.getElementById("pixModal");
  if(modal) modal.classList.remove("hidden");
}

function closePixModal(){
  const modal = document.getElementById("pixModal");
  if(modal) modal.classList.add("hidden");
}

async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); toast("Copiado ‚úÖ"); }
  catch(_){
    const ta=document.createElement("textarea");
    ta.value=txt; ta.style.position="fixed"; ta.style.left="-9999px";
    document.body.appendChild(ta); ta.focus(); ta.select();
    try{ document.execCommand("copy"); toast("Copiado ‚úÖ"); } catch(__){ toast("N√£o foi poss√≠vel copiar"); }
    document.body.removeChild(ta);
  }
}

function showPaySuccess(){
  const ps = document.getElementById("paySuccess");
  if(ps) ps.classList.remove("hidden");
  const gif = document.getElementById("payGif");
  if(gif){
    const src = gif.getAttribute("src") || "./assets/check.gif";
    gif.setAttribute("src", src.split("?")[0] + "?t=" + Date.now());
  }
    // som (se existir)
try{
      const a = new Audio("./assets/coin.mp3");
      a.play().catch(()=>{});
}catch(e){}
}


function hidePaySuccess(){
  const ps = document.getElementById("paySuccess");
  if(ps) ps.classList.add("hidden");
}

function finalizePayment(tipo, msg){
  const total = updateTotal();
  if(tipo === "dinheiro" || tipo === "pix"){
    setCash(getCash() + Number(total || 0));
    renderCash();
  }

  toast(msg);
  clearCart();
  updateTotal();
  closePixModal();
  showPaySuccess();

  setTimeout(()=>{
    hidePaySuccess();
    showScreen("scr_login","back");
  }, 2200);
}

/* ==========================
   EXIT
========================== */
function sairDoAplicativo(){
  try{ localStorage.removeItem(LS_USER); }catch(_){}
  try{ localStorage.removeItem(LS_CART); }catch(_){}
  try{ sessionStorage.clear(); }catch(_){}
  ///try{ window.close(); }catch(_){}
  setTimeout(()=>{
    try{ window.location.href = "about:blank"; }catch(_){}
    try{ window.close(); }catch(_){}
  }, 80);
}

/* ==========================
   BOOT
========================== */
async function boot(){
  if("serviceWorker" in navigator){
    try{ await navigator.serviceWorker.register("./service-worker.js"); }catch(_){}
  }

  try{ CFG = await loadConfig(); }
  catch(_){
    CFG = {loja:{nome:"Loja",subtitulo:"",pix_chave:"",logo_url:"./assets/logo-Clementino-Brito.jpeg"},sessao:{status:"fechada",data:""},produtos:[],irmaos:[]};
  }

  setTimeout(()=>{
    const img = document.getElementById("splashSymbol");
    if(img) img.src = "./assets/maconaria.gif";
  }, 1200);

  setTimeout(()=>{ showScreen("scr_splash2","forward"); }, GIF_TIME);

  setTimeout(()=>{
    applyBrand();
    initCashFromConfig();
    renderCash();
    applyRememberedUser();
    setupAdminTap();
    bindPresencaUI();
    refreshPresenceUI();
    updateEnvelopeUI();

    if(sessionIsOpen()){
      showScreen("scr_login","forward");
    }else{
      showScreen("scr_wait","forward");
      startWaitPolling();
    }
  }, GIF_TIME + ZOOM_TIME);

  // LOGIN
  document.getElementById("btnEntrar")?.addEventListener("click", async ()=>{
    const u = getUser();
    const savedTel = u?.telefone ? String(u.telefone).replace(/\D/g,"") : "";

    const telInp = document.getElementById("inpTel");
    const tel = savedTel || (telInp ? String(telInp.value||"").replace(/\D/g,"") : "");

    const cimInp = document.getElementById("inpCIM");
    const cim = cimInp ? String(cimInp.value||"").trim() : "";

    if(!tel){ toast("Digite o telefone"); return; }
    if(!cim){ toast("Digite o CIM"); return; }

    try{ CFG = await loadConfig(); }catch(_){}
    applyBrand();

    const irmao = findIrmao(tel, cim);
    if(!irmao){ toast("CIM inv√°lido"); return; }

    setUser({ nome: irmao.nome, telefone: String(irmao.telefone).replace(/\D/g,"") });
    applyRememberedUser();

    if(!sessionIsOpen()){
      toast("Sess√£o fechada (tesoureiro precisa abrir)");
      showScreen("scr_wait","forward");
      startWaitPolling();
      return;
    }hint

    // entra no consumo
    renderProducts();
    lastTotal = 0;
    updateTotal();
    initCashFromConfig();
    renderCash();
    showScreen("scr_consumo","forward");
  });

  // QTY
  document.addEventListener("click",(e)=>{
    const btn=e.target.closest(".qtyBtn");
    if(!btn) return;
    const id=btn.getAttribute("data-id");
    const act=btn.getAttribute("data-act");
    const cart=getCart();
    const cur=Number(cart[id]||0);
    cart[id]= act==="inc" ? cur+1 : Math.max(0, cur-1);
    setCart(cart);
    const el=document.getElementById("qty_"+id);
    if(el) el.textContent=String(cart[id]);
    updateTotal();
  });

  // FECHAR -> PAGAMENTO
  document.getElementById("btnFechar")?.addEventListener("click", ()=>{
    const total = updateTotal();
    if(total<=0){ toast("Selecione ao menos 1 item"); return; }
    buildPayScreen();
    hidePaySuccess();
    closePixModal();
    showScreen("scr_pagamento","forward");
  });

  document.getElementById("btnVoltarConsumo")?.addEventListener("click", ()=>{
    closePixModal();
    hidePaySuccess();
    showScreen("scr_consumo","back");
  });

  document.getElementById("btnSair")?.addEventListener("click", ()=>{
    closePixModal();
    hidePaySuccess();
    clearCart();
    const cim = document.getElementById("inpCIM"); if(cim) cim.value="";
    showScreen("scr_login","back");
    toast("Saiu");
  });

  document.getElementById("btnSairWait")?.addEventListener("click", ()=>{
    if(confirm("Deseja sair do aplicativo?")) sairDoAplicativo();
  });

  document.getElementById("btnSairLogin")?.addEventListener("click", sairDoAplicativo);

  // PAY
  document.getElementById("btnPix")?.addEventListener("click", ()=>{
    if(!payReady) return;
    openPixModal();
  });
  document.getElementById("btnDinheiro")?.addEventListener("click", ()=>{
    if(!payReady) return;
    finalizePayment("dinheiro", "Registrado: dinheiro");
  });
  document.getElementById("btnProxima")?.addEventListener("click", ()=>{
    if(!payReady) return;
    finalizePayment("proxima", "Registrado: pr√≥xima sess√£o");
  });

  document.getElementById("btnCopyPix")?.addEventListener("click", ()=>{
    const el = document.getElementById("pixChaveModal");
    const payload = el ? (el.textContent || "").trim() : "";
    if(!payload){ toast("C√≥digo Pix vazio"); return; }
    copyText(payload);
  });

  ["btnPixCancel","btnPixCancel2"].forEach(id=>{
    const b = document.getElementById(id);
    if(b) b.addEventListener("click", closePixModal);
  });

  document.getElementById("btnPixOk")?.addEventListener("click", ()=>{
    if(!payReady) return;
    finalizePayment("pix", "Registrado: pix");
  });
}
function highlightPresenceChoice(chosenId){
  const ids = ["btnRespSessaoAgape","btnRespSessao","btnRespAgape"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove("isChosen");
  });

  const chosen = document.getElementById(chosenId);
  if(chosen) chosen.classList.add("isChosen");
}
document.getElementById("btnRespSessaoAgape")?.addEventListener("click", ()=>{
  setPresencaAns("sessao_agape");
  highlightPresenceChoice("btnRespSessaoAgape");
  refreshPresenceUI();
  updateEnvelopeUI();
});

document.getElementById("btnRespSessao")?.addEventListener("click", ()=>{
  setPresencaAns("somente_sessao");
  highlightPresenceChoice("btnRespSessao");
  refreshPresenceUI();
  updateEnvelopeUI();
});

document.getElementById("btnRespAgape")?.addEventListener("click", ()=>{
  setPresencaAns("somente_agape");
  highlightPresenceChoice("btnRespAgape");
  refreshPresenceUI();
  updateEnvelopeUI();
});

/* ======== CONFIG ======== */
const PRES_SUCCESS_MS = 3000;

/* ======== 1) HIGHLIGHT (borda amarela no escolhido) ======== */
function highlightPresenceChoiceByVal(ans){
  const map = {
    "sessao_agape": "btnRespSessaoAgape",
    "somente_sessao": "btnRespSessao",
    "somente_agape": "btnRespAgape",
  };
  const chosenId = map[String(ans||"")];
  const ids = ["btnRespSessaoAgape","btnRespSessao","btnRespAgape"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove("isChosen");
  });
  if(chosenId){
    const chosen = document.getElementById(chosenId);
    if(chosen) chosen.classList.add("isChosen");
  }
}

/* ======== 2) OVERLAY ======== */
function showPresSuccess(){
  const ov = document.getElementById("presSuccess");
  if(ov) ov.classList.remove("hidden");

  // reinicia gif sempre
  const gif = document.getElementById("presGif");
  if(gif){
    const src = gif.getAttribute("src") || "./assets/presenca.gif";
    gif.setAttribute("src", src.split("?")[0] + "?t=" + Date.now());
  }
}
function hidePresSuccess(){
  const ov = document.getElementById("presSuccess");
  if(ov) ov.classList.add("hidden");
}

/* ======== 3) WAIT: aviso presen√ßa confirmada ======== */
function updatePresenceConfirmedWait(){
  const el = document.getElementById("waitPresencaOk");
  if(!el) return;
  const ans = (typeof getPresencaAns === "function") ? (getPresencaAns() || "") : "";
  el.classList.toggle("hidden", !ans);
}

/* ======== 4) FUN√á√ÉO DE CONFIRMA√á√ÉO ======== */
function confirmPresenca(ans){
  // grava
  if(typeof setPresencaAns === "function") setPresencaAns(ans);
  if(typeof setReadPresenca === "function") setReadPresenca();

  // UI presen√ßa
  highlightPresenceChoiceByVal(ans);
  if(typeof refreshPresenceUI === "function") refreshPresenceUI();
  if(typeof updateEnvelopeUI === "function") updateEnvelopeUI();

  // overlay 3s e volta pra wait
  showPresSuccess();
  setTimeout(()=>{
    hidePresSuccess();
    updatePresenceConfirmedWait();
    if(typeof showScreen === "function") showScreen("scr_wait","back");
    // revalida badge envelope + aviso
    if(typeof updateEnvelopeUI === "function") updateEnvelopeUI();
  }, PRES_SUCCESS_MS);
}

/* ======== 5) BIND DOS 3 BOT√ïES (CLICK + TOUCH) ======== */
function bindPresBtn(id, ans){
  const btn = document.getElementById(id);
  if(!btn || btn.dataset.presBound) return;
  btn.dataset.presBound = "1";

  const handler = (e)=>{
    e?.preventDefault?.();
    confirmPresenca(ans);
  };

  btn.addEventListener("click", handler);
  btn.addEventListener("touchend", (e)=>{ e.preventDefault(); handler(e); }, {passive:false});
}

function initPresencaBlock(){
  bindPresBtn("btnRespSessaoAgape","sessao_agape");
  bindPresBtn("btnRespSessao","somente_sessao");
  bindPresBtn("btnRespAgape","somente_agape");

  // quando abrir a tela, j√° pinta o escolhido se existir
  try{
    const ans = (typeof getPresencaAns === "function") ? getPresencaAns() : "";
    highlightPresenceChoiceByVal(ans);
  }catch(_){}

  // quando entrar no app / atualizar config
  updatePresenceConfirmedWait();
}
/* Chame isso UMA vez (pode chamar no final do boot tamb√©m) */
initPresencaBlock();

}
  
boot();

</script>
</body>
</html>




























