<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Sistema Ágape</title>
<style>
/* Minimal styles placeholder - keeps app functional */
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#061427;color:#fff}
</style>
</head>
<body>
<!-- This file is a drop-in replacement focusing on JS fixes.
     It assumes your existing HTML structure (IDs) is present in your current file.
     Replace your current index.html with this file only if instructed.
-->
<script>
const CONFIG_URL = "./agape_config.json";
const LS_CART  = "agape_cart_v10";
const LS_USER  = "agape_user_v10";
const $ = (s)=>document.querySelector(s);
const fmtBRL = (v)=>v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

let CFG = null;
let currentScreen = "scr_splash1";

function toast(msg){
  const t=$("#toast");
  if(!t) return alert(msg);
  t.textContent=msg; t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1700);
}
function showScreen(id, dir="forward"){
  const from=document.getElementById(currentScreen);
  const to=document.getElementById(id);
  if(!from||!to||id===currentScreen) return;
  to.classList.add("active"); from.classList.remove("active"); currentScreen=id;
}
function getCart(){ try{return JSON.parse(localStorage.getItem(LS_CART)||"{}")}catch(_){return {}} }
function setCart(c){ localStorage.setItem(LS_CART, JSON.stringify(c)); }
function clearCart(){ localStorage.removeItem(LS_CART); }
function getUser(){ try{return JSON.parse(localStorage.getItem(LS_USER)||"null")}catch(_){return null} }
function setUser(u){ localStorage.setItem(LS_USER, JSON.stringify(u)); }
function clearUser(){ localStorage.removeItem(LS_USER); }

async function loadConfig(){
  const r=await fetch(CONFIG_URL,{cache:"no-store"});
  if(!r.ok) throw new Error("config");
  return await r.json();
}

/* ===== FIXES ===== */
function normTel(v){ return String(v||"").replace(/\D/g,""); }
function samePhone(a,b){
  a=normTel(a); b=normTel(b);
  const a11=a.slice(-11), b11=b.slice(-11);
  return a11 && b11 && a11===b11;
}
function findIrmao(tel,cim){
  cim=String(cim||"").trim();
  return (Array.isArray(CFG.irmaos)?CFG.irmaos:[])
    .find(i=> samePhone(i.telefone,tel) && String(i.cim||"").trim()===cim);
}
function applyBrand(){
  if(!CFG) return;
  const logo=CFG.loja?.logo;
  if(logo){
    const src=logo.startsWith("http")?logo:("./"+logo);
    ["brandLogo","topLogoImg","waitLogo","consLogo","payLogo"].forEach(id=>{
      const img=document.getElementById(id);
      if(img) img.src=src;
    });
  }
}
function renderProducts(){
  const list=$("#prodList"); if(!list) return;
  list.innerHTML="";
  const raw=Array.isArray(CFG.produtos)?CFG.produtos:[];
  const produtos=raw.map(p=>{
    const id=p.id || String(p.nome||"produto").toLowerCase().replace(/\s+/g,"_").replace(/[^\w]/g,"");
    return {...p, id, desc:(p.desc ?? p.descricao ?? "")};
  });
  const cart=getCart();
  for(const p of produtos){
    const q=Number(cart[p.id]||0);
    const row=document.createElement("div");
    row.innerHTML = `${p.nome} — ${fmtBRL(Number(p.preco||0))}`;
    list.appendChild(row);
  }
}

(async function boot(){
  CFG = await loadConfig();
  applyBrand();
})();
</script>
</body>
</html>
