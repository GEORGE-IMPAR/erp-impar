<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#071a2b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./favicon.ico" />
  <title>Sistema √Ågape</title>

<style>
  :root{
    --bg1:#071a2b;
    --bg2:#031421;
    --text:#fff;
    --muted:rgba(255,255,255,.74);
    --glass:rgba(255,255,255,.06);
    --stroke:rgba(255,255,255,.10);
    --good:#33d07a;
    --bad:#ff3b30;
    --yellow:rgba(255,215,0,.22);
  }

  html,body{
    height:100%;
    margin:0;
    background: linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 80%) !important;
    color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    overscroll-behavior: none;
  }

  /* fullscreen safe-area */
  .safe{ padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }

  /* Screens base */
  .screen{
    position:fixed;
    inset:0;
    width:100vw;
    height:100dvh;
    display:none;
    opacity:0;
    transform:translateX(0);
    transition: transform .46s ease, opacity .46s ease;
    background: linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 80%) !important;
  }

  .screen.active{
    display:flex;
    opacity:1;
    transform:translateX(0);
  }

  /* Transi√ß√µes */
  .enter-left{ transform:translateX(100%); opacity:1; }
  .enter-right{ transform:translateX(-100%); opacity:1; }
  .exit-left{ transform:translateX(-100%); opacity:1; }
  .exit-right{ transform:translateX(100%); opacity:1; }

  .screen.enter-left,
  .screen.enter-right,
  .screen.exit-left,
  .screen.exit-right{ display:flex; }

  /* Splash 0 (impercept√≠vel) */
  #scr_splash0{ align-items:center; justify-content:center; background:#061a2b !important; }

  /* Splash 1: blue */
  #scr_splash1{align-items:center; justify-content:center; background:#061a2b !important;}

  /* Splash 2: logo zoom */
  #scr_splash2{align-items:center; justify-content:center; background:#061a2b !important;}

  .splashCenter{
    display:flex; flex-direction:column; align-items:center; gap:16px;
    text-align:center; padding:24px;
  }
  .logoWrap{
    width:96px; height:96px; border-radius:22px;
    background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12);
    overflow:hidden;
    box-shadow: 0 18px 40px rgba(0,0,0,.35);
    opacity:0;
    transform: scale(.82);
  }
  .logoWrap img{width:100%; height:100%; object-fit:cover; display:block}
  .brandText{
    font-weight:900;
    font-size:34px;
    letter-spacing:.2px;
    opacity:0;
    transform: translateY(6px) scale(.98);
  }
  @keyframes zoomLogo{0%{opacity:0;transform:scale(.82)}100%{opacity:1;transform:scale(1)}}
  @keyframes fadeUp{0%{opacity:0;transform:translateY(6px) scale(.98)}100%{opacity:1;transform:translateY(0) scale(1)}}
  #scr_splash2.active .logoWrap{animation:zoomLogo 3s ease-out forwards;}
  #scr_splash2.active .brandText{animation:fadeUp 3s ease-out forwards;animation-delay:.20s;}

  /* Toast */
  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background: rgba(0,0,0,.75);
    color:white; padding:10px 14px;
    border-radius:14px;
    opacity:0; pointer-events:none;
    transition: opacity .25s ease;
    font-weight:800;
    z-index:999999;
  }
  .toast.show{opacity:1}

  /* Wrap */
  .wrap{width:min(430px, 100%); margin:0 auto; padding:16px; box-sizing:border-box;}

  .topBrand{
    display:flex; gap:12px; align-items:center;
    padding:14px 14px;
    border-radius:18px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    box-shadow:0 12px 40px rgba(0,0,0,.25);
  }
  .bLogo{width:46px;height:46px;border-radius:12px;background:rgba(255,255,255,.10); overflow:hidden; display:flex; align-items:center; justify-content:center;}
  .bLogo img{width:100%;height:100%;object-fit:cover;display:block;}
  .bTxt{line-height:1.15}
  .bTitle{font-weight:900;font-size:18px}
  .bSub{font-size:12px;opacity:.85;margin-top:2px}

  .sessionBar{
    margin-top:14px; display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:14px;
    background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10);
  }
  .dotBig{width:16px;height:16px;border-radius:50%; background:var(--bad); box-shadow:0 0 0 4px rgba(255,0,0,.10);}
  .sessionLine{font-weight:900; font-size:15px; letter-spacing:.2px;}

  .pixBar{
    margin-top:10px; display:flex; align-items:center; gap:12px; padding:12px 14px; border-radius:14px;
    background:rgba(10,200,160,.16); border:1px solid rgba(100,255,230,.25);
  }
  .pixBadge{
    width:64px; height:36px; border-radius:10px; background:rgba(255,255,255,.12);
    display:flex; align-items:center; justify-content:center;
  }
  .pixBadge img{width:70px;height:26px;object-fit:contain;display:block;filter:drop-shadow(0 2px 8px rgba(0,0,0,.25));}
  .pixKey{font-weight:900; font-size:16px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

  /* Cards */
  .card{
    margin-top:14px;
    padding:16px;
    border-radius:22px;
    background: rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.12);
    box-shadow: 0 24px 55px rgba(0,0,0,.32);
  }
  .card h2{margin:0 0 6px 0; font-size:34px; letter-spacing:.2px}
  .card p{margin:0 0 14px 0; color:var(--muted);}

  label{display:block; font-weight:800; margin:10px 0 6px 0; font-size:15px}
  input{
    width:100%;
    padding:14px 14px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    color:var(--text);
    outline:none;
    font-size:16px;
    box-sizing:border-box;
  }
  input:focus{border-color: rgba(45,140,255,.55); box-shadow: 0 0 0 3px rgba(45,140,255,.18)}

  .btn{
    width:100%;
    margin-top:14px;
    padding:16px 14px;
    border-radius:18px;
    border:none;
    background: linear-gradient(90deg, #19baff, #3a66ff);
    color:#001018;
    font-weight:1000;
    font-size:20px;
  }

  .shake{animation: shake .35s ease}
  @keyframes shake{
    0%,100%{transform:translateX(0)}
    20%{transform:translateX(-7px)}
    40%{transform:translateX(7px)}
    60%{transform:translateX(-5px)}
    80%{transform:translateX(5px)}
  }

  /* Login exit button */
  .loginTopRow{display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .exitBtn{
    width:42px; height:42px; border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    color:#fff;
    display:flex; align-items:center; justify-content:center;
    font-weight:1000;
    cursor:pointer;
    transition: transform .15s ease, background .15s ease;
  }
  .exitBtn:active{transform:scale(.97)}
  .exitBtn:hover{background: rgba(255,255,255,.10);}

  /* Consumo: fixed header/footer, scroll only products */
  #scr_consumo{align-items:stretch; justify-content:center;}
  .page{display:flex; flex-direction:column; height:100%; width:min(440px, 100%); margin:0 auto;}
  .prodScroll{flex:1; min-height:0; overflow:auto; padding: 12px 16px 10px 16px; -webkit-overflow-scrolling: touch;}
  .prodRow{
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    padding:14px 14px;
    border-radius:18px;
    background: rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.10);
    margin-bottom:12px;
  }
  .prodLeft{display:flex; align-items:center; gap:10px; min-width:0;}
  .prodIcon{width:44px; height:44px; border-radius:14px; overflow:hidden; flex:0 0 44px;
    background:rgba(255,255,255,.08); display:flex; align-items:center; justify-content:center;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.10);}
  .prodIcon img{width:100%; height:100%; object-fit:cover; display:block;}
  .prodMeta{display:flex; flex-direction:column; gap:1px; min-width:0;}
  .prodName{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .prodDesc{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .prodPrice{margin-top:6px; font-weight:1000}
  .qtyWrap{display:flex; align-items:center; gap:10px; flex:0 0 auto;}
  .qtyBtn{
    width:40px;height:40px;border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color:var(--text);
    font-size:22px; line-height:1;
    display:flex; align-items:center; justify-content:center;
    font-weight:1000;
    cursor:pointer;
    transition: transform .12s ease, background .12s ease;
  }
  .qtyBtn:active{transform:scale(.96)}
  .qtyBtn:hover{background: rgba(255,255,255,.10);}
  .qty{min-width:20px; text-align:center; font-weight:1000}

  .consFooter{
    padding: 12px 16px 16px 16px;
    background: linear-gradient(180deg, rgba(7,26,43,0) 0%, rgba(7,26,43,.65) 30%, rgba(7,26,43,.92) 100%);
  }
  .totalBox{
    padding:14px 14px;
    border-radius:18px;
    background: rgba(0,0,0,.20);
    border:1px solid rgba(255,255,255,.10);
    margin-bottom:12px;
  }
  .totalBox .tLbl{font-size:12px; color:var(--muted)}
  .totalBox .tVal{font-size:28px; font-weight:1000; margin-top:6px}
  .btn2{
    width:100%;
    padding:14px 12px;
    border:none;
    border-radius:18px;
    background: linear-gradient(90deg, #19baff, #3a66ff);
    color:#001018;
    font-weight:1000;
    font-size:18px;
    cursor:pointer;
    transition: transform .12s ease, filter .12s ease;
  }
  .btn2:active{transform:scale(.985)}
  .btn2:hover{filter:brightness(1.06)}

  /* Pagamento */
  #scr_pagamento{align-items:flex-start; justify-content:center;}
  .payBtns{display:flex; flex-direction:column; gap:12px; margin-top:12px}
  .payBtn{
    padding:16px 14px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color:var(--text);
    font-weight:1000;
    font-size:18px;
    text-align:center;
    cursor:pointer;
    transition: transform .12s ease, background .12s ease;
    position:relative;
  }
  .payBtn:hover{background: rgba(255,255,255,.10);}
  .payBtn:active{transform:scale(.99)}
  .payBtn.primary{background: rgba(51,208,122,.18); border-color: rgba(51,208,122,.35)}
  .payBtn.warn{background: rgba(255,215,0,.14); border-color: rgba(255,215,0,.25)}

  /* Modal Pix */
  .modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:99990;
    background: rgba(0,0,0,.55); padding:18px;}
  .modal.hidden{display:none;}
  .modalCard{
    width:min(420px, 100%);
    border-radius:20px;
    background: rgba(7,26,43,.95);
    border:1px solid rgba(255,255,255,.12);
    box-shadow: 0 28px 70px rgba(0,0,0,.45);
    padding:14px;
  }
  .modalTop{display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .modalTitle{font-weight:1000; font-size:20px;}
  .modalX{
    width:42px;height:42px;border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    color:#fff; font-weight:1000; cursor:pointer;
  }
  .modalText{margin-top:10px; font-size:13px; opacity:.88; line-height:1.35;}
  .pixValueRow{margin-top:12px; display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:12px 12px; border-radius:16px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);}
  .pixValueLbl{font-weight:900; opacity:.85}
  .pixValue{font-weight:1000; font-size:18px}

  .pixKeyRow{
    margin-top:12px;
    display:flex; align-items:center; gap:10px;
    padding:12px 12px; border-radius:16px;
    background: rgba(10,200,160,.14);
    border:1px solid rgba(100,255,230,.25);
  }
  .pixKeyText{
    flex:1; min-width:0;
    font-weight:1000; font-size:12px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .pixCopyBtn{
    width:44px;height:44px;border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.08);
    color:#fff; font-size:18px; cursor:pointer;
    transition: transform .12s ease, background .12s ease;
  }
  .pixCopyBtn:hover{background: rgba(255,255,255,.12);}
  .pixCopyBtn:active{transform:scale(.97)}

  .modalOk{margin-top:12px;}
  .modalCancel{
    width:100%;
    margin-top:10px;
    padding:12px 12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    color:#fff;
    font-weight:900;
    cursor:pointer;
  }

  /* Pay success overlay full */
  .paySuccess{
    position:fixed;
    inset:0;
    width:100vw;
    height:100dvh;
    background: #f0d51a;
    z-index:999999;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .paySuccess.hidden{display:none;}
  .paySuccessInner{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:14px;
    padding:18px;
    background: transparent !important;
    border:0 !important;
    box-shadow:none !important;
  }
  .paySuccessInner img{width:140px;height:140px;object-fit:contain;display:block;}
  .payOkText{font-weight:1000; font-size:18px; color:#0a2a14;}

  /* desktop center */
  @media (min-width:900px){
    body{display:flex; align-items:center; justify-content:center; background:#081b2c;}
    .screen{position:relative; width:420px; height:860px; border-radius:26px; overflow:hidden; box-shadow:0 30px 80px rgba(0,0,0,.55);}
  }
</style>
</head>
<body>
  <div id="toast" class="toast"></div>

  <!-- Splash 0 (passa r√°pido) -->
  <section id="scr_splash0" class="screen active safe"></section>

  <!-- Splash 1 -->
  <section id="scr_splash1" class="screen safe"></section>

  <!-- Splash 2 -->
  <section id="scr_splash2" class="screen safe">
    <div class="splashCenter">
      <div class="logoWrap"><img id="splashLogo" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/></div>
      <div class="brandText">Sistema √Ågape</div>
    </div>
  </section>

  <!-- Wait (sess√£o fechada) -->
  <section id="scr_wait" class="screen safe">
    <div class="wrap">
      <div class="topBrand">
        <div class="bLogo"><img id="brandLogoWait" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/></div>
        <div class="bTxt">
          <div class="bTitle" id="lojaNomeWait">Loja</div>
          <div class="bSub" id="lojaSubWait">App √Ågape ‚Ä¢ Consumo & Pagamento</div>
        </div>
      </div>

      <div class="sessionBar">
        <div class="dotBig" id="sessaoDotWait"></div>
        <div class="sessionLine" id="sessaoLineWait">Sess√£o fechada ‚Äî ‚Äî</div>
      </div>

      <div class="pixBar">
        <div class="pixBadge"><img src="./assets/logo-pix.jpg" alt="Pix"></div>
        <div class="pixKey" id="pixChaveWait">‚Äî</div>
      </div>

      <div class="card">
        <div style="font-weight:1000;font-size:18px;">Sess√£o ainda n√£o liberada üîí</div>
        <div style="margin-top:6px;font-size:13px;opacity:.90;line-height:1.35;">
          A sess√£o ainda n√£o foi aberta pelo respons√°vel, mas n√£o se preocupe. Quando liberar a sess√£o, automaticamente aparecer√° a tela de login.
        </div>
        <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div style="padding:12px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);">
            <div style="font-size:12px;opacity:.75;">√öltima verifica√ß√£o</div>
            <div style="margin-top:4px;font-weight:1000;font-size:16px;" id="lastCheck">‚Äî</div>
          </div>
          <div style="padding:12px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);">
            <div style="font-size:12px;opacity:.75;">Sess√£o</div>
            <div style="margin-top:4px;font-weight:1000;font-size:16px;" id="sessaoStatus">Fechada</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Login -->
  <section id="scr_login" class="screen safe" style="align-items:flex-start; justify-content:center;">
    <div class="wrap">
      <div class="topBrand">
        <div class="bLogo"><img id="brandLogoLogin" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/></div>
        <div class="bTxt">
          <div class="bTitle" id="lojaNome">Loja</div>
          <div class="bSub" id="lojaSub">App √Ågape ‚Ä¢ Consumo & Pagamento</div>
        </div>
      </div>

      <div class="sessionBar">
        <div class="dotBig" id="sessaoDot"></div>
        <div class="sessionLine" id="sessaoLine">Sess√£o ‚Äî</div>
      </div>

      <div class="pixBar">
        <div class="pixBadge"><img src="./assets/logo-pix.jpg" alt="Pix"></div>
        <div class="pixKey" id="pixChave">‚Äî</div>
      </div>

      <div class="card">
        <div class="loginTopRow">
          <h2 style="margin:0;">Login</h2>
          <button class="exitBtn" id="btnExitApp" type="button" title="Sair do app">‚®Ø</button>
        </div>
        <p>Informe o seu CIM para acessar.</p>

        <label for="inpTel" style="display:none" id="telWrap">Telefone</label>
        <input id="inpTel" type="tel" inputmode="numeric" autocomplete="tel" style="display:none" />

        <label for="inpCIM">CIM</label>
        <input id="inpCIM" inputmode="numeric" autocomplete="one-time-code" placeholder="Digite o seu CIM" />

        <button class="btn" id="btnEntrar" type="button">Acessar</button>
      </div>
    </div>
  </section>

  <!-- Consumo -->
  <section id="scr_consumo" class="screen safe">
    <div class="page">
      <div class="wrap">
        <div class="topBrand">
          <div class="bLogo"><img id="brandLogoCons" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/></div>
          <div class="bTxt">
            <div class="bTitle" id="consLoja">Loja</div>
            <div class="bSub" id="consUser">Meu Consumo</div>
          </div>
        </div>

        <div class="sessionBar">
          <div class="dotBig" id="sessaoDotCons"></div>
          <div class="sessionLine" id="sessaoLineCons">Sess√£o ‚Äî</div>
        </div>

        <div class="pixBar">
          <div class="pixBadge"><img src="./assets/logo-pix.jpg" alt="Pix"></div>
          <div class="pixKey" id="payPix">‚Äî</div>
        </div>
      </div>

      <div class="prodScroll" id="prodList"></div>

      <div class="consFooter">
        <div class="totalBox">
          <div class="tLbl">Total</div>
          <div class="tVal" id="totalValue">R$ 0,00</div>
        </div>
        <button class="btn2" id="btnFechar" type="button">Fechar e pagar</button>
        <div style="margin-top:10px;">
          <button class="modalCancel" id="btnSair" type="button">Sair</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Pagamento -->
  <section id="scr_pagamento" class="screen safe">
    <div class="wrap">
      <div class="topBrand">
        <div class="bLogo"><img id="brandLogoPay" src="./assets/logo-Clementino-Brito.jpeg" alt="Logo"/></div>
        <div class="bTxt">
          <div class="bTitle">Pagamento</div>
          <div class="bSub" id="payUser">‚Äî</div>
        </div>
      </div>

      <div class="sessionBar">
        <div class="dotBig" id="sessaoDotPay"></div>
        <div class="sessionLine" id="sessaoLinePay">Sess√£o ‚Äî</div>
      </div>

      <div class="card">
        <div style="font-weight:1000;font-size:18px;">Sua conta deu <span id="payTotal">R$ 0,00</span></div>
        <div style="margin-top:8px;font-size:13px;opacity:.85;">Confira os itens consumidos:</div>
        <div id="payItems" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;"></div>

        <div class="payBtns">
          <div class="payBtn primary" id="btnPix" title="Pix">üí† Pix</div>
          <div class="payBtn" id="btnDinheiro" title="Dinheiro">üíµ Dinheiro</div>
          <div class="payBtn warn" id="btnProxima" title="Pr√≥xima sess√£o">üóìÔ∏è Pr√≥xima sess√£o</div>
        </div>

        <div style="margin-top:12px;">
          <button class="modalCancel" id="btnVoltar" type="button">Voltar</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal Pix -->
  <div id="pixModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="pixTitle">
    <div class="modalCard">
      <div class="modalTop">
        <div class="modalTitle" id="pixTitle">Pix</div>
        <button class="modalX" id="btnPixCancel" type="button" aria-label="Fechar">‚úï</button>
      </div>

      <div class="modalText">Copie o c√≥digo Pix (Copia e Cola) e fa√ßa a transfer√™ncia do valor exato.</div>

      <div class="pixValueRow">
        <div class="pixValueLbl">Valor</div>
        <div class="pixValue" id="pixValor">R$ 0,00</div>
      </div>

      <div class="pixKeyRow">
        <div class="pixKeyText" id="pixChaveModal">‚Äî</div>
        <button class="pixCopyBtn" id="btnCopyPix" type="button" title="Copiar">üìã</button>
      </div>

      <button class="btn2 modalOk" id="btnPixOk" type="button">OK, transferi</button>
      <button class="modalCancel" id="btnPixCancel2" type="button">Cancelar</button>
    </div>
  </div>

  <!-- Sucesso -->
  <div id="paySuccess" class="paySuccess hidden" aria-hidden="true">
    <div class="paySuccessInner">
      <img id="payGif" src="./assets/check.gif" alt="Pago">
      <div class="payOkText">Pagamento registrado</div>
    </div>
  </div>

<script>
const CONFIG_URL = "./agape_config.json";
const LS_CART  = "agape_cart_v25";
const LS_USER  = "agape_user_v25";
const $ = (s)=>document.querySelector(s);
const fmtBRL = (v)=>Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

let CFG = null;
let currentScreen = "scr_splash0";
let payReady = true;
let LAST_PAY_TOTAL = 0;
let LAST_PAY_ITEMS = [];

function toast(msg){
  const t=$("#toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1700);
}

function showScreen(id, dir="forward"){
  const from=document.getElementById(currentScreen);
  const to=document.getElementById(id);
  if(!from||!to||id===currentScreen) return;

  to.classList.remove("exit-left","exit-right","enter-left","enter-right");
  from.classList.remove("exit-left","exit-right","enter-left","enter-right");

  if(dir==="forward") to.classList.add("enter-left"); else to.classList.add("enter-right");
  to.classList.add("active");
  void to.offsetWidth;
  to.classList.remove("enter-left","enter-right");

  if(dir==="forward") from.classList.add("exit-left"); else from.classList.add("exit-right");

  setTimeout(()=>{
    from.classList.remove("active","exit-left","exit-right");
    currentScreen=id;
  }, 460);
}

function getCart(){ try{return JSON.parse(localStorage.getItem(LS_CART)||"{}")}catch(_){return {}} }
function setCart(c){ localStorage.setItem(LS_CART, JSON.stringify(c)); }
function clearCart(){ localStorage.removeItem(LS_CART); }
function getUser(){ try{return JSON.parse(localStorage.getItem(LS_USER)||"null")}catch(_){return null} }
function setUser(u){ localStorage.setItem(LS_USER, JSON.stringify(u)); }
function clearUser(){ localStorage.removeItem(LS_USER); }

async function loadConfig(){
  try{
    const r=await fetch(CONFIG_URL,{cache:"no-store"});
    if(!r.ok) throw new Error();
    return await r.json();
  }catch(e){
    return {loja:{nome:"Loja",subtitulo:"",pix_chave:""},sessao:{status:"fechada",data:""},produtos:[],irmaos:[]};
  }
}

function applyBrand(){
  $("#lojaNome").textContent = CFG.loja?.nome || "Loja";
  $("#lojaSub").textContent = CFG.loja?.subtitulo || "";
  $("#pixChave").textContent = CFG.loja?.pix_chave || "";
  $("#payPix").textContent = CFG.loja?.pix_chave || "";
  $("#consLoja").textContent = CFG.loja?.nome || "Loja";

  $("#lojaNomeWait").textContent = CFG.loja?.nome || "Loja";
  $("#lojaSubWait").textContent = CFG.loja?.subtitulo || "";
  $("#pixChaveWait").textContent = CFG.loja?.pix_chave || "‚Äî";

  const opened = (CFG.sessao?.status||"").toLowerCase()==="aberta";
  const dotColor = opened ? "var(--good)" : "var(--bad)";
  const line = CFG.sessao?.data ? `Sess√£o ${opened?"aberta":"fechada"} ‚Äî ${CFG.sessao.data}` : (opened ? "Sess√£o liberada" : "Sess√£o fechada");

  const idsDots = ["sessaoDot","sessaoDotWait","sessaoDotCons","sessaoDotPay"];
  idsDots.forEach(id=>{ const el=document.getElementById(id); if(el) el.style.background = dotColor; });

  const idsLines = ["sessaoLine","sessaoLineWait","sessaoLineCons","sessaoLinePay"];
  idsLines.forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent = line; });

  $("#lastCheck").textContent = new Date().toLocaleString("pt-BR");
  $("#sessaoStatus").textContent = opened ? "Aberta" : "Fechada";
}

function sessionIsOpen(){ return (CFG.sessao?.status||"").toLowerCase()==="aberta"; }

function renderProducts(){
  const list=$("#prodList"); list.innerHTML="";
  const produtos=Array.isArray(CFG.produtos)?CFG.produtos:[];
  const cart=getCart();
  if(produtos.length===0){
    list.innerHTML='<div class="wrap" style="opacity:.75">Sem produtos no JSON.</div>';
    return;
  }

  for(const p of produtos){
    const q=Number(cart[p.id]||0);
    const row=document.createElement("div");
    row.className="prodRow";
    const icon = p.icon ? `./assets/${p.icon}` : (p.img ? p.img : "");
    row.innerHTML=`
      <div class="prodLeft">
        <div class="prodIcon">${icon?`<img src="${icon}" alt="">`:""}</div>
        <div class="prodMeta">
          <div class="prodName">${p.nome||"Produto"}</div>
          <div class="prodDesc">${p.desc||""}</div>
          <div class="prodPrice">${fmtBRL(Number(p.preco||0))}</div>
        </div>
      </div>
      <div class="qtyWrap">
        <button class="qtyBtn" data-act="dec" data-id="${p.id}">‚àí</button>
        <div class="qty" id="qty_${p.id}">${q}</div>
        <button class="qtyBtn" data-act="inc" data-id="${p.id}">+</button>
      </div>
    `;
    list.appendChild(row);
  }
  updateTotal(true);
}

function animateNumber(el, from, to, duration=240){
  const start = performance.now();
  const diff = to-from;
  function tick(now){
    const t = Math.min(1, (now-start)/duration);
    const val = from + diff*t;
    el.textContent = fmtBRL(val);
    if(t<1) requestAnimationFrame(tick);
    else el.textContent = fmtBRL(to);
  }
  requestAnimationFrame(tick);
}

function updateTotal(animate=false){
  const cart=getCart();
  const produtos=Array.isArray(CFG.produtos)?CFG.produtos:[];
  let total=0;
  for(const p of produtos){
    total += Number(cart[p.id]||0)*Number(p.preco||0);
  }
  const el=$("#totalValue");
  if(animate && el){
    const curTxt = (el.textContent||"0").replace(/[^\d,]/g,"").replace(".","").replace(",",".");
    const cur = Number(curTxt||0);
    animateNumber(el, cur, total, 240);
  }else{
    $("#totalValue").textContent=fmtBRL(total);
  }
  $("#payTotal").textContent=fmtBRL(total);
  return total;
}

function findIrmaoByCIM(cim){
  cim=String(cim||"").trim();
  return (Array.isArray(CFG.irmaos)?CFG.irmaos:[]).find(i => String(i.cim||"").trim()===cim);
}

function markInvalid(el){ el.classList.add("shake"); setTimeout(()=>el.classList.remove("shake"), 500); }

async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); toast("Copiado ‚úÖ"); }
  catch(_){
    const ta=document.createElement("textarea");
    ta.value=txt; ta.style.position="fixed"; ta.style.left="-9999px";
    document.body.appendChild(ta); ta.focus(); ta.select();
    try{ document.execCommand("copy"); toast("Copiado ‚úÖ"); } catch(__){ toast("N√£o foi poss√≠vel copiar"); }
    document.body.removeChild(ta);
  }
}

/* PIX Copia e Cola (EMV/BR Code) */
function emv(id, value){
  const v = String(value ?? "");
  return String(id).padStart(2,"0") + String(v.length).padStart(2,"0") + v;
}
function crc16(payload){
  let crc = 0xFFFF;
  for (let i = 0; i < payload.length; i++){
    crc ^= payload.charCodeAt(i) << 8;
    for (let j = 0; j < 8; j++){
      if ((crc & 0x8000) !== 0) crc = ((crc << 1) ^ 0x1021) & 0xFFFF;
      else crc = (crc << 1) & 0xFFFF;
    }
  }
  return crc.toString(16).toUpperCase().padStart(4, "0");
}
function sanitizePixText(s, max){
  return String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^A-Za-z0-9 .-]/g,"").trim().slice(0, max);
}
function buildPixCopiaECola(key, amount, merchantName="AGAPE", merchantCity="BRASIL", txid="AGAPE"){
  const gui = emv("00", "br.gov.bcb.pix");
  const k = emv("01", String(key||"").trim());
  const mai = emv("26", gui + k);

  const payloadNoCrc =
    emv("00","01") +
    emv("01","12") +
    mai +
    emv("52","0000") +
    emv("53","986") +
    emv("54", Number(amount||0).toFixed(2)) +
    emv("58","BR") +
    emv("59", sanitizePixText(merchantName, 25)) +
    emv("60", sanitizePixText(merchantCity, 15)) +
    emv("62", emv("05", String(txid||"AGAPE").slice(0,25))) +
    "6304";

  return payloadNoCrc + crc16(payloadNoCrc);
}

function goToConsumo(){
  const u=getUser();
  $("#consUser").textContent = u?.nome ? `Meu Consumo ‚Äî Irm√£o ${u.nome}` : "Meu consumo";
  renderProducts();
  showScreen("scr_consumo","forward");
}

function buildPayScreen(){
  payReady = false;
  setTimeout(()=>{ payReady = true; }, 350);

  const total = updateTotal(false);
  LAST_PAY_TOTAL = total;

  const cart = getCart();
  const produtos=Array.isArray(CFG.produtos)?CFG.produtos:[];
  const items = [];
  for(const p of produtos){
    const q = Number(cart[p.id]||0);
    if(q>0){
      items.push({nome:p.nome, q, preco:Number(p.preco||0), subtotal:q*Number(p.preco||0)});
    }
  }
  LAST_PAY_ITEMS = items;

  const list = document.getElementById("payItems");
  if(list){
    list.innerHTML = "";
    items.forEach(it=>{
      const row = document.createElement("div");
      row.style.display="flex";
      row.style.alignItems="center";
      row.style.justifyContent="space-between";
      row.style.gap="10px";
      row.style.padding="10px 12px";
      row.style.borderRadius="14px";
      row.style.background="rgba(255,255,255,.05)";
      row.style.border="1px solid rgba(255,255,255,.10)";
      row.innerHTML = `<div style="font-weight:900;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${it.q}√ó ${it.nome}</div>
                       <div style="font-weight:1000;white-space:nowrap;">${fmtBRL(it.subtotal)}</div>`;
      list.appendChild(row);
    });
  }

  $("#payTotal").textContent = fmtBRL(total);

  const u=getUser();
  $("#payUser").textContent = u?.nome ? `Irm√£o ${u.nome}` : "‚Äî";

  // garantir overlay/modal fechados
  closePixModal();
  hidePaySuccess();
}

function openPixModal(){
  // N√ÉO sobrescrever pixChaveModal aqui. S√≥ abrir.
  const modal = document.getElementById("pixModal");
  if(modal) modal.classList.remove("hidden");
}
function closePixModal(){
  const modal = document.getElementById("pixModal");
  if(modal) modal.classList.add("hidden");
}

function showPaySuccess(){
  // force theme color / full yellow
  const meta = document.querySelector('meta[name="theme-color"]');
  if(meta) meta.setAttribute("content", "#f0d51a");
  document.documentElement.style.background = "#f0d51a";
  document.body.style.background = "#f0d51a";

  const el = document.getElementById("paySuccess");
  if(el) el.classList.remove("hidden");
}
function hidePaySuccess(){
  const el = document.getElementById("paySuccess");
  if(el) el.classList.add("hidden");

  const meta = document.querySelector('meta[name="theme-color"]');
  if(meta) meta.setAttribute("content", "#071a2b");
  document.documentElement.style.background = "";
  document.body.style.background = "";
}

function playCoin(){
  try{
    const a = new Audio("./assets/coin.mp3");
    a.volume = 0.9;
    a.play().catch(()=>{});
  }catch(_){}
}

function finalizePayment(label){
  if(!payReady) return;

  closePixModal();
  showPaySuccess();
  playCoin();

  // zera carrinho
  clearCart();
  updateTotal(false);

  // espera um ciclo do gif e volta
  setTimeout(()=>{
    hidePaySuccess();
    clearUser();
    $("#inpCIM").value="";
    showScreen("scr_login","back");
    toast(label + " ‚úÖ");
  }, 2200);
}

async function boot(){
  if("serviceWorker" in navigator){
    try{ await navigator.serviceWorker.register("./service-worker.js"); }catch(_){}
  }

  CFG = await loadConfig();
  applyBrand();

  // Splash: 0 (impercept√≠vel) -> 1 r√°pido -> 2 zoom -> wait/login
  setTimeout(()=>showScreen("scr_splash1","forward"), 120);
  setTimeout(()=>showScreen("scr_splash2","forward"), 220);
  const tSplash2 = 3000;

  setTimeout(async ()=>{
    CFG = await loadConfig();
    applyBrand();
    if(sessionIsOpen()){
      showScreen("scr_login","forward");
    }else{
      showScreen("scr_wait","forward");
    }
  }, 220 + tSplash2 + 250);

  // exit app
  $("#btnExitApp")?.addEventListener("click", ()=>{
    // alguns PWA n√£o permitem fechar. fallback: abre blank
    try{ window.close(); }catch(_){}
    setTimeout(()=>{ location.href="about:blank"; }, 150);
  });

  // login
  $("#btnEntrar").addEventListener("click", async ()=>{
    const cim=$("#inpCIM").value;
    if(!cim.trim()){ markInvalid($("#inpCIM")); toast("Digite o CIM"); return; }

    CFG = await loadConfig();
    applyBrand();

    const irmao=findIrmaoByCIM(cim);
    if(!irmao){ markInvalid($("#inpCIM")); toast("CIM inv√°lido"); return; }

    setUser({nome:irmao.nome});
    if(!sessionIsOpen()){
      toast("Sess√£o fechada (tesoureiro precisa abrir)");
      showScreen("scr_wait","forward");
      return;
    }
    goToConsumo();
  });

  // qty +/-
  document.addEventListener("click",(e)=>{
    const btn=e.target.closest(".qtyBtn");
    if(!btn) return;
    const id=btn.getAttribute("data-id");
    const act=btn.getAttribute("data-act");
    const cart=getCart();
    const cur=Number(cart[id]||0);
    cart[id]= act==="inc" ? cur+1 : Math.max(0, cur-1);
    setCart(cart);
    const el=document.getElementById("qty_"+id); if(el) el.textContent=String(cart[id]);
    updateTotal(true);
  });

  // fechar e pagar
  $("#btnFechar").addEventListener("click", ()=>{
    const total=updateTotal(false);
    if(total<=0){ toast("Selecione ao menos 1 item"); return; }
    buildPayScreen();
    showScreen("scr_pagamento","forward");
  });

  $("#btnVoltar").addEventListener("click", ()=>showScreen("scr_consumo","back"));

  $("#btnSair").addEventListener("click", ()=>{
    clearCart();
    // mant√©m usu√°rio? aqui sai completo
    clearUser();
    $("#inpCIM").value="";
    showScreen("scr_login","back");
    toast("Saiu");
  });

  // pagamentos
  $("#btnPix").addEventListener("click", ()=>{
    if(!payReady) return;
    const total = (LAST_PAY_TOTAL && LAST_PAY_TOTAL>0) ? LAST_PAY_TOTAL : updateTotal(false);
    const key = (CFG?.loja?.pix_chave || "").trim();
    if(!key){ toast("Chave Pix n√£o configurada"); return; }

    const payload = buildPixCopiaECola(
      key,
      total,
      CFG?.loja?.nome || "AGAPE",
      (CFG?.loja?.pix_cidade || "BRASIL"),
      "AGAPE"
    );

    document.getElementById("pixValor").textContent = fmtBRL(total);
    document.getElementById("pixChaveModal").textContent = payload || "‚Äî";

    openPixModal();
  });

  $("#btnDinheiro").addEventListener("click", ()=>{ if(!payReady) return; finalizePayment("Registrado: dinheiro"); });
  $("#btnProxima").addEventListener("click", ()=>{ if(!payReady) return; finalizePayment("Registrado: pr√≥xima sess√£o"); });

  // modal pix
  $("#btnCopyPix")?.addEventListener("click", ()=>{
    const chave = (document.getElementById("pixChaveModal")?.textContent || "").trim();
    if(!chave || chave==="‚Äî"){ toast("C√≥digo Pix vazio"); return; }
    copyText(chave);
    toast("Pix Copia e Cola copiado ‚úÖ");
  });

  const closeBtns = ["btnPixCancel","btnPixCancel2"];
  closeBtns.forEach(id=>{
    const b = document.getElementById(id);
    if(b) b.addEventListener("click", closePixModal);
  });

  $("#btnPixOk")?.addEventListener("click", ()=>{ if(!payReady) return; finalizePayment("Registrado: pix"); });
}
boot();
</script>
</body>
</html>
