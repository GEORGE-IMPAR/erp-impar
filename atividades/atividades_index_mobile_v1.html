<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ERP √çMPAR ‚Äî Atividade do Dia</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root{
      --bg1:#0b1e4a; --bg2:#0e3b6e; --bg3:#0f766e;
      --panel: rgba(2,6,23,.66);
      --panel2: rgba(2,6,23,.78);
      --border: rgba(148,163,184,.45);
      --text: #e5e7eb; --soft: rgba(229,231,235,.78);
      --blue:#3b82f6; --green:#22c55e; --red:#ef4444;
      --radius:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background:linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3));
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 14px 22px;}

    /* Top bar */
    .top{display:flex;gap:12px;align-items:stretch;flex-wrap:wrap;}
    .brand{
      flex:1 1 280px;
      border-radius:var(--radius);
      border:1px solid rgba(148,163,184,.6);
      background:linear-gradient(120deg, rgba(2,6,23,.78), rgba(2,6,23,.35));
      box-shadow:0 18px 60px rgba(0,0,0,.35);
      padding:12px 14px;
      display:flex;align-items:center;gap:12px;
    }
    .orb{width:36px;height:36px;border-radius:999px;flex:0 0 auto;
      background:conic-gradient(from 210deg,#22c55e,#06b6d4,#3b82f6,#a855f7,#f97316,#22c55e);
      box-shadow:0 10px 22px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.18) inset;
    }
    .brand h1{font-size:16px;font-weight:900;line-height:1.05}
    .brand p{font-size:12px;opacity:.75;margin-top:2px}

    .usercard{
      flex:0 1 340px;
      min-width:260px;
      border-radius:var(--radius);
      border:2px solid rgba(34,197,94,.45);
      background:linear-gradient(120deg, rgba(2,6,23,.78), rgba(2,6,23,.35));
      box-shadow:0 18px 60px rgba(0,0,0,.35);
      padding:12px 14px;
      display:flex;justify-content:space-between;align-items:center;gap:12px;
    }
    .user-meta .k{font-size:11px;letter-spacing:.12em;text-transform:uppercase;color:rgba(156,163,175,.92);font-weight:800}
    .user-meta .v{margin-top:2px;font-size:12px;color:#cfd8ff;font-weight:800;line-height:1.25}
    .user-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    /* Layout grid */
    .grid{margin-top:12px;display:grid;grid-template-columns: 1fr 340px;gap:12px;align-items:start;}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
    }

    .panel{
      border-radius:var(--radius);
      border:1px solid rgba(148,163,184,.6);
      background:linear-gradient(120deg, rgba(2,6,23,.78), rgba(2,6,23,.30));
      box-shadow:0 18px 60px rgba(0,0,0,.25);
      padding:14px;
    }
    .panel h2{font-size:14px;font-weight:900;margin-bottom:8px}
    .panel .hint{font-size:12px;opacity:.8;line-height:1.25}

    /* Cards list */
    .cards{display:flex;flex-direction:column;gap:10px;}
    .card{
      border-radius:16px;
      border:1px solid rgba(148,163,184,.55);
      background:rgba(2,6,23,.55);
      padding:12px;
      box-shadow:0 14px 40px rgba(0,0,0,.25);
    }
    .card-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .chip{font-size:11px;padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.35);background:rgba(15,23,42,.70);color:rgba(229,231,235,.9);font-weight:800;}
    .remove{
      border:none;cursor:pointer;
      border-radius:12px;
      padding:8px 10px;
      background:rgba(239,68,68,.12);
      color:#fecaca;
      border:1px solid rgba(239,68,68,.35);
      font-weight:900;
    }
    .remove:hover{filter:brightness(1.06)}

    .form{display:grid;grid-template-columns: 1.2fr 1fr;gap:10px;}
    @media (max-width: 680px){
      .form{grid-template-columns:1fr;}
    }
    label{font-size:11px;letter-spacing:.08em;text-transform:uppercase;opacity:.85;font-weight:900;display:block;margin:0 0 6px 2px;}
    select,input,textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.55);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:44px;resize:vertical}
    select:focus,input:focus,textarea:focus{border-color:rgba(59,130,246,.75);box-shadow:0 0 0 3px rgba(59,130,246,.18)}
    .input-error{border-color:rgba(239,68,68,.9)!important;box-shadow:0 0 0 3px rgba(239,68,68,.16)!important;animation:shake .28s ease-in-out 0s 2}
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-3px)}50%{transform:translateX(3px)}75%{transform:translateX(-2px)}100%{transform:translateX(0)}}

    .row-full{grid-column:1 / -1;}

    /* Bottom actions */
    .actions{
      margin-top:12px;
      display:flex;gap:10px;flex-wrap:wrap;
      justify-content:space-between;align-items:center;
    }
    .btn{
      border:none;cursor:pointer;
      padding:11px 14px;
      border-radius:999px;
      font-weight:900;
      letter-spacing:.02em;
      display:flex;gap:8px;align-items:center;justify-content:center;
      min-width:160px;
    }
    .btn.secondary{background:rgba(2,6,23,.65);border:1px solid rgba(148,163,184,.45);color:rgba(229,231,235,.95)}
    .btn.secondary:hover{filter:brightness(1.08)}
    .btn.green{background:linear-gradient(135deg,#22c55e,#16a34a);color:#04130a;box-shadow:0 14px 30px rgba(22,163,74,.28)}
    .btn.green:hover{filter:brightness(1.05)}
    .btn.blue{background:linear-gradient(135deg,#60a5fa,#3b82f6);color:#06162b;box-shadow:0 14px 30px rgba(59,130,246,.25)}
    .btn.red{background:linear-gradient(135deg,#fb7185,#ef4444);color:#22040a;box-shadow:0 14px 30px rgba(239,68,68,.22)}

    /* History */
    .hist{display:flex;flex-direction:column;gap:10px;}
    .hist-item{border-radius:14px;border:1px solid rgba(148,163,184,.35);background:rgba(2,6,23,.55);padding:10px;cursor:pointer;}
    .hist-item:hover{filter:brightness(1.08)}
    .hist-item .t{font-weight:900;font-size:12px}
    .hist-item .s{font-size:11px;opacity:.8;margin-top:2px;line-height:1.25}

    /* Multi-select (simple) */
    .ms{position:relative}
    .ms-display{min-height:42px;display:flex;flex-wrap:wrap;gap:6px;align-items:center;padding:8px 10px;border-radius:14px;border:1px solid rgba(148,163,184,.35);background:rgba(2,6,23,.55);cursor:pointer;}
    .ms-tag{font-size:11px;padding:6px 10px;border-radius:999px;background:rgba(59,130,246,.16);border:1px solid rgba(59,130,246,.35);font-weight:900}
    .ms-ph{font-size:12px;opacity:.75}
    .ms-pop{position:absolute;z-index:20;left:0;right:0;top:calc(100% + 8px);border-radius:16px;border:1px solid rgba(148,163,184,.35);background:rgba(2,6,23,.95);box-shadow:0 24px 60px rgba(0,0,0,.55);padding:10px;display:none;}
    .ms.open .ms-pop{display:block}
    .ms-pop input{margin-bottom:8px}
    .ms-list{max-height:220px;overflow:auto;display:flex;flex-direction:column;gap:6px}
    .ms-opt{display:flex;gap:8px;align-items:center;font-size:12px;padding:8px 10px;border-radius:12px;border:1px solid rgba(148,163,184,.18);background:rgba(15,23,42,.55)}
    .ms-opt:hover{filter:brightness(1.06)}

    footer{padding:12px 14px;max-width:1200px;margin:0 auto;color:rgba(229,231,235,.65);font-size:11px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="orb"></div>
        <div>
          <h1>ERP √çMPAR</h1>
          <p>Atividade do Dia ‚Ä¢ Matinal ‚Üí Campo ‚Üí Fechamento</p>
        </div>
      </div>
      <div class="usercard">
        <div class="user-meta">
          <div class="k">Logado como</div>
          <div class="v"><span id="userName">Usu√°rio</span><br><span id="userEmail">‚Äî</span></div>
        </div>
        <div class="user-actions">
          <button class="btn secondary" id="btnMenu" type="button">üè† Menu</button>
          <button class="btn secondary" id="btnReload" type="button">üîÑ Atualizar</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <section class="panel">
        <h2>Aloca√ß√µes do dia</h2>
        <div class="hint">Monte o plano do dia (matinal). No fechamento, informe % e motivo quando &lt; 100%.</div>
        <div style="height:10px"></div>

        <div class="cards" id="cards"></div>

        <div class="actions">
          <button class="btn secondary" id="btnAdd" type="button">‚ûï Adicionar aloca√ß√£o</button>
          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn blue" id="btnPDF" type="button">üñ®Ô∏è Gerar PDF</button>
            <button class="btn green" id="btnFinalize" type="button">‚úÖ Finalizar dia</button>
            <button class="btn secondary" id="btnNewDay" type="button">üóìÔ∏è Novo dia</button>
          </div>
        </div>
      </section>

      <aside class="panel">
        <h2>Hist√≥rico (servidor)</h2>
        <div class="hint">Finalizados salvos no KingHost (API).</div>
        <div style="height:10px"></div>
        <div class="hist" id="hist"></div>

        <div style="height:14px"></div>
        <h2>Inbox do campo (autom√°tico)</h2>
        <div class="hint">Aqui entram mensagens/fotos vindas do WhatsApp via agente (webhook). A tela s√≥ consome.</div>
        <div style="height:10px"></div>
        <div class="hist" id="inbox"></div>
      </aside>
    </div>
  </div>

  <footer>
    <div>¬© 2026 ERP √çMPAR</div>
    <div>Atividades v1 (mobile-first) ‚Ä¢ mant√©m padr√£o √çMPAR</div>
  </footer>

  <script>
  // ===============================
  // 0) Fix de origem (www vs sem www)
  // ===============================
  (function enforceHost(){
    // se voc√™ quiser for√ßar www, descomente:
    // if(location.hostname === 'erpimpar.com.br') location.replace('https://www.erpimpar.com.br' + location.pathname + location.search + location.hash);
  })();

  // ===============================
  // 1) Sess√£o SSO (n√£o depende de ‚Äúm√°quina‚Äù, depende do DOM√çNIO)
  // ===============================
  const SESSION_KEYS = ["ERPIMPAR_USER","usuarioLogado","impar_user","erp_user"]; // ordem de prefer√™ncia
  function readSession(){
    for(const k of SESSION_KEYS){
      const raw = localStorage.getItem(k) || sessionStorage.getItem(k);
      if(!raw) continue;
      try {
        const obj = JSON.parse(raw);
        if(obj && typeof obj === 'object') return obj;
      } catch(e){}
    }
    return null;
  }
  function getUser(){
    const u = readSession();
    if(!u) return { nome:"Usu√°rio", email:"" };
    return {
      nome: String(u.Nome || u.nome || u.name || u.displayName || 'Usu√°rio').trim() || 'Usu√°rio',
      email: String(u.Email || u.email || u.mail || '').trim()
    };
  }
  function paintUser(){
    const u = getUser();
    document.getElementById('userName').textContent = u.nome || 'Usu√°rio';
    document.getElementById('userEmail').textContent = u.email || '‚Äî';
  }
  paintUser();

  // ===============================
  // 2) Dados (vers√£o demo: hardcoded como no Titan√™s)
  // ===============================
  const LIST_NOME = ["CARLOS HENRIQUE","CRISTIANO","FABIO","GLAICON","HENRIQUE","IBRAIS","MARCOS ANTONIO","NERI","RODRIGO","SELO","SILVIO","VALDECI"];
  const LIST_OBRA = ["FALTA","F√âRIAS","EMPRESA","AEMFLO","ASTEL","AUDIT√ìRIO HOSPITAL NOSSA SENHORA DE F√ÅTIMA","BIOS","BRAND√ÉO E COSTA ADVOGADOS","CASA CACUP√â","CASA GRANDE","CASSOL","CASSOL FRENTE DE CAIXA","COMBO FORQUILINHA","CONTATO","CORPORATE 8","CORTE","FENAC","FIESC","FORUM ARAQUARI","FUSION","FUSO HOTEL","GIASSI ARARANGUA","GIASSI TUBAR√ÉO","HOSPITAL NOSSA SENHORA DE F√ÅTIMA","HOSPITAL SANTA TEREZINHA","HOSPITAL S√ÉO CAMILO","HOSPITAL S√ÉO JOSE","HOSPITAL S√ÉO SEBASTI√ÉO","HOTEL FUSO","IMPACT HUB","MELEIRO","RES. CARL HOEPCKE","RESIDENCIAL JOAO LOHN","S√ÉO LUDGERO","SHOPPING PALADIUM","SOS AMBULAT√ìRIO","SOS CAF√â","SOS CLINICA RITMO","SOS ONCOLOGIA","TREZE DE MAIO","UNIDADE BASICA DE SAUDE ENCONTA DO SOL","CLINICA ARTISTi","S√ÉO BRAZ S√ÉO CAMILO","PATIO MILANO","CLINICA RITMO","CASA DO SEU THOMAZ DA FECEL","HOSPITAL 13 DE MAIO","FUSION"];
  const LIST_CARRO = ["RXO8A58","RXL6H17","IZH2A86","MJM3616","QIQ3921","QHQ8009","QII5E96","QIE6I52","QJO3249","SXK2D27","RYI3G63"];
  const LIST_PERC = ["0%","25%","50%","75%","100%"];

  // ===============================
  // 3) API (servidor)
  // ===============================
  const API_BASE = "https://api.erpimpar.com.br/atividades";
  const API = {
    save:  API_BASE + "/save.php",
    list:  API_BASE + "/list.php",
    get:   API_BASE + "/get.php",
    inboxList: API_BASE + "/inbox_list.php" // (vamos criar depois)
  };

  // ===============================
  // 4) Util
  // ===============================
  function swalBase(){
    return {
      background:"#0b1220",
      color:"#e5e7eb",
      confirmButtonColor:"#22c55e",
      cancelButtonColor:"#334155"
    };
  }
  async function withProcessing(fn, title="Processando‚Ä¶", text="PROCESSANDO DADOS......", minMs=600){
    const t0 = Date.now();
    if(window.Swal){
      Swal.fire(Object.assign(swalBase(),{
        title, text,
        allowOutsideClick:false,
        allowEscapeKey:false,
        didOpen:()=>Swal.showLoading()
      }));
    }
    try{ return await fn(); }
    finally{
      const dt = Date.now()-t0;
      if(dt < minMs) await new Promise(r=>setTimeout(r, minMs-dt));
      if(window.Swal) Swal.close();
    }
  }
  function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }
  function optList(arr, ph){ const o=[`<option value="">${escapeHtml(ph)}</option>`]; arr.forEach(v=>o.push(`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`)); return o.join(""); }
  function pctToNumber(p){ if(!p) return null; const n=parseInt(String(p).replace("%","").trim(),10); return Number.isFinite(n)?n:null; }
  function todayKey(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }

  // ===============================
  // 5) Multi-select
  // ===============================
  function buildMultiSelect(selected, onChange){
    const state = { selected: Array.isArray(selected) ? [...selected] : [], open:false };
    const root = document.createElement('div');
    root.className = 'ms';
    const display = document.createElement('div');
    display.className = 'ms-display';
    const pop = document.createElement('div');
    pop.className = 'ms-pop';
    const search = document.createElement('input');
    search.type = 'text';
    search.placeholder = 'Pesquisar‚Ä¶';
    const list = document.createElement('div');
    list.className = 'ms-list';

    function renderDisplay(){
      display.innerHTML = '';
      if(state.selected.length===0){
        const ph = document.createElement('span');
        ph.className='ms-ph';
        ph.textContent='Selecione nome(s)‚Ä¶';
        display.appendChild(ph);
      } else {
        state.selected.forEach(n=>{
          const t=document.createElement('span');
          t.className='ms-tag';
          t.textContent=n;
          display.appendChild(t);
        });
      }
    }

    function renderList(filter=''){
      list.innerHTML='';
      const f = filter.trim().toLowerCase();
      LIST_NOME.filter(n => !f || n.toLowerCase().includes(f)).forEach(n=>{
        const row=document.createElement('label');
        row.className='ms-opt';
        const cb=document.createElement('input');
        cb.type='checkbox';
        cb.checked=state.selected.includes(n);
        cb.addEventListener('change',()=>{
          if(cb.checked){ if(!state.selected.includes(n)) state.selected.push(n); }
          else{ state.selected = state.selected.filter(x=>x!==n); }
          renderDisplay();
          if(typeof onChange==='function') onChange([...state.selected]);
        });
        const sp=document.createElement('span');
        sp.textContent=n;
        row.appendChild(cb);
        row.appendChild(sp);
        list.appendChild(row);
      });
    }

    function setOpen(v){
      state.open = v;
      root.classList.toggle('open', v);
      if(v){ search.focus(); renderList(search.value); }
    }

    display.addEventListener('click',()=> setOpen(!state.open));
    document.addEventListener('click',(e)=>{ if(!root.contains(e.target)) setOpen(false); });
    search.addEventListener('input',()=> renderList(search.value));

    renderDisplay();
    renderList('');
    pop.appendChild(search);
    pop.appendChild(list);
    root.appendChild(display);
    root.appendChild(pop);
    root.getValue = ()=> [...state.selected];
    root.setValue = (arr)=>{ state.selected = Array.isArray(arr)?[...arr]:[]; renderDisplay(); renderList(search.value); };
    return root;
  }

  // ===============================
  // 6) Estado + render
  // ===============================
  const cardsEl = document.getElementById('cards');
  let rows = [];
  const state = {
    dayKey: todayKey(),
    finalized: false,
  };

  function makeRow(pref={}){
    const r = {
      id: pref.id || ("r_"+Math.random().toString(16).slice(2)+Date.now().toString(16)),
      data: pref.data || state.dayKey,
      nomes: Array.isArray(pref.nomes)?pref.nomes:[],
      obra: pref.obra || '',
      carro: pref.carro || '',
      atividade: pref.atividade || '',
      percentual: pref.percentual || '',
      motivo: pref.motivo || ''
    };
    return r;
  }

  function setError(el,on){ if(!el) return; on?el.classList.add('input-error'):el.classList.remove('input-error'); }

  function validateRow(dom, mode){
    const nomes = dom._ms.getValue();
    const obra = dom.querySelector('[data-f="obra"]').value.trim();
    const carro = dom.querySelector('[data-f="carro"]').value.trim();
    const atividade = dom.querySelector('[data-f="atividade"]').value.trim();
    const perc = dom.querySelector('[data-f="percentual"]').value.trim();
    const motivo = dom.querySelector('[data-f="motivo"]').value.trim();

    const err = {
      nomes: nomes.length===0,
      obra: !obra,
      carro: !carro,
      atividade: !atividade,
      percentual: mode==='final' ? !perc : false,
      motivo: mode==='final' ? (pctToNumber(perc) !== null && pctToNumber(perc) < 100 && !motivo) : false,
    };

    setError(dom.querySelector('[data-box="nomes"]'), err.nomes);
    setError(dom.querySelector('[data-f="obra"]'), err.obra);
    setError(dom.querySelector('[data-f="carro"]'), err.carro);
    setError(dom.querySelector('[data-f="atividade"]'), err.atividade);
    setError(dom.querySelector('[data-f="percentual"]'), err.percentual);
    setError(dom.querySelector('[data-f="motivo"]'), err.motivo);

    return !Object.values(err).some(Boolean);
  }

  function rowToData(dom){
    return {
      data: state.dayKey,
      nomes: dom._ms.getValue(),
      obra: dom.querySelector('[data-f="obra"]').value.trim(),
      carro: dom.querySelector('[data-f="carro"]').value.trim(),
      atividade: dom.querySelector('[data-f="atividade"]').value.trim(),
      percentual: dom.querySelector('[data-f="percentual"]').value.trim(),
      motivo: dom.querySelector('[data-f="motivo"]').value.trim(),
    };
  }

  function render(){
    cardsEl.innerHTML='';
    rows.forEach((r, idx)=>{
      const card=document.createElement('div');
      card.className='card';
      card.dataset.id=r.id;

      const head=document.createElement('div');
      head.className='card-head';
      const left=document.createElement('div');
      left.style.display='flex';
      left.style.gap='8px';
      left.style.flexWrap='wrap';
      const c1=document.createElement('div'); c1.className='chip'; c1.textContent=`Aloca√ß√£o ${idx+1}`;
      const c2=document.createElement('div'); c2.className='chip'; c2.textContent=state.dayKey;
      left.appendChild(c1); left.appendChild(c2);
      const del=document.createElement('button');
      del.className='remove';
      del.type='button';
      del.textContent='Remover';
      del.addEventListener('click',()=>{
        rows = rows.filter(x=>x.id!==r.id);
        render();
      });
      head.appendChild(left);
      head.appendChild(del);

      const form=document.createElement('div');
      form.className='form';

      // nomes
      const nomesBox=document.createElement('div');
      nomesBox.className='row-full';
      const ln=document.createElement('label'); ln.textContent='Nome(s)';
      const ms=buildMultiSelect(r.nomes, ()=>{});
      ms.dataset.box='nomes';
      nomesBox.appendChild(ln);
      nomesBox.appendChild(ms);
      nomesBox.dataset.box='nomes';

      // obra
      const obraBox=document.createElement('div');
      const lo=document.createElement('label'); lo.textContent='Obra';
      const obra=document.createElement('select');
      obra.dataset.f='obra';
      obra.innerHTML = optList(LIST_OBRA, 'Selecione a obra‚Ä¶');
      obra.value = r.obra;
      obraBox.appendChild(lo);
      obraBox.appendChild(obra);

      // carro
      const carroBox=document.createElement('div');
      const lc=document.createElement('label'); lc.textContent='Carro';
      const carro=document.createElement('select');
      carro.dataset.f='carro';
      carro.innerHTML = optList(LIST_CARRO, 'Selecione o carro‚Ä¶');
      carro.value = r.carro;
      carroBox.appendChild(lc);
      carroBox.appendChild(carro);

      // atividade
      const atvBox=document.createElement('div');
      atvBox.className='row-full';
      const la=document.createElement('label'); la.textContent='Atividade do dia (o que ser√° feito)';
      const atv=document.createElement('textarea');
      atv.dataset.f='atividade';
      atv.placeholder='Descreva o que ser√° feito hoje‚Ä¶';
      atv.value = r.atividade;
      atvBox.appendChild(la);
      atvBox.appendChild(atv);

      // percentual
      const pctBox=document.createElement('div');
      const lp=document.createElement('label'); lp.textContent='Percentual';
      const pct=document.createElement('select');
      pct.dataset.f='percentual';
      pct.innerHTML = optList(LIST_PERC, 'Selecione‚Ä¶');
      pct.value = r.percentual;
      pctBox.appendChild(lp);
      pctBox.appendChild(pct);

      // motivo
      const motBox=document.createElement('div');
      const lm=document.createElement('label'); lm.textContent='Motivo (se < 100%)';
      const mot=document.createElement('input');
      mot.dataset.f='motivo';
      mot.placeholder='Explique por que n√£o concluiu‚Ä¶';
      mot.value = r.motivo;
      motBox.appendChild(lm);
      motBox.appendChild(mot);

      form.appendChild(nomesBox);
      form.appendChild(obraBox);
      form.appendChild(carroBox);
      form.appendChild(atvBox);
      form.appendChild(pctBox);
      form.appendChild(motBox);

      card.appendChild(head);
      card.appendChild(form);

      // store ref
      card._ms = ms;
      cardsEl.appendChild(card);
    });
  }

  function ensureOneRow(){
    if(rows.length===0){ rows.push(makeRow()); }
    render();
  }
  ensureOneRow();

  // ===============================
  // 7) PDF (janela simples)
  // ===============================
  function openPrint(payload){
    const rows = payload.rows || [];
    const user = payload.userName || 'Usu√°rio';
    const date = payload.dayKey || '';
    const generated = new Date().toLocaleString();

    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Atividades do Dia</title>
      <style>
        body{font-family:Arial,sans-serif;margin:18px;color:#111}
        h1{margin:0 0 6px 0;font-size:18px}
        .meta{font-size:12px;margin-bottom:10px;color:#333}
        table{width:100%;border-collapse:collapse;font-size:12px}
        th,td{border:1px solid #ccc;padding:8px;vertical-align:top}
        th{background:#f3f4f6;text-align:left}
      </style></head><body>
      <h1>ERP √çMPAR ‚Äî Atividades do Dia</h1>
      <div class="meta"><b>Data:</b> ${escapeHtml(date)} ‚Ä¢ <b>Gerado por:</b> ${escapeHtml(user)} ‚Ä¢ <b>Em:</b> ${escapeHtml(generated)}</div>
      <table>
        <thead><tr><th>Nome(s)</th><th>Obra</th><th>Carro</th><th>Atividade</th><th>%</th><th>Motivo</th></tr></thead>
        <tbody>
          ${rows.map(r=>`<tr>
            <td>${escapeHtml((r.nomes||[]).join(', '))}</td>
            <td>${escapeHtml(r.obra||'')}</td>
            <td>${escapeHtml(r.carro||'')}</td>
            <td>${escapeHtml(r.atividade||'')}</td>
            <td>${escapeHtml(r.percentual||'')}</td>
            <td>${escapeHtml(r.motivo||'')}</td>
          </tr>`).join('')}
        </tbody>
      </table>
      <script>window.print();</script>
      </body></html>`;
    const w = window.open('', '_blank');
    if(!w){
      alert('O navegador bloqueou o pop-up. Permita pop-ups para imprimir.');
      return;
    }
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  // ===============================
  // 8) Servidor: hist√≥rico + salvar
  // ===============================
  async function apiList(){
    const r = await fetch(API.list, { cache:'no-store' });
    return await r.json();
  }
  async function apiGet(id){
    const r = await fetch(API.get + '?id=' + encodeURIComponent(id), { cache:'no-store' });
    return await r.json();
  }
  async function apiSave(payload){
    const r = await fetch(API.save, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    return await r.json();
  }

  async function renderHistory(){
    const el = document.getElementById('hist');
    el.innerHTML = '<div class="hint">Carregando‚Ä¶</div>';
    try{
      const data = await apiList();
      if(!data || !data.ok){ el.innerHTML='<div class="hint">Sem hist√≥rico (API)</div>'; return; }
      const items = data.items || [];
      if(items.length===0){ el.innerHTML='<div class="hint">Nenhum dia finalizado ainda.</div>'; return; }
      el.innerHTML='';
      items.slice(0,10).forEach(it=>{
        const div=document.createElement('div');
        div.className='hist-item';
        const t=document.createElement('div');
        t.className='t';
        t.textContent = (it.dayKey || it.title || it.id || 'Dia');
        const s=document.createElement('div');
        s.className='s';
        s.textContent = `${it.userName || ''} ${it.userEmail?('‚Ä¢ '+it.userEmail):''}`;
        div.appendChild(t); div.appendChild(s);
        div.addEventListener('click', async()=>{
          await withProcessing(async()=>{
            const full = await apiGet(it.id);
            if(!full || !full.ok) throw new Error('Falha ao abrir');
            openPrint(full.data);
          }, 'Abrindo‚Ä¶');
        });
        el.appendChild(div);
      });
    } catch(e){
      el.innerHTML = '<div class="hint">Falha ao carregar hist√≥rico (API). Verifique CORS/permiss√£o.</div>';
    }
  }
  renderHistory();

  async function renderInbox(){
    const el = document.getElementById('inbox');
    el.innerHTML = '<div class="hint">Aguardando agente‚Ä¶</div>';
    try{
      const r = await fetch(API.inboxList + '?day=' + encodeURIComponent(state.dayKey), { cache:'no-store' });
      const data = await r.json();
      if(!data || !data.ok){ el.innerHTML='<div class="hint">(Inbox ainda n√£o habilitado)</div>'; return; }
      const items = data.items || [];
      if(items.length===0){ el.innerHTML='<div class="hint">Nenhuma entrada do campo ainda.</div>'; return; }
      el.innerHTML='';
      items.slice(0,8).forEach(it=>{
        const div=document.createElement('div');
        div.className='hist-item';
        div.innerHTML = `<div class="t">${escapeHtml(it.sender || 'Campo')}</div><div class="s">${escapeHtml(it.text || '')}</div>`;
        el.appendChild(div);
      });
    } catch(e){
      el.innerHTML = '<div class="hint">(Inbox ainda n√£o habilitado)</div>';
    }
  }
  setInterval(renderInbox, 15000);
  renderInbox();

  // ===============================
  // 9) Actions
  // ===============================
  document.getElementById('btnMenu').addEventListener('click', ()=> location.href = '/menu.html');
  document.getElementById('btnReload').addEventListener('click', ()=> location.reload());
  document.getElementById('btnAdd').addEventListener('click', ()=>{ rows.push(makeRow()); render(); });
  document.getElementById('btnNewDay').addEventListener('click', async()=>{
    const ok = await (window.Swal ? Swal.fire(Object.assign(swalBase(),{
      icon:'question', title:'Novo dia', text:'Isso limpa a tela (rascunho). Continuar?', showCancelButton:true, confirmButtonText:'Sim', cancelButtonText:'Cancelar'
    })) : Promise.resolve({isConfirmed: confirm('Novo dia?')}));
    if(!ok.isConfirmed) return;
    state.dayKey = todayKey();
    rows = [makeRow()];
    render();
    renderHistory();
  });

  document.getElementById('btnPDF').addEventListener('click', async()=>{
    const domRows = [...cardsEl.querySelectorAll('.card')];
    const valid = domRows.every(r=> validateRow(r,'draft'));
    if(!valid){
      if(window.Swal) Swal.fire(Object.assign(swalBase(),{icon:'warning',title:'Campos obrigat√≥rios',text:'Preencha os campos com borda vermelha para gerar o PDF.'}));
      else alert('Preencha os campos obrigat√≥rios.');
      return;
    }
    const payload = {
      schema:'ERPIMPAR_ATIVIDADES_V1',
      status:'draft',
      dayKey: state.dayKey,
      userName: getUser().nome,
      userEmail: getUser().email,
      rows: domRows.map(rowToData),
      generatedAt: new Date().toISOString()
    };
    openPrint(payload);
  });

  document.getElementById('btnFinalize').addEventListener('click', async()=>{
    const domRows = [...cardsEl.querySelectorAll('.card')];
    const valid = domRows.every(r=> validateRow(r,'final'));
    if(!valid){
      if(window.Swal) Swal.fire(Object.assign(swalBase(),{icon:'warning',title:'Valida√ß√£o',text:'Para finalizar: % obrigat√≥rio. Se < 100%, motivo obrigat√≥rio.'}));
      else alert('Valida√ß√£o: % e motivo (se <100%)');
      return;
    }
    const payload = {
      schema:'ERPIMPAR_ATIVIDADES_V1',
      status:'final',
      dayKey: state.dayKey,
      date: state.dayKey,
      userName: getUser().nome,
      userEmail: getUser().email,
      rows: domRows.map(rowToData),
      finalizedAt: new Date().toISOString()
    };
    payload.total = payload.rows.length;
    payload.pend = payload.rows.filter(r=>{
      const pct = pctToNumber(r.percentual);
      return pct !== null && pct < 100;
    }).length;

    await withProcessing(async()=>{
      const res = await apiSave(payload);
      if(!res || !res.ok) throw new Error('SAVE_FAILED');
      payload.id = res.id;
    }, 'Salvando‚Ä¶');

    if(window.Swal) await Swal.fire(Object.assign(swalBase(),{icon:'success',title:'Dia finalizado',text:'Salvo no servidor e enviado para o hist√≥rico.'}));
    renderHistory();
  });
  </script>
</body>
</html>
