<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ERP √çMPAR ‚Äî Lista de Atividades</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
/* FIX_BUILD: 2026-01-18 05:13:03 API:https://api.erpimpar.com.br/atividades CORS_FIX2 */

<style>
/* ===== RDO: visual √çMPAR (cards, hover, highlight) ===== */
#rdoLive{margin-top:16px;}
.rdo-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
  gap:12px;
  width:100%;
}
.rdo-card{
  background: linear-gradient(180deg, rgba(7,18,35,.88), rgba(8,28,55,.88));
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 14px;
  padding: 12px 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
  cursor: pointer;
  position: relative;
  overflow:hidden;
  transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}
.rdo-card:hover{
  transform: translateY(-2px);
  box-shadow: 0 14px 40px rgba(0,0,0,.32);
  border-color: rgba(34,197,94,.35);
}
.rdo-card .rdo-title{
  font-weight:800;
  letter-spacing:.2px;
  color: rgba(255,255,255,.92);
  font-size: 13px;
  margin-bottom: 6px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.rdo-chip{
  font-size:11px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  color: rgba(255,255,255,.80);
  background: rgba(255,255,255,.06);
  white-space:nowrap;
}
.rdo-card .rdo-sub{
  font-size:12px;
  color: rgba(255,255,255,.72);
  line-height: 1.25;
}
.rdo-card .rdo-meta{
  margin-top:8px;
  font-size:11px;
  color: rgba(255,255,255,.60);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.rdo-card.rdo-new{
  border-color: rgba(59,130,246,.85);
  box-shadow: 0 0 0 1px rgba(59,130,246,.55), 0 0 22px rgba(59,130,246,.45), 0 14px 40px rgba(0,0,0,.32);
}
.rdo-card.rdo-new::after{
  content:"";
  position:absolute; inset:-2px;
  background: radial-gradient(circle at 20% 10%, rgba(59,130,246,.35), transparent 50%),
              radial-gradient(circle at 80% 90%, rgba(6,182,212,.22), transparent 55%);
  opacity:.8;
  pointer-events:none;
  animation: rdoPulse 1.6s ease-in-out infinite;
}
@keyframes rdoPulse{ 0%,100%{opacity:.25} 50%{opacity:.85} }

/* ===== RDO Modal bonito ===== */
#rdoModal{position:fixed; inset:0; display:none; z-index:9999;}
#rdoModal.is-open{display:block;}
#rdoModal .backdrop{
  position:absolute; inset:0;
  background: rgba(2,8,20,.70);
  backdrop-filter: blur(8px);
  animation: fadeIn .18s ease-out;
}
#rdoModal .panel{
  position:absolute;
  left:50%; top:50%;
  transform: translate(-50%,-50%) scale(.98);
  width:min(920px, calc(100vw - 28px));
  max-height: min(80vh, 720px);
  background: linear-gradient(180deg, rgba(7,18,35,.96), rgba(8,28,55,.96));
  border:1px solid rgba(255,255,255,.12);
  border-radius: 18px;
  box-shadow: 0 18px 60px rgba(0,0,0,.55);
  overflow:hidden;
  animation: popIn .22s ease-out forwards;
}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes popIn{from{opacity:0; transform:translate(-50%,-50%) scale(.96)}to{opacity:1; transform:translate(-50%,-50%) scale(1)}}
#rdoModal .head{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding: 12px 14px;
  border-bottom: 1px solid rgba(255,255,255,.10);
}
#rdoModal .head .hleft{min-width:0}
#rdoModal .head .title{
  margin:0;
  font-weight:900;
  font-size: 14px;
  color: rgba(255,255,255,.92);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#rdoModal .head .sub{
  margin-top:3px;
  font-size: 12px;
  color: rgba(255,255,255,.68);
}
#rdoModal .head .actions{display:flex; gap:8px; align-items:center;}
#rdoModal .head .btn-x{
  border-radius: 12px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.85);
  padding: 8px 10px;
  cursor:pointer;
  transition: .15s ease;
}
#rdoModal .head .btn-x:hover{
  background: rgba(255,255,255,.10);
  border-color: rgba(59,130,246,.55);
}
#rdoModal .body{
  padding: 12px 14px 14px;
  max-height: calc(min(80vh, 720px) - 56px);
  overflow:auto;
}
.rdo-msg{
  display:grid;
  grid-template-columns: 68px 1fr;
  gap:10px;
  padding: 10px 10px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  margin-bottom: 10px;
}
.rdo-msg .t{
  font-size:12px;
  color: rgba(255,255,255,.70);
  font-weight:800;
  text-align:right;
}
.rdo-msg .c{
  font-size:13px;
  color: rgba(255,255,255,.86);
  line-height:1.35;
  white-space:pre-wrap;
  word-break:break-word;
}
@media (max-width:560px){
  .rdo-msg{grid-template-columns:1fr}
  .rdo-msg .t{text-align:left}
}
</style>

</head>
<body>
<!-- PAGE LOADER ‚Äî padr√£o ERP √çMPAR -->
<div id="pageLoader" class="hidden" aria-hidden="true">
  <div class="loader-card">
    <div class="loader-spin" aria-hidden="true"></div>
    <div>
      <div class="loader-title">Processando‚Ä¶</div>
      <div class="loader-sub">PROCESSANDO DADOS......</div>
    </div>
  </div>
</div>

<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo-orb" aria-hidden="true"></div>
      <div class="brand-text">
        <div class="brand-kicker">PLATAFORMA</div>
        <div class="brand-title">ERP √çMPAR</div>
        <div class="brand-sub module-sub">Lista de Atividades</div>
      </div>
    </div>
    <div class="tag-top">
      <button class="pill-btn" id="btnVoltarMenu" type="button"><span>üè†</span> Menu principal</button>
    </div>
  </div>
</header>

<main>
  <div class="layout">
    <div class="container">

      <div class="topbox">
        <div class="topbox-left">
          <div class="title">Atividades do Dia</div>
          <div class="user-label">Logado como</div>
          <div class="user-values">
            <strong id="userName">Usu√°rio</strong><br/>
            <span id="userEmail">‚Äî</span>
          </div>
        </div>

        <div class="topbox-center">
          <div class="code-line">Reuni√£o Matinal ‚Ä¢ PDF para impress√£o</div>
          <div class="sub-line">Gerar PDF exige todos alocados ‚Ä¢ Finalizar exige % e Motivo se &lt; 100%</div>
        </div>

        <div class="stepper-wrap">
          <div class="stepper" aria-label="Status">
            <div class="dot active" id="dotR" title="Rascunho">R</div>
            <div class="line active"></div>
            <div class="dot" id="dotF" title="Final">F</div>
          </div>
        </div>
      </div>

      <div class="hint">
        <b>Obrigat√≥rios (rascunho):</b> Data, Nome(s), Obra, Carro e Atividade do dia ‚Äî e <b>todos os nomes da escala precisam estar lan√ßados</b> (use Obra = <b>FALTA</b> ou <b>F√âRIAS</b> quando necess√°rio).<br/>
        <b>Final do dia:</b> Percentual obrigat√≥rio. Se Percentual &lt; 100%, Motivo obrigat√≥rio (vira pend√™ncia autom√°tica).
      </div>

      <div class="page-grid">
        <div>

          <div id="rows" class="rows"></div>

          <div class="actions">
            <button class="btn btn-secondary" id="btnAdd" type="button">‚ûï ADICIONAR LINHA</button>
            <button class="btn btn-primary" id="btnSave" type="button">üñ®Ô∏è GERAR PDF (IMPRIMIR)</button>
            <button class="btn btn-primary" id="btnFinalize" type="button">‚úÖ FINALIZAR (HIST√ìRICO)</button>
          <button class="btn btn-secondary" id="btnNewDay" type="button">üóìÔ∏è Novo dia</button>
          </div>

          <div class="hist card">
  <div class="hist-top">
    <div>
      <div class="title">Hist√≥rico (Finalizados)</div>
      <div class="hint">Clique no card para abrir o PDF do dia</div>
    </div>
    <input id="histDate" class="inp inp-date" type="date" placeholder="dd/mm/aaaa"/>
  </div>
  <div id="histList" class="hist-list" style="display:flex;flex-direction:column;gap:10px;"></div>
          </div>
        </div>

        <aside class="side">
          <div class="card">
            <div class="side-title">Escala do dia</div>
            <div style="color:var(--muted);font-size:12px;margin-bottom:10px;">Todos da lista precisam ter atividade lan√ßada.</div>
            <div id="nameList" class="name-list"></div>
            <div class="side-hint">
              <b>Formato do PDF:</b><br/>
              DATA ‚Ä¢ NOME ‚Ä¢ OBRA ‚Ä¢ CARRO ‚Ä¢ ATIVIDADES ‚Ä¢ PERCENTUAL ‚Ä¢ MOTIVO
            </div>
          </div>
        </aside>
      </div>

    
<section id="rdoLive" data-basepath="https://api.erpimpar.com.br/atividades/rdo" style="margin-top:16px;">
  <div class="card" style="margin-top:16px;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
      <div>
        <div class="title" style="margin:0;">RDO ao vivo</div>
        <div class="hint" style="margin:4px 0 0 0;">WhatsApp ‚Üí Grupos monitorados (somente texto). √öltimos 7 dias.</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div id="rdoStatus" style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);">
          <span style="width:10px;height:10px;border-radius:50%;background:#2bd27f;display:inline-block;"></span>
          <span>ok</span>
        </div>
        <button class="btn btn-secondary" id="btnRdoRefresh" type="button">‚ü≥ ATUALIZAR</button>
      </div>
    </div>

    <div style="margin-top:12px;">
      <div id="rdoGrid" class="rdo-grid"></div>
      <div id="rdoEmpty" style="display:none;color:var(--muted);font-size:12px;margin-top:10px;">Sem arquivos ainda (aguardando agente gravar os JSONs).</div>
    </div>
  </div>
</section>



</div>
  </div>



</main>

<footer>
  <div class="rodape-inner">
    <div>ERP √çMPAR ‚Ä¢ Lista de Atividades</div>
    <div>v6.1 ‚Ä¢ Draft: <b>ERPIMPAR_ATIVIDADES_DIARIAS_V2</b> ‚Ä¢ Pend√™ncias: <b>ERPIMPAR_PENDENCIAS_V1</b> ‚Ä¢ Hist√≥rico: <b>ERPIMPAR_ATIVIDADES_HIST_V1</b></div>
  </div>
</footer>


<div id="pdfModal" class="modal" style="display:none;">
  <div class="modal-backdrop"></div>
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title" id="pdfTitle">PDF</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="btnPdfPrint" type="button">üñ®Ô∏è Imprimir</button>
        <button class="btn btn-secondary" id="btnPdfClose" type="button">‚úñ Fechar</button>
      </div>
    </div>
    <div class="modal-body">
      <iframe id="pdfFrame" title="PDF" style="width:100%;height:72vh;border:0;border-radius:14px;background:white;"></iframe>
    </div>
  </div>
</div>

<script>
function showPageLoader(title, sub){
  const el=document.getElementById("pageLoader"); if(!el) return;
  el.querySelector(".loader-title").textContent = title || "Processando‚Ä¶";
  el.querySelector(".loader-sub").textContent = sub || "PROCESSANDO DADOS......";
  el.classList.remove("hidden"); el.setAttribute("aria-hidden","false");
}
function hidePageLoader(){
  const el=document.getElementById("pageLoader"); if(!el) return;
  el.classList.add("hidden"); el.setAttribute("aria-hidden","true");
}
const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
async function withProcessing(fn, title, sub, minMs=800){
  const t0=Date.now();
  showPageLoader(title||"Processando‚Ä¶", sub||"PROCESSANDO DADOS......");
  try{
    const res = await fn();
    const dt=Date.now()-t0;
    if(dt<minMs) await sleep(minMs-dt);
    return res;
  }finally{
    hidePageLoader();
  }
}

function swalBase(){
  return {
    customClass:{
      popup:"impar-swal",
      title:"impar-swal-title",
      htmlContainer:"impar-swal-text",
      confirmButton:"impar-swal-btn"
    },
    buttonsStyling:false,
    showClass:{ popup:"impar-swal-in" },
    hideClass:{ popup:"impar-swal-out" }
  };
}
function alertOk(msg){
  if(!window.Swal){ alert(msg); return; }
  return Swal.fire(Object.assign(swalBase(),{
    icon:"success",
    title:"Sucesso",
    text:msg,
    confirmButtonText:"OK"
  }));
}
function alertWarn(msg, title="Aten√ß√£o"){
  if(!window.Swal){ alert(msg); return; }
  return Swal.fire(Object.assign(swalBase(),{
    icon:"warning",
    title:title,
    text:msg,
    confirmButtonText:"OK"
  }));
}
function alertInfo(msg, title="Informa√ß√£o"){
  if(!window.Swal){ alert(msg); return; }
  return Swal.fire(Object.assign(swalBase(),{
    icon:"info",
    title:title,
    text:msg,
    confirmButtonText:"OK"
  }));
}
function alertErr(msg, title="Erro"){
  if(!window.Swal){ alert(msg); return; }
  return Swal.fire(Object.assign(swalBase(),{
    icon:"error",
    title:title,
    text:msg,
    confirmButtonText:"OK"
  }));
}




const KEY = "ERPIMPAR_USER";

function getSessaoERP(){
  const raw = localStorage.getItem(KEY) || sessionStorage.getItem(KEY);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}

function loadUser(){
  const u = getSessaoERP();

  if(!u){
    // sem sess√£o = volta pro login REAL do ERP
    window.location.href = "/index.html";
    return;
  }

  document.getElementById("userName").textContent  = (u.nome  || u.Nome  || "Usu√°rio");
  document.getElementById("userEmail").textContent = (u.email || u.Email || "‚Äî");
}

function getUser(){
  const u = getSessaoERP();
  if(!u) return { nome: "Usu√°rio", email: "" };

  return {
    nome:  String(u.nome  || u.Nome  || "Usu√°rio").trim(),
    email: String(u.email || u.Email || "").trim()
  };
}

loadUser();

const STORAGE_DRAFT = "ERPIMPAR_ATIVIDADES_DIARIAS_V2";
const STORAGE_PEND  = "ERPIMPAR_PENDENCIAS_V1";
const STORAGE_HIST  = "ERPIMPAR_ATIVIDADES_HIST_V1";

// ===== Integra√ß√£o com KingHost (PHP) ‚Äî salvar/listar/abrir =====
// Ajuste os caminhos abaixo se seus PHPs estiverem em outra pasta:
const API_SAVE = "https://api.erpimpar.com.br/atividades/save.php";
const API_LIST = "https://api.erpimpar.com.br/atividades/list.php";
const API_GET  = "https://api.erpimpar.com.br/atividades/get.php";

async function apiSave(payload){
  const r = await fetch(API_SAVE, {
    method: "POST",
    // CORS: request simples (sem preflight) ‚Äî manda JSON como text/plain
    headers: { "Content-Type":"text/plain;charset=UTF-8" },
    body: JSON.stringify(payload)
  });
  const j = await r.json().catch(()=>null);
  if(!r.ok || !j || j.ok !== true){
    const msg = (j && (j.error || j.message)) ? (j.error || j.message) : "Falha ao salvar no servidor.";
    throw new Error(msg);
  }
  // save.php pode devolver id; se n√£o devolver, mantemos o que j√° existe
  return j.id || j.data?.id || payload.id || null;
}

async function apiList(){
  const r = await fetch(API_LIST, { method:"GET" });
  const j = await r.json().catch(()=>null);
  if(!r.ok || !j || j.ok !== true) return [];
  const data = j.items || j.data || [];
  return Array.isArray(data) ? data : [];
}

async function apiGet(id){
  const url = API_GET + "?id=" + encodeURIComponent(id);
  const r = await fetch(url, { method:"GET" });
  const j = await r.json().catch(()=>null);
  if(!r.ok || !j || j.ok !== true) throw new Error((j && (j.error||j.message)) || "Falha ao abrir no servidor.");
  return j.data;
}

let last = null; // estado carregado (draft/final)

const LIST_NOME = ["CARLOS HENRIQUE", "CRISTIANO", "FABIO", "GLAICON", "HENRIQUE", "IBRAIS", "MARCOS ANTONIO", "NERI", "RODRIGO", "SELO", "SILVIO", "VALDECI"];
const LIST_OBRA = ["FALTA", "F√âRIAS", "EMPRESA", "AEMFLO", "ASTEL", "AUDIT√ìRIO HOSPITAL NOSSA SENHORA DE F√ÅTIMA", "BIOS", "BRAND√ÉO E COSTA ADVOGADOS", "CASA CACUP√â", "CASA GRANDE", "CASSOL", "CASSOL FRENTE DE CAIXA", "COMBO FORQUILINHA", "CONTATO", "CORPORATE 8", "CORTE", "FENAC", "FIESC", "FORUM ARAQUARI", "FUSION", "FUSO HOTEL", "GIASSI ARARANGUA", "GIASSI TUBAR√ÉO", "HOSPITAL NOSSA SENHORA DE F√ÅTIMA", "HOSPITAL SANTA TEREZINHA", "HOSPITAL S√ÉO CAMILO", "HOSPITAL S√ÉO JOSE", "HOSPITAL S√ÉO SEBASTI√ÉO", "HOTEL FUSO", "IMPACT HUB", "MELEIRO", "RES. CARL HOEPCKE", "RESIDENCIAL JOAO LOHN", "S√ÉO LUDGERO", "SHOPPING PALADIUM", "SOS AMBULAT√ìRIO", "SOS CAF√â", "SOS CLINICA RITMO", "SOS ONCOLOGIA", "TREZE DE MAIO", "UNIDADE BASICA DE SAUDE ENCONTA DO SOL", "CLINICA ARTISTi", "S√ÉO BRAZ S√ÉO CAMILO", "PATIO MILANO", "CLINICA RITMO", "CASA DO SEU THOMAZ DA FECEL", "HOSPITAL 13 DE MAIO", "FUSION"];
const LIST_CARRO = ["RXO8A58", "RXL6H17", "IZH2A86", "MJM3616", "QIQ3921", "QHQ8009", "QII5E96", "QIE6I52", "QJO3249", "SXK2D27", "RYI3G63"];
const LIST_PERC = ["0%", "25%", "50%", "75%", "100%"];
const TRASH_SVG = "<svg viewBox=\"0 0 24 24\" aria-hidden=\"true\"><path fill=\"currentColor\" d=\"M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v10h-2V9zm4 0h2v10h-2V9zM7 9h2v10H7V9z\"/></svg>";

const rowsEl = document.getElementById("rows");
const btnAdd = document.getElementById("btnAdd");
const btnSave = document.getElementById("btnSave");
const btnFinalize = document.getElementById("btnFinalize");
const btnNewDay = document.getElementById("btnNewDay");
const nameListEl = document.getElementById("nameList");
const histListEl = document.getElementById("histList");
const pdfModal = document.getElementById("pdfModal");
const pdfFrame = document.getElementById("pdfFrame");
const pdfTitle = document.getElementById("pdfTitle");
const btnPdfClose = document.getElementById("btnPdfClose");
const btnPdfPrint = document.getElementById("btnPdfPrint");
function cryptoRandomId(){
  try { return crypto.randomUUID(); }
  catch(e) { return "id_" + Math.random().toString(16).slice(2) + Date.now().toString(16); }
}
function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
function nowISO(){ return new Date().toISOString(); }
function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }
function optList(arr, ph){ const o=[`<option value="">${ph}</option>`]; arr.forEach(v=>o.push(`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`)); return o.join(""); }
function pctToNumber(p){ if(!p) return null; const n=parseInt(String(p).replace("%","").trim(),10); return Number.isFinite(n)?n:null; }
function setError(el,on){ if(!el) return; on?el.classList.add("input-error"):el.classList.remove("input-error"); }
function openPrintWindow(payload){
  const rows = payload.rows || [];
  const date = (rows[0] && rows[0].data) ? rows[0].data : "";
  const user = (payload.usuario && payload.usuario.nome) ? payload.usuario.nome : "Usu√°rio";
  const generated = new Date().toLocaleString();

  function esc(s){ return String(s ?? "").replace(/[&<>"]/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m])); }

  const style = "<style>
*{box-sizing:border-box;}
body{font-family:Arial,sans-serif;margin:18px;color:#111;}
.h{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px;}
.title{font-size:18px;font-weight:800;}
.sub{font-size:12px;color:#333;margin-top:4px;}
.meta{font-size:12px;color:#333;text-align:right;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #444;padding:8px;font-size:12px;vertical-align:top;}
th{background:#e5e7eb;font-weight:800;text-transform:uppercase;font-size:11px;letter-spacing:.3px;}
.w-data{width:92px;}.w-nome{width:190px;}.w-obra{width:190px;}.w-carro{width:92px;}.w-perc{width:80px;text-align:center;}
@media print{@page{size:A4 landscape;margin:10mm;}}
</style>";
const thead = [
    "<thead><tr>",
    '<th class="w-data">Data</th>',
    '<th class="w-nome">Nome</th>',
    '<th class="w-obra">Obra</th>',
    '<th class="w-carro">Carro</th>',
    "<th>Atividades do dia (o que ser√° feito)</th>",
    '<th class="w-perc">Percentual</th>',
    "<th>Motivo de n√£o ter conclu√≠do</th>",
    "</tr></thead>"
  ].join("");

  const tbody = rows.map(r => [
    "<tr>",
    '<td class="w-data">', esc(r.data||""), "</td>",
    '<td class="w-nome">', esc(r.nome||""), "</td>",
    '<td class="w-obra">', esc(r.obra||""), "</td>",
    '<td class="w-carro">', esc(r.carro||""), "</td>",
    "<td>", esc(r.atividades||""), "</td>",
    '<td class="w-perc">', esc(r.percentual||""), "</td>",
    "<td>", esc(r.motivo||""), "</td>",
    "</tr>"
  ].join("")).join("");

  const header = [
    '<div class="h">',
      '<div>',
        '<div class="title">Lista de Atividades ‚Äî Reuni√£o Matinal</div>',
        '<div class="sub">Data: <b>', esc(date), '</b> ‚Ä¢ Usu√°rio: <b>', esc(user), '</b></div>',
      '</div>',
      '<div class="meta">Gerado em<br/><b>', esc(generated), '</b></div>',
    '</div>'
  ].join("");

  const doc = [
    "<!doctype html><html><head><meta charset='utf-8'><title>Lista de Atividades</title>",
    style,
    "</head><body>",
    header,
    "<table>", thead, "<tbody>", tbody, "</tbody></table>",
    "</body></html>"
  ].join("");
pdfTitle.textContent = "PDF ‚Äî " + (date || "Dia");
  pdfFrame.srcdoc = doc;
  pdfModal.style.display = "block";
}

function buildMultiSelect(options, selected=[], labelText='Selecionar', searchPh='Buscar...'){
  const wrap=document.createElement('div');
  wrap.className='multi';
  wrap.innerHTML = `
    <button type="button" class="multi-btn" aria-haspopup="listbox" aria-expanded="false">
      <span class="txt">${labelText}</span>
      <span class="cnt">0</span>
    </button>
    <div class="multi-popup" role="dialog" aria-label="Selecionados">
      <div class="pop-title">Selecionados</div>
      <div class="pop-items">(nenhum)</div>
    </div>
    <div class="multi-drop" role="listbox">
      <input class="input multi-search" type="text" placeholder="${searchPh}" />
      <div class="multi-list"></div>
    </div>
  `;


  const btn=wrap.querySelector('.multi-btn');
  const txt=wrap.querySelector('.txt');
  const cnt=wrap.querySelector('.cnt');
  const popup=wrap.querySelector('.multi-popup');
  const popItems=wrap.querySelector('.pop-items');
  const search=wrap.querySelector('.multi-search');
  const list=wrap.querySelector('.multi-list');

  // --- Portal para dropdown (evita ficar por tr√°s / ser cortado por overflow/stacking)
  const dropEl = wrap.querySelector('.multi-drop');
  const dropParent = wrap;
  let dropIsPortaled = false;

  function positionDrop(){
    if(!dropIsPortaled) return;
    const r = btn.getBoundingClientRect();
    dropEl.style.position = 'fixed';
    dropEl.style.left = (r.left) + 'px';
    dropEl.style.top  = (r.bottom + 8) + 'px';
    dropEl.style.width = (r.width) + 'px';
    dropEl.style.zIndex = '2147483647';
    dropEl.style.pointerEvents = 'auto';
  }

  function portalDrop(){
    if(dropIsPortaled) return;
    document.body.appendChild(dropEl);
    dropIsPortaled = true
  }

  function unportalDrop(){
    if(!dropIsPortaled) return;
    dropParent.appendChild(dropEl);
    dropEl.removeAttribute('style');
    dropIsPortaled = false;
  }

  const state={selected:new Set((selected||[]).filter(Boolean)), onChange:null};

  function emit(){ if(typeof state.onChange==='function') state.onChange([...state.selected]); }

  function renderHeader(){
    const arr=[...state.selected];
    cnt.textContent=String(arr.length);
    // Mant√©m texto fixo como placeholder (n√£o cresce com os nomes)
    txt.textContent = labelText;
    btn.title = arr.join(', ');
  }

  function renderPopup(){
    const arr=[...state.selected];
    popItems.innerHTML='';
    if(!arr.length){
      popItems.innerHTML = `<div class="pop-empty">(nenhum)</div>`;
      return;
    }
    arr.sort().forEach(v=>{
      const div=document.createElement('div');
      div.className='pop-pill';
      div.innerHTML = `<div class="nm">${escapeHtml(v)}</div><button type="button" class="x" title="Remover">‚úñ</button>`;
      div.querySelector('.x').addEventListener('click', (e)=>{
        e.preventDefault();
        e.stopPropagation();
        state.selected.delete(v);
        // Atualiza checkbox na lista se existir
        const cb = list.querySelector(`input[type=checkbox][data-val="${CSS.escape(v)}"]`);
        if(cb) cb.checked=false;
        renderHeader();
        renderPopup();
        emit();
      });
      popItems.appendChild(div);
    });
  }

  function renderList(filter=''){
    list.innerHTML='';
    const f=(filter||'').trim().toLowerCase();
    (options||[]).filter(v=>!f || String(v).toLowerCase().includes(f)).forEach(v=>{
      const item=document.createElement('label');
      item.className='multi-item';
      const vv=String(v);
      item.innerHTML = `<input type="checkbox" ${state.selected.has(vv)?'checked':''} data-val="${escapeHtml(vv)}"/><div class="lbl">${escapeHtml(vv)}</div>`;
      const cb=item.querySelector('input');
      cb.addEventListener('change', ()=>{
        if(cb.checked) state.selected.add(vv); else state.selected.delete(vv);
        renderHeader();
        renderPopup();
        emit();
      });
      list.appendChild(item);
    });
  }

  function open(){
    wrap.classList.add('open');
    btn.setAttribute('aria-expanded','true');
    // porta o dropdown para o <body> (acima de tudo)
    portalDrop();
    positionDrop();
    const row = wrap.closest('.row');
    if(row) row.classList.add('row-open');
    renderList(search.value);
    // quando est√° portaled, precisa for√ßar display
    if(dropIsPortaled) dropEl.style.display = 'block';
    search.focus();
  }
  function close(){
    wrap.classList.remove('open');
    btn.setAttribute('aria-expanded','false');
    unportalDrop();
    const row = wrap.closest('.row');
    if(row) row.classList.remove('row-open');
  }

  // Clique abre/fecha o dropdown
  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    if(wrap.classList.contains('open')) close(); else open();
  });

  // Popup aparece no foco, some no blur (sem mexer na estrutura)
  btn.addEventListener('focus', ()=>{ wrap.classList.add('show-popup'); renderPopup(); });
  btn.addEventListener('blur', ()=>{ setTimeout(()=>wrap.classList.remove('show-popup'), 120); });

  // Mant√©m popup vis√≠vel enquanto o usu√°rio interage dentro dele
  popup.addEventListener('mousedown', (e)=>{ e.preventDefault(); });

  search.addEventListener('input', ()=>renderList(search.value));

  window.addEventListener('scroll', ()=>{ if(wrap.classList.contains('open')) positionDrop(); }, true);
  window.addEventListener('resize', ()=>{ if(wrap.classList.contains('open')) positionDrop(); });

  // Clique fora fecha tudo
  document.addEventListener('click', (e)=>{
    if(!wrap.contains(e.target) && !(dropIsPortaled && dropEl.contains(e.target))){
      close();
      wrap.classList.remove('show-popup');
    }
  });

  wrap._multi = {
    get: ()=>[...state.selected],
    set: (arr)=>{ state.selected=new Set((arr||[]).filter(Boolean)); renderHeader(); renderPopup(); renderList(search.value); },
    onChange: (fn)=>state.onChange=fn
  };

  renderHeader();
  renderPopup();
  renderList('');
  return wrap;
}


function newRow(pref={}){
  const rowId=cryptoRandomId();
  const row=document.createElement("div");
  row.className="row"; row.dataset.rowId=rowId;
  row.innerHTML = `
    <div class="row-line1">
      <div><button class="iconbtn btn-del" type="button" title="Excluir linha">${TRASH_SVG}</button></div>
      <div><input type="date" class="inp-data" value="${escapeHtml(pref.data || todayStr())}"></div>
      <div class="nome-slot"></div>
      <div class="obra-slot"></div>
      </div>
    <div class="row-line2">
      <div></div>
      <div><textarea class="txt-ativ long" placeholder="Descreva a atividade do dia‚Ä¶">${escapeHtml(pref.atividades || "")}</textarea></div>
      <div><select class="sel-perc">${optList(LIST_PERC,"Percentual (%)")}</select></div>
            <div><select class="sel-carro">${optList(LIST_CARRO,"Placa")}</select></div>
<div class="motivo-wrap"><textarea class="txt-mot long" placeholder="Obrigat√≥rio se percentual < 100%‚Ä¶">${escapeHtml(pref.motivo || "")}</textarea></div>
    </div>
  `;
  const nomesInit = Array.isArray(pref.nomes) ? pref.nomes : (pref.nome ? [pref.nome] : []);
  const multi = buildMultiSelect(LIST_NOME, nomesInit, 'Nome(s)', 'Buscar nome...');
  row.querySelector(".nome-slot").appendChild(multi);

  // Obra(s) ‚Äî multi (NxN)
  const obrasInit = Array.isArray(pref.obras) ? pref.obras : (pref.obra ? [pref.obra] : []);
  const multiObra = buildMultiSelect(LIST_OBRA, obrasInit, 'Obra(s)', 'Buscar obra...');
  row.querySelector(".obra-slot").appendChild(multiObra);

  row._refs = {
    btnDel: row.querySelector(".btn-del"),
    inpDate: row.querySelector(".inp-data"),
    multiNomes: multi,
    multiObras: multiObra,
    selCarro: row.querySelector(".sel-carro"),
    selPerc: row.querySelector(".sel-perc"),
    txtAtiv: row.querySelector(".txt-ativ"),
    txtMot: row.querySelector(".txt-mot"),
    motWrap: row.querySelector(".motivo-wrap"),
  };
    row._refs.selCarro.value = pref.carro || "";
  row._refs.selPerc.value = pref.percentual || "";

  function refreshMotivo(){
    const pct=pctToNumber(row._refs.selPerc.value);
    const show=(pct!==null && pct<100);
    row._refs.motWrap.style.display = show ? "block" : "none";
    if(!show) row._refs.txtMot.value="";
    setError(row._refs.txtMot,false);
  }
  row._refs.selPerc.addEventListener("change", ()=>{ refreshMotivo(); refreshNameChecklist(); });
  refreshMotivo();

  function anyChange(){
    // AUTO regras: Obra = F√âRIAS/FALTA => Atividade = mesma, Percentual = 0%, Carro n√£o obrigat√≥rio
    try{
      const vRaw = (row._refs.multiObras._multi.get()[0] || '') .trim();
      const v = vRaw.toUpperCase();
      const isFerias = (v==="F√âRIAS" || v==="FERIAS");
      const isFalta  = (v==="FALTA" || v==="FATA");
      const isEmpresa = (v==="EMPRESA");
      const specialFF  = (isFerias || isFalta);

      if(specialFF){
        const t = isFerias ? "F√âRIAS" : "FALTA";

        // Atividade autom√°tica + bloqueia
        row._refs.txtAtiv.value = t;
        row._refs.txtAtiv.dataset.autofill = "1";
        row._refs.txtAtiv.disabled = true;
        row._refs.txtAtiv.classList.add('disabled');

        // Percentual autom√°tico 0% + bloqueia
        if(row._refs.selPerc){
          row._refs.selPerc.value = "0%";
          row._refs.selPerc.disabled = true;
          row._refs.selPerc.classList.add('disabled');
        }

        // Motivo limpa e bloqueia
        if(row._refs.txtMot){
          row._refs.txtMot.value = "";
          row._refs.txtMot.disabled = true;
          row._refs.txtMot.classList.add('disabled');
        }

        // Carro n√£o obrigat√≥rio (bloqueia)
        if(row._refs.selCarro){
          row._refs.selCarro.value = "";
          row._refs.selCarro.disabled = true;
          row._refs.selCarro.classList.add('disabled');
        }
      }else{
        // libera campos de FF
        if(row._refs.txtAtiv){
          row._refs.txtAtiv.disabled = false;
          row._refs.txtAtiv.classList.remove('disabled');
          if(row._refs.txtAtiv.dataset.autofill==="1"){
            row._refs.txtAtiv.value = "";
            row._refs.txtAtiv.dataset.autofill = "";
          }
        }
        if(row._refs.selPerc){
          row._refs.selPerc.disabled = false;
          row._refs.selPerc.classList.remove('disabled');
        }
        if(row._refs.txtMot){
          row._refs.txtMot.disabled = false;
          row._refs.txtMot.classList.remove('disabled');
        }

        // regra EMPRESA: n√£o exige carro (bloqueia carro)
        if(row._refs.selCarro){
          if(isEmpresa){
            row._refs.selCarro.value = "";
            row._refs.selCarro.disabled = true;
            row._refs.selCarro.classList.add('disabled');
          }else{
            row._refs.selCarro.disabled = false;
            row._refs.selCarro.classList.remove('disabled');
          }
        }
      }
}catch(e){}

    validateRow(row,"draft");
    refreshNameChecklist();
  }
  row._refs.multiNomes
  row._refs.multiNomes._multi.onChange(()=>anyChange());
  if(row._refs.multiObras && row._refs.multiObras._multi) row._refs.multiObras._multi.onChange(()=>anyChange());
  [row._refs.inpDate,row._refs.selCarro,row._refs.selPerc,row._refs.txtAtiv,row._refs.txtMot]
    .filter(Boolean)
    .forEach(el=>{
      el.addEventListener("change", anyChange);
      el.addEventListener("blur", anyChange);
      el.addEventListener("input", anyChange);
    });
  row._refs.btnDel.addEventListener("click", ()=>{
    if(rowsEl.querySelectorAll(".row").length<=1){ alertWarn("Deve existir pelo menos 1 linha."); return; }
    row.remove(); refreshNameChecklist();
  });
  return row;
}

function getRowData(row){
  const r=row._refs;
  const nomes=r.multiNomes._multi.get();
  return {
    id: row.dataset.rowId,
    data: r.inpDate.value || "",
    nomes,
    nome: nomes.join(" + "),
    obra: (r.multiObras ? (r.multiObras._multi.get().join(' + ')) : '') || "",
    obras: (r.multiObras ? r.multiObras._multi.get() : []),
    carro: r.selCarro.value || "",
    atividades: r.txtAtiv.value || "",
    percentual: r.selPerc.value || "",
    motivo: r.txtMot.value || ""
  };
}

function validateRow(row, mode="draft"){
  const r=row._refs;
  const nomes=r.multiNomes._multi.get();
  const okDate=!!r.inpDate.value;
  const okNomes=Array.isArray(nomes) && nomes.length>0;
  const obras = r.multiObras ? r.multiObras._multi.get() : [];
  const okObra = Array.isArray(obras) && obras.length > 0;
  // Regras especiais (FALTA/F√âRIAS/EMPRESA) s√≥ fazem sentido quando h√° 1 obra selecionada
  const obraSingle = (obras && obras.length===1) ? String(obras[0]||"") : "";
  const obraVal = obraSingle.trim().toUpperCase();
  const isFerias = (obraVal==="F√âRIAS"||obraVal==="FERIAS");
  const isFalta  = (obraVal==="FALTA"||obraVal==="FATA");
  const isEmpresa = (obraVal==="EMPRESA");
  const carOptional = (isFerias || isFalta || isEmpresa);
  const okCar = carOptional ? true : !!r.selCarro.value;
  const okAtiv=(r.txtAtiv.value||"").trim().length>=3;

  let okPerc=true, okMot=true;
  const pct=pctToNumber(r.selPerc.value);
  if(mode==="final"){ okPerc=(pct!==null); if(pct!==null && pct<100 && !isFerias && !isFalta) okMot=(r.txtMot.value||"").trim().length>=3; }

  setError(r.inpDate,!okDate);
  setError(r.multiNomes.querySelector(".multi-btn"), !okNomes);
  setError(r.multiObras.querySelector(".multi-btn"), !okObra);
  setError(r.selCarro,!okCar);
  setError(r.txtAtiv,!okAtiv);

  if(mode==="final"){ 
    setError(r.selPerc,!okPerc);
    // Motivo s√≥ √© obrigat√≥rio quando % < 100% em atividades normais.
    // Para F√âRIAS/FALTA, o % √© for√ßado para 0% e n√£o deve exigir Motivo.
    const needsMot=(pct!==null && pct<100 && !isFerias && !isFalta);
    setError(r.txtMot, needsMot && !okMot);
  }else{ setError(r.selPerc,false); setError(r.txtMot,false); }

  return okDate && okNomes && okObra && okCar && okAtiv && okPerc && okMot;
}

function validateAll(mode="draft"){
  const rows=[...rowsEl.querySelectorAll(".row")];
  if(rows.length===0) return true;
  let ok=true;
  rows.forEach(row=>{ if(!validateRow(row,mode)) ok=false; });
  return ok;
}

function getPayload(status="draft"){
  const rows=[...rowsEl.querySelectorAll(".row")].map(getRowData);
  const r0=rows[0]||{};
  const d=r0.data || todayStr();
  const first=(r0.nomes && r0.nomes[0]) ? r0.nomes[0] : "SEM_NOME";
  const dayKey = d + "__" + String(first).replace(/\s+/g,"_");
  return {
    schema:"ERPIMPAR_ATIVIDADES_DIARIAS",
    version:6,
    status,
    dayKey,
    generatedAt: nowISO(),
    usuario: {
      nome: document.getElementById("userName").textContent || "Usu√°rio",
      email: document.getElementById("userEmail").textContent || "‚Äî"
    },
    rows
  };
}

function missingNames(rows){
  const done=new Set();
  rows.forEach(r=>{
    const hasAtiv=(r.atividades||"").trim().length>=3;
    (Array.isArray(r.nomes)?r.nomes:[]).forEach(n=>{ if(hasAtiv && n) done.add(n); });
  });
  return LIST_NOME.filter(n=>!done.has(n));
}

function refreshNameChecklist(){
  const rows=[...rowsEl.querySelectorAll(".row")].map(getRowData);
  const done=new Set();
  rows.forEach(r=>{
    const hasAtiv=(r.atividades||"").trim().length>=3;
    (Array.isArray(r.nomes)?r.nomes:[]).forEach(n=>{ if(hasAtiv && n) done.add(n); });
  });
  nameListEl.innerHTML="";
  LIST_NOME.forEach(nome=>{
    const ok=done.has(nome);
    const pill=document.createElement("div");
    pill.className="name-pill";
    pill.innerHTML = '<div class="nm">'+escapeHtml(nome)+'</div><div class="st '+(ok?'done':'todo')+'">'+(ok?'OK':'FALTA')+'</div>';
    nameListEl.appendChild(pill);
  });
}

function loadPendencias(){ const raw=localStorage.getItem(STORAGE_PEND); if(!raw) return {schema:"ERPIMPAR_PENDENCIAS",version:1,items:[]}; try{return JSON.parse(raw);}catch(e){return {schema:"ERPIMPAR_PENDENCIAS",version:1,items:[]};} }
function savePendencias(p){ localStorage.setItem(STORAGE_PEND, JSON.stringify(p)); }
function pushPendenciasFromFinal(payloadFinal){
  const pend=loadPendencias();
  const existing=new Set((pend.items||[]).map(x=>x.pendId));
  (payloadFinal.rows||[]).forEach(r=>{
    const pct=pctToNumber(r.percentual);
    if(pct===null || pct>=100) return;
    const pendId=payloadFinal.dayKey+'__'+r.id;
    if(existing.has(pendId)) return;
    pend.items.push({pendId,origemDayKey:payloadFinal.dayKey,createdAt:payloadFinal.generatedAt,data:r.data,nome:r.nome,nomes:r.nomes,obra:r.obra,carro:r.carro,percentual:r.percentual,atividades:r.atividades,motivo:r.motivo,status:"aberta"});
  });
  pend.updatedAt=nowISO(); savePendencias(pend);
}

function loadHist(){ const raw=localStorage.getItem(STORAGE_HIST); if(!raw) return {schema:"ERPIMPAR_ATIVIDADES_HIST",version:1,items:[]}; try{return JSON.parse(raw);}catch(e){return {schema:"ERPIMPAR_ATIVIDADES_HIST",version:1,items:[]};} }
function saveHist(h){ localStorage.setItem(STORAGE_HIST, JSON.stringify(h)); }
function pushHistory(payloadFinal){
  const hist = loadHist();
  const items = hist.items || [];

  // Evita sobrescrever o historico quando houver mais de um fechamento no mesmo dia (testes).
  // Cada fechamento ganha um ID unico.
  if(!payloadFinal.histId){
    payloadFinal.histId = (payloadFinal.dayKey || todayISO()) + "__" + (payloadFinal.generatedAt || nowISO());
  }

  // Se ja existir exatamente o mesmo fechamento, nao duplica.
  if(items.some(x => x.histId === payloadFinal.histId)){
    return;
  }

  // Mantem o ultimo fechamento do dia no topo, sem apagar os anteriores
  items.unshift(payloadFinal);

  hist.items = items.slice(0, 200);
  hist.updatedAt = nowISO();
  saveHist(hist);
}


async async function renderHistoryServer(){
  const LS_SERVER_CACHE = "ERPIMPAR_ATIVIDADES_SERVER_CACHE_V1";
  const dt = (document.getElementById("histDate")?.value || "").trim();

  async function renderIds(ids){
    const list = Array.isArray(ids) ? ids : [];
    // normaliza (list.php pode retornar string[] ou objetos)
    let norm = list.map(x => (typeof x === 'string') ? x : (x && (x.id || x.filename)) ).filter(Boolean);
    // ordena desc (IDs geralmente come√ßam com YYYY-MM-DD)
    norm.sort((a,b)=> String(b).localeCompare(String(a)));
    if(dt) norm = norm.filter(id => String(id).startsWith(dt));

    histListEl.innerHTML = "";

    if(norm.length === 0){
      const empty = document.createElement('div');
      empty.style.color = 'var(--muted)';
      empty.style.fontSize = '12px';
      empty.textContent = dt ? 'Sem registros no servidor para esta data.' : 'Sem registros no servidor.';
      histListEl.appendChild(empty);
      return;
    }

    // limita para n√£o pesar
    norm.slice(0, 80).forEach(id => {
      const card=document.createElement("button");
      card.type="button";
      card.className="hist-item";
      card.style.textAlign="left";
      card.style.padding="12px 14px";
      card.style.borderRadius="14px";
      card.style.width="100%";
      card.style.border="1px solid rgba(148,163,184,.18)";
      card.style.background="rgba(2,6,23,.30)";
      card.style.cursor="pointer";
      card.style.color="inherit";

      const date = String(id).slice(0,10);
      card.innerHTML =
        '<div style="font-weight:1000;letter-spacing:.2px;">'+escapeHtml(date)+' - ATIVIDADES EXECUTADAS</div>'+
        '<div style="display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:6px;">'+
          '<span>ID: <b>'+escapeHtml(id)+'</b></span>'+
        '</div>';

      card.addEventListener("click", async()=>{
        try{
          const data = await withProcessing(async()=> await apiGet(id), "Buscando no servidor‚Ä¶", "PROCESSANDO DADOS......", 700);
          openPrintWindow(data);
        }catch(e){
          alertWarn("N√£o consegui abrir este registro do servidor.\n\n" + (e && e.message ? e.message : ""));
        }
      });
      histListEl.appendChild(card);
    });
  }

  try{
    const ids = await apiList();
    localStorage.setItem(LS_SERVER_CACHE, JSON.stringify(ids || []));
    await renderIds(ids);
  }catch(e){
    // fallback: cache do servidor (n√£o usa hist√≥rico local como fonte principal)
    try{
      const cached = JSON.parse(localStorage.getItem(LS_SERVER_CACHE) || '[]');
      await renderIds(cached);
    }catch(_){
      histListEl.innerHTML = '<div style="color:var(--muted);font-size:12px;">Servidor indispon√≠vel e sem cache.</div>';
    }
  }
}

function renderHistory(){
  const hist=loadHist();
  const items=hist.items||[];
  histListEl.innerHTML="";
  if(items.length===0){
    histListEl.innerHTML='<div style="color:var(--muted);font-size:12px;">Nenhum registro encontrado.</div>';
    return;
  }
  items.slice(0,30).forEach(p=>{
    const rows=p.rows||[];
    const date=(rows[0]&&rows[0].data)?rows[0].data:"‚Äî";
    const total=rows.length;
    const pend=rows.filter(r=>{ const pct=pctToNumber(r.percentual); return pct!==null && pct<100; }).length;

    const card=document.createElement("button");
    card.type="button";
    card.className="hist-item";
    card.style.textAlign="left";
    card.style.padding="12px 14px";
    card.style.borderRadius="14px";
    card.style.width="100%";
    card.style.border="1px solid rgba(148,163,184,.18)";
    card.style.background="rgba(2,6,23,.30)";
    card.style.cursor="pointer";
    card.style.color="inherit";

    card.innerHTML =
      '<div style="font-weight:1000;letter-spacing:.2px;">'+escapeHtml(date)+' - ATIVIDADES EXECUTADAS</div>'+
      '<div style="display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:6px;">'+
        '<span>Linhas: <b>'+total+'</b> - Pend√™ncias: <b>'+pend+'</b> &nbsp; Usu√°rio logado: <b>'+escapeHtml((p.usuario&&p.usuario.nome)||"Usu√°rio")+'</b></span>'+
      '</div>';

    card.addEventListener("click", async()=>{ await withProcessing(async()=>{}, "Buscando hist√≥rico‚Ä¶", "PROCESSANDO DADOS......", 700); openPrintWindow(p); });
    histListEl.appendChild(card);
  });
}

async function gerarPDF(){
  if(isLockedFinal()){
    alertWarn("Dia j√° foi fechado. Use o Hist√≥rico para abrir o PDF do dia.");
    return;
  }
  if(!validateAll("draft")){
    alertWarn("Preencha: Data, Nome(s), Obra, Atividade do dia e Carro (exceto F√âRIAS/FALTA/EMPRESA).");
    return;
  }
  const payload=getPayload("draft");
  const miss = missingNames(payload.rows);
  if(miss.length>0){
    alertWarn("N√ÉO PODE GERAR/IMPRIMIR.\n\nFaltam atividades para:\n- " + miss.join("\n- ") + "\n\nUse Obra = FALTA, F√âRIAS ou EMPRESA quando necess√°rio.");
    return;
  }
  localStorage.setItem(STORAGE_DRAFT, JSON.stringify(payload));
  await withProcessing(async()=>{}, "Gerando relat√≥rio‚Ä¶", "PROCESSANDO DADOS......", 900);
  openPrintWindow(payload);
}

async function finalizeDay(){
  if(isLockedFinal()){
    alertWarn("Dia j√° foi fechado. Use o Hist√≥rico para abrir o PDF do dia.");
    return;
  }
  if(!validateAll("final")){
    alertWarn("Para finalizar: Percentual obrigat√≥rio. Se Percentual < 100%, Motivo obrigat√≥rio.");
    return;
  }

  const payload=getPayload("final");
  const miss = missingNames(payload.rows);
  if(miss.length>0){
    alertWarn("N√£o pode finalizar.\n\nFaltam atividades para:\n- " + miss.join("\n- ") + "\n\nUse Obra = FALTA, F√âRIAS ou EMPRESA quando necess√°rio.");
    return;
  }

  // grava hist√≥rico + trava o dia
  localStorage.setItem(STORAGE_DRAFT, JSON.stringify(payload));
  pushPendenciasFromFinal(payload);
  
pushHistory(payload);
setLockedFinal(true);
  // Hist√≥rico: sempre do servidor (KingHost)
renderHistoryServer();
refreshNameChecklist();

  // prepara campos m√≠nimos pro servidor (save.php exige "date")
  try{
    payload.date = (payload.dayKey || payload.date || (payload.rows && payload.rows[0] && payload.rows[0].data) || todayStr());
  }catch(e){}
  payload.finalizedAt = payload.finalizedAt || new Date().toISOString();

  // meta r√°pida (pra lista do servidor ficar √∫til)
  try{
    const rows = Array.isArray(payload.rows) ? payload.rows : [];
    payload.total = payload.total ?? rows.length;
    payload.pend  = payload.pend  ?? rows.filter(r => {
      const pct = pctToNumber(r.percentual);
      return pct !== null && pct < 100;
    }).length;
  }catch(e){}

  // duplicar userName/userEmail no topo (list.php j√° tenta ler isso)
  try{
    const u = getUser();
    payload.userName  = payload.userName  || (u && u.nome  ? u.nome  : "");
    payload.userEmail = payload.userEmail || (u && u.email ? u.email : "");
  }catch(e){}

// tenta salvar no servidor (KingHost) ‚Äî se falhar, mant√©m local e avisa
try{
  await withProcessing(async()=>{ await apiSave(payload); }, "Salvando no servidor‚Ä¶", "PROCESSANDO DADOS......", 900);
}catch(e){
  alertWarn("Finalizado localmente, mas n√£o consegui salvar no servidor.\n\n" + (e && e.message ? e.message : "Verifique o caminho dos PHPs e permiss√µes."), "Servidor (KingHost)");
}

await withProcessing(async()=>{}, "Gerando relat√≥rio e fechando o dia‚Ä¶", "PROCESSANDO DADOS......", 1200);
  openPrintWindow(payload);
}


if(btnPdfClose) btnPdfClose.addEventListener("click", ()=>{ if(pdfModal) pdfModal.style.display="none"; });
if(btnPdfPrint) btnPdfPrint.addEventListener("click", ()=>{
  try{
    const w = pdfFrame.contentWindow;
    if(w) w.print();
  }catch(e){
    alertWarn("N√£o foi poss√≠vel imprimir o PDF.");
  }
});
if(pdfModal){ const bd = pdfModal.querySelector(".modal-backdrop"); if(bd) bd.addEventListener("click", ()=>{ pdfModal.style.display="none"; }); }

document.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && pdfModal && pdfModal.style.display==="block"){ pdfModal.style.display="none"; }});


function lockRows(isLocked){
  document.querySelectorAll(".rows .row").forEach(r=>{
    r.querySelectorAll("input,select,textarea,button").forEach(el=>{
      // allow viewing (no typing) after final; keep modal/historico working
      if(el.classList.contains("btn-del")) el.disabled = !!isLocked;
      if(el.classList.contains("iconbtn")) el.disabled = !!isLocked;
      if(el.closest(".modal")) return;
      // keep top-right menu principal clickable
      if(el.id==="btnBack") return;
      // keep historico items clickable
      if(el.classList.contains("hist-item")) return;
      // keep pdf modal buttons
      if(el.id==="btnPdfClose" || el.id==="btnPdfPrint") return;
      // lock all form controls in rows
      if(r.contains(el)) el.disabled = !!isLocked;
    });
  });
}

function isLockedFinal(){
  try{
    const last = loadLast();
    return !!(last && last.status === 'final');
  }catch(e){
    return false;
  }
}

function setLockedFinal(isLocked){
  const locked = !!isLocked;
  // top buttons
  if(btnAdd) btnAdd.disabled = locked;
  // N√£o usamos "disabled" em Gerar PDF/Finalizar para poder mostrar modal explicando.
  if(btnSave) btnSave.classList.toggle("soft-disabled", locked);
  if(btnFinalize) btnFinalize.classList.toggle("soft-disabled", locked);
  if(btnNewDay) btnNewDay.classList.toggle("soft-disabled", !locked);
  // lock row controls + delete
  document.querySelectorAll(".rows .row").forEach(row=>{
    row.querySelectorAll("input,select,textarea,button").forEach(el=>{
      // allow delete only when not locked
      if(el.classList.contains("btn-del") || el.classList.contains("iconbtn")) el.disabled = locked;
      else el.disabled = locked;
    });
  });
  // stepper: R (draft) / F (final)
  try{
    const dotF  = document.getElementById("dotF");
    if(locked){
      if(dotF) dotF.classList.add("is-final");
    }else{
      if(dotF) dotF.classList.remove("is-final");
    }
  }catch(e){}
}

function loadLast(){ const raw=localStorage.getItem(STORAGE_DRAFT); if(!raw) return null; try{return JSON.parse(raw);}catch(e){return null;} }
async function newDay(){
  const locked = isLockedFinal();
  if(!locked){
    alertWarn("ABERTURA DE NOVO DIA N√ÉO PERMITIDO, pois falta finalizar o dia anterior.");
    return;
  }

  await withProcessing(async()=>{}, "Preparando novo dia‚Ä¶", "PROCESSANDO DADOS......", 700);

  const payload = { usuario: getUser(), rows: [{data: todayStr(), nomes: [], obra:"", carro:"", atividade:"", percentual:"", motivo:""}] };
  localStorage.setItem(STORAGE_DRAFT, JSON.stringify(payload));
  setLockedFinal(false);
  renderInitial();
  renderHistoryServer();
  refreshNameChecklist();
}
function renderInitial(){
  rowsEl.innerHTML="";
  last = loadLast();
  if(last && Array.isArray(last.rows) && last.rows.length){ last.rows.forEach(r=>rowsEl.appendChild(newRow(r))); }
  else { rowsEl.appendChild(newRow({data:todayStr()})); }

  refreshNameChecklist();
  // Hist√≥rico: sempre do servidor (KingHost)

  // s√≥ permite "Novo dia" se o dia anterior estiver FINALIZADO
  const locked = !!(last && last.status==='final');
  setLockedFinal(locked);
  if(btnNewDay) btnNewDay.disabled = false;
}

btnAdd.addEventListener("click", ()=>{ rowsEl.appendChild(newRow({data:todayStr()})); refreshNameChecklist(); });
btnSave.addEventListener("click", gerarPDF);
btnFinalize.addEventListener("click", finalizeDay);
document.getElementById("btnVoltarMenu").addEventListener("click", ()=>{ window.location.href="/menu.html"; });
const histDateEl = document.getElementById("histDate");
if(histDateEl) histDateEl.addEventListener("change", ()=>{ renderHistoryServer(); });
renderInitial();
renderHistoryServer();
if(btnNewDay) btnNewDay.addEventListener("click", newDay);

</script>


<div id="pdfModal" class="modal" style="display:none;">
  <div class="modal-backdrop"></div>
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title" id="pdfTitle">PDF</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="btnPdfPrint" type="button">üñ®Ô∏è Imprimir</button>
        <button class="btn btn-secondary" id="btnPdfClose" type="button">‚úñ Fechar</button>
      </div>
    </div>
    <div class="modal-body">
      <iframe id="pdfFrame" title="PDF" style="width:100%;height:72vh;border:0;border-radius:14px;background:white;"></iframe>
    </div>
  </div>
</div>
  <script src="rdo_grupos.js"></script>

<!-- RDO MODAL -->
<div id="rdoModal" aria-hidden="true">
  <div class="backdrop" data-close="1"></div>
  <div class="panel" role="dialog" aria-modal="true" aria-label="RDO">
    <div class="head">
      <div class="hleft">
        <div class="title" id="rdoModalTitle">RDO</div>
        <div class="sub" id="rdoModalSub">√öltimos 7 dias</div>
      </div>
      <div class="actions">
        <button class="btn-x" id="rdoModalClose" type="button">‚úñ Fechar</button>
      </div>
    </div>
    <div class="body" id="rdoModalBody"></div>
  </div>
</div>

</body>
</html>
