<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ERP √çMPAR ‚Äî Lista de Atividades</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>

    :root{
      --bg1:#0b1e4a;
      --bg2:#0e3b6e;
      --bg3:#0f766e;

      --panel: rgba(2,6,23,.66);
      --panel2: rgba(2,6,23,.78);
      --border: rgba(148,163,184,.45);

      --text: #e5e7eb;
      --soft: rgba(229,231,235,.78);

      --blue:#3b82f6;
      --green:#22c55e;
      --red:#ef4444;

      --radius: 18px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background:linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3));
      display:flex;
      flex-direction:column;
    }

    /* Entrada suave */
    body{opacity:0}
    @keyframes imparEnter{
      0%{opacity:0; transform: translateY(28px) scale(.98); filter: blur(10px);}
      100%{opacity:1; transform: translateY(0) scale(1); filter: blur(0);}
    }
    body.impar-enter{animation:imparEnter .75s cubic-bezier(.16,1,.3,1) both;}
    @media (prefers-reduced-motion: reduce){
      body{opacity:1}
      body.impar-enter{animation:none}
    }

    header{
      padding:14px 14px 10px;
      display:flex;
      justify-content:center;
    }
    .header-inner{
      width:100%;
      max-width:1200px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      text-shadow:0 2px 6px rgba(0,0,0,.75);
      min-width:0;
    }
    .logo-orb{
      width:36px;height:36px;border-radius:999px;flex:0 0 auto;
      position:relative;
      background: conic-gradient(from 210deg,#22c55e,#06b6d4,#3b82f6,#a855f7,#f97316,#22c55e);
      box-shadow:0 10px 22px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.18) inset;
      overflow:hidden;
    }
    .logo-orb:before{
      content:""; position:absolute; inset:-6px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 55%);
    }
    .brand-text{display:flex; flex-direction:column; gap:2px; min-width:0;}
    .brand-kicker{font-size:12px; letter-spacing:.22em; text-transform:uppercase; font-weight:800; opacity:.9;}
    .brand-title{font-size:18px; font-weight:900; line-height:1.05;}
    .brand-sub{font-size:14px; font-weight:800; opacity:.92; line-height:1.1;}
    .brand-tagline{font-size:12px; opacity:.75; line-height:1.2; max-width:65ch; white-space:normal;}

    .tag-top{
      margin-left:auto;
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.85);
      border:1px solid rgba(148,163,184,.6);
      color:var(--soft);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill-btn{
      border:none;
      background:transparent;
      color:inherit;
      font:inherit;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      padding:0;
    }
    .pill-btn:hover{filter:brightness(1.08)}

    main{
      flex:1 0 auto;
      display:flex;
      justify-content:center;
      padding:12px 16px 18px;
    }
    .layout{
      width:100%;
      max-width:1200px;
      display:flex;
      justify-content:center;
    }
    .container{
      width:100%;
      border-radius:var(--radius);
      border:1px solid rgba(148,163,184,.6);
      box-shadow:0 24px 60px rgba(15,23,42,.9);
      background:linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3));
      padding:18px;
    }

    /* Topbox (padr√£o) */
    .topbox{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:12px 14px;
      border-radius:14px;
      border:2px solid rgba(34,197,94,.45);
      background:linear-gradient(120deg, rgba(2,6,23,.78), rgba(2,6,23,.35));
      box-shadow:0 18px 60px rgba(0,0,0,.35);
      flex-wrap:wrap;
    }
    .topbox-left .title{
      font-size:18px;
      font-weight:900;
      margin-bottom:4px;
    }
    .user-label{
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(156,163,175,.92);
      margin-bottom:2px;
      font-weight:800;
    }
    .user-values{
      font-size:12px;
      color:#cfd8ff;
      line-height:1.25;
      font-weight:700;
    }
    .topbox-center{
      flex:1 1 240px;
      min-width:240px;
      text-align:center;
      padding:0 10px;
    }
    .code-line{
      font-size:20px;
      font-weight:900;
      letter-spacing:.4px;
      color:rgba(229,231,235,.98);
    }
    .sub-line{
      margin-top:4px;
      font-size:16px;
      color:rgba(229,231,235,.92);
      opacity:.95;
    }

    /* Stepper */
    .stepper-wrap{display:flex; align-items:center; justify-content:flex-end; flex:0 0 auto;}
    .stepper{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 8px;
      border-radius:999px;
      background:rgba(2,6,23,.35);
      border:1px solid rgba(255,255,255,.06);
      overflow:auto;
      max-width:100%;
    }
    .dot{
      width:24px;height:24px;border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      font-size:11px; font-weight:900;
      background:#0b1220;
      color:#cbd5e1;
      border:1px solid rgba(148,163,184,.25);
      box-shadow:0 10px 24px rgba(0,0,0,.25);
      flex:0 0 auto;
    }
    .dot.active{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#020617;
      border-color:rgba(34,197,94,.6);
      box-shadow:0 14px 34px rgba(22,163,74,.45);
    }
    .line{
      width:56px;height:3px;border-radius:999px;
      background:rgba(148,163,184,.18);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.04);
      flex:0 0 auto;
    }
    .line.active{
      background:linear-gradient(90deg,#22c55e,#16a34a);
      box-shadow:0 10px 24px rgba(22,163,74,.35);
    }

    .hint{
      margin:10px 2px 10px;
      font-size:14px;
      color:rgba(231,236,255,.92);
      opacity:.95;
      line-height:1.35;
      text-shadow:0 2px 10px rgba(0,0,0,.35);
    }

    .card{
      margin-top:10px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(2,6,23,.55);
      padding:14px;
      display:flex;
      flex-direction:column;
      min-height:280px;
      box-shadow:0 18px 48px rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
    }

    label{
      display:block;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#9ca3af;
      margin-bottom:6px;
      font-weight:900;
    }
    .req-star{
      color:#fbbf24;
      font-weight:900;
      text-shadow:0 0 10px rgba(251,191,36,.35);
      margin-left:2px;
    }
    input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #111827;
      background:#020617;
      color:var(--text);
      font-size:14px;
      outline:none;
      transition: box-shadow .18s ease, border-color .18s ease, transform .18s ease;
    }
    input:focus{
      border-color:var(--blue);
      box-shadow:0 0 0 1px rgba(59,130,246,.95), 0 0 18px rgba(59,130,246,.40), 0 0 46px rgba(29,78,216,.25);
    }
    .field-help{
      margin-top:8px;
      min-height:14px;
      font-size:12px;
      color:#94a3b8;
    }
    .field-help.ok{color:#86efac; font-weight:800;}
    .field-help.err{color:#fca5a5; font-weight:900;}

    /* Efeito premium: vermelho + tremor */
    @keyframes shakeX{
      0%,100%{transform:translateX(0)}
      20%{transform:translateX(-10px)}
      40%{transform:translateX(10px)}
      60%{transform:translateX(-8px)}
      80%{transform:translateX(8px)}
    }
    .input-error{
      border:2px solid rgba(239,68,68,.95) !important;
      border-color:rgba(239,68,68,.95) !important;
      box-shadow:0 0 0 1px rgba(239,68,68,.95), 0 0 18px rgba(239,68,68,.35), 0 0 46px rgba(239,68,68,.25) !important;
      animation:shakeX .38s ease-in-out;
    }

    .actions{
      margin-top:auto;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      padding-top:14px;
    }
    .actions-left{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-start;
    }
    .actions-right{
      margin-left:auto;
      display:flex;
      justify-content:flex-end;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:10px 16px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.12em;
      font-weight:900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      min-width:220px;
      transition: transform .22s cubic-bezier(.16,1,.3,1),
                  box-shadow .22s cubic-bezier(.16,1,.3,1),
                  filter .22s cubic-bezier(.16,1,.3,1);
      will-change: transform;
    }

    /* "Desabilitado" visualmente, mas clic√°vel (para mostrar modal com motivo) */
    .btn.soft-disabled{
      opacity: .55;
      filter: saturate(.75);
    }
    .btn.soft-disabled:hover{
      transform: none;
      box-shadow: none;
    }

/* =========================================================
   TRANSI√á√ÉO DE ENTRADA ‚Äî estilo slide (menu ‚Üí solicita√ß√£o)
   ========================================================= */
body { opacity: 0; }
@keyframes imparEnter {
  0% { opacity:0; transform: translateY(34px) scale(.97); filter: blur(10px); }
  100% { opacity:1; transform: translateY(0) scale(1); filter: blur(0); }
}
body.impar-enter { animation: imparEnter .80s cubic-bezier(.16,1,.3,1) both; }
@media (prefers-reduced-motion: reduce) {
  body { opacity: 1; }
  body.impar-enter { animation:none; }
}

    .btn-primary{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#020617;
      box-shadow:0 10px 30px rgba(22,163,74,.6);
    }
    .btn-secondary{
      background:#111827;
      color:#fff;
      border:1px solid #374151;
    }


/* ===== Bot√µes verdes ‚Äî hover/focus premium (zoom + brilho) ===== */
.btn-primary{
  transition: transform .22s cubic-bezier(.16,1,.3,1),
              box-shadow .22s cubic-bezier(.16,1,.3,1),
              filter .22s cubic-bezier(.16,1,.3,1);
  will-change: transform;
}
.btn-primary:hover{
  transform: translateY(-1px) scale(1.035);
  filter: saturate(1.18) brightness(1.08);
  box-shadow:
    0 0 0 1px rgba(34,197,94,.95),
    0 0 22px rgba(34,197,94,.55),
    0 18px 45px rgba(22,163,74,.55);
}
.btn-primary:active{
  transform: translateY(0) scale(.99);
  filter: saturate(1.08) brightness(1.03);
}
.btn-primary:focus-visible{
  outline:none;
  transform: translateY(-1px) scale(1.035);
  box-shadow:
    0 0 0 2px rgba(2,6,23,.90),
    0 0 0 4px rgba(34,197,94,.75),
    0 0 26px rgba(34,197,94,.55);
}
    .btn-primary.is-loading,
    .btn-secondary.is-loading{
      pointer-events:none;
      opacity:.92;
      filter:saturate(1.02) brightness(1.01);
    }
    .mini-spinner{
      width:14px;height:14px;
      border-radius:999px;
      border:2px solid rgba(2,6,23,.35);
      border-top-color:rgba(2,6,23,.85);
      display:inline-block;
      animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

.pill-btn{
  transition: transform .2s cubic-bezier(.16,1,.3,1), box-shadow .2s cubic-bezier(.16,1,.3,1);
}
.pill-btn:hover{ transform: translateY(-1px) scale(1.02); box-shadow: 0 12px 28px rgba(0,0,0,.28); }
.pill-btn:focus-visible{ outline:none; box-shadow: 0 0 0 2px rgba(2,6,23,.9), 0 0 0 4px rgba(47,123,255,.55); }

    .arrow{ display:inline-block; font-weight:900; }
    .arrow-left{ transform: rotate(180deg); }


    /* Panes */
    .step-pane{display:none;}
    .step-pane.active{display:block;}
    @keyframes paneIn{from{opacity:0; transform:translateY(10px) scale(.99);} to{opacity:1; transform:translateY(0) scale(1);}}
    .pane-in{animation:paneIn .22s ease-out both;}

    /* Placeholder */
    .coming{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:10px;
      min-height:220px;
      padding:10px;
    }
    .coming .big{
      font-size:18px;
      font-weight:1000;
      letter-spacing:.02em;
    }
    .coming .small{
      font-size:13px;
      color:rgba(229,231,235,.82);
      max-width:70ch;
      line-height:1.35;
    }

    footer{
      margin-top:auto;
      background:#020617;
      color:#9ca3af;
      padding:8px 12px;
      font-size:10px;
    }
    .rodape-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    @media (max-width: 900px){
      .topbox-center{text-align:left}
      .btn{width:100%; min-width:unset;}
      input{font-size:16px} /* evita zoom no iPhone */
      .line{width:28px}
    }
  
    .btn:focus{
      outline:none;
      box-shadow:
        0 0 0 2px rgba(2,6,23,.90),
        0 0 0 4px rgba(34,197,94,.80),
        0 0 28px rgba(34,197,94,.70),
        0 22px 55px rgba(22,163,74,.65) !important;
    }


    /* Etapa 3 ‚Äì grid do miolo (sem mexer no layout geral) */
    .grid24{
      display:grid;
      grid-template-columns: repeat(24, minmax(0, 1fr));
      gap:14px;
      align-items:start;
    }
    .grid24 > div{min-width:0;}
    .c12{grid-column: span 12;}
    .c8{grid-column: span 8;}
    .c6{grid-column: span 6;}
    .c5{grid-column: span 5;}
    .c4{grid-column: span 4;}
    .c3{grid-column: span 3;}
    .c2{grid-column: span 2;}

    @media (max-width: 900px){
      .grid24{grid-template-columns: 1fr; gap:12px;}
      .c12,.c8,.c6,.c5,.c4,.c3,.c2{grid-column: 1 / -1;}
    }


    /* Campos preenchidos automaticamente via CEP */
    input[data-autofill="1"]{
      background: rgba(2,6,23,.72);
      border-color: rgba(34,197,94,.22);
      box-shadow: inset 0 0 0 1px rgba(34,197,94,.18);
      color: rgba(229,231,235,.92);
    }
    input[data-autofill="1"][data-auto-set="1"]{
      background: rgba(16,185,129,.10);
      border-color: rgba(16,185,129,.55);
      box-shadow: 0 0 0 1px rgba(16,185,129,.35), 0 0 18px rgba(16,185,129,.18);
    }

    /* Overlay spinner (Atualizando endere√ßo...) */
    .overlay-loading{
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,.55);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9999;
      padding: 16px;
    }
    .overlay-loading.show{display:flex;}
    .overlay-card{
      width: min(520px, 92vw);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(2,6,23,.78);
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
      padding: 18px 18px 16px;
      text-align:center;
    }
    .overlay-title{
      font-size: 14px;
      font-weight: 1000;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: rgba(231,236,255,.95);
      margin-top: 10px;
    }
    .overlay-sub{
      font-size: 13px;
      color: rgba(229,231,235,.82);
      margin-top: 8px;
    }
    .spinner-lg{
      width: 54px;
      height: 54px;
      border-radius: 999px;
      border: 4px solid rgba(148,163,184,.25);
      border-top-color: rgba(34,197,94,.95);
      animation: spin .9s linear infinite;
      margin: 0 auto;
      box-shadow: 0 0 0 1px rgba(34,197,94,.18), 0 0 26px rgba(34,197,94,.20);
    }


    textarea{
      width:100%;
      resize: vertical;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.55);
      color: rgba(231,236,255,.92);
      outline: none;
    }
    textarea::placeholder{color: rgba(148,163,184,.65);}
    textarea:focus{
      border-color:var(--blue);
      box-shadow:0 0 0 1px rgba(59,130,246,.95), 0 0 18px rgba(59,130,246,.40), 0 0 46px rgba(29,78,216,.25);
    }


    /* Etapa 5 - data picker √≠cone e preview de logo */
    input[type="date"]{
      padding-right: 42px;
    }
    input[type="date"]::-webkit-calendar-picker-indicator{
      opacity: .9;
      cursor: pointer;
      filter: invert(1);
    }
    .hint{
      font-size: 12px;
      color: rgba(229,231,235,.72);
      margin-top: 6px;
    }
    .logo-preview{
      position: relative;
      width: 100%;
      height: 54px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,.28);
      background: rgba(2,6,23,.55);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .logo-preview img{
      max-height: 42px;
      max-width: 92%;
      display: none;
      filter: drop-shadow(0 8px 14px rgba(0,0,0,.35));
    }
    .logo-empty{
      font-size: 12px;
      color: rgba(229,231,235,.65);
    }


#step5 textarea:focus,
#step5 input:focus{
  outline:none;
  border-color: rgba(34,197,94,.85);
  box-shadow:0 0 0 2px rgba(2,6,23,.90),0 0 0 4px rgba(34,197,94,.80),0 0 28px rgba(34,197,94,.65),0 22px 55px rgba(22,163,74,.55);
}

/* ===== Modal √çMPAR ===== */
.impar-modal{position:fixed; inset:0; display:none; z-index:9999;}
.impar-modal[aria-hidden="false"]{display:block;}
.impar-modal-backdrop{position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(6px);}
.impar-modal-card{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  width:min(720px, calc(100% - 32px));
  border-radius:22px;
  border:1px solid rgba(148,163,184,.22);
  background: radial-gradient(1200px 600px at 10% 10%, rgba(59,130,246,.14), transparent 55%),
              radial-gradient(900px 500px at 90% 20%, rgba(34,197,94,.12), transparent 55%),
              rgba(2,6,23,.92);
  box-shadow: 0 30px 80px rgba(0,0,0,.55);
  padding:22px 22px 18px;
}
.impar-modal-head{display:flex; gap:14px; align-items:flex-start; padding-bottom:10px;}
.impar-modal-icon{
  width:46px; height:46px; border-radius:14px;
  display:flex; align-items:center; justify-content:center;
  background: rgba(59,130,246,.15);
  border:1px solid rgba(59,130,246,.35);
  box-shadow: 0 0 24px rgba(59,130,246,.25);
  font-size:22px;
}
.impar-modal-title{font-size:22px; font-weight:800; letter-spacing:.2px; color:rgba(255,255,255,.92);}
.impar-modal-subtitle{margin-top:4px; font-size:13px; color:rgba(229,231,235,.72);}
.impar-modal-footer{display:flex; justify-content:flex-end; padding-top:10px;}
.impar-modal-loading{
  position:absolute; inset:0; border-radius:22px;
  background:rgba(2,6,23,.82);
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px;
}
.impar-modal-loading-text{color:rgba(229,231,235,.85); font-size:13px;}
.impar-modal-body{padding:8px 0 0;}
.impar-modal-message{color:rgba(229,231,235,.88); font-size:14px; line-height:1.35;}


/* ===== Override: foco azul brilhante (garantia) ===== */
button:focus, .btn:focus, .btn:focus-visible,
input:focus, textarea:focus, select:focus,
input:focus-visible, textarea:focus-visible, select:focus-visible{
  outline:none !important;
  border-color: rgba(59,130,246,.95) !important;
  box-shadow: 0 0 0 3px rgba(59,130,246,.25), 0 0 18px rgba(59,130,246,.45) !important;
}


    /* =========================================================
       SWEETALERT2 ‚Äî Tema √çMPAR Premium (igual Solicita√ß√£o)
       ========================================================= */
    .impar-swal{
      background: rgba(2,6,23,.92) !important;
      color: #e5e7eb !important;
      border: 1px solid rgba(255,255,255,.10) !important;
      border-radius: 18px !important;
      box-shadow: 0 30px 80px rgba(0,0,0,.55) !important;
      backdrop-filter: blur(14px);
    }
    .impar-swal .swal2-title{ color:#e5e7eb !important; font-weight:800; }
    .impar-swal .swal2-html-container{ color: rgba(229,231,235,.88) !important; }
    .impar-swal-confirm, .impar-swal-cancel{
      border:0 !important;
      border-radius:12px !important;
      padding:10px 16px !important;
      font-weight:900 !important;
      letter-spacing:.3px !important;
      cursor:pointer !important;
      box-shadow:none !important;
    }
    .impar-swal-confirm{
      background: linear-gradient(135deg,#22c55e,#16a34a) !important;
      color:#020617 !important;
    }
    .impar-swal-cancel{
      background: rgba(148,163,184,.14) !important;
      color:#e5e7eb !important;
    }

    /* =========================================================
       PAGE LOADER ‚Äî padr√£o ERP (spinner pequeno + texto)
       ========================================================= */
    #pageLoader{
      position:fixed; inset:0; z-index:99999;
      display:flex; align-items:center; justify-content:center;
      background: rgba(2,6,23,.55);
      backdrop-filter: blur(10px);
    }
    #pageLoader.hidden{ display:none; }
    #pageLoader .loader-card{
      width:min(720px, 92vw);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(2,6,23,.78);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      padding: 18px 18px;
      display:flex; gap:14px; align-items:center;
    }
    #pageLoader .loader-spin{
      width:22px; height:22px; border-radius:999px;
      border: 2px solid rgba(148,163,184,.35);
      border-top-color: rgba(226,232,240,.95);
      animation: imparSpin .85s linear infinite;
      flex: 0 0 auto;
    }
    #pageLoader .loader-title{ font-weight:900; letter-spacing:.3px; }
    #pageLoader .loader-sub{ font-size:12px; color: rgba(226,232,240,.78); margin-top:2px; }
    @keyframes imparSpin { to { transform: rotate(360deg); } }



/* ========================= LISTA DE ATIVIDADES ‚Äî v6 (√çMPAR) ========================= */
.module-sub{font-size:14px;font-weight:800;opacity:.92;line-height:1.1;}
.req-star{color:#fbbf24;font-weight:900;text-shadow:0 0 10px rgba(251,191,36,.35);margin-left:2px;}

.page-grid{display:grid;grid-template-columns:1fr 300px;gap:14px;align-items:start;}
.side{position:sticky;top:92px;}
.side .card{padding:12px;}
.side-title{font-weight:900;letter-spacing:.2px;margin-bottom:8px;}
.name-list{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto;padding-right:6px;}
.name-pill{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid rgba(148,163,184,.18);background: rgba(2,6,23,.40);border-radius:12px;padding:8px 10px;}
.name-pill .nm{font-weight:800;font-size:12px;letter-spacing:.2px;opacity:.92;}
.name-pill .st{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.18);opacity:.95;}
.st.todo{background: rgba(239,68,68,.12);border-color: rgba(239,68,68,.25);color: rgba(254,226,226,.95);}
.st.done{background: rgba(34,197,94,.12);border-color: rgba(34,197,94,.25);color: rgba(220,252,231,.95);}
.side-hint{color:var(--muted);font-size:12px;line-height:1.35;margin-top:10px;}

.table-head{border-radius:16px;overflow:hidden;border:1px solid rgba(148,163,184,.20);box-shadow:0 18px 48px rgba(0,0,0,.10);}
.th1{background: rgba(148,163,184,.28);border-bottom:1px solid rgba(148,163,184,.18);padding:10px 12px;display:grid;grid-template-columns: 42px 200px 1fr 1fr 160px;gap:12px;align-items:center;}
.th2{background: rgba(148,163,184,.18);padding:10px 12px;display:grid;grid-template-columns: 42px 1fr 160px 1fr;gap:12px;align-items:center;}
.th-label{font-size:12px;font-weight:900;letter-spacing:.25px;text-transform:uppercase;opacity:.95;color: rgba(17,24,39,.95);}
.th-label .req-star{color:#b45309;text-shadow:none;}

.rows{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
.row{border:1px solid rgba(148,163,184,.22);background: rgba(2,6,23,.35);border-radius:16px;padding:12px;box-shadow:0 18px 48px rgba(0,0,0,.12);backdrop-filter: blur(10px);position:relative;overflow:visible;}
.row-line1{display:grid;grid-template-columns: 42px 200px 1fr 1fr 160px;gap:12px;align-items:start;}
.row-line2{display:grid;grid-template-columns: 42px 1fr 160px 1fr;gap:12px;margin-top:10px;align-items:start;}

.iconbtn{width:34px;height:34px;border-radius:12px;border:1px solid rgba(148,163,184,.25);background: rgba(2,6,23,.65);color: rgba(229,231,235,.92);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.18s ease;}
.iconbtn:hover{border-color: rgba(239,68,68,.45);box-shadow: 0 0 0 2px rgba(2,6,23,.75), 0 0 18px rgba(239,68,68,.25);transform: translateY(-1px);}
.iconbtn svg{width:18px;height:18px;opacity:.95}

select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #111827;background:#020617;color:var(--text);font-size:14px;outline:none;transition: box-shadow .18s ease, border-color .18s ease, transform .18s ease;}
select:focus, select:focus-visible{outline:none !important;border-color: rgba(59,130,246,.95) !important;box-shadow: 0 0 0 3px rgba(59,130,246,.25), 0 0 18px rgba(59,130,246,.45) !important;}
textarea.long{min-height:78px;resize:vertical;}
.motivo-wrap{display:none;}

.actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:space-between;margin-top:14px;position:relative;z-index:10;}
.actions .btn{min-width: 260px;}
.hist{margin-top:14px;}

/* ===== Multi-select (NOMES) ===== */
.multi{position:relative; z-index:30;}
.multi.open{z-index:9998;}
.multi-btn{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #111827;background:#020617;color:var(--text);font-size:14px;display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer;transition: box-shadow .18s ease, border-color .18s ease, transform .18s ease;}
.multi-btn:focus, .multi-btn:focus-visible{outline:none !important;border-color: rgba(59,130,246,.95) !important;box-shadow: 0 0 0 3px rgba(59,130,246,.25), 0 0 18px rgba(59,130,246,.45) !important;}
.multi-btn .txt{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:.95;}
.multi-btn .cnt{font-size:12px;color:var(--muted);padding:4px 8px;border:1px solid rgba(148,163,184,.18);border-radius:999px;background: rgba(2,6,23,.55);}
.multi-drop{position:absolute;left:0;right:0;top:calc(100% + 8px);background: rgba(2,6,23,.92);border:1px solid rgba(148,163,184,.18);border-radius:14px;box-shadow:0 22px 60px rgba(0,0,0,.35);padding:10px;z-index:9999 !important;display:none;}
.multi.open .multi-drop{display:block;}
.multi-search{width:100%;margin-bottom:8px;}
.multi-list{max-height:260px;overflow:auto;display:flex;flex-direction:column;gap:6px;padding-right:6px;}
.multi-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:12px;border:1px solid rgba(148,163,184,.14);background: rgba(2,6,23,.45);}
.multi-item:hover{border-color: rgba(59,130,246,.25);box-shadow: 0 0 0 2px rgba(59,130,246,.10);}
.multi-item input{transform: scale(1.05);}
.multi-item .lbl{font-size:13px;font-weight:800;letter-spacing:.1px;}

@media (max-width: 1100px){.page-grid{grid-template-columns:1fr;}.side{position:relative;top:auto;}}
@media (max-width: 980px){
  .th1, .row-line1{grid-template-columns: 42px 1fr;}
  .th2, .row-line2{grid-template-columns: 42px 1fr;}
}

  
/* OVERRIDE: index.html usa body{opacity:0} e libera via JS; aqui mantemos vis√≠vel */

/* FIX: dropdown do multi-select acima dos bot√µes/a√ß√µes */
.row{position:relative;}
.row.row-open{z-index:99999 !important;}
.actions{z-index:2 !important;}
.multi.open{z-index:99999 !important;}
.multi.open .multi-drop{z-index:100000 !important;}

body{opacity:1 !important;}


/* ===== Ajustes finais diretor (V6.4) ===== */
.th1{grid-template-columns: 42px 200px 1.25fr 1fr !important;}
.row-line1{grid-template-columns: 42px 200px 1.25fr 1fr !important;}
.th2{grid-template-columns: 42px 1fr 150px 150px 1fr !important;}
.row-line2{grid-template-columns: 42px 1fr 150px 150px 1fr !important;}
/* modal PDF inline */
.modal{position:fixed;inset:0;z-index:200000;display:none;}
.modal .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter: blur(6px);}
.modal .modal-card{position:relative;margin:40px auto;max-width:1100px;width:calc(100% - 24px);border-radius:18px;border:1px solid rgba(148,163,184,.22);
  background: rgba(2,6,23,.88);box-shadow:0 28px 90px rgba(0,0,0,.45);overflow:hidden;}
.modal .modal-head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 12px;border-bottom:1px solid rgba(148,163,184,.18);}
.modal .modal-title{font-weight:900;letter-spacing:.2px;}
.modal .modal-body{padding:12px;}
@media (max-width: 980px){
  .th1,.row-line1{grid-template-columns:42px 1fr !important;}
  .th2,.row-line2{grid-template-columns:42px 1fr !important;}
  .modal .modal-card{margin:14px auto;}
}


/* ===== Hist√≥rico layout clean (V7.0) ===== */
.hist.card .hist-top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:10px;}
.hist.card .hist-top .title{font-size:14px;margin:0;}
.hist.card .hist-top .hint{color:var(--muted);font-size:12px;margin-top:4px;}
/* keep only date filter */
#histDate{max-width:220px;}
/* stepper final state */
.stepper .pill.is-final{background:#16a34a!important;border-color:#16a34a!important;color:white!important;} .stepper .dot.is-final{background:rgba(34,197,94,.22)!important;border-color:rgba(34,197,94,.35)!important;color:#d1fae5!important;}
.stepper .dot.is-final{background:rgba(34,197,94,.95)!important;box-shadow:0 0 0 6px rgba(34,197,94,.18)!important;}


/* ===== MODAIS (ERP √çMPAR) - SWEETALERT ===== */
.swal2-container{ padding: 10px !important; }
.swal2-popup.impar-swal{
  background: rgba(6, 16, 38, .96) !important;
  color: rgba(255,255,255,.92) !important;
  border: 1px solid rgba(255,255,255,.08) !important;
  border-radius: 18px !important;
  box-shadow: 0 24px 80px rgba(0,0,0,.55) !important;
  backdrop-filter: blur(10px);
}
.impar-swal-title{ letter-spacing:.3px; font-weight: 1000; }
.impar-swal-text{ color: rgba(255,255,255,.76) !important; }
.impar-swal-btn{
  background: rgba(10, 25, 55, .9) !important;
  border: 1px solid rgba(96,165,250,.70) !important;
  color: rgba(255,255,255,.92) !important;
  border-radius: 12px !important;
  padding: 10px 18px !important;
  font-weight: 1000 !important;
  letter-spacing: .3px !important;
  box-shadow: 0 10px 24px rgba(0,0,0,.35);
}
.impar-swal-btn:hover{ filter: brightness(1.08); transform: translateY(-1px); }
.impar-swal-btn:active{ transform: translateY(0); }
.impar-swal-in{ animation: imparPopIn .18s ease-out both; }
.impar-swal-out{ animation: imparPopOut .14s ease-in both; }
@keyframes imparPopIn{ from{ transform: scale(.98); opacity: 0; } to{ transform: scale(1); opacity: 1; } }
@keyframes imparPopOut{ from{ transform: scale(1); opacity: 1; } to{ transform: scale(.985); opacity: 0; } }

/* ===== LOADER / SPINNER (fundo fosco) ===== */
#pageLoader{ backdrop-filter: blur(8px); }


/* ===== Multi-select POPUP (selecionados) ===== */
.multi-popup{position:absolute;left:0;right:0;top:calc(100% + 8px);margin-top:0;
  background: rgba(2,6,23,.92);
  border:1px solid rgba(148,163,184,.18);
  border-radius:14px;
  box-shadow:0 22px 60px rgba(0,0,0,.35);
  padding:10px;
  z-index:200000 !important;
  display:none;
}
.multi.show-popup .multi-popup{display:block;}
.multi-popup .pop-title{font-size:11px;letter-spacing:.18em;text-transform:uppercase;font-weight:900;color:rgba(229,231,235,.78);margin-bottom:8px;}
.multi-popup .pop-items{max-height:220px;overflow:auto;display:flex;flex-direction:column;gap:6px;padding-right:6px;}
.multi-popup .pop-pill{display:flex;align-items:center;justify-content:space-between;gap:10px;
  border:1px solid rgba(148,163,184,.14);
  background: rgba(2,6,23,.45);
  border-radius:12px;
  padding:8px 10px;
}
.multi-popup .pop-pill .nm{font-size:12px;font-weight:900;letter-spacing:.12px;opacity:.94;}
.multi-popup .pop-pill .x{border:none;background:transparent;color:rgba(229,231,235,.7);cursor:pointer;font-weight:900;}
.multi-popup .pop-empty{font-size:12px;color:rgba(229,231,235,.65);padding:6px 2px;}

/* Garante dropdown sempre acima */
.multi.open{z-index:200000 !important;}
.multi.open .multi-drop{z-index:200001 !important;}
.row.row-open{z-index:199999 !important;}


/* PATCH v5.1: remover labels (th1/th2) */
.table-head{display:none !important;}

/* PATCH v5.3: garantir dropdown sempre por cima */
.rows, .page-grid, .card, .hist{overflow:visible !important;}
.multi-drop{z-index:1000000 !important;}
.multi-popup{z-index:1000001 !important;}

/* PATCH v5.3 zindex: garantir dropdown acima e sem corte */
.rows,.page-grid,.card{overflow:visible !important;}
.multi-drop{z-index:100000 !important;}
.multi-popup{z-index:100001 !important;}


/* ===== MOBILE (VFINAL) ‚Äî quebra usu√°rio e % em novas linhas ===== */
@media (max-width: 560px){
  .container{padding:12px;}
  .topbox{flex-direction:column; align-items:stretch; gap:10px;}
  .topbox-left, .topbox-center, .stepper-wrap{width:100%;}
  .topbox-center{min-width:0; text-align:left; padding:0;}
  .code-line{font-size:16px; line-height:1.2;}
  .sub-line{font-size:13px;}
  .user-values{word-break:break-word;}

  /* linhas da atividade: tudo em uma coluna (sem % colado com placa) */
  .row-line2{grid-template-columns: 1fr !important;}
  .row-line2 > div:first-child{display:none !important;}

  /* bot√µes */
  .actions{gap:10px;}
  .actions .btn{min-width: 100%;}

  /* sidebar abaixo */
  .page-grid{grid-template-columns:1fr; }
  .side{position:relative; top:auto;}
}


/* ===== Acoplamento Hist√≥rico + RDO ===== */
.hist-divider{
  height:1px;
  background: rgba(148,163,184,.18);
  margin: 14px 0 12px;
}
.rdo-inline{ margin-top: 0; }
.rdo-inline .rdo-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}
.rdo-inline .rdo-actions{ display:flex; align-items:center; gap:10px; }
.rdo-inline .rdo-status{
  display:flex; align-items:center; gap:8px;
  font-size:12px; color: var(--muted);
}
.rdo-inline .rdo-status .dot{
  width:10px;height:10px;border-radius:50%;
  background:#2bd27f; display:inline-block;
}
.rdo-inline .rdo-body{ margin-top:12px; }
.rdo-inline .rdo-grid{
  display:grid;
  grid-template-columns:repeat(4, minmax(220px, 1fr));
  gap:12px;
  max-height:220px;
  overflow:auto;
  padding-right:6px;
}
@media (max-width: 1100px){
  .rdo-inline .rdo-grid{ grid-template-columns:repeat(3, minmax(220px, 1fr)); }
}
@media (max-width: 860px){
  .rdo-inline .rdo-grid{ grid-template-columns:repeat(2, minmax(220px, 1fr)); }
}
@media (max-width: 560px){
  .rdo-inline .rdo-grid{ grid-template-columns:1fr; max-height:260px; }
}
.rdo-inline .rdo-empty{
  display:none;
  color: var(--muted);
  font-size:12px;
  margin-top:10px;
}

/* ===== Badge global de novas mensagens (canto superior) ===== */
.rdo-global-badge{
  position: fixed;
  top: 14px;
  right: 14px;
  z-index: 99999;
  min-width: 22px;
  height: 22px;
  padding: 0 6px;
  border-radius: 999px;
  background: #ef4444;
  color: #fff;
  font-weight: 900;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 10px 25px rgba(0,0,0,.35);
  border: 2px solid rgba(255,255,255,.20);
  cursor: pointer;
}

</style>

/* FIX_BUILD: 2026-01-18 05:13:03 API:https://api.erpimpar.com.br/atividades CORS_FIX2 */
</head>
<body>
<!-- PAGE LOADER ‚Äî padr√£o ERP √çMPAR -->
<div id="pageLoader" class="hidden" aria-hidden="true">
  <div class="loader-card">
    <div class="loader-spin" aria-hidden="true"></div>
    <div>
      <div class="loader-title">Processando‚Ä¶</div>
      <div class="loader-sub">PROCESSANDO DADOS......</div>
    </div>
  </div>
</div>

<header>
  <div class="header-inner">
    <div class="brand">
      <div class="logo-orb" aria-hidden="true"></div>
      <div class="brand-text">
        <div class="brand-kicker">PLATAFORMA</div>
        <div class="brand-title">ERP √çMPAR</div>
        <div class="brand-sub module-sub">Lista de Atividades</div>
      </div>
    </div>
    <div class="tag-top">
      <button class="pill-btn" id="btnVoltarMenu" type="button"><span>üè†</span> Menu principal</button>
    </div>
  </div>
</header>

<main>
  <div class="layout">
    <div class="container">

      <div class="topbox">
        <div class="topbox-left">
          <div class="title">Atividades do Dia</div>
          <div class="user-label">Logado como</div>
          <div class="user-values">
            <strong id="userName">Usu√°rio</strong><br/>
            <span id="userEmail">‚Äî</span>
          </div>
        </div>

        <div class="topbox-center">
          <div class="code-line">Reuni√£o Matinal ‚Ä¢ PDF para impress√£o</div>
          <div class="sub-line">Gerar PDF exige todos alocados ‚Ä¢ Finalizar exige % e Motivo se &lt; 100%</div>
        </div>

        <div class="stepper-wrap">
          <div class="stepper" aria-label="Status">
            <div class="dot active" id="dotR" title="Rascunho">R</div>
            <div class="line active"></div>
            <div class="dot" id="dotF" title="Final">F</div>
          </div>
        </div>
      </div>

      <div class="hint">
        <b>Obrigat√≥rios (rascunho):</b> Data, Nome(s), Obra, Carro e Atividade do dia ‚Äî e <b>todos os nomes da escala precisam estar lan√ßados</b> (use Obra = <b>FALTA</b> ou <b>F√âRIAS</b> quando necess√°rio).<br/>
        <b>Final do dia:</b> Percentual obrigat√≥rio. Se Percentual &lt; 100%, Motivo obrigat√≥rio (vira pend√™ncia autom√°tica).
      </div>

      <div class="page-grid">
        <div>

          <div id="rows" class="rows"></div>

          <div class="actions">
            <button class="btn btn-secondary" id="btnAdd" type="button">‚ûï ADICIONAR LINHA</button>
            <button class="btn btn-primary" id="btnSave" type="button">üñ®Ô∏è GERAR PDF (IMPRIMIR)</button>
            <button class="btn btn-primary" id="btnFinalize" type="button">‚úÖ FINALIZAR (HIST√ìRICO)</button>
          <button class="btn btn-secondary" id="btnNewDay" type="button">üóìÔ∏è Novo dia</button>
          </div>

          <div class="hist card">
  <div class="hist-top">
    <div>
      <div class="title">Hist√≥rico (Finalizados)</div>
      <div class="hint">Clique no card para abrir o PDF do dia</div>
    </div>
    <input id="histDate" class="inp inp-date" type="date" placeholder="dd/mm/aaaa"/>
  </div>
  <div id="histList" class="hist-list" style="display:flex;flex-direction:column;gap:10px;"></div>
      <div class="hist-divider"></div>
</div>
        </div>

        <aside class="side">
          <div class="card">
            <div class="side-title">Escala do dia</div>
            <div style="color:var(--muted);font-size:12px;margin-bottom:10px;">Todos da lista precisam ter atividade lan√ßada.</div>
            <div id="nameList" class="name-list"></div>
            <div class="side-hint">
              <b>Formato do PDF:</b><br/>
              DATA ‚Ä¢ NOME ‚Ä¢ OBRA ‚Ä¢ CARRO ‚Ä¢ ATIVIDADES ‚Ä¢ PERCENTUAL ‚Ä¢ MOTIVO
            </div>
          </div>
        </aside>
      </div>

    </div>
  </div>

</main>

<footer>
  <div class="rodape-inner">
    <div>ERP √çMPAR ‚Ä¢ Lista de Atividades</div>
    <div>v6.1 ‚Ä¢ Draft: <b>ERPIMPAR_ATIVIDADES_DIARIAS_V2</b> ‚Ä¢ Pend√™ncias: <b>ERPIMPAR_PENDENCIAS_V1</b> ‚Ä¢ Hist√≥rico: <b>ERPIMPAR_ATIVIDADES_HIST_V1</b></div>
  </div>
</footer>


<div id="pdfModal" class="modal" style="display:none;">
  <div class="modal-backdrop"></div>
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title" id="pdfTitle">PDF</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="btnPdfPrint" type="button">üñ®Ô∏è Imprimir</button>
        <button class="btn btn-secondary" id="btnPdfClose" type="button">‚úñ Fechar</button>
      </div>
    </div>
    <div class="modal-body">
      <iframe id="pdfFrame" title="PDF" style="width:100%;height:72vh;border:0;border-radius:14px;background:white;"></iframe>
    </div>
  </div>
</div>

<script>
function showPageLoader(title, sub){
  const el=document.getElementById("pageLoader"); if(!el) return;
  el.querySelector(".loader-title").textContent = title || "Processando‚Ä¶";
  el.querySelector(".loader-sub").textContent = sub || "PROCESSANDO DADOS......";
  el.classList.remove("hidden"); el.setAttribute("aria-hidden","false");
}
function hidePageLoader(){
  const el=document.getElementById("pageLoader"); if(!el) return;
  el.classList.add("hidden"); el.setAttribute("aria-hidden","true");
}
const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
async function withProcessing(fn, title, sub, minMs=800){
  const t0=Date.now();
  showPageLoader(title||"Processando‚Ä¶", sub||"PROCESSANDO DADOS......");
  try{
    const res = await fn();
    const dt=Date.now()-t0;
    if(dt<minMs) await sleep(minMs-dt);
    return res;
  }finally{
    hidePageLoader();
  }
}

function swalBase(){
  return {
    customClass:{
      popup:"impar-swal",
      title:"impar-swal-title",
      htmlContainer:"impar-swal-text",
      confirmButton:"impar-swal-btn"
    },
    buttonsStyling:false,
    showClass:{ popup:"impar-swal-in" },
    hideClass:{ popup:"impar-swal-out" }
  };
}
function alertOk(msg){
  if(!window.Swal){ alert(msg); return; }
  return Swal.fire(Object.assign(swalBase(),{
    icon:"success",
    title:"Sucesso",
    text:msg,
    confirmButtonText:"OK"
  }));
}
function alertWarn(msg, title="Aten√ß√£o"){
  if(!window.Swal){ alert(msg); return; }
  return Swal.fire(Object.assign(swalBase(),{
    icon:"warning",
    title:title,
    text:msg,
    confirmButtonText:"OK"
  }));
}
function alertInfo(msg, title="Informa√ß√£o"){
  if(!window.Swal){ alert(msg); return; }
  return Swal.fire(Object.assign(swalBase(),{
    icon:"info",
    title:title,
    text:msg,
    confirmButtonText:"OK"
  }));
}
function alertErr(msg, title="Erro"){
  if(!window.Swal){ alert(msg); return; }
  return Swal.fire(Object.assign(swalBase(),{
    icon:"error",
    title:title,
    text:msg,
    confirmButtonText:"OK"
  }));
}




const KEY = "ERPIMPAR_USER";

function getSessaoERP(){
  const raw = localStorage.getItem(KEY) || sessionStorage.getItem(KEY);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}

function loadUser(){
  const u = getSessaoERP();

  if(!u){
    // sem sess√£o = volta pro login REAL do ERP
    window.location.href = "/index.html";
    return;
  }

  document.getElementById("userName").textContent  = (u.nome  || u.Nome  || "Usu√°rio");
  document.getElementById("userEmail").textContent = (u.email || u.Email || "‚Äî");
}

function getUser(){
  const u = getSessaoERP();
  if(!u) return { nome: "Usu√°rio", email: "" };

  return {
    nome:  String(u.nome  || u.Nome  || "Usu√°rio").trim(),
    email: String(u.email || u.Email || "").trim()
  };
}

loadUser();

const STORAGE_DRAFT = "ERPIMPAR_ATIVIDADES_DIARIAS_V2";
const STORAGE_PEND  = "ERPIMPAR_PENDENCIAS_V1";
const STORAGE_HIST  = "ERPIMPAR_ATIVIDADES_HIST_V1";

// ===== Integra√ß√£o com KingHost (PHP) ‚Äî salvar/listar/abrir =====
// Ajuste os caminhos abaixo se seus PHPs estiverem em outra pasta:
const API_SAVE = "https://api.erpimpar.com.br/atividades/save.php";
const API_LIST = "https://api.erpimpar.com.br/atividades/list.php";
const API_GET  = "https://api.erpimpar.com.br/atividades/get.php";

async function apiSave(payload){
  const r = await fetch(API_SAVE, {
    method: "POST",
    // CORS: request simples (sem preflight) ‚Äî manda JSON como text/plain
    headers: { "Content-Type":"text/plain;charset=UTF-8" },
    body: JSON.stringify(payload)
  });
  const j = await r.json().catch(()=>null);
  if(!r.ok || !j || j.ok !== true){
    const msg = (j && (j.error || j.message)) ? (j.error || j.message) : "Falha ao salvar no servidor.";
    throw new Error(msg);
  }
  // save.php pode devolver id; se n√£o devolver, mantemos o que j√° existe
  return j.id || j.data?.id || payload.id || null;
}

async function apiList(){
  const r = await fetch(API_LIST, { method:"GET" });
  const j = await r.json().catch(()=>null);
  if(!r.ok || !j || j.ok !== true) return [];
  const data = j.items || j.data || [];
  return Array.isArray(data) ? data : [];
}

async function apiGet(id){
  const url = API_GET + "?id=" + encodeURIComponent(id);
  const r = await fetch(url, { method:"GET" });
  const j = await r.json().catch(()=>null);
  if(!r.ok || !j || j.ok !== true) throw new Error((j && (j.error||j.message)) || "Falha ao abrir no servidor.");
  return j.data;
}

let last = null; // estado carregado (draft/final)

const LIST_NOME = ["CARLOS HENRIQUE", "CRISTIANO", "FABIO", "GLAICON", "HENRIQUE", "IBRAIS", "MARCOS ANTONIO", "NERI", "RODRIGO", "SELO", "SILVIO", "VALDECI"];
const LIST_OBRA = ["FALTA", "F√âRIAS", "EMPRESA", "AEMFLO", "ASTEL", "AUDIT√ìRIO HOSPITAL NOSSA SENHORA DE F√ÅTIMA", "BIOS", "BRAND√ÉO E COSTA ADVOGADOS", "CASA CACUP√â", "CASA GRANDE", "CASSOL", "CASSOL FRENTE DE CAIXA", "COMBO FORQUILINHA", "CONTATO", "CORPORATE 8", "CORTE", "FENAC", "FIESC", "FORUM ARAQUARI", "FUSION", "FUSO HOTEL", "GIASSI ARARANGUA", "GIASSI TUBAR√ÉO", "HOSPITAL NOSSA SENHORA DE F√ÅTIMA", "HOSPITAL SANTA TEREZINHA", "HOSPITAL S√ÉO CAMILO", "HOSPITAL S√ÉO JOSE", "HOSPITAL S√ÉO SEBASTI√ÉO", "HOTEL FUSO", "IMPACT HUB", "MELEIRO", "RES. CARL HOEPCKE", "RESIDENCIAL JOAO LOHN", "S√ÉO LUDGERO", "SHOPPING PALADIUM", "SOS AMBULAT√ìRIO", "SOS CAF√â", "SOS CLINICA RITMO", "SOS ONCOLOGIA", "TREZE DE MAIO", "UNIDADE BASICA DE SAUDE ENCONTA DO SOL", "CLINICA ARTISTi", "S√ÉO BRAZ S√ÉO CAMILO", "PATIO MILANO", "CLINICA RITMO", "CASA DO SEU THOMAZ DA FECEL", "HOSPITAL 13 DE MAIO", "FUSION"];
const LIST_CARRO = ["RXO8A58", "RXL6H17", "IZH2A86", "MJM3616", "QIQ3921", "QHQ8009", "QII5E96", "QIE6I52", "QJO3249", "SXK2D27", "RYI3G63"];
const LIST_PERC = ["0%", "25%", "50%", "75%", "100%"];
const TRASH_SVG = "<svg viewBox=\"0 0 24 24\" aria-hidden=\"true\"><path fill=\"currentColor\" d=\"M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v10h-2V9zm4 0h2v10h-2V9zM7 9h2v10H7V9z\"/></svg>";

const rowsEl = document.getElementById("rows");
const btnAdd = document.getElementById("btnAdd");
const btnSave = document.getElementById("btnSave");
const btnFinalize = document.getElementById("btnFinalize");
const btnNewDay = document.getElementById("btnNewDay");
const nameListEl = document.getElementById("nameList");
const histListEl = document.getElementById("histList");
const pdfModal = document.getElementById("pdfModal");
const pdfFrame = document.getElementById("pdfFrame");
const pdfTitle = document.getElementById("pdfTitle");
const btnPdfClose = document.getElementById("btnPdfClose");
const btnPdfPrint = document.getElementById("btnPdfPrint");
function cryptoRandomId(){
  try { return crypto.randomUUID(); }
  catch(e) { return "id_" + Math.random().toString(16).slice(2) + Date.now().toString(16); }
}
function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
function nowISO(){ return new Date().toISOString(); }
function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }
function optList(arr, ph){ const o=[`<option value="">${ph}</option>`]; arr.forEach(v=>o.push(`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`)); return o.join(""); }
function pctToNumber(p){ if(!p) return null; const n=parseInt(String(p).replace("%","").trim(),10); return Number.isFinite(n)?n:null; }
function setError(el,on){ if(!el) return; on?el.classList.add("input-error"):el.classList.remove("input-error"); }
function openPrintWindow(payload){
  const rows = payload.rows || [];
  const date = (rows[0] && rows[0].data) ? rows[0].data : "";
  const user = (payload.usuario && payload.usuario.nome) ? payload.usuario.nome : "Usu√°rio";
  const generated = new Date().toLocaleString();

  function esc(s){ return String(s ?? "").replace(/[&<>"]/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m])); }

  const style = [
    "<style>",
    "*{box-sizing:border-box;}",
    "body{font-family:Arial,sans-serif;margin:18px;color:#111;}",
    ".h{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px;}",
    ".title{font-size:18px;font-weight:800;}",
    ".sub{font-size:12px;color:#333;margin-top:4px;}",
    ".meta{font-size:12px;color:#333;text-align:right;}",
    "table{width:100%;border-collapse:collapse;margin-top:10px;}",
    "th,td{border:1px solid #444;padding:8px;font-size:12px;vertical-align:top;}",
    "th{background:#e5e7eb;font-weight:800;text-transform:uppercase;font-size:11px;letter-spacing:.3px;}",
    ".w-data{width:92px;}.w-nome{width:190px;}.w-obra{width:190px;}.w-carro{width:92px;}.w-perc{width:80px;text-align:center;}",
    "@media print{@page{size:A4 landscape;margin:10mm;}}",
    "
/* RDO ao vivo grid responsivo */
@media (max-width: 980px){
  #rdoGrid{grid-template-columns:repeat(2, minmax(220px, 1fr)) !important;}
}
@media (max-width: 560px){
  #rdoGrid{grid-template-columns:1fr !important;}
}
</style>"
  ].join("");

  const thead = [
    "<thead><tr>",
    '<th class="w-data">Data</th>',
    '<th class="w-nome">Nome</th>',
    '<th class="w-obra">Obra</th>',
    '<th class="w-carro">Carro</th>',
    "<th>Atividades do dia (o que ser√° feito)</th>",
    '<th class="w-perc">Percentual</th>',
    "<th>Motivo de n√£o ter conclu√≠do</th>",
    "</tr></thead>"
  ].join("");

  const tbody = rows.map(r => [
    "<tr>",
    '<td class="w-data">', esc(r.data||""), "</td>",
    '<td class="w-nome">', esc(r.nome||""), "</td>",
    '<td class="w-obra">', esc(r.obra||""), "</td>",
    '<td class="w-carro">', esc(r.carro||""), "</td>",
    "<td>", esc(r.atividades||""), "</td>",
    '<td class="w-perc">', esc(r.percentual||""), "</td>",
    "<td>", esc(r.motivo||""), "</td>",
    "</tr>"
  ].join("")).join("");

  const header = [
    '<div class="h">',
      '<div>',
        '<div class="title">Lista de Atividades ‚Äî Reuni√£o Matinal</div>',
        '<div class="sub">Data: <b>', esc(date), '</b> ‚Ä¢ Usu√°rio: <b>', esc(user), '</b></div>',
      '</div>',
      '<div class="meta">Gerado em<br/><b>', esc(generated), '</b></div>',
    '</div>'
  ].join("");

  const doc = [
    "<!doctype html><html><head><meta charset='utf-8'><title>Lista de Atividades</title>",
    style,
    "</head><body>",
    header,
    "<table>", thead, "<tbody>", tbody, "</tbody></table>",
    "
  <div id="rdoGlobalBadge" class="rdo-global-badge" style="display:none;">0</div>
</body></html>"
  ].join("");

  pdfTitle.textContent = "PDF ‚Äî " + (date || "Dia");
  pdfFrame.srcdoc = doc;
  pdfModal.style.display = "block";
}

function buildMultiSelect(options, selected=[], labelText='Selecionar', searchPh='Buscar...'){
  const wrap=document.createElement('div');
  wrap.className='multi';
  wrap.innerHTML = `
    <button type="button" class="multi-btn" aria-haspopup="listbox" aria-expanded="false">
      <span class="txt">${labelText}</span>
      <span class="cnt">0</span>
    </button>
    <div class="multi-popup" role="dialog" aria-label="Selecionados">
      <div class="pop-title">Selecionados</div>
      <div class="pop-items"></div>
    </div>
    <div class="multi-drop" role="listbox">
      <input class="input multi-search" type="text" placeholder="${searchPh}"/>
      <div class="multi-list"></div>
    </div>
  `;

  const btn=wrap.querySelector('.multi-btn');
  const txt=wrap.querySelector('.txt');
  const cnt=wrap.querySelector('.cnt');
  const popup=wrap.querySelector('.multi-popup');
  const popItems=wrap.querySelector('.pop-items');
  const search=wrap.querySelector('.multi-search');
  const list=wrap.querySelector('.multi-list');

  // --- Portal para dropdown (evita ficar por tr√°s / ser cortado por overflow/stacking)
  const dropEl = wrap.querySelector('.multi-drop');
  const dropParent = wrap;
  let dropIsPortaled = false;

  function positionDrop(){
    if(!dropIsPortaled) return;
    const r = btn.getBoundingClientRect();
    dropEl.style.position = 'fixed';
    dropEl.style.left = (r.left) + 'px';
    dropEl.style.top  = (r.bottom + 8) + 'px';
    dropEl.style.width = (r.width) + 'px';
    dropEl.style.zIndex = '2147483647';
    dropEl.style.pointerEvents = 'auto';
  }

  function portalDrop(){
    if(dropIsPortaled) return;
    document.body.appendChild(dropEl);
    dropIsPortaled = true
  }

  function unportalDrop(){
    if(!dropIsPortaled) return;
    dropParent.appendChild(dropEl);
    dropEl.removeAttribute('style');
    dropIsPortaled = false;
  }

  const state={selected:new Set((selected||[]).filter(Boolean)), onChange:null};

  function emit(){ if(typeof state.onChange==='function') state.onChange([...state.selected]); }

  function renderHeader(){
    const arr=[...state.selected];
    cnt.textContent=String(arr.length);
    // Mant√©m texto fixo como placeholder (n√£o cresce com os nomes)
    txt.textContent = labelText;
    btn.title = arr.join(', ');
  }

  function renderPopup(){
    const arr=[...state.selected];
    popItems.innerHTML='';
    if(!arr.length){
      popItems.innerHTML = `<div class="pop-empty">(nenhum)</div>`;
      return;
    }
    arr.sort().forEach(v=>{
      const div=document.createElement('div');
      div.className='pop-pill';
      div.innerHTML = `<div class="nm">${escapeHtml(v)}</div><button type="button" class="x" title="Remover">‚úñ</button>`;
      div.querySelector('.x').addEventListener('click', (e)=>{
        e.preventDefault();
        e.stopPropagation();
        state.selected.delete(v);
        // Atualiza checkbox na lista se existir
        const cb = list.querySelector(`input[type=checkbox][data-val="${CSS.escape(v)}"]`);
        if(cb) cb.checked=false;
        renderHeader();
        renderPopup();
        emit();
      });
      popItems.appendChild(div);
    });
  }

  function renderList(filter=''){
    list.innerHTML='';
    const f=(filter||'').trim().toLowerCase();
    (options||[]).filter(v=>!f || String(v).toLowerCase().includes(f)).forEach(v=>{
      const item=document.createElement('label');
      item.className='multi-item';
      const vv=String(v);
      item.innerHTML = `<input type="checkbox" ${state.selected.has(vv)?'checked':''} data-val="${escapeHtml(vv)}"/><div class="lbl">${escapeHtml(vv)}</div>`;
      const cb=item.querySelector('input');
      cb.addEventListener('change', ()=>{
        if(cb.checked) state.selected.add(vv); else state.selected.delete(vv);
        renderHeader();
        renderPopup();
        emit();
      });
      list.appendChild(item);
    });
  }

  function open(){
    wrap.classList.add('open');
    btn.setAttribute('aria-expanded','true');
    // porta o dropdown para o <body> (acima de tudo)
    portalDrop();
    positionDrop();
    const row = wrap.closest('.row');
    if(row) row.classList.add('row-open');
    renderList(search.value);
    // quando est√° portaled, precisa for√ßar display
    if(dropIsPortaled) dropEl.style.display = 'block';
    search.focus();
  }
  function close(){
    wrap.classList.remove('open');
    btn.setAttribute('aria-expanded','false');
    unportalDrop();
    const row = wrap.closest('.row');
    if(row) row.classList.remove('row-open');
  }

  // Clique abre/fecha o dropdown
  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    if(wrap.classList.contains('open')) close(); else open();
  });

  // Popup aparece no foco, some no blur (sem mexer na estrutura)
  btn.addEventListener('focus', ()=>{ wrap.classList.add('show-popup'); renderPopup(); });
  btn.addEventListener('blur', ()=>{ setTimeout(()=>wrap.classList.remove('show-popup'), 120); });

  // Mant√©m popup vis√≠vel enquanto o usu√°rio interage dentro dele
  popup.addEventListener('mousedown', (e)=>{ e.preventDefault(); });

  search.addEventListener('input', ()=>renderList(search.value));

  window.addEventListener('scroll', ()=>{ if(wrap.classList.contains('open')) positionDrop(); }, true);
  window.addEventListener('resize', ()=>{ if(wrap.classList.contains('open')) positionDrop(); });

  // Clique fora fecha tudo
  document.addEventListener('click', (e)=>{
    if(!wrap.contains(e.target) && !(dropIsPortaled && dropEl.contains(e.target))){
      close();
      wrap.classList.remove('show-popup');
    }
  });

  wrap._multi = {
    get: ()=>[...state.selected],
    set: (arr)=>{ state.selected=new Set((arr||[]).filter(Boolean)); renderHeader(); renderPopup(); renderList(search.value); },
    onChange: (fn)=>state.onChange=fn
  };

  renderHeader();
  renderPopup();
  renderList('');
  return wrap;
}


function newRow(pref={}){
  const rowId=cryptoRandomId();
  const row=document.createElement("div");
  row.className="row"; row.dataset.rowId=rowId;
  row.innerHTML = `
    <div class="row-line1">
      <div><button class="iconbtn btn-del" type="button" title="Excluir linha">${TRASH_SVG}</button></div>
      <div><input type="date" class="inp-data" value="${escapeHtml(pref.data || todayStr())}"></div>
      <div class="nome-slot"></div>
      <div class="obra-slot"></div>
      </div>
    <div class="row-line2">
      <div></div>
      <div><textarea class="txt-ativ long" placeholder="Descreva a atividade do dia‚Ä¶">${escapeHtml(pref.atividades || "")}</textarea></div>
      <div><select class="sel-perc">${optList(LIST_PERC,"Percentual (%)")}</select></div>
            <div><select class="sel-carro">${optList(LIST_CARRO,"Placa")}</select></div>
<div class="motivo-wrap"><textarea class="txt-mot long" placeholder="Obrigat√≥rio se percentual < 100%‚Ä¶">${escapeHtml(pref.motivo || "")}</textarea></div>
    </div>
  `;
  const nomesInit = Array.isArray(pref.nomes) ? pref.nomes : (pref.nome ? [pref.nome] : []);
  const multi = buildMultiSelect(LIST_NOME, nomesInit, 'Nome(s)', 'Buscar nome...');
  row.querySelector(".nome-slot").appendChild(multi);

  // Obra(s) ‚Äî multi (NxN)
  const obrasInit = Array.isArray(pref.obras) ? pref.obras : (pref.obra ? [pref.obra] : []);
  const multiObra = buildMultiSelect(LIST_OBRA, obrasInit, 'Obra(s)', 'Buscar obra...');
  row.querySelector(".obra-slot").appendChild(multiObra);

  row._refs = {
    btnDel: row.querySelector(".btn-del"),
    inpDate: row.querySelector(".inp-data"),
    multiNomes: multi,
    multiObras: multiObra,
    selCarro: row.querySelector(".sel-carro"),
    selPerc: row.querySelector(".sel-perc"),
    txtAtiv: row.querySelector(".txt-ativ"),
    txtMot: row.querySelector(".txt-mot"),
    motWrap: row.querySelector(".motivo-wrap"),
  };
    row._refs.selCarro.value = pref.carro || "";
  row._refs.selPerc.value = pref.percentual || "";

  function refreshMotivo(){
    const pct=pctToNumber(row._refs.selPerc.value);
    const show=(pct!==null && pct<100);
    row._refs.motWrap.style.display = show ? "block" : "none";
    if(!show) row._refs.txtMot.value="";
    setError(row._refs.txtMot,false);
  }
  row._refs.selPerc.addEventListener("change", ()=>{ refreshMotivo(); refreshNameChecklist(); });
  refreshMotivo();

  function anyChange(){
    // AUTO regras: Obra = F√âRIAS/FALTA => Atividade = mesma, Percentual = 0%, Carro n√£o obrigat√≥rio
    try{
      const vRaw = (row._refs.multiObras._multi.get()[0] || '') .trim();
      const v = vRaw.toUpperCase();
      const isFerias = (v==="F√âRIAS" || v==="FERIAS");
      const isFalta  = (v==="FALTA" || v==="FATA");
      const isEmpresa = (v==="EMPRESA");
      const specialFF  = (isFerias || isFalta);

      if(specialFF){
        const t = isFerias ? "F√âRIAS" : "FALTA";

        // Atividade autom√°tica + bloqueia
        row._refs.txtAtiv.value = t;
        row._refs.txtAtiv.dataset.autofill = "1";
        row._refs.txtAtiv.disabled = true;
        row._refs.txtAtiv.classList.add('disabled');

        // Percentual autom√°tico 0% + bloqueia
        if(row._refs.selPerc){
          row._refs.selPerc.value = "0%";
          row._refs.selPerc.disabled = true;
          row._refs.selPerc.classList.add('disabled');
        }

        // Motivo limpa e bloqueia
        if(row._refs.txtMot){
          row._refs.txtMot.value = "";
          row._refs.txtMot.disabled = true;
          row._refs.txtMot.classList.add('disabled');
        }

        // Carro n√£o obrigat√≥rio (bloqueia)
        if(row._refs.selCarro){
          row._refs.selCarro.value = "";
          row._refs.selCarro.disabled = true;
          row._refs.selCarro.classList.add('disabled');
        }
      }else{
        // libera campos de FF
        if(row._refs.txtAtiv){
          row._refs.txtAtiv.disabled = false;
          row._refs.txtAtiv.classList.remove('disabled');
          if(row._refs.txtAtiv.dataset.autofill==="1"){
            row._refs.txtAtiv.value = "";
            row._refs.txtAtiv.dataset.autofill = "";
          }
        }
        if(row._refs.selPerc){
          row._refs.selPerc.disabled = false;
          row._refs.selPerc.classList.remove('disabled');
        }
        if(row._refs.txtMot){
          row._refs.txtMot.disabled = false;
          row._refs.txtMot.classList.remove('disabled');
        }

        // regra EMPRESA: n√£o exige carro (bloqueia carro)
        if(row._refs.selCarro){
          if(isEmpresa){
            row._refs.selCarro.value = "";
            row._refs.selCarro.disabled = true;
            row._refs.selCarro.classList.add('disabled');
          }else{
            row._refs.selCarro.disabled = false;
            row._refs.selCarro.classList.remove('disabled');
          }
        }
      }
}catch(e){}

    validateRow(row,"draft");
    refreshNameChecklist();
  }
  row._refs.multiNomes
  row._refs.multiNomes._multi.onChange(()=>anyChange());
  if(row._refs.multiObras && row._refs.multiObras._multi) row._refs.multiObras._multi.onChange(()=>anyChange());
  [row._refs.inpDate,row._refs.selCarro,row._refs.selPerc,row._refs.txtAtiv,row._refs.txtMot]
    .filter(Boolean)
    .forEach(el=>{
      el.addEventListener("change", anyChange);
      el.addEventListener("blur", anyChange);
      el.addEventListener("input", anyChange);
    });
  row._refs.btnDel.addEventListener("click", ()=>{
    if(rowsEl.querySelectorAll(".row").length<=1){ alertWarn("Deve existir pelo menos 1 linha."); return; }
    row.remove(); refreshNameChecklist();
  });
  return row;
}

function getRowData(row){
  const r=row._refs;
  const nomes=r.multiNomes._multi.get();
  return {
    id: row.dataset.rowId,
    data: r.inpDate.value || "",
    nomes,
    nome: nomes.join(" + "),
    obra: (r.multiObras ? (r.multiObras._multi.get().join(' + ')) : '') || "",
    obras: (r.multiObras ? r.multiObras._multi.get() : []),
    carro: r.selCarro.value || "",
    atividades: r.txtAtiv.value || "",
    percentual: r.selPerc.value || "",
    motivo: r.txtMot.value || ""
  };
}

function validateRow(row, mode="draft"){
  const r=row._refs;
  const nomes=r.multiNomes._multi.get();
  const okDate=!!r.inpDate.value;
  const okNomes=Array.isArray(nomes) && nomes.length>0;
  const obras = r.multiObras ? r.multiObras._multi.get() : [];
  const okObra = Array.isArray(obras) && obras.length > 0;
  // Regras especiais (FALTA/F√âRIAS/EMPRESA) s√≥ fazem sentido quando h√° 1 obra selecionada
  const obraSingle = (obras && obras.length===1) ? String(obras[0]||"") : "";
  const obraVal = obraSingle.trim().toUpperCase();
  const isFerias = (obraVal==="F√âRIAS"||obraVal==="FERIAS");
  const isFalta  = (obraVal==="FALTA"||obraVal==="FATA");
  const isEmpresa = (obraVal==="EMPRESA");
  const carOptional = (isFerias || isFalta || isEmpresa);
  const okCar = carOptional ? true : !!r.selCarro.value;
  const okAtiv=(r.txtAtiv.value||"").trim().length>=3;

  let okPerc=true, okMot=true;
  const pct=pctToNumber(r.selPerc.value);
  if(mode==="final"){ okPerc=(pct!==null); if(pct!==null && pct<100 && !isFerias && !isFalta) okMot=(r.txtMot.value||"").trim().length>=3; }

  setError(r.inpDate,!okDate);
  setError(r.multiNomes.querySelector(".multi-btn"), !okNomes);
  setError(r.multiObras.querySelector(".multi-btn"), !okObra);
  setError(r.selCarro,!okCar);
  setError(r.txtAtiv,!okAtiv);

  if(mode==="final"){ 
    setError(r.selPerc,!okPerc);
    // Motivo s√≥ √© obrigat√≥rio quando % < 100% em atividades normais.
    // Para F√âRIAS/FALTA, o % √© for√ßado para 0% e n√£o deve exigir Motivo.
    const needsMot=(pct!==null && pct<100 && !isFerias && !isFalta);
    setError(r.txtMot, needsMot && !okMot);
  }else{ setError(r.selPerc,false); setError(r.txtMot,false); }

  return okDate && okNomes && okObra && okCar && okAtiv && okPerc && okMot;
}

function validateAll(mode="draft"){
  const rows=[...rowsEl.querySelectorAll(".row")];
  if(rows.length===0) return true;
  let ok=true;
  rows.forEach(row=>{ if(!validateRow(row,mode)) ok=false; });
  return ok;
}

function getPayload(status="draft"){
  const rows=[...rowsEl.querySelectorAll(".row")].map(getRowData);
  const r0=rows[0]||{};
  const d=r0.data || todayStr();
  const first=(r0.nomes && r0.nomes[0]) ? r0.nomes[0] : "SEM_NOME";
  const dayKey = d + "__" + String(first).replace(/\s+/g,"_");
  return {
    schema:"ERPIMPAR_ATIVIDADES_DIARIAS",
    version:6,
    status,
    dayKey,
    generatedAt: nowISO(),
    usuario: {
      nome: document.getElementById("userName").textContent || "Usu√°rio",
      email: document.getElementById("userEmail").textContent || "‚Äî"
    },
    rows
  };
}

function missingNames(rows){
  const done=new Set();
  rows.forEach(r=>{
    const hasAtiv=(r.atividades||"").trim().length>=3;
    (Array.isArray(r.nomes)?r.nomes:[]).forEach(n=>{ if(hasAtiv && n) done.add(n); });
  });
  return LIST_NOME.filter(n=>!done.has(n));
}

function refreshNameChecklist(){
  const rows=[...rowsEl.querySelectorAll(".row")].map(getRowData);
  const done=new Set();
  rows.forEach(r=>{
    const hasAtiv=(r.atividades||"").trim().length>=3;
    (Array.isArray(r.nomes)?r.nomes:[]).forEach(n=>{ if(hasAtiv && n) done.add(n); });
  });
  nameListEl.innerHTML="";
  LIST_NOME.forEach(nome=>{
    const ok=done.has(nome);
    const pill=document.createElement("div");
    pill.className="name-pill";
    pill.innerHTML = '<div class="nm">'+escapeHtml(nome)+'</div><div class="st '+(ok?'done':'todo')+'">'+(ok?'OK':'FALTA')+'</div>';
    nameListEl.appendChild(pill);
  });
}

function loadPendencias(){ const raw=localStorage.getItem(STORAGE_PEND); if(!raw) return {schema:"ERPIMPAR_PENDENCIAS",version:1,items:[]}; try{return JSON.parse(raw);}catch(e){return {schema:"ERPIMPAR_PENDENCIAS",version:1,items:[]};} }
function savePendencias(p){ localStorage.setItem(STORAGE_PEND, JSON.stringify(p)); }
function pushPendenciasFromFinal(payloadFinal){
  const pend=loadPendencias();
  const existing=new Set((pend.items||[]).map(x=>x.pendId));
  (payloadFinal.rows||[]).forEach(r=>{
    const pct=pctToNumber(r.percentual);
    if(pct===null || pct>=100) return;
    const pendId=payloadFinal.dayKey+'__'+r.id;
    if(existing.has(pendId)) return;
    pend.items.push({pendId,origemDayKey:payloadFinal.dayKey,createdAt:payloadFinal.generatedAt,data:r.data,nome:r.nome,nomes:r.nomes,obra:r.obra,carro:r.carro,percentual:r.percentual,atividades:r.atividades,motivo:r.motivo,status:"aberta"});
  });
  pend.updatedAt=nowISO(); savePendencias(pend);
}

function loadHist(){ const raw=localStorage.getItem(STORAGE_HIST); if(!raw) return {schema:"ERPIMPAR_ATIVIDADES_HIST",version:1,items:[]}; try{return JSON.parse(raw);}catch(e){return {schema:"ERPIMPAR_ATIVIDADES_HIST",version:1,items:[]};} }
function saveHist(h){ localStorage.setItem(STORAGE_HIST, JSON.stringify(h)); }
function pushHistory(payloadFinal){
  const hist = loadHist();
  const items = hist.items || [];

  // Evita sobrescrever o historico quando houver mais de um fechamento no mesmo dia (testes).
  // Cada fechamento ganha um ID unico.
  if(!payloadFinal.histId){
    payloadFinal.histId = (payloadFinal.dayKey || todayISO()) + "__" + (payloadFinal.generatedAt || nowISO());
  }

  // Se ja existir exatamente o mesmo fechamento, nao duplica.
  if(items.some(x => x.histId === payloadFinal.histId)){
    return;
  }

  // Mantem o ultimo fechamento do dia no topo, sem apagar os anteriores
  items.unshift(payloadFinal);

  hist.items = items.slice(0, 200);
  hist.updatedAt = nowISO();
  saveHist(hist);
}


async function renderHistoryServer(){
  const LS_SERVER_CACHE = "ERPIMPAR_ATIVIDADES_SERVER_CACHE_V1";
  const dt = (document.getElementById("histDate")?.value || "").trim();

  async function renderIds(ids){
    const list = Array.isArray(ids) ? ids : [];
    // normaliza (list.php pode retornar string[] ou objetos)
    let norm = list.map(x => (typeof x === 'string') ? x : (x && (x.id || x.filename)) ).filter(Boolean);
    // ordena desc (IDs geralmente come√ßam com YYYY-MM-DD)
    norm.sort((a,b)=> String(b).localeCompare(String(a)));
    if(dt) norm = norm.filter(id => String(id).startsWith(dt));

    histListEl.innerHTML = "";

    if(norm.length === 0){
      const empty = document.createElement('div');
      empty.style.color = 'var(--muted)';
      empty.style.fontSize = '12px';
      empty.textContent = dt ? 'Sem registros no servidor para esta data.' : 'Sem registros no servidor.';
      histListEl.appendChild(empty);
      return;
    }

    // limita para n√£o pesar
    norm.slice(0, 80).forEach(id => {
      const card=document.createElement("button");
      card.type="button";
      card.className="hist-item";
      card.style.textAlign="left";
      card.style.padding="12px 14px";
      card.style.borderRadius="14px";
      card.style.width="100%";
      card.style.border="1px solid rgba(148,163,184,.18)";
      card.style.background="rgba(2,6,23,.30)";
      card.style.cursor="pointer";
      card.style.color="inherit";

      const date = String(id).slice(0,10);
      card.innerHTML =
        '<div style="font-weight:1000;letter-spacing:.2px;">'+escapeHtml(date)+' - ATIVIDADES EXECUTADAS</div>'+
        '<div style="display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:6px;">'+
          '<span>ID: <b>'+escapeHtml(id)+'</b></span>'+
        '</div>';

      card.addEventListener("click", async()=>{
        try{
          const data = await withProcessing(async()=> await apiGet(id), "Buscando no servidor‚Ä¶", "PROCESSANDO DADOS......", 700);
          openPrintWindow(data);
        }catch(e){
          alertWarn("N√£o consegui abrir este registro do servidor.\n\n" + (e && e.message ? e.message : ""));
        }
      });
      histListEl.appendChild(card);
    });
  }

  try{
    const ids = await apiList();
    localStorage.setItem(LS_SERVER_CACHE, JSON.stringify(ids || []));
    await renderIds(ids);
  }catch(e){
    // fallback: cache do servidor (n√£o usa hist√≥rico local como fonte principal)
    try{
      const cached = JSON.parse(localStorage.getItem(LS_SERVER_CACHE) || '[]');
      await renderIds(cached);
    }catch(_){
      histListEl.innerHTML = '<div style="color:var(--muted);font-size:12px;">Servidor indispon√≠vel e sem cache.</div>';
    }
  }
}

function renderHistory(){
  const hist=loadHist();
  const items=hist.items||[];
  histListEl.innerHTML="";
  if(items.length===0){
    histListEl.innerHTML='<div style="color:var(--muted);font-size:12px;">Nenhum registro encontrado.</div>';
    return;
  }
  items.slice(0,30).forEach(p=>{
    const rows=p.rows||[];
    const date=(rows[0]&&rows[0].data)?rows[0].data:"‚Äî";
    const total=rows.length;
    const pend=rows.filter(r=>{ const pct=pctToNumber(r.percentual); return pct!==null && pct<100; }).length;

    const card=document.createElement("button");
    card.type="button";
    card.className="hist-item";
    card.style.textAlign="left";
    card.style.padding="12px 14px";
    card.style.borderRadius="14px";
    card.style.width="100%";
    card.style.border="1px solid rgba(148,163,184,.18)";
    card.style.background="rgba(2,6,23,.30)";
    card.style.cursor="pointer";
    card.style.color="inherit";

    card.innerHTML =
      '<div style="font-weight:1000;letter-spacing:.2px;">'+escapeHtml(date)+' - ATIVIDADES EXECUTADAS</div>'+
      '<div style="display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:6px;">'+
        '<span>Linhas: <b>'+total+'</b> - Pend√™ncias: <b>'+pend+'</b> &nbsp; Usu√°rio logado: <b>'+escapeHtml((p.usuario&&p.usuario.nome)||"Usu√°rio")+'</b></span>'+
      '</div>';

    card.addEventListener("click", async()=>{ await withProcessing(async()=>{}, "Buscando hist√≥rico‚Ä¶", "PROCESSANDO DADOS......", 700); openPrintWindow(p); });
    histListEl.appendChild(card);
  });
}

async function gerarPDF(){
  if(isLockedFinal()){
    alertWarn("Dia j√° foi fechado. Use o Hist√≥rico para abrir o PDF do dia.");
    return;
  }
  if(!validateAll("draft")){
    alertWarn("Preencha: Data, Nome(s), Obra, Atividade do dia e Carro (exceto F√âRIAS/FALTA/EMPRESA).");
    return;
  }
  const payload=getPayload("draft");
  const miss = missingNames(payload.rows);
  if(miss.length>0){
    alertWarn("N√ÉO PODE GERAR/IMPRIMIR.\n\nFaltam atividades para:\n- " + miss.join("\n- ") + "\n\nUse Obra = FALTA, F√âRIAS ou EMPRESA quando necess√°rio.");
    return;
  }
  localStorage.setItem(STORAGE_DRAFT, JSON.stringify(payload));
  await withProcessing(async()=>{}, "Gerando relat√≥rio‚Ä¶", "PROCESSANDO DADOS......", 900);
  openPrintWindow(payload);
}

async function finalizeDay(){
  if(isLockedFinal()){
    alertWarn("Dia j√° foi fechado. Use o Hist√≥rico para abrir o PDF do dia.");
    return;
  }
  if(!validateAll("final")){
    alertWarn("Para finalizar: Percentual obrigat√≥rio. Se Percentual < 100%, Motivo obrigat√≥rio.");
    return;
  }

  const payload=getPayload("final");
  const miss = missingNames(payload.rows);
  if(miss.length>0){
    alertWarn("N√£o pode finalizar.\n\nFaltam atividades para:\n- " + miss.join("\n- ") + "\n\nUse Obra = FALTA, F√âRIAS ou EMPRESA quando necess√°rio.");
    return;
  }

  // grava hist√≥rico + trava o dia
  localStorage.setItem(STORAGE_DRAFT, JSON.stringify(payload));
  pushPendenciasFromFinal(payload);
  
pushHistory(payload);
setLockedFinal(true);
  // Hist√≥rico: sempre do servidor (KingHost)
renderHistoryServer();
refreshNameChecklist();

  // prepara campos m√≠nimos pro servidor (save.php exige "date")
  try{
    payload.date = (payload.dayKey || payload.date || (payload.rows && payload.rows[0] && payload.rows[0].data) || todayStr());
  }catch(e){}
  payload.finalizedAt = payload.finalizedAt || new Date().toISOString();

  // meta r√°pida (pra lista do servidor ficar √∫til)
  try{
    const rows = Array.isArray(payload.rows) ? payload.rows : [];
    payload.total = payload.total ?? rows.length;
    payload.pend  = payload.pend  ?? rows.filter(r => {
      const pct = pctToNumber(r.percentual);
      return pct !== null && pct < 100;
    }).length;
  }catch(e){}

  // duplicar userName/userEmail no topo (list.php j√° tenta ler isso)
  try{
    const u = getUser();
    payload.userName  = payload.userName  || (u && u.nome  ? u.nome  : "");
    payload.userEmail = payload.userEmail || (u && u.email ? u.email : "");
  }catch(e){}

// tenta salvar no servidor (KingHost) ‚Äî se falhar, mant√©m local e avisa
try{
  await withProcessing(async()=>{ await apiSave(payload); }, "Salvando no servidor‚Ä¶", "PROCESSANDO DADOS......", 900);
}catch(e){
  alertWarn("Finalizado localmente, mas n√£o consegui salvar no servidor.\n\n" + (e && e.message ? e.message : "Verifique o caminho dos PHPs e permiss√µes."), "Servidor (KingHost)");
}

await withProcessing(async()=>{}, "Gerando relat√≥rio e fechando o dia‚Ä¶", "PROCESSANDO DADOS......", 1200);
  openPrintWindow(payload);
}


if(btnPdfClose) btnPdfClose.addEventListener("click", ()=>{ if(pdfModal) pdfModal.style.display="none"; });
if(btnPdfPrint) btnPdfPrint.addEventListener("click", ()=>{
  try{
    const w = pdfFrame.contentWindow;
    if(w) w.print();
  }catch(e){
    alertWarn("N√£o foi poss√≠vel imprimir o PDF.");
  }
});
if(pdfModal){ const bd = pdfModal.querySelector(".modal-backdrop"); if(bd) bd.addEventListener("click", ()=>{ pdfModal.style.display="none"; }); }

document.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && pdfModal && pdfModal.style.display==="block"){ pdfModal.style.display="none"; }});


function lockRows(isLocked){
  document.querySelectorAll(".rows .row").forEach(r=>{
    r.querySelectorAll("input,select,textarea,button").forEach(el=>{
      // allow viewing (no typing) after final; keep modal/historico working
      if(el.classList.contains("btn-del")) el.disabled = !!isLocked;
      if(el.classList.contains("iconbtn")) el.disabled = !!isLocked;
      if(el.closest(".modal")) return;
      // keep top-right menu principal clickable
      if(el.id==="btnBack") return;
      // keep historico items clickable
      if(el.classList.contains("hist-item")) return;
      // keep pdf modal buttons
      if(el.id==="btnPdfClose" || el.id==="btnPdfPrint") return;
      // lock all form controls in rows
      if(r.contains(el)) el.disabled = !!isLocked;
    });
  });
}

function isLockedFinal(){
  try{
    const last = loadLast();
    return !!(last && last.status === 'final');
  }catch(e){
    return false;
  }
}

function setLockedFinal(isLocked){
  const locked = !!isLocked;
  // top buttons
  if(btnAdd) btnAdd.disabled = locked;
  // N√£o usamos "disabled" em Gerar PDF/Finalizar para poder mostrar modal explicando.
  if(btnSave) btnSave.classList.toggle("soft-disabled", locked);
  if(btnFinalize) btnFinalize.classList.toggle("soft-disabled", locked);
  if(btnNewDay) btnNewDay.classList.toggle("soft-disabled", !locked);
  // lock row controls + delete
  document.querySelectorAll(".rows .row").forEach(row=>{
    row.querySelectorAll("input,select,textarea,button").forEach(el=>{
      // allow delete only when not locked
      if(el.classList.contains("btn-del") || el.classList.contains("iconbtn")) el.disabled = locked;
      else el.disabled = locked;
    });
  });
  // stepper: R (draft) / F (final)
  try{
    const dotF  = document.getElementById("dotF");
    if(locked){
      if(dotF) dotF.classList.add("is-final");
    }else{
      if(dotF) dotF.classList.remove("is-final");
    }
  }catch(e){}
}

function loadLast(){ const raw=localStorage.getItem(STORAGE_DRAFT); if(!raw) return null; try{return JSON.parse(raw);}catch(e){return null;} }
async function newDay(){
  const locked = isLockedFinal();
  if(!locked){
    alertWarn("ABERTURA DE NOVO DIA N√ÉO PERMITIDO, pois falta finalizar o dia anterior.");
    return;
  }

  await withProcessing(async()=>{}, "Preparando novo dia‚Ä¶", "PROCESSANDO DADOS......", 700);

  const payload = { usuario: getUser(), rows: [{data: todayStr(), nomes: [], obra:"", carro:"", atividade:"", percentual:"", motivo:""}] };
  localStorage.setItem(STORAGE_DRAFT, JSON.stringify(payload));
  setLockedFinal(false);
  renderInitial();
  renderHistoryServer();
  refreshNameChecklist();
}
function renderInitial(){
  rowsEl.innerHTML="";
  last = loadLast();
  if(last && Array.isArray(last.rows) && last.rows.length){ last.rows.forEach(r=>rowsEl.appendChild(newRow(r))); }
  else { rowsEl.appendChild(newRow({data:todayStr()})); }

  refreshNameChecklist();
  // Hist√≥rico: sempre do servidor (KingHost)

  // s√≥ permite "Novo dia" se o dia anterior estiver FINALIZADO
  const locked = !!(last && last.status==='final');
  setLockedFinal(locked);
  if(btnNewDay) btnNewDay.disabled = false;
}

btnAdd.addEventListener("click", ()=>{ rowsEl.appendChild(newRow({data:todayStr()})); refreshNameChecklist(); });
btnSave.addEventListener("click", gerarPDF);
btnFinalize.addEventListener("click", finalizeDay);
document.getElementById("btnVoltarMenu").addEventListener("click", ()=>{ window.location.href="/menu.html"; });
const histDateEl = document.getElementById("histDate");
if(histDateEl) histDateEl.addEventListener("change", ()=>{ renderHistoryServer(); });
renderInitial();
renderHistoryServer();
if(btnNewDay) btnNewDay.addEventListener("click", newDay);

</script>


<div id="pdfModal" class="modal" style="display:none;">
  <div class="modal-backdrop"></div>
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title" id="pdfTitle">PDF</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="btnPdfPrint" type="button">üñ®Ô∏è Imprimir</button>
        <button class="btn btn-secondary" id="btnPdfClose" type="button">‚úñ Fechar</button>
      </div>
    </div>
    <div class="modal-body">
      <iframe id="pdfFrame" title="PDF" style="width:100%;height:72vh;border:0;border-radius:14px;background:white;"></iframe>
    </div>
  </div>
</div>
<section id="rdoLive" data-basepath="https://api.erpimpar.com.br/atividades/rdo/rdo_get.php?slug=" style="max-width:1180px;margin:0 auto 24px auto;padding:0 18px;">
  <div class="card" style="margin-top:16px;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
      <div>
        <div class="title" style="margin:0;">RDO ao vivo</div>
        <div class="hint" style="margin:4px 0 0 0;">WhatsApp ‚Üí Grupos monitorados (somente texto). √öltimos 7 dias.</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div id="rdoStatus" style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);">
          <span style="width:10px;height:10px;border-radius:50%;background:#2bd27f;display:inline-block;"></span>
          <span>ok</span>
        </div>
        <button class="btn btn-secondary" id="btnRdoRefresh" type="button">‚ü≥ ATUALIZAR</button>
      </div>
    </div>

    <div style="margin-top:12px;">
      <div id="rdoGrid" style="display:grid;grid-template-columns:repeat(4, minmax(220px, 1fr));gap:12px;max-height:220px;overflow:auto;padding-right:6px;"></div>
      <div id="rdoEmpty" style="display:none;color:var(--muted);font-size:12px;margin-top:10px;">Sem arquivos ainda (aguardando agente gravar os JSONs).</div>
    </div>
  </div>
</section>  
<script src="rdo_grupos.js"></script>
</body>
</html>
