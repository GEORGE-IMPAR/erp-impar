<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Consulta de Documentos — ERP Ímpar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--accent:#2563eb;
      --border:#e5e7eb;--ok:#10b981;--bad:#ef4444
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"}
    .wrap{max-width:1000px;margin:24px auto;padding:0 14px}
    h1{margin:0 0 14px;font-size:22px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700}
    .bd{padding:14px 16px}
    .row{display:grid;grid-template-columns:160px 1fr 80px 64px;gap:8px;align-items:center}
    .row > div{display:flex;gap:6px;align-items:center}
    .input{width:100%;border:1px solid var(--border);padding:8px;border-radius:8px;background:#fff;font:inherit}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid transparent;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .status{font-size:12px;font-weight:700;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff}
    .ok{color:var(--ok);border-color:#a7f3d0;background:#ecfdf5}
    .bad{color:var(--bad);border-color:#fecaca;background:#fef2f2}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;vertical-align:top}
    th{font-size:12px;text-transform:uppercase;letter-spacing:.3px;color:var(--muted);text-align:left}
    td small{color:var(--muted)}
    a.link{color:var(--accent);text-decoration:none;font-weight:700}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--border);margin:10px 0}
    .foot{padding:10px 16px;color:var(--muted);font-size:12px}
    @media (max-width: 760px){
      .row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hd">Consulta de Documentos — ERP Ímpar</div>
      <div class="bd">
        <div class="row">
          <div>
            <div class="muted">Código (opcional)</div>
          </div>
          <div>
            <input id="inpCodigo" class="input" placeholder="Ex.: AC00025" />
          </div>
          <div class="muted" style="justify-content:flex-end">Token da API</div>
          <div>
            <input id="inpToken" class="input" placeholder="Cole seu token" />
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div class="muted">Endpoint detectado</div>
          <div>
            <input id="inpEndpoint" class="input" value="https://api.erpimpar.com.br/gerador/" />
          </div>
          <div id="statusBox" class="status">—</div>
          <div style="justify-content:flex-end">
            <button id="btnBuscar" class="btn">Buscar</button>
          </div>
        </div>

        <div class="hr"></div>

        <div style="overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th style="width:120px">Data</th>
                <th style="width:90px">Código</th>
                <th>Contratante</th>
                <th>Contratada</th>
                <th>Serviço</th>
                <th style="width:60px">PDF</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="6" class="muted">Nenhum registro encontrado.</td></tr>
            </tbody>
          </table>
        </div>

      </div>
      <div class="foot">Dica: você pode limitar pela coluna “Código”. O PDF agora abre via
        <code>gerador/pdf.php</code>, evitando bloqueios do .htaccess em <code>/storage/docs</code>.
      </div>
    </div>
  </div>

  <script>
    // ====== elementos ======
    const inpCodigo   = document.getElementById('inpCodigo');
    const inpToken    = document.getElementById('inpToken');
    const inpEndpoint = document.getElementById('inpEndpoint');
    const statusBox   = document.getElementById('statusBox');
    const btnBuscar   = document.getElementById('btnBuscar');
    const tbody       = document.getElementById('tbody');

    // ====== utils ======
    function baseApiOrigin(){
      const v = (inpEndpoint.value || '').trim();
      try{
        const u = new URL(v);
        return u.origin; // ex.: https://api.erpimpar.com.br
      }catch(e){
        return 'https://api.erpimpar.com.br';
      }
    }
    function joinUrl(base, path){
      return base.replace(/\/+$/,'') + '/' + path.replace(/^\/+/, '');
    }
    function fmtDateTime(iso){
      try{
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso || '';
        return d.toLocaleString('pt-BR');
      }catch(e){ return iso || ''; }
    }

    // ====== RESOLVER PDF (usa proxy pdf.php) ======
    function resolvePdfHref(row){
      const origin = baseApiOrigin();

      // Campos prováveis do backend
      let url  = (row.pdf_url || row.pdfUrl || row.url || '').toString().trim();
      let file = (row.pdf_file || row.pdfFile || row.file || '').toString().trim();

      // Se já veio absoluta, usa direto
      if (url && /^https?:\/\//i.test(url)) return url;

      // Se vier caminho relativo, tenta extrair o nome
      if (!file && url) {
        const p = url.split('/').pop();
        if (p && /\.pdf$/i.test(p)) file = p;
      }

      // Usa SEMPRE o proxy se não é absoluta (resolve 404 do storage/docs)
      return file ? joinUrl(origin, 'gerador/pdf.php') + '?f=' + encodeURIComponent(file) : '';
    }

    // ====== ping de status ======
    async function ping(){
      setStatus('Aguarde…');
      try{
        const origin = baseApiOrigin();
        const r = await fetch(joinUrl(origin, 'gerador/ping.php'), {cache:'no-store'});
        const j = await r.json().catch(()=>({}));
        if (j && j.ok) setStatus('OK', true);
        else setStatus('Falha', false);
      }catch(e){
        setStatus('Falha', false);
      }
    }
    function setStatus(text, ok){
      statusBox.textContent = text;
      statusBox.classList.remove('ok','bad');
      if (ok === true) statusBox.classList.add('ok');
      else if (ok === false) statusBox.classList.add('bad');
    }

    // ====== buscar ======
    async function buscar(){
      const token = (inpToken.value || '').trim();
      if (!token){
        alert('Informe o Token da API.'); return;
      }
      const codigo = (inpCodigo.value || '').trim();
      const origin = baseApiOrigin();
      const url = new URL(joinUrl(origin, 'gerador/list.php'));

      url.searchParams.set('token', token);
      if (codigo) url.searchParams.set('codigo', codigo);

      btnBuscar.disabled = true;
      tbody.innerHTML = `<tr><td colspan="6" class="muted">Carregando…</td></tr>`;

      try{
        const r = await fetch(url.toString(), {cache:'no-store'});
        const j = await r.json();
        renderRows(Array.isArray(j.rows) ? j.rows : []);
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">Erro ao buscar.</td></tr>`;
      }finally{
        btnBuscar.disabled = false;
      }
    }

    function renderRows(rows){
      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">Nenhum registro encontrado.</td></tr>`;
        return;
      }
      const html = rows.map(row => {
        const data   = fmtDateTime(row.created_at || row.createdAt || '');
        const codigo = (row.codigo || '').toString();
        const contA  = (row.contratante_nome || row.contratante || '').toString();
        const contB  = (row.contratada_nome  || row.contratada  || '').toString();
        const serv   = (row.servico || '').toString();
        const href   = resolvePdfHref(row);
        const link   = href ? `<a class="link" href="${href}" target="_blank" rel="noopener">abrir</a>` : `<span class="muted">—</span>`;
        return `
          <tr>
            <td>${data || '<span class="muted">—</span>'}</td>
            <td>${codigo || '<span class="muted">—</span>'}</td>
            <td>
              ${contA || '<span class="muted">—</span>'}
              ${row.contratante_doc ? `<br><small>${row.contratante_doc}</small>` : ''}
            </td>
            <td>
              ${contB || '<span class="muted">—</span>'}
              ${row.contratada_doc ? `<br><small>${row.contratada_doc}</small>` : ''}
            </td>
            <td>${serv || '<span class="muted">—</span>'}</td>
            <td>${link}</td>
          </tr>`;
      }).join('');
      tbody.innerHTML = html;
    }

    // eventos
    btnBuscar.addEventListener('click', buscar);
    window.addEventListener('load', ping);
  </script>
</body>
</html>
