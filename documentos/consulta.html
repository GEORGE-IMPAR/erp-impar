<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consulta de Documentos — ERP Ímpar</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --accent:#2563eb; --ok:#16a34a; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"}
    .wrap{max-width:980px;margin:28px auto;padding:0 14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .hd{padding:16px 18px;border-bottom:1px solid var(--border);font-weight:700;font-size:18px}
    .bd{padding:16px 18px}
    .row{display:grid;grid-template-columns:1fr 180px;gap:10px}
    .form{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    .form > div{display:flex;flex-direction:column}
    label{font-size:12px;color:var(--muted);margin-bottom:4px}
    input{border:1px solid var(--border);border-radius:8px;padding:10px 12px;font:inherit;outline:none;background:#fff}
    input[readonly]{background:#fafafa;color:#374151}
    .status{display:flex;align-items:center;gap:8px;font-weight:700}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px}
    .pill.ok{background:#dcfce7;color:#166534}
    .pill.bad{background:#fee2e2;color:#991b1b}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid transparent;background:var(--accent);color:#fff;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:.5;cursor:default}
    table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:top}
    th{background:#f8fafc;color:#0f172a;text-align:left;font-size:13px}
    tbody tr:hover{background:#fafafa}
    .muted{color:var(--muted)}
    .right{justify-self:end}
    .empty{padding:18px;text-align:center;color:var(--muted)}
    @media (max-width:760px){
      .form{grid-template-columns:1fr}
      .row{grid-template-columns:1fr}
      .right{justify-self:stretch}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hd">Consulta de Documentos — ERP Ímpar</div>
      <div class="bd">
        <div class="form">
          <div>
            <label for="codigo">Código (opcional)</label>
            <input id="codigo" placeholder="Ex.: AC00025" />
          </div>
          <div>
            <label for="token">Token da API</label>
            <!-- se quiser, deixe pre-preenchido -->
            <input id="token" value="8cce9abb2fd53b1cceaa93b9cecfd5384b2ea6fb931e8882c543cbd7d3663b77" />
          </div>
          <div>
            <label for="endpoint">Endpoint detectado</label>
            <input id="endpoint" readonly />
          </div>
          <div class="status">
            <label style="margin:0">Status</label>
            <span id="statusPill" class="pill bad">Verificando…</span>
          </div>
        </div>

        <div class="row" style="margin:8px 0 18px">
          <div></div>
          <button id="btnBuscar" class="btn right">Buscar</button>
        </div>

        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th style="width:160px">Data</th>
                <th style="width:110px">Código</th>
                <th>Contratante</th>
                <th>Contratada</th>
                <th>Serviço</th>
                <th style="width:70px">PDF</th>
              </tr>
            </thead>
            <tbody id="tabela-rows">
              <tr><td colspan="6" class="empty">Sem resultados ainda.</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG PADRÃO ======
    const DEFAULT_ENDPOINT = 'https://api.erpimpar.com.br/gerador/';

    // ====== UTIL ======
    function $(id){ return document.getElementById(id); }
    function originFromEndpoint(){
      const ep = $('endpoint').value.trim() || DEFAULT_ENDPOINT;
      try { return new URL(ep).origin; } catch(e){ return new URL(DEFAULT_ENDPOINT).origin; }
    }
    function fmt(s){ return (s ?? '').toString(); }
    function resolvePdfHref(row, baseOrigin){
     // tenta nos campos mais comuns
     let url = (row.pdf_url || row.pdfUrl || '').trim();

    if (url) {
    	// já é URL completa? usa como está
    if (/^https?:\/\//i.test(url)) return url;
    // começou com "/"? prefixa com a origem do endpoint (api.erpimpar.com.br)
    if (url.startsWith('/')) return baseOrigin + url;
    // veio só o nome do arquivo
    return `${baseOrigin}/storage/docs/${url}`;
   }

  // fallback pelo nome do arquivo
  const file = (row.pdf_file || row.pdfFile || row.file || '').trim();
  return file ? `${baseOrigin}/storage/docs/${file}` : '';}
    function setStatus(ok){
      const pill = $('statusPill');
      if(ok){ pill.textContent = 'OK'; pill.className = 'pill ok'; }
      else  { pill.textContent = 'Falha'; pill.className = 'pill bad'; }
    }
    function setEndpointDetected(){
      // se estiver hospedado no erpimpar.com.br, use o API oficial
      $('endpoint').value = DEFAULT_ENDPOINT;
    }

    // ====== PING ======
    async function ping(){
      const base = originFromEndpoint();
      try{
        const r = await fetch(`${base}/gerador/ping.php`, {cache:'no-store'});
        const j = await r.json();
        setStatus(!!j.ok);
        return !!j.ok;
      }catch(e){
        setStatus(false);
        return false;
      }
    }

    // ====== BUSCA ======
    async function buscar(){
      const token = $('token').value.trim();
      if(!token){ alert('Informe o token da API.'); return; }

      const ok = await ping();
      if(!ok){ alert('Endpoint indisponível no momento.'); return; }

      const base = originFromEndpoint();
      const code = $('codigo').value.trim();

      const fd = new FormData();
      fd.append('token', token);
      if(code) fd.append('codigo', code);

      $('btnBuscar').disabled = true;

      try{
        const r = await fetch(`${base}/gerador/list.php`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: fd
        });
        const j = await r.json();
        if(!j || !j.ok){ throw new Error('Resposta inválida do servidor'); }
        renderRows(j.rows || []);
      }catch(e){
        console.error(e);
        renderRows([]);
        alert('Erro ao consultar. Veja o console para detalhes.');
      }finally{
        $('btnBuscar').disabled = false;
      }
    }

    // ====== RENDER ======
    function renderRows(rows){
      const tb = $('tabela-rows');
      if(!rows || !rows.length){
        tb.innerHTML = `<tr><td colspan="6" class="empty">Nenhum registro encontrado.</td></tr>`;
        return;
      }
      const base = originFromEndpoint();
      tb.innerHTML = rows.map(r=>{
        const href = resolvePdfHref(r, base);
        return `
          <tr>
            <td class="muted">${fmt(r.created_at)}</td>
            <td>${fmt(r.codigo || r.code)}</td>
            <td>${fmt(r.contratante_nome)}</td>
            <td>${fmt(r.contratada_nome)}</td>
            <td>${fmt(r.servico)}</td>
            <td>
              ${href
                ? `<a href="${href}" target="_blank" rel="noopener">abrir</a>`
                : `<span class="muted">—</span>`}
            </td>
          </tr>`;
      }).join('');
    }

    // ====== INIT ======
    setEndpointDetected();
    ping();
    $('btnBuscar').addEventListener('click', buscar);
    $('codigo').addEventListener('keydown', (e)=>{ if(e.key==='Enter') buscar(); });
    $('token').addEventListener('keydown', (e)=>{ if(e.key==='Enter') buscar(); });
  </script>
</body>
</html>
