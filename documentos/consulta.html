<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta de Documentos — ERP Ímpar</title>
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#6b7280;--border:#e5e7eb;
      --primary:#2563eb;--primaryText:#fff;--chipOk:#10b981;--chipErr:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:980px;width:92%;margin:24px auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 0 rgba(0,0,0,.04);overflow:hidden}
    .hd{padding:16px 18px;border-bottom:1px solid var(--border);font-weight:700;font-size:18px}
    .bd{padding:16px 18px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .label{font-size:12px;text-transform:uppercase;letter-spacing:.3px;color:var(--muted)}
    .input{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font:15px/1.45 inherit;outline:none}
    .input:focus{border-color:var(--primary);box-shadow:0 0 0 2px #2563eb30}
    .grid3{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:end;margin-top:10px}
    .btn{padding:10px 14px;border-radius:8px;border:1px solid var(--primary);background:var(--primary);color:var(--primaryText);font-weight:700;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--primary)}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-weight:700}
    .ok{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .err{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    thead th{font-size:12px;letter-spacing:.3px;text-transform:uppercase;color:var(--muted);text-align:left;border-bottom:1px solid var(--border);padding:10px 8px}
    tbody td{border-bottom:1px solid var(--border);padding:10px 8px;vertical-align:top}
    a{color:var(--primary);text-decoration:none} a:hover{text-decoration:underline}
    .muted{color:var(--muted)}
    @media (max-width:760px){ .row{grid-template-columns:1fr} .grid3{grid-template-columns:1fr 1fr 1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hd">Consulta de Documentos — ERP Ímpar</div>
      <div class="bd">
        <div class="row">
          <div class="field">
            <div class="label">Código (opcional)</div>
            <input id="codigo" class="input" placeholder="Ex.: AC00025" />
          </div>
          <div class="field">
            <div class="label">Token da API</div>
            <input id="token" class="input" placeholder="Cole seu token" />
          </div>
        </div>

        <div class="grid3">
          <div class="field">
            <div class="label">Endpoint detectado</div>
            <input id="endpoint" class="input" readonly />
          </div>
          <div class="field">
            <div class="label">Status</div>
            <div id="status" class="chip muted">—</div>
          </div>
          <button id="btnBuscar" class="btn">Buscar</button>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width:140px">Data</th>
              <th style="width:120px">Código</th>
              <th>Contratante</th>
              <th>Contratada</th>
              <th>Serviço</th>
              <th style="width:80px">PDF</th>
            </tr>
          </thead>
          <tbody id="tbodyResults">
            <tr><td colspan="6" class="muted">Nenhum registro encontrado.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(function(){
  // ====== Config & preenchimentos iniciais ======
  const DEFAULT_ORIGIN = 'https://api.erpimpar.com.br';

  // Se a página do gerador já carregou este objeto, reaproveitamos token/origem
  const PATCH = (window.__ERP_SAVE_PATCH__ || {});

  const inpToken    = document.getElementById('token');
  const inpCodigo   = document.getElementById('codigo');
  const inpEndpoint = document.getElementById('endpoint');
  const chipStatus  = document.getElementById('status');
  const btnBuscar   = document.getElementById('btnBuscar');
  const tbody       = document.getElementById('tbodyResults');

  // Deriva a origem ("https://api.erpimpar.com.br") a partir do SAVE_URL, se existir
  function originFromSaveUrl(){
    try{
      if (PATCH.SAVE_URL){
        return new URL(PATCH.SAVE_URL).origin;
      }
    }catch(e){}
    return DEFAULT_ORIGIN;
  }

  // Preenche endpoint default (ex.: https://api.erpimpar.com.br/gerador/)
  function fillEndpoint(){
    const origin = originFromSaveUrl();
    inpEndpoint.value = origin + '/gerador/';
  }

  // Tenta puxar token do patch se existir
  function fillToken(){
    if (inpToken.value.trim()) return;
    if (PATCH.SAVE_TOKEN) inpToken.value = PATCH.SAVE_TOKEN;
  }

  // ====== Resolvedor robusto de link do PDF ======
  function baseApiOrigin(){
    const v = (inpEndpoint.value || '').trim();
    try{ return new URL(v).origin; } catch(e){ return DEFAULT_ORIGIN; }
  }

  function resolvePdfHref(row){
    const origin = baseApiOrigin();
    let url = (row.pdf_url || row.pdfUrl || row.url || '').toString().trim();

    if (url) {
      if (/^https?:\/\//i.test(url)) return url;                // absoluta
      if (url.startsWith('/'))       return origin + url;        // caminho absoluto no host
      if (url.includes('storage/'))  return `${origin}/${url.replace(/^\/+/, '')}`; // relativo que já indica storage/
    }

    // fallback usando o nome do arquivo
    const file = (row.pdf_file || row.pdfFile || row.file || '').toString().trim();
    return file ? `${origin}/storage/docs/${file.replace(/^\/+/, '')}` : '';
  }

  // ====== Utilidades de UI ======
  function setStatusOk(){ chipStatus.className='chip ok'; chipStatus.textContent='OK'; }
  function setStatusErr(msg){ chipStatus.className='chip err'; chipStatus.textContent=msg || 'Erro'; }

  function clearTable(){
    tbody.innerHTML = '<tr><td colspan="6" class="muted">Nenhum registro encontrado.</td></tr>';
  }

  function fmtDateTime(iso){
    if (!iso) return '—';
    const d = new Date(iso);
    if (isNaN(d)) return iso;
    const dd = d.toLocaleDateString('pt-BR');
    const hh = d.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    return `${dd}, ${hh}`;
  }

  // ====== Ping do endpoint ======
  async function checkStatus(){
    setStatusErr('Verificando…');
    const origin = baseApiOrigin();
    try{
      const r = await fetch(`${origin}/gerador/ping.php`, {cache:'no-store'});
      const j = await r.json().catch(()=>null);
      if (j && j.ok) setStatusOk(); else setStatusErr('Falha');
    }catch(e){
      setStatusErr('Indisponível');
    }
  }

  // ====== Busca ======
  async function buscar(){
    const token  = inpToken.value.trim();
    const codigo = inpCodigo.value.trim();
    const origin = baseApiOrigin();

    clearTable();
    if (!token){ setStatusErr('Informe o token'); return; }

    const fd = new FormData();
    fd.append('token', token);
    if (codigo) fd.append('codigo', codigo);

    try{
      const resp = await fetch(`${origin}/gerador/list.php`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        body: fd,
      });
      const data = await resp.json();

      const rows = (data && data.rows) ? data.rows : [];
      if (!rows.length){
        clearTable();
        return;
      }

      tbody.innerHTML = '';
      for (const row of rows){
        const tr = document.createElement('tr');

        const tdData  = document.createElement('td');
        const tdCod   = document.createElement('td');
        const tdCont1 = document.createElement('td');
        const tdCont2 = document.createElement('td');
        const tdServ  = document.createElement('td');
        const tdPdf   = document.createElement('td');

        tdData.textContent  = fmtDateTime(row.created_at);
        tdCod.textContent   = row.codigo || '—';
        tdCont1.innerHTML   = [
          (row.contratante_nome  || '—'),
          (row.contratante_doc   ? `<div class="muted">${row.contratante_doc}</div>` : '')
        ].join('');
        tdCont2.innerHTML   = [
          (row.contratada_nome  || '—'),
          (row.contratada_doc   ? `<div class="muted">${row.contratada_doc}</div>` : '')
        ].join('');
        tdServ.textContent   = row.servico || '—';

        const href = resolvePdfHref(row);
        tdPdf.innerHTML = href ? `<a href="${href}" target="_blank" rel="noopener">abrir</a>` : '—';

        tr.append(tdData, tdCod, tdCont1, tdCont2, tdServ, tdPdf);
        tbody.appendChild(tr);
      }
    }catch(e){
      setStatusErr('Erro na busca');
      clearTable();
    }
  }

  // ====== Init ======
  fillEndpoint();
  fillToken();
  checkStatus();

  btnBuscar.addEventListener('click', buscar);
  inpCodigo.addEventListener('keydown', (e)=>{ if(e.key==='Enter') buscar(); });
  inpToken .addEventListener('keydown', (e)=>{ if(e.key==='Enter') buscar(); });
})();
</script>
</body>
</html>
