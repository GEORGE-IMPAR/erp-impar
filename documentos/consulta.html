<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consulta de Documentos — ERP Ímpar</title>
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--txt:#0f172a;--muted:#64748b;--line:#e2e8f0;
      --accent:#2563eb;--accent-2:#1d4ed8;--ok:#16a34a;--bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:28px auto;padding:0 14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;box-shadow:0 4px 10px rgba(15,23,42,.06);overflow:hidden}
    .hd{padding:16px;border-bottom:1px solid var(--line);font-weight:700}
    .bd{padding:16px}
    .row{display:grid;grid-template-columns: 1fr 340px 120px 100px;gap:10px}
    .row + .row{margin-top:10px}
    .input, .btn{height:40px;font:15px/1.2 inherit;border-radius:8px;border:1px solid var(--line);padding:0 10px;background:#fff}
    .input[readonly]{background:#f8fafc;color:var(--muted)}
    .btn{background:var(--accent);color:#fff;border-color:transparent;font-weight:700;cursor:pointer}
    .btn:hover{background:var(--accent-2)}
    .status{display:inline-flex;align-items:center;justify-content:center;height:40px;padding:0 12px;border-radius:999px;font-weight:700}
    .ok{background:#ecfdf5;color:var(--ok);border:1px solid #86efac}
    .bad{background:#fef2f2;color:var(--bad);border:1px solid #fecaca}
    table{width:100%;border-collapse:collapse;margin-top:12px;border-top:1px solid var(--line)}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:top}
    th{font-size:13px;text-transform:uppercase;letter-spacing:.3px;color:var(--muted);text-align:left}
    td small{color:var(--muted)}
    a.link{color:var(--accent);text-decoration:none;font-weight:700}
    a.link:hover{text-decoration:underline}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hd">Consulta de Documentos — ERP Ímpar</div>
      <div class="bd">
        <div class="row">
          <input id="codigo" class="input" placeholder="Ex.: AC00025 (opcional)" />
          <input id="token"  class="input" placeholder="Token da API" />
          <div id="status" class="status muted" aria-live="polite">…</div>
          <button id="buscar" class="btn">Buscar</button>
        </div>
        <div class="row" style="grid-template-columns: 1fr 140px 1fr 1fr; margin-top:10px">
          <input id="endpoint" class="input" value="" readonly />
          <span class="muted" style="display:flex;align-items:center">Endpoint detectado</span>
          <span class="muted" style="display:flex;align-items:center">Dica: deixe o código em branco para listar tudo</span>
        </div>

        <div id="resultado" style="margin-top:14px">
          <div class="muted">Nenhum registro encontrado.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const API_BASE   = 'https://api.erpimpar.com.br';
    const ENDPOINT   = `${API_BASE}/gerador`;
    const LIST_URL   = `${ENDPOINT}/list.php`;
    const PDF_PROXY  = `${ENDPOINT}/pdf.php`; // <- abre o PDF pelo proxy (sem 404)
    const LS_TOKEN   = 'impar_api_token';

    // ========= UI =========
    const $ = (s) => document.querySelector(s);
    const inpCodigo  = $('#codigo');
    const inpToken   = $('#token');
    const badge      = $('#status');
    const btnBuscar  = $('#buscar');
    const out        = $('#resultado');
    const inpEndpt   = $('#endpoint');

    // Carrega token salvo
    inpToken.value = localStorage.getItem(LS_TOKEN) || '';

    // Detecta endpoint / status
    async function detectEndpoint(){
      inpEndpt.value = `${ENDPOINT}/`;
      try{
        const r = await fetch(`${ENDPOINT}/ping.php`, { cache:'no-store' });
        const j = await r.json().catch(()=> ({}));
        if (j && j.ok) setBadge('OK', true);
        else setBadge('Falha ao detectar endpoint', false);
      }catch(e){
        setBadge('Falha ao detectar endpoint', false);
      }
    }
    function setBadge(txt, ok){
      badge.textContent = txt;
      badge.className = 'status ' + (ok ? 'ok' : 'bad');
    }

    // Formata data
    function fmtDate(s){
      if(!s) return '—';
      try{
        const d = new Date(s);
        return d.toLocaleString('pt-BR');
      }catch(e){ return s; }
    }

    // Constrói o HREF do PDF usando o NOME do arquivo (sem caminho)
    function resolvePdfHref(row){
      const file = (row.pdf_file || '').trim();
      if (file) {
        return `${PDF_PROXY}?f=${encodeURIComponent(file)}`;
      }
      // fallback: se não houver pdf_file, tenta pdf_url (pode funcionar também)
      if (row.pdf_url) return row.pdf_url;
      return '#';
    }

    // Busca na API
    async function buscar(){
      const token = (inpToken.value || '').trim();
      if(!token){
        setBadge('Informe o token', false);
        return;
      }
      localStorage.setItem(LS_TOKEN, token);

      // monta URL (código opcional)
      const codigo = (inpCodigo.value || '').trim();
      const url = codigo
        ? `${LIST_URL}?codigo=${encodeURIComponent(codigo)}`
        : LIST_URL;

      setBadge('Buscando…', true);
      try{
        const r = await fetch(url, {
          headers: { 'Authorization': 'Bearer ' + token },
          cache: 'no-store'
        });
        const j = await r.json();
        if (!j || !j.ok) {
          setBadge('Falha na consulta', false);
          out.innerHTML = `<div class="muted">Nenhum registro encontrado.</div>`;
          return;
        }
        renderRows(j.rows || []);
        setBadge('OK', true);
      }catch(e){
        setBadge('Erro na consulta', false);
        out.innerHTML = `<div class="muted">Nenhum registro encontrado.</div>`;
      }
    }

    // Renderiza tabela
    function renderRows(rows){
      if(!rows.length){
        out.innerHTML = `<div class="muted">Nenhum registro encontrado.</div>`;
        return;
      }
      let html = `
        <table>
          <thead>
            <tr>
              <th style="width:140px">Data</th>
              <th style="width:100px">Código</th>
              <th>Contratante</th>
              <th>Contratada</th>
              <th>Serviço</th>
              <th style="width:70px">PDF</th>
            </tr>
          </thead>
          <tbody>
      `;
      for (const row of rows){
        const contratante = `
          <div>${row.contratante_nome||'—'}</div>
          <small>${row.contratante_doc||''}</small>
        `;
        const contratada = `
          <div>${row.contratada_nome||'—'}</div>
          <small>${row.contratada_doc||''}</small>
        `;
        html += `
          <tr>
            <td>${fmtDate(row.created_at)}</td>
            <td>${row.codigo||'—'}</td>
            <td>${contratante}</td>
            <td>${contratada}</td>
            <td>${row.servico||'—'}</td>
            <td><a class="link" href="${resolvePdfHref(row)}" target="_blank" rel="noopener">abrir</a></td>
          </tr>
        `;
      }
      html += `</tbody></table>`;
      out.innerHTML = html;
    }

    // Eventos
    btnBuscar.addEventListener('click', buscar);
    inpCodigo.addEventListener('keydown', (e)=>{ if(e.key==='Enter') buscar(); });
    inpToken.addEventListener('keydown',  (e)=>{ if(e.key==='Enter') buscar(); });

    // Init
    detectEndpoint();
  </script>
</body>
</html>
