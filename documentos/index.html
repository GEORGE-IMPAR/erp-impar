<!DOCTYPE html><html lang="pt-br"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gerador de documentos</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{--bg:#f1f1f1;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--border:#d1d5db;--capbg:#f3f4f6;--accent:#2ea3f2;--accentText:#fff;--disabled:#cbd5e1;--disabledText:#6b7280;--back:#f59e0b;--error:#ef4444}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 Arial,Helvetica,sans-serif}
.wrap{max-width:420px;margin:0 auto;padding:10px 10px 18px}
.stepper{display:flex;align-items:center;gap:10px;justify-content:center;margin:10px 0 6px}
.dot{width:18px;height:18px;border-radius:50%;border:1px solid #c7c7c7;color:#4b5563;display:flex;align-items:center;justify-content:center;font-size:11px;background:#fff}
.dot.done,.dot.active{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:700}
.dot.active{box-shadow:0 0 0 2px rgba(46,163,242,.35)}
.line{height:1px;flex:1;background:#c7c7c7;max-width:24px}
.line.done{background:var(--accent)}
.card{background:var(--card);border:1px solid var(--border);border-radius:3px;overflow:hidden;box-shadow:0 1px 0 rgba(0,0,0,.04)}
.header{padding:14px 14px 6px}
.title{font-family:Georgia,Times,serif;font-weight:600;font-size:22px;margin:0 0 6px;color:#111827}
.user{font-size:13px;color:#4b5563;margin:0 0 8px}
.code{font-size:13px;color:#374151;margin:0 0 8px}.code b{font-weight:700}
.body{padding:12px 14px 16px}.intro{color:#4b5563;margin:0 0 10px}
.block{border:1px solid var(--border);background:#fff;margin:0 0 12px}
.block .cap{background:var(--capbg);color:#6b7280;font-size:12px;text-transform:uppercase;letter-spacing:.3px;padding:6px 8px;border-bottom:1px solid var(--border)}
.block .cap .req{color:#dc2626}.block .content{padding:8px}
.textarea,.input,select{width:100%;border:1px solid #e5e7eb;background:#fff;padding:8px;border-radius:2px;font:15px/1.45 Arial,Helvetica,sans-serif;color:#111827;outline:none;transition:border-color .15s,box-shadow .15s}
.textarea{min-height:120px;resize:vertical}.textarea:focus,.input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(46,163,242,.25)}
.file{font:14px Arial,Helvetica,sans-serif}.error{color:var(--error);font-size:12px;margin-top:6px}.hint{font-size:12px;color:#6b7280;margin-top:6px}
.bar{position:sticky;bottom:0;left:0;right:0;text-align:center;padding:14px;font-weight:700;cursor:default;margin-top:10px;border-top:1px solid #e5e7eb}
.bar.disabled{background:var(--disabled);color:var(--disabledText)}.bar.enabled{background:var(--accent);color:var(--accentText);cursor:pointer}
.back{display:flex;align-items:center;gap:6px;justify-content:center;color:#111827;font-size:14px;margin-top:6px;cursor:pointer;user-select:none}.back .chev{color:var(--back)}
.hidden{display:none}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:50}
.sheet{width:100%;max-width:560px;background:#fff;border-radius:6px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:auto;max-height:90vh;border:1px solid #e5e7eb}
.sheet .hd{padding:14px 16px;border-bottom:1px solid #e5e7eb;font-weight:700}
.sheet .ct{padding:16px}
.actions{display:flex;gap:10px;padding:14px;border-top:1px solid #e5e7eb;justify-content:flex-end;flex-wrap:wrap}
.btn{padding:10px 14px;border-radius:4px;border:1px solid #e5e7eb;background:#fff;font-weight:700;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border-color:transparent}
/* PDF viewer overlay */
.viewer{position:fixed;inset:0;background:#111827cc;display:none;align-items:center;justify-content:center;z-index:60}
.viewer .panel{width:96%;max-width:760px;background:#fff;border-radius:6px;overflow:hidden;display:flex;flex-direction:column}
.viewer .panel .top{padding:10px;border-bottom:1px solid #e5e7eb;display:flex;gap:8px;justify-content:flex-end}
.viewer .panel iframe{width:100%;height:80vh;border:0}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#10b981;color:#fff;padding:12px 16px;border-radius:6px;font-weight:700;box-shadow:0 10px 20px rgba(0,0,0,.2);display:none;z-index:70}
</style>
</head>
<body>
<div class="wrap">

  <div class="stepper" id="stepper">
    <div class="dot" id="dot1">1</div><div class="line" id="line12"></div>
    <div class="dot" id="dot2">2</div><div class="line" id="line23"></div>
    <div class="dot" id="dot3">3</div><div class="line" id="line34"></div>
    <div class="dot" id="dot4">4</div><div class="line" id="line45"></div>
    <div class="dot" id="dot5">5</div>
  </div>

  <!-- TELA 1 -->
  <div class="card" id="screen1">
    <div class="header"><h2 class="title">Gerador de documentos</h2><p class="user">Rafael Ramos<br>rafael.@imparsistemas.com</p></div>
    <div class="body">
      <p class="intro">Informar a código do projeto no campo abaixo. Esse código será a chave para busca de documentos e utilizado para outras funcionalidades importantes na empresa</p>
      <div class="block"><div class="cap">CÓDIGO <span class="req">*</span></div><div class="content">
        <input id="codigo" class="input" placeholder="Digite o código do projeto" oninput="validate1()">
      </div></div>
    </div>
  </div>
  <div id="bar1" class="bar disabled" onclick="noop()">Continuar</div>

  <!-- TELA 2 -->
  <div class="card hidden" id="screen2">
    <div class="header"><h2 class="title">Gerador de documentos</h2><p class="user">Rafael Ramos<br>rafael.@imparsistemas.com</p><p class="code">Código Projeto: <b id="codigoVal">AC00025</b></p></div>
    <div class="body">
      <div class="block"><div class="cap">SERVIÇO <span class="req">*</span></div><div class="content"><textarea id="servico" class="textarea" placeholder="Digite o serviço do projeto" oninput="validate2()"></textarea></div></div>
      <div class="block"><div class="cap">ENDEREÇO DA OBRA <span class="req">*</span></div><div class="content"><input id="endereco" class="input" placeholder="Digite o endereço da obra" oninput="validate2()"></div></div>
    </div>
  </div>
  <div id="bar2" class="bar hidden disabled" onclick="noop()">Continuar</div>
  <div id="back2" class="back hidden" onclick="goTo(1)"><span class="chev">◀</span> Voltar</div>

  <!-- TELA 3 — CONTRATANTE -->
  <div class="card hidden" id="screen3">
    <div class="header"><h2 class="title">Gerador de documentos</h2><p class="user">Rafael Ramos<br>rafael.@imparsistemas.com</p><p class="code">Código Projeto: <b id="codigoVal3">AC00025</b></p></div>
    <div class="body">
      <div class="block"><div class="cap">DADOS DO CONTRATANTE</div></div>
      <div class="block"><div class="cap">NOME <span class="req">*</span></div><div class="content"><input id="nomeContratante" class="input" placeholder="Digite o nome do contratante" oninput="validate3()"></div></div>
      <div class="block"><div class="cap">CPF/CNPJ <span class="req">*</span></div><div class="content">
        <input id="docContratante" class="input" placeholder="Digite o CPF ou CNPJ do contratante" oninput="docInput(this); validate3()" onblur="docBlur(this); validate3()" onfocus="docFocus(this)">
        <div id="docContratanteErr" class="error hidden">Documento inválido</div>
      </div></div>
      <div class="block"><div class="cap">CONTATO <span class="req">*</span></div><div class="content"><input id="contatoContratante" class="input" placeholder="Digite o nome do responsável pela obra" oninput="validate3()"></div></div>

      <!-- CEP PRIMEIRO -->
      <div class="block"><div class="cap">CEP <span class="req">*</span></div><div class="content">
        <input id="cepContratante" class="input" placeholder="00000-000"
               oninput="cepOnInput(this)"
               onblur="cepOnBlur(this,'Contratante')"
               onchange="cepOnBlur(this,'Contratante')"
               onfocusout="cepOnBlur(this,'Contratante')">
        <div id="cepContratanteErr"  class="error hidden">CEP inválido</div>
        <div id="cepContratanteHint" class="hint hidden">Endereço preenchido pelo CEP.</div>
      </div></div>

      <!-- ENDEREÇO DETALHADO -->
      <div class="block"><div class="cap">ENDEREÇO DO CONTRATANTE <span class="req">*</span></div>
        <div class="content">
          <input id="logradouroContratante" class="input" placeholder="Logradouro (rua, avenida, etc.)" oninput="validate3()" style="margin-bottom:8px">
          <input id="numeroContratante" class="input" placeholder="Número" oninput="validate3()" style="margin-bottom:8px">
          <input id="bairroContratante" class="input" placeholder="Bairro" oninput="validate3()" style="margin-bottom:8px">
          <input id="cidadeContratante" class="input" placeholder="Cidade" oninput="validate3()" style="margin-bottom:8px">
          <select id="ufContratante" class="input" onchange="validate3()" style="margin-bottom:8px">
            <option value="">UF</option>
            <option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option><option>CE</option><option>DF</option>
            <option>ES</option><option>GO</option><option>MA</option><option>MT</option><option>MS</option><option>MG</option><option>PA</option>
            <option>PB</option><option>PR</option><option>PE</option><option>PI</option><option>RJ</option><option>RN</option><option>RS</option>
            <option>RO</option><option>RR</option><option>SC</option><option>SP</option><option>SE</option><option>TO</option>
          </select>
          <input id="complementoContratante" class="input" placeholder="Complemento (opcional)" oninput="validate3()">
        </div>
      </div>

      <div class="block"><div class="cap">TELEFONE DO CONTATO <span class="req">*</span></div><div class="content"><input id="telefoneContratante" class="input" placeholder="(00)00000-0000" oninput="maskPhoneSimple(this); validate3()"><div id="telContratanteErr" class="error hidden">Telefone inválido — formato (99)99999-9999</div></div></div>
      <div class="block"><div class="cap">E-MAIL <span class="req">*</span></div><div class="content"><input id="emailContratante" class="input" placeholder="Digite o e-mail do contato" oninput="validate3()"><div id="emailContratanteErr" class="error hidden">E-mail inválido</div></div></div>
    </div>
  </div>
  <div id="bar3" class="bar hidden disabled" onclick="noop()">Continuar</div>
  <div id="back3" class="back hidden" onclick="goTo(2)"><span class="chev">◀</span> Voltar</div>

  <!-- TELA 4 — CONTRATADA -->
  <div class="card hidden" id="screen4">
    <div class="header"><h2 class="title">Gerador de documentos</h2><p class="user">Rafael Ramos<br>rafael.@imparsistemas.com</p><p class="code">Código Projeto: <b id="codigoVal4">AC00025</b></p></div>
    <div class="body">
      <div class="block"><div class="cap">DADOS DA CONTRATADA</div></div>
      <div class="block"><div class="cap">NOME <span class="req">*</span></div><div class="content"><input id="nomeContratada" class="input" placeholder="Digite o nome da contratada" oninput="validate4()"></div></div>
      <div class="block"><div class="cap">CPF/CNPJ <span class="req">*</span></div><div class="content">
        <input id="docContratada" class="input" placeholder="Digite o CPF ou CNPJ da contratada" oninput="docInput(this); validate4()" onblur="docBlur(this); validate4()" onfocus="docFocus(this)">
        <div id="docContratadaErr" class="error hidden">Documento inválido</div>
      </div></div>
      <div class="block"><div class="cap">CONTATO <span class="req">*</span></div><div class="content"><input id="contatoContratada" class="input" placeholder="Digite o nome do responsável pela obra" oninput="validate4()"></div></div>

      <!-- CEP PRIMEIRO -->
      <div class="block"><div class="cap">CEP <span class="req">*</span></div><div class="content">
        <input id="cepContratada" class="input" placeholder="00000-000"
               oninput="cepOnInput(this)"
               onblur="cepOnBlur(this,'Contratada')"
               onchange="cepOnBlur(this,'Contratada')"
               onfocusout="cepOnBlur(this,'Contratada')">
        <div id="cepContratadaErr"  class="error hidden">CEP inválido</div>
        <div id="cepContratadaHint" class="hint hidden">Endereço preenchido pelo CEP.</div>
      </div></div>

      <!-- ENDEREÇO DETALHADO -->
      <div class="block"><div class="cap">ENDEREÇO DA CONTRATADA <span class="req">*</span></div>
        <div class="content">
          <input id="logradouroContratada" class="input" placeholder="Logradouro (rua, avenida, etc.)" oninput="validate4()" style="margin-bottom:8px">
          <input id="numeroContratada" class="input" placeholder="Número" oninput="validate4()" style="margin-bottom:8px">
          <input id="bairroContratada" class="input" placeholder="Bairro" oninput="validate4()" style="margin-bottom:8px">
          <input id="cidadeContratada" class="input" placeholder="Cidade" oninput="validate4()" style="margin-bottom:8px">
          <select id="ufContratada" class="input" onchange="validate4()" style="margin-bottom:8px">
            <option value="">UF</option>
            <option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option><option>CE</option><option>DF</option>
            <option>ES</option><option>GO</option><option>MA</option><option>MT</option><option>MS</option><option>MG</option><option>PA</option>
            <option>PB</option><option>PR</option><option>PE</option><option>PI</option><option>RJ</option><option>RN</option><option>RS</option>
            <option>RO</option><option>RR</option><option>SC</option><option>SP</option><option>SE</option><option>TO</option>
          </select>
          <input id="complementoContratada" class="input" placeholder="Complemento (opcional)" oninput="validate4()">
        </div>
      </div>

      <div class="block"><div class="cap">TELEFONE DO CONTATO <span class="req">*</span></div><div class="content"><input id="telefoneContratada" class="input" placeholder="(00)00000-0000" oninput="maskPhoneSimple(this); validate4()"><div id="telContratadaErr" class="error hidden">Telefone inválido — formato (99)99999-9999</div></div></div>
      <div class="block"><div class="cap">E-MAIL <span class="req">*</span></div><div class="content"><input id="emailContratada" class="input" placeholder="Digite o e-mail do contato" oninput="validate4()"><div id="emailContratadaErr" class="error hidden">E-mail inválido</div></div></div>
    </div>
  </div>
  <div id="bar4" class="bar hidden disabled" onclick="noop()">Continuar</div>
  <div id="back4" class="back hidden" onclick="goTo(3)"><span class="chev">◀</span> Voltar</div>

  <!-- TELA 5 -->
  <div class="card hidden" id="screen5">
    <div class="header"><h2 class="title">Gerador de documentos</h2><p class="user">Rafael Ramos<br>rafael.@imparsistemas.com</p><p class="code">Código Projeto: <b id="codigoVal5">AC00025</b></p></div>
    <div class="body">
      <div class="block"><div class="cap">CLÁUSULAS <span class="req">*</span></div><div class="content"><textarea id="clausulas" class="textarea" placeholder="Digite as cláusulas do documento" oninput="validate5()"></textarea></div></div>
      <div class="block"><div class="cap">CONDIÇÕES DE PAGAMENTO <span class="req">*</span></div><div class="content"><textarea id="condicoes" class="textarea" placeholder="Digite as condições de pagamento" oninput="validate5()"></textarea></div></div>
      <div class="block"><div class="cap">VALOR <span class="req">*</span></div><div class="content"><input id="valor" class="input" placeholder="R$ 0,00" oninput="maskCurrency(this); setValorExtenso(); validate5()"><div class="hint">Formato: R$ 0.000,00</div></div></div>
      <div class="block"><div class="cap">VALOR POR EXTENSO <span class="req">*</span></div><div class="content"><input id="valorExtenso" class="input" placeholder="Gerado automaticamente a partir do valor" readonly><div class="hint">Preenchido automaticamente.</div></div></div>
      <div class="block"><div class="cap">PRAZO (em dias) <span class="req">*</span></div><div class="content"><input id="prazo" class="input" type="number" inputmode="numeric" min="1" step="1" placeholder="Digite o prazo de pagamento (dias)" oninput="validate5()"></div></div>
      <div class="block"><div class="cap">DATA POR EXTENSO <span class="req">*</span></div><div class="content"><input id="dataExtenso" class="input" placeholder="Escolha uma data" readonly onclick="openDatePicker()"><input id="dataPicker" type="date" class="hidden" onchange="fillDateExtenso()"><div class="hint">Clique no campo para abrir o calendário e preencher por extenso.</div></div></div>
      <div class="block"><div class="cap">LOGO DA EMPRESA</div><div class="content"><input id="logo" class="file" type="file" accept="image/*"><div id="logoInfo" class="intro" style="margin-top:6px">Anexar logo do contratante</div></div></div>
    </div>
  </div>
  <div id="bar5" class="bar hidden disabled" onclick="noop()">Continuar</div>
  <div id="back5" class="back hidden" onclick="goTo(4)"><span class="chev">◀</span> Voltar</div>

</div>

<!-- Toast de sucesso -->
<div id="toast" class="toast">Documento cadastrado com sucesso!</div>

<!-- Viewer PDF -->
<div id="viewer" class="viewer">
  <div class="panel">
    <div class="top">
      <button class="btn" onclick="downloadLastPdf()">Baixar PDF</button>
      <button class="btn primary" onclick="shareLastPdf()">Compartilhar</button>
      <button class="btn" onclick="closeViewer()">Fechar</button>
    </div>
    <iframe id="pdfFrame"></iframe>
  </div>
</div>

<script>
function noop(){} function onlyDigits(s){return (s||'').replace(/\D+/g,'');}

// CEP
function cepOnInput(el){ el.value = onlyDigits(el.value).slice(0,8); const e=document.getElementById(el.id+'Err'); const h=document.getElementById(el.id+'Hint'); if(e) e.classList.add('hidden'); if(h) h.classList.add('hidden'); }
async function cepOnBlur(el, prefix){
  const d = onlyDigits(el.value).slice(0,8);
  el.value = d.length<=5 ? d : (d.substring(0,5)+'-'+d.substring(5));
  const ok = d.length===8; const e=document.getElementById(el.id+'Err'); const h=document.getElementById(el.id+'Hint'); if(e) e.classList.toggle('hidden',ok); if(h) h.classList.add('hidden'); if(!ok) return;
  try{ const r=await fetch('https://viacep.com.br/ws/'+d+'/json/'); const data=await r.json(); if(!data.erro){ const map={logradouro:'logradouro',bairro:'bairro',localidade:'cidade',uf:'uf'}; for(const k in map){ const t=document.getElementById(map[k]+prefix); if(t) t.value=data[k]||''; } if(h) h.classList.remove('hidden'); } }catch(err){}
  if(prefix==='Contratante') validate3(); else validate4();
}

// CPF/CNPJ
function formatCPF(d){d=onlyDigits(d).slice(0,11);return d.replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2');}
function formatCNPJ(d){d=onlyDigits(d).slice(0,14);return d.replace(/(\d{2})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1/$2').replace(/(\d{4})(\d{1,2})$/,'$1-$2');}
function isValidCPF(cpf){cpf=onlyDigits(cpf);if(cpf.length!==11||/(\d)\1{10}/.test(cpf))return false;let s=0;for(let i=0;i<9;i++)s+=+cpf[i]*(10-i);let d1=11-(s%11);d1=d1>9?0:d1;if(+cpf[9]!==d1)return false;s=0;for(let i=0;i<10;i++)s+=+cpf[i]*(11-i);let d2=11-(s%11);d2=d2>9?0:d2;return +cpf[10]===d2;}
function isValidCNPJ(cnpj){cnpj=onlyDigits(cnpj);if(cnpj.length!==14||/(\d)\1{13}/.test(cnpj))return false;const calc=(b)=>{let s=0,p=b.length-7;for(let i=b.length;i>=1;i--){s+=+b[b.length-i]*p--;if(p<2)p=9}return s%11<2?0:11-(s%11)};const b=cnpj.slice(0,12);const d1=calc(b);if(+cnpj[12]!==d1)return false;const d2=calc(b+d1);return +cnpj[13]===d2;}
function docFocus(inp){inp.value=onlyDigits(inp.value);document.getElementById(inp.id+'Err').classList.add('hidden');}
function docInput(inp){inp.value=onlyDigits(inp.value).slice(0,14);document.getElementById(inp.id+'Err').classList.add('hidden');}
function docBlur(inp){const d=onlyDigits(inp.value);let ok=false;if(d.length===11){ok=isValidCPF(d);inp.value=formatCPF(d);}else if(d.length===14){ok=isValidCNPJ(d);inp.value=formatCNPJ(d);}document.getElementById(inp.id+'Err').classList.toggle('hidden',ok);}

// Telefone
function formatPhoneSimple(d){d=onlyDigits(d).slice(0,11);if(d.length<=6)return d.replace(/(\d{2})(\d{0,5})/,'($1)$2');return d.replace(/(\d{2})(\d{5})(\d{0,4})/,'($1)$2-$3');}
function maskPhoneSimple(inp){const d=onlyDigits(inp.value).slice(0,11);inp.value=formatPhoneSimple(d);const id=inp.id.replace('telefone','tel')+'Err';document.getElementById(id).classList.toggle('hidden',d.length===11||d.length===0);}

// Valor + por extenso
function formatCurrencyBR(cents){const r=Math.floor(cents/100),c=(cents%100).toString().padStart(2,'0');const rr=r.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');return 'R$ '+rr+','+c;}
function maskCurrency(inp){let d=onlyDigits(inp.value);if(!d){inp.value='';return;}inp.value=formatCurrencyBR(parseInt(d,10));}
const UNIDADES=['zero','um','dois','três','quatro','cinco','seis','sete','oito','nove'];
const DEZ_A_DEZENOVE=['dez','onze','doze','treze','catorze','quinze','dezesseis','dezessete','dezoito','dezenove'];
const DEZENAS=['','dez','vinte','trinta','quarenta','cinquenta','sessenta','setenta','oitenta','noventa'];
const CENTENAS=['','cento','duzentos','trezentos','quatrocentos','quinhentos','seiscentos','setecentos','oitocentos','novecentos'];
function trioPorExtenso(n){n%=1000;if(n===0)return'';if(n===100)return'cem';const c=Math.floor(n/100),d=Math.floor((n%100)/10),u=n%10;let p=[];if(c)p.push(CENTENAS[c]);if(d===1)p.push(DEZ_A_DEZENOVE[u]);else{if(d)p.push(DEZENAS[d]);if(u)p.push(UNIDADES[u]);}return p.join(' e ');}
function inteiroBR(n){if(n===0)return'zero';const g=[{v:n%1000,n:''},{v:Math.floor(n/1000)%1000,n:'mil'},{v:Math.floor(n/1e6)%1000,n:'milhão',p:'milhões'},{v:Math.floor(n/1e9)%1000,n:'bilhão',p:'bilhões'}];let partes=[];for(let i=g.length-1;i>=0;i--){const x=g[i];if(!x.v)continue;const ext=trioPorExtenso(x.v);if(i===1){partes.push(x.v===1?'mil':ext+' mil');continue;}if(i>=2){partes.push(ext+' '+(x.v===1?x.n:x.p));continue;}if(i===0)partes.push(ext);}return partes.join(' ');}
function valorExt(cents){const r=Math.floor(cents/100),c=cents%100;let t='';if(r>0)t+=inteiroBR(r)+' '+(r===1?'real':'reais');if(c>0){const s=inteiroBR(c)+' '+(c===1?'centavo':'centavos');t=t? t+' e '+s : s;}return t||'zero real';}
function setValorExtenso(){const d=onlyDigits(document.getElementById('valor').value);document.getElementById('valorExtenso').value=d?valorExt(parseInt(d,10)):'';}

// Data
function openDatePicker(){ const p=document.getElementById('dataPicker'); if(p.showPicker) p.showPicker(); else p.click(); }
function fillDateExtenso(){ const p=document.getElementById('dataPicker'); if(!p.value) return; const d=new Date(p.value+'T12:00:00'); document.getElementById('dataExtenso').value=d.toLocaleDateString('pt-BR',{day:'numeric',month:'long',year:'numeric'}); validate5(); }

// Email
function isValidEmail(e){ return /^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i.test(e); }

// Navegação
function updateStepper(step){[1,2,3,4,5].forEach(n=>{const d=document.getElementById('dot'+n);d.classList.remove('done','active');if(n<step)d.classList.add('done');if(n===step)d.classList.add('active');});[['line12',2],['line23',3],['line34',4],['line45',5]].forEach(([id,to])=>{const el=document.getElementById(id);if(step>=to)el.classList.add('done');else el.classList.remove('done');});}
function showOnly(id){['screen1','screen2','screen3','screen4','screen5'].forEach(s=>document.getElementById(s).classList.add('hidden'));document.getElementById(id).classList.remove('hidden');['bar1','bar2','bar3','bar4','bar5','back2','back3','back4','back5'].forEach(i=>{const el=document.getElementById(i);if(el)el.classList.add('hidden');});}
function goTo(step){updateStepper(step);showOnly('screen'+step);const codigo=(document.getElementById('codigo').value||'').trim()||'AC00025';['codigoVal','codigoVal3','codigoVal4','codigoVal5'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=codigo;});const bar=document.getElementById('bar'+step);if(bar)bar.classList.remove('hidden');const back=document.getElementById('back'+step);if(back)back.classList.remove('hidden');const fn=window['validate'+step];if(typeof fn==='function')fn();}

// Validadores
function addrOk(prefix){return ['logradouro','numero','bairro','cidade','uf'].every(k => document.getElementById(k+prefix).value.trim());}
function validate1(){const v=document.getElementById('codigo').value.trim(),b=document.getElementById('bar1');if(v){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=()=>goTo(2);}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}updateStepper(1);}
function validate2(){const s=document.getElementById('servico').value.trim(),e=document.getElementById('endereco').value.trim(),b=document.getElementById('bar2');if(s&&e){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=()=>goTo(3);}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}}
function validate3(){const d=document.getElementById('docContratante').value,t=document.getElementById('telefoneContratante').value,m=document.getElementById('emailContratante').value.trim(),cep=document.getElementById('cepContratante').value.trim();const docOk=(onlyDigits(d).length===11&&isValidCPF(d))||(onlyDigits(d).length===14&&isValidCNPJ(d));const telOk=onlyDigits(t).length===11;const emailOk=isValidEmail(m);const cepOk=onlyDigits(cep).length===8;document.getElementById('emailContratanteErr').classList.toggle('hidden',emailOk||m.length===0);document.getElementById('telContratanteErr').classList.toggle('hidden',telOk||onlyDigits(t).length===0);document.getElementById('cepContratanteErr').classList.toggle('hidden',cepOk||onlyDigits(cep).length===0);const ok=['nomeContratante','contatoContratante'].every(id=>document.getElementById(id).value.trim())&&docOk&&telOk&&emailOk&&cepOk&&addrOk('Contratante');const b=document.getElementById('bar3');if(ok){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=()=>goTo(4);}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}}
function validate4(){const d=document.getElementById('docContratada').value,t=document.getElementById('telefoneContratada').value,m=document.getElementById('emailContratada').value.trim(),cep=document.getElementById('cepContratada').value.trim();const docOk=(onlyDigits(d).length===11&&isValidCPF(d))||(onlyDigits(d).length===14&&isValidCNPJ(d));const telOk=onlyDigits(t).length===11;const emailOk=isValidEmail(m);const cepOk=onlyDigits(cep).length===8;document.getElementById('emailContratadaErr').classList.toggle('hidden',emailOk||m.length===0);document.getElementById('telContratadaErr').classList.toggle('hidden',telOk||onlyDigits(t).length===0);document.getElementById('cepContratadaErr').classList.toggle('hidden',cepOk||onlyDigits(cep).length===0);const ok=['nomeContratada','contatoContratada'].every(id=>document.getElementById(id).value.trim())&&docOk&&telOk&&emailOk&&cepOk&&addrOk('Contratada');const b=document.getElementById('bar4');if(ok){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=()=>goTo(5);}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}}
function isValidCurrencyInput(){return /R\$\s\d{1,3}(\.\d{3})*,\d{2}$/.test(document.getElementById('valor').value);}
function validate5(){setValorExtenso();const ok=isValidCurrencyInput()&&parseInt(document.getElementById('prazo').value,10)>0&&document.getElementById('dataExtenso').value.trim().length>0&&['clausulas','condicoes','valorExtenso'].every(id=>document.getElementById(id).value.trim());const b=document.getElementById('bar5');if(ok){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=finalizeStep5;}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}}

// Sucesso + PDF
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';setTimeout(()=>t.style.display='none',2500);}
function composeEndereco(prefix){const log=document.getElementById('logradouro'+prefix).value||'',num=document.getElementById('numero'+prefix).value||'',comp=document.getElementById('complemento'+prefix).value||'',bai=document.getElementById('bairro'+prefix).value||'',cid=document.getElementById('cidade'+prefix).value||'',uf=document.getElementById('uf'+prefix).value||'',cep=(document.getElementById('cep'+prefix).value||'');let base=log+', '+num+(comp?(' - '+comp):'');base+=' — '+bai+' — '+cid+'/'+uf+' — CEP '+cep;return base;}

async function createPdfBlob(){
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF({unit:'pt',format:'a4'}), pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight(), M=40; let y=M;
  function h1(t){pdf.setFont('Helvetica','bold');pdf.setFontSize(16);pdf.text(t,pageW/2,y,{align:'center'});y+=22;pdf.setDrawColor(200);pdf.line(M,y,pageW-M,y);y+=14;}
  function lv(l,v){pdf.setFont('Helvetica','bold');pdf.setFontSize(11);const lines=pdf.splitTextToSize(l+' '+v,pageW-2*M);pdf.text(lines,M,y);y+=lines.length*14;}
  function block(l,v){pdf.setFont('Helvetica','bold');pdf.setFontSize(12);pdf.text(l,M,y);y+=14;pdf.setFont('Helvetica','normal');pdf.setFontSize(11);const lines=pdf.splitTextToSize(v,pageW-2*M);for(const line of lines){if(y>pageH-M){pdf.addPage();y=M;}pdf.text(line,M,y);y+=14;}y+=6;}
  function ensure(h){if(y+h>pageH-M){pdf.addPage();y=M;}}
  const get=(id)=>(document.getElementById(id).value||'').trim();
  const endC=(p)=>composeEndereco(p);

  const file=document.getElementById('logo').files[0];
  if(file){const dataUrl=await new Promise(res=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.readAsDataURL(file);}); pdf.addImage(dataUrl,'PNG',pageW-140,M,100,60);}

  h1('Resumo do Documento');
  lv('Código do Projeto:', get('codigo')); y+=6;
  block('Serviço:', get('servico'));
  lv('Endereço da obra:', get('endereco')); y+=8;

  pdf.setFont('Helvetica','bold');pdf.setFontSize(13);ensure(24);pdf.text('CONTRATANTE',M,y);y+=16;pdf.setDrawColor(220);pdf.line(M,y,pageW-M,y);y+=10;
  lv('Nome:', get('nomeContratante'));
  lv('CPF/CNPJ:', get('docContratante'));
  lv('Endereço:', endC('Contratante'));
  lv('Contato:', get('contatoContratante'));
  lv('Telefone:', get('telefoneContratante'));
  lv('E-mail:', get('emailContratante')); y+=8;

  pdf.setFont('Helvetica','bold');pdf.setFontSize(13);ensure(24);pdf.text('CONTRATADA',M,y);y+=16;pdf.setDrawColor(220);pdf.line(M,y,pageW-M,y);y+=10;
  lv('Nome:', get('nomeContratada'));
  lv('CPF/CNPJ:', get('docContratada'));
  lv('Endereço:', endC('Contratada'));
  lv('Contato:', get('contatoContratada'));
  lv('Telefone:', get('telefoneContratada'));
  lv('E-mail:', get('emailContratada')); y+=8;

  pdf.setFont('Helvetica','bold');pdf.setFontSize(13);ensure(24);pdf.text('CONDIÇÕES',M,y);y+=16;pdf.setDrawColor(220);pdf.line(M,y,pageW-M,y);y+=10;
  lv('Valor:', get('valor')+' ('+get('valorExtenso')+')');
  lv('Prazo:', get('prazo')+' dias');
  lv('Data:', get('dataExtenso'));
  block('Condições de pagamento:', get('condicoes'));
  block('Cláusulas:', get('clausulas'));

  return pdf.output('blob');
}

function finalizeStep5(){
  showToast('Documento cadastrado com sucesso!');
  // após o toast, oferecemos abrir o PDF automaticamente
  setTimeout(async ()=>{
    const blob = await createPdfBlob();
    openViewerWithBlob(blob);
  }, 800);
}

let __pdfBlob=null, __pdfUrl=null;
function openViewerWithBlob(blob){
  __pdfBlob = blob;
  if(__pdfUrl) URL.revokeObjectURL(__pdfUrl);
  __pdfUrl = URL.createObjectURL(blob);
  document.getElementById('pdfFrame').src = __pdfUrl;
  document.getElementById('viewer').style.display='flex';
}
function closeViewer(){
  document.getElementById('viewer').style.display='none';
}
function downloadLastPdf(){
  if(!__pdfBlob) return;
  const a=document.createElement('a');
  a.href=__pdfUrl;
  a.download='documento.pdf';
  document.body.appendChild(a); a.click(); a.remove();
}
async function shareLastPdf(){
  if(!__pdfBlob){ showToast('Gere o PDF primeiro'); return; }
  const file = new File([__pdfBlob], 'documento.pdf', {type:'application/pdf'});
  try{
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({files:[file], title:'Documento', text:'Envio do documento em PDF'});
    }else if(navigator.share){
      // fallback: tenta compartilhar com URL blob (alguns apps não aceitam)
      await navigator.share({title:'Documento', text:'Envio do documento em PDF', url: __pdfUrl});
    }else{
      // última opção: abre WhatsApp com texto e orienta baixar
      const txt = encodeURIComponent('Documento gerado. Baixe aqui: '+location.href);
      window.open('https://wa.me/?text='+txt,'_blank');
    }
  }catch(e){
    console.log('Compartilhamento cancelado/erro', e);
  }
}

// init
updateStepper(1);validate1();
</script>
</body></html>
