<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerador de documentos</title>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#f1f1f1;--card:#ffffff;--text:#1f2937;--border:#d1d5db;--capbg:#f3f4f6;
      --accent:#2ea3f2;--accentText:#fff;--disabled:#cbd5e1;--disabledText:#6b7280;--error:#ef4444
    }
    :root[data-theme="dark"]{
      --bg:#0b1220;--card:#0f172a;--text:#e5e7eb;--border:#1f2a40;--capbg:#0c1830;
      --accent:#3b82f6;--accentText:#fff;--disabled:#334155;--disabledText:#a3b1c6;--error:#f87171
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 Arial,Helvetica,sans-serif}
    .wrap{width:100%;max-width:clamp(420px, 90vw, 860px);margin:0 auto;padding:10px 10px 18px}
    .topbar{display:flex;justify-content:flex-end;gap:8px;margin-top:6px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;font-weight:700;cursor:pointer}
    .btn.primary{background:#2ea3f2;color:#fff;border-color:transparent}
    .btn.warn{background:#fee2e2;color:#b91c1c;border-color:#fecaca}

    @media (min-width: 768px){ .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px} }
    .stepper{display:flex;align-items:center;gap:10px;justify-content:center;margin:10px 0 6px;flex-wrap:wrap}
    .dot{width:18px;height:18px;border-radius:50%;border:1px solid #c7c7c7;color:#4b5563;display:flex;align-items:center;justify-content:center;font-size:11px;background:#fff}
    .dot.done,.dot.active{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:700}
    .dot.active{box-shadow:0 0 0 2px rgba(46,163,242,.35)}
    .line{height:1px;flex:1;background:#c7c7c7;max-width:24px}
    .line.done{background:var(--accent)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:6px;overflow:hidden;box-shadow:0 1px 0 rgba(0,0,0,.04)}
    .header{padding:14px 14px 6px}
    .title{font-family:Georgia,Times,serif;font-weight:600;font-size:22px;margin:0 0 6px;color:#111827}
    .user{font-size:13px;color:#4b5563;margin:0 0 8px}
    .code{font-size:13px;color:#374151;margin:0 0 8px}.code b{font-weight:700}
    .body{padding:12px 14px 16px}
    .block{border:1px solid var(--border);background:#fff;margin:0 0 12px;border-radius:4px;overflow:hidden}
    .block .cap{background:var(--capbg);color:#6b7280;font-size:12px;text-transform:uppercase;letter-spacing:.3px;padding:6px 8px;border-bottom:1px solid var(--border)}
    .block .cap .req{color:#dc2626}.block .content{padding:8px}
    .textarea,.input,select{width:100%;border:1px solid #e5e7eb;background:#fff;padding:8px;border-radius:4px;font:15px/1.45 Arial,Helvetica,sans-serif;color:#111827;outline:none;transition:border-color .15s,box-shadow .15s}
    .textarea{min-height:120px;resize:vertical}.textarea:focus,.input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(46,163,242,.25)}
    .file{font:14px Arial,Helvetica,sans-serif}.error{color:var(--error);font-size:12px;margin-top:6px}.hint{font-size:12px;color:#6b7280;margin-top:6px}
    .bar{position:sticky;bottom:0;left:0;right:0;text-align:center;padding:14px;font-weight:700;cursor:default;margin-top:10px;border-top:1px solid #e5e7eb}
    .bar.disabled{background:var(--disabled);color:var(--disabledText)}.bar.enabled{background:var(--accent);color:var(--accentText);cursor:pointer}
    .back{display:flex;align-items:center;gap:6px;justify-content:center;color:#111827;font-size:14px;margin-top:6px;cursor:pointer;user-select:none}.back .chev{color:#f59e0b}
    .hidden{display:none}

    /* Consulta modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:60}
    .modal .box{width:100%;max-width:900px;background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);border:1px solid #e5e7eb;overflow:hidden;display:flex;flex-direction:column;max-height:90vh}
    .modal .box .hd{padding:16px;border-bottom:1px solid #e5e7eb;font-weight:700;display:flex;align-items:center;gap:10px}
    .modal .box .bd{padding:16px;overflow:auto}
    .modal .box .ft{padding:12px 16px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap}

    .viewer{position:fixed;inset:0;background:#111827cc;display:none;align-items:center;justify-content:center;z-index:65}
    .viewer .panel{width:96%;max-width:900px;background:#fff;border-radius:6px;overflow:hidden;display:flex;flex-direction:column}
    .viewer .panel .top{padding:10px;border-bottom:1px solid #e5e7eb;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    .viewer .panel iframe{width:100%;height:80vh;border:0}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#10b981;color:#fff;padding:12px 16px;border-radius:6px;font-weight:700;box-shadow:0 10px 20px rgba(0,0,0,.2);display:none;z-index:70}
  </style>

  <!-- 1) Coletor de dados pr√≥prio (inclui clausulas/condicoes e metadados) -->
  <script>
    window.collectFormData = function() {
      const get = (id) => (document.getElementById(id)?.value || '').trim();
      // carrega usu√°rio: primeiro tenta /assets/usuario_doc.json, depois localStorage (fallback)
      const getUser = () => {
        try { return JSON.parse(localStorage.getItem('impar_user') || 'null'); } catch(e){ return null; }
      };
      const __userCache = { loaded:false, data:null };
      (async () => {
        if (__userCache.loaded) return;
        try {
          const r = await fetch('/assets/usuario_doc.json', { cache: 'no-store' });
          if (r.ok) {
            const j = await r.json();
            __userCache.data = { Nome: j.nome || j.Nome || '', Email: j.email || j.Email || '' };
          } else {
            const u = getUser();
            __userCache.data = u ? { Nome: u.Nome, Email: u.Email } : null;
          }
        } catch(e) {
          const u = getUser();
          __userCache.data = u ? { Nome: u.Nome, Email: u.Email } : null;
        } finally {
          __userCache.loaded = true;
          // Atualiza cabe√ßalhos existentes (.user) se houver
          const label = __userCache.data ? (__userCache.data.Nome + '<br>' + __userCache.data.Email) : 'Usu√°rio<br>usuario@empresa.com';
          document.querySelectorAll('.user').forEach(p=>{ p.innerHTML = label; });
        }
      })();

      const u = __userCache.data || getUser();
      const end = (p) => {
        const log = get('logradouro' + p), num = get('numero' + p),
              comp = get('complemento' + p), bai = get('bairro' + p),
              cid = get('cidade' + p), uf = get('uf' + p), cep = get('cep' + p);
        return `${log}, ${num}${comp?(' - '+comp):''} ‚Äî ${bai} ‚Äî ${cid}/${uf} ‚Äî CEP ${cep}`;
      };
      return {
        codigo: get('codigo'),
        servico: get('servico'),
        enderecoObra: get('endereco'),
        contratante: {
          nome: get('nomeContratante'),
          cpfCnpj: get('docContratante'),
          endereco: end('Contratante'),
          contato: get('contatoContratante'),
          telefone: get('telefoneContratante'),
          email: get('emailContratante')
        },
        contratada: {
          nome: get('nomeContratada'),
          cpfCnpj: get('docContratada'),
          endereco: end('Contratada'),
          contato: get('contatoContratada'),
          telefone: get('telefoneContratada'),
          email: get('emailContratada')
        },
        valor: get('valor'),
        valorExtenso: get('valorExtenso'),
        prazo: get('prazo'),
        dataExtenso: get('dataExtenso'),
        clausulas: get('clausulas'),
        condicoesPagamento: get('condicoes'),
        operador: u ? { nome: (u.Nome||u.nome||''), email: (u.Email||u.email||'') } : {}
      };
    };
  </script>

  <!-- 2) Patch de salvamento do ERP (usa o collectFormData acima) -->

  <script src="/documentos/erp_save_patch_flatfile.js"></script>

<script>
// ========== Helpers de resposta segura ==========
async function safeJsonFromResponse(resp) {
  const text = await resp.text();
  try { return JSON.parse(text); }
  catch {
    console.error('Resposta n√£o-JSON do servidor:', text);
    return {
      ok: false,
      success: false,
      status: resp.status,
      error: 'Resposta n√£o-JSON do servidor (poss√≠vel erro PHP no save.php).',
      raw: text
    };
  }
}

// Monta e envia o POST para o save.php (usa __ERP_SAVE_PATCH__ se existir)
async function saveToServerWithFallback(pdfBlob, pdfName, updateFlag=false) {
  const patch      = window.__ERP_SAVE_PATCH__ || {};
  const SAVE_URL   = patch.SAVE_URL   || 'https://api.erpimpar.com.br/gerador/save.php';
  const SAVE_TOKEN = patch.SAVE_TOKEN || '';

  const fd = new FormData();
  fd.append('pdf', new File([pdfBlob], pdfName, { type:'application/pdf' }));
  // MUITO IMPORTANTE: enviar "dados" como string JSON
  fd.append('dados', JSON.stringify(window.collectFormData()));
  if (updateFlag) fd.append('update', '1');

  const headers = {};
  if (SAVE_TOKEN) headers['Authorization'] = 'Bearer ' + SAVE_TOKEN;

  const resp = await fetch(SAVE_URL, { method:'POST', headers, body: fd });
  return await safeJsonFromResponse(resp);
}
</script>


</head>
<body>
  <div class="wrap">

    <!-- TOPO: Tema / Limpar / Fechar -->
    <div class="topbar">
      <button class="btn" id="themeBtn" onclick="toggleTheme()">üåô Tema</button>
      <button class="btn warn" onclick="limparDados()">Limpar dados</button>
      <button class="btn" onclick="fecharFluxo()">Fechar</button>
    </div>

    <!-- STEPPER -->
    <div class="stepper" id="stepper">
      <div class="dot" id="dot1">1</div><div class="line" id="line12"></div>
      <div class="dot" id="dot2">2</div><div class="line" id="line23"></div>
      <div class="dot" id="dot3">3</div><div class="line" id="line34"></div>
      <div class="dot" id="dot4">4</div><div class="line" id="line45"></div>
      <div class="dot" id="dot5">5</div>
    </div>

    <!-- ========== TELA 1 ========== -->
    <div class="card" id="screen1">
      <div class="header">
        <h2 class="title">Gerador de documentos</h2>
        <p class="user" id="userInfo1">Usu√°rio</p>
      </div>
      <div class="body">
        <p>Informar a c√≥digo do projeto no campo abaixo. Esse c√≥digo ser√° a chave para busca de documentos e utilizado para outras funcionalidades importantes na empresa</p>

        <div class="block">
          <div class="cap">C√ìDIGO <span class="req">*</span></div>
          <div class="content">
            <input id="codigo" class="input" placeholder="Digite o c√≥digo do projeto" oninput="validate1()">
          </div>
        </div>

        <button class="btn primary" onclick="abrirConsulta()">Pesquisar documentos cadastrados</button>
      </div>
    </div>
    <div id="bar1" class="bar disabled" onclick="noop()">Continuar</div>

    <!-- ========== TELA 2 ========== -->
    <div class="card hidden" id="screen2">
      <div class="header">
        <h2 class="title">Gerador de documentos</h2>
        <p class="user" id="userInfo2">Usu√°rio</p>
        <p class="code">C√≥digo Projeto: <b id="codigoVal">AC00025</b></p>
      </div>
      <div class="body">
        <div class="block">
          <div class="cap">SERVI√áO <span class="req">*</span></div>
          <div class="content">
            <textarea id="servico" class="textarea" placeholder="Digite o servi√ßo do projeto" oninput="validate2()"></textarea>
          </div>
        </div>
        <div class="block">
          <div class="cap">ENDERE√áO DA OBRA <span class="req">*</span></div>
          <div class="content">
            <input id="endereco" class="input" placeholder="Digite o endere√ßo da obra" oninput="validate2()">
          </div>
        </div>
      </div>
    </div>
    <div id="bar2" class="bar hidden disabled" onclick="noop()">Continuar</div>
    <div id="back2" class="back hidden" onclick="goTo(1)"><span class="chev">‚óÄ</span> Voltar</div>

    <!-- ========== TELA 3 ========== -->
    <div class="card hidden" id="screen3">
      <div class="header">
        <h2 class="title">Gerador de documentos</h2>
        <p class="user" id="userInfo3">Usu√°rio</p>
        <p class="code">C√≥digo Projeto: <b id="codigoVal3">AC00025</b></p>
      </div>
      <div class="body">
        <div class="block"><div class="cap">DADOS DO CONTRATANTE</div></div>
        <div class="grid-2">
          <div class="block"><div class="cap">NOME <span class="req">*</span></div><div class="content"><input id="nomeContratante" class="input" placeholder="Digite o nome do contratante" oninput="validate3()"></div></div>
          <div class="block"><div class="cap">CPF/CNPJ <span class="req">*</span></div><div class="content">
            <input id="docContratante" class="input" placeholder="Digite o CPF ou CNPJ do contratante" oninput="docInput(this); validate3()" onblur="docBlur(this); validate3()" onfocus="docFocus(this)">
            <div id="docContratanteErr" class="error hidden">Documento inv√°lido</div>
          </div></div>
        </div>

        <div class="block"><div class="cap">CONTATO <span class="req">*</span></div><div class="content"><input id="contatoContratante" class="input" placeholder="Digite o nome do respons√°vel pela obra" oninput="validate3()"></div></div>

        <div class="grid-2">
          <div class="block"><div class="cap">CEP <span class="req">*</span></div><div class="content">
            <input id="cepContratante" class="input" placeholder="00000-000" oninput="cepOnInput(this)" onblur="cepOnBlur(this,'Contratante')" onchange="cepOnBlur(this,'Contratante')" onfocusout="cepOnBlur(this,'Contratante')">
            <div id="cepContratanteErr"  class="error hidden">CEP inv√°lido</div>
            <div id="cepContratanteHint" class="hint hidden">Endere√ßo preenchido pelo CEP.</div>
          </div></div>
          <div class="block"><div class="cap">N√öMERO <span class="req">*</span></div><div class="content"><input id="numeroContratante" class="input" placeholder="N√∫mero" oninput="validate3()"></div></div>
        </div>

        <div class="grid-2">
          <div class="block"><div class="cap">LOGRADOURO <span class="req">*</span></div><div class="content"><input id="logradouroContratante" class="input" placeholder="Rua / Avenida" oninput="validate3()"></div></div>
          <div class="block"><div class="cap">COMPLEMENTO</div><div class="content"><input id="complementoContratante" class="input" placeholder="Opcional" oninput="validate3()"></div></div>
        </div>

        <div class="grid-2">
          <div class="block"><div class="cap">BAIRRO <span class="req">*</span></div><div class="content"><input id="bairroContratante" class="input" placeholder="Bairro" oninput="validate3()"></div></div>
          <div class="block"><div class="cap">CIDADE <span class="req">*</span></div><div class="content"><input id="cidadeContratante" class="input" placeholder="Cidade" oninput="validate3()"></div></div>
        </div>

        <div class="block"><div class="cap">UF <span class="req">*</span></div><div class="content">
          <select id="ufContratante" class="input" onchange="validate3()">
            <option value="">UF</option>
            <option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option><option>CE</option><option>DF</option>
            <option>ES</option><option>GO</option><option>MA</option><option>MT</option><option>MS</option><option>MG</option><option>PA</option>
            <option>PB</option><option>PR</option><option>PE</option><option>PI</option><option>RJ</option><option>RN</option><option>RS</option>
            <option>RO</option><option>RR</option><option>SC</option><option>SP</option><option>SE</option><option>TO</option>
          </select>
        </div></div>

        <div class="block"><div class="cap">TELEFONE DO CONTATO <span class="req">*</span></div><div class="content"><input id="telefoneContratante" class="input" placeholder="(00)00000-0000" oninput="maskPhoneSimple(this); validate3()"><div id="telContratanteErr" class="error hidden">Telefone inv√°lido ‚Äî formato (99)99999-9999</div></div></div>
        <div class="block"><div class="cap">E-MAIL <span class="req">*</span></div><div class="content"><input id="emailContratante" class="input" placeholder="Digite o e-mail do contato" oninput="validate3()"><div id="emailContratanteErr" class="error hidden">E-mail inv√°lido</div></div></div>
      </div>
    </div>
    <div id="bar3" class="bar hidden disabled" onclick="noop()">Continuar</div>
    <div id="back3" class="back hidden" onclick="goTo(2)"><span class="chev">‚óÄ</span> Voltar</div>

    <!-- ========== TELA 4 ========== -->
    <div class="card hidden" id="screen4">
      <div class="header">
        <h2 class="title">Gerador de documentos</h2>
        <p class="user" id="userInfo4">Usu√°rio</p>
        <p class="code">C√≥digo Projeto: <b id="codigoVal4">AC00025</b></p>
      </div>
      <div class="body">
        <div class="block"><div class="cap">DADOS DA CONTRATADA</div></div>
        <div class="grid-2">
          <div class="block"><div class="cap">NOME <span class="req">*</span></div><div class="content"><input id="nomeContratada" class="input" placeholder="Digite o nome da contratada" oninput="validate4()"></div></div>
          <div class="block"><div class="cap">CPF/CNPJ <span class="req">*</span></div><div class="content">
            <input id="docContratada" class="input" placeholder="Digite o CPF ou CNPJ da contratada" oninput="docInput(this); validate4()" onblur="docBlur(this); validate4()" onfocus="docFocus(this)">
            <div id="docContratadaErr" class="error hidden">Documento inv√°lido</div>
          </div></div>
        </div>

        <div class="block"><div class="cap">CONTATO <span class="req">*</span></div><div class="content"><input id="contatoContratada" class="input" placeholder="Digite o nome do respons√°vel pela obra" oninput="validate4()"></div></div>

        <div class="grid-2">
          <div class="block"><div class="cap">CEP <span class="req">*</span></div><div class="content">
            <input id="cepContratada" class="input" placeholder="00000-000" oninput="cepOnInput(this)" onblur="cepOnBlur(this,'Contratada')" onchange="cepOnBlur(this,'Contratada')" onfocusout="cepOnBlur(this,'Contratada')">
            <div id="cepContratadaErr"  class="error hidden">CEP inv√°lido</div>
            <div id="cepContratadaHint" class="hint hidden">Endere√ßo preenchido pelo CEP.</div>
          </div></div>
          <div class="block"><div class="cap">N√öMERO <span class="req">*</span></div><div class="content"><input id="numeroContratada" class="input" placeholder="N√∫mero" oninput="validate4()"></div></div>
        </div>

        <div class="grid-2">
          <div class="block"><div class="cap">LOGRADOURO <span class="req">*</span></div><div class="content"><input id="logradouroContratada" class="input" placeholder="Rua / Avenida" oninput="validate4()"></div></div>
          <div class="block"><div class="cap">COMPLEMENTO</div><div class="content"><input id="complementoContratada" class="input" placeholder="Opcional" oninput="validate4()"></div></div>
        </div>

        <div class="grid-2">
          <div class="block"><div class="cap">BAIRRO <span class="req">*</span></div><div class="content"><input id="bairroContratada" class="input" placeholder="Bairro" oninput="validate4()"></div></div>
          <div class="block"><div class="cap">CIDADE <span class="req">*</span></div><div class="content"><input id="cidadeContratada" class="input" placeholder="Cidade" oninput="validate4()"></div></div>
        </div>

        <div class="block"><div class="cap">UF <span class="req">*</span></div><div class="content">
          <select id="ufContratada" class="input" onchange="validate4()">
            <option value="">UF</option>
            <option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option><option>CE</option><option>DF</option>
            <option>ES</option><option>GO</option><option>MA</option><option>MT</option><option>MS</option><option>MG</option><option>PA</option>
            <option>PB</option><option>PR</option><option>PE</option><option>PI</option><option>RJ</option><option>RN</option><option>RS</option>
            <option>RO</option><option>RR</option><option>SC</option><option>SP</option><option>SE</option><option>TO</option>
          </select>
        </div></div>

        <div class="block"><div class="cap">TELEFONE DO CONTATO <span class="req">*</span></div><div class="content"><input id="telefoneContratada" class="input" placeholder="(00)00000-0000" oninput="maskPhoneSimple(this); validate4()"><div id="telContratadaErr" class="error hidden">Telefone inv√°lido ‚Äî formato (99)99999-9999</div></div></div>
        <div class="block"><div class="cap">E-MAIL <span class="req">*</span></div><div class="content"><input id="emailContratada" class="input" placeholder="Digite o e-mail do contato" oninput="validate4()"><div id="emailContratadaErr" class="error hidden">E-mail inv√°lido</div></div></div>
      </div>
    </div>
    <div id="bar4" class="bar hidden disabled" onclick="noop()">Continuar</div>
    <div id="back4" class="back hidden" onclick="goTo(3)"><span class="chev">‚óÄ</span> Voltar</div>

    <!-- ========== TELA 5 ========== -->
    <div class="card hidden" id="screen5">
      <div class="header">
        <h2 class="title">Gerador de documentos</h2>
        <p class="user" id="userInfo5">Usu√°rio</p>
        <p class="code">C√≥digo Projeto: <b id="codigoVal5">AC00025</b></p>
      </div>
      <div class="body">
        <div class="grid-2">
          <div class="block"><div class="cap">CL√ÅUSULAS <span class="req">*</span></div><div class="content"><textarea id="clausulas" class="textarea" placeholder="Digite as cl√°usulas do documento" oninput="validate5()"></textarea></div></div>
          <div class="block"><div class="cap">CONDI√á√ïES DE PAGAMENTO <span class="req">*</span></div><div class="content"><textarea id="condicoes" class="textarea" placeholder="Digite as condi√ß√µes de pagamento" oninput="validate5()"></textarea></div></div>
        </div>

        <div class="grid-2">
          <div class="block"><div class="cap">VALOR <span class="req">*</span></div><div class="content"><input id="valor" class="input" placeholder="R$ 0,00" oninput="maskCurrency(this); setValorExtenso(); validate5()"><div class="hint">Formato: R$ 0.000,00</div></div></div>
          <div class="block"><div class="cap">VALOR POR EXTENSO <span class="req">*</span></div><div class="content"><input id="valorExtenso" class="input" placeholder="Gerado automaticamente a partir do valor" readonly></div></div>
        </div>

        <div class="grid-2">
          <div class="block"><div class="cap">PRAZO (em dias) <span class="req">*</span></div><div class="content"><input id="prazo" class="input" type="number" inputmode="numeric" min="1" step="1" placeholder="Digite o prazo de pagamento (dias)" oninput="validate5()"></div></div>
          <div class="block"><div class="cap">DATA POR EXTENSO <span class="req">*</span></div><div class="content"><input id="dataExtenso" class="input" placeholder="Escolha uma data" readonly onclick="openDatePicker()"><input id="dataPicker" type="date" class="hidden" onchange="fillDateExtenso()"></div></div>
        </div>

        <div class="block"><div class="cap">LOGO DA EMPRESA</div><div class="content"><input id="logo" class="file" type="file" accept="image/*" onchange="showLogoName(this)"><div id="logoInfo" class="hint" style="margin-top:6px">Anexar logo do contratante</div></div></div>
      </div>
    </div>
    <div id="bar5" class="bar hidden disabled" onclick="noop()">Continuar</div>
    <div id="back5" class="back hidden" onclick="goTo(4)"><span class="chev">‚óÄ</span> Voltar</div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Modal de sucesso -->
    <div id="successModal" class="modal">
      <div class="box">
        <div class="hd">Documento cadastrado com sucesso!</div>
        <div class="bd">Seu documento foi gerado. Voc√™ pode visualiz√°-lo agora em PDF para compartilhar.</div>
        <div class="ft">
          <button class="btn" onclick="closeSuccess()">Fechar</button>
          <button class="btn primary" onclick="visualizarPdf()">Visualizar documento</button>
        </div>
      </div>
    </div>

    <!-- Viewer PDF -->
    <div id="viewer" class="viewer">
      <div class="panel">
        <div class="top">
          <button class="btn" onclick="downloadLastPdf()">Baixar PDF</button>
          <button class="btn primary" onclick="shareLastPdf()">Compartilhar</button>
          <button class="btn" onclick="closeViewer()">Fechar</button>
        </div>
        <iframe id="pdfFrame"></iframe>
      </div>
    </div>

    <!-- Consulta Modal -->
    <div id="consultaModal" class="modal">
      <div class="box">
        <div class="hd">Consulta de Documentos ‚Äî ERP √çmpar</div>
        <div class="bd">
          <div class="block">
            <div class="cap">C√≥digo (opcional)</div>
            <div class="content" style="display:flex;gap:8px;align-items:center;">
              <input id="qCodigo" class="input" placeholder="Ex.: AC00025" style="flex:1">
              <button class="btn primary" onclick="buscarConsulta()">Buscar</button>
            </div>
          </div>

          <div class="block">
            <div class="cap">Digite o c√≥digo do projeto.</div>
            <div class="content" style="overflow:auto;">
              <table style="width:100%;border-collapse:collapse">
                <thead>
                  <tr style="background:#f8fafc">
                    <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:8px">C√ìDIGO</th>
                    <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:8px">OBRA</th>
                    <th style="text-align:center;border-bottom:1px solid #e5e7eb;padding:8px;width:60px">PDF</th>
                  </tr>
                </thead>
                <tbody id="consultaTBody">
                  <tr><td colspan="3" style="padding:10px;color:#6b7280;text-align:center">Sem c√≥digo, sem resultados.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="ft">
          <button class="btn" onclick="fecharConsulta()">Fechar</button>
        </div>
      </div>
    </div>

  </div><!-- /wrap -->

  <script>
    function noop(){} function onlyDigits(s){return (s||'').replace(/\D+/g,'');}

    // Tema
    const THEME_KEY='impar_theme';
    function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); const b=document.getElementById('themeBtn'); if(b) b.textContent=(t==='dark'?'‚òÄÔ∏è Tema':'üåô Tema'); }
    (function initTheme(){ const saved=localStorage.getItem(THEME_KEY); if(saved){applyTheme(saved);} else { const prefersDark=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches; applyTheme(prefersDark?'dark':'light'); } })();
    function toggleTheme(){ const cur=document.documentElement.getAttribute('data-theme')||'light'; const next=(cur==='dark')?'light':'dark'; localStorage.setItem(THEME_KEY,next); applyTheme(next); }

    // usu√°rio (din√¢mico via /assets/usuario_doc.json com fallback em localStorage)
    async function loadUser(){
      let u=null;
      try {
        const r = await fetch('/assets/usuario_doc.json', { cache: 'no-store' });
        if (r.ok) {
          const j = await r.json();
          u = { Nome: j.nome || j.Nome || 'Usu√°rio', Email: j.email || j.Email || 'usuario@empresa.com' };
        }
      } catch(e){}
      if(!u){
        try{ const l = JSON.parse(localStorage.getItem('impar_user')||'null'); if(l) u = { Nome:l.Nome, Email:l.Email }; }catch(e){}
      }
      const label = u ? (u.Nome+'\n'+u.Email) : 'Usu√°rio\nusuario@empresa.com';
      document.querySelectorAll('.user').forEach(p=>{ p.innerHTML = label.replace('\n','<br>'); });
    }
    loadUser();

    // CEP
    function cepOnInput(el){ el.value = onlyDigits(el.value).slice(0,8); const e=document.getElementById(el.id+'Err'); const h=document.getElementById(el.id+'Hint'); if(e) e.classList.add('hidden'); if(h) h.classList.add('hidden'); }
    async function cepOnBlur(el, prefix){
      const d = onlyDigits(el.value).slice(0,8);
      el.value = d.length<=5 ? d : (d.substring(0,5)+'-'+d.substring(5));
      const ok = d.length===8; const e=document.getElementById(el.id+'Err'); const h=document.getElementById(el.id+'Hint'); if(e) e.classList.toggle('hidden',ok); if(h) h.classList.add('hidden'); if(!ok) return;
      try{ const r=await fetch('https://viacep.com.br/ws/'+d+'/json/'); const data=await r.json(); if(!data.erro){ const map={logradouro:'logradouro',bairro:'bairro',localidade:'cidade',uf:'uf'}; for(const k in map){ const t=document.getElementById(map[k]+prefix); if(t) t.value=data[k]||''; } if(h) h.classList.remove('hidden'); } }catch(err){}
      if(prefix==='Contratante') validate3(); else validate4();
    }

    // CPF/CNPJ
    function formatCPF(d){d=onlyDigits(d).slice(0,11);return d.replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2');}
    function formatCNPJ(d){d=onlyDigits(d).slice(0,14);return d.replace(/(\d{2})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1/$2').replace(/(\d{4})(\d{1,2})$/,'$1-$2');}
    function isValidCPF(cpf){cpf=onlyDigits(cpf);if(cpf.length!==11||/(\d)\1{10}/.test(cpf))return false;let s=0;for(let i=0;i<9;i++)s+=+cpf[i]*(10-i);let d1=11-(s%11);d1=d1>9?0:d1;if(+cpf[9]!==d1)return false;s=0;for(let i=0;i<10;i++)s+=+cpf[i]*(11-i);let d2=11-(s%11);d2=d2>9?0:d2;return +cpf[10]===d2;}
    function isValidCNPJ(cnpj){cnpj=onlyDigits(cnpj);if(cnpj.length!==14||/(\d)\1{13}/.test(cnpj))return false;const calc=(b)=>{let s=0,p=b.length-7;for(let i=b.length;i>=1;i--){s+=+b[b.length-i]*p--;if(p<2)p=9}return s%11<2?0:11-(s%11)};const b=cnpj.slice(0,12);const d1=calc(b);if(+cnpj[12]!==d1)return false;const d2=calc(b+d1);return +cnpj[13]===d2;}
    function docFocus(inp){inp.value=onlyDigits(inp.value);document.getElementById(inp.id+'Err').classList.add('hidden');}
    function docInput(inp){inp.value=onlyDigits(inp.value).slice(0,14);document.getElementById(inp.id+'Err').classList.add('hidden');}
    function docBlur(inp){const d=onlyDigits(inp.value);let ok=false;if(d.length===11){ok=isValidCPF(d);inp.value=formatCPF(d);}else if(d.length===14){ok=isValidCNPJ(d);inp.value=formatCNPJ(d);}document.getElementById(inp.id+'Err').classList.toggle('hidden',ok);}

    // Telefone
    function formatPhoneSimple(d){d=onlyDigits(d).slice(0,11);if(d.length<=6)return d.replace(/(\d{2})(\d{0,5})/,'($1)$2');return d.replace(/(\d{2})(\d{5})(\d{0,4})/,'($1)$2-$3');}
    function maskPhoneSimple(inp){const d=onlyDigits(inp.value).slice(0,11);inp.value=formatPhoneSimple(d);const id=inp.id.replace('telefone','tel')+'Err';document.getElementById(id).classList.toggle('hidden',d.length===11||d.length===0);}

    // Valor + por extenso
    function formatCurrencyBR(cents){const r=Math.floor(cents/100),c=(cents%100).toString().padStart(2,'0');const rr=r.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');return 'R$ '+rr+','+c;}
    function maskCurrency(inp){let d=onlyDigits(inp.value);if(!d){inp.value='';return;}inp.value=formatCurrencyBR(parseInt(d,10));}
    const UNIDADES=['zero','um','dois','tr√™s','quatro','cinco','seis','sete','oito','nove'];
    const DEZ_A_DEZENOVE=['dez','onze','doze','treze','catorze','quinze','dezesseis','dezessete','dezoito','dezenove'];
    const DEZENAS=['','dez','vinte','trinta','quarenta','cinquenta','sessenta','setenta','oitenta','noventa'];
    const CENTENAS=['','cento','duzentos','trezentos','quatrocentos','quinhentos','seiscentos','setecentos','oitocentos','noventos'];
    function trioPorExtenso(n){n%=1000;if(n===0)return'';if(n===100)return'cem';const c=Math.floor(n/100),d=Math.floor((n%100)/10),u=n%10;let p=[];if(c)p.push(CENTENAS[c]);if(d===1)p.push(DEZ_A_DEZENOVE[u]);else{if(d)p.push(DEZENAS[d]);if(u)p.push(UNIDADES[u]);}return p.join(' e ');}
    function inteiroBR(n){if(n===0)return'zero';const g=[{v:n%1000,n:''},{v:Math.floor(n/1000)%1000,n:'mil'},{v:Math.floor(n/1e6)%1000,n:'milh√£o',p:'milh√µes'},{v:Math.floor(n/1e9)%1000,n:'bilh√£o',p:'bilh√µes'}];let partes=[];for(let i=g.length-1;i>=0;i--){const x=g[i];if(!x.v)continue;const ext=trioPorExtenso(x.v);if(i===1){partes.push(x.v===1?'mil':ext+' mil');continue;}if(i>=2){partes.push(ext+' '+(x.v===1?x.n:x.p));continue;}if(i===0)partes.push(ext);}return partes.join(' ');}
    function valorExt(cents){const r=Math.floor(cents/100),c=cents%100;let t='';if(r>0)t+=inteiroBR(r)+' '+(r===1?'real':'reais');if(c>0){const s=inteiroBR(c)+' '+(c===1?'centavo':'centavos');t=t? t+' e '+s : s;}return t||'zero real';}
    function setValorExtenso(){const d=onlyDigits(document.getElementById('valor').value);document.getElementById('valorExtenso').value=d?valorExt(parseInt(d,10)):'';}

    // Data
    function openDatePicker(){ const p=document.getElementById('dataPicker'); if(p.showPicker) p.showPicker(); else p.click(); }
    function fillDateExtenso(){ const p=document.getElementById('dataPicker'); if(!p.value) return; const d=new Date(p.value+'T12:00:00'); document.getElementById('dataExtenso').value=d.toLocaleDateString('pt-BR',{day:'numeric',month:'long',year:'numeric'}); validate5(); }

    // Toast
    function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';setTimeout(()=>t.style.display='none',2000);}

    // Navega√ß√£o / valida√ß√µes
    let __currentStep = 1;
    function updateStepper(step){__currentStep=step;[1,2,3,4,5].forEach(n=>{const d=document.getElementById('dot'+n);d.classList.remove('done','active');if(n<step)d.classList.add('done');if(n===step)d.classList.add('active');});[['line12',2],['line23',3],['line34',4],['line45',5]].forEach(([id,to])=>{const el=document.getElementById(id);if(step>=to)el.classList.add('done');else el.classList.remove('done');});}
    function showOnly(id){['screen1','screen2','screen3','screen4','screen5'].forEach(s=>document.getElementById(s).classList.add('hidden'));document.getElementById(id).classList.remove('hidden');['bar1','bar2','bar3','bar4','bar5','back2','back3','back4','back5'].forEach(i=>{const el=document.getElementById(i);if(el)el.classList.add('hidden');});}
    function goTo(step){updateStepper(step);showOnly('screen'+step);const codigo=(document.getElementById('codigo').value||'').trim()||'AC00025';['codigoVal','codigoVal3','codigoVal4','codigoVal5'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=codigo;});const bar=document.getElementById('bar'+step);if(bar)bar.classList.remove('hidden');const back=document.getElementById('back'+step);if(back)back.classList.remove('hidden');const fn=window['validate'+step];if(typeof fn==='function')fn();}

    function addrOk(prefix){return ['logradouro','numero','bairro','cidade','uf'].every(k => document.getElementById(k+prefix).value.trim());}
    function validate1(){const v=document.getElementById('codigo').value.trim(),b=document.getElementById('bar1');if(v){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=()=>goTo(2);}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}updateStepper(1);}
    function validate2(){const s=document.getElementById('servico').value.trim(),e=document.getElementById('endereco').value.trim(),b=document.getElementById('bar2');if(s&&e){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=()=>goTo(3);}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}}
    function validate3(){const d=document.getElementById('docContratante').value,t=document.getElementById('telefoneContratante').value,m=document.getElementById('emailContratante').value.trim(),cep=document.getElementById('cepContratante').value.trim();const docOk=(onlyDigits(d).length===11&&isValidCPF(d))||(onlyDigits(d).length===14&&isValidCNPJ(d));const telOk=onlyDigits(t).length===11;const emailOk=isValidEmail(m);const cepOk=onlyDigits(cep).length===8;document.getElementById('emailContratanteErr').classList.toggle('hidden',emailOk||m.length===0);document.getElementById('telContratanteErr').classList.toggle('hidden',telOk||onlyDigits(t).length===0);document.getElementById('cepContratanteErr').classList.toggle('hidden',cepOk||onlyDigits(cep).length===0);const ok=['nomeContratante','contatoContratante'].every(id=>document.getElementById(id).value.trim())&&docOk&&telOk&&emailOk&&cepOk&&addrOk('Contratante');const b=document.getElementById('bar3');if(ok){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=()=>goTo(4);}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}}
    function validate4(){const d=document.getElementById('docContratada').value,t=document.getElementById('telefoneContratada').value,m=document.getElementById('emailContratada').value.trim(),cep=document.getElementById('cepContratada').value.trim();const docOk=(onlyDigits(d).length===11&&isValidCPF(d))||(onlyDigits(d).length===14&&isValidCNPJ(d));const telOk=onlyDigits(t).length===11;const emailOk=isValidEmail(m);const cepOk=onlyDigits(cep).length===8;document.getElementById('emailContratadaErr').classList.toggle('hidden',emailOk||m.length===0);document.getElementById('telContratadaErr').classList.toggle('hidden',telOk||onlyDigits(t).length===0);document.getElementById('cepContratadaErr').classList.toggle('hidden',cepOk||onlyDigits(cep).length===0);const ok=['nomeContratada','contatoContratada'].every(id=>document.getElementById(id).value.trim())&&docOk&&telOk&&emailOk&&cepOk&&addrOk('Contratada');const b=document.getElementById('bar4');if(ok){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=()=>goTo(5);}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}}
    function isValidEmail(e){ return /^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i.test(e); }
    function isValidCurrencyInput(){return /R\$\s\d{1,3}(\.\d{3})*,\d{2}$/.test(document.getElementById('valor').value);}
    function validate5(){setValorExtenso();const ok=isValidCurrencyInput()&&parseInt(document.getElementById('prazo').value,10)>0&&document.getElementById('dataExtenso').value.trim().length>0&&['clausulas','condicoes','valorExtenso'].every(id=>document.getElementById(id).value.trim());const b=document.getElementById('bar5');if(ok){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=finalizeStep5;}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}}

    // LOGO
    let __logoCached = null;
    function showLogoName(inp){
      const f = inp.files && inp.files[0];
      const el = document.getElementById('logoInfo');
      el.textContent = f ? ('Anexo: ' + f.name) : 'Anexar logo do contratante';
      __logoCached = null;
    }
    function detectFormatFromDataUrl(dt){
      if(!dt || typeof dt!=='string') return 'PNG';
      if(dt.startsWith('data:image/jpeg')) return 'JPEG';
      if(dt.startsWith('data:image/jpg'))  return 'JPEG';
      if(dt.startsWith('data:image/webp')) return 'WEBP';
      return 'PNG';
    }
    function loadLogoForPdf(){
      return new Promise((resolve)=>{
        if(__logoCached) return resolve(__logoCached);
        const inp = document.getElementById('logo');
        const file = inp && inp.files && inp.files[0];
        if(!file) return resolve(null);
        const fr = new FileReader();
        fr.onload = () => {
          const url = fr.result;
          const img = new Image();
          img.onload = () => {
            const maxW = 110;
            const ratio = img.naturalWidth ? (maxW / img.naturalWidth) : 1;
            const w = Math.min(maxW, img.naturalWidth) * (img.naturalWidth ? ratio : 1);
            const h = img.naturalHeight ? (img.naturalHeight * (w / (img.naturalWidth||w))) : 40;
            __logoCached = { url, w, h, fmt: detectFormatFromDataUrl(url) };
            resolve(__logoCached);
          };
          img.src = url;
        };
        fr.readAsDataURL(file);
      });
    }

// PDF
    function currentCode(){ return (document.getElementById('codigo').value||'').trim() || 'DOC'; }
    function todayYMD(){ const d=new Date(); const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const dd=('0'+d.getDate()).slice(-2); return `${y}${m}${dd}`; }
    let __pdfBlob=null, __pdfUrl=null, __pdfName='documento.pdf';

    async function createPdfBlob(){
      const logo = await loadLogoForPdf();
      const { jsPDF } = window.jspdf;
      const pdf=new jsPDF({unit:'pt',format:'a4'}), pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight(), M=40; let y=M;
      function drawLogo(){ if(!logo) return; try{ pdf.addImage(logo.url, logo.fmt, pageW - M - logo.w, M - 6, logo.w, logo.h); }catch(e){} }
      function h1(t){pdf.setFont('Helvetica','bold');pdf.setFontSize(16);drawLogo();pdf.text(t,pageW/2,y,{align:'center'});y+=22;pdf.setDrawColor(200);pdf.line(M,y,pageW-M,y);y+=14;}
      function lv(l,v){pdf.setFont('Helvetica','bold');pdf.setFontSize(11);const lines=pdf.splitTextToSize(l+' '+v,pageW-2*M);pdf.text(lines,M,y);y+=lines.length*14;}
      function block(l,v){pdf.setFont('Helvetica','bold');pdf.setFontSize(12);pdf.text(l,M,y);y+=14;pdf.setFont('Helvetica','normal');pdf.setFontSize(11);const lines=pdf.splitTextToSize(v,pageW-2*M);for(const line of lines){if(y>pageH-M){pdf.addPage();y=M;drawLogo();}pdf.text(line,M,y);y+=14;}y+=6;}
      function ensure(h){if(y+h>pageH-M){pdf.addPage();y=M;}}
      const get=(id)=>(document.getElementById(id).value||'').trim();
      const end=(p)=>{ const log=document.getElementById('logradouro'+p).value||'',num=document.getElementById('numero'+p).value||'',comp=document.getElementById('complemento'+p).value||'',bai=document.getElementById('bairro'+p).value||'',cid=document.getElementById('cidade'+p).value||'',uf=document.getElementById('uf'+p).value||'',cep=(document.getElementById('cep'+p).value||''); let base=log+', '+num+(comp?(' - '+comp):''); base+=' ‚Äî '+bai+' ‚Äî '+cid+'/'+uf+' ‚Äî CEP '+cep; return base; };
      const u = JSON.parse(localStorage.getItem('impar_user')||'null');

      h1('Resumo do Documento');
      lv('Operador:', u ? (u.Nome+' ('+u.Email+')') : '‚Äî'); y+=6;
      lv('C√≥digo do Projeto:', get('codigo')); y+=8;
      block('Servi√ßo:', get('servico'));
      lv('Endere√ßo da obra:', get('endereco')); y+=8;

      pdf.setFont('Helvetica','bold');pdf.setFontSize(13);ensure(24);pdf.text('CONTRATANTE',M,y);y+=16;pdf.setDrawColor(220);pdf.line(M,y,pageW-M,y);y+=10;
      lv('Nome:', get('nomeContratante'));
      lv('CPF/CNPJ:', get('docContratante'));
      lv('Endere√ßo:', end('Contratante'));
      lv('Contato:', get('contatoContratante'));
      lv('Telefone:', get('telefoneContratante'));
      lv('E-mail:', get('emailContratante')); y+=8;

      pdf.setFont('Helvetica','bold');pdf.setFontSize(13);ensure(24);pdf.text('CONTRATADA',M,y);y+=16;pdf.setDrawColor(220);pdf.line(M,y,pageW-M,y);y+=10;
      lv('Nome:', get('nomeContratada'));
      lv('CPF/CNPJ:', get('docContratada'));
      lv('Endere√ßo:', end('Contratada'));
      lv('Contato:', get('contatoContratada'));
      lv('Telefone:', get('telefoneContratada'));
      lv('E-mail:', get('emailContratada')); y+=8;

      pdf.setFont('Helvetica','bold');pdf.setFontSize(13);ensure(24);pdf.text('CONDI√á√ïES',M,y);y+=16;pdf.setDrawColor(220);pdf.line(M,y,pageW-M,y);y+=10;
      lv('Valor:', get('valor')+' ('+get('valorExtenso')+')');
      lv('Prazo:', get('prazo')+' dias');
      lv('Data:', get('dataExtenso'));
      block('Condi√ß√µes de pagamento:', get('condicoes'));
      block('Cl√°usulas:', get('clausulas'));

      return pdf.output('blob');
    }

    function openViewerWithBlob(blob){
      __pdfBlob = blob;
      if(__pdfUrl) URL.revokeObjectURL(__pdfUrl);
      __pdfUrl = URL.createObjectURL(blob);
      __pdfName = `${currentCode()}_${todayYMD()}.pdf`;
      document.getElementById('pdfFrame').src = __pdfUrl;
      document.getElementById('viewer').style.display='flex';
    }

    function closeViewer(){ document.getElementById('viewer').style.display='none'; }
   // baixar / compartilhar PDF j√° aberto no viewer
   function downloadLastPdf(){
   if(!window.__pdfBlob || !window.__pdfUrl) return;
   const a=document.createElement('a');
   a.href=window.__pdfUrl;
   a.download=window.__pdfName || ('documento_'+todayYMD()+'.pdf');
   document.body.appendChild(a); a.click(); a.remove();
}


// =============== CONTINUA√á√ÉO (colar ap√≥s closeViewer) ===============

// baixar / compartilhar PDF j√° aberto no viewer
function downloadLastPdf(){
    if(!window.__pdfBlob || !window.__pdfUrl){
      if (typeof window.showToast === 'function') showToast('Gere o PDF primeiro');
      return;
    }
    const a = document.createElement('a');
    a.href = window.__pdfUrl;
    a.download = window.__pdfName || ('documento_' + todayYMD() + '.pdf');
    document.body.appendChild(a);
    a.click();
    a.remove();
}
// Compartilhar o √∫ltimo PDF (Web Share API quando dispon√≠vel)
  async function shareLastPdf(){
    if(!window.__pdfBlob || !window.__pdfUrl){
      if (typeof window.showToast === 'function') showToast('Gere o PDF primeiro');
      return;
    }
    const nome = window.__pdfName || ('documento_' + todayYMD() + '.pdf');
    const file = new File([window.__pdfBlob], nome, { type: 'application/pdf' });

    try{
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({ files: [file], title: 'Documento', text: 'Envio do documento em PDF' });
      } else if (navigator.share) {
        await navigator.share({ title: 'Documento', text: 'Envio do documento em PDF', url: window.__pdfUrl });
      } else {
        // fallback: WhatsApp web
        const txt = encodeURIComponent('Documento gerado. Baixe aqui: ' + location.href);
        window.open('https://wa.me/?text=' + txt, '_blank');
      }
    } catch(e) {
      // Usu√°rio cancelou ou plataforma n√£o permitiu ‚Äî fica silencioso
    }
  }
function closeSuccess(){ document.getElementById('successModal').style.display='none'; }
async function visualizarPdf(){ closeSuccess(); const blob = await createPdfBlob(); openViewerWithBlob(blob); }

// ---------- Consulta (modal j√° existe no HTML) ----------
function abrirConsulta(){
  const m = document.getElementById('consultaModal');
  const q = document.getElementById('qCodigo');
  q.value = (document.getElementById('codigo').value || '').trim();
  document.getElementById('consultaTBody').innerHTML = `<tr><td colspan="3" style="padding:10px;color:#6b7280;text-align:center">Sem c√≥digo, sem resultados.</td></tr>`;
  m.style.display='flex';
}
function fecharConsulta(){ document.getElementById('consultaModal').style.display='none'; }

async function buscarConsulta(){
  const token = (window.__ERP_SAVE_PATCH__ && window.__ERP_SAVE_PATCH__.SAVE_TOKEN) || '';
  const endpoint = (window.__ERP_SAVE_PATCH__ && window.__ERP_SAVE_PATCH__.SAVE_URL.replace('/save.php','/')) || 'https://api.erpimpar.com.br/gerador/';
  const codigo = (document.getElementById('qCodigo').value || '').trim();
  let url = endpoint + 'list.php?token=' + encodeURIComponent(token);
  if(codigo) url += '&codigo=' + encodeURIComponent(codigo);

  const tb = document.getElementById('consultaTBody');
  tb.innerHTML = `<tr><td colspan="3" style="padding:10px;color:#6b7280;text-align:center">Buscando...</td></tr>`;

  try{
    const r = await fetch(url, {cache:'no-store'});
    const j = await r.json();
    const rows = (j && j.rows) ? j.rows : [];
    if(!rows.length){
      tb.innerHTML = `<tr><td colspan="3" style="padding:10px;color:#6b7280;text-align:center">${codigo?'Nenhum documento para o c√≥digo informado.':'Nenhum registro encontrado.'}</td></tr>`;
      return;
    }
    tb.innerHTML = rows.map(row=>{
      const code = row.codigo || '';
      const obra = row.contratante_nome || '';
      const href = resolvePdfHref(row);
      return `<tr>
        <td style="padding:8px;border-bottom:1px solid #eee">${code}</td>
        <td style="padding:8px;border-bottom:1px solid #eee">${obra}</td>
        <td style="padding:8px;border-bottom:1px solid #eee;text-align:center">
          <a class="btn" style="padding:4px 10px" target="_blank" href="${href}">abrir</a>
        </td>
      </tr>`;
    }).join('');
  }catch(e){
    tb.innerHTML = `<tr><td colspan="3" style="padding:10px;color:#ef4444;text-align:center">Erro ao consultar.</td></tr>`;
  }
}
function resolvePdfHref(row){
  const endpoint = (window.__ERP_SAVE_PATCH__ && window.__ERP_SAVE_PATCH__.SAVE_URL.replace('/save.php','/')) || 'https://api.erpimpar.com.br/gerador/';
  const token = (window.__ERP_SAVE_PATCH__ && window.__ERP_SAVE_PATCH__.SAVE_TOKEN) || '';
  const file  = row.pdf_file || (row.file || '').replace(/^.*\//,'');
  if(!file) return '#';
  // stream via pdf.php pra evitar 404 por proxy/cache
  return endpoint + 'pdf.php?f=' + encodeURIComponent(file) + '&token=' + encodeURIComponent(token);
}

// ---------- Fechar / Limpar ----------
function fecharFluxo(){
  if(window.__currentStep === 1){
    // RAIZ (conforme voc√™ pediu): /login_doc.html
    location.href = '/login_doc.html';
  }else{
    goTo(1);
  }
}
function limparDados(){
  document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], textarea').forEach(i=>i.value='');
  const logo = document.getElementById('logo'); if(logo) logo.value='';
  const h = document.getElementById('logoInfo'); if(h) h.textContent='Anexar logo do contratante';
  window.__logoCached = null;
  goTo(1);
  showToast('Campos limpos');
}

// ========== DUPLICIDADE: checar, perguntar e (se atualizar) preencher ==========
async function checkCodigoDuplicado(cod){
  const token = (window.__ERP_SAVE_PATCH__ && window.__ERP_SAVE_PATCH__.SAVE_TOKEN) || '';
  const endpoint = (window.__ERP_SAVE_PATCH__ && window.__ERP_SAVE_PATCH__.SAVE_URL.replace('/save.php','/')) || 'https://api.erpimpar.com.br/gerador/';
  const url = endpoint + 'list.php?token=' + encodeURIComponent(token) + '&codigo=' + encodeURIComponent(cod);
  try{
    const r = await fetch(url, {cache:'no-store'});
    const j = await r.json();
    const rows = (j && j.rows) ? j.rows : [];
    return rows; // [] se n√£o existe
  }catch(e){
    return [];
  }
}

// cria modal simples reutiliz√°vel
function ensureDupModal(){
  if(document.getElementById('dupModal')) return;
  const m = document.createElement('div');
  m.id='dupModal';
  m.className='modal';
  m.innerHTML = `
    <div class="box">
      <div class="hd">Documento j√° cadastrado</div>
      <div class="bd">
        <p>J√° existe um documento para este c√≥digo. Deseja <b>imprimir o PDF</b> ou <b>atualizar informa√ß√µes</b>?</p>
      </div>
      <div class="ft">
        <button class="btn" id="dupFechar">Fechar</button>
        <button class="btn" id="dupImprimir">Imprimir PDF</button>
        <button class="btn primary" id="dupAtualizar">Atualizar</button>
      </div>
    </div>
  `;
  document.body.appendChild(m);
  document.getElementById('dupFechar').onclick=()=>{ m.style.display='none'; };
}
let __dupRowsCache = [];
async function abrirDupModal(rows){
  __dupRowsCache = rows||[];
  ensureDupModal();
  const m = document.getElementById('dupModal');
  m.style.display='flex';
  // a√ß√µes
  document.getElementById('dupImprimir').onclick = ()=>{
    m.style.display='none';
    // abre o primeiro PDF correspondente
    if(__dupRowsCache.length){
      const href = resolvePdfHref(__dupRowsCache[0]);
      if(href && href !== '#') window.open(href, '_blank');
    }
  };
  document.getElementById('dupAtualizar').onclick = async ()=>{
    m.style.display='none';
    if(__dupRowsCache.length){
      await preencherCamposComRow(__dupRowsCache[0]);
      goTo(2); // j√° cai na etapa 2 para seguir at√© 5
      showToast('Campos carregados do documento existente');
    }
  };
}

// Preencher campos de tela a partir da linha retornada pelo list.php
async function preencherCamposComRow(row){
  // mapeia campos prov√°veis (depende do list.php incluir clausulas/condicoes)
  const byId = (id,val)=>{ const el=document.getElementById(id); if(el) el.value=(val||''); };

  byId('servico', row.servico);
  byId('endereco', row.enderecoObra || row.endereco || '');

  // contratante
  byId('nomeContratante', row.contratante_nome);
  byId('docContratante',  (row.contratante_doc||'').replace(/\D+/g,''));
  byId('contatoContratante', row.contratante_contato);
  byId('telefoneContratante', row.contratante_telefone);
  byId('emailContratante', row.contratante_email);

  // se seu list.php j√° envia CEP/logradouro/bairro/... preencha aqui
  // (ex.: row.cep_contratante, row.logradouro_contratante, etc.)
  // byId('cepContratante', row.cep_contratante);
  // byId('logradouroContratante', row.logradouro_contratante);
  // byId('numeroContratante', row.numero_contratante);
  // byId('complementoContratante', row.complemento_contratante);
  // byId('bairroContratante', row.bairro_contratante);
  // byId('cidadeContratante', row.cidade_contratante);
  // if(row.uf_contratante){ const s=document.getElementById('ufContratante'); if(s) s.value=row.uf_contratante; }

  // contratada
  byId('nomeContratada', row.contratada_nome);
  byId('docContratada', (row.contratada_doc||'').replace(/\D+/g,''));
  byId('contatoContratada', row.contratada_contato);
  byId('telefoneContratada', row.contratada_telefone);
  byId('emailContratada', row.contratada_email);
  // idem endere√ßo da contratada se dispon√≠vel nos campos do list.php

  // condi√ß√µes finais
  byId('valor', row.valor);
  byId('valorExtenso', row.valorExtenso || row.valor_extenso || '');
  byId('prazo', row.prazo);
  byId('dataExtenso', row.dataExtenso || row.data_extenso || '');
  byId('clausulas', row.clausulas || '');
  byId('condicoes', row.condicoes || '');

  // revalidar barras
  if(typeof validate2==='function') validate2();
  if(typeof validate3==='function') validate3();
  if(typeof validate4==='function') validate4();
  if(typeof validate5==='function') validate5();
}

// --- Hook no fluxo da Etapa 1: ao clicar "Continuar", primeiro verificar duplicidade ---
(function hookEtapa1(){
  const b = document.getElementById('bar1');
  if(!b) return;
  const original = b.onclick;
  b.onclick = async function(){
    const cod = (document.getElementById('codigo').value || '').trim();
    if(!cod){ showToast('Informe o c√≥digo'); return; }
    const rows = await checkCodigoDuplicado(cod);
    if(rows && rows.length){
      await abrirDupModal(rows);
    }else{
      // segue o fluxo normal (vai p/ etapa 2)
      if(typeof original === 'function') original(); else goTo(2);
    }
  };
})();

// ========== Salvar com LOGO + CSV + checagem de c√≥digo no backend ==========
(function enableSaveWithLogo(){
  const patch = window.__ERP_SAVE_PATCH__;
  if(!patch) return;

  const SAVE_URL = patch.SAVE_URL;
  const SAVE_TOKEN = patch.SAVE_TOKEN;

  async function saveWithLogo(pdfBlob, pdfName){
    const fd = new FormData();
    fd.append('pdf', new File([pdfBlob], pdfName, {type:'application/pdf'}));
    fd.append('dados', JSON.stringify(window.collectFormData()));
    fd.append('token', SAVE_TOKEN);
    const file = document.getElementById('logo')?.files?.[0];
    if(file) fd.append('logo', file, file.name);
    const resp = await fetch(SAVE_URL, {
      method:'POST',
      headers:{ 'Authorization': 'Bearer ' + SAVE_TOKEN },
      body: fd
    });
    return resp.json();
  }


(function () {
  // Usa as constantes do PATCH j√° carregado no index (erp_save_patch_flatfile.js)
  const PATCH = window.__ERP_SAVE_PATCH__ || {};
  const SAVE_URL   = PATCH.SAVE_URL   || 'https://api.erpimpar.com.br/gerador/save.php';
  const LIST_URL   = PATCH.LIST_URL   || 'https://api.erpimpar.com.br/gerador/list.php';
  const SAVE_TOKEN = PATCH.SAVE_TOKEN || '';

  function currentCode(){
    return (document.getElementById('codigo')?.value || '').trim();
  }
  function todayYMD(){
    const d=new Date(); const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2);
    return `${y}${m}${dd}`;
  }

  // Mesmo resolvedor usado na consulta (abre via pdf.php)
  function resolvePdfHref(row){
    const endpoint = (window.__ERP_SAVE_PATCH__ && window.__ERP_SAVE_PATCH__.SAVE_URL.replace('/save.php','/')) || 'https://api.erpimpar.com.br/gerador/';
    const token = (window.__ERP_SAVE_PATCH__ && window.__ERP_SAVE_PATCH__.SAVE_TOKEN) || '';
    const file  = row.pdf_file || (row.file || '').replace(/^.*\//,'');
    if(!file) return '#';
    return endpoint + 'pdf.php?f=' + encodeURIComponent(file) + '&token=' + encodeURIComponent(token);
  }

  // 1) Checa duplicidade no backend (list.php)
  async function checkCodigoDuplicado(codigo){
    let url = LIST_URL + '?token=' + encodeURIComponent(SAVE_TOKEN) + '&codigo=' + encodeURIComponent(codigo);
    const r  = await fetch(url, { cache: 'no-store' });
    const js = await r.json().catch(()=>({}));
    return (js && js.rows) ? js.rows : [];
  }

  // 2) Carrega JSON salvo em /docs/<codigo>.json e preenche o formul√°rio
  async function carregarDocumentoNosCampos(codigo){
    const base = (window.__ERP_SAVE_PATCH__ && window.__ERP_SAVE_PATCH__.SAVE_URL.replace('/save.php','/')) || 'https://api.erpimpar.com.br/gerador/';
    const url  = base + 'docs/' + encodeURIComponent(codigo) + '.json' + (SAVE_TOKEN ? ('?token='+encodeURIComponent(SAVE_TOKEN)) : '');
    const r    = await fetch(url, { cache: 'no-store' });
    const data = await r.json();

    // Preenche os campos baseado no collectFormData
    const set = (id,v)=>{ const el=document.getElementById(id); if(el!=null){ el.value = v || ''; el.dispatchEvent(new Event('input')); } };
    set('codigo',  data.codigo);
    set('servico', data.servico);
    set('endereco', data.enderecoObra);

    // CONTRATANTE
    const ct = data.contratante || {};
    set('nomeContratante', ct.nome);
    set('docContratante', ct.cpfCnpj);
    set('contatoContratante', ct.contato);
    set('telefoneContratante', ct.telefone);
    set('emailContratante', ct.email);
    // tenta fatiar endere√ßo "logradouro, numero - comp ‚Äî bairro ‚Äî cidade/UF ‚Äî CEP 00000-000"
    (function parseEnd(end, prefix){
      if(!end) return;
      // heur√≠stica simples
      const cepMatch = end.match(/CEP\s+([\d\-]+)/i);
      const ufMatch  = end.match(/\/([A-Z]{2})\s+‚Äî\s+CEP/i);
      const cidadeB  = end.split('‚Äî');
      const cidadeUF = (cidadeB[2]||'').trim();
      const bairro   = (cidadeB[1]||'').trim();
      const logNum   = (end.split('‚Äî')[0]||'').trim().split(' - ')[0]||'';
      const log      = (logNum.split(',')[0]||'').trim();
      const num      = (logNum.split(',')[1]||'').trim();

      set('logradouro'+prefix, log);
      set('numero'+prefix, num);
      set('bairro'+prefix, bairro.replace(/^bairro\s*:\s*/i,''));
      if (cidadeUF.includes('/')){
        const parts = cidadeUF.split('/');
        set('cidade'+prefix, (parts[0]||'').trim());
        set('uf'+prefix, (parts[1]||'').trim());
      }
      if (cepMatch) set('cep'+prefix, cepMatch[1]);
    })(ct.endereco,'Contratante');

    // CONTRATADA
    const cd = data.contratada || {};
    set('nomeContratada', cd.nome);
    set('docContratada', cd.cpfCnpj);
    set('contatoContratada', cd.contato);
    set('telefoneContratada', cd.telefone);
    set('emailContratada', cd.email);
    (function parseEnd(end, prefix){ /* mesma heur√≠stica */ })(cd.endereco,'Contratada');

    // CONDI√á√ïES / VALORES
    set('clausulas', data.clausulas);
    set('condicoes', data.condicoesPagamento || data.condicoes);
    set('valor', data.valor);
    set('valorExtenso', data.valorExtenso);
    set('prazo', data.prazo);
    set('dataExtenso', data.dataExtenso);

    // Vai para etapa 2 e deixa o usu√°rio seguir at√© 5
    if (typeof window.goTo === 'function') {
      window.goTo(2);
    }
  }



  // 3) Di√°logo: imprimir ou atualizar
  async function abrirDupModal(dupRows){
    // Di√°logo simples: OK = IMPRIMIR, Cancel = ATUALIZAR
    const escolhaImprimir = confirm('DOCUMENTO J√Å CADASTRADO.\n\nOK = Imprimir PDF\nCancelar = Atualizar informa√ß√µes');
    const row = dupRows[0];

    if(escolhaImprimir){
      const href = resolvePdfHref(row);
      if(href && href !== '#') {
        window.open(href, '_blank');
      } else {
        alert('N√£o foi poss√≠vel localizar o PDF para este c√≥digo.');
      }
      return 'imprimir';
    } else {
      await carregarDocumentoNosCampos(row.codigo || currentCode());
      return 'atualizar';
    }
  }

  // 4) Salvar (usa o saveWithLogo do patch j√° existente)
  async function saveWithLogo(pdfBlob, pdfName){
    if(!window.__ERP_SAVE_PATCH__ || !window.__ERP_SAVE_PATCH__.SAVE_URL){
      throw new Error('Patch de salvamento n√£o carregado.');
    }
    const fd = new FormData();
    fd.append('pdf', new File([pdfBlob], pdfName, {type:'application/pdf'}));
    fd.append('dados', JSON.stringify(window.collectFormData()));
    fd.append('token', SAVE_TOKEN);
    const logoFile = document.getElementById('logo')?.files?.[0];
    if(logoFile) fd.append('logo', logoFile, logoFile.name);

    const resp = await fetch(SAVE_URL, {
      method:'POST',
      headers:{ 'Authorization': 'Bearer ' + SAVE_TOKEN },
      body: fd
    });

    // parse seguro
    const raw = await resp.text();
    let json = null; try { json = JSON.parse(raw); } catch(_) {}
    return json || { ok:false, raw, status: resp.status };
  }


// 5) Intercepta o finalizeStep5 (vers√£o corrigida e autossuficiente)
const orig = window.finalizeStep5;
window.finalizeStep5 = function(){
  const toast = (typeof window.showToast === 'function') ? window.showToast : console.log;
  (async () => {
    try{
      const cod = currentCode();
      if(!cod){ toast('Informe o c√≥digo do projeto.'); return; }

      // Checa duplicidade
      let updateFlag = false;
      const dupRows = await checkCodigoDuplicado(cod);
      if (dupRows && dupRows.length){
        const acao = await abrirDupModal(dupRows);
        if (acao === 'imprimir') {
          // usu√°rio optou por abrir/imprimir o PDF existente ‚Üí encerrar
          return;
        }
        if (acao === 'atualizar') {
          // sinaliza atualiza√ß√£o (save.php aceitar√° sobrescrever)
          updateFlag = true;
        }
        // se cair aqui, segue para gerar PDF e salvar (com updateFlag quando for o caso)
      }

      // Gera PDF
      if (typeof window.createPdfBlob !== 'function') {
        toast('Falha: gerador de PDF n√£o dispon√≠vel.');
        return;
      }
      const blob = await window.createPdfBlob();
      window.__pdfBlob = blob;
      if (window.__pdfUrl) URL.revokeObjectURL(window.__pdfUrl);
      window.__pdfUrl  = URL.createObjectURL(blob);
      const ymd  = todayYMD();
      window.__pdfName = `${cod}_${ymd}.pdf`;

      // >>> ALTERA√á√ÉO AQUI <<<
      // Em vez de saveWithLogo(...), usamos o helper robusto saveToServerWithFallback(...)
      const out = await saveToServerWithFallback(blob, window.__pdfName, updateFlag);

      if(out && (out.ok || out.success)){
        window.__pdfSavedUrl = out.pdfUrl || out.pdf || out.file;
        toast('Registro salvo no ERP ‚úÖ');
      }else{
        console.warn('save error', out);
        const msg = (out && (out.error || out.message)) ? (out.error || out.message) : 'Falha desconhecida';
        toast('Gerado localmente. Falha ao salvar no ERP ‚ùó ' + msg);
        if (out && out.raw) {
          console.error('RAW do servidor (HTML/erro PHP):\n', out.raw);
          alert('Servidor retornou um erro (n√£o-JSON). Abra o Console para detalhes.');
        }
      }

      // Modal de sucesso (j√° existe no HTML)
      const modal = document.getElementById('successModal');
      if(modal) modal.style.display='flex';

    }catch(e){
      console.error(e);
      toast('Gerado localmente. Falha ao salvar no ERP ‚ùó ' + e.message);
      const modal = document.getElementById('successModal');
      if(modal) modal.style.display='flex';
    }
  })();
};

// ========== Helpers de resposta segura ==========
async function safeJsonFromResponse(resp) {
  const text = await resp.text(); // l√™ SEMPRE como texto
  try {
    return JSON.parse(text);      // tenta virar JSON
  } catch {
    console.error('Resposta n√£o-JSON do servidor:', text);
    return {
      ok: false,
      success: false,
      status: resp.status,
      error: 'Resposta n√£o-JSON do servidor (poss√≠vel erro PHP no save.php).',
      raw: text
    };
  }
}

// Monta e envia o POST para o save.php usando as configs do patch se existirem
async function saveToServerWithFallback(pdfBlob, pdfName, updateFlag=false) {
  // tenta usar as configs do patch (se existir)
  const patch = window.__ERP_SAVE_PATCH__ || {};
  const SAVE_URL   = patch.SAVE_URL   || 'https://api.erpimpar.com.br/gerador/save.php';
  const SAVE_TOKEN = patch.SAVE_TOKEN || '';

  const fd = new FormData();
  fd.append('pdf', new File([pdfBlob], pdfName, { type: 'application/pdf' }));
  // MUITO IMPORTANTE: enviar como string, n√£o Blob
  fd.append('dados', JSON.stringify(window.collectFormData()));
  if (updateFlag) fd.append('update', '1');

  const headers = {};
  if (SAVE_TOKEN) headers['Authorization'] = 'Bearer ' + SAVE_TOKEN;

  const resp = await fetch(SAVE_URL, { method: 'POST', headers, body: fd });
  return await safeJsonFromResponse(resp);
}


<!-- ...seu c√≥digo acima permanece... -->

// ========== (RE)Init ==========
document.addEventListener('DOMContentLoaded', async () => {
  // 1) Usu√°rio no cabe√ßalho (assets/usuario_doc.json)
  try {
    const r = await fetch('/assets/usuario_doc.json', { cache: 'no-store' });
    if (r.ok) {
      const u = await r.json();
      document.querySelectorAll('.user').forEach(el => {
        el.innerHTML = `${u.Nome || 'Usu√°rio'}<br>${u.Email || ''}`;
      });
    }
  } catch (_) { /* ignora se n√£o existir */ }

  // 2) Stepper + valida√ß√µes
  if (typeof updateStepper === 'function') updateStepper(1);
  if (typeof validate1 === 'function') validate1();

  // 3) Bot√£o "Fechar" (etapa 1) -> raiz /login_doc.html
  const fecharBtns = [
    document.querySelector('.topbar .btn.danger'),  // seu bot√£o FECHAR do topo
    document.getElementById('fecharEtapa1')         // se existir um id espec√≠fico
  ].filter(Boolean);

  fecharBtns.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      location.href = '/login_doc.html';
    });
  });

  // 4) ‚ÄúPesquisar documentos cadastrados‚Äù ‚Üí abrirConsulta()
  const btnBusca = Array.from(document.querySelectorAll('button'))
    .find(b => /pesquisar.*cadastrados/i.test(b.textContent));
  if (btnBusca && typeof abrirConsulta === 'function') {
    btnBusca.onclick = abrirConsulta;
  }
</script>
});

