<!DOCTYPE html>

<html data-theme="light" lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<title>Gerador de documentos</title>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{--bg:#f1f1f1;--card:#ffffff;--text:#1f2937;--border:#d1d5db;--capbg:#f3f4f6;
        --accent:#2ea3f2;--accentText:#fff;--disabled:#cbd5e1;--disabledText:#6b7280;--error:#ef4444}
  :root[data-theme="dark"] {
  --bg: #3a3a3a;                /* <- cinza escuro elegante */
  --card: #1f1f1f;
  --text: #e5e7eb;
  --border: #3c3c3c;
  --capbg: #333;
  --accent: #4db4e2;
  --accentText: #fff;
  --disabled: #555;
  --disabledText: #aaa;
  --error: #f87171;
}
  *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 Arial,Helvetica,sans-serif}
  .wrap{width:100%;max-width:clamp(420px, 90vw, 860px);margin:0 auto;padding:10px 10px 18px}
  @media (min-width: 768px){ .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px} }
  .stepper{display:flex;align-items:center;gap:10px;justify-content:center;margin:10px 0 6px;flex-wrap:wrap}
  .dot{width:18px;height:18px;border-radius:50%;border:1px solid #c7c7c7;color:#4b5563;display:flex;align-items:center;justify-content:center;font-size:11px;background:#fff}
  .dot.done,.dot.active{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:700}
  .dot.active{box-shadow:0 0 0 2px rgba(46,163,242,.35)}
  .line{height:1px;flex:1;background:#c7c7c7;max-width:24px}
  .line.done{background:var(--accent)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:6px;overflow:hidden;box-shadow:0 1px 0 rgba(0,0,0,.04)}
  .header{padding:14px 14px 6px}
  .title{ /* ... */ color: var(--text); }   /* era #111827 */
  .user{font-size:13px;color:#4b5563;margin:0 0 8px}
  .code{  /* ... */ color: var(--text); }   /* era #374151 */
  .body{padding:12px 14px 16px}
  .block{border:1px solid var(--border);background:#fff;margin:0 0 12px;border-radius:4px;overflow:hidden}
  .block .cap{background:var(--capbg);color:#6b7280;font-size:12px;text-transform:uppercase;letter-spacing:.3px;padding:6px 8px;border-bottom:1px solid var(--border)}
  .block .cap .req{color:#dc2626}.block .content{padding:8px}
  .textarea,.input,select{width:100%;border:1px solid #e5e7eb;background:#fff;padding:8px;border-radius:4px;font:15px/1.45 Arial,Helvetica,sans-serif;color:#111827;outline:none;transition:border-color .15s,box-shadow .15s}
  .textarea{min-height:120px;resize:vertical}.textarea:focus,.input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(46,163,242,.25)}
  .file{font:14px Arial,Helvetica,sans-serif}.error{color:var(--error);font-size:12px;margin-top:6px}.hint{font-size:12px;color:#6b7280;margin-top:6px}
  .bar{position:sticky;bottom:0;left:0;right:0;text-align:center;padding:14px;font-weight:700;cursor:default;margin-top:10px;border-top:1px solid #e5e7eb}
  .bar.disabled{background:var(--disabled);color:var(--disabledText)}.bar.enabled{background:var(--accent);color:var(--accentText);cursor:pointer}
  .back{display:flex;align-items:center;gap:6px;justify-content:center;color:#111827;font-size:14px;margin-top:6px;cursor:pointer;user-select:none}.back .chev{color:#f59e0b}
  .hidden{display:none}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:60}
  .modal .box{width:100%;max-width:920px;background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);border:1px solid #e5e7eb;overflow:hidden;display:flex;flex-direction:column;max-height:90vh}
  .modal .box .hd{padding:16px;border-bottom:1px solid #e5e7eb;font-weight:700}
  .modal .box .bd{padding:16px;overflow:auto}
  .modal .box .ft{padding:12px 16px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;font-weight:700;cursor:pointer}
  .btn.primary{background:#2ea3f2;color:#fff;border-color:transparent}
  .viewer{position:fixed;inset:0;background:#111827cc;display:none;align-items:center;justify-content:center;z-index:65}
  .viewer .panel{width:96%;max-width:900px;background:#fff;border-radius:6px;overflow:hidden;display:flex;flex-direction:column}
  .viewer .panel .top{padding:10px;border-bottom:1px solid #e5e7eb;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  .viewer .panel iframe{width:100%;height:80vh;border:0}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#10b981;color:#fff;padding:12px 16px;border-radius:6px;font-weight:700;box-shadow:0 10px 20px rgba(0,0,0,.2);display:none;z-index:70}

  /* Consulta: tabela simples */
  .tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{border:1px solid #e5e7eb;padding:8px;font-size:14px}
  .tbl th{background:#f8fafc;text-transform:uppercase;font-size:12px;color:#64748b}
  .pdf-link{color:#2563eb;font-weight:700;cursor:pointer;text-decoration:none}
  .row-muted{color:#64748b;font-size:13px}

 /* === Busy overlay === */
  .busy{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(17,24,39,.55);z-index:95}
  .busy .panel{display:flex;align-items:center;gap:10px;background:#fff;color:#111827;
             padding:12px 16px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.25);
             font-weight:700}
  .spinner{width:18px;height:18px;border:3px solid #d1d5db;border-top-color:#3b82f6;
         border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  
.code-link{color:var(--accent);text-decoration:none;font-weight:700}.code-link:hover{text-decoration:underline}

/* --- BOT√ïES COM EFEITO MODERNO --- */
.btn, .bar.enabled, #searchJsonBtn, #btnBuscarInline, #btnBuscar {
  border: none;
  font-weight: 700;
  border-radius: 1000px;
  background: linear-gradient(135deg, #4db4e2, #63C2EA);
  color: #fff;
  box-shadow: 0 8px 20px rgba(45, 152, 218, 0.35);
  transition: all 0.25s ease-in-out;
}
.btn:hover, .bar.enabled:hover, #searchJsonBtn:hover, #btnBuscarInline:hover, #btnBuscar:hover {
  transform: translateY(-1px);
  box-shadow: 0 12px 24px rgba(45, 152, 218, 0.5);
  background: linear-gradient(135deg, #63C2EA, #4db4e2);
}

/* --- SOMBRAS SUAVES EM CARDS --- */
.card {
  box-shadow: 0 12px 32px rgba(0, 0, 0, 0.05);
  transition: box-shadow 0.2s ease;
}
.card:hover {
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.08);
}

/* --- TRANSI√á√ïES MODERNAS --- */
.input, .textarea, select {
  transition: box-shadow 0.25s ease, border-color 0.25s ease;
}
.input:focus, .textarea:focus, select:focus {
  border-color: #4db4e2;
  box-shadow: 0 0 0 3px rgba(45, 152, 218, 0.25);
}

/* --- HERO GLOW + GLASS EFFECT --- */
.block, .modal .box, .viewer .panel {
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 10px;
}

/* --- ESTILO DO TOAST MODERNO --- */
.toast {
  background: linear-gradient(135deg, #10b981, #34d399);
  font-size: 14px;
  border: none;
  box-shadow: 0 6px 18px rgba(16, 185, 129, 0.4);
  animation: fadein 0.4s ease-in-out;
}

/* --- ANIMA√á√ÉO --- */
@keyframes fadein {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}

</style>

<style>
button[type="submit"] {
  display: none !important;
}

</style>

<script>
window.__CONSULTA_CFG__ = {
  PDF_PATH_CANDIDATES: ['/pdf/', '/uploads/pdf/', '/pdfs/', '/documentos/pdf/']
};
</script>
<!-- Patch de salvamento (j√° usado) -->
<script src="/documentos/erp_save_patch_flatfile.js"></script>
<style>

/* ===== PREVIEW V4 ‚Äî VISUAL-ONLY OVERRIDES (n√£o altera layout/JS) ===== */

/* T√≠tulo com faixa cinza (mant√©m estrutura) */
#tituloGerador{
  display:block;width:100%;
  padding:8px 16px;margin:6px 0;border-radius:6px;
  font-family:Candara,"Segoe UI",Roboto,Arial,Helvetica,sans-serif;
  font-weight:700;letter-spacing:.2px;line-height:1.15;
  background:#707782;color:#FFFFFF;
}
/* Se o t√≠tulo estiver dentro do card como .header .title */
.card > .header .title{
  display:block;width:100%;
  padding:8px 16px;margin:6px 0;border-radius:6px;
  font-family:Candara,"Segoe UI",Roboto,Arial,Helvetica,sans-serif;
  font-weight:700;letter-spacing:.2px;line-height:1.15;
  background:#707782;color:#FFFFFF;
}

/* Etapas maiores e mais espa√ßadas (preencher linha e aproximar dos bot√µes) */
.stage-row{display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px}
.stage-steps{display:flex;align-items:center;gap:16px}
.stage-dot{width:32px;height:32px;border-radius:999px;display:grid;place-items:center;font-weight:700;font-size:14px}
.stage-dash{width:32px;height:4px;border-radius:99px}
/* Compatibilidade com stepper existente (#stepper .dot/.line) */
#stepper{gap:16px}
#stepper .dot{width:32px;height:32px;font-size:14px}
#stepper .line{height:4px;max-width:32px;border-radius:4px}

/* Bot√£o 'Pesquisar documentos cadastrados' sempre ativo/azul, fino e p√≠lula */
#openConsultaBtn, .btn-search{
  height:28px; padding:0 12px; border-radius:1000px;
  font-size:13px; font-weight:700; letter-spacing:.1px;
  background-image:linear-gradient(180deg,#63C2EA,#4DB4E2);
  background-color:#4DB4E2; /* fallback */
  border:1px solid #329BCC;
  color:#FFFFFF; box-shadow:0 1px 0 rgba(0,0,0,.06);
  display:inline-flex; align-items:center; justify-content:center;
}

/* Bot√£o 'Continuar' 100% do card, p√≠lula, com seta √† direita */
.continue{
  display:flex; width:100%; height:32px;
  margin:14px 0 32px; border-radius:1000px;
  align-items:center; justify-content:center;
  background-image:linear-gradient(180deg,#63C2EA,#4DB4E2);
  background-color:#4DB4E2; border:1px solid #329BCC;
  color:#FFFFFF; font-weight:700; letter-spacing:.1px;
  box-shadow:0 1px 0 rgba(0,0,0,.06);
  position:relative; padding-right:56px;
}
.continue::after{
  content:"‚Üí"; position:absolute; right:16px; top:50%; transform:translateY(-50%);
  font-weight:900; opacity:.98; color:inherit; pointer-events:none;
  font-size:20px; line-height:1;
  -webkit-text-stroke:0.6px currentColor;
  text-shadow:0 0 0 currentColor,0 .3px 0 currentColor,.3px 0 0 currentColor,-.3px 0 0 currentColor,0 -.3px 0 currentColor;
}

/* N√£o estilizar .bar para evitar duplica√ß√µes do 'Continuar' */



/* === Topbox final: stepper (esq) + a√ß√µes (dir), mesmo n√≠vel, bloco branco === */
.topbox{
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 6px;
  box-shadow: 0 1px 0 rgba(0,0,0,.04);
  padding: 8px 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin: 8px 0 6px;
}
.topbox .stepper{
  flex: 1 1 auto;
  justify-content: flex-start;
  flex-wrap: wrap;
  margin: 0;
}
.topbox .stepper .dot,
.topbox .stepper .line{ flex: 0 0 auto; }
.topbox .top-actions{ display:flex; gap:8px; margin-left:auto; }



/* Corrige: mostrar tra√ßos entre os c√≠rculos dentro da topbox */
.topbox .stepper .line{
  width: 32px;      /* tra√ßo fixo */
  max-width: 32px;
  height: 1px;      /* garante a altura do tra√ßo */
}
/* === Mobile: bot√µes em CIMA e stepper EMBAIXO (mesmo bloco), sem afetar desktop === */
@media (max-width: 480px) {
  .topbox {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    padding: 8px 4px;
  }

  .topbox .top-actions {
    order: 1;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 6px;
    width: 100%;
  }

 .topbox .stepper {
    order: 2;
    display: flex;
    justify-content: center;
    flex-wrap: nowrap;
    gap: 6px;
    width: auto;
    overflow: visible;
  }

  .topbox .stepper::-webkit-scrollbar {
    display: none;
  }

  .stepper .dot {
    width: 22px !important;
    height: 22px !important;
    font-size: 12px !important;
    flex-shrink: 0 !important;
  }

  .stepper .line {
    width: 12px !important;
    height: 2px !important;
    flex-shrink: 0 !important;
  }

  .stepper {
    scroll-snap-type: x mandatory; 
  }

  .stepper .dot {
    scroll-snap-align: start;
  }

  /* Evita barra de rolagem vis√≠vel */
  .topbox .stepper::-webkit-scrollbar {
    display: none;
  }
}


/* === Ajustes do bot√£o/ barra "Continuar" (pedido do George) === */
/* Mant√©m largura e alinhamento; apenas reduz altura, arredonda cantos e mostra seta √† direita. */
.bar{
  padding: 10px 14px;            /* ‚Üì altura menor mantendo largura/alinhamento */
  border-radius: 6px;            /* mesmo raio dos outros blocos */
  
  align-items: center;
  justify-content: center;
}
/* Seta indicativa de que h√° mais etapas √† direita */
.bar::after{
  content: "‚ûî";                  /* seta simples, sem alterar HTML */
  font-weight: 700;
  margin-left: auto;             /* ‚Äúcola‚Äù no canto direito interno */
  opacity: .8;
}
/* Estados: mant√©m contraste; seta suaviza quando desabilitado */
.bar.disabled{ background: var(--disabled); color: var(--disabledText); }
.bar.disabled::after{ opacity: .4; }
.bar.enabled{ background: var(--accent); color: var(--accentText); }



/* Exibe como flex apenas quando N√ÉO estiver oculto */
.bar:not(.hidden){ display:flex; }




/* === Ajuste de cor (tema escuro): usu√°rio/e-mail e labels em azul-petr√≥leo escuro ‚Äî √änfase 1, Mais Claro 40% === */
/* Definimos a cor como vari√°vel para f√°cil ajuste fino, se necess√°rio. */
:root[data-theme="dark"]{
  --petroleo-emp-1-40: #4FB8E8; /* aproxim. Azul-petr√≥leo escuro, √änfase 1, Mais Claro 40% */
}

/* Aplica aos textos do usu√°rio e e-mail */
:root[data-theme="dark"] .user{
  color: var(--petroleo-emp-1-40) !important;
}

/* Aplica a todos os labels de campos (mantendo .req em vermelho) */
:root[data-theme="dark"] label,
:root[data-theme="dark"] .lbl,
:root[data-theme="dark"] .field > label,
:root[data-theme="dark"] .cap{
  color: var(--petroleo-emp-1-40) !important;
}

/* Mant√©m o asterisco obrigat√≥rio em vermelho */
:root[data-theme="dark"] .cap .req,
:root[data-theme="dark"] label .req{
  color: #ef4444 !important;
}




/* === Tema escuro: cor do texto do bot√£o/link "Voltar" === */
:root[data-theme="dark"] #btnVoltar{
  color: var(--petroleo-emp-1-40) !important;
}
/* Cobertura defensiva caso o Voltar use uma classe diferente */
:root[data-theme="dark"] .btn-voltar,
:root[data-theme="dark"] .back-btn,
:root[data-theme="dark"] a.back,
:root[data-theme="dark"] button.back{
  color: var(--petroleo-emp-1-40) !important;
}




/* === Tema escuro: cor do texto do bot√£o/√°rea "Voltar" (.back) === */
:root[data-theme="dark"] .back{
  color: var(--petroleo-emp-1-40) !important;
}

</style>
<style>
/* === MOBILE (CSS-only): bot√µes em cima, stepper embaixo ‚Äî desktop intacto === */
@media (max-width: 680px){
  .topbox{
    display: flex;
    flex-direction: column !important;      /* empilha no mobile */
    align-items: stretch;
    gap: 6px;
  }
  .topbox .top-actions{
    order: 1 !important;                    /* bot√µes primeiro */
    display: flex;
    justify-content: flex-end !important;
    gap: 8px;
    flex-wrap: nowrap !important;           /* horizontal */
    width: 100%;
  }
  .topbox .stepper{
    order: 2 !important;                    /* stepper depois */
    width: 100%;
    justify-content: center !important;     /* centralizado */
    flex-wrap: wrap;
    margin-top: 2px;
  }
}

#successModal{display:none!important;visibility:hidden!important;opacity:0!important;}

#openConsultaBtn{display:none!important;visibility:hidden!important;}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>.version-badge{position:fixed;right:10px;bottom:10px;z-index:200;background:rgba(0,0,0,.85);color:#fff;padding:6px 10px;border-radius:6px;font:12px/1.2 Arial,Helvetica,sans-serif;box-shadow:0 4px 12px rgba(0,0,0,.25)}</style><script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
  .top-actions button[onclick="abrirConsulta()"] {
    display: none !important;
  }
</style>
</head>
<body>
<!-- Busy / Processando -->
<div aria-busy="true" aria-live="assertive" class="busy" id="busy" role="alert">
<div class="panel">
<div class="spinner"></div>
<div id="busyTxt">Processando, por favor, aguarde...</div>
</div>
</div>
<div class="wrap">
<div class="topbox">
<div class="stepper" id="stepper">
<div class="dot" id="dot1">1</div><div class="line" id="line12"></div>
<div class="dot" id="dot2">2</div><div class="line" id="line23"></div>
<div class="dot" id="dot3">3</div><div class="line" id="line34"></div>
<div class="dot" id="dot4">4</div><div class="line" id="line45"></div>
<div class="dot" id="dot5">5</div>
<div class="top-actions">
<button class="btn" id="themeBtn" onclick="toggleTheme()">üåô Tema</button>
<button class="btn" id="btnFecharTopo" onclick="closeWizard()">Fechar</button>
<button class="btn" id="btnLimparTopo" onclick="clearLocal()" title="Limpa apenas dados locais (browser)">Limpar dados locais</button>
</div>
</div>
</div>
<!-- TELA 1 -->
<div class="card" id="screen1">
<div class="header">
<h2 class="title">Gerador de documentos</h2>
<p class="user" id="userInfo1">Usu√°rio</p>
</div>
<div class="body">
<p class="intro">
      Informar o c√≥digo do projeto no campo abaixo. Esse c√≥digo ser√° a chave para busca de documentos e utilizado para outras funcionalidades importantes na empresa
    </p>
<div class="block">
<div class="cap">C√ìDIGO <span class="req">*</span></div>
<div class="content">
<input class="input" id="codigo" oninput="validate1()" placeholder="Digite o c√≥digo do projeto"/>
<div style="text-align:right; margin-top:6px;">
  <button id="searchJsonBtn" type="button" style="background:#000; color:#fff; font-weight:700; border:none; padding:4px 10px; border-radius:999px; cursor:pointer; line-height:1.0; font-size:13px;">Pesquisar</button>
</div>
<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
<button class="btn" id="openConsultaBtn" style="display:none!important; visibility:hidden!important;" type="button">Pesquisar documentos cadastrados</button>
</div>
</div>
</div>
<!-- Consulta inline (√öNICA) -->
<div class="block hidden" id="consultaInline">
<div class="cap">CONSULTA DE DOCUMENTOS</div>
<div class="content">
<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
<div style="flex:1;min-width:220px">
<div style="font-size:12px;color:#64748b;margin-bottom:6px">C√≥digo (opcional)</div>
<input class="input" id="consCodigoInline" placeholder="Ex.: AC00025"/>
<div class="hint">Digite o c√≥digo e clique em Buscar.</div>
</div>
<button class="btn primary" id="btnBuscarInline" type="button">Buscar</button>
</div>
<table class="tbl">
<thead>
<tr><th style="width:120px">DATA</th><th style="width:110px">C√ìDIGO</th><th>CONTRATANTE</th><th>CONTRATADA</th><th>SERVI√áO</th><th style="width:90px">PDF</th></tr>
</thead>
<tbody id="consBodyInline">
<tr><td class="row-muted" colspan="3">Sem c√≥digo, sem resultados.</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="bar disabled" id="bar1">Continuar</div>
<!-- TELA 2 -->
<div class="card hidden" id="screen2">
<div class="header"><h2 class="title">Gerador de documentos</h2><p class="user" id="userInfo2">Usu√°rio</p><p class="code">C√≥digo Projeto: <b id="codigoVal">AC00025</b></p></div>
<div class="body">
<div class="block"><div class="cap">SERVI√áO <span class="req">*</span></div><div class="content"><textarea class="textarea" id="servico" oninput="validate2()" placeholder="Digite o servi√ßo do projeto"></textarea></div></div>
<div class="block"><div class="cap">ENDERE√áO DA OBRA <span class="req">*</span></div><div class="content"><input class="input" id="endereco" oninput="validate2()" placeholder="Digite o endere√ßo da obra"/></div></div>
</div>
</div>
<div class="bar hidden disabled" id="bar2">Continuar</div>
<div class="back hidden" id="back2" onclick="goTo(1)"><span class="chev">‚óÄ</span> Voltar</div>
<!-- TELA 3 -->
<div class="card hidden" id="screen3">
<div class="header"><h2 class="title">Gerador de documentos</h2><p class="user" id="userInfo3">Usu√°rio</p><p class="code">C√≥digo Projeto: <b id="codigoVal3">AC00025</b></p></div>
<div class="body">
<div class="block"><div class="cap">DADOS DO CONTRATANTE</div></div>
<div class="grid-2">
<div class="block"><div class="cap">NOME <span class="req">*</span></div><div class="content"><input class="input" id="nomeContratante" oninput="validate3()" placeholder="Digite o nome do contratante"/></div></div>
<div class="block"><div class="cap">CPF/CNPJ <span class="req">*</span></div><div class="content">
<input class="input" id="docContratante" onblur="docBlur(this); validate3()" onfocus="docFocus(this)" oninput="docInput(this); validate3()" placeholder="Digite o CPF ou CNPJ do contratante"/>
<div class="error hidden" id="docContratanteErr">Documento inv√°lido</div>
</div></div>
</div>
<div class="block"><div class="cap">CONTATO <span class="req">*</span></div><div class="content"><input class="input" id="contatoContratante" oninput="validate3()" placeholder="Digite o nome do respons√°vel pela obra"/></div></div>
<div class="grid-2">
<div class="block"><div class="cap">CEP <span class="req">*</span></div><div class="content">
<input class="input" id="cepContratante" onblur="cepOnBlur(this,'Contratante')" onchange="cepOnBlur(this,'Contratante')" onfocusout="cepOnBlur(this,'Contratante')" oninput="cepOnInput(this)" placeholder="00000-000"/>
<div class="error hidden" id="cepContratanteErr">CEP inv√°lido</div>
<div class="hint hidden" id="cepContratanteHint">Endere√ßo preenchido pelo CEP.</div>
</div></div>
<div class="block"><div class="cap">N√öMERO <span class="req">*</span></div><div class="content"><input class="input" id="numeroContratante" oninput="validate3()" placeholder="N√∫mero"/></div></div>
</div>
<div class="grid-2">
<div class="block"><div class="cap">LOGRADOURO <span class="req">*</span></div><div class="content"><input class="input" id="logradouroContratante" oninput="validate3()" placeholder="Rua / Avenida"/></div></div>
<div class="block"><div class="cap">COMPLEMENTO</div><div class="content"><input class="input" id="complementoContratante" oninput="validate3()" placeholder="Opcional"/></div></div>
</div>
<div class="grid-2">
<div class="block"><div class="cap">BAIRRO <span class="req">*</span></div><div class="content"><input class="input" id="bairroContratante" oninput="validate3()" placeholder="Bairro"/></div></div>
<div class="block"><div class="cap">CIDADE <span class="req">*</span></div><div class="content"><input class="input" id="cidadeContratante" oninput="validate3()" placeholder="Cidade"/></div></div>
</div>
<div class="block"><div class="cap">UF <span class="req">*</span></div><div class="content">
<select class="input" id="ufContratante" onchange="validate3()">
<option value="">UF</option>
<option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option><option>CE</option><option>DF</option>
<option>ES</option><option>GO</option><option>MA</option><option>MT</option><option>MS</option><option>MG</option><option>PA</option>
<option>PB</option><option>PR</option><option>PE</option><option>PI</option><option>RJ</option><option>RN</option><option>RS</option>
<option>RO</option><option>RR</option><option>SC</option><option>SP</option><option>SE</option><option>TO</option>
</select>
</div></div>
<div class="block"><div class="cap">TELEFONE DO CONTATO <span class="req">*</span></div><div class="content"><input class="input" id="telefoneContratante" oninput="maskPhoneSimple(this); validate3()" placeholder="(00)00000-0000"/><div class="error hidden" id="telContratanteErr">Telefone inv√°lido ‚Äî formato (99)99999-9999</div></div></div>
<div class="block"><div class="cap">E-MAIL <span class="req">*</span></div><div class="content"><input class="input" id="emailContratante" oninput="validate3()" placeholder="Digite o e-mail do contato"/><div class="error hidden" id="emailContratanteErr">E-mail inv√°lido</div></div></div>
</div>
</div>
<div class="bar hidden disabled" id="bar3">Continuar</div>
<div class="back hidden" id="back3" onclick="goTo(2)"><span class="chev">‚óÄ</span> Voltar</div>
<!-- TELA 4 -->
<div class="card hidden" id="screen4">
<div class="header"><h2 class="title">Gerador de documentos</h2><p class="user" id="userInfo4">Usu√°rio</p><p class="code">C√≥digo Projeto: <b id="codigoVal4">AC00025</b></p></div>
<div class="body">
<div class="block"><div class="cap">DADOS DA CONTRATADA</div></div>
<div class="grid-2">
<div class="block"><div class="cap">NOME <span class="req">*</span></div><div class="content"><input class="input" id="nomeContratada" oninput="validate4()" placeholder="Digite o nome da contratada"/></div></div>
<div class="block"><div class="cap">CPF/CNPJ <span class="req">*</span></div><div class="content">
<input class="input" id="docContratada" onblur="docBlur(this); validate4()" onfocus="docFocus(this)" oninput="docInput(this); validate4()" placeholder="Digite o CPF ou CNPJ da contratada"/>
<div class="error hidden" id="docContratadaErr">Documento inv√°lido</div>
</div></div>
</div>
<div class="block"><div class="cap">CONTATO <span class="req">*</span></div><div class="content"><input class="input" id="contatoContratada" oninput="validate4()" placeholder="Digite o nome do respons√°vel pela obra"/></div></div>
<div class="grid-2">
<div class="block"><div class="cap">CEP <span class="req">*</span></div><div class="content">
<input class="input" id="cepContratada" onblur="cepOnBlur(this,'Contratada')" onchange="cepOnBlur(this,'Contratada')" onfocusout="cepOnBlur(this,'Contratada')" oninput="cepOnInput(this)" placeholder="00000-000"/>
<div class="error hidden" id="cepContratadaErr">CEP inv√°lido</div>
<div class="hint hidden" id="cepContratadaHint">Endere√ßo preenchido pelo CEP.</div>
</div></div>
<div class="block"><div class="cap">N√öMERO <span class="req">*</span></div><div class="content"><input class="input" id="numeroContratada" oninput="validate4()" placeholder="N√∫mero"/></div></div>
</div>
<div class="grid-2">
<div class="block"><div class="cap">LOGRADOURO <span class="req">*</span></div><div class="content"><input class="input" id="logradouroContratada" oninput="validate4()" placeholder="Rua / Avenida"/></div></div>
<div class="block"><div class="cap">COMPLEMENTO</div><div class="content"><input class="input" id="complementoContratada" oninput="validate4()" placeholder="Opcional"/></div></div>
</div>
<div class="grid-2">
<div class="block"><div class="cap">BAIRRO <span class="req">*</span></div><div class="content"><input class="input" id="bairroContratada" oninput="validate4()" placeholder="Bairro"/></div></div>
<div class="block"><div class="cap">CIDADE <span class="req">*</span></div><div class="content"><input class="input" id="cidadeContratada" oninput="validate4()" placeholder="Cidade"/></div></div>
</div>
<div class="block"><div class="cap">UF <span class="req">*</span></div><div class="content">
<select class="input" id="ufContratada" onchange="validate4()">
<option value="">UF</option>
<option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option><option>CE</option><option>DF</option>
<option>ES</option><option>GO</option><option>MA</option><option>MT</option><option>MS</option><option>MG</option><option>PA</option>
<option>PB</option><option>PR</option><option>PE</option><option>PI</option><option>RJ</option><option>RN</option><option>RS</option>
<option>RO</option><option>RR</option><option>SC</option><option>SP</option><option>SE</option><option>TO</option>
</select>
</div></div>
<div class="block"><div class="cap">TELEFONE DO CONTATO <span class="req">*</span></div><div class="content"><input class="input" id="telefoneContratada" oninput="maskPhoneSimple(this); validate4()" placeholder="(00)00000-0000"/><div class="error hidden" id="telContratadaErr">Telefone inv√°lido ‚Äî formato (99)99999-9999</div></div></div>
<div class="block"><div class="cap">E-MAIL <span class="req">*</span></div><div class="content"><input class="input" id="emailContratada" oninput="validate4()" placeholder="Digite o e-mail do contato"/><div class="error hidden" id="emailContratadaErr">E-mail inv√°lido</div></div></div>
</div>
</div>
<div class="bar hidden disabled" id="bar4">Continuar</div>
<div class="back hidden" id="back4" onclick="goTo(3)"><span class="chev">‚óÄ</span> Voltar</div>
<!-- TELA 5 -->
<div class="card hidden" id="screen5">
<div class="header"><h2 class="title">Gerador de documentos</h2><p class="user" id="userInfo5">Usu√°rio</p><p class="code">C√≥digo Projeto: <b id="codigoVal5">AC00025</b></p></div>
<div class="body">
<div class="grid-2">
<div class="block"><div class="cap">CL√ÅUSULAS <span class="req">*</span></div><div class="content"><textarea class="textarea" id="clausulas" oninput="validate5()" placeholder="Digite as cl√°usulas do documento"></textarea></div></div>
<div class="block"><div class="cap">CONDI√á√ïES DE PAGAMENTO <span class="req">*</span></div><div class="content"><textarea class="textarea" id="condicoes" oninput="validate5()" placeholder="Digite as condi√ß√µes de pagamento"></textarea></div></div>
</div>
<div class="grid-2">
<div class="block"><div class="cap">VALOR <span class="req">*</span></div><div class="content"><input class="input" id="valor" oninput="maskCurrency(this); setExtenso_Valor(); validate5()" placeholder="R$ 0,00"/><div class="hint">Formato: R$ 0.000,00</div></div></div>
<div class="block"><div class="cap">VALOR POR EXTENSO <span class="req">*</span></div><div class="content"><input class="input" id="Extenso_Valor" placeholder="Gerado automaticamente a partir do valor" readonly=""/></div></div>
</div>
<div class="grid-2">
<div class="block"><div class="cap">PRAZO (em dias) <span class="req">*</span></div><div class="content"><input class="input" id="prazo" inputmode="numeric" min="1" oninput="validate5()" placeholder="Digite o prazo de pagamento (dias)" step="1" type="number"/></div></div>
<div class="block"><div class="cap">DATA POR EXTENSO <span class="req">*</span></div><div class="content"><input class="input" id="dataExtenso" onclick="openDatePicker()" placeholder="Escolha uma data" readonly=""/><input class="hidden" id="dataPicker" onchange="fillDateExtenso()" type="date"/></div></div>
</div>
<div class="block"><div class="cap">LOGO DA EMPRESA</div><div class="content"><input accept="image/*" class="file" id="logo" onchange="showLogoName(this)" type="file"/><div class="hint" id="logoInfo" style="margin-top:6px">Anexar logo do contratante</div></div></div>
</div>
</div>
<div class="bar hidden disabled" id="bar5">Finalizar e salvar</div>
<div class="back hidden" id="back5" onclick="goTo(4)"><span class="chev">‚óÄ</span> Voltar</div>
</div>
<!-- Toast -->
<div class="toast" id="toast">Documento cadastrado com sucesso!</div>
<!-- Modal sucesso -->
<div class="modal" id="successModal" style="display:none!important; visibility:hidden!important; opacity:0!important;">
<div class="box">
<div class="hd">Documento cadastrado com sucesso!</div>
<div class="bd">Seu documento foi gerado. Voc√™ pode visualiz√°-lo agora em PDF para compartilhar.</div>
<div class="ft">
<button class="btn" onclick="closeSuccess()">Fechar</button>
<button class="btn primary" onclick="visualizarPdf()">Visualizar documento</button>
</div>
</div>
</div>
<!-- Viewer PDF -->
<div class="viewer" id="viewer">
<div class="panel">
<div class="top">
<button class="btn" onclick="downloadLastPdf()">Baixar PDF</button>
<button class="btn primary" onclick="shareLastPdf()">Compartilhar</button>
<button class="btn" onclick="closeViewer()">Fechar</button>
</div>
<iframe id="pdfFrame"></iframe>
</div>
</div>
<!-- Modal Consulta -->
<div class="modal" id="consultaModal" style="display:none">
<div class="box">
<div class="hd">Consulta de Documentos ‚Äî ERP √çmpar</div>
<div class="bd">
<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
<div style="flex:1;min-width:220px">
<div style="font-size:12px;color:#64748b;margin-bottom:6px">C√≥digo (opcional)</div>
<input class="input" id="consCodigo" placeholder="Ex.: AC00025"/>
<div class="hint">Digite o c√≥digo do projeto.
<p></p></div>
</div>
<button class="btn primary" id="btnBuscar">Buscar</button>
</div>
<table class="tbl" id="consTable">
<thead>
<tr><th style="width:120px">DATA</th><th style="width:110px">C√ìDIGO</th><th>CONTRATANTE</th><th>CONTRATADA</th><th>SERVI√áO</th><th style="width:90px">PDF</th></tr>
</thead>
<tbody id="consBody">
<tr><td class="row-muted" colspan="3">Sem c√≥digo, sem resultados.</td></tr>
</tbody>
</table>
</div>
<div class="ft">
<button class="btn" id="btnCloseConsulta">Fechar</button>
</div>
</div>
</div>
<!-- Modal A√ß√£o (Atualizar ou Gerar PDF) -->
<div class="modal" id="actionModal" style="display:none">
<div class="box" style="max-width:520px">
<div class="hd">O que voc√™ deseja fazer?</div>
<div class="bd">
<div style="color:#334155;margin-bottom:8px">Documento: <b id="actDocCode">‚Äî</b></div>
<div class="hint">Escolha abaixo para continuar:</div>
</div>
<div class="ft" style="display:flex;gap:8px;justify-content:flex-end">
<button class="btn" id="btnActionCancel" type="button">Cancelar</button>
<button class="btn" id="btnActionPdf" type="button">Gerar PDF</button>
<button class="btn primary" id="btnActionUpdate" type="button">Atualizar informa√ß√µes</button>
</div>
</div>
</div>
<!-- Modal Duplicidade -->
<div class="modal" id="dupeModal" style="display:none">
<div class="box" style="max-width:560px">
<div class="hd">Documento j√° cadastrado</div>
<div class="bd">
      Encontramos um documento com este c√≥digo. O que voc√™ deseja fazer?
      <div class="hint" id="dupeInfo" style="margin-top:8px"></div>
</div>
<div class="ft">
<button class="btn" id="btnDupCancel">Cancelar</button>
<button class="btn" id="btnDupUpdate">Atualizar informa√ß√µes</button>
<button class="btn primary" id="btnDupPrint">Imprimir PDF</button>
</div>
</div>
</div>
<script>
// trava anti-duplica√ß√£o (sempre em window, SEM let/const)
window.__savingNow = window.__savingNow === true ? true : false;
// guarda a ‚Äúassinatura‚Äù do √∫ltimo save (para idempot√™ncia local)
window.__lastSave = window.__lastSave || { sig: null, at: 0 };

function noop(){} function onlyDigits(s){return (s||'').replace(/\D+/g,'');}

/* Tema */
const THEME_KEY='impar_theme';
function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); const b=document.getElementById('themeBtn'); if(b) b.textContent=(t==='dark'?'‚òÄÔ∏è Tema':'üåô Tema'); }
(function initTheme(){ const saved=localStorage.getItem(THEME_KEY); if(saved){applyTheme(saved);} else { const prefersDark=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches; applyTheme(prefersDark?'dark':'light'); } })();
function toggleTheme(){ const cur=document.documentElement.getAttribute('data-theme')||'light'; const next=(cur==='dark')?'light':'dark'; localStorage.setItem(THEME_KEY,next); applyTheme(next); }

/* Usu√°rio */
function loadUser(){
  let u=null; try{ u=JSON.parse(localStorage.getItem('impar_user')||'null'); }catch(e){}
  const label = u ? (u.Nome+'\n'+u.Email) : 'Rafael Ramos\nrafael.@imparsistemas.com';
  document.querySelectorAll('.user').forEach(p=>{ p.innerHTML = label.replace(/\r?\n/g,'<br>'); });
}

loadUser();

/* CEP */
function cepOnInput(el){ el.value = onlyDigits(el.value).slice(0,8); const e=document.getElementById(el.id+'Err'); const h=document.getElementById(el.id+'Hint'); if(e) e.classList.add('hidden'); if(h) h.classList.add('hidden'); }
async function cepOnBlur(el, prefix){
  const d = onlyDigits(el.value).slice(0,8);
  el.value = d.length<=5 ? d : (d.substring(0,5)+'-'+d.substring(5));
  const ok = d.length===8; const e=document.getElementById(el.id+'Err'); const h=document.getElementById(el.id+'Hint'); if(e) e.classList.toggle('hidden',ok); if(h) h.classList.add('hidden'); if(!ok) return;
  try{ const r=await fetch('https://viacep.com.br/ws/'+d+'/json/'); const data=await r.json(); if(!data.erro){ const map={logradouro:'logradouro',bairro:'bairro',localidade:'cidade',uf:'uf'}; for(const k in map){ const t=document.getElementById(map[k]+prefix); if(t) t.value=data[k]||''; } if(h) h.classList.remove('hidden'); } }catch(err){}
  if(prefix==='Contratante') validate3(); else validate4();
}

/* CPF/CNPJ */
function formatCPF(d){d=onlyDigits(d).slice(0,11);return d.replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2');}
function formatCNPJ(d){d=onlyDigits(d).slice(0,14);return d.replace(/(\d{2})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1/$2').replace(/(\d{4})(\d{1,2})$/,'$1-$2');}
function isValidCPF(cpf){cpf=onlyDigits(cpf);if(cpf.length!==11||/(\d)\1{10}/.test(cpf))return false;let s=0;for(let i=0;i<9;i++)s+=+cpf[i]*(10-i);let d1=11-(s%11);d1=d1>9?0:d1;if(+cpf[9]!==d1)return false;s=0;for(let i=0;i<10;i++)s+=+cpf[i]*(11-i);let d2=11-(s%11);d2=d2>9?0:d2;return +cpf[10]===d2;}
function isValidCNPJ(cnpj){cnpj=onlyDigits(cnpj);if(cnpj.length!==14||/(\d)\1{13}/.test(cnpj))return false;const calc=(b)=>{let s=0,p=b.length-7;for(let i=b.length;i>=1;i--){s+=+b[b.length-i]*p--;if(p<2)p=9}return s%11<2?0:11-(s%11)};const b=cnpj.slice(0,12);const d1=calc(b);if(+cnpj[12]!==d1)return false;const d2=calc(b+d1);return +cnpj[13]===d2;}
function docFocus(inp){inp.value=onlyDigits(inp.value);document.getElementById(inp.id+'Err').classList.add('hidden');}
function docInput(inp){inp.value=onlyDigits(inp.value).slice(0,14);document.getElementById(inp.id+'Err').classList.add('hidden');}
function docBlur(inp){const d=onlyDigits(inp.value);let ok=false;if(d.length===11){ok=isValidCPF(d);inp.value=formatCPF(d);}else if(d.length===14){ok=isValidCNPJ(d);inp.value=formatCNPJ(d);}document.getElementById(inp.id+'Err').classList.toggle('hidden',ok);}

/* Telefone */
function formatPhoneSimple(d){d=onlyDigits(d).slice(0,11);if(d.length<=6)return d.replace(/(\d{2})(\d{0,5})/,'($1)$2');return d.replace(/(\d{2})(\d{5})(\d{0,4})/,'($1)$2-$3');}
function maskPhoneSimple(inp){const d=onlyDigits(inp.value).slice(0,11);inp.value=formatPhoneSimple(d);const id=inp.id.replace('telefone','tel')+'Err';document.getElementById(id).classList.toggle('hidden',d.length===11||d.length===0);}

/* Valor/extenso */
function formatCurrencyBR(cents){const r=Math.floor(cents/100),c=(cents%100).toString().padStart(2,'0');const rr=r.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');return 'R$ '+rr+','+c;}
function maskCurrency(inp){let d=onlyDigits(inp.value);if(!d){inp.value='';return;}inp.value=formatCurrencyBR(parseInt(d,10));}
const UNIDADES=['zero','um','dois','tr√™s','quatro','cinco','seis','sete','oito','nove'];
const DEZ_A_DEZENOVE=['dez','onze','doze','treze','catorze','quinze','dezesseis','dezessete','dezoito','dezenove'];
const DEZENAS=['','dez','vinte','trinta','quarenta','cinquenta','sessenta','setenta','oitenta','noventa'];
const CENTENAS=['','cento','duzentos','trezentos','quatrocentos','quinhentos','seiscentos','setecentos','oitocentos','novecentos'];
function trioPorExtenso(n){n%=1000;if(n===0)return'';if(n===100)return'cem';const c=Math.floor(n/100),d=Math.floor((n%100)/10),u=n%10;let p=[];if(c)p.push(CENTENAS[c]);if(d===1)p.push(DEZ_A_DEZENOVE[u]);else{if(d)p.push(DEZENAS[d]);if(u)p.push(UNIDADES[u]);}return p.join(' e ');}
function inteiroBR(n){if(n===0)return'zero';const g=[{v:n%1000,n:''},{v:Math.floor(n/1000)%1000,n:'mil'},{v:Math.floor(n/1e6)%1000,n:'milh√£o',p:'milh√µes'},{v:Math.floor(n/1e9)%1000,n:'bilh√£o',p:'bilh√µes'}];let partes=[];for(let i=g.length-1;i>=0;i--){const x=g[i];if(!x.v)continue;const ext=trioPorExtenso(x.v);if(i===1){partes.push(x.v===1?'mil':ext+' mil');continue;}if(i>=2){partes.push(ext+' '+(x.v===1?x.n:x.p));continue;}if(i===0)partes.push(ext);}return partes.join(' ');}
function valorExt(cents){const r=Math.floor(cents/100),c=cents%100;let t='';if(r>0)t+=inteiroBR(r)+' '+(r===1?'real':'reais');if(c>0){const s=inteiroBR(c)+' '+(c===1?'centavo':'centavos');t=t? t+' e '+s : s;}return t||'zero real';}
function setExtenso_Valor(){const d=onlyDigits(document.getElementById('valor').value);document.getElementById('Extenso_Valor').value=d?valorExt(parseInt(d,10)):'';}

/* Data */
function openDatePicker(){ const p=document.getElementById('dataPicker'); if(p.showPicker) p.showPicker(); else p.click(); }
function fillDateExtenso(){ const p=document.getElementById('dataPicker'); if(!p.value) return; const d=new Date(p.value+'T12:00:00'); document.getElementById('dataExtenso').value=d.toLocaleDateString('pt-BR',{day:'numeric',month:'long',year:'numeric'}); validate5(); }

/* Email */
function isValidEmail(e){ return /^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i.test(e); }

/* Navega√ß√£o base */
function updateStepper(step){[1,2,3,4,5].forEach(n=>{const d=document.getElementById('dot'+n);d.classList.remove('done','active');if(n<step)d.classList.add('done');if(n===step)d.classList.add('active');});[['line12',2],['line23',3],['line34',4],['line45',5]].forEach(([id,to])=>{const el=document.getElementById(id);if(step>=to)el.classList.add('done');else el.classList.remove('done');});}
function showOnly(id){
  ['screen1','screen2','screen3','screen4','screen5'].forEach(s=>{
    const el = document.getElementById(s);
    if (el) el.classList.add('hidden');
  });
  const cur = document.getElementById(id);
  if (cur) cur.classList.remove('hidden');

  ['bar1','bar2','bar3','bar4','bar5','back2','back3','back4','back5'].forEach(i=>{
    const el = document.getElementById(i);
    if (el) el.classList.add('hidden');
  });
}

function goTo(step){
  updateStepper(step);
  showOnly('screen'+step);

  const codigo=(document.getElementById('codigo').value||'').trim()||'AC00025';
  ['codigoVal','codigoVal3','codigoVal4','codigoVal5'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.textContent=codigo;
  });

  const bar=document.getElementById('bar'+step); if(bar) bar.classList.remove('hidden');
  const back=document.getElementById('back'+step); if(back) back.classList.remove('hidden');

  const ci=document.getElementById('consultaInline'); if(ci&&step!==1) ci.classList.add('hidden');

  const fn=window['validate'+step]; if(typeof fn==='function') fn();

  // foco no primeiro campo "edit√°vel" da etapa
  setTimeout(()=>{
    const sc = document.getElementById('screen'+step);
    if(!sc) return;
    const first = sc.querySelector('input:not([type="hidden"]):not([readonly]), textarea, select');
    if(first) first.focus({ preventScroll:true });
  }, 50);
}

/* Validadores */
function addrOk(prefix){return ['logradouro','numero','bairro','cidade','uf'].every(k => document.getElementById(k+prefix).value.trim());}
function validate1(){const v=document.getElementById('codigo').value.trim(),b=document.getElementById('bar1');if(v){b.classList.remove('disabled');b.classList.add('enabled');}else{b.classList.add('disabled');b.classList.remove('enabled');}updateStepper(1);}
function validate2(){const s=document.getElementById('servico').value.trim(),e=document.getElementById('endereco').value.trim(),b=document.getElementById('bar2');if(s&&e){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=()=>goTo(3);}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}}
function validate3(){const d=document.getElementById('docContratante').value,t=document.getElementById('telefoneContratante').value,m=document.getElementById('emailContratante').value.trim(),cep=document.getElementById('cepContratante').value.trim();const docOk=(onlyDigits(d).length===11&&isValidCPF(d))||(onlyDigits(d).length===14&&isValidCNPJ(d));const telOk=onlyDigits(t).length===11;const emailOk=isValidEmail(m);const cepOk=onlyDigits(cep).length===8;document.getElementById('emailContratanteErr').classList.toggle('hidden',emailOk||m.length===0);document.getElementById('telContratanteErr').classList.toggle('hidden',telOk||onlyDigits(t).length===0);document.getElementById('cepContratanteErr').classList.toggle('hidden',cepOk||onlyDigits(cep).length===0);const ok=['nomeContratante','contatoContratante'].every(id=>document.getElementById(id).value.trim())&&docOk&&telOk&&emailOk&&cepOk&&addrOk('Contratante');const b=document.getElementById('bar3');if(ok){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=()=>goTo(4);}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}}
function validate4(){const d=document.getElementById('docContratada').value,t=document.getElementById('telefoneContratada').value,m=document.getElementById('emailContratada').value.trim(),cep=document.getElementById('cepContratada').value.trim();const docOk=(onlyDigits(d).length===11&&isValidCPF(d))||(onlyDigits(d).length===14&&isValidCNPJ(d));const telOk=onlyDigits(t).length===11;const emailOk=isValidEmail(m);const cepOk=onlyDigits(cep).length===8;document.getElementById('emailContratadaErr').classList.toggle('hidden',emailOk||m.length===0);document.getElementById('telContratadaErr').classList.toggle('hidden',telOk||onlyDigits(t).length===0);document.getElementById('cepContratadaErr').classList.toggle('hidden',cepOk||onlyDigits(cep).length===0);const ok=['nomeContratada','contatoContratada'].every(id=>document.getElementById(id).value.trim())&&docOk&&telOk&&emailOk&&cepOk&&addrOk('Contratada');const b=document.getElementById('bar4');if(ok){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=()=>goTo(5);}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}}
function isValidCurrencyInput(){return /R\$\s\d{1,3}(\.\d{3})*,\d{2}$/.test(document.getElementById('valor').value);}
function validate5(){
  setExtenso_Valor();
  const ok = isValidCurrencyInput()
    && parseInt(document.getElementById('prazo').value,10) > 0
    && document.getElementById('dataExtenso').value.trim().length > 0
    && ['clausulas','condicoes','Extenso_Valor'].every(id=>document.getElementById(id).value.trim());

  const b = document.getElementById('bar5');
  if (!b) return; // sem bot√£o, n√£o h√° o que habilitar

  if (ok){
    b.classList.remove('disabled');
    b.classList.add('enabled');
    b.onclick = withSaveLock(finalizeStep5);
  }else{
    b.classList.add('disabled');
    b.classList.remove('enabled');
    b.onclick = noop;
  }
}
/* LOGO utils */
let __logoCached = null;
function showLogoName(inp){
  const f = inp.files && inp.files[0];
  const el = document.getElementById('logoInfo');
  el.textContent = f ? ('Anexo: ' + f.name) : 'Anexar logo do contratante';
  __logoCached = null;
}
// Busy helpers
function showBusy(msg){
  const el = document.getElementById('busy');
  if (!el) return;
  const t = document.getElementById('busyTxt');
  if (t) t.textContent = msg || 'Processando, por favor, aguarde...';
  el.style.display = 'flex';
  document.body.style.cursor = 'progress';
}
function hideBusy(){
  const el = document.getElementById('busy');
  if (!el) return;
  el.style.display = 'none';
  document.body.style.cursor = '';
}
function detectFormatFromDataUrl(dt){
  if(!dt || typeof dt!=='string') return 'PNG';
  if(dt.startsWith('data:image/jpeg')) return 'JPEG';
  if(dt.startsWith('data:image/jpg'))  return 'JPEG';
  if(dt.startsWith('data:image/webp')) return 'WEBP';
  return 'PNG';
}
function loadLogoForPdf(){
  return new Promise((resolve)=>{
    if(__logoCached) return resolve(__logoCached);
    const inp = document.getElementById('logo');
    const file = inp && inp.files && inp.files[0];
    if(!file) return resolve(null);
    const fr = new FileReader();
    fr.onload = () => {
      const url = fr.result;
      const img = new Image();
      img.onload = () => {
        const maxW = 110;
        const ratio = img.naturalWidth ? (maxW / img.naturalWidth) : 1;
        const w = Math.min(maxW, img.naturalWidth) * (img.naturalWidth ? ratio : 1);
        const h = img.naturalHeight ? (img.naturalHeight * (w / (img.naturalWidth||w))) : 40;
        __logoCached = { url, w, h, fmt: detectFormatFromDataUrl(url) };
        resolve(__logoCached);
      };
      img.src = url;
    };
    fr.readAsDataURL(file);
  });
}

/* PDF */
function currentCode(){ return (document.getElementById('codigo').value||'').trim() || 'DOC'; }
//function todayYMD(){ const d=new Date(); const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const dd=('0'+d.getDate()).slice(-2); return `${y}${m}${dd}`; }
let __pdfBlob=null, __pdfUrl=null, __pdfName='documento.pdf';

async function createPdfBlob(){
  const logo = await loadLogoForPdf();
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF({unit:'pt',format:'a4'}), pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight(), M=40; let y=M;
  function drawLogo(){ if(!logo) return; try{ pdf.addImage(logo.url, logo.fmt, pageW - M - logo.w, M - 6, logo.w, logo.h); }catch(e){} }
  function h1(t){pdf.setFont('Helvetica','bold');pdf.setFontSize(16);drawLogo();pdf.text(t,pageW/2,y,{align:'center'});y+=22;pdf.setDrawColor(200);pdf.line(M,y,pageW-M,y);y+=14;}
  function lv(l,v){pdf.setFont('Helvetica','bold');pdf.setFontSize(11);const lines=pdf.splitTextToSize(l+' '+v,pageW-2*M);pdf.text(lines,M,y);y+=lines.length*14;}
  function block(l,v){pdf.setFont('Helvetica','bold');pdf.setFontSize(12);pdf.text(l,M,y);y+=14;pdf.setFont('Helvetica','normal');pdf.setFontSize(11);const lines=pdf.splitTextToSize(v,pageW-2*M);for(const line of lines){if(y>pageH-M){pdf.addPage();y=M;drawLogo();}pdf.text(line,M,y);y+=14;}y+=6;}
  function ensure(h){if(y+h>pageH-M){pdf.addPage();y=M;}}
  const get=(id)=>(document.getElementById(id).value||'').trim();
  const end=(p)=>{ const log=document.getElementById('logradouro'+p).value||'',num=document.getElementById('numero'+p).value||'',comp=document.getElementById('complemento'+p).value||'',bai=document.getElementById('bairro'+p).value||'',cid=document.getElementById('cidade'+p).value||'',uf=document.getElementById('uf'+p).value||'',cep=(document.getElementById('cep'+p).value||''); let base=log+', '+num+(comp?(' - '+comp):''); base+=' ‚Äî '+bai+' ‚Äî '+cid+'/'+uf+' ‚Äî CEP '+cep; return base; };
  const u = JSON.parse(localStorage.getItem('impar_user')||'null');

  h1('Resumo do Documento');
  lv('Operador:', u ? (u.Nome+' ('+u.Email+')') : '‚Äî'); y+=6;
  lv('C√≥digo do Projeto:', get('codigo')); y+=8;
  block('Servi√ßo:', get('servico'));
  lv('Endere√ßo da obra:', get('endereco')); y+=8;

  pdf.setFont('Helvetica','bold');pdf.setFontSize(13);ensure(24);pdf.text('CONTRATANTE',M,y);y+=16;pdf.setDrawColor(220);pdf.line(M,y,pageW-M,y);y+=10;
  lv('Nome:', get('nomeContratante'));
  lv('CPF/CNPJ:', get('docContratante'));
  lv('Endere√ßo:', end('Contratante'));
  lv('Contato:', get('contatoContratante'));
  lv('Telefone:', get('telefoneContratante'));
  lv('E-mail:', get('emailContratante')); y+=8;

  pdf.setFont('Helvetica','bold');pdf.setFontSize(13);ensure(24);pdf.text('CONTRATADA',M,y);y+=16;pdf.setDrawColor(220);pdf.line(M,y,pageW-M,y);y+=10;
  lv('Nome:', get('nomeContratada'));
  lv('CPF/CNPJ:', get('docContratada'));
  lv('Endere√ßo:', end('Contratada'));
  lv('Contato:', get('contatoContratada'));
  lv('Telefone:', get('telefoneContratada'));
  lv('E-mail:', get('emailContratada')); y+=8;

  pdf.setFont('Helvetica','bold');pdf.setFontSize(13);ensure(24);pdf.text('CONDI√á√ïES',M,y);y+=16;pdf.setDrawColor(220);pdf.line(M,y,pageW-M,y);y+=10;
  lv('Valor:', get('valor')+' ('+get('Extenso_Valor')+')');
  lv('Prazo:', get('prazo')+' dias');
  lv('Data:', get('dataExtenso'));
  block('Condi√ß√µes de pagamento:', get('condicoes'));
  block('Cl√°usulas:', get('clausulas'));

  return pdf.output('blob');
}

function openViewerWithBlob(blob){
  __pdfBlob = blob;
  if(__pdfUrl) URL.revokeObjectURL(__pdfUrl);
  __pdfUrl = URL.createObjectURL(blob);
  __pdfName = `${currentCode()}_${todayYMD()}.pdf`;
  document.getElementById('pdfFrame').src = __pdfUrl;
  document.getElementById('viewer').style.display='flex';
}
function closeViewer(){ document.getElementById('viewer').style.display='none'; }
function downloadLastPdf(){ if(!__pdfBlob) return; const a=document.createElement('a'); a.href=__pdfUrl; a.download=__pdfName; document.body.appendChild(a); a.click(); a.remove(); }
async function shareLastPdf(){
  if(!__pdfBlob){ showToast('Gere o PDF primeiro'); return; }
  const file = new File([__pdfBlob], __pdfName, {type:'application/pdf'});
  try{
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({files:[file], title:'Documento', text:'Envio do documento em PDF'});
    }else if(navigator.share){
      await navigator.share({title:'Documento', text:'Envio do documento em PDF', url: __pdfUrl});
    }else{
      const txt = encodeURIComponent('Documento gerado. Baixe aqui: '+location.href);
      window.open('https://wa.me/?text='+txt,'_blank');
    }
  }catch(e){}
}
// envolve a a√ß√£o com lock + overlay
function withSaveLock(handler){
  return async function(...args){
    const bar = document.getElementById('bar5');

    // usa SEMPRE a mesma trava global
    if (window.__savingNow || bar?.dataset.lock === '1'){
      console.warn('[index] salvamento bloqueado (em andamento)');
      return;
    }

    try{
      window.__savingNow = true;
      if (bar){ bar.dataset.lock = '1'; bar.style.pointerEvents = 'none'; bar.classList.add('disabled'); }
      showBusy('Gerando e salvando o PDF...');
      return await handler.apply(this, args);
    } finally {
      hideBusy();
      if (bar){ delete bar.dataset.lock; bar.style.pointerEvents = ''; bar.classList.remove('disabled'); }
      window.__savingNow = false;
    }
  };
}

/* Toast + success modal */
function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 2000);
}

async function finalizeStep5(){
  // OBS: o overlay j√° √© controlado por withSaveLock(finalizeStep5)
  // via validate5(), ent√£o aqui n√£o chamamos showBusy/hideBusy.
  const blob = await createPdfBlob();
  const res  = await saveDocumentWithPdf(blob);

  if (res && res.ok) {
    try{ if (window.__lastSave && window.__lastSave.dados) { __afterPdfSavedGenerateExcel(window.__lastSave.dados); } }catch(e){ console.error(e); }
    showToast('Documento cadastrado com sucesso!');
    setTimeout(() => {
      document.getElementById('successModal').style.display = 'flex';
    }, 300);
  } else {
    showToast('N√£o foi poss√≠vel salvar. Tente novamente.');
  }
}
function closeSuccess(){ document.getElementById('successModal').style.display='none'; }
async function visualizarPdf(){ closeSuccess(); const blob = await createPdfBlob(); openViewerWithBlob(blob); }

// ...c√≥digo anterior...

// === SUBSTITUA sua fun√ß√£o por esta ===
async function saveDocumentWithPdf(pdfBlob){
  try{
    // usa as configs do patch
    const patch      = (window.__ERP_SAVE_PATCH__ || {});
    const SAVE_URL   = patch.SAVE_URL || 'https://api.erpimpar.com.br/gerador/save.php';
    const SAVE_TOKEN = patch.SAVE_TOKEN || '';

    const get = (id) => (document.getElementById(id)?.value || '').trim();
    const joinAddr = (p) => {
      const log = document.getElementById('logradouro'+p).value || '';
      const num = document.getElementById('numero'+p).value || '';
      const comp= document.getElementById('complemento'+p).value || '';
      const bai = document.getElementById('bairro'+p).value || '';
      const cid = document.getElementById('cidade'+p).value || '';
      const uf  = document.getElementById('uf'+p).value || '';
      const cep = document.getElementById('cep'+p).value || '';
      return `${log}, ${num}${comp?(' - '+comp):''} ‚Äî ${bai} ‚Äî ${cid}/${uf} ‚Äî CEP ${cep}`;
    };
    const u = JSON.parse(localStorage.getItem('impar_user') || 'null') || {};

    const dados = {
      codigo:        get('codigo'),
      servico:       get('servico'),
      enderecoObra:  get('endereco'),
      valor:         get('valor'),
      Extenso_Valor: get('Extenso_Valor'),
      prazo:         get('prazo'),
      dataExtenso:   get('dataExtenso'),
      clausulas:     get('clausulas'),
      condicoes:     get('condicoes'),
      clausulas_texto:     get('clausulas'),
      condicoes_pagamento: get('condicoes'),
      contratante: {
        nome:     get('nomeContratante'),
        cpfCnpj:  get('docContratante'),
        endereco: joinAddr('Contratante'),
        contato:  get('contatoContratante'),
        telefone: get('telefoneContratante'),
        email:    get('emailContratante')
      },
      contratada: {
        nome:     get('nomeContratada'),
        cpfCnpj:  get('docContratada'),
        endereco: joinAddr('Contratada'),
        contato:  get('contatoContratada'),
        telefone: get('telefoneContratada'),
        email:    get('emailContratada')
      },
      operador: { nome: u.Nome || '', email: u.Email || '' }
    };

   // nome do arquivo
   //const ymd  = (new Date()).toISOString().slice(0,10).replace(/-/g,'');
    const code = (dados.codigo || 'DOC').replace(/[^A-Za-z0-9_\-]/g,'_') || 'DOC';
    const pdfName = `${code}_${ymd}.pdf`;

    // ---- Guard anti duplica√ß√£o em janela curta (4s) ----
    const now = Date.now();
    const sig = `${code}|${pdfName}`;
    if (window.__lastSave && window.__lastSave.sig === sig && (now - window.__lastSave.at) < 4000){
      console.warn('[index] tentativa duplicada detectada (4s) ‚Äî ignorado');
      return { ok:false, reason:'local-dupe-guard' };
    }
    window.__lastSave = { sig, at: now, dados };
    // -----------------------------------------------------

    // chamada √öNICA: usa o patch e PASSA "dados"
    if (typeof window.saveWithLogo === 'function') {
      console.log('[index] enviando p/ patch:', dados);
      return await window.saveWithLogo(pdfBlob, pdfName, dados);
    }

    console.warn('[index] Patch ausente ‚Äî sem fallback para evitar duplica√ß√£o.');
    return { ok:false, reason:'no-patch' };

  } catch (e) {
    console.warn('saveDocumentWithPdf error', e);
    showToast('Erro inesperado ao salvar.');
    return { ok:false, error:String(e) };
  }
}

</script>

<script src="consulta_json_v3_beauty-bkp-Funcionando-Gerador-Contrato__PATCHED.js"></script>

<script>

/* ===== Consulta ===== */
const LOGIN_URL='/login_doc.html';
const apiPatch=(window.__ERP_SAVE_PATCH__||{});
function pdfHrefFromRow(row){
  return row.pdf_url || row.PDF_URL || '';
}
function openConsulta(){
  const el=document.getElementById('consultaModal');
  const inp=document.getElementById('consCodigo');
  const code=(document.getElementById('codigo').value||'').trim();
  inp.value=code;
  renderConsMsg('Sem c√≥digo, sem resultados.');
  el.style.display='flex';
}
function closeConsulta(){ document.getElementById('consultaModal').style.display='none'; }
function renderConsMsg(msg){
  const tb=document.getElementById('consBody');
  tb.innerHTML=`<tr><td colspan="3" class="row-muted">${msg}</td></tr>`;
}

// -------- Consulta (inline + modal) SEM token na URL --------

/* === Helpers para PDF (fallback inteligente) === */
function getApiBaseFromPatch(){
  const listUrl = (window.__ERP_SAVE_PATCH__?.LIST_URL || '').trim();
  if (!listUrl) return '';
  return listUrl.replace(/\/list\.php.*$/,'').replace(/\/+$/,'');
}


async function openPdfSmart(row){
  const file = row.pdf || row.pdf_file || '';
  if (row.pdf_url || row.PDF_URL){
    window.open(row.pdf_url || row.PDF_URL, '_blank', 'noopener');
    return;
  }
  const apiBase = getApiBaseFromPatch();
  if (!apiBase || !file){
    alert('PDF n√£o dispon√≠vel para este registro.');
    return;
  }
  const base = apiBase.replace(/\/+$/,'');
  const candidates = [
    base + '/pdf/' + encodeURIComponent(file),
    base + '/pdf.php?f=' + encodeURIComponent(file)
  ];

  for (const url of candidates){
    try{
      const r = await fetch(url, { method:'HEAD', mode:'cors' });
      if (r.ok || r.status === 405){
        window.open(url, '_blank', 'noopener');
        return;
      }
    }catch(e){}
  }
  window.open(candidates[0], '_blank', 'noopener');
}




/* === Helpers para extrair nomes dinamicamente === */
function _normalize(v){
  if (v==null) return '';
  if (typeof v === 'string') return v.trim();
  if (typeof v === 'number') return String(v);
  if (typeof v === 'object'){
    // tenta campos comuns
    const cand = v.razao || v.razao_social || v.razaoSocial || v.nome || v.Nome || v.fantasia;
    if (typeof cand === 'string') return cand.trim();
  }
  return '';
}

function pickByKeys(obj, keysLike){
  // 1) tenta chaves exatas
  for (const k of keysLike){
    if (k in obj){
      const val = _normalize(obj[k]);
      if (val) return val;
    }
  }
  // 2) procura por substring (case-insensitive)
  const lc = Object.keys(obj).map(k => [k, k.toLowerCase()]);
  for (const [orig, low] of lc){
    if (keysLike.some(s => low.includes(s.toLowerCase()))){
      const val = _normalize(obj[orig]);
      if (val) return val;
    }
  }
  // 3) se for objeto dentro (ex.: obj.contratante = {...})
  for (const [orig, low] of lc){
    if (keysLike.some(s => low.includes(s.toLowerCase()))){
      const v = obj[orig];
      if (v && typeof v === 'object'){
        const cand = _normalize(v);
        if (cand) return cand;
      }
    }
  }
  return '';
}



function getContratanteFromRow(row){
  const val = pickByKeys(row, [
    // padr√µes antigos
    'contratante_nome','CONTRATANTE_NOME','contratante','CONTRATANTE','cliente','CLIENTE',
    'razao_contratante','razaoSocialContratante','razao_social_contratante','contratante_razao',
    // novos (do console): cta_*
    'cta_nome','cta_razao','ctaRazao','cta_razaoSocial','cta_razao_social','cta_nomeFantasia','cta_fantasia'
  ]);
  if (val) return val;
  console.debug('[consulta] CONTRATANTE n√£o identificado. Chaves dispon√≠veis:', Object.keys(row));
  return '-';
}
function getContratadaFromRow(row){
  let val = pickByKeys(row, [
    'contratada_nome','CONTRATADA_NOME','contratada','CONTRATADA','fornecedor','FORNECEDOR',
    'razao_contratada','razaoSocialContratada','razao_social_contratada','contratada_razao',
    // tentativas com prefixos usuais
    'ctd_nome','ctd_razao','ctdRazao','ctd_razaoSocial','ctd_razao_social',
    // alguns backends usam "empresa" para a contratada
    'empresa','empresa_nome','empresaRazao'
  ]);
  if (!val){
    // muitos documentos da √çmpar t√™m contratada fixa
    val = 'IMPAR CLIMATIZA√á√ÉO E SISTEMAS LTDA';
  }
  return val;
}


function pick(row, keys){
  for (const k of keys){
    if (row && Object.prototype.hasOwnProperty.call(row, k) && row[k] != null && String(row[k]).trim() !== ''){
      return row[k];
    }
  }
  return '';
}
function fmtDate(v){
  if (!v) return '';
  const d = new Date(String(v).replace(' ', 'T'));
  if (isNaN(d)) return String(v);
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  return `${dd}/${mm}/${yyyy}, ${hh}:${mi}:${ss}`;
}
// Prefer proxy like the external page does
function pdfHrefFromRow(row){
  const raw = pick(row, ['pdf_file','file','pdf','pdf_url','pdfUrl','url','URL']);
  if (!raw) return '#';
  const fname = String(raw)
    .replace(/^https?:\/\/[^/]+/i, '')
    .replace(/\?.*$/, '')
    .split('/').filter(Boolean).pop();
  if (!fname || !fname.toLowerCase().endsWith('.pdf')) return '#';
  const apiBase = (window.__ERP_SAVE_PATCH__?.LIST_URL || '').replace(/\/list\.php.*/, '');
  return apiBase ? `${apiBase}/pdf.php?f=${encodeURIComponent(fname)}` : '#';
}



// === A√ß√µes no clique do C√ìDIGO ===
function openPdfFromRow(row){
  try{
    const href = pdfHrefFromRow ? pdfHrefFromRow(row) : (row.pdf_url || row.pdf || '#');
    if (href && href !== '#') window.open(href, '_blank', 'noopener');
    else alert('PDF n√£o dispon√≠vel para este registro.');
  }catch(e){ alert('N√£o foi poss√≠vel abrir o PDF.'); }
}
function setIfExists(id, value){
  const el = document.getElementById(id);
  if (!el) return;
  el.value = (value ?? '').toString();
  try{ el.dispatchEvent(new Event('input', {bubbles:true})); }catch(_){}
}
function pick2(row, keys){
  for (const k of keys){
    if (row && Object.prototype.hasOwnProperty.call(row, k) && row[k] != null && String(row[k]).trim() !== ''){
      return row[k];
    }
  }
  return '';
}
function fillFromRowFallback(row){
  setIfExists('codigo',      pick2(row, ['codigo','C√≥digo','CODIGO']));
  setIfExists('servico',     pick2(row, ['servico','Servi√ßo','descricao','objeto']));
  setIfExists('endereco_obra', pick2(row, ['enderecoObra','endereco_obra','obra_endereco','endereco']));
  setIfExists('contratante', pick2(row, ['ctt_nome','contratante_nome','contratante','cliente']));
  setIfExists('cnpj_contratante', pick2(row, ['ctt_cpfCnpj','contratante_cnpj','cpfCnpj','cpfCnpjContratante','contratante_doc']));
  setIfExists('contratada',  pick2(row, ['cta_nome','contratada_nome','contratada']) || 'IMPAR CLIMATIZA√á√ÉO E SISTEMAS LTDA');
  setIfExists('cnpj_contratada', pick2(row, ['cta_cpfCnpj','contratada_cnpj','contratada_doc']));
}
function proceedToStep2(){
  try{ if (typeof goTo === 'function') goTo(2); 
setTimeout(function(){ ['bar2','back2'].forEach(function(id){ var el=document.getElementById(id); if(el) el.classList.remove('hidden'); }); }, 0);
 } catch(_){}
      return;
    }

    var exists = false;
    if (window.__CJFIX_API__ && typeof window.__CJFIX_API__.fetchDoc === 'function'){
      try { var item = await window.__CJFIX_API__.fetchDoc(code); exists = !!item; } catch(_){ exists = false; }
    }

    if (exists){
      try { window.__CJFIX_API__.openDecide(code); } catch(_){}
      return;
    }

    try { if (typeof goTo === 'function') goTo(2); 
setTimeout(function(){ ['bar2','back2'].forEach(function(id){ var el=document.getElementById(id); if(el) el.classList.remove('hidden'); }); }, 0);
 } catch(_){}
  }

  var clone = btn.cloneNode(true);
  btn.parentNode.replaceChild(clone, btn);
  btn = document.getElementById('bar1');
  btn.addEventListener('click', onContinue, true);
  btn.addEventListener('click', onContinue, false);
})();
</script>

<script>
// === Guard: s√≥ permite abrir a decis√£o (openDecide) quando for clique do CONTINUAR ===
window.__ALLOW_DECIDE__ = false;
function __guardOpeners(){
  try{
    if (typeof window.openDecide === 'function' && !window.openDecide.__guarded__) {
      const __orig = window.openDecide;
      window.openDecide = function(code){
        if (!window.__ALLOW_DECIDE__) return;
        return __orig(code);
      };
      window.openDecide.__guarded__ = true;
    }
    if (window.__CJFIX_API__ && typeof window.__CJFIX_API__.openDecide === 'function' && !window.__CJFIX_API__.openDecide.__guarded__) {
      const __orig2 = window.__CJFIX_API__.openDecide;
      window.__CJFIX_API__.openDecide = function(code){
        if (!window.__ALLOW_DECIDE__) return;
        return __orig2(code);
      };
      window.__CJFIX_API__.openDecide.__guarded__ = true;
    }
  }catch(e){}
}
document.addEventListener('DOMContentLoaded', __guardOpeners);
setTimeout(__guardOpeners, 1000);
</script>
</body>
</html>