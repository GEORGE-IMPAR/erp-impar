<!-- === Consulta integrada (modal) – cole antes do </body> === -->
<script>
(function () {
  // Usa as configs já expostas pelo patch de salvamento
  const PATCH  = (window.__ERP_SAVE_PATCH__ || {});
  const LIST_URL   = PATCH.LIST_URL   || 'https://api.erpimpar.com.br/gerador/list.php';
  const SAVE_TOKEN = PATCH.SAVE_TOKEN || ''; // mantém vazio se não existir (só para não quebrar)

  // --- Util: cria estilos enxutos pro modal de consulta (reaproveita seu .modal/.box) ---
  const css = `
  .consulta-head{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .consulta-grid{width:100%;border-collapse:collapse;margin-top:12px}
  .consulta-grid th,.consulta-grid td{border:1px solid var(--border);padding:10px;text-align:left}
  .consulta-grid th{background:var(--capbg);color:#374151;font-size:12px;letter-spacing:.3px;text-transform:uppercase}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #cbd5e1;border-radius:20px;padding:6px 10px;font-weight:700;cursor:pointer}
  .pill.primary{background:#2ea3f2;border-color:transparent;color:#fff}
  .pill:disabled{opacity:.65;cursor:default}
  .muted{color:#6b7280}
  .nowrap{white-space:nowrap}
  .pdf-btn{display:inline-flex;align-items:center;gap:6px;font-weight:700}
  .pdf-btn .dot{width:8px;height:8px;border-radius:50%;background:#ef4444;display:inline-block}
  .right{margin-left:auto}
  .xbtn{cursor:pointer;font-size:18px;font-weight:900;line-height:1}
  `;
  const style = document.createElement('style'); style.textContent = css; document.head.appendChild(style);

  // --- Injeta HTML do modal (usa sua mesma estrutura .modal/.box/.hd/.bd/.ft) ---
  const modal = document.createElement('div');
  modal.id = 'consultaModal';
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="box" style="max-width:980px">
      <div class="hd consulta-head">
        <div><b>Consulta de Documentos — ERP Ímpar</b></div>
        <div class="xbtn" id="consultaClose">×</div>
      </div>
      <div class="bd">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div style="flex:1 1 260px;min-width:260px">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px">Código (opcional)</div>
            <input id="consultaCodigo" class="input" placeholder="Ex.: AC00025">
          </div>
          <button id="consultaBuscar" class="pill primary">Buscar</button>
          <div id="consultaStatus" class="muted"></div>
        </div>

        <table class="consulta-grid" style="margin-top:14px">
          <thead>
            <tr>
              <th style="width:110px">Código</th>
              <th>Obra</th>
              <th style="width:90px" class="nowrap">PDF</th>
            </tr>
          </thead>
          <tbody id="consultaRows">
            <tr><td colspan="3" class="muted">Informe um código e clique <b>Buscar</b> ou deixe vazio para listar todos.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="ft" style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="consultaFechar">Fechar</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  // --- Botão na Tela 1 (se não existir, cria automaticamente) ---
  function ensureOpenButton() {
    const host = document.querySelector('#screen1 .body') || document.getElementById('screen1');
    if (!host) return;
    let btn = document.getElementById('btnOpenConsulta');
    if (!btn) {
      const wrapper = document.createElement('div');
      wrapper.style.marginTop = '8px';
      wrapper.innerHTML = `
        <button id="btnOpenConsulta" class="btn" style="width:100%;font-weight:700">
          Pesquisar documentos cadastrados
        </button>
      `;
      host.appendChild(wrapper);
      btn = wrapper.querySelector('#btnOpenConsulta');
    }
    btn.addEventListener('click', openConsulta);
  }
  ensureOpenButton();

  // --- Helpers ---
  function openConsulta() {
    // Prefill com o código digitado na tela 1, se existir
    const codeEl = document.getElementById('codigo');
    const cod = (codeEl && codeEl.value || '').trim();
    const inp = document.getElementById('consultaCodigo');
    if (inp && cod && !inp.value) inp.value = cod;

    document.getElementById('consultaStatus').textContent = '';
    document.getElementById('consultaRows').innerHTML =
      `<tr><td colspan="3" class="muted">Informe um código e clique <b>Buscar</b> ou deixe vazio para listar todos.</td></tr>`;
    modal.style.display = 'flex';
    setTimeout(()=>inp && inp.focus(), 50);
  }
  function closeConsulta(){ modal.style.display='none'; }

  function resolvePdfHref(urlLike, row) {
    // Aceita pdf_url ou, se não houver, pdf_file
    let href = urlLike || (row && row.pdf_url) || '';
    if (!href && row && row.pdf_file) {
      href = 'https://api.erpimpar.com.br/storage/docs/' + row.pdf_file;
    }
    try {
      const u = new URL(href, 'https://api.erpimpar.com.br/');
      // Se for /storage/docs/..., usa o proxy pdf.php (evita 404/caminho interno)
      if (/^\/?storage\/docs\//.test(u.pathname)) {
        const file = u.pathname.split('/').pop();
        return 'https://api.erpimpar.com.br/gerador/pdf.php?f=' + encodeURIComponent(file);
      }
      return u.href;
    } catch(e) {
      // fallback “cru”
      return href || '#';
    }
  }

  function rowHTML(row) {
    const codigo = row.codigo || '';
    const obra   = row.contratante_nome || row.obra || '';
    const pdfHref = resolvePdfHref(row.pdf_url, row);
    const hasPdf  = !!pdfHref && pdfHref !== '#';
    return `
      <tr>
        <td class="nowrap"><b>${escapeHtml(codigo)}</b></td>
        <td>${escapeHtml(obra)}</td>
        <td class="nowrap">
          ${hasPdf
            ? `<a class="pdf-btn" href="${pdfHref}" target="_blank" rel="noopener">
                 <span class="dot"></span> abrir
               </a>`
            : `<span class="muted">—</span>`}
        </td>
      </tr>
    `;
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  async function buscar() {
    const status = document.getElementById('consultaStatus');
    const tbody  = document.getElementById('consultaRows');
    const codigo = (document.getElementById('consultaCodigo').value || '').trim();

    try {
      status.textContent = 'Buscando...';
      const fd = new FormData();
      if (SAVE_TOKEN) fd.append('token', SAVE_TOKEN);
      if (codigo) fd.append('codigo', codigo);

      const resp = await fetch(LIST_URL, { method: 'POST', body: fd });
      const data = await resp.json().catch(()=>({}));

      const rows = (data && data.rows) || [];
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="3" class="muted">Nenhum registro encontrado.</td></tr>`;
      } else {
        tbody.innerHTML = rows.map(rowHTML).join('');
      }
      status.textContent = 'OK';
    } catch (e) {
      console.error(e);
      status.textContent = 'Falha ao buscar';
      document.getElementById('consultaRows').innerHTML =
        `<tr><td colspan="3" class="muted">Erro ao buscar. Tente novamente.</td></tr>`;
    }
  }

  // Eventos do modal
  document.getElementById('consultaBuscar').addEventListener('click', buscar);
  document.getElementById('consultaFechar').addEventListener('click', closeConsulta);
  document.getElementById('consultaClose').addEventListener('click', closeConsulta);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeConsulta(); });

})();
</script>
<!-- === fim da consulta integrada === -->
