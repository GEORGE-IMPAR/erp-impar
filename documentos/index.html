<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Gerador de documentos — ERP Ímpar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon.ico" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;background:#f5f7fb;color:#0f172a}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 20px 60px rgba(2,6,23,.08)}
    .card-h{padding:18px 20px;background:#0A1A3A;color:#fff;border-radius:16px 16px 0 0}
    .card-b{padding:20px}
    .row{display:flex;gap:10px;align-items:center}
    .row input{flex:1;padding:10px;border-radius:10px;border:1px solid #cbd5e1}
    .row button{padding:10px 14px;border:0;border-radius:999px;background:#0A1A3A;color:#fff;font-weight:700;cursor:pointer}
    .meta{margin-top:12px;color:#475569;font-size:13px}
    .meta code{background:#eef2f7;border:1px solid #e2e8f0;border-radius:8px;padding:3px 6px}
  </style>

  <!-- GARANTE as 2 linhas do index: nomeTemplatePadrao() e TEMPLATE_ATUAL -->
  <script>
    (function(){
      if (typeof window.TEMPLATE_ATUAL === 'undefined') {
        // default neutro; o JS da consulta muda para Contrato/OS
        window.TEMPLATE_ATUAL = 'Template-Contrato.docx';
      }
      if (typeof window.nomeTemplatePadrao !== 'function') {
        window.nomeTemplatePadrao = function(){
          return String(window.TEMPLATE_ATUAL || 'Template-Contrato.docx').trim();
        };
      }
    })();
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="card-h">
        <div style="font-weight:900;letter-spacing:.2px">Gerador de documentos</div>
        <div style="opacity:.8;font-size:12px">Versão 20.0 • 26-10-2025</div>
      </div>
      <div class="card-b">

        <div style="margin-bottom:18px">
          Informar o código do projeto no campo abaixo. Esse código será a chave para busca de documentos e utilizado para outras funcionalidades importantes na empresa.
        </div>

        <div class="row">
          <label for="codigo" style="font-weight:700;margin-right:4px">CÓDIGO</label>
          <input id="codigo" type="text" placeholder="Digite o código do projeto" />
          <button id="searchJsonBtn" type="button">Pesquisar</button>
        </div>

        <!-- Botão do gerador legado; as 2 linhas abaixo serão atualizadas -->
        <div style="margin-top:18px" class="row">
          <button id="btnGerarContrato" type="button">Gerar (legado)</button>
          <button id="btnGerar" type="button">Gerar (novo)</button>
        </div>

        <div id="docMeta" class="meta"
             data-excel=""
             data-template="">
          <div>Excel: <code id="metaExcel">—</code></div>
          <div>Template: <code id="metaTpl">—</code></div>
        </div>

        <script>
          // utilidades do index (nada aqui define OS/Contrato; só reflete o global)
          (function(){
            const API_ORIGIN    = '';
            const PATH_EXCEL    = '/api/gerador/storage/docs';
            const PATH_TEMPLATE = '/api/gerador/templates';

            function ymd(d){d=d||new Date();const p=n=>String(n).padStart(2,'0');return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate());}

            function nomeExcelPorCodigo(codigo){
              // mantém seu padrão; ajuste se necessário
              return `${codigo}.xlsx`;
            }

            function updateMeta(excelName, templateName){
              const meta = document.getElementById('docMeta');
              const mExcel = document.getElementById('metaExcel');
              const mTpl   = document.getElementById('metaTpl');
              meta.dataset.excel    = excelName || '';
              meta.dataset.template = templateName || '';
              if (mExcel) mExcel.textContent = excelName || '—';
              if (mTpl)   mTpl.textContent   = templateName || '—';
            }

            // === AS DUAS LINHAS DO INDEX (EXCEL/TEMPLATE) =====================
            function aplicarTemplateNoIndex(tplName){
              const tpl  = String(tplName || window.nomeTemplatePadrao()).trim();
              const code = (document.getElementById('codigo')?.value || '').trim();
              const excelName = nomeExcelPorCodigo(code || 'documento');

              window.TEMPLATE_ATUAL = tpl; // fonte de verdade
              // linha 1 (excel)
              const btnGerar = document.getElementById('btnGerar');
              if (btnGerar) {
                btnGerar.dataset.excelUrl =
                  `${API_ORIGIN}${PATH_EXCEL}/${encodeURIComponent(excelName)}`;
                // linha 2 (template)
                btnGerar.dataset.templateUrl =
                  `${API_ORIGIN}${PATH_TEMPLATE}/${encodeURIComponent(window.nomeTemplatePadrao())}`;
              }
              updateMeta(excelName, tpl);
            }
            window.aplicarTemplateNoIndex = aplicarTemplateNoIndex;
            // =================================================================

            // Prepara as duas linhas sempre que o campo de código muda
            const input = document.getElementById('codigo');
            input?.addEventListener('input', () => aplicarTemplateNoIndex(window.nomeTemplatePadrao()));

            // Gatilho legado de gerar (exige as duas data-* definidas)
            const btnLegado = document.getElementById('btnGerarContrato');
            btnLegado?.addEventListener('click', function(){
              const el = document.getElementById('btnGerar');
              const excel = el?.dataset?.excelUrl;
              const tpl   = el?.dataset?.templateUrl;
              if (!excel || !tpl) {
                alert('URLs do Excel/Template não definidas (data-excel-url / data-template-url).');
                return;
              }
              window.open(excel, '_blank');
              window.open(tpl, '_blank');
            });

            // Inicializa meta exibida
            aplicarTemplateNoIndex(window.nomeTemplatePadrao());
          })();
        </script>

      </div>
    </div>
  </div>

  <!-- SEU JS de consulta (arquivo completo novo, abaixo) -->
  <script src="consulta_json_v3__AUTO_PATCHED__popular_codigo_no_modal__Parametrizavel.js"></script>
</body>
</html>
