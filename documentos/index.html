<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gerador de documentos</title>

  <style>
    :root{
      --bg:#f5f6f8;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#475569;
      --brand:#2563eb;
      --brand-2:#1d4ed8;
      --danger:#ef4444;
      --ok:#16a34a;
      --capbg:#0f172a;  /* faixa mais escura p/ destaque */
      --capfg:#ffffff;
      --bar:#cbd5e1;
      --bar-on:#2563eb;
      --label:#0b1220;
    }
    :root[data-theme="dark"]{
      --bg:#e7eaf0;
      --card:#f8fafc;
      --text:#0b1220;
      --muted:#1f2937;
      --brand:#1d4ed8;
      --brand-2:#1e40af;
      --danger:#dc2626;
      --ok:#15803d;
      --capbg:#0b1220;   /* ainda mais escura no "noite" */
      --capfg:#ffffff;
      --bar:#cbd5e1;
      --bar-on:#1d4ed8;
      --label:#0b1220;
    }
    *{box-sizing:border-box}
    .hidden{display:none!important}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:15px/1.35 "Segoe UI", Candara, system-ui, -apple-system, Arial, sans-serif}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    .topbar{display:flex;gap:8px;justify-content:flex-end;margin-bottom:10px}
    .btn{border:1px solid #e5e7eb;background:#fff;padding:9px 14px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#f8fafc}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.primary:hover{background:var(--brand-2)}
    .btn.warn{background:#fff3f3;border-color:#fecaca;color:#b91c1c}
    .btn.small{padding:5px 8px;border-radius:8px}

    .stepper{display:flex;align-items:center;justify-content:center;gap:10px;margin:14px 0 18px}
    .dot{width:36px;height:36px;border-radius:50%;border:2px solid var(--bar);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:16px;color:var(--muted);background:#fff}
    .dot.on{background:var(--brand);border-color:var(--brand);color:#fff}
    .line{width:48px;height:4px;background:var(--bar);border-radius:2px}
    .line.on{background:var(--brand)}

    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 0 rgba(0,0,0,.03);padding:0 0 8px;margin-bottom:10px}
    .header{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid #0b172b;background:var(--capbg)}
    .title{margin:0;font-size:22px;font-weight:900;color:var(--capfg);font-family:Candara,"Segoe UI",system-ui,sans-serif;letter-spacing:.2px}
    .user{margin:0;color:var(--capfg);text-align:right;white-space:nowrap;font-weight:600}
    .code{margin:0;color:var(--capfg);font-weight:700}
    .body{padding:16px}

    .block{margin:12px 0;border:1px solid #d6dae2;border-radius:10px;overflow:hidden;background:#fff}
    .block .cap{background:#eef2f7;color:var(--label);padding:10px 12px;font-weight:900;letter-spacing:.2px}
    .req{color:#ef4444;font-weight:900}
    .block .content{padding:10px}
    .input,.textarea,.select{width:100%;border:1px solid #c7ceda;border-radius:10px;padding:10px}
    .textarea{min-height:110px;resize:vertical}

    .bar,.back{user-select:none;text-align:center;background:#e5e7eb;padding:12px;border-radius:10px;margin:10px 0;cursor:pointer;font-weight:700;letter-spacing:.2px}
    .bar.disabled{opacity:.5;pointer-events:none}
    .bar.on{background:var(--brand);color:#fff}
    .back{background:#f3f4f6}

    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:30}
    .modal .box{width:min(840px,96vw);background:#fff;border-radius:14px;border:1px solid #e5e7eb;overflow:hidden}
    .modal .hd{padding:12px 14px;background:#0f172a;color:#fff;font-weight:800}
    .modal .bd{padding:14px}
    .modal .ft{padding:12px 14px;display:flex;justify-content:flex-end;gap:8px;border-top:1px solid #e5e7eb}

    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;border-radius:10px;padding:10px 12px;z-index:40;opacity:.95;display:none;max-width:75vw}

    .viewer{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:40}
    .viewer .panel{width:min(1000px,98vw);height:min(90vh,1000px);background:#fff;border-radius:14px;display:flex;flex-direction:column}
    .viewer .panel .top{padding:8px;display:flex;gap:8px;border-bottom:1px solid #e5e7eb;background:#f8fafc}
    .viewer iframe{flex:1;border:0}

    table{border-collapse:collapse}
    th,td{font-size:14px}
  </style>

  <script src="/documentos/erp_save_patch_flatfile.js?v=20251002"></script>
  <link rel="stylesheet" href="/documentos/ui-hotfix.css?v=1">

</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <button class="btn" id="themeBtn" onclick="toggleTheme()">üåô Tema</button>
      <button class="btn warn" onclick="limparDados()">Limpar dados</button>
      <button class="btn" onclick="fecharFluxo()">Fechar</button>
    </div>

    <div class="stepper" id="stepper">
      <div class="dot" id="dot1">1</div><div class="line" id="line12"></div>
      <div class="dot" id="dot2">2</div><div class="line" id="line23"></div>
      <div class="dot" id="dot3">3</div><div class="line" id="line34"></div>
      <div class="dot" id="dot4">4</div><div class="line" id="line45"></div>
      <div class="dot" id="dot5">5</div>
    </div>

    <!-- TELA 1 -->
    <div class="card" id="screen1">
      <div class="header">
        <h2 class="title">Gerador de documentos</h2>
        <p class="user" id="userInfo1">Usu√°rio</p>
      </div>
      <div class="body">
        <p>Informar a c√≥digo do projeto no campo abaixo. Esse c√≥digo ser√° a chave para busca de documentos e utilizado para outras funcionalidades importantes na empresa</p>

        <div class="block">
          <div class="cap">C√ìDIGO <span class="req">*</span></div>
          <div class="content">
            <input id="codigo" class="input" placeholder="Digite o c√≥digo do projeto" oninput="validate1()">
          </div>
        </div>

        <button class="btn primary" onclick="abrirConsulta()">Pesquisar documentos cadastrados</button>
      </div>
    </div>
    <div id="bar1" class="bar disabled" onclick="noop()">Continuar</div>

    <!-- TELA 2 -->
    <div class="card hidden" id="screen2">
      <div class="header">
        <h2 class="title">Gerador de documentos</h2>
        <p class="user" id="userInfo2">Usu√°rio</p>
        <p class="code">C√≥digo Projeto: <b id="codigoVal">‚Äî</b></p>
      </div>
      <div class="body">
        <div class="block">
          <div class="cap">SERVI√áO <span class="req">*</span></div>
          <div class="content">
            <textarea id="servico" class="textarea" placeholder="Digite o servi√ßo do projeto" oninput="validate2()"></textarea>
          </div>
        </div>

        <div class="block">
          <div class="cap">ENDERE√áO DA OBRA <span class="req">*</span></div>
          <div class="content">
            <input id="endereco" class="input" placeholder="Digite o endere√ßo da obra" oninput="validate2()">
          </div>
        </div>
      </div>
    </div>
    <div id="bar2" class="bar hidden disabled" onclick="noop()">Continuar</div>
    <div id="back2" class="back hidden" onclick="goTo(1)">‚óÄ Voltar</div>

    <!-- TELA 3 -->
    <div class="card hidden" id="screen3">
      <div class="header">
        <h2 class="title">Gerador de documentos</h2>
        <p class="user" id="userInfo3">Usu√°rio</p>
        <p class="code">C√≥digo Projeto: <b id="codigoVal3">‚Äî</b></p>
      </div>
      <div class="body">
        <div class="block"><div class="cap">DADOS DO CONTRATANTE</div></div>
        <div class="grid-2">
          <div class="block"><div class="cap">NOME <span class="req">*</span></div><div class="content"><input id="nomeContratante" class="input" placeholder="Digite o nome do contratante" oninput="validate3()"></div></div>
          <div class="block"><div class="cap">CPF/CNPJ <span class="req">*</span></div><div class="content"><input id="docContratante" class="input" placeholder="Digite o CPF/CNPJ" oninput="validate3()"></div></div>
        </div>
        <div class="block"><div class="cap">CONTATO <span class="req">*</span></div><div class="content"><input id="contatoContratante" class="input" placeholder="Digite o contato" oninput="validate3()"></div></div>
        <div class="grid-2">
          <div class="block"><div class="cap">TELEFONE <span class="req">*</span></div><div class="content"><input id="telefoneContratante" class="input" placeholder="Digite o telefone" oninput="validate3()"></div></div>
          <div class="block"><div class="cap">E-MAIL <span class="req">*</span></div><div class="content"><input id="emailContratante" class="input" placeholder="Digite o e-mail" oninput="validate3()"></div></div>
        </div>
      </div>
    </div>
    <div id="bar3" class="bar hidden disabled" onclick="noop()">Continuar</div>
    <div id="back3" class="back hidden" onclick="goTo(2)">‚óÄ Voltar</div>

    <!-- TELA 4 -->
    <div class="card hidden" id="screen4">
      <div class="header">
        <h2 class="title">Gerador de documentos</h2>
        <p class="user" id="userInfo4">Usu√°rio</p>
        <p class="code">C√≥digo Projeto: <b id="codigoVal4">‚Äî</b></p>
      </div>
      <div class="body">
        <div class="block"><div class="cap">DADOS DA CONTRATADA</div></div>
        <div class="grid-2">
          <div class="block"><div class="cap">NOME <span class="req">*</span></div><div class="content"><input id="nomeContratada" class="input" placeholder="Digite o nome da contratada" oninput="validate4()"></div></div>
          <div class="block"><div class="cap">CPF/CNPJ <span class="req">*</span></div><div class="content"><input id="docContratada" class="input" placeholder="Digite o CPF/CNPJ" oninput="validate4()"></div></div>
        </div>
        <div class="block"><div class="cap">CONTATO <span class="req">*</span></div><div class="content"><input id="contatoContratada" class="input" placeholder="Digite o contato" oninput="validate4()"></div></div>
        <div class="grid-2">
          <div class="block"><div class="cap">TELEFONE <span class="req">*</span></div><div class="content"><input id="telefoneContratada" class="input" placeholder="Telefone" oninput="validate4()"></div></div>
          <div class="block"><div class="cap">E-MAIL <span class="req">*</span></div><div class="content"><input id="emailContratada" class="input" placeholder="E-mail" oninput="validate4()"></div></div>
        </div>
      </div>
    </div>
    <div id="bar4" class="bar hidden disabled" onclick="noop()">Continuar</div>
    <div id="back4" class="back hidden" onclick="goTo(3)">‚óÄ Voltar</div>

    <!-- TELA 5 -->
    <div class="card hidden" id="screen5">
      <div class="header">
        <h2 class="title">Gerador de documentos</h2>
        <p class="user" id="userInfo5">Usu√°rio</p>
        <p class="code">C√≥digo Projeto: <b id="codigoVal5">‚Äî</b></p>
      </div>
      <div class="body">
        <div class="grid-2">
          <div class="block"><div class="cap">VALOR <span class="req">*</span></div><div class="content"><input id="valor" class="input" oninput="validate5()" placeholder="0,00"></div></div>
          <div class="block"><div class="cap">VALOR POR EXTENSO <span class="req">*</span></div><div class="content"><input id="valorExtenso" class="input" oninput="validate5()" placeholder="ex.: dez mil reais"></div></div>
        </div>
        <div class="grid-2">
          <div class="block"><div class="cap">PRAZO (dias) <span class="req">*</span></div><div class="content"><input id="prazo" class="input" oninput="validate5()" placeholder="ex.: 30"></div></div>
          <div class="block"><div class="cap">DATA POR EXTENSO <span class="req">*</span></div><div class="content"><input id="dataExtenso" class="input" oninput="validate5()" placeholder="ex.: Florian√≥polis, 01 de outubro de 2025"></div></div>
        </div>
        <div class="block"><div class="cap">CL√ÅUSULAS</div><div class="content"><textarea id="clausulas" class="textarea"></textarea></div></div>
        <div class="block"><div class="cap">CONDI√á√ïES DE PAGAMENTO</div><div class="content"><textarea id="condicoes" class="textarea"></textarea></div></div>
        <div class="block"><div class="cap">LOGO (opcional)</div><div class="content"><input type="file" id="logo" accept="image/*"></div></div>
      </div>
    </div>
    <div id="bar5" class="bar hidden disabled" onclick="noop()">Gerar PDF e salvar</div>
    <div id="back5" class="back hidden" onclick="goTo(4)">‚óÄ Voltar</div>

    <!-- Viewer -->
    <div id="viewer" class="viewer">
      <div class="panel">
        <div class="top">
          <button class="btn" onclick="downloadLastPdf()">Baixar PDF</button>
          <button class="btn primary" onclick="shareLastPdf()">Compartilhar</button>
          <button class="btn" onclick="closeViewer()">Fechar</button>
        </div>
        <iframe id="pdfFrame"></iframe>
      </div>
    </div>

    <!-- Consulta -->
    <div id="consultaModal" class="modal">
      <div class="box">
        <div class="hd">Consulta de Documentos ‚Äî ERP √çmpar</div>
        <div class="bd">
          <div class="block">
            <div class="cap">C√≥digo (opcional)</div>
            <div class="content" style="display:flex;gap:8px;align-items:center;">
              <input id="qCodigo" class="input" placeholder="Ex.: AC00025" style="flex:1">
              <button class="btn primary" onclick="buscarConsulta()">Buscar</button>
            </div>
          </div>

          <div class="block">
            <div class="cap">Resultados</div>
            <div class="content" style="overflow:auto;">
              <table style="width:100%;border-collapse:collapse">
                <thead>
                  <tr style="background:#f8fafc">
                    <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:8px">C√ìDIGO</th>
                    <th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:8px">OBRA</th>
                    <th style="text-align:center;border-bottom:1px solid #e5e7eb;padding:8px;width:60px">PDF</th>
                  </tr>
                </thead>
                <tbody id="consultaTBody">
                  <tr><td colspan="3" style="padding:10px;color:#6b7280;text-align:center">Sem c√≥digo, sem resultados.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="ft">
          <button class="btn" onclick="fecharConsulta()">Fechar</button>
        </div>
      </div>
    </div>

    <!-- Modal Duplicado -->
    <div id="dupModal" class="modal">
      <div class="box">
        <div class="hd">Documento j√° cadastrado</div>
        <div class="bd">
          <p id="dupMsg" style="margin:0 0 10px"></p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn primary" id="dupImprimir">Imprimir (abrir PDF)</button>
            <button class="btn" id="dupAtualizar">Atualizar informa√ß√µes</button>
          </div>
        </div>
        <div class="ft"><button class="btn" onclick="fecharDup()">Fechar</button></div>
      </div>
    </div>

  </div>

  <div id="toast" class="toast"></div>

  <script>
    function noop(){}
    function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2500); }

    const THEME_KEY='impar_theme';
    function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); const b=document.getElementById('themeBtn'); if(b) b.textContent=(t==='dark'?'‚òÄÔ∏è Tema':'üåô Tema'); }
    (function initTheme(){ const saved=localStorage.getItem(THEME_KEY); if(saved){applyTheme(saved);} else { const prefersDark=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches; applyTheme(prefersDark?'dark':'light'); } })();
    function toggleTheme(){ const cur=document.documentElement.getAttribute('data-theme')||'light'; const next=(cur==='dark')?'light':'dark'; localStorage.setItem(THEME_KEY,next); applyTheme(next); }

    async function loadUser(){
      try{
        const r = await fetch('/assets/usuario_doc.json', { cache:'no-store' });
        if(r.ok){
          const j=await r.json();
          const nome = j.nome||j.Nome, email = j.email||j.Email;
          if(nome||email){ setUserLabel(nome,email); return; }
        }
      }catch(e){}
      try{
        const l = JSON.parse(localStorage.getItem('impar_user')||'null');
        if(l){ setUserLabel(l.Nome,l.Email); return; }
      }catch(e){}
      if(window.imparUser){ setUserLabel(window.imparUser.nome, window.imparUser.email); return; }
      setUserLabel('Usu√°rio','usuario@empresa.com');
    }
    function setUserLabel(nome,email){
      const label = (nome||'Usu√°rio') + '<br>' + (email||'usuario@empresa.com');
      document.querySelectorAll('.user').forEach(p => p.innerHTML = label);
    }
    loadUser();

    function goTo(step){
      const ids=['screen1','screen2','screen3','screen4','screen5'];
      const bars=['bar1','bar2','bar3','bar4','bar5'];
      const backs=['back2','back3','back4','back5'];
      ids.forEach((id,i)=>{ document.getElementById(id).classList.toggle('hidden', i!==step-1); });
      bars.forEach((id,i)=>{ const el=document.getElementById(id); if(el) el.classList.toggle('hidden', i!==step-1); });
      backs.forEach((id,i)=>{ const el=document.getElementById(id); if(el) el.classList.toggle('hidden', i!==step-2); });
      document.getElementById('dot1').classList.toggle('on', step>=1);
      document.getElementById('dot2').classList.toggle('on', step>=2);
      document.getElementById('dot3').classList.toggle('on', step>=3);
      document.getElementById('dot4').classList.toggle('on', step>=4);
      document.getElementById('dot5').classList.toggle('on', step>=5);
      document.getElementById('line12').classList.toggle('on', step>1);
      document.getElementById('line23').classList.toggle('on', step>2);
      document.getElementById('line34').classList.toggle('on', step>3);
      document.getElementById('line45').classList.toggle('on', step>4);
    }
    function fecharFluxo(){
      const screen1Visible = !document.getElementById('screen1').classList.contains('hidden');
      if(screen1Visible){ window.location.href = '/login_doc.html'; } else { goTo(1); }
    }
    function limparDados(){ localStorage.removeItem('impar_form'); showToast('Dados limpos'); }

    function validate1(){ const ok = !!(document.getElementById('codigo').value||'').trim(); document.getElementById('bar1').classList.toggle('disabled', !ok); }
    function validate2(){ const ok = !!(document.getElementById('servico').value||'').trim() && !!(document.getElementById('endereco').value||'').trim(); document.getElementById('bar2').classList.toggle('disabled', !ok); }
    function validate3(){ const ok = !!(document.getElementById('nomeContratante').value||'').trim() && !!(document.getElementById('docContratante').value||'').trim() && !!(document.getElementById('contatoContratante').value||'').trim() && !!(document.getElementById('telefoneContratante').value||'').trim() && !!(document.getElementById('emailContratante').value||'').trim(); document.getElementById('bar3').classList.toggle('disabled', !ok); }
    function validate4(){ const ok = !!(document.getElementById('nomeContratada').value||'').trim() && !!(document.getElementById('docContratada').value||'').trim() && !!(document.getElementById('contatoContratada').value||'').trim() && !!(document.getElementById('telefoneContratada').value||'').trim() && !!(document.getElementById('emailContratada').value||'').trim(); document.getElementById('bar4').classList.toggle('disabled', !ok); }
    function validate5(){ const ok = !!(document.getElementById('valor').value||'').trim() && !!(document.getElementById('valorExtenso').value||'').trim() && !!(document.getElementById('prazo').value||'').trim() && !!(document.getElementById('dataExtenso').value||'').trim(); document.getElementById('bar5').classList.toggle('disabled', !ok); }

    function byId(id, v) { const el=document.getElementById(id); if(!el) return; el.value = v ?? ''; el.dispatchEvent(new Event('input')); }
    function fillFromRow(row){
      byId('codigo', row.codigo || row.CODIGO || '');
      byId('servico', row.servico || row.SERVICO || '');
      byId('endereco', row.enderecoObra || row.endereco || row.OBRA || '');
      byId('nomeContratante', row.contratante_nome || row.NOME_CONTRATANTE || '');
      byId('docContratante', (row.contratante_doc || row.DOC_CONTRATANTE || '').toString().replace(/\\D+/g,''));
      byId('contatoContratante', row.contratante_contato || '');
      byId('telefoneContratante', row.contratante_telefone || '');
      byId('emailContratante', row.contratante_email || '');
      byId('nomeContratada', row.contratada_nome || '');
      byId('docContratada', (row.contratada_doc || '').toString().replace(/\\D+/g,''));
      byId('contatoContratada', row.contratada_contato || '');
      byId('telefoneContratada', row.contratada_telefone || '');
      byId('emailContratada', row.contratada_email || '');
      byId('valor', row.valor || '');
      byId('valorExtenso', row.valorExtenso || row.valor_extenso || '');
      byId('prazo', row.prazo || '');
      byId('dataExtenso', row.dataExtenso || row.data_extenso || '');
      byId('clausulas', row.clausulas || '');
      byId('condicoes', row.condicoes || '');
      validate2(); validate3(); validate4(); validate5();
    }

    function refreshCodes(){
      const cod = (document.getElementById('codigo').value||'').trim();
      ['codigoVal','codigoVal3','codigoVal4','codigoVal5'].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent = cod || '‚Äî'; });
    }
    document.getElementById('codigo').addEventListener('input', refreshCodes);

    function abrirConsulta(){ document.getElementById('consultaModal').style.display='grid'; document.getElementById('qCodigo').value = (document.getElementById('codigo').value||'').trim(); }
    function fecharConsulta(){ document.getElementById('consultaModal').style.display='none'; }
    function rowPdfHref(row){
      const base = (window.__ERP_SAVE_PATCH__ && window.__ERP_SAVE_PATCH__.SAVE_URL.replace('/save.php','/')) || 'https://api.erpimpar.com.br/gerador/';
      const pdfFile = row.file || row.pdf_file || row.PDF || row.pdf || '';
      const url = row.pdfUrl || row.url || '';
      if(url) return url;
      if(pdfFile) return base + 'pdf.php?f=' + encodeURIComponent(pdfFile);
      return '';
    }
    async function buscarConsulta(){
      const PATCH = window.__ERP_SAVE_PATCH__ || {};
      const LIST_URL = PATCH.LIST_URL || 'https://api.erpimpar.com.br/gerador/list.php';
      const token = PATCH.SAVE_TOKEN || '';
      const q = (document.getElementById('qCodigo').value||'').trim();
      const url = LIST_URL + '?limit=100&token=' + encodeURIComponent(token) + (q?('&codigo='+encodeURIComponent(q)):'');
      const r = await fetch(url, { cache:'no-store' });
      const j = await r.json().catch(()=>({ok:false,items:[],rows:[]}));
      const rows = j.rows || j.items || [];
      const tb = document.getElementById('consultaTBody');
      tb.innerHTML = rows.length? '' : '<tr><td colspan="3" style="padding:10px;color:#6b7280;text-align:center">Sem resultados.</td></tr>';
      rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.style.cursor='pointer';
        tr.innerHTML = '<td style="padding:8px;border-bottom:1px solid #eee">'+(row.codigo||'')+'</td>' +
                       '<td style="padding:8px;border-bottom:1px solid #eee">'+(row.enderecoObra||row.endereco||row.OBRA||'')+'</td>'+
                       '<td style="padding:8px;border-bottom:1px solid #eee;text-align:center"><a class="btn small" target="_blank" href="'+rowPdfHref(row)+'">abrir</a></td>';
        tr.addEventListener('click', () => handleDuplicate(row));
        tb.appendChild(tr);
      });
    }

    function fecharDup(){ document.getElementById('dupModal').style.display='none'; }
    function openDup(row){
      const msg = 'Documento com c√≥digo <b>'+((row&&row.codigo)||document.getElementById('codigo').value)+'</b> j√° existe. O que deseja fazer?';
      document.getElementById('dupMsg').innerHTML = msg;
      document.getElementById('dupModal').style.display='grid';
      const href = rowPdfHref(row||{});
      document.getElementById('dupImprimir').onclick = function(){ fecharDup(); if(href){ window.open(href,'_blank'); } else { showToast('PDF n√£o localizado'); } };
      document.getElementById('dupAtualizar').onclick = function(){ fecharDup(); if(row) fillFromRow(row); goTo(2); };
    }
    function handleDuplicate(row){ openDup(row); }

    (function hookEtapa1(){
      const b = document.getElementById('bar1');
      if(!b) return;
      const original = b.onclick;
      b.onclick = async function(){
        const cod = (document.getElementById('codigo').value || '').trim();
        if(!cod){ showToast('Informe o c√≥digo'); return; }
        const rows = await checkCodigoDuplicado(cod);
        if(rows && rows.length){
          const r = rows[0];
          openDup(r);
        }else{
          if(typeof original === 'function') original(); else { goTo(2); refreshCodes(); }
        }
      };
    })();

    async function gerarPdfBlobFake(){
      const blob = new Blob([new Uint8Array([0x25,0x50,0x44,0x46,0x2D,0x31,0x2E,0x33,0x0A,0x25,0xE2,0xE3,0xCF,0xD3,0x0A])],{type:'application/pdf'});
      return blob;
    }
    let lastPdfUrl='';
    function openViewer(url){ lastPdfUrl=url; document.getElementById('pdfFrame').src=url; document.getElementById('viewer').style.display='grid'; }
    function closeViewer(){ document.getElementById('viewer').style.display='none'; }
    function downloadLastPdf(){ if(lastPdfUrl) window.open(lastPdfUrl,'_blank'); }
    function shareLastPdf(){ if(navigator.share && lastPdfUrl) navigator.share({title:'Documento',url:lastPdfUrl}).catch(()=>{}); else downloadLastPdf(); }

    document.getElementById('bar2').onclick = function(){ goTo(3); };
    document.getElementById('bar3').onclick = function(){ goTo(4); };
    document.getElementById('bar4').onclick = function(){ goTo(5); };
    document.getElementById('bar5').onclick = async function(){
      const blob = await gerarPdfBlobFake();
      const safeName = ((document.getElementById('codigo').value||'DOC') + '_' + new Date().toISOString().slice(0,10).replace(/-/g,'')) + '.pdf';
      const patch = window.__ERP_SAVE_PATCH__||{};
      const SAVE_URL = patch.SAVE_URL || 'https://api.erpimpar.com.br/gerador/save.php';
      const SAVE_TOKEN = patch.SAVE_TOKEN || '';
      const fd = new FormData();
      fd.append('pdf', new File([blob], safeName, {type:'application/pdf'}));
      fd.append('dados', JSON.stringify(collectFormData()));
      if(SAVE_TOKEN) fd.append('token', SAVE_TOKEN);
      const headers = {}; if(SAVE_TOKEN) headers['Authorization'] = 'Bearer '+SAVE_TOKEN;
      const resp = await fetch(SAVE_URL, { method:'POST', headers, body: fd });
      const js = await resp.json().catch(()=>({ok:false}));
      if(js && js.ok && (js.pdfUrl || js.url)){
        openViewer(js.pdfUrl || js.url);
      }else{
        showToast('Falha ao salvar/gerar PDF');
        console.log('save.php resp:', js);
      }
    };

    function collectFormData(){
      return {
        codigo: (document.getElementById('codigo').value||'').trim(),
        servico: (document.getElementById('servico').value||'').trim(),
        enderecoObra: (document.getElementById('endereco').value||'').trim(),
        contratante: {
          nome:(document.getElementById('nomeContratante').value||'').trim(),
          cpfCnpj:(document.getElementById('docContratante').value||'').trim(),
          contato:(document.getElementById('contatoContratante').value||'').trim(),
          telefone:(document.getElementById('telefoneContratante').value||'').trim(),
          email:(document.getElementById('emailContratante').value||'').trim(),
        },
        contratada: {
          nome:(document.getElementById('nomeContratada').value||'').trim(),
          cpfCnpj:(document.getElementById('docContratada').value||'').trim(),
          contato:(document.getElementById('contatoContratada').value||'').trim(),
          telefone:(document.getElementById('telefoneContratada').value||'').trim(),
          email:(document.getElementById('emailContratada').value||'').trim(),
        },
        valor:(document.getElementById('valor').value||'').trim(),
        valorExtenso:(document.getElementById('valorExtenso').value||'').trim(),
        prazo:(document.getElementById('prazo').value||'').trim(),
        dataExtenso:(document.getElementById('dataExtenso').value||'').trim(),
        clausulas:(document.getElementById('clausulas').value||'').trim(),
        condicoesPagamento:(document.getElementById('condicoes').value||'').trim(),
      };
    }

    async function checkCodigoDuplicado(codigo){
      try{
        const PATCH = window.__ERP_SAVE_PATCH__ || {};
        const LIST_URL = PATCH.LIST_URL || 'https://api.erpimpar.com.br/gerador/list.php';
        const token = PATCH.SAVE_TOKEN || '';
        const url = LIST_URL + '?token=' + encodeURIComponent(token) + '&codigo=' + encodeURIComponent(codigo||'');
        const r = await fetch(url, { cache:'no-store' });
        const j = await r.json().catch(()=>null);
        return (j && (j.rows||j.items)) ? (j.rows||j.items) : [];
      }catch(e){ return []; }
    }

    goTo(1);
    validate1();
  </script>
  <script src="/documentos/ui-hotfix.js?v=1"></script>
</body>
</html>
