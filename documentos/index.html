<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerador de documentos</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <style>
    :root { --bg:#f7f8fa; --fg:#0f172a; --muted:#64748b; --primary:#0ea5e9; --accent:#111827; --card:#ffffff; --danger:#ef4444; --ok:#16a34a; --border:#e5e7eb;}
    [data-theme="dark"] { --bg:#0b1220; --fg:#e5e7eb; --muted:#9ca3af; --primary:#38bdf8; --accent:#e5e7eb; --card:#0f172a; --border:#1f2937;}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .app{max-width:1100px;margin:24px auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px}
    .title{font-weight:700;font-size:20px}
    .toolbar{display:flex;gap:10px;align-items:center}
    .btn{border:1px solid var(--border);background:var(--card);color:var(--fg);padding:8px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:transparent}
    .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
    .btn.ghost{background:transparent}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:12px}
    .steps{display:flex;gap:6px;flex-wrap:wrap}
    .step{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--card);cursor:pointer;font-size:12px}
    .step.active{background:var(--primary);color:#fff;border-color:transparent}
    .row{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
    .col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-8{grid-column:span 8}
    label{font-size:12px;color:var(--muted);display:block}
    input[type="text"],input[type="date"],input[type="number"],textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);background:#fff;color:#111}
    textarea{min-height:120px;resize:vertical}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
    .hint{color:var(--muted);font-size:12px}.error{color:var(--danger);font-size:12px}.ok{color:var(--ok);font-size:12px}
    .hidden{display:none!important}.preview-wrap{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
    @media(max-width:720px){.row{grid-template-columns:1fr}.col-12,.col-6,.col-4,.col-8{grid-column:span 1}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">Gerador de documentos</div>
      <div class="toolbar">
        <button id="btnTema" class="btn ghost">Tema</button>
        <a class="btn" id="btnLimpar">LIMPAR DADOS</a>
        <a class="btn danger" id="btnFechar" href="/login_doc.html">FECHAR</a>
      </div>
    </header>
    <div class="card"><div class="steps" id="steps"></div></div>

    <section class="card step-pane" data-step="1">
      <div class="row">
        <div class="col-4"><label>Código do projeto *</label><input id="codigo" type="text" placeholder="EX: IM-2025-001" /><div id="codigoMsg" class="hint">Será verificado se já existe.</div></div>
        <div class="col-8"><label>Serviço</label><input id="servico" type="text" placeholder="Descrição do serviço" /></div>
        <div class="col-12"><label>Endereço da Obra</label><input id="enderecoObra" type="text" placeholder="Rua, nº, bairro, cidade/UF" /></div>
      </div>
      <div class="actions"><button class="btn primary" data-next>Prosseguir</button></div>
    </section>

    <section class="card step-pane hidden" data-step="2">
      <div class="row">
        <div class="col-4"><label>Valor</label><input id="valor" type="text" placeholder="0,00" /></div>
        <div class="col-8"><label>Valor por extenso</label><input id="valorExtenso" type="text" placeholder="cinco mil reais" /></div>
        <div class="col-6"><label>Prazo</label><input id="prazo" type="text" placeholder="30 dias" /></div>
        <div class="col-6"><label>Data por extenso</label><input id="dataExtenso" type="text" placeholder="29 de setembro de 2025" /></div>
      </div>
      <div class="actions"><button class="btn" data-prev>Voltar</button><button class="btn primary" data-next>Prosseguir</button></div>
    </section>

    <section class="card step-pane hidden" data-step="3">
      <div class="row">
        <div class="col-6"><label>Contratante (JSON)</label><textarea id="contratante" placeholder='{"razao":"Impar Engenharia","cnpj":"00.000.000/0001-00"}'></textarea></div>
        <div class="col-6"><label>Contratada (JSON)</label><textarea id="contratada" placeholder='{"razao":"Fornecedor X","cnpj":"11.111.111/0001-11"}'></textarea></div>
        <div class="col-12"><label>Operador (JSON)</label><textarea id="operador" placeholder='{"nome":"George","email":"george@imparsistemas.com"}'></textarea></div>
      </div>
      <div class="actions"><button class="btn" data-prev>Voltar</button><button class="btn primary" data-next>Prosseguir</button></div>
    </section>

    <section class="card step-pane hidden" data-step="4">
      <div class="row">
        <div class="col-12"><label>Cláusulas</label><textarea id="clausulas" placeholder="Digite as cláusulas contratuais"></textarea></div>
        <div class="col-12"><label>Condições de pagamento</label><textarea id="condicoes" placeholder="30/60/90 via boleto"></textarea></div>
        <div class="col-12"><label>Anexo opcional (PDF)</label><input id="anexoPdf" type="file" accept="application/pdf" /></div>
      </div>
      <div class="actions"><button class="btn" data-prev>Voltar</button><button class="btn primary" data-next>Prosseguir</button></div>
    </section>

    <section class="card step-pane hidden" data-step="5">
      <div class="row"><div class="col-12">
        <div class="preview-wrap" id="preview">
          <h3 style="margin:0 0 8px 0">Pré-visualização</h3>
          <div class="hint">Revise antes de finalizar. O PDF será gerado desta prévia.</div>
          <hr style="border:none;border-top:1px solid var(--border);margin:12px 0" />
          <div id="previewContent"></div>
        </div>
      </div></div>
      <div class="actions"><button class="btn" data-prev>Voltar</button><button class="btn primary" id="btnFinalizar">Finalizar e Salvar</button></div>
      <div id="finalMsg" class="hint" style="margin-top:8px"></div>
    </section>
  </div>

<script>
(function(){
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const LS_KEY='geradorDoc.v1';
  const API_BASE='https://api.erpimpar.com.br/gerador/';
  const API_SAVE=API_BASE+'save.php';
  const API_CHECK=API_BASE+'check_code.php?codigo=';

  document.getElementById('btnTema').addEventListener('click',()=>{
    const h=document.documentElement; h.setAttribute('data-theme', h.getAttribute('data-theme')==='dark'?'light':'dark');
  });
  document.getElementById('btnLimpar').addEventListener('click',()=>{localStorage.removeItem(LS_KEY); location.reload();});

  const panes=$$('.step-pane'), steps=document.getElementById('steps');
  function renderSteps(c=1){ steps.innerHTML=''; panes.forEach(p=>{const n=+p.dataset.step; const b=document.createElement('button'); b.className='step'+(n===c?' active':''); b.textContent='Etapa '+n; b.onclick=()=>go(n); steps.appendChild(b);});}
  function go(n){ panes.forEach(p=>p.classList.toggle('hidden', +p.dataset.step!==n)); renderSteps(n); if(n===5) buildPreview(); }

  const state=(()=>{try{return JSON.parse(localStorage.getItem(LS_KEY))||{}}catch{return{}}})();
  function saveState(){localStorage.setItem(LS_KEY, JSON.stringify(state));}
  const ids=['codigo','servico','enderecoObra','valor','valorExtenso','prazo','dataExtenso','contratante','contratada','operador','clausulas','condicoes'];
  ids.forEach(id=>{const el=document.getElementById(id); if(!el)return; if(state[id]) el.value=state[id]; el.addEventListener('input',()=>{state[id]=el.value; saveState();});});

  const codigo=document.getElementById('codigo'), codigoMsg=document.getElementById('codigoMsg');
  async function checkCodigo(){
    const v=(codigo.value||'').trim(); if(!v){codigoMsg.textContent='Informe um código.'; codigoMsg.className='hint'; return false;}
    try{ codigoMsg.textContent='Verificando...'; codigoMsg.className='hint'; const r=await fetch(API_CHECK+encodeURIComponent(v),{cache:'no-store'}); const js=await r.json(); if(js.exists){codigoMsg.textContent='Já existe um documento com esse código.'; codigoMsg.className='error'; return false;} codigoMsg.textContent='Código disponível.'; codigoMsg.className='ok'; return true; }
    catch{ codigoMsg.textContent='Falha na verificação (CORS ou rede).'; codigoMsg.className='error'; return false; }
  }
  codigo.addEventListener('blur', checkCodigo);

  $$('.step-pane [data-next]').forEach(b=>b.addEventListener('click',async()=>{const cur=+b.closest('.step-pane').dataset.step; if(cur===1){ if(!(await checkCodigo()))return; } go(cur+1);}));
  $$('.step-pane [data-prev]').forEach(b=>b.addEventListener('click',()=>{const cur=+b.closest('.step-pane').dataset.step; go(cur-1);}));

  function j(v){try{return JSON.parse(v||'{}')}catch{return{}}}
  function collect(){ const d={...state}; d.contratante=j(d.contratante); d.contratada=j(d.contratada); d.operador=j(d.operador); return d; }
  function buildPreview(){ const d=collect(); document.getElementById('previewContent').innerHTML=`
    <div><strong>Código:</strong> ${d.codigo||''}</div>
    <div><strong>Serviço:</strong> ${d.servico||''}</div>
    <div><strong>Endereço:</strong> ${d.enderecoObra||''}</div>
    <hr/><div><strong>Valor:</strong> ${d.valor||''} — <em>${d.valorExtenso||''}</em></div>
    <div><strong>Prazo:</strong> ${d.prazo||''}</div><div><strong>Data:</strong> ${d.dataExtenso||''}</div>
    <hr/><div><strong>Contratante:</strong> ${d.contratante?.razao||''} — ${d.contratante?.cnpj||''}</div>
    <div><strong>Contratada:</strong> ${d.contratada?.razao||''} — ${d.contratada?.cnpj||''}</div>
    <div><strong>Operador:</strong> ${d.operador?.nome||''} — ${d.operador?.email||''}</div>
    <hr/><div><strong>Cláusulas:</strong><br>${(d.clausulas||'').replace(/\n/g,'<br>')}</div>
    <div style="margin-top:8px"><strong>Condições de pagamento:</strong><br>${(d.condicoes||'').replace(/\n/g,'<br>')}</div>`; }

  async function createPdfBlob(){ const el=document.getElementById('preview'); const canvas=await html2canvas(el,{scale:2,useCORS:true}); const img=canvas.toDataURL('image/png'); const {jsPDF}=window.jspdf; const pdf=new jsPDF('p','pt','a4'); const w=pdf.internal.pageSize.getWidth(); const iw=w-80; const ratio=canvas.height/canvas.width; const ih=iw*ratio; pdf.addImage(img,'PNG',40,40,iw,ih); return pdf.output('blob'); }

  const finalMsg=document.getElementById('finalMsg');
  document.getElementById('btnFinalizar').addEventListener('click', finalize);
  async function finalize(){
    finalMsg.textContent='Gerando PDF e enviando...';
    const d=collect(); if(!(await checkCodigo())){finalMsg.textContent='Ajuste o código antes de salvar.'; return;}
    try{ const pdfBlob=await createPdfBlob(); const nomePdf=`${(d.codigo||'DOC').replace(/[^a-zA-Z0-9-_]/g,'_')}_${new Date().toISOString().slice(0,10)}.pdf`; const fd=new FormData(); fd.append('pdf', new File([pdfBlob], nomePdf, {type:'application/pdf'})); fd.append('dados', new Blob([JSON.stringify(d)],{type:'application/json'})); const anexo=document.getElementById('anexoPdf'); if(anexo.files&&anexo.files[0]) fd.append('anexo', anexo.files[0]); const r=await fetch(API_SAVE,{method:'POST',body:fd}); const js=await r.json(); if(js.success){ finalMsg.textContent='✅ Documento salvo com sucesso.';} else { finalMsg.textContent='❌ Falha ao salvar: '+(js.error||'desconhecido'); } } catch(e){ finalMsg.textContent='❌ Erro: '+e.message; }
  }

  renderSteps(1); go(1);
})();
</script>
</body>
</html>
