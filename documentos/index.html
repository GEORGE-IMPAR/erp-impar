<!DOCTYPE html>

<html data-theme="light" lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<title>Gerador de documentos</title>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{--bg:#f1f1f1;--card:#ffffff;--text:#1f2937;--border:#d1d5db;--capbg:#f3f4f6;
        --accent:#2ea3f2;--accentText:#fff;--disabled:#cbd5e1;--disabledText:#6b7280;--error:#ef4444}
  :root[data-theme="dark"] {
  --bg: #3a3a3a;                /* <- cinza escuro elegante */
  --card: #1f1f1f;
  --text: #e5e7eb;
  --border: #3c3c3c;
  --capbg: #333;
  --accent: #4db4e2;
  --accentText: #fff;
  --disabled: #555;
  --disabledText: #aaa;
  --error: #f87171;
}
  *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 Arial,Helvetica,sans-serif}
  .wrap{width:100%;max-width:clamp(420px, 90vw, 860px);margin:0 auto;padding:10px 10px 18px}
  @media (min-width: 768px){ .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px} }
  .stepper{display:flex;align-items:center;gap:10px;justify-content:center;margin:10px 0 6px;flex-wrap:wrap}
  .dot{width:18px;height:18px;border-radius:50%;border:1px solid #c7c7c7;color:#4b5563;display:flex;align-items:center;justify-content:center;font-size:11px;background:#fff}
  .dot.done,.dot.active{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:700}
  .dot.active{box-shadow:0 0 0 2px rgba(46,163,242,.35)}
  .line{height:1px;flex:1;background:#c7c7c7;max-width:24px}
  .line.done{background:var(--accent)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:6px;overflow:hidden;box-shadow:0 1px 0 rgba(0,0,0,.04)}
  .header{padding:14px 14px 6px}
  .title{ /* ... */ color: var(--text); }   /* era #111827 */
  .user{font-size:13px;color:#4b5563;margin:0 0 8px}
  .code{  /* ... */ color: var(--text); }   /* era #374151 */
  .body{padding:12px 14px 16px}
  .block{border:1px solid var(--border);background:#fff;margin:0 0 12px;border-radius:4px;overflow:hidden}
  .block .cap{background:var(--capbg);color:#6b7280;font-size:12px;text-transform:uppercase;letter-spacing:.3px;padding:6px 8px;border-bottom:1px solid var(--border)}
  .block .cap .req{color:#dc2626}.block .content{padding:8px}
  .textarea,.input,select{width:100%;border:1px solid #e5e7eb;background:#fff;padding:8px;border-radius:4px;font:15px/1.45 Arial,Helvetica,sans-serif;color:#111827;outline:none;transition:border-color .15s,box-shadow .15s}
  .textarea{min-height:120px;resize:vertical}.textarea:focus,.input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(46,163,242,.25)}
  .file{font:14px Arial,Helvetica,sans-serif}.error{color:var(--error);font-size:12px;margin-top:6px}.hint{font-size:12px;color:#6b7280;margin-top:6px}
  .bar{position:sticky;bottom:0;left:0;right:0;text-align:center;padding:14px;font-weight:700;cursor:default;margin-top:10px;border-top:1px solid #e5e7eb}
  .bar.disabled{background:var(--disabled);color:var(--disabledText)}.bar.enabled{background:var(--accent);color:var(--accentText);cursor:pointer}
  .back{display:flex;align-items:center;gap:6px;justify-content:center;color:#111827;font-size:14px;margin-top:6px;cursor:pointer;user-select:none}.back .chev{color:#f59e0b}
  .hidden{display:none}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:60}
  .modal .box{width:100%;max-width:920px;background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);border:1px solid #e5e7eb;overflow:hidden;display:flex;flex-direction:column;max-height:90vh}
  .modal .box .hd{padding:16px;border-bottom:1px solid #e5e7eb;font-weight:700}
  .modal .box .bd{padding:16px;overflow:auto}
  .modal .box .ft{padding:12px 16px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;font-weight:700;cursor:pointer}
  .btn.primary{background:#2ea3f2;color:#fff;border-color:transparent}
  .viewer{position:fixed;inset:0;background:#111827cc;display:none;align-items:center;justify-content:center;z-index:65}
  .viewer .panel{width:96%;max-width:900px;background:#fff;border-radius:6px;overflow:hidden;display:flex;flex-direction:column}
  .viewer .panel .top{padding:10px;border-bottom:1px solid #e5e7eb;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  .viewer .panel iframe{width:100%;height:80vh;border:0}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#10b981;color:#fff;padding:12px 16px;border-radius:6px;font-weight:700;box-shadow:0 10px 20px rgba(0,0,0,.2);display:none;z-index:70}

  /* Consulta: tabela simples */
  .tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{border:1px solid #e5e7eb;padding:8px;font-size:14px}
  .tbl th{background:#f8fafc;text-transform:uppercase;font-size:12px;color:#64748b}
  .pdf-link{color:#2563eb;font-weight:700;cursor:pointer;text-decoration:none}
  .row-muted{color:#64748b;font-size:13px}

 /* === Busy overlay === */
  .busy{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(17,24,39,.55);z-index:95}
  .busy .panel{display:flex;align-items:center;gap:10px;background:#fff;color:#111827;
             padding:12px 16px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.25);
             font-weight:700}
  .spinner{width:18px;height:18px;border:3px solid #d1d5db;border-top-color:#3b82f6;
         border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  
.code-link{color:var(--accent);text-decoration:none;font-weight:700}.code-link:hover{text-decoration:underline}

/* --- BOTÕES COM EFEITO MODERNO --- */
.btn, .bar.enabled, #searchJsonBtn, #btnBuscarInline, #btnBuscar {
  border: none;
  font-weight: 700;
  border-radius: 1000px;
  background: linear-gradient(135deg, #4db4e2, #63C2EA);
  color: #fff;
  box-shadow: 0 8px 20px rgba(45, 152, 218, 0.35);
  transition: all 0.25s ease-in-out;
}
.btn:hover, .bar.enabled:hover, #searchJsonBtn:hover, #btnBuscarInline:hover, #btnBuscar:hover {
  transform: translateY(-1px);
  box-shadow: 0 12px 24px rgba(45, 152, 218, 0.5);
  background: linear-gradient(135deg, #63C2EA, #4db4e2);
}

/* --- SOMBRAS SUAVES EM CARDS --- */
.card {
  box-shadow: 0 12px 32px rgba(0, 0, 0, 0.05);
  transition: box-shadow 0.2s ease;
}
.card:hover {
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.08);
}

/* --- TRANSIÇÕES MODERNAS --- */
.input, .textarea, select {
  transition: box-shadow 0.25s ease, border-color 0.25s ease;
}
.input:focus, .textarea:focus, select:focus {
  border-color: #4db4e2;
  box-shadow: 0 0 0 3px rgba(45, 152, 218, 0.25);
}

/* --- HERO GLOW + GLASS EFFECT --- */
.block, .modal .box, .viewer .panel {
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 10px;
}

/* --- ESTILO DO TOAST MODERNO --- */
.toast {
  background: linear-gradient(135deg, #10b981, #34d399);
  font-size: 14px;
  border: none;
  box-shadow: 0 6px 18px rgba(16, 185, 129, 0.4);
  animation: fadein 0.4s ease-in-out;
}

/* --- ANIMAÇÃO --- */
@keyframes fadein {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}

</style>

<style>
button[type="submit"] {
  display: none !important;
}

</style>

<script>
window.__CONSULTA_CFG__ = {
  PDF_PATH_CANDIDATES: ['/pdf/', '/uploads/pdf/', '/pdfs/', '/documentos/pdf/']
};
</script>
<!-- Patch de salvamento (já usado) -->
<script src="/documentos/erp_save_patch_flatfile.js"></script>
<style>

/* ===== PREVIEW V4 — VISUAL-ONLY OVERRIDES (não altera layout/JS) ===== */

/* Título com faixa cinza (mantém estrutura) */
#tituloGerador{
  display:block;width:100%;
  padding:8px 16px;margin:6px 0;border-radius:6px;
  font-family:Candara,"Segoe UI",Roboto,Arial,Helvetica,sans-serif;
  font-weight:700;letter-spacing:.2px;line-height:1.15;
  background:#707782;color:#FFFFFF;
}
/* Se o título estiver dentro do card como .header .title */
.card > .header .title{
  display:block;width:100%;
  padding:8px 16px;margin:6px 0;border-radius:6px;
  font-family:Candara,"Segoe UI",Roboto,Arial,Helvetica,sans-serif;
  font-weight:700;letter-spacing:.2px;line-height:1.15;
  background:#707782;color:#FFFFFF;
}

/* Etapas maiores e mais espaçadas (preencher linha e aproximar dos botões) */
.stage-row{display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px}
.stage-steps{display:flex;align-items:center;gap:16px}
.stage-dot{width:32px;height:32px;border-radius:999px;display:grid;place-items:center;font-weight:700;font-size:14px}
.stage-dash{width:32px;height:4px;border-radius:99px}
/* Compatibilidade com stepper existente (#stepper .dot/.line) */
#stepper{gap:16px}
#stepper .dot{width:32px;height:32px;font-size:14px}
#stepper .line{height:4px;max-width:32px;border-radius:4px}

/* Botão 'Pesquisar documentos cadastrados' sempre ativo/azul, fino e pílula */
#openConsultaBtn, .btn-search{
  height:28px; padding:0 12px; border-radius:1000px;
  font-size:13px; font-weight:700; letter-spacing:.1px;
  background-image:linear-gradient(180deg,#63C2EA,#4DB4E2);
  background-color:#4DB4E2; /* fallback */
  border:1px solid #329BCC;
  color:#FFFFFF; box-shadow:0 1px 0 rgba(0,0,0,.06);
  display:inline-flex; align-items:center; justify-content:center;
}

/* Botão 'Continuar' 100% do card, pílula, com seta à direita */
.continue{
  display:flex; width:100%; height:32px;
  margin:14px 0 32px; border-radius:1000px;
  align-items:center; justify-content:center;
  background-image:linear-gradient(180deg,#63C2EA,#4DB4E2);
  background-color:#4DB4E2; border:1px solid #329BCC;
  color:#FFFFFF; font-weight:700; letter-spacing:.1px;
  box-shadow:0 1px 0 rgba(0,0,0,.06);
  position:relative; padding-right:56px;
}
.continue::after{
  content:"→"; position:absolute; right:16px; top:50%; transform:translateY(-50%);
  font-weight:900; opacity:.98; color:inherit; pointer-events:none;
  font-size:20px; line-height:1;
  -webkit-text-stroke:0.6px currentColor;
  text-shadow:0 0 0 currentColor,0 .3px 0 currentColor,.3px 0 0 currentColor,-.3px 0 0 currentColor,0 -.3px 0 currentColor;
}

/* Não estilizar .bar para evitar duplicações do 'Continuar' */



/* === Topbox final: stepper (esq) + ações (dir), mesmo nível, bloco branco === */
.topbox{
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 6px;
  box-shadow: 0 1px 0 rgba(0,0,0,.04);
  padding: 8px 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin: 8px 0 6px;
}
.topbox .stepper{
  flex: 1 1 auto;
  justify-content: flex-start;
  flex-wrap: wrap;
  margin: 0;
}
.topbox .stepper .dot,
.topbox .stepper .line{ flex: 0 0 auto; }
.topbox .top-actions{ display:flex; gap:8px; margin-left:auto; }



/* Corrige: mostrar traços entre os círculos dentro da topbox */
.topbox .stepper .line{
  width: 32px;      /* traço fixo */
  max-width: 32px;
  height: 1px;      /* garante a altura do traço */
}
/* === Mobile: botões em CIMA e stepper EMBAIXO (mesmo bloco), sem afetar desktop === */
@media (max-width: 480px) {
  .topbox {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    padding: 8px 4px;
  }

  .topbox .top-actions {
    order: 1;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 6px;
    width: 100%;
  }

 .topbox .stepper {
    order: 2;
    display: flex;
    justify-content: center;
    flex-wrap: nowrap;
    gap: 6px;
    width: auto;
    overflow: visible;
  }

  .topbox .stepper::-webkit-scrollbar {
    display: none;
  }

  .stepper .dot {
    width: 22px !important;
    height: 22px !important;
    font-size: 12px !important;
    flex-shrink: 0 !important;
  }

  .stepper .line {
    width: 12px !important;
    height: 2px !important;
    flex-shrink: 0 !important;
  }

  .stepper {
    scroll-snap-type: x mandatory; 
  }

  .stepper .dot {
    scroll-snap-align: start;
  }

  /* Evita barra de rolagem visível */
  .topbox .stepper::-webkit-scrollbar {
    display: none;
  }
}


/* === Ajustes do botão/ barra "Continuar" (pedido do George) === */
/* Mantém largura e alinhamento; apenas reduz altura, arredonda cantos e mostra seta à direita. */
.bar{
  padding: 10px 14px;            /* ↓ altura menor mantendo largura/alinhamento */
  border-radius: 6px;            /* mesmo raio dos outros blocos */
  
  align-items: center;
  justify-content: center;
}
/* Seta indicativa de que há mais etapas à direita */
.bar::after{
  content: "➔";                  /* seta simples, sem alterar HTML */
  font-weight: 700;
  margin-left: auto;             /* “cola” no canto direito interno */
  opacity: .8;
}
/* Estados: mantém contraste; seta suaviza quando desabilitado */
.bar.disabled{ background: var(--disabled); color: var(--disabledText); }
.bar.disabled::after{ opacity: .4; }
.bar.enabled{ background: var(--accent); color: var(--accentText); }



/* Exibe como flex apenas quando NÃO estiver oculto */
.bar:not(.hidden){ display:flex; }




/* === Ajuste de cor (tema escuro): usuário/e-mail e labels em azul-petróleo escuro — Ênfase 1, Mais Claro 40% === */
/* Definimos a cor como variável para fácil ajuste fino, se necessário. */
:root[data-theme="dark"]{
  --petroleo-emp-1-40: #4FB8E8; /* aproxim. Azul-petróleo escuro, Ênfase 1, Mais Claro 40% */
}

/* Aplica aos textos do usuário e e-mail */
:root[data-theme="dark"] .user{
  color: var(--petroleo-emp-1-40) !important;
}

/* Aplica a todos os labels de campos (mantendo .req em vermelho) */
:root[data-theme="dark"] label,
:root[data-theme="dark"] .lbl,
:root[data-theme="dark"] .field > label,
:root[data-theme="dark"] .cap{
  color: var(--petroleo-emp-1-40) !important;
}

/* Mantém o asterisco obrigatório em vermelho */
:root[data-theme="dark"] .cap .req,
:root[data-theme="dark"] label .req{
  color: #ef4444 !important;
}




/* === Tema escuro: cor do texto do botão/link "Voltar" === */
:root[data-theme="dark"] #btnVoltar{
  color: var(--petroleo-emp-1-40) !important;
}
/* Cobertura defensiva caso o Voltar use uma classe diferente */
:root[data-theme="dark"] .btn-voltar,
:root[data-theme="dark"] .back-btn,
:root[data-theme="dark"] a.back,
:root[data-theme="dark"] button.back{
  color: var(--petroleo-emp-1-40) !important;
}




/* === Tema escuro: cor do texto do botão/área "Voltar" (.back) === */
:root[data-theme="dark"] .back{
  color: var(--petroleo-emp-1-40) !important;
}

</style>
<style>
/* === MOBILE (CSS-only): botões em cima, stepper embaixo — desktop intacto === */
@media (max-width: 680px){
  .topbox{
    display: flex;
    flex-direction: column !important;      /* empilha no mobile */
    align-items: stretch;
    gap: 6px;
  }
  .topbox .top-actions{
    order: 1 !important;                    /* botões primeiro */
    display: flex;
    justify-content: flex-end !important;
    gap: 8px;
    flex-wrap: nowrap !important;           /* horizontal */
    width: 100%;
  }
  .topbox .stepper{
    order: 2 !important;                    /* stepper depois */
    width: 100%;
    justify-content: center !important;     /* centralizado */
    flex-wrap: wrap;
    margin-top: 2px;
  }
}

#successModal{display:none!important;visibility:hidden!important;opacity:0!important;}

#openConsultaBtn{display:none!important;visibility:hidden!important;}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>.version-badge{position:fixed;right:10px;bottom:10px;z-index:200;background:rgba(0,0,0,.85);color:#fff;padding:6px 10px;border-radius:6px;font:12px/1.2 Arial,Helvetica,sans-serif;box-shadow:0 4px 12px rgba(0,0,0,.25)}</style><script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
  .top-actions button[onclick="abrirConsulta()"] {
    display: none !important;
  }
</style>
</head>
<body>
<!-- Busy / Processando -->
<div aria-busy="true" aria-live="assertive" class="busy" id="busy" role="alert">
<div class="panel">
<div class="spinner"></div>
<div id="busyTxt">Processando, por favor, aguarde...</div>
</div>
</div>
<div class="wrap">
<div class="topbox">
<div class="stepper" id="stepper">
<div class="dot" id="dot1">1</div><div class="line" id="line12"></div>
<div class="dot" id="dot2">2</div><div class="line" id="line23"></div>
<div class="dot" id="dot3">3</div><div class="line" id="line34"></div>
<div class="dot" id="dot4">4</div><div class="line" id="line45"></div>
<div class="dot" id="dot5">5</div>
<div class="top-actions">
<button class="btn" id="themeBtn" onclick="toggleTheme()">🌙 Tema</button>
<button class="btn" id="btnFecharTopo" onclick="closeWizard()">Fechar</button>
<button class="btn" id="btnLimparTopo" onclick="clearLocal()" title="Limpa apenas dados locais (browser)">Limpar dados locais</button>
</div>
</div>
</div>
<!-- TELA 1 -->
<div class="card" id="screen1">
<div class="header">
<h2 class="title">Gerador de documentos</h2>
<p class="user" id="userInfo1">Usuário</p>
</div>
<div class="body">
<p class="intro">
      Informar o código do projeto no campo abaixo. Esse código será a chave para busca de documentos e utilizado para outras funcionalidades importantes na empresa
    </p>
<div class="block">
<div class="cap">CÓDIGO <span class="req">*</span></div>
<div class="content">
<input class="input" id="codigo" oninput="validate1()" placeholder="Digite o código do projeto"/>
<div style="text-align:right; margin-top:6px;">
  <button id="searchJsonBtn" type="button" style="background:#000; color:#fff; font-weight:700; border:none; padding:4px 10px; border-radius:999px; cursor:pointer; line-height:1.0; font-size:13px;">Pesquisar</button>
</div>
<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
<button class="btn" id="openConsultaBtn" style="display:none!important; visibility:hidden!important;" type="button">Pesquisar documentos cadastrados</button>
</div>
</div>
</div>
<!-- Consulta inline (ÚNICA) -->
<div class="block hidden" id="consultaInline">
<div class="cap">CONSULTA DE DOCUMENTOS</div>
<div class="content">
<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
<div style="flex:1;min-width:220px">
<div style="font-size:12px;color:#64748b;margin-bottom:6px">Código (opcional)</div>
<input class="input" id="consCodigoInline" placeholder="Ex.: AC00025"/>
<div class="hint">Digite o código e clique em Buscar.</div>
</div>
<button class="btn primary" id="btnBuscarInline" type="button">Buscar</button>
</div>
<table class="tbl">
<thead>
<tr><th style="width:120px">DATA</th><th style="width:110px">CÓDIGO</th><th>CONTRATANTE</th><th>CONTRATADA</th><th>SERVIÇO</th><th style="width:90px">PDF</th></tr>
</thead>
<tbody id="consBodyInline">
<tr><td class="row-muted" colspan="3">Sem código, sem resultados.</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="bar disabled" id="bar1">Continuar</div>
<!-- TELA 2 -->
<div class="card hidden" id="screen2">
<div class="header"><h2 class="title">Gerador de documentos</h2><p class="user" id="userInfo2">Usuário</p><p class="code">Código Projeto: <b id="codigoVal">AC00025</b></p></div>
<div class="body">
<div class="block"><div class="cap">SERVIÇO <span class="req">*</span></div><div class="content"><textarea class="textarea" id="servico" oninput="validate2()" placeholder="Digite o serviço do projeto"></textarea></div></div>
<div class="block"><div class="cap">ENDEREÇO DA OBRA <span class="req">*</span></div><div class="content"><input class="input" id="endereco" oninput="validate2()" placeholder="Digite o endereço da obra"/></div></div>
</div>
</div>
<div class="bar hidden disabled" id="bar2">Continuar</div>
<div class="back hidden" id="back2" onclick="goTo(1)"><span class="chev">◀</span> Voltar</div>
<!-- TELA 3 -->
<div class="card hidden" id="screen3">
<div class="header"><h2 class="title">Gerador de documentos</h2><p class="user" id="userInfo3">Usuário</p><p class="code">Código Projeto: <b id="codigoVal3">AC00025</b></p></div>
<div class="body">
<div class="block"><div class="cap">DADOS DO CONTRATANTE</div></div>
<div class="grid-2">
<div class="block"><div class="cap">NOME <span class="req">*</span></div><div class="content"><input class="input" id="nomeContratante" oninput="validate3()" placeholder="Digite o nome do contratante"/></div></div>
<div class="block"><div class="cap">CPF/CNPJ <span class="req">*</span></div><div class="content">
<input class="input" id="docContratante" onblur="docBlur(this); validate3()" onfocus="docFocus(this)" oninput="docInput(this); validate3()" placeholder="Digite o CPF ou CNPJ do contratante"/>
<div class="error hidden" id="docContratanteErr">Documento inválido</div>
</div></div>
</div>
<div class="block"><div class="cap">CONTATO <span class="req">*</span></div><div class="content"><input class="input" id="contatoContratante" oninput="validate3()" placeholder="Digite o nome do responsável pela obra"/></div></div>
<div class="grid-2">
<div class="block"><div class="cap">CEP <span class="req">*</span></div><div class="content">
<input class="input" id="cepContratante" onblur="cepOnBlur(this,'Contratante')" onchange="cepOnBlur(this,'Contratante')" onfocusout="cepOnBlur(this,'Contratante')" oninput="cepOnInput(this)" placeholder="00000-000"/>
<div class="error hidden" id="cepContratanteErr">CEP inválido</div>
<div class="hint hidden" id="cepContratanteHint">Endereço preenchido pelo CEP.</div>
</div></div>
<div class="block"><div class="cap">NÚMERO <span class="req">*</span></div><div class="content"><input class="input" id="numeroContratante" oninput="validate3()" placeholder="Número"/></div></div>
</div>
<div class="grid-2">
<div class="block"><div class="cap">LOGRADOURO <span class="req">*</span></div><div class="content"><input class="input" id="logradouroContratante" oninput="validate3()" placeholder="Rua / Avenida"/></div></div>
<div class="block"><div class="cap">COMPLEMENTO</div><div class="content"><input class="input" id="complementoContratante" oninput="validate3()" placeholder="Opcional"/></div></div>
</div>
<div class="grid-2">
<div class="block"><div class="cap">BAIRRO <span class="req">*</span></div><div class="content"><input class="input" id="bairroContratante" oninput="validate3()" placeholder="Bairro"/></div></div>
<div class="block"><div class="cap">CIDADE <span class="req">*</span></div><div class="content"><input class="input" id="cidadeContratante" oninput="validate3()" placeholder="Cidade"/></div></div>
</div>
<div class="block"><div class="cap">UF <span class="req">*</span></div><div class="content">
<select class="input" id="ufContratante" onchange="validate3()">
<option value="">UF</option>
<option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option><option>CE</option><option>DF</option>
<option>ES</option><option>GO</option><option>MA</option><option>MT</option><option>MS</option><option>MG</option><option>PA</option>
<option>PB</option><option>PR</option><option>PE</option><option>PI</option><option>RJ</option><option>RN</option><option>RS</option>
<option>RO</option><option>RR</option><option>SC</option><option>SP</option><option>SE</option><option>TO</option>
</select>
</div></div>
<div class="block"><div class="cap">TELEFONE DO CONTATO <span class="req">*</span></div><div class="content"><input class="input" id="telefoneContratante" oninput="maskPhoneSimple(this); validate3()" placeholder="(00)00000-0000"/><div class="error hidden" id="telContratanteErr">Telefone inválido — formato (99)99999-9999</div></div></div>
<div class="block"><div class="cap">E-MAIL <span class="req">*</span></div><div class="content"><input class="input" id="emailContratante" oninput="validate3()" placeholder="Digite o e-mail do contato"/><div class="error hidden" id="emailContratanteErr">E-mail inválido</div></div></div>
</div>
</div>
<div class="bar hidden disabled" id="bar3">Continuar</div>
<div class="back hidden" id="back3" onclick="goTo(2)"><span class="chev">◀</span> Voltar</div>
<!-- TELA 4 -->
<div class="card hidden" id="screen4">
<div class="header"><h2 class="title">Gerador de documentos</h2><p class="user" id="userInfo4">Usuário</p><p class="code">Código Projeto: <b id="codigoVal4">AC00025</b></p></div>
<div class="body">
<div class="block"><div class="cap">DADOS DA CONTRATADA</div></div>
<div class="grid-2">
<div class="block"><div class="cap">NOME <span class="req">*</span></div><div class="content"><input class="input" id="nomeContratada" oninput="validate4()" placeholder="Digite o nome da contratada"/></div></div>
<div class="block"><div class="cap">CPF/CNPJ <span class="req">*</span></div><div class="content">
<input class="input" id="docContratada" onblur="docBlur(this); validate4()" onfocus="docFocus(this)" oninput="docInput(this); validate4()" placeholder="Digite o CPF ou CNPJ da contratada"/>
<div class="error hidden" id="docContratadaErr">Documento inválido</div>
</div></div>
</div>
<div class="block"><div class="cap">CONTATO <span class="req">*</span></div><div class="content"><input class="input" id="contatoContratada" oninput="validate4()" placeholder="Digite o nome do responsável pela obra"/></div></div>
<div class="grid-2">
<div class="block"><div class="cap">CEP <span class="req">*</span></div><div class="content">
<input class="input" id="cepContratada" onblur="cepOnBlur(this,'Contratada')" onchange="cepOnBlur(this,'Contratada')" onfocusout="cepOnBlur(this,'Contratada')" oninput="cepOnInput(this)" placeholder="00000-000"/>
<div class="error hidden" id="cepContratadaErr">CEP inválido</div>
<div class="hint hidden" id="cepContratadaHint">Endereço preenchido pelo CEP.</div>
</div></div>
<div class="block"><div class="cap">NÚMERO <span class="req">*</span></div><div class="content"><input class="input" id="numeroContratada" oninput="validate4()" placeholder="Número"/></div></div>
</div>
<div class="grid-2">
<div class="block"><div class="cap">LOGRADOURO <span class="req">*</span></div><div class="content"><input class="input" id="logradouroContratada" oninput="validate4()" placeholder="Rua / Avenida"/></div></div>
<div class="block"><div class="cap">COMPLEMENTO</div><div class="content"><input class="input" id="complementoContratada" oninput="validate4()" placeholder="Opcional"/></div></div>
</div>
<div class="grid-2">
<div class="block"><div class="cap">BAIRRO <span class="req">*</span></div><div class="content"><input class="input" id="bairroContratada" oninput="validate4()" placeholder="Bairro"/></div></div>
<div class="block"><div class="cap">CIDADE <span class="req">*</span></div><div class="content"><input class="input" id="cidadeContratada" oninput="validate4()" placeholder="Cidade"/></div></div>
</div>
<div class="block"><div class="cap">UF <span class="req">*</span></div><div class="content">
<select class="input" id="ufContratada" onchange="validate4()">
<option value="">UF</option>
<option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option><option>CE</option><option>DF</option>
<option>ES</option><option>GO</option><option>MA</option><option>MT</option><option>MS</option><option>MG</option><option>PA</option>
<option>PB</option><option>PR</option><option>PE</option><option>PI</option><option>RJ</option><option>RN</option><option>RS</option>
<option>RO</option><option>RR</option><option>SC</option><option>SP</option><option>SE</option><option>TO</option>
</select>
</div></div>
<div class="block"><div class="cap">TELEFONE DO CONTATO <span class="req">*</span></div><div class="content"><input class="input" id="telefoneContratada" oninput="maskPhoneSimple(this); validate4()" placeholder="(00)00000-0000"/><div class="error hidden" id="telContratadaErr">Telefone inválido — formato (99)99999-9999</div></div></div>
<div class="block"><div class="cap">E-MAIL <span class="req">*</span></div><div class="content"><input class="input" id="emailContratada" oninput="validate4()" placeholder="Digite o e-mail do contato"/><div class="error hidden" id="emailContratadaErr">E-mail inválido</div></div></div>
</div>
</div>
<div class="bar hidden disabled" id="bar4">Continuar</div>
<div class="back hidden" id="back4" onclick="goTo(3)"><span class="chev">◀</span> Voltar</div>
<!-- TELA 5 -->
<div class="card hidden" id="screen5">
<div class="header"><h2 class="title">Gerador de documentos</h2><p class="user" id="userInfo5">Usuário</p><p class="code">Código Projeto: <b id="codigoVal5">AC00025</b></p></div>
<div class="body">
<div class="grid-2">
<div class="block"><div class="cap">CLÁUSULAS <span class="req">*</span></div><div class="content"><textarea class="textarea" id="clausulas" oninput="validate5()" placeholder="Digite as cláusulas do documento"></textarea></div></div>
<div class="block"><div class="cap">CONDIÇÕES DE PAGAMENTO <span class="req">*</span></div><div class="content"><textarea class="textarea" id="condicoes" oninput="validate5()" placeholder="Digite as condições de pagamento"></textarea></div></div>
</div>
<div class="grid-2">
<div class="block"><div class="cap">VALOR <span class="req">*</span></div><div class="content"><input class="input" id="valor" oninput="maskCurrency(this); setExtenso_Valor(); validate5()" placeholder="R$ 0,00"/><div class="hint">Formato: R$ 0.000,00</div></div></div>
<div class="block"><div class="cap">VALOR POR EXTENSO <span class="req">*</span></div><div class="content"><input class="input" id="Extenso_Valor" placeholder="Gerado automaticamente a partir do valor" readonly=""/></div></div>
</div>
<div class="grid-2">
<div class="block"><div class="cap">PRAZO (em dias) <span class="req">*</span></div><div class="content"><input class="input" id="prazo" inputmode="numeric" min="1" oninput="validate5()" placeholder="Digite o prazo de pagamento (dias)" step="1" type="number"/></div></div>
<div class="block"><div class="cap">DATA POR EXTENSO <span class="req">*</span></div><div class="content"><input class="input" id="dataExtenso" onclick="openDatePicker()" placeholder="Escolha uma data" readonly=""/><input class="hidden" id="dataPicker" onchange="fillDateExtenso()" type="date"/></div></div>
</div>
<div class="block"><div class="cap">LOGO DA EMPRESA</div><div class="content"><input accept="image/*" class="file" id="logo" onchange="showLogoName(this)" type="file"/><div class="hint" id="logoInfo" style="margin-top:6px">Anexar logo do contratante</div></div></div>
</div>
</div>
<div class="bar hidden disabled" id="bar5">Finalizar e salvar</div>
<div class="back hidden" id="back5" onclick="goTo(4)"><span class="chev">◀</span> Voltar</div>
</div>
<!-- Toast -->
<div class="toast" id="toast">Documento cadastrado com sucesso!</div>
<!-- Modal sucesso -->
<div class="modal" id="successModal" style="display:none!important; visibility:hidden!important; opacity:0!important;">
<div class="box">
<div class="hd">Documento cadastrado com sucesso!</div>
<div class="bd">Seu documento foi gerado. Você pode visualizá-lo agora em PDF para compartilhar.</div>
<div class="ft">
<button class="btn" onclick="closeSuccess()">Fechar</button>
<button class="btn primary" onclick="visualizarPdf()">Visualizar documento</button>
</div>
</div>
</div>
<!-- Viewer PDF -->
<div class="viewer" id="viewer">
<div class="panel">
<div class="top">
<button class="btn" onclick="downloadLastPdf()">Baixar PDF</button>
<button class="btn primary" onclick="shareLastPdf()">Compartilhar</button>
<button class="btn" onclick="closeViewer()">Fechar</button>
</div>
<iframe id="pdfFrame"></iframe>
</div>
</div>
<!-- Modal Consulta -->
<div class="modal" id="consultaModal" style="display:none">
<div class="box">
<div class="hd">Consulta de Documentos — ERP Ímpar</div>
<div class="bd">
<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
<div style="flex:1;min-width:220px">
<div style="font-size:12px;color:#64748b;margin-bottom:6px">Código (opcional)</div>
<input class="input" id="consCodigo" placeholder="Ex.: AC00025"/>
<div class="hint">Digite o código do projeto.
<p></p></div>
</div>
<button class="btn primary" id="btnBuscar">Buscar</button>
</div>
<table class="tbl" id="consTable">
<thead>
<tr><th style="width:120px">DATA</th><th style="width:110px">CÓDIGO</th><th>CONTRATANTE</th><th>CONTRATADA</th><th>SERVIÇO</th><th style="width:90px">PDF</th></tr>
</thead>
<tbody id="consBody">
<tr><td class="row-muted" colspan="3">Sem código, sem resultados.</td></tr>
</tbody>
</table>
</div>
<div class="ft">
<button class="btn" id="btnCloseConsulta">Fechar</button>
</div>
</div>
</div>
<!-- Modal Ação (Atualizar ou Gerar PDF) -->
<div class="modal" id="actionModal" style="display:none">
<div class="box" style="max-width:520px">
<div class="hd">O que você deseja fazer?</div>
<div class="bd">
<div style="color:#334155;margin-bottom:8px">Documento: <b id="actDocCode">—</b></div>
<div class="hint">Escolha abaixo para continuar:</div>
</div>
<div class="ft" style="display:flex;gap:8px;justify-content:flex-end">
<button class="btn" id="btnActionCancel" type="button">Cancelar</button>
<button class="btn" id="btnActionPdf" type="button">Gerar PDF</button>
<button class="btn primary" id="btnActionUpdate" type="button">Atualizar informações</button>
</div>
</div>
</div>
<!-- Modal Duplicidade -->
<div class="modal" id="dupeModal" style="display:none">
<div class="box" style="max-width:560px">
<div class="hd">Documento já cadastrado</div>
<div class="bd">
      Encontramos um documento com este código. O que você deseja fazer?
      <div class="hint" id="dupeInfo" style="margin-top:8px"></div>
</div>
<div class="ft">
<button class="btn" id="btnDupCancel">Cancelar</button>
<button class="btn" id="btnDupUpdate">Atualizar informações</button>
<button class="btn primary" id="btnDupPrint">Imprimir PDF</button>
</div>
</div>
</div>
<script>
// trava anti-duplicação (sempre em window, SEM let/const)
window.__savingNow = window.__savingNow === true ? true : false;
// guarda a “assinatura” do último save (para idempotência local)
window.__lastSave = window.__lastSave || { sig: null, at: 0 };

function noop(){} function onlyDigits(s){return (s||'').replace(/\D+/g,'');}

/* Tema */
const THEME_KEY='impar_theme';
function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); const b=document.getElementById('themeBtn'); if(b) b.textContent=(t==='dark'?'☀️ Tema':'🌙 Tema'); }
(function initTheme(){ const saved=localStorage.getItem(THEME_KEY); if(saved){applyTheme(saved);} else { const prefersDark=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches; applyTheme(prefersDark?'dark':'light'); } })();
function toggleTheme(){ const cur=document.documentElement.getAttribute('data-theme')||'light'; const next=(cur==='dark')?'light':'dark'; localStorage.setItem(THEME_KEY,next); applyTheme(next); }

/* Usuário */
function loadUser(){
  let u=null; try{ u=JSON.parse(localStorage.getItem('impar_user')||'null'); }catch(e){}
  const label = u ? (u.Nome+'\n'+u.Email) : 'Rafael Ramos\nrafael.@imparsistemas.com';
  document.querySelectorAll('.user').forEach(p=>{ p.innerHTML = label.replace(/\r?\n/g,'<br>'); });
}

loadUser();

/* CEP */
function cepOnInput(el){ el.value = onlyDigits(el.value).slice(0,8); const e=document.getElementById(el.id+'Err'); const h=document.getElementById(el.id+'Hint'); if(e) e.classList.add('hidden'); if(h) h.classList.add('hidden'); }
async function cepOnBlur(el, prefix){
  const d = onlyDigits(el.value).slice(0,8);
  el.value = d.length<=5 ? d : (d.substring(0,5)+'-'+d.substring(5));
  const ok = d.length===8; const e=document.getElementById(el.id+'Err'); const h=document.getElementById(el.id+'Hint'); if(e) e.classList.toggle('hidden',ok); if(h) h.classList.add('hidden'); if(!ok) return;
  try{ const r=await fetch('https://viacep.com.br/ws/'+d+'/json/'); const data=await r.json(); if(!data.erro){ const map={logradouro:'logradouro',bairro:'bairro',localidade:'cidade',uf:'uf'}; for(const k in map){ const t=document.getElementById(map[k]+prefix); if(t) t.value=data[k]||''; } if(h) h.classList.remove('hidden'); } }catch(err){}
  if(prefix==='Contratante') validate3(); else validate4();
}

/* CPF/CNPJ */
function formatCPF(d){d=onlyDigits(d).slice(0,11);return d.replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2');}
function formatCNPJ(d){d=onlyDigits(d).slice(0,14);return d.replace(/(\d{2})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1/$2').replace(/(\d{4})(\d{1,2})$/,'$1-$2');}
function isValidCPF(cpf){cpf=onlyDigits(cpf);if(cpf.length!==11||/(\d)\1{10}/.test(cpf))return false;let s=0;for(let i=0;i<9;i++)s+=+cpf[i]*(10-i);let d1=11-(s%11);d1=d1>9?0:d1;if(+cpf[9]!==d1)return false;s=0;for(let i=0;i<10;i++)s+=+cpf[i]*(11-i);let d2=11-(s%11);d2=d2>9?0:d2;return +cpf[10]===d2;}
function isValidCNPJ(cnpj){cnpj=onlyDigits(cnpj);if(cnpj.length!==14||/(\d)\1{13}/.test(cnpj))return false;const calc=(b)=>{let s=0,p=b.length-7;for(let i=b.length;i>=1;i--){s+=+b[b.length-i]*p--;if(p<2)p=9}return s%11<2?0:11-(s%11)};const b=cnpj.slice(0,12);const d1=calc(b);if(+cnpj[12]!==d1)return false;const d2=calc(b+d1);return +cnpj[13]===d2;}
function docFocus(inp){inp.value=onlyDigits(inp.value);document.getElementById(inp.id+'Err').classList.add('hidden');}
function docInput(inp){inp.value=onlyDigits(inp.value).slice(0,14);document.getElementById(inp.id+'Err').classList.add('hidden');}
function docBlur(inp){const d=onlyDigits(inp.value);let ok=false;if(d.length===11){ok=isValidCPF(d);inp.value=formatCPF(d);}else if(d.length===14){ok=isValidCNPJ(d);inp.value=formatCNPJ(d);}document.getElementById(inp.id+'Err').classList.toggle('hidden',ok);}

/* Telefone */
function formatPhoneSimple(d){d=onlyDigits(d).slice(0,11);if(d.length<=6)return d.replace(/(\d{2})(\d{0,5})/,'($1)$2');return d.replace(/(\d{2})(\d{5})(\d{0,4})/,'($1)$2-$3');}
function maskPhoneSimple(inp){const d=onlyDigits(inp.value).slice(0,11);inp.value=formatPhoneSimple(d);const id=inp.id.replace('telefone','tel')+'Err';document.getElementById(id).classList.toggle('hidden',d.length===11||d.length===0);}

/* Valor/extenso */
function formatCurrencyBR(cents){const r=Math.floor(cents/100),c=(cents%100).toString().padStart(2,'0');const rr=r.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');return 'R$ '+rr+','+c;}
function maskCurrency(inp){let d=onlyDigits(inp.value);if(!d){inp.value='';return;}inp.value=formatCurrencyBR(parseInt(d,10));}
const UNIDADES=['zero','um','dois','três','quatro','cinco','seis','sete','oito','nove'];
const DEZ_A_DEZENOVE=['dez','onze','doze','treze','catorze','quinze','dezesseis','dezessete','dezoito','dezenove'];
const DEZENAS=['','dez','vinte','trinta','quarenta','cinquenta','sessenta','setenta','oitenta','noventa'];
const CENTENAS=['','cento','duzentos','trezentos','quatrocentos','quinhentos','seiscentos','setecentos','oitocentos','novecentos'];
function trioPorExtenso(n){n%=1000;if(n===0)return'';if(n===100)return'cem';const c=Math.floor(n/100),d=Math.floor((n%100)/10),u=n%10;let p=[];if(c)p.push(CENTENAS[c]);if(d===1)p.push(DEZ_A_DEZENOVE[u]);else{if(d)p.push(DEZENAS[d]);if(u)p.push(UNIDADES[u]);}return p.join(' e ');}
function inteiroBR(n){if(n===0)return'zero';const g=[{v:n%1000,n:''},{v:Math.floor(n/1000)%1000,n:'mil'},{v:Math.floor(n/1e6)%1000,n:'milhão',p:'milhões'},{v:Math.floor(n/1e9)%1000,n:'bilhão',p:'bilhões'}];let partes=[];for(let i=g.length-1;i>=0;i--){const x=g[i];if(!x.v)continue;const ext=trioPorExtenso(x.v);if(i===1){partes.push(x.v===1?'mil':ext+' mil');continue;}if(i>=2){partes.push(ext+' '+(x.v===1?x.n:x.p));continue;}if(i===0)partes.push(ext);}return partes.join(' ');}
function valorExt(cents){const r=Math.floor(cents/100),c=cents%100;let t='';if(r>0)t+=inteiroBR(r)+' '+(r===1?'real':'reais');if(c>0){const s=inteiroBR(c)+' '+(c===1?'centavo':'centavos');t=t? t+' e '+s : s;}return t||'zero real';}
function setExtenso_Valor(){const d=onlyDigits(document.getElementById('valor').value);document.getElementById('Extenso_Valor').value=d?valorExt(parseInt(d,10)):'';}

/* Data */
function openDatePicker(){ const p=document.getElementById('dataPicker'); if(p.showPicker) p.showPicker(); else p.click(); }
function fillDateExtenso(){ const p=document.getElementById('dataPicker'); if(!p.value) return; const d=new Date(p.value+'T12:00:00'); document.getElementById('dataExtenso').value=d.toLocaleDateString('pt-BR',{day:'numeric',month:'long',year:'numeric'}); validate5(); }

/* Email */
function isValidEmail(e){ return /^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i.test(e); }

/* Navegação base */
function updateStepper(step){[1,2,3,4,5].forEach(n=>{const d=document.getElementById('dot'+n);d.classList.remove('done','active');if(n<step)d.classList.add('done');if(n===step)d.classList.add('active');});[['line12',2],['line23',3],['line34',4],['line45',5]].forEach(([id,to])=>{const el=document.getElementById(id);if(step>=to)el.classList.add('done');else el.classList.remove('done');});}
function showOnly(id){
  ['screen1','screen2','screen3','screen4','screen5'].forEach(s=>{
    const el = document.getElementById(s);
    if (el) el.classList.add('hidden');
  });
  const cur = document.getElementById(id);
  if (cur) cur.classList.remove('hidden');

  ['bar1','bar2','bar3','bar4','bar5','back2','back3','back4','back5'].forEach(i=>{
    const el = document.getElementById(i);
    if (el) el.classList.add('hidden');
  });
}

function goTo(step){
  updateStepper(step);
  showOnly('screen'+step);

  const codigo=(document.getElementById('codigo').value||'').trim()||'AC00025';
  ['codigoVal','codigoVal3','codigoVal4','codigoVal5'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.textContent=codigo;
  });

  const bar=document.getElementById('bar'+step); if(bar) bar.classList.remove('hidden');
  const back=document.getElementById('back'+step); if(back) back.classList.remove('hidden');

  const ci=document.getElementById('consultaInline'); if(ci&&step!==1) ci.classList.add('hidden');

  const fn=window['validate'+step]; if(typeof fn==='function') fn();

  // foco no primeiro campo "editável" da etapa
  setTimeout(()=>{
    const sc = document.getElementById('screen'+step);
    if(!sc) return;
    const first = sc.querySelector('input:not([type="hidden"]):not([readonly]), textarea, select');
    if(first) first.focus({ preventScroll:true });
  }, 50);
}

/* Validadores */
function addrOk(prefix){return ['logradouro','numero','bairro','cidade','uf'].every(k => document.getElementById(k+prefix).value.trim());}
function validate1(){const v=document.getElementById('codigo').value.trim(),b=document.getElementById('bar1');if(v){b.classList.remove('disabled');b.classList.add('enabled');}else{b.classList.add('disabled');b.classList.remove('enabled');}updateStepper(1);}
function validate2(){const s=document.getElementById('servico').value.trim(),e=document.getElementById('endereco').value.trim(),b=document.getElementById('bar2');if(s&&e){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=()=>goTo(3);}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}}
function validate3(){const d=document.getElementById('docContratante').value,t=document.getElementById('telefoneContratante').value,m=document.getElementById('emailContratante').value.trim(),cep=document.getElementById('cepContratante').value.trim();const docOk=(onlyDigits(d).length===11&&isValidCPF(d))||(onlyDigits(d).length===14&&isValidCNPJ(d));const telOk=onlyDigits(t).length===11;const emailOk=isValidEmail(m);const cepOk=onlyDigits(cep).length===8;document.getElementById('emailContratanteErr').classList.toggle('hidden',emailOk||m.length===0);document.getElementById('telContratanteErr').classList.toggle('hidden',telOk||onlyDigits(t).length===0);document.getElementById('cepContratanteErr').classList.toggle('hidden',cepOk||onlyDigits(cep).length===0);const ok=['nomeContratante','contatoContratante'].every(id=>document.getElementById(id).value.trim())&&docOk&&telOk&&emailOk&&cepOk&&addrOk('Contratante');const b=document.getElementById('bar3');if(ok){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=()=>goTo(4);}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}}
function validate4(){const d=document.getElementById('docContratada').value,t=document.getElementById('telefoneContratada').value,m=document.getElementById('emailContratada').value.trim(),cep=document.getElementById('cepContratada').value.trim();const docOk=(onlyDigits(d).length===11&&isValidCPF(d))||(onlyDigits(d).length===14&&isValidCNPJ(d));const telOk=onlyDigits(t).length===11;const emailOk=isValidEmail(m);const cepOk=onlyDigits(cep).length===8;document.getElementById('emailContratadaErr').classList.toggle('hidden',emailOk||m.length===0);document.getElementById('telContratadaErr').classList.toggle('hidden',telOk||onlyDigits(t).length===0);document.getElementById('cepContratadaErr').classList.toggle('hidden',cepOk||onlyDigits(cep).length===0);const ok=['nomeContratada','contatoContratada'].every(id=>document.getElementById(id).value.trim())&&docOk&&telOk&&emailOk&&cepOk&&addrOk('Contratada');const b=document.getElementById('bar4');if(ok){b.classList.remove('disabled');b.classList.add('enabled');b.onclick=()=>goTo(5);}else{b.classList.add('disabled');b.classList.remove('enabled');b.onclick=noop;}}
function isValidCurrencyInput(){return /R\$\s\d{1,3}(\.\d{3})*,\d{2}$/.test(document.getElementById('valor').value);}
function validate5(){
  setExtenso_Valor();
  const ok = isValidCurrencyInput()
    && parseInt(document.getElementById('prazo').value,10) > 0
    && document.getElementById('dataExtenso').value.trim().length > 0
    && ['clausulas','condicoes','Extenso_Valor'].every(id=>document.getElementById(id).value.trim());

  const b = document.getElementById('bar5');
  if (!b) return; // sem botão, não há o que habilitar

  if (ok){
    b.classList.remove('disabled');
    b.classList.add('enabled');
    b.onclick = withSaveLock(finalizeStep5);
  }else{
    b.classList.add('disabled');
    b.classList.remove('enabled');
    b.onclick = noop;
  }
}
/* LOGO utils */
let __logoCached = null;
function showLogoName(inp){
  const f = inp.files && inp.files[0];
  const el = document.getElementById('logoInfo');
  el.textContent = f ? ('Anexo: ' + f.name) : 'Anexar logo do contratante';
  __logoCached = null;
}
// Busy helpers
function showBusy(msg){
  const el = document.getElementById('busy');
  if (!el) return;
  const t = document.getElementById('busyTxt');
  if (t) t.textContent = msg || 'Processando, por favor, aguarde...';
  el.style.display = 'flex';
  document.body.style.cursor = 'progress';
}
function hideBusy(){
  const el = document.getElementById('busy');
  if (!el) return;
  el.style.display = 'none';
  document.body.style.cursor = '';
}
function detectFormatFromDataUrl(dt){
  if(!dt || typeof dt!=='string') return 'PNG';
  if(dt.startsWith('data:image/jpeg')) return 'JPEG';
  if(dt.startsWith('data:image/jpg'))  return 'JPEG';
  if(dt.startsWith('data:image/webp')) return 'WEBP';
  return 'PNG';
}
function loadLogoForPdf(){
  return new Promise((resolve)=>{
    if(__logoCached) return resolve(__logoCached);
    const inp = document.getElementById('logo');
    const file = inp && inp.files && inp.files[0];
    if(!file) return resolve(null);
    const fr = new FileReader();
    fr.onload = () => {
      const url = fr.result;
      const img = new Image();
      img.onload = () => {
        const maxW = 110;
        const ratio = img.naturalWidth ? (maxW / img.naturalWidth) : 1;
        const w = Math.min(maxW, img.naturalWidth) * (img.naturalWidth ? ratio : 1);
        const h = img.naturalHeight ? (img.naturalHeight * (w / (img.naturalWidth||w))) : 40;
        __logoCached = { url, w, h, fmt: detectFormatFromDataUrl(url) };
        resolve(__logoCached);
      };
      img.src = url;
    };
    fr.readAsDataURL(file);
  });
}

/* PDF */
function currentCode(){ return (document.getElementById('codigo').value||'').trim() || 'DOC'; }
//function todayYMD(){ const d=new Date(); const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const dd=('0'+d.getDate()).slice(-2); return `${y}${m}${dd}`; }
let __pdfBlob=null, __pdfUrl=null, __pdfName='documento.pdf';

async function createPdfBlob(){
  const logo = await loadLogoForPdf();
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF({unit:'pt',format:'a4'}), pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight(), M=40; let y=M;
  function drawLogo(){ if(!logo) return; try{ pdf.addImage(logo.url, logo.fmt, pageW - M - logo.w, M - 6, logo.w, logo.h); }catch(e){} }
  function h1(t){pdf.setFont('Helvetica','bold');pdf.setFontSize(16);drawLogo();pdf.text(t,pageW/2,y,{align:'center'});y+=22;pdf.setDrawColor(200);pdf.line(M,y,pageW-M,y);y+=14;}
  function lv(l,v){pdf.setFont('Helvetica','bold');pdf.setFontSize(11);const lines=pdf.splitTextToSize(l+' '+v,pageW-2*M);pdf.text(lines,M,y);y+=lines.length*14;}
  function block(l,v){pdf.setFont('Helvetica','bold');pdf.setFontSize(12);pdf.text(l,M,y);y+=14;pdf.setFont('Helvetica','normal');pdf.setFontSize(11);const lines=pdf.splitTextToSize(v,pageW-2*M);for(const line of lines){if(y>pageH-M){pdf.addPage();y=M;drawLogo();}pdf.text(line,M,y);y+=14;}y+=6;}
  function ensure(h){if(y+h>pageH-M){pdf.addPage();y=M;}}
  const get=(id)=>(document.getElementById(id).value||'').trim();
  const end=(p)=>{ const log=document.getElementById('logradouro'+p).value||'',num=document.getElementById('numero'+p).value||'',comp=document.getElementById('complemento'+p).value||'',bai=document.getElementById('bairro'+p).value||'',cid=document.getElementById('cidade'+p).value||'',uf=document.getElementById('uf'+p).value||'',cep=(document.getElementById('cep'+p).value||''); let base=log+', '+num+(comp?(' - '+comp):''); base+=' — '+bai+' — '+cid+'/'+uf+' — CEP '+cep; return base; };
  const u = JSON.parse(localStorage.getItem('impar_user')||'null');

  h1('Resumo do Documento');
  lv('Operador:', u ? (u.Nome+' ('+u.Email+')') : '—'); y+=6;
  lv('Código do Projeto:', get('codigo')); y+=8;
  block('Serviço:', get('servico'));
  lv('Endereço da obra:', get('endereco')); y+=8;

  pdf.setFont('Helvetica','bold');pdf.setFontSize(13);ensure(24);pdf.text('CONTRATANTE',M,y);y+=16;pdf.setDrawColor(220);pdf.line(M,y,pageW-M,y);y+=10;
  lv('Nome:', get('nomeContratante'));
  lv('CPF/CNPJ:', get('docContratante'));
  lv('Endereço:', end('Contratante'));
  lv('Contato:', get('contatoContratante'));
  lv('Telefone:', get('telefoneContratante'));
  lv('E-mail:', get('emailContratante')); y+=8;

  pdf.setFont('Helvetica','bold');pdf.setFontSize(13);ensure(24);pdf.text('CONTRATADA',M,y);y+=16;pdf.setDrawColor(220);pdf.line(M,y,pageW-M,y);y+=10;
  lv('Nome:', get('nomeContratada'));
  lv('CPF/CNPJ:', get('docContratada'));
  lv('Endereço:', end('Contratada'));
  lv('Contato:', get('contatoContratada'));
  lv('Telefone:', get('telefoneContratada'));
  lv('E-mail:', get('emailContratada')); y+=8;

  pdf.setFont('Helvetica','bold');pdf.setFontSize(13);ensure(24);pdf.text('CONDIÇÕES',M,y);y+=16;pdf.setDrawColor(220);pdf.line(M,y,pageW-M,y);y+=10;
  lv('Valor:', get('valor')+' ('+get('Extenso_Valor')+')');
  lv('Prazo:', get('prazo')+' dias');
  lv('Data:', get('dataExtenso'));
  block('Condições de pagamento:', get('condicoes'));
  block('Cláusulas:', get('clausulas'));

  return pdf.output('blob');
}

function openViewerWithBlob(blob){
  __pdfBlob = blob;
  if(__pdfUrl) URL.revokeObjectURL(__pdfUrl);
  __pdfUrl = URL.createObjectURL(blob);
  __pdfName = `${currentCode()}_${todayYMD()}.pdf`;
  document.getElementById('pdfFrame').src = __pdfUrl;
  document.getElementById('viewer').style.display='flex';
}
function closeViewer(){ document.getElementById('viewer').style.display='none'; }
function downloadLastPdf(){ if(!__pdfBlob) return; const a=document.createElement('a'); a.href=__pdfUrl; a.download=__pdfName; document.body.appendChild(a); a.click(); a.remove(); }
async function shareLastPdf(){
  if(!__pdfBlob){ showToast('Gere o PDF primeiro'); return; }
  const file = new File([__pdfBlob], __pdfName, {type:'application/pdf'});
  try{
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({files:[file], title:'Documento', text:'Envio do documento em PDF'});
    }else if(navigator.share){
      await navigator.share({title:'Documento', text:'Envio do documento em PDF', url: __pdfUrl});
    }else{
      const txt = encodeURIComponent('Documento gerado. Baixe aqui: '+location.href);
      window.open('https://wa.me/?text='+txt,'_blank');
    }
  }catch(e){}
}
// envolve a ação com lock + overlay
function withSaveLock(handler){
  return async function(...args){
    const bar = document.getElementById('bar5');

    // usa SEMPRE a mesma trava global
    if (window.__savingNow || bar?.dataset.lock === '1'){
      console.warn('[index] salvamento bloqueado (em andamento)');
      return;
    }

    try{
      window.__savingNow = true;
      if (bar){ bar.dataset.lock = '1'; bar.style.pointerEvents = 'none'; bar.classList.add('disabled'); }
      showBusy('Gerando e salvando o PDF...');
      return await handler.apply(this, args);
    } finally {
      hideBusy();
      if (bar){ delete bar.dataset.lock; bar.style.pointerEvents = ''; bar.classList.remove('disabled'); }
      window.__savingNow = false;
    }
  };
}

/* Toast + success modal */
function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 2000);
}

async function finalizeStep5(){
  // OBS: o overlay já é controlado por withSaveLock(finalizeStep5)
  // via validate5(), então aqui não chamamos showBusy/hideBusy.
  const blob = await createPdfBlob();
  const res  = await saveDocumentWithPdf(blob);

  if (res && res.ok) {
    try{ if (window.__lastSave && window.__lastSave.dados) { __afterPdfSavedGenerateExcel(window.__lastSave.dados); } }catch(e){ console.error(e); }
    showSuccessToast(`Código: ${codigo}`, contratante ? contratante : '');
    setTimeout(() => {
      document.getElementById('successModal').style.display = 'flex';
    }, 300);
  } else {
    showToast('Não foi possível salvar. Tente novamente.');
  }
}
function closeSuccess(){ document.getElementById('successModal').style.display='none'; }
async function visualizarPdf(){ closeSuccess(); const blob = await createPdfBlob(); openViewerWithBlob(blob); }

// ...código anterior...

// === SUBSTITUA sua função por esta ===
async function saveDocumentWithPdf(pdfBlob){
  try{
    // usa as configs do patch
    const patch      = (window.__ERP_SAVE_PATCH__ || {});
    const SAVE_URL   = patch.SAVE_URL || 'https://api.erpimpar.com.br/gerador/save.php';
    const SAVE_TOKEN = patch.SAVE_TOKEN || '';

    const get = (id) => (document.getElementById(id)?.value || '').trim();
    const joinAddr = (p) => {
      const log = document.getElementById('logradouro'+p).value || '';
      const num = document.getElementById('numero'+p).value || '';
      const comp= document.getElementById('complemento'+p).value || '';
      const bai = document.getElementById('bairro'+p).value || '';
      const cid = document.getElementById('cidade'+p).value || '';
      const uf  = document.getElementById('uf'+p).value || '';
      const cep = document.getElementById('cep'+p).value || '';
      return `${log}, ${num}${comp?(' - '+comp):''} — ${bai} — ${cid}/${uf} — CEP ${cep}`;
    };
    const u = JSON.parse(localStorage.getItem('impar_user') || 'null') || {};

    const dados = {
      codigo:        get('codigo'),
      servico:       get('servico'),
      enderecoObra:  get('endereco'),
      valor:         get('valor'),
      Extenso_Valor: get('Extenso_Valor'),
      prazo:         get('prazo'),
      dataExtenso:   get('dataExtenso'),
      clausulas:     get('clausulas'),
      condicoes:     get('condicoes'),
      clausulas_texto:     get('clausulas'),
      condicoes_pagamento: get('condicoes'),
      contratante: {
        nome:     get('nomeContratante'),
        cpfCnpj:  get('docContratante'),
        endereco: joinAddr('Contratante'),
        contato:  get('contatoContratante'),
        telefone: get('telefoneContratante'),
        email:    get('emailContratante')
      },
      contratada: {
        nome:     get('nomeContratada'),
        cpfCnpj:  get('docContratada'),
        endereco: joinAddr('Contratada'),
        contato:  get('contatoContratada'),
        telefone: get('telefoneContratada'),
        email:    get('emailContratada')
      },
      operador: { nome: u.Nome || '', email: u.Email || '' }
    };

   // nome do arquivo
   //const ymd  = (new Date()).toISOString().slice(0,10).replace(/-/g,'');
    const code = (dados.codigo || 'DOC').replace(/[^A-Za-z0-9_\-]/g,'_') || 'DOC';
    const pdfName = `${code}_${ymd}.pdf`;

    // ---- Guard anti duplicação em janela curta (4s) ----
    const now = Date.now();
    const sig = `${code}|${pdfName}`;
    if (window.__lastSave && window.__lastSave.sig === sig && (now - window.__lastSave.at) < 4000){
      console.warn('[index] tentativa duplicada detectada (4s) — ignorado');
      return { ok:false, reason:'local-dupe-guard' };
    }
    window.__lastSave = { sig, at: now, dados };
    // -----------------------------------------------------

    // chamada ÚNICA: usa o patch e PASSA "dados"
    if (typeof window.saveWithLogo === 'function') {
      console.log('[index] enviando p/ patch:', dados);
      return await window.saveWithLogo(pdfBlob, pdfName, dados);
    }

    console.warn('[index] Patch ausente — sem fallback para evitar duplicação.');
    return { ok:false, reason:'no-patch' };

  } catch (e) {
    console.warn('saveDocumentWithPdf error', e);
    showToast('Erro inesperado ao salvar.');
    return { ok:false, error:String(e) };
  }
}

/* ===== Consulta ===== */
const LOGIN_URL='/login_doc.html';
const apiPatch=(window.__ERP_SAVE_PATCH__||{});
function pdfHrefFromRow(row){
  return row.pdf_url || row.PDF_URL || '';
}
function openConsulta(){
  const el=document.getElementById('consultaModal');
  const inp=document.getElementById('consCodigo');
  const code=(document.getElementById('codigo').value||'').trim();
  inp.value=code;
  renderConsMsg('Sem código, sem resultados.');
  el.style.display='flex';
}
function closeConsulta(){ document.getElementById('consultaModal').style.display='none'; }
function renderConsMsg(msg){
  const tb=document.getElementById('consBody');
  tb.innerHTML=`<tr><td colspan="3" class="row-muted">${msg}</td></tr>`;
}

// -------- Consulta (inline + modal) SEM token na URL --------

/* === Helpers para PDF (fallback inteligente) === */
function getApiBaseFromPatch(){
  const listUrl = (window.__ERP_SAVE_PATCH__?.LIST_URL || '').trim();
  if (!listUrl) return '';
  return listUrl.replace(/\/list\.php.*$/,'').replace(/\/+$/,'');
}


async function openPdfSmart(row){
  const file = row.pdf || row.pdf_file || '';
  if (row.pdf_url || row.PDF_URL){
    window.open(row.pdf_url || row.PDF_URL, '_blank', 'noopener');
    return;
  }
  const apiBase = getApiBaseFromPatch();
  if (!apiBase || !file){
    alert('PDF não disponível para este registro.');
    return;
  }
  const base = apiBase.replace(/\/+$/,'');
  const candidates = [
    base + '/pdf/' + encodeURIComponent(file),
    base + '/pdf.php?f=' + encodeURIComponent(file)
  ];

  for (const url of candidates){
    try{
      const r = await fetch(url, { method:'HEAD', mode:'cors' });
      if (r.ok || r.status === 405){
        window.open(url, '_blank', 'noopener');
        return;
      }
    }catch(e){}
  }
  window.open(candidates[0], '_blank', 'noopener');
}




/* === Helpers para extrair nomes dinamicamente === */
function _normalize(v){
  if (v==null) return '';
  if (typeof v === 'string') return v.trim();
  if (typeof v === 'number') return String(v);
  if (typeof v === 'object'){
    // tenta campos comuns
    const cand = v.razao || v.razao_social || v.razaoSocial || v.nome || v.Nome || v.fantasia;
    if (typeof cand === 'string') return cand.trim();
  }
  return '';
}

function pickByKeys(obj, keysLike){
  // 1) tenta chaves exatas
  for (const k of keysLike){
    if (k in obj){
      const val = _normalize(obj[k]);
      if (val) return val;
    }
  }
  // 2) procura por substring (case-insensitive)
  const lc = Object.keys(obj).map(k => [k, k.toLowerCase()]);
  for (const [orig, low] of lc){
    if (keysLike.some(s => low.includes(s.toLowerCase()))){
      const val = _normalize(obj[orig]);
      if (val) return val;
    }
  }
  // 3) se for objeto dentro (ex.: obj.contratante = {...})
  for (const [orig, low] of lc){
    if (keysLike.some(s => low.includes(s.toLowerCase()))){
      const v = obj[orig];
      if (v && typeof v === 'object'){
        const cand = _normalize(v);
        if (cand) return cand;
      }
    }
  }
  return '';
}



function getContratanteFromRow(row){
  const val = pickByKeys(row, [
    // padrões antigos
    'contratante_nome','CONTRATANTE_NOME','contratante','CONTRATANTE','cliente','CLIENTE',
    'razao_contratante','razaoSocialContratante','razao_social_contratante','contratante_razao',
    // novos (do console): cta_*
    'cta_nome','cta_razao','ctaRazao','cta_razaoSocial','cta_razao_social','cta_nomeFantasia','cta_fantasia'
  ]);
  if (val) return val;
  console.debug('[consulta] CONTRATANTE não identificado. Chaves disponíveis:', Object.keys(row));
  return '-';
}
function getContratadaFromRow(row){
  let val = pickByKeys(row, [
    'contratada_nome','CONTRATADA_NOME','contratada','CONTRATADA','fornecedor','FORNECEDOR',
    'razao_contratada','razaoSocialContratada','razao_social_contratada','contratada_razao',
    // tentativas com prefixos usuais
    'ctd_nome','ctd_razao','ctdRazao','ctd_razaoSocial','ctd_razao_social',
    // alguns backends usam "empresa" para a contratada
    'empresa','empresa_nome','empresaRazao'
  ]);
  if (!val){
    // muitos documentos da Ímpar têm contratada fixa
    val = 'IMPAR CLIMATIZAÇÃO E SISTEMAS LTDA';
  }
  return val;
}


function pick(row, keys){
  for (const k of keys){
    if (row && Object.prototype.hasOwnProperty.call(row, k) && row[k] != null && String(row[k]).trim() !== ''){
      return row[k];
    }
  }
  return '';
}
function fmtDate(v){
  if (!v) return '';
  const d = new Date(String(v).replace(' ', 'T'));
  if (isNaN(d)) return String(v);
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  return `${dd}/${mm}/${yyyy}, ${hh}:${mi}:${ss}`;
}
// Prefer proxy like the external page does
function pdfHrefFromRow(row){
  const raw = pick(row, ['pdf_file','file','pdf','pdf_url','pdfUrl','url','URL']);
  if (!raw) return '#';
  const fname = String(raw)
    .replace(/^https?:\/\/[^/]+/i, '')
    .replace(/\?.*$/, '')
    .split('/').filter(Boolean).pop();
  if (!fname || !fname.toLowerCase().endsWith('.pdf')) return '#';
  const apiBase = (window.__ERP_SAVE_PATCH__?.LIST_URL || '').replace(/\/list\.php.*/, '');
  return apiBase ? `${apiBase}/pdf.php?f=${encodeURIComponent(fname)}` : '#';
}



// === Ações no clique do CÓDIGO ===
function openPdfFromRow(row){
  try{
    const href = pdfHrefFromRow ? pdfHrefFromRow(row) : (row.pdf_url || row.pdf || '#');
    if (href && href !== '#') window.open(href, '_blank', 'noopener');
    else alert('PDF não disponível para este registro.');
  }catch(e){ alert('Não foi possível abrir o PDF.'); }
}
function setIfExists(id, value){
  const el = document.getElementById(id);
  if (!el) return;
  el.value = (value ?? '').toString();
  try{ el.dispatchEvent(new Event('input', {bubbles:true})); }catch(_){}
}
function pick2(row, keys){
  for (const k of keys){
    if (row && Object.prototype.hasOwnProperty.call(row, k) && row[k] != null && String(row[k]).trim() !== ''){
      return row[k];
    }
  }
  return '';
}
function fillFromRowFallback(row){
  setIfExists('codigo',      pick2(row, ['codigo','Código','CODIGO']));
  setIfExists('servico',     pick2(row, ['servico','Serviço','descricao','objeto']));
  setIfExists('endereco_obra', pick2(row, ['enderecoObra','endereco_obra','obra_endereco','endereco']));
  setIfExists('contratante', pick2(row, ['ctt_nome','contratante_nome','contratante','cliente']));
  setIfExists('cnpj_contratante', pick2(row, ['ctt_cpfCnpj','contratante_cnpj','cpfCnpj','cpfCnpjContratante','contratante_doc']));
  setIfExists('contratada',  pick2(row, ['cta_nome','contratada_nome','contratada']) || 'IMPAR CLIMATIZAÇÃO E SISTEMAS LTDA');
  setIfExists('cnpj_contratada', pick2(row, ['cta_cpfCnpj','contratada_cnpj','contratada_doc']));
}
function proceedToStep2(){
  try{ if (typeof goTo === 'function') goTo(2); }catch(_){}
  const step = document.querySelector('[data-step="2"]');
  if (step){ step.scrollIntoView({behavior:'smooth',block:'start'}); step.classList.add('pulse'); setTimeout(()=> step.classList.remove('pulse'), 1000); }
}
function updateAllFieldsFromRow(row){
  if (typeof window.fillAllFromRow === 'function'){
    try { window.fillAllFromRow(row); }
    catch(e){ console.error('fillAllFromRow falhou, usando fallback:', e); fillFromRowFallback(row); }
  } else {
    fillFromRowFallback(row);
  }
  proceedToStep2();
}

// === Normalização do objeto recebido da API para o formato esperado por fillAllFromRow ===
function normalizeRowForFill(row){
  const pickKey = (keys)=>{
    for (const k of keys){ if (row && row[k] != null && String(row[k]).trim() !== '') return row[k]; }
    return '';
  };
  const addr = (n, altKeys=[])=>{
    // tenta campo único de endereço; se não houver, monta com partes
    const single = pickKey(altKeys);
    if (single) return single;
    const parts = [pickKey([n+'_logradouro', n+'_logradouro_nome']),
                   pickKey([n+'_numero']),
                   pickKey([n+'_complemento']),
                   pickKey([n+'_bairro']),
                   pickKey([n+'_cidade']), pickKey([n+'_uf'])].filter(Boolean);
    return parts.length ? parts.join(', ') : '';
  };

  return {
    // Etapa 2
    servico:        pickKey(['servico','Serviço','descricao','objeto']),
    endereco_obra:  pickKey(['endereco_obra','enderecoObra','obra_endereco','endereco']),

    // Etapa 3 (Contratante)
    contratante_nome:     pickKey(['ctt_nome','contratante_nome','contratante','cliente']),
    contratante_doc:      pickKey(['ctt_cpfCnpj','contratante_doc','cpfCnpjContratante','contratante_cnpj','cpfCnpj']),
    contratante_contato:  pickKey(['ctt_contato','contato_contratante','responsavel_contratante']),
    contratante_tel:      pickKey(['ctt_telefone','telefone_contratante','telefone']),
    contratante_email:    pickKey(['ctt_email','email_contratante','email']),
    contratante_endereco: pickKey(['ctt_endereco','contratante_endereco','endereco_contratante']) || addr('ctt',['ctt_endereco']),
    
    // Etapa 4 (Contratada)
    contratada_nome:      pickKey(['cta_nome','contratada_nome','contratada']) || 'IMPAR CLIMATIZAÇÃO E SISTEMAS LTDA',
    contratada_doc:       pickKey(['cta_cpfCnpj','contratada_doc','contratada_cnpj']),
    contratada_contato:   pickKey(['cta_contato','contato_contratada','responsavel_contratada']),
    contratada_tel:       pickKey(['cta_telefone','telefone_contratada']),
    contratada_email:     pickKey(['cta_email','email_contratada']),
    contratada_endereco:  pickKey(['cta_endereco','contratada_endereco','endereco_contratada']) || addr('cta',['cta_endereco']),

    // Etapa 5
    valor:            pickKey(['valor','valor_total']),
    Extenso_Valor:    pickKey(['Extenso_Valor','Extenso_Valor']),
    prazo_dias:       pickKey(['prazo','prazo_dias']),
    data_extenso:     pickKey(['dataExtenso','data_extenso']),
    clausulas:        pickKey(['clausulas']),
    condicoes:        pickKey(['condicoes','condicoes_pagamento'])
  };
}

// === Modal de Ação (UX mais amigável) ===
let __actionRow = null;
function openActionModal(row){
  __actionRow = row;
  const m = document.getElementById('actionModal');
  document.getElementById('actDocCode').textContent = row.codigo || row.code || '';
  m.style.display='flex';
}
function closeActionModal(){
  const m = document.getElementById('actionModal');
  if (m) m.style.display='none';
}
document.addEventListener('click', function(e){
  if(e.target && e.target.id==='btnActionCancel') closeActionModal();
  if(e.target && e.target.id==='btnActionPdf'){ if(__actionRow){ openPdfFromRow(__actionRow); } closeActionModal(); }
  if(e.target && e.target.id==='btnActionUpdate'){
    if(__actionRow){
      const norm = normalizeRowForFill(__actionRow);
      try { fillAllFromRow(norm); } catch(err){ console.error(err); }
      try { closeConsulta(); } catch(_){}
    }
    closeActionModal();
  }
});

// Entry point chamado na célula do código
function showAction(row){ openActionModal(row); }

function showAction_old(row){
  const msg = 'Deseja atualizar as informações ou gerar o PDF?\n\nClique "OK" para Atualizar, ou "Cancelar" para Gerar o PDF.';
  const chooseUpdate = confirm(msg);
  if (chooseUpdate) updateAllFieldsFromRow(row);
  else openPdfFromRow(row);
}

function renderRows(tbodyId, rows){
  const tb = document.getElementById(tbodyId);
  if (!tb) return;
  if (!rows || !rows.length){
    tb.innerHTML = '<tr><td colspan="6" class="row-muted">Nenhum registro encontrado.</td></tr>';
    return;
  }
  let html = '';
  for (const row of rows){
    const rowData = JSON.stringify(row).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;');
    const dt   = pick(row, ['created_at','data','Data','timestamp','DATA','dt']);
    const cod  = pick(row, ['codigo','Código','CÓDIGO','CODIGO','code']);
    const serv = pick(row, ['servico','Serviço','SERVIÇO','descricao','Descrição','DESCRICAO','objeto','OBJETO']);
    const cttN = pick(row, ['ctt_nome','contratante_nome','contratante','Contratante','CONTRATANTE','cliente','CLIENTE']);
    const cttD = pick(row, ['ctt_cpfCnpj','contratante_doc','cpfCnpj','cpfCnpjContratante','contratante_cnpj']);
    const ctaN = pick(row, ['cta_nome','contratada_nome','contratada','Contratada','CONTRATADA']) || 'IMPAR CLIMATIZAÇÃO E SISTEMAS LTDA';
    const ctaD = pick(row, ['cta_cpfCnpj','contratada_doc','contratada_cnpj']);
    const href = pdfHrefFromRow(row);
    html += `
      <tr>
        <td>${fmtDate(dt) || '—'}</td>
        <td>${cod ? `<a href="#" class="code-link" data-row="${rowData}" onclick='showAction(JSON.parse(this.dataset.row));return false;'>${cod}</a>` : '—'}</td>
        <td><div>${cttN || '—'}</div><small>${cttD || ''}</small></td>
        <td><div>${ctaN || '—'}</div><small>${ctaD || ''}</small></td>
        <td>${serv || '—'}</td>
        <td>${href !== '#' ? `<a class="link" href="${href}" target="_blank" rel="noopener noreferrer">abrir</a>` : '—'}</td>
      </tr>
    `;
  }
  tb.innerHTML = html;
}


function renderConsMsgInline(msg){
  const tb=document.getElementById('consBodyInline');
  if (tb) tb.innerHTML = `<tr><td colspan="3" class="row-muted">${msg}</td></tr>`;
}

async function fetchConsulta(codigo){
  const LIST_URL = apiPatch.LIST_URL, SAVE_TOKEN = apiPatch.SAVE_TOKEN;
  if(!LIST_URL || !SAVE_TOKEN) throw new Error('Endpoint não configurado.');

  // Envia o token NO CORPO (POST) — não aparece no URL/DOM
  const body = new URLSearchParams({ token: SAVE_TOKEN, codigo: (codigo||'') }).toString();

  const r = await fetch(LIST_URL, {
    method: 'POST',
    headers: { 'Content-Type':'application/x-www-form-urlencoded' },
    body
  });
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}

// Toggle da consulta inline
function toggleInlineConsulta(){
  const box = document.getElementById('consultaInline');
  if (!box) return;
  box.classList.toggle('hidden');
  const cur = (document.getElementById('codigo').value||'').trim();
  const input = document.getElementById('consCodigoInline');
  if (input && cur && !input.value) input.value = cur;
}


async function doSearch(){
  try{
    const code = (document.getElementById('consCodigo').value||'').trim();
    renderConsMsg('Buscando...');
    const j    = await fetchConsulta(code);      // POST com token no corpo
    const rows = (j && j.rows) ? j.rows : [];
    if(!rows.length){
      renderConsMsg(code ? 'Código não encontrado.' : 'Nenhum registro encontrado.');
      return;
    }
    renderRows('consBody', rows);
  }catch(e){
    console.error(e);
    renderConsMsg('Falha ao buscar.');
  }
}

document.getElementById('openConsultaBtn').onclick = openConsulta;
document.getElementById('btnCloseConsulta').onclick=closeConsulta;
document.getElementById('btnBuscar').onclick=doSearch;

// === Consulta inline: Enter + botão ===
document.getElementById('btnBuscarInline').onclick = async ()=>{
  const code = (document.getElementById('consCodigoInline').value||'').trim();
  renderConsMsgInline('Buscando...');
  try{
    const j = await fetchConsulta(code);           // usa POST com token no corpo (passo 2)
    const rows = (j && j.rows) ? j.rows : [];
    if (!rows.length){
      renderConsMsgInline(code ? 'Código não encontrado.' : 'Nenhum registro encontrado.');
    }else{
      renderRows('consBodyInline', rows);          // mesma tabela da modal
    }
  }catch(e){
    console.error(e);
    renderConsMsgInline('Falha ao buscar.');
  }
};

// Enter no campo da inline
document.getElementById('consCodigoInline').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    e.preventDefault();
    document.getElementById('btnBuscarInline').click();
  }
});

// Enter no campo da MODAL
document.getElementById('consCodigo').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    e.preventDefault();
    document.getElementById('btnBuscar').click();
  }
});

// Sincroniza com o campo principal "codigo" quando a consulta inline estiver aberta
document.getElementById('codigo').addEventListener('input', ()=>{
  const cur = (document.getElementById('codigo').value||'').trim();
  const box = document.getElementById('consultaInline');
  if (!box || box.classList.contains('hidden')) return;
  const input = document.getElementById('consCodigoInline');
  if (input) input.value = cur;
});

/* ===== Fechar / Limpar ===== */
function closeWizard(){
  const current = [...document.querySelectorAll('.card')].findIndex(c => !c.classList.contains('hidden')) + 1;
  if (current <= 1){
    try { window.location.href = LOGIN_URL; } catch(e){ goTo(1); }
  } else {
    goTo(1);
  }
}
function clearLocal(){
  try{
    // Se quiser manter o usuário, comente a linha abaixo.
    // localStorage.removeItem('impar_user');
    ['screen2','screen3','screen4','screen5'].forEach(sc=>{
      const box = document.getElementById(sc);
      if(!box) return;
      box.querySelectorAll('input,textarea,select').forEach(el=>{
        if(el.type==='file') el.value = '';
        else if (el.tagName==='SELECT') el.selectedIndex = 0;
        else el.value = '';
      });
    });
    document.getElementById('codigo').value=''
    showToast('Dados locais limpos');
  }catch(e){}
}

/* ===== Código único na etapa 1 ===== */
(function overrideStep1(){
  const b = document.getElementById('bar1');
  const codigoEl = document.getElementById('codigo');

  function arm(){
    const v = (codigoEl.value||'').trim();
    if(v){
      b.classList.add('enabled'); b.classList.remove('disabled');
      b.onclick = ()=>proceedFromStep1(v);
    }else{
      b.classList.add('disabled'); b.classList.remove('enabled');
      b.onclick = noop;
    }
  }
  arm();
  codigoEl.addEventListener('input', arm);

  // Enter => continuar
  codigoEl.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){
      e.preventDefault();
      const v = (codigoEl.value||'').trim();
      if(v) proceedFromStep1(v);
    }
  });
})();

async function proceedFromStep1(codigo){
  const LIST_URL = apiPatch.LIST_URL, SAVE_TOKEN = apiPatch.SAVE_TOKEN;
  if(!LIST_URL || !SAVE_TOKEN){ goTo(2); return; }
  try{
    const j    = await fetchConsulta(codigo);     // POST com token no corpo
    const rows = (j && j.rows) ? j.rows : [];
    if(rows.length === 0){ goTo(2); return; }
    const exact = rows.find(r => (String(r.codigo||'').toUpperCase() === String(code).toUpperCase()));
    if (exact) { openDupeModal(exact); } else { goTo(2); }
  }catch(e){
    console.error(e);
    goTo(2);
  }
}

let __dupeRow = null;
function openDupeModal(row){
  __dupeRow = row || null;
  const el = document.getElementById('dupeModal');
  const info = document.getElementById('dupeInfo');
  if(info){ info.textContent = `Código: ${row.codigo || '-'} • Obra: ${row.contratante_nome || '-'}`; }
  el.style.display = 'flex';
}
function closeDupeModal(){ document.getElementById('dupeModal').style.display='none'; }
document.getElementById('btnDupCancel').onclick = () => { closeDupeModal(); };
document.getElementById('btnDupPrint').onclick = () => {
  if(!__dupeRow){ closeDupeModal(); return; }
  openPdfSmart(__dupeRow); closeDupeModal();
};
document.getElementById('btnDupUpdate').onclick = () => {
  if(!__dupeRow){ closeDupeModal(); return; }
  fillAllFromRow(__dupeRow); closeDupeModal(); goTo(2); showToast('Dados carregados do cadastro existente');
};

function setVal(id, v){ const el=document.getElementById(id); if(el){ el.value = (v||''); if(el.oninput) try{ el.oninput({}); }catch(_){} } }
function setSel(id, v){ const el=document.getElementById(id); if(el){ el.value = (v||''); if(el.onchange) try{ el.onchange({}); }catch(_){} } }

function fillAllFromRow(row){
  // Etapa 2
  setVal('servico',       row.servico);
  setVal('endereco',      row.endereco_obra);

  // Etapa 3 (Contratante)
  setVal('nomeContratante',     row.contratante_nome);
  setVal('docContratante',      row.contratante_doc);
  setVal('contatoContratante',  row.contratante_contato);
  setVal('telefoneContratante', row.contratante_tel);
  setVal('emailContratante',    row.contratante_email);
  setVal('cepContratante',      (row.contratante_endereco||'').match(/CEP\s([\d\-]+)/i)?.[1] || '');
  splitAddressToForm('Contratante', row.contratante_endereco);

  // Etapa 4 (Contratada)
  setVal('nomeContratada',      row.contratada_nome);
  setVal('docContratada',       row.contratada_doc);
  setVal('contatoContratada',   row.contratada_contato);
  setVal('telefoneContratada',  row.contratada_tel);
  setVal('emailContratada',     row.contratada_email);
  setVal('cepContratada',       (row.contratada_endereco||'').match(/CEP\s([\d\-]+)/i)?.[1] || '');
  splitAddressToForm('Contratada', row.contratada_endereco);

  // Etapa 5
  setVal('valor',        row.valor);
  setVal('Extenso_Valor', row.Extenso_Valor);
  setVal('prazo',        row.prazo_dias);
  setVal('dataExtenso',  row.data_extenso)

  
// Etapa 5 — textos (cláusulas / condições)
setVal('clausulas', row.clausulas || row.clausulas_texto || row.textoClausulas || row.clausulas_gerais || '');
setVal('condicoes', row.condicoes || row.condicoes_pagamento || row.condicoes_texto || row.textoCondicoes || row.condicoesGerais || '');
;

  try { validate2(); } catch(_){}
  try { validate3(); } catch(_){}
  try { validate4(); } catch(_){}
  try { validate5(); } catch(_){}
}

// quebra best-effort do endereço salvo
function splitAddressToForm(prefix, enderecoCompleto){
  if(!enderecoCompleto) return;
  const r = {logradouro:'',numero:'',complemento:'',bairro:'',cidade:'',uf:''};
  try{
    const parts = enderecoCompleto.split(' — ');
    const p1=(parts[0]||'').split(',');
    r.logradouro=(p1[0]||'').trim();
    const p1b=(p1[1]||'').trim().split(' - ');
    r.numero=(p1b[0]||'').trim();
    r.complemento=(p1b[1]||'').trim();
    r.bairro=(parts[1]||'').trim();
    const m=(parts[2]||'').match(/(.+)\/([A-Z]{2})/);
    if(m){ r.cidade=m[1].trim(); r.uf=m[2].trim(); }
  }catch(_){}
  setVal('logradouro'+prefix, r.logradouro);
  setVal('numero'+prefix,     r.numero);
  setVal('complemento'+prefix,r.complemento);
  setVal('bairro'+prefix,     r.bairro);
  setVal('cidade'+prefix,     r.cidade);
  setSel('uf'+prefix,         r.uf);
}
function focusNext(el){
  const id = el.getAttribute('data-next');
  if(!id) return false;
  const nxt = document.getElementById(id);
  if(nxt){
    nxt.focus({ preventScroll: true });
    // Em iOS às vezes precisa rolar um pouquinho:
    setTimeout(()=>nxt.scrollIntoView({block:'center', behavior:'smooth'}), 60);
    return true;
  }
  return false;
}

// Atalho: em qualquer input/textarea com data-next,
// pressionar Enter move para o próximo
(function armNextKeys(){
  document.addEventListener('keydown', (e)=>{
    if(e.key !== 'Enter') return;
    const el = e.target;
    if(!(el instanceof HTMLElement)) return;
    if(!el.matches('input, textarea, select')) return;

    // se tiver data-next, usamos navegação custom
    if(el.hasAttribute('data-next')){
      e.preventDefault();
      focusNext(el);
    }
  });
})();

// ✅ Clique simples na tabela de consulta — apenas copia o código, fecha e foca o botão
document.addEventListener('click', function(e) {
  const cell = e.target.closest('td:nth-child(2)'); // segunda coluna (Código)
  if (!cell || !cell.textContent.trim()) return;
  const tr = cell.parentElement;
  if (!tr || !tr.closest('#consultaModal')) return;

  e.preventDefault();
  const code = cell.textContent.trim();
  const inp = document.getElementById('codigo');
  if (inp) {
    inp.value = code;
    try { inp.dispatchEvent(new Event('input', { bubbles: true })); } catch(_) {}
  }

  const modal = document.getElementById('consultaModal');
  if (modal) modal.style.display = 'none';

  const continuar = document.getElementById('bar1');
  if (continuar) setTimeout(() => continuar.focus(), 0);
});

    // ===== Init =====
    updateStepper(1); validate1();
  </script>
<!-- ====== INTEGRAÇÃO DOCX (sem defaults) ====== -->
<script>
(function(){
  const URL_DOCX = 'https://api.erpimpar.com.br/gerador/gerar_docx.php';

  async function gerarDOCXContrato(payload){
    const resp = await fetch(URL_DOCX, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!resp.ok){
      const txt = await resp.text();
      throw new Error('Falha ao gerar DOCX: ' + txt.slice(0,300));
    }
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const codigo = (payload.codigo || 'DOC').toString().replace(/[^0-9A-Za-z_\-]/g,'_');
    a.download = `CONTRATO_${codigo}.docx`;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(url);
    a.remove();
  }

  function getVal(sel){ const el=document.querySelector(sel); return el?el.value:''; }

  function mapearParaTemplateDoRegistro(r){
    const out = {
      codigo: r.codigo,
      servico: r.servico,
      endereco_obra: r.endereco_obra,

      contratante_nome: r.contratante_nome,
      contratante_endereco: r.contratante_endereco,
      contratante_doc: r.contratante_doc,
      contratante_contato: r.contratante_contato,
      contratante_CNPJ: r.contratante_CNPJ,

      contratada_nome: r.contratada_nome,
      contratada_endereco: r.contratada_endereco,
      contratada_doc: r.contratada_doc,
      contratada_CNPJ: r.contratada_CNPJ,

      clausulas: r.clausulas,
      prazo_dias: r.prazo_dias,
      valor: r.valor,
      Extenso_Valor: r.Extenso_Valor,
      condicoes: r.condicoes,
      data_extenso: r.data_extenso
    };
    Object.keys(out).forEach(k => { if (out[k] === undefined) delete out[k]; });
    return out;
  }

  function coletarMinimoDoFormulario(){
    const out = {
      codigo: getVal('#codigo'),
      servico: getVal('#servico'),
      endereco_obra: getVal('#endereco_obra'),
      contratante_nome: getVal('#contratante_nome'),
      contratante_endereco: getVal('#contratante_endereco'),
      contratante_doc: getVal('#contratante_doc'),
      contratante_contato: getVal('#contratante_contato'),
      contratante_CNPJ: getVal('#contratante_CNPJ'),
      contratada_nome: getVal('#contratada_nome'),
      contratada_endereco: getVal('#contratada_endereco'),
      contratada_doc: getVal('#contratada_doc'),
      contratada_CNPJ: getVal('#contratada_CNPJ'),
      clausulas: getVal('#clausulas'),
      prazo_dias: getVal('#prazo_dias'),
      valor: getVal('#valor'),
      Extenso_Valor: getVal('#Extenso_Valor'),
      condicoes: getVal('#condicoes'),
      data_extenso: getVal('#data_extenso')
    };
    Object.keys(out).forEach(k => { if (out[k] === '') delete out[k]; });
    return out;
  }

  document.getElementById('btnGerarDocx')?.addEventListener('click', async () => {
    try {
      let payload = null;
      if (window.documentoAtual && typeof window.documentoAtual === 'object') {
        payload = mapearParaTemplateDoRegistro(window.documentoAtual);
      } else {
        payload = coletarMinimoDoFormulario();
      }
      await gerarDOCXContrato(payload);
    } catch (e) {
      alert(e.message);
      console.error(e);
    }
  });

  document.addEventListener('click', async (ev) => {
    const t = ev.target;
    if (t && t.classList && t.classList.contains('btn-docx')){
      const id = t.dataset.id;
      if (!id) return;
      if (typeof window.carregarRegistroPorId === 'function') {
        try {
          const r = await window.carregarRegistroPorId(id);
          const payload = mapearParaTemplateDoRegistro(r);
          await gerarDOCXContrato(payload);
        } catch (e) {
          alert('Erro ao gerar DOCX: ' + e.message);
          console.error(e);
        }
      } else {
        alert('Função carregarRegistroPorId(id) não encontrada.');
      }
    }
  });
})();
</script>
<script>
(function(){
  const URL_DOCX = 'https://api.erpimpar.com.br/gerador/gerar_docx.php';

  async function gerarDOCXContrato(payload){
    const resp = await fetch(URL_DOCX, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!resp.ok){
      const txt = await resp.text();
      throw new Error('Falha ao gerar DOCX: ' + txt.slice(0,300));
    }
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const codigo = (payload.codigo || 'DOC').toString().replace(/[^0-9A-Za-z_\-]/g,'_');
    a.download = `CONTRATO_${codigo}.docx`;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(url);
    a.remove();
  }

  function getVal(sel){ const el=document.querySelector(sel); return el?el.value:''; }

  function mapearParaTemplateDoRegistro(r){
    const out = {
      codigo: r.codigo,
      servico: r.servico,
      endereco_obra: r.endereco_obra || r.enderecoObra,
      contratante_nome: r.contratante_nome || (r.contratante && r.contratante.nome),
      contratante_endereco: r.contratante_endereco || (r.contratante && r.contratante.endereco),
      contratante_doc: r.contratante_doc || (r.contratante && r.contratante.cpfCnpj),
      contratante_contato: r.contratante_contato || (r.contratante && r.contratante.contato),
      contratante_CNPJ: r.contratante_CNPJ || (r.contratante && r.contratante.cpfCnpj),
      contratada_nome: r.contratada_nome || (r.contratada && r.contratada.nome),
      contratada_endereco: r.contratada_endereco || (r.contratada && r.contratada.endereco),
      contratada_doc: r.contratada_doc || (r.contratada && r.contratada.cpfCnpj),
      contratada_CNPJ: r.contratada_CNPJ || (r.contratada && r.contratada.cpfCnpj),
      clausulas: r.clausulas || r.clausulas_texto,
      prazo_dias: r.prazo_dias || r.prazo,
      valor: r.valor,
      Extenso_Valor: r.Extenso_Valor || r.Extenso_Valor,
      condicoes: r.condicoes || r.condicoes_pagamento,
      data_extenso: r.data_extenso || r.dataExtenso || r.data
    };
    Object.keys(out).forEach(k => (out[k]===undefined || out[k]==='') && delete out[k]);
    return out;
  }

  function coletarDoFormulario(){
    const endereco_obra = getVal('#endereco') || getVal('#endereco_obra');
    const out = {
      codigo: getVal('#codigo'),
      servico: getVal('#servico'),
      endereco_obra,
      contratante_nome: getVal('#nomeContratante'),
      contratante_endereco: (()=>{
        const log = getVal('#logradouroContratante'),
              num = getVal('#numeroContratante'),
              comp= getVal('#complementoContratante'),
              bai = getVal('#bairroContratante'),
              cid = getVal('#cidadeContratante'),
              uf  = getVal('#ufContratante'),
              cep = getVal('#cepContratante');
        return log ? `${log}, ${num}${comp?(' - '+comp):''} — ${bai} — ${cid}/${uf} — CEP ${cep}` : '';
      })(),
      contratante_doc: getVal('#docContratante'),
      contratante_contato: getVal('#contatoContratante'),
      contratante_CNPJ: getVal('#docContratante'),
      contratada_nome: getVal('#nomeContratada'),
      contratada_endereco: (()=>{
        const log = getVal('#logradouroContratada'),
              num = getVal('#numeroContratada'),
              comp= getVal('#complementoContratada'),
              bai = getVal('#bairroContratada'),
              cid = getVal('#cidadeContratada'),
              uf  = getVal('#ufContratada'),
              cep = getVal('#cepContratada');
        return log ? `${log}, ${num}${comp?(' - '+comp):''} — ${bai} — ${cid}/${uf} — CEP ${cep}` : '';
      })(),
      contratada_doc: getVal('#docContratada'),
      contratada_CNPJ: getVal('#docContratada'),
      clausulas: getVal('#clausulas'),
      prazo_dias: getVal('#prazo'),
      valor: getVal('#valor'),
      Extenso_Valor: getVal('#Extenso_Valor'),
      condicoes: getVal('#condicoes'),
      data_extenso: getVal('#dataExtenso')
    };
    Object.keys(out).forEach(k => out[k]==='' && delete out[k]);
    return out;
  }

  const btnTop = document.getElementById('btnGerarDocxTop');
  if (btnTop){
    btnTop.addEventListener('click', async () => {
      try{
        let payload;
        if (window.documentoAtual && typeof window.documentoAtual === 'object'){
          payload = mapearParaTemplateDoRegistro(window.documentoAtual);
        } else {
          payload = coletarDoFormulario();
        }
        await gerarDOCXContrato(payload);
      } catch(e){ alert(e.message); console.error(e); }
    });
  }

  function openExistingPdfByUrl(url){
    const iframe = document.getElementById('pdfFrame');
    if (!iframe) { window.open(url, '_blank'); return; }
    iframe.src = url;
    const viewer = document.getElementById('viewer');
    if (viewer) viewer.style.display = 'flex';
  }

  document.addEventListener('click', (ev)=>{
    const a = ev.target.closest('.code-link, .pdf-code-link, .codigo-link');
    if (!a) return;
    ev.preventDefault();
    const tr = a.closest('tr');
    let pdfHref = null;
    if (tr){
      const link = tr.querySelector('a.pdf-link, a[href$=".pdf"]');
      if (link) pdfHref = link.getAttribute('href');
    }
    if (!pdfHref && a.dataset && a.dataset.pdf) pdfHref = a.dataset.pdf;
    if (pdfHref) openExistingPdfByUrl(pdfHref);
  });
})();
</script>
<!-- Botão "Gerar contrato.docx" AO LADO do "Baixar PDF" no viewer -->
<script>
(function(){
  const URL_DOCX = 'https://api.erpimpar.com.br/gerador/gerar_docx.php';

  function mapearRegistro(r){
    if (!r) return {};
    const out = {
      codigo: r.codigo,
      servico: r.servico,
      endereco_obra: r.endereco_obra || r.enderecoObra,
      contratante_nome: r.contratante_nome || (r.contratante && r.contratante.nome),
      contratante_endereco: r.contratante_endereco || (r.contratante && r.contratante.endereco),
      contratante_doc: r.contratante_doc || (r.contratante && r.contratante.cpfCnpj),
      contratante_contato: r.contratante_contato || (r.contratante && r.contratante.contato),
      contratante_CNPJ: r.contratante_CNPJ || (r.contratante && r.contratante.cpfCnpj),
      contratada_nome: r.contratada_nome || (r.contratada && r.contratada.nome),
      contratada_endereco: r.contratada_endereco || (r.contratada && r.contratada.endereco),
      contratada_doc: r.contratada_doc || (r.contratada && r.contratada.cpfCnpj),
      contratada_CNPJ: r.contratada_CNPJ || (r.contratada && r.contratada.cpfCnpj),
      clausulas: r.clausulas || r.clausulas_texto,
      prazo_dias: r.prazo_dias || r.prazo,
      valor: r.valor,
      Extenso_Valor: r.Extenso_Valor || r.Extenso_Valor,
      condicoes: r.condicoes || r.condicoes_pagamento,
      data_extenso: r.data_extenso || r.dataExtenso || r.data
    };
    Object.keys(out).forEach(k => (out[k]===undefined || out[k]==='') && delete out[k]);
    return out;
  }

  async function gerarDOCX(){
    if (!window.documentoAtual || typeof window.documentoAtual !== 'object'){
      alert('Abra um documento primeiro para gerar o contrato.');
      return;
    }
    const payload = mapearRegistro(window.documentoAtual);
    const resp = await fetch(URL_DOCX, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if (!resp.ok){
      const txt = await resp.text();
      throw new Error('Falha ao gerar DOCX: ' + txt.slice(0,300));
    }
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const codigo = (payload.codigo || 'DOC').toString().replace(/[^0-9A-Za-z_\-]/g,'_');
    a.download = `CONTRATO_${codigo}.docx`;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(url);
    a.remove();
  }

  function ensureBtnNextToBaixarPDF(){
    // procura o botão "Baixar PDF" dentro do viewer
    const pdfBtn = Array.from(document.querySelectorAll('#viewer button, #viewer a'))
      .find(el => /baixar\s*pdf/i.test((el.textContent||'').trim()));
    if (!pdfBtn) return;
    if (document.getElementById('btnGerarContratoDocx')) return;

    const btn = document.createElement('button');
    btn.id = 'btnGerarContratoDocx';
    btn.type = 'button';
    // herda a classe do "Baixar PDF" para ficar idêntico
    btn.className = pdfBtn.className || 'btn';
    btn.style.marginLeft = '8px';
    btn.textContent = 'Gerar contrato.docx';
    btn.addEventListener('click', async ()=>{
      try { await gerarDOCX(); } catch(e){ alert(e.message); console.error(e); }
    });

    // insere logo depois do "Baixar PDF"
    if (pdfBtn.parentNode) {
      pdfBtn.parentNode.insertBefore(btn, pdfBtn.nextSibling);
    }
  }

  // Observa o abrir do viewer
  (function watchViewer(){
    const viewer = document.getElementById('viewer');
    if (!viewer) return;
    const obs = new MutationObserver(()=>{
      const visible = getComputedStyle(viewer).display !== 'none';
      if (visible) {
        setTimeout(ensureBtnNextToBaixarPDF, 30);
        setTimeout(ensureBtnNextToBaixarPDF, 200);
      }
    });
    obs.observe(viewer, {attributes:true, attributeFilter:['style','class']});
  })();

  // Caso o viewer já esteja aberto no load
  document.addEventListener('DOMContentLoaded', ()=>{
    setTimeout(ensureBtnNextToBaixarPDF, 200);
  });
})();
</script>
<script>
function proceedFromStep1() {
  const codigo = (document.getElementById('codigo')?.value || '').trim();
  if (!codigo) return;
  try {
    if (typeof showBusy === 'function') showBusy('Buscando documento pelo código...');
    const _fetch = (typeof fetchConsulta === 'function') ? fetchConsulta(codigo) : Promise.reject(new Error('fetchConsulta não disponível'));
    Promise.resolve(_fetch).then((res) => {
      const rows = (res && Array.isArray(res.rows)) ? res.rows : [];
      if (rows.length === 1) {
        const norm = (typeof normalizeRowForFill === 'function') ? normalizeRowForFill(rows[0]) : rows[0];
        if (typeof fillAllFromRow === 'function') fillAllFromRow(norm);
        try {
          const mirrors = document.querySelectorAll('[id^="codigoVal"]');
          mirrors.forEach(el => { el.textContent = codigo; });
        } catch(e) {}
        if (typeof goTo === 'function') goTo(2);
      } else if (rows.length === 0) {
        (window.toast?.error || window.alert)('Código não encontrado.');
      } else {
        (window.toast?.error || window.alert)('Mais de um documento com esse código.');
      }
    }).catch((err) => {
      (window.toast?.error || window.alert)('Falha ao buscar o documento.');
      console.error(err);
    }).finally(() => {
      if (typeof hideBusy === 'function') hideBusy();
    });
  } catch (err) {
    if (typeof hideBusy === 'function') hideBusy();
    (window.toast?.error || window.alert)('Falha ao buscar o documento.');
    console.error(err);
  }
}
</script>
<script>
// Chama delete.php para deduplicar por CÓDIGO antes de carregar o documento
async function dedupeByCodigo(codigo) {
  const LIST_URL  = (window.__ERP_SAVE_PATCH__?.LIST_URL || '').trim();
  const SAVE_TOKEN= (window.__ERP_SAVE_PATCH__?.SAVE_TOKEN || '').trim();
  if (!LIST_URL || !SAVE_TOKEN || !codigo) return {ok:false, skipped:true};

  // base da API a partir do list.php
  const apiBase = LIST_URL.replace(/\/list\.php.*$/,'').replace(/\/+$/,'');
  const delUrl  = apiBase ? (apiBase + '/delete.php') : '';

  if (!delUrl) return {ok:false, skipped:true};

  const body = new URLSearchParams();
  body.set('token', SAVE_TOKEN);
  body.set('codigo', String(codigo));
  body.set('keep', 'newest'); // manter o mais recente

  try {
    const res = await fetch(delUrl, {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body
    });
    const json = await res.json().catch(()=>({}));
    return json;
  } catch (e) {
    console.warn('dedupeByCodigo falhou', e);
    return {ok:false, error:String(e)};
  }
}

// Mantém a função original e cria um wrapper que roda o dedupe antes
const __orig_proceedFromStep1 = (typeof proceedFromStep1 === 'function') ? proceedFromStep1 : null;

async function proceedFromStep1_Dedupe() {
  const codigo = (document.getElementById('codigo')?.value || '').trim();
  if (!codigo) return;
  try {
    if (typeof showBusy === 'function') showBusy('Dedupe por código...');
    await dedupeByCodigo(codigo);
  } catch (e) {
    console.warn('Erro no dedupe:', e);
  } finally {
    if (typeof hideBusy === 'function') hideBusy();
  }
  if (__orig_proceedFromStep1) return __orig_proceedFromStep1();
}

// Redireciona o botão para o wrapper (sem mexer no HTML)
window.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('bar1');
  if (btn) btn.setAttribute('onclick', 'proceedFromStep1_Dedupe()');
});
</script>
<script>
// Normaliza código: tira espaços e não-alfanuméricos, upper-case
function normCodigo(v){
  return String(v||'').replace(/[^0-9A-Za-z]/g,'').toUpperCase();
}

(function(){
  if (typeof proceedFromStep1 !== 'function') return;
  const __orig_fetch = (typeof fetchConsulta === 'function') ? fetchConsulta : null;

  window.proceedFromStep1 = function() {
    const raw = (document.getElementById('codigo')?.value || '').trim();
    const codigo = normCodigo(raw);
    if (!codigo) return;
    try {
      if (typeof showBusy === 'function') showBusy('Buscando documento pelo código...');
      const p = __orig_fetch ? __orig_fetch(raw) : Promise.reject(new Error('fetchConsulta não disponível'));
      Promise.resolve(p).then(res => {
        const rows = (res && Array.isArray(res.rows)) ? res.rows : [];
        // Log de apoio no console
        try {
          console.log('[consulta] total rows:', rows.length);
          console.log('[consulta] codes retornados:', rows.map(r => r.codigo));
        } catch(e){}

        // Filtra por código normalizado
        const matches = rows.filter(r => normCodigo(r.codigo) === codigo);

        if (matches.length === 0) {
          /* código não encontrado: seguir para novo cadastro */ if (typeof goTo === 'function') goTo(2); return;
        }

        // Escolhe o mais recente quando houver mais de um
        function t(v){ if(!v) return 0; const d=new Date(v); return isNaN(d.getTime())?0:d.getTime(); }
        matches.sort((a,b)=> (t(b.updated_at||b.created_at||b.data) - t(a.updated_at||a.created_at||a.data)));
        const row = matches[0];

        const norm = (typeof normalizeRowForFill === 'function') ? normalizeRowForFill(row) : row;
        if (typeof fillAllFromRow === 'function') fillAllFromRow(norm);
        try {
          const mirrors = document.querySelectorAll('[id^="codigoVal"]');
          mirrors.forEach(el => { el.textContent = raw; });
        } catch(e) {}
        if (typeof goTo === 'function') goTo(2);
      }).catch(err => {
        (window.toast?.error || window.alert)('Falha ao buscar o documento.');
        console.error(err);
      }).finally(()=>{
        if (typeof hideBusy === 'function') hideBusy();
      });
    } catch(e){
      if (typeof hideBusy === 'function') hideBusy();
      (window.toast?.error || window.alert)('Falha ao buscar o documento.');
      console.error(e);
    }
  };
})();
</script>
<script>
// --------- DEDUPE GLOBAL AO ABRIR CONSULTA ---------
async function dedupeAllByCodigo() {
  const LIST_URL  = (window.__ERP_SAVE_PATCH__?.LIST_URL || '').trim();
  const SAVE_TOKEN= (window.__ERP_SAVE_PATCH__?.SAVE_TOKEN || '').trim();
  if (!LIST_URL || !SAVE_TOKEN) return {ok:false, skipped:true};

  const apiBase = LIST_URL.replace(/\/list\.php.*$/,'').replace(/\/+$/,'');
  const delUrl  = apiBase ? (apiBase + '/delete.php') : '';
  if (!delUrl) return {ok:false, skipped:true};

  // Busca todos os registros
  const form = new URLSearchParams();
  form.set('token', SAVE_TOKEN);
  // sem codigo => lista completa
  const res = await fetch(LIST_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: form });
  const j = await res.json().catch(()=>({rows:[]}));
  const rows = Array.isArray(j.rows) ? j.rows : [];
  // Agrupa por codigo (normalizado)
  const norm = v => String(v||'').replace(/[^0-9A-Za-z]/g,'').toUpperCase();
  const groups = new Map();
  for (const r of rows) {
    const c = norm(r.codigo);
    if (!c) continue;
    if (!groups.has(c)) groups[c] = [];
    (groups[c] || groups.set(c, [])).push(r);
  }
  // Para cada codigo com mais de 1, chama delete.php (keep=newest)
  let affected = 0;
  for (const [code, arr] of Object.entries(groups)) {
    if (!Array.isArray(arr) || arr.length <= 1) continue;
    affected++;
    const body = new URLSearchParams();
    body.set('token', SAVE_TOKEN);
    body.set('codigo', code);
    body.set('keep', 'newest');
    try {
      await fetch(delUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    } catch(e) {
      console.warn('dedupe codigo falhou', code, e);
    }
  }
  return {ok:true, affected};
}

// Envolve a abertura do modal de consulta (ou o clique do botão "Consulta") para rodar dedupe antes
(function(){
  // Tenta interceptar a função do botão de Consulta (se houver)
  const openers = [];
  // Caso exista uma função showConsultaModal() ou similar, você pode adaptar aqui.
  // Como fallback, ligamos no botão #btnConsulta (se existir) e no botão que abre o modal (#openConsulta, etc.).
  window.addEventListener('DOMContentLoaded', () => {
    const candidates = [
      document.getElementById('btnConsulta'),
      document.querySelector('[data-open="consulta"]'),
      document.getElementById('openConsulta'),
      document.querySelector('button.consulta'),
      document.querySelector('#consultaModalButton')
    ].filter(Boolean);

    candidates.forEach(btn => {
      const originalOnClick = btn.getAttribute('onclick');
      btn.setAttribute('onclick', '');
      btn.addEventListener('click', async (ev) => {
        try {
          if (typeof showBusy === 'function') showBusy('Eliminando duplicados...');
          await dedupeAllByCodigo();
        } catch(e) {
          console.warn('dedupeAllByCodigo erro', e);
        } finally {
          if (typeof hideBusy === 'function') hideBusy();
        }
        // Reexecuta o handler original, se havia
        if (originalOnClick) {
          try { new Function(originalOnClick).call(btn); } catch(e){ console.error(e); }
        }
      });
    });
  });
})();
</script>
<script>
function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// Gera Excel a partir do MESMO objeto 'dados' usado para o PDF
function gerarExcelDoMesmoConteudo(dados, nomeBase) {
  const wsData = [];
  const ctt = dados.contratante || {}, cta = dados.contratada || {}, op = dados.operador || {};

  
  const pickEmail = (o)=> (o && (o["e-mail"] || o["email"] || o["e_mail"] || o["mail"] || o["Email"] || o["E-mail"])) || "";
  const opEmail  = pickEmail(op);
  const cttEmail = pickEmail(ctt);
  const ctaEmail = pickEmail(cta);
wsData.push(["Resumo do Documento",""]);
  wsData.push(["Operador", [op.nome || "", opEmail].filter(Boolean).join(" ")]);
  wsData.push(["Código do Projeto", dados.codigo || dados["código"] || ""]);
  wsData.push(["Serviço", dados.servico || ""]);
  wsData.push(["Endereço da obra", dados.enderecoObra || dados.enderecoobra || ""]);
  wsData.push(["",""]);

  wsData.push(["CONTRATANTE",""]);
  wsData.push(["Nome", ctt.nome || ""]);
  wsData.push(["CPF/CNPJ", ctt.cpfCnpj || ctt.cpfcnpj || ""]);
  wsData.push(["Endereço", ctt.endereco || ""]);
  wsData.push(["Contato", ctt.contato || ""]);
  wsData.push(["Telefone", ctt.telefone || ""]);
  wsData.push(["E-mail", cttEmail]);
  wsData.push(["",""]);

  wsData.push(["CONTRATADA",""]);
  wsData.push(["Nome", cta.nome || ""]);
  wsData.push(["CPF/CNPJ", cta.cpfCnpj || cta.cpfcnpj || ""]);
  wsData.push(["Endereço", cta.endereco || ""]);
  wsData.push(["Contato", cta.contato || ""]);
  wsData.push(["Telefone", cta.telefone || ""]);
  wsData.push(["E-mail", ctaEmail]);
  wsData.push(["",""]);

  wsData.push(["CONDIÇÕES",""]);
  wsData.push(["Valor", dados.valor || ""]);
  wsData.push(["Valor (extenso)", dados.Extenso_Valor || dados.Extenso_Valor || ""]);
  wsData.push(["Prazo", dados.prazo || ""]);
  wsData.push(["Data", dados.dataExtenso || dados.dataextenso || ""]);
  wsData.push(["Condições de pagamento", (dados.condicoes || dados.condicoespagamento || "")]);
  wsData.push(["",""]);

  wsData.push(["Cláusulas", (dados.clausulas || "")]);

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols'] = [{wch:40},{wch:90}];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Documento");
  const ab = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([ab], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
  const fn = (nomeBase || 'DOC') + ".xlsx";
  downloadBlob(blob, fn);
}

// Hook simples chamado após salvamento OK (PDF no servidor, Excel para o usuário)
function __afterPdfSavedGenerateExcel(dados) {
  const base = (typeof dados.codigo !== 'undefined' ? dados.codigo : (dados["código"]||"DOC"));
  const ymd = new Date().toISOString().slice(0,10).replaceAll('-','');
  const nomeBase = (base || 'DOC');
  try { gerarExcelDoMesmoConteudo(dados, nomeBase); } catch(e){ console.error(e); }
}

// Troca apenas os textos visuais de PDF -> EXCEL (não altera funções internas)
document.addEventListener('DOMContentLoaded', () => {
  const swap = (el) => { el.textContent = el.textContent.replace(/PDF/gi, 'EXCEL'); };
  document.querySelectorAll('button, .hint, .hd, .bd, .ft, label, .btn').forEach(el => {
    if (el && /PDF/i.test(el.textContent || '')) swap(el);
  });
});
</script>
<div class="version-badge">Versão 1.0 - 17-10-2025</div><div id="consultaJsonModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1000;"><div style="background:#fff;max-width:880px;width:92%;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden;"><div style="padding:10px 14px;font-weight:700;background:#f3f4f6;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;"><div>Consulta de documentos (Excel)</div><button id="consultaJsonClose" style="background:none;border:0;font-size:18px;cursor:pointer" type="button">×</button></div><div style="padding:12px;max-height:70vh;overflow:auto"><table id="consultaJsonTable" style="width:100%;border-collapse:collapse"><thead><tr><th style="padding:8px 10px;border-bottom:1px solid #eee;text-align:left;background:#fafafa;position:sticky;top:0;font-size:14px;">Código</th><th style="padding:8px 10px;border-bottom:1px solid #eee;text-align:left;background:#fafafa;position:sticky;top:0;font-size:14px;">Data de geração</th><th style="padding:8px 10px;border-bottom:1px solid #eee;text-align:left;background:#fafafa;position:sticky;top:0;font-size:14px;">Contratante (Nome)</th></tr></thead><tbody id="consultaJsonTbody"></tbody></table></div></div></div><script>
// WIRE_SEARCH_JSON_V1
(function(){
  function qs(s, r){ return (r||document).querySelector(s); }
  function qsa(s, r){ return Array.from((r||document).querySelectorAll(s)); }
  function show(el, on){ if(el) el.style.display = on ? 'flex' : 'none'; }
  var LIST_URL = (window.apiPatch && window.apiPatch.LIST_URL) || window.LIST_URL;
  var SAVE_TOKEN = (window.apiPatch && window.apiPatch.SAVE_TOKEN) || window.SAVE_TOKEN;
  var btn = qs('#searchJsonBtn');
  var modal = qs('#consultaJsonModal');
  var tbody = qs('#consultaJsonTbody');
  var closeBtn = qs('#consultaJsonClose');
  var codigoInput = qs('#codigo');

  async function listarArquivos(){
    if(!LIST_URL) throw new Error('LIST_URL ausente');
    var body = new URLSearchParams({ token: SAVE_TOKEN || '' });
    var r = await fetch(LIST_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    if(!r.ok) throw new Error('Erro na listagem');
    return r.json();
  }

  async function abrirConsulta(){
    show(modal, true);
    if(tbody) tbody.innerHTML = '<tr><td colspan="3" style="padding:10px">Carregando...</td></tr>';
    try{
      var data = await listarArquivos();
      var files = Array.isArray(data) ? data : [];
      var jsons = files.filter(function(f){ return f && f.name && /\.json$/i.test(f.name); });
      if(jsons.length===0){ tbody.innerHTML = '<tr><td colspan="3" style="padding:10px">Nenhum documento Excel (JSON) encontrado.</td></tr>'; return; }
      var rows = await Promise.all(jsons.map(async function(f){
        var name = f.name || ''; var url = f.url || f.download || '';
        var base = name.replace(/\.json$/i, '');
        var codigo = base.split('_')[0] || base;
        var dataGer = ''; var m = base.match(/_(\d{8})$/); if(m){ var d=m[1]; dataGer = d.slice(0,4)+'-'+d.slice(4,6)+'-'+d.slice(6,8); }
        var contratante = '';
        try{
          if(url){
            var jr = await fetch(url); if(jr.ok){ var j = await jr.json(); contratante = (j.CONTRATANTE && j.CONTRATANTE['CONTRATANTE-Nome']) || ''; }
          }
        }catch(_){}
        return {codigo: codigo, dataGer: dataGer, contratante: contratante};
      }));
      tbody.innerHTML = rows.map(function(r){
        var c = (r.contratante||'').replace(/</g,'&lt;');
        return '<tr>' +
          '<td style="padding:8px 10px;border-bottom:1px solid #eee"><button class="pick-codigo" data-codigo="'+r.codigo+'" style="background:none;border:0;color:#0d6efd;text-decoration:underline;cursor:pointer;font-weight:600">'+r.codigo+'</button></td>' +
          '<td style="padding:8px 10px;border-bottom:1px solid #eee">'+(r.dataGer||'')+'</td>' +
          '<td style="padding:8px 10px;border-bottom:1px solid #eee">'+c+'</td>' +
        '</tr>';
      }).join('');
      qsa('.pick-codigo').forEach(function(b){
        b.addEventListener('click', function(){
          if(codigoInput){ codigoInput.value = b.dataset.codigo; }
          show(modal, false);
        });
      });
    }catch(e){
      tbody.innerHTML = '<tr><td colspan="3" style="padding:10px">Erro ao carregar a lista.</td></tr>';
    }
  }

  if(btn){ btn.addEventListener('click', abrirConsulta); }
  if(closeBtn){ closeBtn.addEventListener('click', function(){ show(modal,false); }); }
  if(modal){ modal.addEventListener('click', function(ev){ if(ev.target===modal) show(modal,false); }); }
})();
</script>
<div style="position:fixed; right:12px; bottom:10px; font-family:Arial,Helvetica,sans-serif; font-size:11px; color:#fff; background:#061736; border-radius:8px; padding:4px 8px; font-weight:700; z-index:9999;">Versão 103.0 - 23-10-2025</div>

<script>
function __todayYMD(){const d=new Date();const y=d.getFullYear();const m=('0'+(d.getMonth()+1)).slice(-2);const dd=('0'+d.getDate()).slice(-2);return `${y}${m}${dd}`;}
function __collectDadosParaExcel_FIX(){
  const get=(id)=>{const el=document.getElementById(id); return el ? (el.value||'').trim() : '';};
  return {
    codigo:get('codigo'), servico:get('servico'), endereco:get('endereco'), valor:get('valor'),
    Extenso_Valor:get('Extenso_Valor'), prazo:get('prazo'), dataExtenso:get('dataExtenso'),
    clausulas:get('clausulas'), condicoes:get('condicoes'),
    nomeContratante:get('nomeContratante'), docContratante:get('docContratante'),
    contatoContratante:get('contatoContratante'), telefoneContratante:get('telefoneContratante'),
    emailContratante:get('emailContratante'), cepContratante:get('cepContratante'),
    numeroContratante:get('numeroContratante'), logradouroContratante:get('logradouroContratante'),
    complementoContratante:get('complementoContratante'), bairroContratante:get('bairroContratante'),
    cidadeContratante:get('cidadeContratante'), ufContratante:get('ufContratante'),
    nomeContratada:get('nomeContratada'), docContratada:get('docContratada'),
    contatoContratada:get('contatoContratada'), telefoneContratada:get('telefoneContratada'),
    emailContratada:get('emailContratada'), cepContratada:get('cepContratada'),
    numeroContratada:get('numeroContratada'), logradouroContratada:get('logradouroContratada'),
    complementoContratada:get('complementoContratada'), bairroContratada:get('bairroContratada'),
    cidadeContratada:get('cidadeContratada'), ufContratada:get('ufContratada'),
    operador_Nome:(function(){ try{const u=JSON.parse(localStorage.getItem('impar_user')||'null')||{}; return u.Nome||'';}catch(e){return '';} })(),
    operador_Email:(function(){ try{const u=JSON.parse(localStorage.getItem('impar_user')||'null')||{}; return u.Email||'';}catch(e){return '';} })(),
    data_criacao:new Date().toISOString()
  };
}
async function __createExcelBlob_FIX(dados){
  const ws=XLSX.utils.json_to_sheet([dados],{skipHeader:false});
  const headers=Object.keys(dados); ws['!cols']=headers.map(h=>({wch:Math.min(Math.max(12,String(h).length+2),48)}));
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Documento');
  const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
  return new Blob([wbout],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
}
async function __uploadExcelToServer_FIX(excelBlob, excelName, codigo){
  const patch=(window.__ERP_SAVE_PATCH__||{});
  const SAVE_URL=patch.SAVE_URL||'https://api.erpimpar.com.br/gerador/save.php';
  const SAVE_TOKEN=patch.SAVE_TOKEN||'';
  const fd=new FormData();
  if(SAVE_TOKEN) fd.append('token', SAVE_TOKEN);
  fd.append('codigo', codigo||'');
  fd.append('pdfName', excelName);
  fd.append('nome_arquivo', excelName);
  fd.append('file', excelBlob, excelName);
  fd.append('pdf', excelBlob, excelName);
  fd.append('file_excel', excelBlob, excelName);
  try{const res=await fetch(SAVE_URL,{method:'POST',body:fd}); return {ok:res.ok,status:res.status};}catch(e){return {ok:false,error:String(e)};}
}

window.finalizeStep5 = async function(){
  const d = __collectDadosParaExcel_FIX();
  const code = (d.codigo || 'DOC').replace(/[^A-Za-z0-9_\-]/g,'_') || 'DOC';
  const excelName = `${code}.xlsx`;

  // gera e sobe o Excel
  const excelBlob = await __createExcelBlob_FIX(d);
  await __uploadExcelToServer_FIX(excelBlob, excelName, d.codigo || '');

  // download local
  try{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(excelBlob);
    a.download = excelName;
    document.body.appendChild(a);
    setTimeout(()=>{ a.click(); a.remove(); }, 0);
    setTimeout(()=> URL.revokeObjectURL(a.href), 2000);
  }catch(e){}

  // 👇 usa o mesmo toast bonito da Etapa 1
  if (window.contratoSucesso){
  const nome = d?.contratante?.nome || d?.contratante?.razao || '';
  window.contratoSucesso({
    codigo: code,
    nome,
    texto: 'Documento cadastrado com sucesso!' // 👈 override do subtítulo
  });
 }

  // remove possíveis elementos antigos
  const t = document.getElementById('toast'); if(t){ t.style.display='none'; }
  const m = document.getElementById('successModal'); if(m){ m.style.display='none'; }
};

</script>


<!-- [NOVO] Consulta JSON -->
<div id="consultaModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:99999;">
  <div style="background:#fff; width:90%; max-width:900px; border-radius:10px; padding:16px;">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
      <div style="font-weight:700;">Consulta de Documentos</div>
      <button type="button" onclick="fecharConsultaModal()" style="border:none; background:#eee; padding:6px 10px; border-radius:8px; cursor:pointer;">Fechar</button>
    </div>
    <div style="margin-bottom:8px; display:flex; gap:8px;">
      <input id="consultaFiltro" placeholder="Filtrar por código..." style="flex:1; padding:6px 10px; border:1px solid #ddd; border-radius:8px;">
      <button type="button" onclick="carregarListaConsulta()" style="background:#000; color:#fff; border:none; padding:6px 12px; border-radius:999px; cursor:pointer; font-weight:700;">Buscar</button>
    </div>
    <div style="max-height:60vh; overflow:auto; border:1px solid #eee; border-radius:8px;">
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="background:#f5f5f5;">
            <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Código</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Data</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Contratante</th>
          </tr>
        </thead>
        <tbody id="consultaBody"></tbody>
      </table>
    </div>
  </div>
</div>


<script>
async function __upsertJsonBase(dados){
  try{
    const patch=(window.__ERP_SAVE_PATCH__||{});
    const URL = (patch.JSON_URL || 'https://api.erpimpar.com.br/gerador/json_table_cors.php');
    const token = (patch.SAVE_TOKEN || '');
    const payload = {...dados};
    if (token) payload.token = token;
    payload.op = 'upsert';
    const res = await fetch(URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    return res.ok;
  }catch(e){ return false; }
}
(function(){
  const origFinalize = window.finalizeStep5;
  window.finalizeStep5 = async function(){
    await origFinalize();
    try{
      if (typeof __collectDadosParaExcel_FIX === 'function'){
        const d = __collectDadosParaExcel_FIX();
        __upsertJsonBase(d);
      }
    }catch(e){}
  };
})();
function abrirConsultaModal(){ document.getElementById('consultaModal').style.display='flex'; carregarListaConsulta(); }
function fecharConsultaModal(){ document.getElementById('consultaModal').style.display='none'; }
async function carregarListaConsulta(){
  const filtro = (document.getElementById('consultaFiltro').value || '').trim().toLowerCase();
  const patch=(window.__ERP_SAVE_PATCH__||{});
  const URL = (patch.JSON_URL || 'https://api.erpimpar.com.br/gerador/json_table_cors.php');
  const token = (patch.SAVE_TOKEN || '');
  const qs = new URLSearchParams({ op:'list' }); if (token) qs.append('token', token);
  const res = await fetch(`${URL}?${qs.toString()}`);
  const j = await res.json().catch(()=>({ok:false}));
  const tbody = document.getElementById('consultaBody');
  tbody.innerHTML='';
  if (!j || !j.ok) return;
  (j.items||[]).forEach(row=>{
    const cod = row.codigo || '';
    if (filtro && !cod.toLowerCase().includes(filtro)) return;
    const tr = document.createElement('tr'); tr.style.cursor='pointer';
    tr.onclick = ()=> abrirAcoesDocumento(cod);
    tr.innerHTML = `<td style="padding:8px; border-bottom:1px solid #f0f0f0;">${cod}</td>
                    <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${(row.data_criacao||'').slice(0,10)}</td>
                    <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${row.nomeContratante||''}</td>`;
    tbody.appendChild(tr);
  });
}
function abrirAcoesDocumento(codigo){
  if (!codigo) return;
  const op = window.confirm(`Documento ${codigo}

OK = Atualizar dados
Cancelar = Gerar Excel`);
  if (op){ carregarParaEdicao(codigo); } else { baixarExcel(codigo); }
}
async function carregarParaEdicao(codigo){
  const patch=(window.__ERP_SAVE_PATCH__||{});
  const URL = (patch.JSON_URL || 'https://api.erpimpar.com.br/gerador/json_table_cors.php');
  const token = (patch.SAVE_TOKEN || '');
  const qs = new URLSearchParams({ op:'get', codigo }); if (token) qs.append('token', token);
  const res = await fetch(`${URL}?${qs.toString()}`);
  const j = await res.json().catch(()=>({ok:false}));
  if (!j || !j.ok || !j.item) return;
  const d = j.item;
  Object.keys(d).forEach(k=>{ const el=document.getElementById(k); if (el && 'value' in el) el.value=d[k]; });
  fecharConsultaModal();
  window.scrollTo({top:0, behavior:'smooth'});
}
function baixarExcel(codigo){
  if (!codigo) return;
  alert('Abra a pasta /www/api/storage/docs e baixe o arquivo do código ' + codigo + ' com a data desejada.');
}
(function(){
  const b = document.getElementById('searchJsonBtn');
  if (b) b.addEventListener('click', abrirConsultaModal);
})();
</script>
<script src="consulta_json_v3_beauty-bkp-Funcionando-Gerador-Contrato.js"></script>

<!-- ===== Add-on ROBUSTO: garante captura do código certo e geração do DOCX ===== -->
<script>
(function(){
  const API_ORIGIN = 'https://api.erpimpar.com.br';
  const PATH_EXCEL    = '/storage/docs';
  const PATH_TEMPLATE = '/gerador/templates';

  // ---------- util ----------
  function ymd(d=new Date()){ const p=n=>String(n).padStart(2,'0'); return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate()); }
  function nomeExcelPorCodigo(codigo){ return `${codigo}.xlsx`; }
  function nomeTemplatePadrao(){ return 'Template-Contrato.docx'; }
  function findByText(selector, regex){
    return Array.from(document.querySelectorAll(selector))
      .find(el => regex.test((el.textContent||el.value||'').trim()));
  }

  // ---------- persistir código escolhido assim que o usuário clicar no resultado ----------
  // Estratégia: delegação de eventos — se sua lista tiver classe/contêiner identificado, troque '.consulta-lista'
  document.addEventListener('click', (ev)=>{
    // tenta capturar cliques em linhas da consulta
    const el = ev.target.closest('tr, li, .linha, .item, .row, .resultado, .consulta-item');
    if (!el) return;
    // procura um possível código no elemento clicado/linha
    const text = (el.textContent||'').trim();
    const m = text.match(/\bAC[0-9A-Za-z]+/i);
    if (!m) return; // não é uma linha com código
    const codigo = m[0];

    // guarda em #docMeta para uso garantido
    let meta = document.getElementById('docMeta');
    if (!meta){
      meta = document.createElement('div');
      meta.id = 'docMeta';
      meta.style.display='none';
      document.body.appendChild(meta);
    }
    meta.dataset.codigo = codigo;
    // se você souber o nome exato do arquivo Excel/Template aqui, pode setar também:
    // meta.dataset.excel = `${codigo}_20251020.xlsx`;
    // meta.dataset.template = 'Template-Contrato.docx';

    // log
    console.log('[Gerar Contrato] código selecionado na lista:', codigo);
  }, true);

  // ---------- obter código válido (nunca placeholder) ----------
  function getCodigoEscolhido(){
    // 1) prioriza #docMeta (preenchido no clique da lista)
    const metaCode = (document.getElementById('docMeta')?.dataset?.codigo||'').trim();
    if (/^AC[0-9A-Za-z]+$/i.test(metaCode)) return metaCode;

    // 2) badge/label no modal
    const modalCodeNode = Array.from(document.querySelectorAll('.modal, [role="dialog"], .dialog, .popup, body'))
      .flatMap(root => Array.from(root.querySelectorAll('*')))
      .find(el => /^AC[0-9A-Za-z]+$/i.test((el.textContent||'').trim()));
    if (modalCodeNode) return (modalCodeNode.textContent||'').trim();

    // 3) input (mas ignora placeholder)
    const input = document.querySelector('#codigo') ||
                  document.querySelector('[name="codigo"]') ||
                  document.querySelector('input[aria-label*="código" i]') ||
                  document.querySelector('input[aria-label*="codigo" i]');
    if (input){
      const v = (input.value||'').trim();
      if (/^AC[0-9A-Za-z]+$/i.test(v)) return v;
    }

    console.warn('[Gerar Contrato] Código não encontrado (placeholder ignorado).');
    return '';
  }

  // ---------- prepararGerarContrado(codigo) ----------
  window.prepararGerarContrato = function(codigo){
    const btn = document.getElementById('btnGerarContrato') ||
                findByText('button, a[role="button"]', /gerar contrato/i);
    if (!btn) { console.warn('[Gerar Contrato] botão não encontrado.'); return; }

    const meta = document.getElementById('docMeta');
    const excelName    = (meta?.dataset?.excel)    || nomeExcelPorCodigo(codigo);
    const templateName = (meta?.dataset?.template) || nomeTemplatePadrao();

    const excelURL    = `${API_ORIGIN}${PATH_EXCEL}/${encodeURIComponent(excelName)}`;
    const templateURL = `${API_ORIGIN}${PATH_TEMPLATE}/${encodeURIComponent(templateName)}`;

    btn.dataset.excelUrl    = excelURL;
    btn.dataset.templateUrl = templateURL;
    console.log('[Gerar Contrato] pronto | codigo:', codigo, '| excel:', excelURL, '| template:', templateURL);
  };

  // ---------- ligar no "Pesquisar": ao abrir modal, chama preparar... com código certo ----------
  function hookPesquisar(){
    const btn = findByText('button, input[type="button"], input[type="submit"], a[role="button"]', /pesquisar/i);
    if (!btn || btn.__hooked) return !!btn;
    btn.__hooked = true;
    btn.addEventListener('click', ()=>{
      setTimeout(()=>{
        const codigo = getCodigoEscolhido();
        if (!codigo){ console.warn('[Gerar Contrato] código não disponível após pesquisar.'); return; }
        window.prepararGerarContrato(codigo);
      }, 300);
    });
    return true;
  }

  // ---------- gerador DOCX (mesma lógica aprovada) ----------
  function xmlEscape(v){return String(v??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');}
  function makeDocxSafeRegex(ph){const esc=ph.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&'); const between='(?:<[^>]+>)*'; return new RegExp(esc.split('').join(between),'gi');}
  async function generateDocxReplacedRobusto(templateAB, map){
    const zip = await JSZip.loadAsync(templateAB);
    const p='word/document.xml'; let xml=await zip.file(p).async('string');
    xml = xml.replace(/(<w:t\b[^>]*>)([\s\S]*?)(<\/w:t>)/g,(m,o,t,c)=>{let tt=t; for(const [k,v] of Object.entries(map)){const ph='#'+k; if (tt.includes(ph)) tt=tt.split(ph).join(xmlEscape(v));} return o+tt+c;});
    for(const [k,v] of Object.entries(map)){ xml = xml.replace(makeDocxSafeRegex('#'+k), xmlEscape(v)); }
    zip.file(p, xml); return await zip.generateAsync({type:'blob'});
  }
  function sanitize(s){return String(s??'').normalize('NFKD').replace(/[^\w\s.-]/g,'').replace(/\s+/g,'-').substring(0,80)||'contrato';}
  function autoDetectHeaderRow(matrix){for(let i=0;i<matrix.length;i++){const filled=(matrix[i]||[]).filter(c=>String(c||'').trim().length>0); if(filled.length>=2) return i;} return null;}
  function buildObjectsFromMatrix(matrix, headerIdx){
    const hdr=(matrix[headerIdx]||[]).map(h=>String(h||'').trim()), objs=[];
    for(let i=headerIdx+1;i<matrix.length;i++){const row=matrix[i]||[]; if(row.every(c=>String(c||'').trim()==='')) continue; const o={}; hdr.forEach((h,ix)=>{ if(h) o[h]=row[ix]??''; }); objs.push(o);}
    return { headers: hdr.filter(Boolean), rows: objs };
  }
  async function fetchAB(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('Falha ao baixar: '+url); return await r.arrayBuffer(); }
  async function readExcelRowsFromURL(url){
    const ab=await fetchAB(url), wb=XLSX.read(new Uint8Array(ab),{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]], matrix=XLSX.utils.sheet_to_json(ws,{header:1,raw:true,blankrows:false});
    const hdrIdx=autoDetectHeaderRow(matrix); if(hdrIdx===null) return {headers:[],rows:[]}; return buildObjectsFromMatrix(matrix,hdrIdx);
  }
  async function gerarContratoDeURLs(excelURL, templateURL){
    const [{rows}, tplAB] = await Promise.all([readExcelRowsFromURL(excelURL), fetchAB(templateURL)]);
    if (!rows.length){ alert('Planilha sem dados.'); return; }
    const row=rows[0];
    const blob=await generateDocxReplacedRobusto(tplAB, row);
    const codigo = row['codigo']||row['Codigo']||row['CODIGO']||'';
    const nome   = row['nomeContratante']||row['NomeContratante']||row['nome']||'';
    const fname  = `${sanitize(codigo)}_${sanitize(nome)}`.replace(/^_+|_+$/g,'') || 'Contrato';
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fname+'.docx';
    document.body.appendChild(a); a.click(); try { window.contratoSucesso?.({ codigo: codigo, nome: nome }); } catch(_) {}; setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
  }

  // liga o clique do botão "Gerar contrato"
  function hookGerar(){
    const btn = document.getElementById('btnGerarContrato') || findByText('button, a[role="button"]', /gerar contrato/i);
    if (!btn || btn.__hooked) return !!btn;
    btn.__hooked = true;
    btn.addEventListener('click', async ()=>{
      let excelURL = btn.dataset.excelUrl, templateURL = btn.dataset.templateUrl;
      if(!excelURL){ const c = (document.getElementById('codigo')?.value||'').trim().toUpperCase(); if(c) excelURL = `https://api.erpimpar.com.br/storage/docs/${encodeURIComponent(c)}.xlsx`; }
      if (!excelURL || !templateURL){ alert('URLs do Excel/Template não definidas (data-excel-url / data-template-url).'); return; }
      try { await gerarContratoDeURLs(excelURL, templateURL); }
      catch(e){ console.error(e); alert('Erro ao gerar contrato (veja o console).'); }
    });
    return true;
  }

  // Observa a página: conecta pesquisar e gerar
  const iv = setInterval(()=>{
    const p = hookPesquisar();
    const g = hookGerar();
    if (p && g){ /* ok */ }
  }, 400);
})();
</script>

<script>
(function(){
  const AC_RE = /\bAC[0-9A-Za-z]+\b/;

  // 1) CAPTURA O CÓDIGO QUANDO CLICA NA CONSULTA (2ª COLUNA)
  document.addEventListener('click', function(e) {
    const cell = e.target.closest('td:nth-child(2)'); // segunda coluna
    if (!cell || !cell.textContent.trim()) return;
    const tr = cell.parentElement;
    // limita à tabela do modal de consulta (ajuste o seletor se seu modal tiver outro id)
    if (!tr || !tr.closest('#consultaModal')) return;

    const code = cell.textContent.trim();
    if (AC_RE.test(code) && code.toUpperCase() !== 'AC00025') {
      window.codigoSelecionado = code;
      console.log('[Consulta] Código selecionado:', code);

      // opcional: já atualiza o input #codigo
      const inp = document.getElementById('codigo');
      if (inp) {
        inp.value = code;
        try { inp.dispatchEvent(new Event('input', { bubbles: true })); } catch(_) {}
      }
    }
  }, true);

  // util: acha botão por texto visível (com e sem acento)
  function findBtnByText(re){
    return Array.from(document.querySelectorAll('button, a[role="button"], input[type="button"], input[type="submit"]'))
      .find(el => re.test((el.textContent || el.value || '').trim()));
  }

  // util: lê o input #codigo (fallback)
  function readCodigoField(){
    const el =
      document.querySelector('#codigo') ||
      document.querySelector('input[name="codigo"]') ||
      document.querySelector('input[aria-label*="código" i], input[aria-label*="codigo" i]');
    return (el?.value || '').trim();
  }

  // 2) GARANTE QUE O "GERAR CONTRATO" USE O CÓDIGO CERTO
  
function pushCodeToEtapa1(code){
  const el = document.getElementById('codigo');
  if (!el) return;
  const v = String(code||'').trim().toUpperCase();
  el.value = v;
  try{
    el.dispatchEvent(new Event('input',{bubbles:true}));
    el.dispatchEvent(new Event('change',{bubbles:true}));
  }catch(e){}
}

  function hookGerarContrato(){
    const btnGerar = findBtnByText(/gerar contrato/i);
    if (!btnGerar || btnGerar.__hooked_usaCodigo) return;
    btnGerar.__hooked_usaCodigo = true;

    btnGerar.addEventListener('click', (ev)=>{
      // pega prioritariamente o código salvo da consulta
      let codigo = document.getElementById('codigo')?.value?.trim().toUpperCase();
      pushCodeToEtapa1 && pushCodeToEtapa1(codigo);

      // fallback: tenta do campo #codigo
      if (!codigo) {
        const v = readCodigoField();
        if (AC_RE.test(v) && v.toUpperCase() !== 'AC00025') {
          codigo = v;
        }
      }

      // if (!codigo) {
        // ev.preventDefault(); ev.stopPropagation();
        // alert('Selecione um documento na consulta para gerar o contrato.');
        // return;
      // }

      // monta URLs para o gerador que você já validou
      const API = 'https://api.erpimpar.com.br';
      const ymd = (d=>{const p=n=>String(n).padStart(2,'0');return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate());})(new Date());
      btnGerar.dataset.excelUrl    = `${API}/storage/docs/${encodeURIComponent(`${codigo}.xlsx`)}`;
      btnGerar.dataset.templateUrl = `${API}/gerador/templates/${encodeURIComponent('Template-Contrato.docx')}`;

      // se tiver aquele preparador, chamamos com o código correto
      if (typeof window.prepararGerarContrato === 'function'){
        window.prepararGerarContrato(codigo);
      }

      // segue o fluxo normal do botão
      console.log('[GerarContrato] usando código:', codigo);
    }, true);
  }

  setInterval(hookGerarContrato, 300);
})();
</script>

<style>
  /* Toast suave e moderno */
  #contrato-toast {
    position: fixed; inset: auto 20px 20px auto;
    display: none; gap: 12px; align-items: center;
    background: #0b1220; color: #e6f0ff; border: 1px solid #21304a;
    padding: 14px 16px; border-radius: 12px; z-index: 999999;
    box-shadow: 0 16px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    font: 500 14px/1.25 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    transform: translateY(10px); opacity: 0; transition: .28s ease;
    max-width: min(480px, calc(100vw - 40px));
  }
  #contrato-toast.show { display:flex; transform: translateY(0); opacity: 1; }
  .toast-icon {
    width: 28px; height: 28px; border-radius: 50%;
    background: #12b98122; border: 2px solid #12b981;
    display: grid; place-items: center; position: relative; overflow: hidden;
    box-shadow: 0 0 0 3px #12b98122;
  }
  .toast-icon::before {
    content: ""; width: 9px; height: 16px; border-right: 3px solid #12b981; border-bottom: 3px solid #12b981;
    transform: rotate(45deg) translateY(-2px); opacity: 0; transition: .28s ease .08s;
  }
  #contrato-toast.show .toast-icon::before { opacity: 1; }
  .toast-title { font-weight: 700; color: #eafff6; }
  .toast-sub { opacity: .85; margin-top: 4px; font-weight: 500; }
  .toast-close {
    margin-left: 10px; background: transparent; border: 0; color: #cfe7ff; opacity:.7; cursor: pointer;
    padding: 6px; border-radius: 8px;
  }
  .toast-close:hover { opacity: 1; background:#ffffff14 }
  /* barra de progresso */
  .toast-bar {
    position: absolute; left: 0; bottom: 0; height: 3px; background: linear-gradient(90deg,#34d399,#22c55e);
    width: 100%; transform-origin: left; animation: toastbar 4.2s linear forwards;
    border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; opacity:.9;
  }
  @keyframes toastbar { to { transform: scaleX(0); } }
</style>

<div id="contrato-toast" role="status" aria-live="polite">
  <div class="toast-icon" aria-hidden="true"></div>
  <div style="display:flex; flex-direction:column">
    <div class="toast-title">Contrato gerado com sucesso</div>
    <div class="toast-sub" id="toast-sub">O download foi iniciado.</div>
  </div>
  <button class="toast-close" type="button" onclick="(function(t){t.classList.remove('show'); setTimeout(()=>t.style.display='none',280)})(document.getElementById('contrato-toast'))">✕</button>
  <div class="toast-bar"></div>
</div>

<script>
  // Exponho uma função para você chamar de onde quiser
  window.contratoSucesso = function (opts = {}) {
    const t = document.getElementById('contrato-toast');
    const sub = document.getElementById('toast-sub');
    const msg = [];

    if (opts.codigo) msg.push(`Código: ${opts.codigo}`);
    if (opts.nome)   msg.push(opts.nome);

    sub.textContent = opts.texto || (msg.length ? msg.join(' · ') : 'O download foi iniciado.');

    // mostra o toast
    t.style.display = 'flex';
    // reinicia a barra de tempo
    const bar = t.querySelector('.toast-bar');
    bar.style.animation = 'none'; void bar.offsetWidth; bar.style.animation = null;

    requestAnimationFrame(()=> t.classList.add('show'));

    // fecha automático após 4.6s
    clearTimeout(t.__hideTimer);
    t.__hideTimer = setTimeout(()=>{
      t.classList.remove('show');
      setTimeout(()=> t.style.display='none', 280);
    }, 4600);
  };

  // OPCIONAL: se quiser acoplar automaticamente ao clique do "Gerar contrato"
  (function autoHook(){
    const btns = Array.from(document.querySelectorAll('button, a[role="button"], input[type="button"], input[type="submit"]'));
    const btn = btns.find(el => /gerar contrato/i.test((el.textContent || el.value || '').trim()));
    if (!btn || btn.__toastHooked) return;
    btn.__toastHooked = true;
    btn.addEventListener('click', () => {
      // chame logo após você iniciar o download (ou aqui, se já inicia no clique)
      const codigo = (window.codigoSelecionado || document.getElementById('codigo')?.value || '').trim();
      window.contratoSucesso({ codigo: codigo && codigo !== 'AC00025' ? codigo : undefined });
    });
  })();
</script>
<script>
(function(){
  // cria o container do toast só uma vez
  let toastRoot;
  function ensureToastRoot(){
    if (toastRoot) return toastRoot;
    toastRoot = document.createElement('div');
    toastRoot.id = 'toast-root';
    toastRoot.style.position = 'fixed';
    toastRoot.style.right = '24px';
    toastRoot.style.bottom = '24px';
    toastRoot.style.zIndex = '99999';
    document.body.appendChild(toastRoot);
    return toastRoot;
  }

  // estilo do cartão do toast
  function makeToastCard(html){
    const card = document.createElement('div');
    card.style.maxWidth = '520px';
    card.style.padding = '14px 16px';
    card.style.marginTop = '10px';
    card.style.borderRadius = '12px';
    card.style.display = 'flex';
    card.style.alignItems = 'center';
    card.style.gap = '10px';
    card.style.background = '#0f172a';      // quase preto
    card.style.color = '#e2e8f0';           // cinza claro
    card.style.boxShadow = '0 8px 30px rgba(0,0,0,.25)';
    card.style.font = '14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    card.innerHTML = html;
    return card;
  }

  // ícone “check”
  function checkIcon(){
    return `<svg width="20" height="20" viewBox="0 0 24 24" fill="#22c55e">
      <path d="M9 16.17l-3.88-3.88a1 1 0 00-1.41 1.41l4.59 4.59a1 1 0 001.41 0l10-10a1 1 0 10-1.41-1.41L9 16.17z"/>
    </svg>`;
  }

  // API pública
  window.showSuccessToast = function(msg, sub=''){
    ensureToastRoot();
    const html = `
      ${checkIcon()}
      <div style="display:flex;flex-direction:column">
        <strong style="color:#a7f3d0">Contrato gerado com sucesso</strong>
        <span>${msg}${sub ? '<br><small style="opacity:.8">'+sub+'</small>' : ''}</span>
      </div>
      <button type="button" aria-label="Fechar" style="
        margin-left:auto;background:transparent;border:0;color:#94a3b8;
        cursor:pointer;font-size:18px;line-height:1">×</button>
    `;
    const card = makeToastCard(html);
    const closer = card.querySelector('button');
    closer.addEventListener('click', ()=> card.remove());
    toastRoot.appendChild(card);
    setTimeout(()=> card.remove(), 6000); // some sozinho
  };
})();
</script>



</body>
</html>