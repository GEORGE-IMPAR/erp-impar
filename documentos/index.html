
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gerador de documentos — Consulta & Ações (bonitão)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
      --line:#1e293b; --primary:#1e3a8a; --primary2:#0ea5e9;
      --chip:#1f2937; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --glass:rgba(2,6,23,.6);
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, Arial, Helvetica, sans-serif;}
    .wrap{max-width:980px;margin:30px auto;padding:0 16px;}
    .title{font-weight:800;font-size:22px;letter-spacing:.2px;margin:0 0 16px;display:inline-flex;gap:10px;align-items:center;}
    .card{background:linear-gradient(180deg,#0f172a,#0b1324);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:18px;}
    .field{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input{flex:1 1 260px;min-width:240px;background:#0b1220;border:1px solid #22314a;border-radius:999px;padding:10px 14px;color:var(--text);outline:none;transition:box-shadow .2s,border-color .2s}
    .input:focus{border-color:var(--primary2);box-shadow:0 0 0 3px rgba(14,165,233,.25)}
    .btn{height:36px;border-radius:999px;border:1px solid #2a3d60;background:linear-gradient(180deg,#263a5b,#1b2942);padding:0 14px;color:#fff;font-weight:700;letter-spacing:.15px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:0 3px 10px rgba(0,0,0,.2)}
    .btn:hover{filter:brightness(1.12)}
    .btn.primary{border-color:#0ea5e9;background:linear-gradient(180deg,#38bdf8,#0ea5e9);color:#051525}
    .hint{color:var(--muted);font-size:12px;margin-top:8px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .pill{background:var(--chip);border:1px solid #20314d;border-radius:999px;padding:4px 10px;color:#cbd5e1;font-size:12px}
    /* Consulta modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:999}
    .modal.open{display:grid}
    .panel{width:min(960px,96vw);max-height:90vh;display:flex;flex-direction:column;background:linear-gradient(180deg,#0e1526,#0b1220);border:1px solid #21314d;border-radius:16px;overflow:hidden;backdrop-filter:blur(6px);box-shadow:0 20px 60px rgba(0,0,0,.45)}
    .panel .hd{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #22314a}
    .panel .bd{padding:12px 16px;overflow:auto}
    .panel .ft{padding:12px 16px;border-top:1px solid #22314a;display:flex;gap:10px;justify-content:flex-end}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1e293b;padding:10px 8px;text-align:left;font-size:13px}
    th{font-size:12px;text-transform:uppercase;color:#8fa3c1}
    tr:hover td{background:#0c162a}
    .action{cursor:pointer;color:#93c5fd;font-weight:700}
    /* Ação modal */
    .actbox{width:min(520px,95vw);background:linear-gradient(180deg,#0e1526,#0b1220);border:1px solid #21314d;border-radius:16px;overflow:hidden}
    .acthd{padding:16px;border-bottom:1px solid #22314a;font-weight:800}
    .actbd{padding:16px;color:#cbd5e1}
    .actft{padding:12px 16px;border-top:1px solid #22314a;display:flex;gap:10px;justify-content:flex-end}
    /* Loader */
    .loader{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.8);z-index:1000}
    .loader.open{display:grid}
    .loadpanel{display:flex;align-items:center;gap:14px;background:#000;border:2px solid #fff;border-radius:8px;color:#fff;padding:12px 16px;font-weight:800}
    .spin{width:22px;height:22px;border:3px solid #666;border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hide{display:none!important}
    .link{color:#7dd3fc;font-weight:700;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1 class="title">Gerador de documentos — <span class="pill">Consulta nova + ações</span></h1>
      <button id="btnConsulta" class="btn">Pesquisar docs</button>
    </div>
    <div class="card">
      <div class="field">
        <input id="codigo" class="input" placeholder="Digite o código do projeto (ex.: AC05225)"/>
        <button id="btnContinuar" class="btn primary">Continuar</button>
      </div>
      <div class="hint">Apenas visual. Seu fluxo antigo permanece intacto — não alteramos handlers legados.</div>
    </div>
  </div>

  <!-- Consulta Modal -->
  <div id="modal" class="modal" aria-modal="true" role="dialog">
    <div class="panel">
      <div class="hd">
        <div class="title" style="font-size:18px;margin:0">Consulta de documentos (ERP Ímpar)</div>
        <button id="btnClose" class="btn">Fechar</button>
      </div>
      <div class="bd">
        <div class="field" style="margin-bottom:10px">
          <input id="filtroCodigo" class="input" placeholder="Código (opcional)"/>
          <button id="btnBuscar" class="btn primary">Buscar</button>
        </div>
        <table>
          <thead>
            <tr><th>Data</th><th>Código</th><th>Contratante</th><th>Contratada</th><th>Serviço</th><th>Ação</th></tr>
          </thead>
          <tbody id="lista"><tr><td colspan="6" style="color:#9ca3af">Sem código, sem resultados.</td></tr></tbody>
        </table>
      </div>
      <div class="ft">
        <span class="hint">Dica: clique no código para escolher uma ação.</span>
      </div>
    </div>
  </div>

  <!-- Ação Modal -->
  <div id="actModal" class="modal" aria-modal="true" role="dialog">
    <div class="actbox">
      <div class="acthd">O que deseja fazer?</div>
      <div class="actbd">
        Documento: <b id="actCode">—</b>
        <div id="fallback" class="hint hide" style="margin-top:8px">Popup bloqueado. Abra manualmente: <a id="fallbackLink" class="link" href="#" target="_blank" rel="noreferrer">abrir</a></div>
      </div>
      <div class="actft">
        <button id="actCancel" class="btn">Cancelar</button>
        <button id="actUpdate" class="btn primary">Atualizar dados</button>
        <button id="actGerar" class="btn">Gerar contrato</button>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader" class="loader" role="alert" aria-live="assertive">
    <div class="loadpanel"><div class="spin"></div><div>Processando... aguarde...</div></div>
  </div>

  <script>
    // ===== Utils isolados =====
    const $ = (sel) => document.querySelector(sel);
    const el = (tag, attrs={}, html='') => {
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>n.setAttribute(k,v));
      if(html) n.innerHTML = html;
      return n;
    };
    const show = (id) => $(id).classList.add('open');
    const hide = (id) => $(id).classList.remove('open');

    // ===== Consulta =====
    $('#btnConsulta').onclick = () => show('#modal');
    $('#btnClose').onclick    = () => hide('#modal');

    // Busca usando seu endpoint existente json_table_cors.php
    async function fetchDocs(codigo){
      const qp = new URLSearchParams({op:'list', q:codigo||''});
      const url = '/api/gerador/json_table_cors.php?'+qp.toString();
      const r   = await fetch(url, {cache:'no-store'});
      if(!r.ok) throw new Error('Falha na consulta');
      return r.json();
    }

    async function doBuscar(){
      const code = $('#filtroCodigo').value.trim();
      $('#lista').innerHTML = '<tr><td colspan="6" style="color:#9ca3af">Buscando...</td></tr>';
      try{
        const data = await fetchDocs(code);
        const arr  = Array.isArray(data?.items) ? data.items : [];
        if(!arr.length){
          $('#lista').innerHTML = '<tr><td colspan="6" style="color:#9ca3af">Nenhum registro encontrado.</td></tr>';
          return;
        }
        const frag = document.createDocumentFragment();
        arr.forEach(row => {
          const tr = el('tr');
          const td = (t)=>{const d=el('td'); d.textContent=t; return d;};
          tr.append(td(row.data||'-'));
          const link = el('td',{}, `<a href="#" class="action" data-code="${row.codigo}">${row.codigo}</a>`);
          tr.append(link);
          tr.append(td(row.contratante||'-'));
          tr.append(td(row.contratada||'-'));
          tr.append(td(row.servico||'-'));
          const act = el('td',{}, `<a href="#" class="action" data-code="${row.codigo}">Selecionar</a>`);
          tr.append(act);
          frag.append(tr);
        });
        $('#lista').innerHTML='';
        $('#lista').append(frag);
      }catch(e){
        $('#lista').innerHTML = '<tr><td colspan="6" style="color:#ef4444">Erro ao carregar a lista.</td></tr>';
      }
    }
    $('#btnBuscar').onclick = doBuscar;

    // Abre modal de ação ao clicar no código/selecionar
    document.addEventListener('click', (ev) => {
      const a = ev.target.closest('a.action');
      if(!a) return;
      ev.preventDefault();
      const code = a.getAttribute('data-code');
      $('#actCode').textContent = code;
      $('#fallback').classList.add('hide');
      show('#actModal');
      hide('#modal');
    });
    $('#actCancel').onclick = () => { hide('#actModal'); };
    // Atualizar: preenche o código e ativa continuar (fluxo legado permanece)
    $('#actUpdate').onclick = () => {
      const code = $('#actCode').textContent;
      $('#codigo').value = code;
      hide('#actModal');
      try{
        // tenta clicar no continuar legado se existir
        (window.continuar||(()=>{}))();
      }catch(_){}
      // se você usa um "botão continuar" visual, simule um evento custom:
      document.dispatchEvent(new CustomEvent('legacy-ativar-continuar',{detail:{code}}));
    };

    // Gerar contrato: chama make_contract.php e tenta abrir a URL
    $('#actGerar').onclick = async () => {
      const code = $('#actCode').textContent;
      hide('#actModal');
      show('#loader');
      try{
        const r  = await fetch(`/api/gerador/make_contract.php?codigo=${encodeURIComponent(code)}`, {cache:'no-store'});
        const ct = (r.headers.get('content-type')||'').toLowerCase();
        if(!r.ok) throw new Error('Erro HTTP');
        if(ct.includes('application/json')){
          const j = await r.json();
          if(j?.ok && j?.url){
            const url = j.url.startsWith('http') ? j.url : (location.origin + j.url);
            const w = window.open(url,'_blank');
            if(!w){
              // fallback se popup bloqueado
              $('#fallbackLink').href = url;
              $('#fallback').classList.remove('hide');
              show('#actModal');
            }
          }else{
            alert(j?.msg || 'Falha ao gerar contrato.');
          }
        }else{
          // servidor devolveu o próprio PHP (debug); abre em aba p/ avaliar
          const blob = await r.blob();
          const u = URL.createObjectURL(blob);
          window.open(u,'_blank');
        }
      }catch(e){
        alert('Falha ao gerar contrato.');
      }finally{
        hide('#loader');
      }
    };

    // Botão continuar só preenche/aciona legacy; NÃO toca no código antigo
    $('#btnContinuar').onclick = () => {
      const v = $('#codigo').value.trim();
      if(!v){ alert('Informe o código.'); return; }
      // Dispara um evento que o legado pode escutar
      document.dispatchEvent(new CustomEvent('legacy-continuar',{detail:{code:v}}));
      alert('Código aplicado. Use o fluxo padrão para prosseguir.');
    };
  </script>
</body>
</html>
