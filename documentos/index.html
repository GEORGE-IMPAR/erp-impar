<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gerador de documentos</title>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
  :root{--bg:#f1f1f1;--card:#ffffff;--text:#1f2937;--border:#d1d5db;--capbg:#f3f4f6;
        --accent:#2ea3f2;--accentText:#fff;--disabled:#cbd5e1;--disabledText:#6b7280;--error:#ef4444}
  :root[data-theme="dark"]{--bg:#0b1220;--card:#0f172a;--text:#e5e7eb;--border:#1f2a40;--capbg:#0c1830;
        --accent:#3b82f6;--accentText:#fff;--disabled:#334155;--disabledText:#a3b1c6;--error:#f87171}
  *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 Arial,Helvetica,sans-serif}
  .wrap{width:100%;max-width:clamp(420px, 90vw, 860px);margin:0 auto;padding:10px 10px 18px}
  @media (min-width: 768px){ .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px} }
  .stepper{display:flex;align-items:center;gap:10px;justify-content:center;margin:10px 0 6px;flex-wrap:wrap}
  .dot{width:18px;height:18px;border-radius:50%;border:1px solid #c7c7c7;color:#4b5563;display:flex;align-items:center;justify-content:center;font-size:11px;background:#fff}
  .dot.done,.dot.active{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:700}
  .dot.active{box-shadow:0 0 0 2px rgba(46,163,242,.35)}
  .line{height:1px;flex:1;background:#c7c7c7;max-width:24px}
  .line.done{background:var(--accent)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:6px;overflow:hidden;box-shadow:0 1px 0 rgba(0,0,0,.04)}
  .header{padding:14px 14px 6px}
  .title{ /* ... */ color: var(--text); }   /* era #111827 */
  .user{font-size:13px;color:#4b5563;margin:0 0 8px}
  .code{  /* ... */ color: var(--text); }   /* era #374151 */
  .body{padding:12px 14px 16px}
  .block{border:1px solid var(--border);background:#fff;margin:0 0 12px;border-radius:4px;overflow:hidden}
  .block .cap{background:var(--capbg);color:#6b7280;font-size:12px;text-transform:uppercase;letter-spacing:.3px;padding:6px 8px;border-bottom:1px solid var(--border)}
  .block .cap .req{color:#dc2626}.block .content{padding:8px}
  .textarea,.input,select{width:100%;border:1px solid #e5e7eb;background:#fff;padding:8px;border-radius:4px;font:15px/1.45 Arial,Helvetica,sans-serif;color:#111827;outline:none;transition:border-color .15s,box-shadow .15s}
  .textarea{min-height:120px;resize:vertical}.textarea:focus,.input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(46,163,242,.25)}
  .file{font:14px Arial,Helvetica,sans-serif}.error{color:var(--error);font-size:12px;margin-top:6px}.hint{font-size:12px;color:#6b7280;margin-top:6px}
  .bar{position:sticky;bottom:0;left:0;right:0;text-align:center;padding:14px;font-weight:700;cursor:default;margin-top:10px;border-top:1px solid #e5e7eb}
  .bar.disabled{background:var(--disabled);color:var(--disabledText)}.bar.enabled{background:var(--accent);color:var(--accentText);cursor:pointer}
  .back{display:flex;align-items:center;gap:6px;justify-content:center;color:#111827;font-size:14px;margin-top:6px;cursor:pointer;user-select:none}.back .chev{color:#f59e0b}
  .hidden{display:none}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:60}
  .modal .box{width:100%;max-width:920px;background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);border:1px solid #e5e7eb;overflow:hidden;display:flex;flex-direction:column;max-height:90vh}
  .modal .box .hd{padding:16px;border-bottom:1px solid #e5e7eb;font-weight:700}
  .modal .box .bd{padding:16px;overflow:auto}
  .modal .box .ft{padding:12px 16px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;font-weight:700;cursor:pointer}
  .btn.primary{background:#2ea3f2;color:#fff;border-color:transparent}
  .viewer{position:fixed;inset:0;background:#111827cc;display:none;align-items:center;justify-content:center;z-index:65}
  .viewer .panel{width:96%;max-width:900px;background:#fff;border-radius:6px;overflow:hidden;display:flex;flex-direction:column}
  .viewer .panel .top{padding:10px;border-bottom:1px solid #e5e7eb;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  .viewer .panel iframe{width:100%;height:80vh;border:0}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#10b981;color:#fff;padding:12px 16px;border-radius:6px;font-weight:700;box-shadow:0 10px 20px rgba(0,0,0,.2);display:none;z-index:70}

  /* Consulta: tabela simples */
  .tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{border:1px solid #e5e7eb;padding:8px;font-size:14px}
  .tbl th{background:#f8fafc;text-transform:uppercase;font-size:12px;color:#64748b}
  .pdf-link{color:#2563eb;font-weight:700;cursor:pointer;text-decoration:none}
  .row-muted{color:#64748b;font-size:13px}

 /* === Busy overlay === */
  .busy{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(17,24,39,.55);z-index:95}
  .busy .panel{display:flex;align-items:center;gap:10px;background:#fff;color:#111827;
             padding:12px 16px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.25);
             font-weight:700}
  .spinner{width:18px;height:18px;border:3px solid #d1d5db;border-top-color:#3b82f6;
         border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  
.code-link{color:var(--accent);text-decoration:none;font-weight:700}.code-link:hover{text-decoration:underline}
</style>




<script>
// Normaliza código: tira espaços e não-alfanuméricos, upper-case
function normCodigo(v){
  return String(v||'').replace(/[^0-9A-Za-z]/g,'').toUpperCase();
}

(function(){
  if (typeof proceedFromStep1 !== 'function') return;
  const __orig_fetch = (typeof fetchConsulta === 'function') ? fetchConsulta : null;

  window.proceedFromStep1 = function() {
    const raw = (document.getElementById('codigo')?.value || '').trim();
    const codigo = normCodigo(raw);
    if (!codigo) return;
    try {
      if (typeof showBusy === 'function') showBusy('Buscando documento pelo código...');
      const p = __orig_fetch ? __orig_fetch(raw) : Promise.reject(new Error('fetchConsulta não disponível'));
      Promise.resolve(p).then(res => {
        const rows = (res && Array.isArray(res.rows)) ? res.rows : [];
        // Log de apoio no console
        try {
          console.log('[consulta] total rows:', rows.length);
          console.log('[consulta] codes retornados:', rows.map(r => r.codigo));
        } catch(e){}

        // Filtra por código normalizado
        const matches = rows.filter(r => normCodigo(r.codigo) === codigo);

        if (matches.length === 0) {
          /* código não encontrado: seguir para novo cadastro */ if (typeof goTo === 'function') goTo(2); return;
        }

        // Escolhe o mais recente quando houver mais de um
        function t(v){ if(!v) return 0; const d=new Date(v); return isNaN(d.getTime())?0:d.getTime(); }
        matches.sort((a,b)=> (t(b.updated_at||b.created_at||b.data) - t(a.updated_at||a.created_at||a.data)));
        const row = matches[0];

        const norm = (typeof normalizeRowForFill === 'function') ? normalizeRowForFill(row) : row;
        if (typeof fillAllFromRow === 'function') fillAllFromRow(norm);
        try {
          const mirrors = document.querySelectorAll('[id^="codigoVal"]');
          mirrors.forEach(el => { el.textContent = raw; });
        } catch(e) {}
        if (typeof goTo === 'function') goTo(2);
      }).catch(err => {
        (window.toast?.error || window.alert)('Falha ao buscar o documento.');
        console.error(err);
      }).finally(()=>{
        if (typeof hideBusy === 'function') hideBusy();
      });
    } catch(e){
      if (typeof hideBusy === 'function') hideBusy();
      (window.toast?.error || window.alert)('Falha ao buscar o documento.');
      console.error(e);
    }
  };
})();
</script>


<script>
// --------- DEDUPE GLOBAL AO ABRIR CONSULTA ---------
async function dedupeAllByCodigo() {
  const LIST_URL  = (window.__ERP_SAVE_PATCH__?.LIST_URL || '').trim();
  const SAVE_TOKEN= (window.__ERP_SAVE_PATCH__?.SAVE_TOKEN || '').trim();
  if (!LIST_URL || !SAVE_TOKEN) return {ok:false, skipped:true};

  const apiBase = LIST_URL.replace(/\/list\.php.*$/,'').replace(/\/+$/,'');
  const delUrl  = apiBase ? (apiBase + '/delete.php') : '';
  if (!delUrl) return {ok:false, skipped:true};

  // Busca todos os registros
  const form = new URLSearchParams();
  form.set('token', SAVE_TOKEN);
  // sem codigo => lista completa
  const res = await fetch(LIST_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: form });
  const j = await res.json().catch(()=>({rows:[]}));
  const rows = Array.isArray(j.rows) ? j.rows : [];
  // Agrupa por codigo (normalizado)
  const norm = v => String(v||'').replace(/[^0-9A-Za-z]/g,'').toUpperCase();
  const groups = new Map();
  for (const r of rows) {
    const c = norm(r.codigo);
    if (!c) continue;
    if (!groups.has(c)) groups[c] = [];
    (groups[c] || groups.set(c, [])).push(r);
  }
  // Para cada codigo com mais de 1, chama delete.php (keep=newest)
  let affected = 0;
  for (const [code, arr] of Object.entries(groups)) {
    if (!Array.isArray(arr) || arr.length <= 1) continue;
    affected++;
    const body = new URLSearchParams();
    body.set('token', SAVE_TOKEN);
    body.set('codigo', code);
    body.set('keep', 'newest');
    try {
      await fetch(delUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    } catch(e) {
      console.warn('dedupe codigo falhou', code, e);
    }
  }
  return {ok:true, affected};
}

// Envolve a abertura do modal de consulta (ou o clique do botão "Consulta") para rodar dedupe antes
(function(){
  // Tenta interceptar a função do botão de Consulta (se houver)
  const openers = [];
  // Caso exista uma função showConsultaModal() ou similar, você pode adaptar aqui.
  // Como fallback, ligamos no botão #btnConsulta (se existir) e no botão que abre o modal (#openConsulta, etc.).
  window.addEventListener('DOMContentLoaded', () => {
    const candidates = [
      document.getElementById('btnConsulta'),
      document.querySelector('[data-open="consulta"]'),
      document.getElementById('openConsulta'),
      document.querySelector('button.consulta'),
      document.querySelector('#consultaModalButton')
    ].filter(Boolean);

    candidates.forEach(btn => {
      const originalOnClick = btn.getAttribute('onclick');
      btn.setAttribute('onclick', '');
      btn.addEventListener('click', async (ev) => {
        try {
          if (typeof showBusy === 'function') showBusy('Eliminando duplicados...');
          await dedupeAllByCodigo();
        } catch(e) {
          console.warn('dedupeAllByCodigo erro', e);
        } finally {
          if (typeof hideBusy === 'function') hideBusy();
        }
        // Reexecuta o handler original, se havia
        if (originalOnClick) {
          try { new Function(originalOnClick).call(btn); } catch(e){ console.error(e); }
        }
      });
    });
  });
})();
</script>


<script>
// Dedupe antes do "Buscar" na Consulta (modal e inline)
window.addEventListener('DOMContentLoaded', () => {
  const hookButton = (btn) => {
    if (!btn) return;
    const original = btn.getAttribute('onclick');
    btn.setAttribute('onclick', '');
    btn.addEventListener('click', async (ev) => {
      try {
        if (typeof showBusy === 'function') showBusy('Eliminando duplicados...');
        // Tenta localizar o input de código relacionado a este botão
        let input = null;
        // Busca por ids conhecidos
        input = document.getElementById('consCodigo') || document.getElementById('consCodigoInline');
        // Se não achou, tenta subir DOM e achar input[type=text] mais próximo
        if (!input) {
          const container = btn.closest('form, .modal, .screen, body');
          if (container) {
            input = container.querySelector('input[type="text"], input[type="search"]');
          }
        }
        const raw = (input && input.value) ? String(input.value).trim() : '';
        if (raw) {
          // Dedupe somente daquele código (mantém o mais recente)
          await dedupeByCodigo(raw);
        } else {
          // Se nenhum código digitado, faz um dedupe global rápido
          if (typeof dedupeAllByCodigo === 'function') {
            await dedupeAllByCodigo();
          }
        }
      } catch (e) {
        console.warn('dedupe antes do buscar falhou', e);
      } finally {
        if (typeof hideBusy === 'function') hideBusy();
      }
      // Executa o handler original do botão
      if (original) {
        try { new Function(original).call(btn); } catch (e) { console.error(e); }
      }
    });
  };

  hookButton(document.getElementById('btnBuscar'));        // botão no modal
  hookButton(document.getElementById('btnBuscarInline'));  // botão inline na etapa 1
});
</script>


<script>
// ------- DEDUPE NO CLIENTE ANTES DE RENDERIZAR AS LINHAS -------
(function(){
  // normaliza código para agrupar variações (maiúsculas e sem símbolos)
  function normCodigo(v){ return String(v||'').replace(/[^0-9A-Za-z]/g,'').toUpperCase(); }
  function stamp(v){ if(!v) return 0; const d=new Date(v); return isNaN(d.getTime())?0:d.getTime(); }
  function pickNewest(arr){
    return [...arr].sort((a,b)=> (stamp(b.updated_at||b.created_at||b.data) - stamp(a.updated_at||a.created_at||a.data)))[0] || arr[0];
  }
  function dedupeRowsClient(rows){
    if (!Array.isArray(rows)) return [];
    const groups = new Map();
    for (const r of rows){
      const key = normCodigo(r.codigo);
      if (!key) continue;
      if (!groups.has(key)) groups.set(key, []);
      groups.get(key).push(r);
    }
    const out = [];
    for (const [key, arr] of groups.entries()){
      if (arr.length === 1){ out.push(arr[0]); continue; }
      out.push(pickNewest(arr));
    }
    // mantém ordem aproximada por data desc para visualização consistente
    out.sort((a,b)=> (stamp(b.updated_at||b.created_at||b.data) - stamp(a.updated_at||a.created_at||a.data)));
    return out;
  }

  // Envolve renderRows para aplicar dedupe automaticamente
  const __renderRows = window.renderRows;
  window.renderRows = function(tbodyId, rows){
    try {
      rows = dedupeRowsClient(rows);
    } catch(e){ console.warn('dedupeRowsClient erro', e); }
    return __renderRows ? __renderRows(tbodyId, rows) : null;
  };

  // Mensagem inline quando código não encontrado segue igual;
  // se quiser, poderia também dedupe no j.rows antes de checar length >0.
})();
</script>


<script>
// ===== Dedupe robusto (1 linha por CÓDIGO) =====
(function(){
  function normCodigo(v){ return String(v||'').replace(/[^0-9A-Za-z]/g,'').toUpperCase(); }
  function stamp(v){ if(!v) return 0; const d=new Date(v); return isNaN(d.getTime())?0:d.getTime(); }
  function pickNewest(arr){
    return [...arr].sort((a,b)=> (stamp(b.updated_at||b.created_at||b.data) - stamp(a.updated_at||a.created_at||a.data)))[0] || arr[0];
  }
  window.dedupeRowsClient = function(rows){
    if (!Array.isArray(rows)) return [];
    const out = [];
    const groups = new Map();
    for (const r of rows){
      const key = normCodigo(r && r.codigo);
      if (!key) {
        // Sem código: mantém na lista (não remove)
        out.push(r);
        continue;
      }
      if (!groups.has(key)) groups.set(key, []);
      groups.get(key).push(r);
    }
    for (const [key, arr] of groups.entries()){
      out.push(arr.length === 1 ? arr[0] : pickNewest(arr));
    }
    // Ordena por data desc apenas para apresentação
    out.sort((a,b)=> (stamp((b&&b.updated_at)||(b&&b.created_at)||(b&&b.data)) - stamp((a&&a.updated_at)||(a&&a.created_at)||(a&&a.data))));
    // Se por algum motivo zerar, garante fallback para os originais
    if (out.length === 0 && rows.length > 0) return rows;
    return out;
  };

  // Hooka o renderRows QUANDO ele existir (para não quebrar a página)
  (function hookRenderRowsSafely(attempt=0){
    const MAX_ATTEMPTS = 60; // ~6s
    if (typeof window.renderRows === 'function'){
      const __orig = window.renderRows;
      if (!__orig.__dedupe_hooked){
        window.renderRows = function(tbodyId, rows){
          try { rows = window.dedupeRowsClient(rows); } catch(e){ console.warn('dedupeRowsClient erro', e); }
          return __orig.call(this, tbodyId, rows);
        };
        window.renderRows.__dedupe_hooked = true;
      }
      return;
    }
    if (attempt < MAX_ATTEMPTS) {
      setTimeout(()=>hookRenderRowsSafely(attempt+1), 100);
    } else {
      console.warn('renderRows não encontrado para dedupe.');
    }
  })();
})();
</script>


<!-- === Mapa de campos (inline, sem dependências externas) === -->
<script type="application/json" id="mapa_campos">{
  "codigo": "#codigo",
  "servico": "#servico",
  "endereco": "#endereco",
  "nomeContratante": "#nomeContratante",
  "logradouroContratante": "#logradouroContratante",
  "docContratante": "#docContratante",
  "contatoContratante": "#contatoContratante",
  "nomeContratada": "#nomeContratada",
  "logradouroContratada": "#logradouroContratada",
  "docContratada": "#docContratada",
  "clausulas": "#clausulas",
  "prazo": "#prazo",
  "valor": "#valor",
  "valorExtenso": "#valorExtenso",
  "condicoes": "#condicoes",
  "dataExtenso": "#dataExtenso"
}</script>

<script>
function __pegarValor(sel){
  var el = document.querySelector(sel);
  if(!el) return '';
  if (typeof el.value !== 'undefined') return (el.value || '').trim();
  return (el.textContent || '').trim();
}
function __lerMapa(){
  var tag = document.getElementById('mapa_campos');
  if(!tag) { throw new Error('Mapa de campos não encontrado'); }
  return JSON.parse(tag.textContent);
}
function gerarContratoViaMapa(){
  try {
    if (typeof showBusy === 'function') showBusy('Processando…');
    var mapa = __lerMapa();
    var payload = {};
    for (var key in mapa){
      if (!Object.prototype.hasOwnProperty.call(mapa, key)) continue;
      payload[key] = __pegarValor(mapa[key]);
    }
    if(!payload.codigo){ payload.codigo = 'DOC'; }
    if(!payload.servico){
      alert('Preencha o campo Serviço antes de gerar o contrato.');
      return;
    }
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '/api/gerador/gerar_docx.php', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.responseType = 'blob';
    xhr.onload = function(){
      try {
        if (xhr.status !== 200){ alert('Falha ao gerar contrato (.docx)'); return; }
        var blob = xhr.response;
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'Contrato-' + (payload.codigo || 'documento') + '.docx';
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(function(){ window.URL.revokeObjectURL(url); }, 1500);
        if (typeof showToast === 'function') showToast('✅ Contrato gerado com sucesso!');
      } finally {
        if (typeof hideBusy === 'function') hideBusy();
      }
    };
    xhr.onerror = function(){
      if (typeof hideBusy === 'function') hideBusy();
      alert('Erro de rede ao gerar contrato.');
    };
    xhr.send(JSON.stringify(payload));
  } catch (e){
    if (typeof hideBusy === 'function') hideBusy();
    console.error(e);
    alert('Erro ao gerar contrato. Verifique os dados.');
  }
}
document.addEventListener('DOMContentLoaded', function(){
  var b = document.getElementById('btnGerarDocx');
  if (b){ b.onclick = gerarContratoViaMapa; }
});
</script>
<!-- === /Mapa de campos === -->

<div id="versionador" style="position:fixed;right:12px;bottom:10px;background:#0b3a6f;color:#fff;font:12px Arial;padding:6px 10px;border-radius:6px;opacity:.90;z-index:9999;">Versão 1.7 – Atualizado em 15/10/2025</div>

<script>
// Wrapper seguro para o botão de avançar da Etapa 1 (sem sintaxe problemática)
(function(){
  var __orig_proceedFromStep1 = (typeof window.proceedFromStep1 === 'function')
    ? window.proceedFromStep1
    : null;

  window.proceedFromStep1_Dedupe = function(){
    try {
      if (typeof __orig_proceedFromStep1 === 'function') {
        return __orig_proceedFromStep1();
      }
    } catch(e){
      try { console.warn('Erro no dedupe:', e); } catch(_){}
    } finally {
      if (typeof window.hideBusy === 'function') window.hideBusy();
    }
    return undefined;
  };

  // Redireciona o clique do botão (sem mexer no HTML original)
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('bar1');
    if (btn) btn.setAttribute('onclick', 'proceedFromStep1_Dedupe()');
  });
})();
</script>

</body>
</html>