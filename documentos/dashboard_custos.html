<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>ERP √çMPAR ¬∑ Dashboards Integrados</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Plotly + XLSX -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --impar-azul-escuro: #050a30;
      --impar-azul: #1d4ed8;
      --impar-azul-claro: #60a5fa;
      --impar-laranja: #f97316;
      --impar-cinza-claro: #e5e7eb;
      --impar-cinza: #9ca3af;
      --impar-fundo: #f3f4f6;
      --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.25);
      --radius-card: 18px;
      --transition-fast: 0.2s ease-out;
      --btn-grad-start:#2563eb;
      --btn-grad-end:#22c55e;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Candara", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #111827 0, #020617 40%, #020617 100%);
      color: #f9fafb;
      min-height: 100vh;
    }

    body::-webkit-scrollbar {
      width: 8px;
    }
    body::-webkit-scrollbar-track {
      background: #020617;
    }
    body::-webkit-scrollbar-thumb {
      background: #1f2937;
      border-radius: 999px;
    }

    /* HEADER GERAL */
    .app-header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(120deg, rgba(5,10,48,0.98), rgba(15,23,42,0.98));
      border-bottom: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 10px 25px rgba(15,23,42,0.75);
      padding: 12px 16px 10px;
    }

    .app-header-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .app-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-badge {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: conic-gradient(from 180deg, #f97316, #0ea5e9, #22c55e, #f97316);
      box-shadow: 0 0 18px rgba(249,115,22,0.95);
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-text h1 {
      font-size: 18px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .logo-text span {
      font-size: 11px;
      color: #cbd5f5;
    }

    /* BOT√ïES √çMPAR (DEGRAD√ä) */
    .btn-pill {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: rgba(15,23,42,0.95);
      padding: 6px 14px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform .15s ease, box-shadow .15s ease,
                  background .15s ease, border-color .15s ease, color .15s ease;
    }
    .btn-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(15,23,42,0.8);
    }
    .btn-pill-primary {
      background: linear-gradient(135deg,var(--btn-grad-start),var(--btn-grad-end));
      border-color: #16a34a;
      color:#fff;
      box-shadow:0 10px 24px rgba(0,0,0,.7);
    }

    .view-switch {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items:center;
    }

    .view-switch button {
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 6px 14px;
      font-size: 11px;
      cursor: pointer;
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      text-transform: uppercase;
      letter-spacing: .12em;
      transition: background var(--transition-fast), color var(--transition-fast),
                  border-color var(--transition-fast), box-shadow var(--transition-fast), transform .15s ease;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .view-switch button.ativo {
      background: linear-gradient(135deg,var(--btn-grad-start),var(--btn-grad-end));
      color: #fff;
      border-color: #16a34a;
      box-shadow: 0 10px 24px rgba(0,0,0,.7);
      transform: translateY(-1px);
    }

    .view-menu-btn {
      border-radius:999px;
      border:1px solid #4b5563;
      background:#020617;
      padding:5px 12px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:#e5e7eb;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .view-menu-btn span.icn{font-size:13px;}
    .view-menu-btn:hover{
      background:rgba(15,23,42,.9);
      border-color:#6b7280;
    }

    /* LAYOUT GERAL DAS VIEWS */
    .view-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 14px 16px 24px;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 10px;
    }

    .kpi-card {
      background: radial-gradient(circle at top left, rgba(96,165,250,0.22), rgba(15,23,42,1));
      border-radius: var(--radius-card);
      padding: 14px 16px;
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .kpi-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(249,115,22,0.18), transparent 60%);
      opacity: 1;
      pointer-events: none;
    }

    .kpi-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #cbd5f5;
      position: relative;
      z-index: 1;
    }

    .kpi-value {
      font-size: 24px;
      font-weight: 700;
      margin-top: 4px;
      color: #f9fafb;
      position: relative;
      z-index: 1;
    }

    .kpi-sub {
      font-size: 11px;
      color: #e5e7eb;
      margin-top: 4px;
      position: relative;
      z-index: 1;
    }

    .section-row,
    .layout-2col,
    .layout-3col,
    .layout-1col {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 14px;
      margin-top: 16px;
    }

    @media (min-width: 900px) {
      .section-row {
        grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.3fr);
      }
      .layout-2col {
        grid-template-columns: minmax(0, 2fr) minmax(0, 1.5fr);
      }
      .layout-3col {
        grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.3fr) minmax(0, 1.4fr);
      }
    }

    .panel {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.85), rgba(2,6,23,0.98));
      border-radius: var(--radius-card);
      padding: 10px 10px 14px;
      border: 1px solid rgba(148,163,184,0.55);
      box-shadow: var(--shadow-soft);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 6px;
    }

    .panel-header h2 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #e5e7eb;
    }

    .panel-header span {
      font-size: 11px;
      color: #9ca3af;
    }

    .chart-container {
      width: 100%;
      height: 320px;
    }
    .chart-container.small {
      height: 260px;
    }

    .table-wrapper {
      max-height: 320px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.55);
      margin-top: 4px;
    }

    .table-wrapper table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      background: #020617;
      color: #e5e7eb;
    }

    .table-wrapper thead {
      position: sticky;
      top: 0;
      background: #111827;
      z-index: 1;
    }

    .table-wrapper th,
    .table-wrapper td {
      padding: 6px 8px;
      border-bottom: 1px solid #1f2937;
      white-space: nowrap;
    }

    .table-wrapper th {
      text-align: left;
      font-weight: 600;
      color: #e5e7eb;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .table-wrapper tr:nth-child(even) td {
      background: #020617;
    }

    .table-wrapper tr:hover td {
      background: #111827;
    }

    .view-title {
      font-size: 15px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #e5e7eb;
      margin-bottom: 4px;
    }

    .view-subtitle {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    /* GRUPOS DE FILTRO GEN√âRICOS */
    .filters-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-start;
      gap: 8px;
      margin-top: 6px;
      margin-bottom: 8px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .filter-group label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #cbd5f5;
    }

    .filter-group select,
    .filter-group input {
      background: #f9fafb;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      padding: 5px 12px;
      font-size: 12px;
      min-width: 150px;
      outline: none;
      color: #111827;
    }

    .filter-group select:focus,
    .filter-group input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37,99,235,0.35);
    }

    .import-info {
      font-size: 11px;
      color: #e5e7eb;
      margin-bottom: 6px;
    }

    .import-info strong {
      color: #bfdbfe;
    }

    .import-status {
      margin-top: 4px;
      color: #bbf7d0;
      font-size: 11px;
    }

    /* INPUT FILE BONITO */
    .file-input-wrapper {
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px;
      margin-top:4px;
      margin-bottom:2px;
    }
    .file-input-wrapper input[type="file"] {
      display:none;
    }
    .btn-file {
      border-radius:999px;
      border:1px solid #4b5563;
      background:linear-gradient(135deg,var(--btn-grad-start),var(--btn-grad-end));
      padding:5px 14px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 10px 24px rgba(0,0,0,.7);
    }
    .file-name {
      font-size:11px;
      color:#e5e7eb;
      min-height:14px;
    }

    /* MULTI OBRAS ‚Äì BUSCA + LISTA + TAGS */
    .filter-group.filter-obras-advanced {
      min-width: 260px;
      flex: 1 1 260px;
    }

    .obra-search-box input {
      width: 100%;
      background: #f9fafb;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      padding: 5px 12px;
      font-size: 12px;
      outline: none;
      color: #111827;
    }

    .obra-search-box input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37,99,235,0.35);
    }

    .obra-list {
      margin-top: 4px;
      max-height: 180px;
      overflow-y: auto;
      padding: 4px;
      border-radius: 12px;
      background: rgba(15,23,42,0.6);
      border: 1px solid rgba(148,163,184,0.6);
    }

    .obra-list::-webkit-scrollbar {
      width: 6px;
    }
    .obra-list::-webkit-scrollbar-track {
      background: transparent;
    }
    .obra-list::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.9);
      border-radius: 999px;
    }

    .obra-item {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      margin-bottom: 3px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #e5e7eb;
      background: transparent;
      transition: background 0.15s ease, color 0.15s ease, transform 0.12s ease;
    }

    .obra-item:hover {
      background: rgba(37,99,235,0.35);
      transform: translateY(-1px);
    }

    .obra-item.selected {
      background: rgba(37,99,235,0.9);
      color: #ffffff;
      font-weight: 600;
    }

    .obra-item.empty {
      opacity: 0.7;
      cursor: default;
      text-align: center;
    }

    .selected-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
      max-width: 600px;
    }

    .badge-pill {
      background: rgba(37,99,235,0.1);
      color: #e5e7eb;
      border-radius: 999px;
      padding: 2px 9px;
      font-size: 11px;
      border: 1px solid rgba(191,219,254,0.7);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge-pill button {
      border: none;
      background: transparent;
      color: #bfdbfe;
      cursor: pointer;
      font-size: 11px;
    }

    .badge-clear-all {
      border: 1px dashed rgba(191,219,254,0.85);
      background: transparent;
      color: #e5e7eb;
      border-radius: 999px;
      padding: 2px 9px;
      font-size: 10px;
      cursor: pointer;
    }

    /* CUSTOS INDIRETOS E OBRAS ‚Äì HEADER DE FILTROS RECOLH√çVEL */
    .ci-filter-header {
      background: linear-gradient(120deg, #0f172a, #1d4ed8);
      border-radius: 18px;
      border: 1px solid #60a5fa;
      padding: 10px 12px;
      margin-bottom: 10px;
      box-shadow: 0 12px 28px rgba(15,23,42,0.4);
    }

    .ci-header-top {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      color: #f9fafb;
    }

    .ci-header-title {
      display: flex;
      flex-direction: column;
    }

    .ci-header-title h2 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .ci-header-title span {
      font-size: 11px;
      color: #d1fae5;
    }

    .filter-toggle {
      display: inline-flex;
      font-size: 11px;
      color: #e5e7eb;
      cursor: pointer;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.5);
      align-items: center;
      gap: 6px;
      user-select: none;
      white-space: nowrap;
    }

    .filter-toggle span.icon {
      font-size: 12px;
    }

    .filters-wrapper {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 500px;
      opacity: 1;
      overflow: hidden;
      transition: all 0.25s ease;
      margin-top: 6px;
    }

    .filters-wrapper.collapsed {
      max-height: 0;
      opacity: 0;
      transform: translateY(-4px);
    }

    .filters-ci {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-start;
      justify-content: flex-start;
    }

    .filters-ci label {
      font-size: 11px;
      color: #e5e7eb;
      margin-right: 4px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .filters-ci select,
    .filters-ci input {
      background: #f9fafb;
      border: 1px solid #cbd5f5;
      border-radius: 999px;
      padding: 6px 12px;
      color: #111827;
      font-size: 12px;
      outline: none;
      min-width: 140px;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.05);
    }

    .filters-ci select:focus,
    .filters-ci input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37,99,235,0.35);
    }

    .ci-import-area {
      font-size: 11px;
      color: #e5e7eb;
    }

    .ci-import-status {
      font-size: 11px;
      margin-top: 2px;
      color: #bbf7d0;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      background: rgba(239,246,255,0.9);
      font-size: 10px;
      color: #1f2937;
    }
    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #f97316;
    }

    /* FOOTER */
    .app-footer {
      max-width: 1400px;
      margin: 4px auto 14px;
      padding: 0 16px;
      font-size: 10px;
      color: #9ca3af;
      text-align: right;
    }

    /* RESPONSIVIDADE MOBILE */
    @media (max-width: 768px) {
      .app-header-inner {
        flex-direction: column;
        align-items: flex-start;
      }
      .logo-text h1 {
        font-size: 14px;
      }
      .chart-container {
        height: 260px;
      }
      .chart-container.small {
        height: 220px;
      }
      .kpi-card {
        padding: 10px 12px;
      }
      .panel {
        padding: 8px 8px 12px;
      }
    }
  </style>
</head>
<body>
<header class="app-header">
  <div class="app-header-inner">
    <div class="app-logo">
      <div class="logo-badge"></div>
      <div class="logo-text">
        <h1>ERP √çMPAR ¬∑ Dashboard de Custos</h1>
        <span>Dashboard de custos de m√£o de obra e despesas vari√°veis</span>
      </div>
    </div>

    <div class="view-switch">
      <button data-view="obras" class="ativo">Dashboard Obras</button>
      <button data-view="custos">Custos Indiretos</button>

      <button
        type="button"
        class="view-menu-btn"
        onclick="window.location.href='../index.html'">
        <span class="icn">üè†</span>
        Menu principal
      </button>
    </div>
  </div>
</header>

<!-- VIEW OBRAS -->
<div id="view-obras" class="view-container">
  <div class="view-title">Dashboard de Produtividade por Obra</div>
  <div class="view-subtitle">
    Custos, efici√™ncia e aloca√ß√£o por obra, colaborador e cargo.
    Importe a base <strong>BASE-DASH.xlsx</strong> para iniciar.
  </div>

  <!-- BLOCO AZUL RECOLH√çVEL -->
  <div class="ci-filter-header">
    <div class="ci-header-top">
      <div class="ci-header-title">
        <h2>Filtros e Importa√ß√£o</h2>
        <span>Escolha o per√≠odo, obras, cargos e colaboradores para analisar os custos de m√£o de obra.</span>
      </div>
      <div class="filter-toggle" id="ob-filter-toggle">
        <span class="icon">‚¨Ü</span>
        <span>Ocultar filtros</span>
      </div>
    </div>

    <div class="filters-wrapper" id="ob-filters-wrapper">
      <div class="ci-import-area">
        <div><strong>Base:</strong> use a planilha BASE-DASH.xlsx (DATA, NOME, CARGO, OBRA, VALOR-DIA, EFICI√äNCIA, Horas-di√°rias).</div>
        <label>Importar base (.xlsx):</label>
        <div class="file-input-wrapper">
          <input type="file" id="file-obras" accept=".xlsx,.xls" />
          <label for="file-obras" class="btn-file">Escolher arquivo</label>
          <span id="file-obras-nome" class="file-name">Nenhum arquivo escolhido</span>
        </div>
        <div id="import-status-obras" class="ci-import-status">Nenhuma base carregada.</div>
      </div>

      <div class="filters-ci">
        <!-- NOVO: OBRAS COM BUSCA + LISTA + TAGS -->
        <div class="filter-group filter-obras-advanced">
          <label for="obra-search">Obras</label>
          <div class="obra-search-box">
            <input type="text" id="obra-search" placeholder="Digite para filtrar obras..." />
          </div>
          <div class="obra-list" id="obra-list">
            <!-- itens renderizados via JS -->
          </div>
          <div class="selected-badges" id="obras-badges"></div>
        </div>

        <div class="filter-group">
          <label for="cargo-select">Cargo</label>
          <select id="cargo-select">
            <option value="Todos">Todos</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="colaborador-select">Colaborador</label>
          <select id="colaborador-select">
            <option value="Todos">Todos</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="data-inicio">De</label>
          <input type="date" id="data-inicio" />
        </div>

        <div class="filter-group">
          <label for="data-fim">At√©</label>
          <input type="date" id="data-fim" />
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <section class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-label">Custo total (filtro atual)</div>
      <div class="kpi-value" id="kpi-custo-total">R$ 0,00</div>
      <div class="kpi-sub">Somat√≥rio de VALOR-DIA</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Custo m√©dio por colaborador</div>
      <div class="kpi-value" id="kpi-custo-medio">R$ 0,00</div>
      <div class="kpi-sub">Custo total dividido por n¬∫ de colaboradores √∫nicos</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">% efici√™ncia m√©dia</div>
      <div class="kpi-value" id="kpi-eficiencia-media">0%</div>
      <div class="kpi-sub">EFICI√äNCIA / Horas-di√°rias</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Obras ativas</div>
      <div class="kpi-value" id="kpi-obras-ativas">0</div>
      <div class="kpi-sub">Quantidade distinta de obras no filtro</div>
    </div>
  </section>

  <!-- GR√ÅFICOS PRINCIPAIS -->
  <section class="section-row">
    <div class="panel">
      <div class="panel-header">
        <h2>Custo por obra</h2>
        <span>Barra horizontal ¬∑ R$</span>
      </div>
      <div id="chart-custo-obra" class="chart-container"></div>
    </div>
    <div class="panel">
      <div class="panel-header">
        <h2>Custo por cargo</h2>
        <span>Compara√ß√£o de fun√ß√µes</span>
      </div>
      <div id="chart-custo-cargo" class="chart-container"></div>
    </div>
  </section>

  <!-- FUNIS TOP 10 -->
  <section class="section-row">
    <div class="panel">
      <div class="panel-header">
        <h2>Funil ¬∑ Top 10 obras por custo</h2>
        <span>Da obra mais cara para a menos cara</span>
      </div>
      <div id="chart-funil-obra" class="chart-container small"></div>
    </div>
    <div class="panel">
      <div class="panel-header">
        <h2>Funil ¬∑ Top 10 colaboradores por custo</h2>
        <span>Da maior despesa para a menor</span>
      </div>
      <div id="chart-funil-colaborador" class="chart-container small"></div>
    </div>
  </section>

  <section class="section-row">
    <div class="panel">
      <div class="panel-header">
        <h2>% efici√™ncia por colaborador</h2>
        <span>Top 15</span>
      </div>
      <div id="chart-eficiencia-colaborador" class="chart-container small"></div>
    </div>
    <div class="panel">
      <div class="panel-header">
        <h2>Custo por colaborador</h2>
        <span>Top 15</span>
      </div>
      <div id="chart-custo-colaborador" class="chart-container small"></div>
    </div>
  </section>

  <section class="section-row">
    <div class="panel">
      <div class="panel-header">
        <h2>Distribui√ß√£o de cargos</h2>
        <span>Pizza ¬∑ participa√ß√£o no custo</span>
      </div>
      <div id="chart-pizza-cargo" class="chart-container small"></div>
    </div>
    <div class="panel">
      <div class="panel-header">
        <h2>Evolu√ß√£o do custo no tempo</h2>
        <span>S√©rie temporal por data</span>
      </div>
      <div id="chart-custo-tempo" class="chart-container"></div>
    </div>
  </section>

  <section class="section-row">
    <div class="panel">
      <div class="panel-header">
        <h2>Detalhamento de lan√ßamentos</h2>
        <span>Base consolidada da planilha</span>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Obra</th>
              <th>Cargo</th>
              <th>Colaborador</th>
              <th>Horas Di√°rias</th>
              <th>Efici√™ncia</th>
              <th>% Efici√™ncia</th>
              <th>Valor/Dia (R$)</th>
            </tr>
          </thead>
          <tbody id="tabela-detalhada"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<!-- VIEW CUSTOS INDIRETOS -->
<div id="view-custos" class="view-container" style="display:none;">
  <div class="view-title">Dashboard de Custos Indiretos</div>
  <div class="view-subtitle">
    Compara√ß√£o entre <strong>Modelo ANTIGO x NOVO</strong> em HE, di√°rias, hotel e combust√≠vel.
    Importe a base <strong>BASE-DASH-CUSTOS-INDIRETOS.xlsx</strong>.
  </div>

  <div class="ci-filter-header">
    <div class="ci-header-top">
      <div class="ci-header-title">
        <h2>Filtros e Importa√ß√£o</h2>
        <span>Escolha o per√≠odo, modelo e colaboradores para comparar custos.</span>
      </div>
      <div class="filter-toggle" id="ci-filter-toggle">
        <span class="icon">‚¨Ü</span>
        <span>Ocultar filtros</span>
      </div>
    </div>
    <div class="filters-wrapper" id="ci-filters-wrapper">
      <div class="ci-import-area">
        <div><strong>Base:</strong> use a planilha BASE-DASH-CUSTOS-INDIRETOS.xlsx com colunas M√™s, Modelo, Classifica√ß√£o, Colaborador, Despesa (R$).</div>
        <label>Importar base de custos indiretos (.xlsx):</label>
        <div class="file-input-wrapper">
          <input type="file" id="file-ci" accept=".xlsx,.xls" />
          <label for="file-ci" class="btn-file">Escolher arquivo</label>
          <span id="file-ci-nome" class="file-name">Nenhum arquivo escolhido</span>
        </div>
        <div id="ci-import-status" class="ci-import-status">Nenhuma base carregada.</div>
      </div>
      <div class="filters-ci">
        <div>
          <label for="ci-class">Classifica√ß√£o</label><br>
          <select id="ci-class">
            <option value="__ALL__">Todas</option>
          </select>
        </div>
        <div>
          <label for="ci-nome">Colaborador</label><br>
          <select id="ci-nome">
            <option value="__ALL__">Todos</option>
          </select>
        </div>
        <div>
          <label for="ci-modelo">Modelo</label><br>
          <select id="ci-modelo">
            <option value="__ALL__">Antigo + Novo</option>
            <option value="ANTIGO">ANTIGO</option>
            <option value="NOVO">NOVO</option>
          </select>
        </div>
        <div>
          <label for="ci-mes-inicio">De</label><br>
          <input type="month" id="ci-mes-inicio" />
        </div>
        <div>
          <label for="ci-mes-fim">At√©</label><br>
          <input type="month" id="ci-mes-fim" />
        </div>
      </div>
    </div>
  </div>

  <section class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-label">Despesas totais</div>
      <div class="kpi-value" id="ci-kpi-despesa">R$ 0,00</div>
      <div class="kpi-sub">Somat√≥rio de todas as despesas filtradas</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Despesas modelo ANTIGO</div>
      <div class="kpi-value" id="ci-kpi-antigo">R$ 0,00</div>
      <div class="kpi-sub">Somat√≥rio no modelo ANTIGO</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Despesas modelo NOVO</div>
      <div class="kpi-value" id="ci-kpi-novo">R$ 0,00</div>
      <div class="kpi-sub">Somat√≥rio no modelo NOVO</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Diferen√ßa NOVO - ANTIGO</div>
      <div class="kpi-value" id="ci-kpi-diff">R$ 0,00</div>
      <div class="kpi-sub">Negativo: NOVO mais barato ¬∑ Positivo: NOVO mais caro</div>
    </div>
  </section>

  <section class="layout-2col">
    <div class="panel">
      <div class="panel-header">
        <h2>Despesas por classifica√ß√£o ¬∑ ANTIGO x NOVO</h2>
        <span class="tag"><span class="tag-dot"></span> Compara√ß√£o direta de modelo</span>
      </div>
      <div id="chart-ci-class-model" class="chart-container"></div>
    </div>
    <div class="panel">
      <div class="panel-header">
        <h2>Despesas mensais por modelo (barras + tend√™ncia)</h2>
        <span class="tag"><span class="tag-dot"></span> Mostra se o NOVO reduz custos ao longo do tempo</span>
      </div>
      <div id="chart-ci-mensal-modelo" class="chart-container small"></div>
    </div>
  </section>

  <section class="layout-3col">
    <div class="panel">
      <div class="panel-header">
        <h2>Distribui√ß√£o de despesas por classifica√ß√£o</h2>
        <span class="tag"><span class="tag-dot"></span> Pizza ¬∑ participa√ß√£o por classifica√ß√£o</span>
      </div>
      <div id="chart-ci-pizza-class" class="chart-container small"></div>
    </div>
    <div class="panel">
      <div class="panel-header">
        <h2>Top 10 colaboradores por despesa</h2>
        <span class="tag"><span class="tag-dot"></span> Ordenado da maior para a menor</span>
      </div>
      <div id="chart-ci-top-colab" class="chart-container small"></div>
    </div>
    <div class="panel">
      <div class="panel-header">
        <h2>Despesas totais por modelo</h2>
        <span class="tag"><span class="tag-dot"></span> Somat√≥rio geral por modelo</span>
      </div>
      <div id="chart-ci-modelo-total" class="chart-container small"></div>
    </div>
  </section>

  <section class="layout-1col">
    <div class="panel">
      <div class="panel-header">
        <h2>Detalhamento de lan√ßamentos</h2>
        <span id="ci-table-subtitle">Nenhuma base carregada.</span>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>M√™s</th>
              <th>Modelo</th>
              <th>Classifica√ß√£o</th>
              <th>Colaborador</th>
              <th>Despesa (R$)</th>
            </tr>
          </thead>
          <tbody id="ci-table-body"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<div class="app-footer">
  ERP √çMPAR ¬∑ Dashboards Unificados (Obras + Custos Indiretos) ¬∑ v10-unificado-mobile-funil
</div>

<script>
  // ---------- FUN√á√ïES AUXILIARES ----------
  function formatCurrencyBR(v) {
    if (!v || !isFinite(v)) v = 0;
    return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  function parseExcelDateToISO(value) {
    if (!value) return null;
    if (value instanceof Date) {
      return value.toISOString().slice(0, 10);
    }
    if (typeof value === "number") {
      const epoch = new Date(Date.UTC(1899, 11, 30));
      const ms = value * 86400000;
      const d = new Date(epoch.getTime() + ms);
      return d.toISOString().slice(0, 10);
    }
    if (typeof value === "string") {
      const s = value.trim().replace(" ", "T");
      const d = new Date(s);
      if (!isNaN(d)) return d.toISOString().slice(0, 10);
    }
    return null;
  }

  function parseMonthToYYYYMM(value) {
    if (!value) return null;
    if (value instanceof Date) return value.toISOString().slice(0, 7);
    if (typeof value === "number") {
      const epoch = new Date(Date.UTC(1899,11,30));
      const ms = value * 86400000;
      const d = new Date(epoch.getTime() + ms);
      return d.toISOString().slice(0,7);
    }
    if (typeof value === "string") {
      const s = value.trim();
      if (/^\d{4}-\d{2}$/.test(s)) return s;
      const d = new Date(s);
      if (!isNaN(d)) return d.toISOString().slice(0,7);
    }
    return null;
  }

  function parseBrazilNumber(str) {
    if (str == null) return 0;
    if (typeof str === "number") return str;
    const s = String(str).trim().replace(/\./g, "").replace(",", ".");
    const n = Number(s);
    return isNaN(n) ? 0 : n;
  }

  function parseTimeToHours(hhmmss) {
    if (!hhmmss) return 0;
    const parts = String(hhmmss).split(":").map(Number);
    const h = parts[0] || 0;
    const m = parts[1] || 0;
    const s = parts[2] || 0;
    return h + m/60 + s/3600;
  }

  function monthCompare(a, b) {
    if (!a && !b) return 0;
    if (!a) return -1;
    if (!b) return 1;
    return a < b ? -1 : (a > b ? 1 : 0);
  }

  function computeTrendLine(yValues) {
    const n = yValues.length;
    let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0, count = 0;
    for (let i = 0; i < n; i++) {
      const y = yValues[i];
      if (!isFinite(y)) continue;
      const x = i + 1;
      sumX += x;
      sumY += y;
      sumXY += x * y;
      sumXX += x * x;
      count++;
    }
    if (count < 2) return null;
    const slope = (count*sumXY - sumX*sumY) / (count*sumXX - sumX*sumX);
    const intercept = (sumY - slope*sumX) / count;
    return yValues.map((_, i) => intercept + slope*(i+1));
  }

  // ---------- SWITCH ENTRE VIEWS ----------
  document.addEventListener("DOMContentLoaded", () => {
    const buttons = document.querySelectorAll(".view-switch button[data-view]");
    const viewObras = document.getElementById("view-obras");
    const viewCustos = document.getElementById("view-custos");

    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        const view = btn.getAttribute("data-view");
        if (view === "obras") {
          viewObras.style.display = "block";
          viewCustos.style.display = "none";
        } else {
          viewObras.style.display = "none";
          viewCustos.style.display = "block";
        }
        buttons.forEach(b => b.classList.remove("ativo"));
        btn.classList.add("ativo");
        if (view === "obras") {
          refreshDashboardObras();
        } else {
          refreshCIDashboard();
        }
      });
    });
  });

  // =====================================
  // DASHBOARD OBRAS
  // =====================================
  let obrasData = [];
  let selectedObras = new Set();
  let todasObras = [];

  function renderObraList() {
    const listEl   = document.getElementById("obra-list");
    const searchEl = document.getElementById("obra-search");
    if (!listEl || !searchEl) return;

    const term = (searchEl.value || "").toLowerCase();
    listEl.innerHTML = "";

    const filtered = todasObras.filter(o =>
      !term || o.toLowerCase().includes(term)
    );

    if (filtered.length === 0) {
      const empty = document.createElement("div");
      empty.className = "obra-item empty";
      empty.textContent = "Nenhuma obra encontrada";
      listEl.appendChild(empty);
      updateObrasBadges();
      return;
    }

    filtered.forEach(obra => {
      const item = document.createElement("div");
      item.className = "obra-item" + (selectedObras.has(obra) ? " selected" : "");
      item.textContent = obra;
      item.title = obra;
      item.addEventListener("click", () => {
        if (selectedObras.has(obra)) {
          selectedObras.delete(obra);
        } else {
          selectedObras.add(obra);
        }
        renderObraList();
        updateObrasBadges();
        refreshDashboardObras();
      });
      listEl.appendChild(item);
    });

    updateObrasBadges();
  }

  function updateObrasBadges() {
    const badgesEl = document.getElementById("obras-badges");
    if (!badgesEl) return;

    badgesEl.innerHTML = "";

    if (selectedObras.size === 0) {
      const pill = document.createElement("div");
      pill.className = "badge-pill";
      pill.textContent = "Todas as obras";
      badgesEl.appendChild(pill);
      return;
    }

    Array.from(selectedObras).forEach(obra => {
      const pill = document.createElement("div");
      pill.className = "badge-pill";
      pill.innerHTML = `
        <span>${obra}</span>
        <button type="button" aria-label="Remover obra">&times;</button>
      `;
      pill.querySelector("button").addEventListener("click", () => {
        selectedObras.delete(obra);
        renderObraList();
        refreshDashboardObras();
      });
      badgesEl.appendChild(pill);
    });

    const clearBtn = document.createElement("button");
    clearBtn.type = "button";
    clearBtn.className = "badge-clear-all";
    clearBtn.textContent = "Limpar sele√ß√£o";
    clearBtn.addEventListener("click", () => {
      selectedObras.clear();
      renderObraList();
      refreshDashboardObras();
    });
    badgesEl.appendChild(clearBtn);
  }

  function buildFiltersFromDataObras(data) {
    const cargoSet = new Set();
    const nomeSet = new Set();
    const obraSet = new Set();
    let minData = null;
    let maxData = null;

    data.forEach(d => {
      if (d.CARGO) cargoSet.add(d.CARGO);
      if (d.NOME) nomeSet.add(d.NOME);
      if (d.OBRA) obraSet.add(d.OBRA);
      if (d.DATA) {
        if (!minData || d.DATA < minData) minData = d.DATA;
        if (!maxData || d.DATA > maxData) maxData = d.DATA;
      }
    });

    const selCargo = document.getElementById("cargo-select");
    const selColab = document.getElementById("colaborador-select");
    selCargo.innerHTML = "<option value='Todos'>Todos</option>";
    selColab.innerHTML = "<option value='Todos'>Todos</option>";

    Array.from(cargoSet).sort().forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      selCargo.appendChild(opt);
    });
    Array.from(nomeSet).sort().forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n;
      selColab.appendChild(opt);
    });

    todasObras = Array.from(obraSet).sort();
    selectedObras.clear();

    const searchInput = document.getElementById("obra-search");
    if (searchInput) {
      searchInput.value = "";
      searchInput.oninput = renderObraList;
    }
    renderObraList();

    const inpIni = document.getElementById("data-inicio");
    const inpFim = document.getElementById("data-fim");
    if (minData) inpIni.value = minData;
    if (maxData) inpFim.value = maxData;
  }

  function applyFiltersObras() {
    const cargoSel = document.getElementById("cargo-select").value;
    const colabSel = document.getElementById("colaborador-select").value;
    const dataIni  = document.getElementById("data-inicio").value;
    const dataFim  = document.getElementById("data-fim").value;

    return obrasData.filter(d => {
      if (selectedObras.size > 0 && !selectedObras.has(d.OBRA)) return false;
      if (cargoSel !== "Todos" && d.CARGO !== cargoSel) return false;
      if (colabSel !== "Todos" && d.NOME !== colabSel) return false;
      if (dataIni && d.DATA && d.DATA < dataIni) return false;
      if (dataFim && d.DATA && d.DATA > dataFim) return false;
      return true;
    });
  }

  function refreshDashboardObras() {
    if (!obrasData || obrasData.length === 0) return;
    const filtered = applyFiltersObras();
    updateKpisObras(filtered);
    updateChartsObras(filtered);
    updateTabelaObras(filtered);
  }

  function updateKpisObras(filtered) {
    let total = 0;
    const colaboradores = new Set();
    const obras = new Set();
    let somaPerc = 0;
    let contaEff = 0;

    filtered.forEach(d => {
      total += d.VALOR_DIA || 0;
      if (d.NOME) colaboradores.add(d.NOME);
      if (d.OBRA) obras.add(d.OBRA);

      if (d.PERC_EFICIENCIA != null && isFinite(d.PERC_EFICIENCIA)) {
        somaPerc += d.PERC_EFICIENCIA;
        contaEff++;
      }
    });

    const kTotal = document.getElementById("kpi-custo-total");
    const kMedio = document.getElementById("kpi-custo-medio");
    const kEff = document.getElementById("kpi-eficiencia-media");
    const kObras = document.getElementById("kpi-obras-ativas");

    kTotal.textContent = formatCurrencyBR(total);
    const media = colaboradores.size > 0 ? total / colaboradores.size : 0;
    kMedio.textContent = formatCurrencyBR(media);
    const effMed = contaEff > 0 ? (somaPerc / contaEff) : 0;
    kEff.textContent = effMed.toFixed(1) + "%";
    kObras.textContent = obras.size;
  }

  function updateChartsObras(filtered) {
    // --------- Agrega√ß√µes base ---------
    // Custo por obra
    const mapObra = new Map();
    filtered.forEach(d => {
      const key = d.OBRA || "Sem obra";
      mapObra.set(key, (mapObra.get(key) || 0) + (d.VALOR_DIA || 0));
    });
    const arrObra = Array.from(mapObra.entries()).sort((a,b)=>b[1]-a[1]);

    // Custo por cargo
    const mapCargo = new Map();
    filtered.forEach(d => {
      const key = d.CARGO || "Sem cargo";
      mapCargo.set(key, (mapCargo.get(key) || 0) + (d.VALOR_DIA || 0));
    });
    const arrCargo = Array.from(mapCargo.entries()).sort((a,b)=>b[1]-a[1]);

    // Custo por colaborador
    const mapColab = new Map();
    filtered.forEach(d => {
      const nome = d.NOME || "Sem nome";
      mapColab.set(nome, (mapColab.get(nome)||0) + (d.VALOR_DIA||0));
    });
    const arrColab = Array.from(mapColab.entries()).map(([nome, valor])=>({nome, valor}))
                         .sort((a,b)=>b.valor - a.valor);

    // --------- Custo por obra (barra) ---------
    const xObra = arrObra.map(e=>e[1]);
    const yObra = arrObra.map(e=>e[0]);
    Plotly.react("chart-custo-obra", [{
      type: "bar",
      orientation: "h",
      x: xObra,
      y: yObra,
      hovertemplate: "%{y}<br>Custo: R$ %{x:,.2f}<extra></extra>"
    }], {
      margin: {l: 160, r: 20, t: 10, b: 40},
      paper_bgcolor: "rgba(0,0,0,0)",
      plot_bgcolor: "rgba(0,0,0,0)",
      font: {color:"#f9fafb"},
      xaxis: {tickprefix:"R$ "}
    });

    // --------- Custo por cargo ---------
    Plotly.react("chart-custo-cargo", [{
      type: "bar",
      x: arrCargo.map(e=>e[0]),
      y: arrCargo.map(e=>e[1]),
      hovertemplate: "%{x}<br>Custo: R$ %{y:,.2f}<extra></extra>"
    }], {
      margin: {l: 40, r: 20, t: 10, b: 80},
      paper_bgcolor: "rgba(0,0,0,0)",
      plot_bgcolor: "rgba(0,0,0,0)",
      font: {color:"#f9fafb"},
      yaxis: {tickprefix:"R$ "},
      xaxis: {tickangle: -30}
    });

    // --------- Efici√™ncia por colaborador (top 15) ---------
    const mapEff = new Map();
    filtered.forEach(d => {
      const nome = d.NOME || "Sem nome";
      if (!mapEff.has(nome)) mapEff.set(nome, []);
      mapEff.get(nome).push(d.PERC_EFICIENCIA);
    });
    const arrEff = Array.from(mapEff.entries()).map(([nome, arr]) => {
      const valid = arr.filter(v=>v!=null && isFinite(v));
      const media = valid.length>0 ? valid.reduce((a,b)=>a+b,0)/valid.length : 0;
      return { nome, media };
    }).sort((a,b)=>b.media - a.media).slice(0,15);

    Plotly.react("chart-eficiencia-colaborador", [{
      type: "bar",
      x: arrEff.map(e=>e.nome),
      y: arrEff.map(e=>e.media),
      hovertemplate: "%{x}<br>% Efici√™ncia: %{y:.1f}%<extra></extra>"
    }], {
      margin: {l:40, r:20, t:10, b:80},
      paper_bgcolor: "rgba(0,0,0,0)",
      plot_bgcolor: "rgba(0,0,0,0)",
      font:{color:"#f9fafb"},
      yaxis:{title:"% Efici√™ncia"}
    });

    // --------- Custo por colaborador (barra horizontal top 15) ---------
    const arrColabTop15 = arrColab.slice(0,15);
    Plotly.react("chart-custo-colaborador", [{
      type: "bar",
      orientation: "h",
      x: arrColabTop15.map(e=>e.valor),
      y: arrColabTop15.map(e=>e.nome),
      hovertemplate: "%{y}<br>Custo: R$ %{x:,.2f}<extra></extra>"
    }], {
      margin:{l:160, r:20, t:10, b:40},
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      font:{color:"#f9fafb"},
      xaxis:{tickprefix:"R$ "}
    });

    // --------- Pizza por cargo ---------
    Plotly.react("chart-pizza-cargo", [{
      type: "pie",
      labels: arrCargo.map(e=>e[0]),
      values: arrCargo.map(e=>e[1]),
      hole: 0.4,
      hovertemplate: "%{label}<br>Custo: R$ %{value:,.2f}<extra></extra>"
    }], {
      margin:{l:10, r:10, t:10, b:10},
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      font:{color:"#f9fafb"}
    });

    // --------- Custo no tempo ---------
    const mapData = new Map();
    filtered.forEach(d => {
      const dt = d.DATA || "Sem data";
      mapData.set(dt, (mapData.get(dt)||0) + (d.VALOR_DIA||0));
    });
    const arrData = Array.from(mapData.entries()).filter(e=>e[0] && e[0]!=="Sem data")
                       .sort((a,b)=> a[0] < b[0]? -1 : (a[0]>b[0]?1:0));

    Plotly.react("chart-custo-tempo", [{
      type: "scatter",
      mode: "lines+markers",
      x: arrData.map(e=>e[0]),
      y: arrData.map(e=>e[1]),
      hovertemplate: "%{x}<br>Custo: R$ %{y:,.2f}<extra></extra>"
    }], {
      margin:{l:50,r:20,t:10,b:40},
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      font:{color:"#f9fafb"},
      yaxis:{tickprefix:"R$ "}
    });

    // --------- FUNIS TOP 10 ---------
    const arrObraTop10 = arrObra.slice(0,10);
    Plotly.react("chart-funil-obra", [{
      type: "funnel",
      y: arrObraTop10.map(e => e[0]),
      x: arrObraTop10.map(e => e[1]),
      textinfo: "value+percent initial",
      hovertemplate: "%{y}<br>Custo: R$ %{x:,.2f}<extra></extra>"
    }], {
      margin:{l:120,r:20,t:10,b:20},
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      font:{color:"#f9fafb"},
    });

    const arrColabTop10 = arrColab.slice(0,10);
    Plotly.react("chart-funil-colaborador", [{
      type: "funnel",
      y: arrColabTop10.map(e => e.nome),
      x: arrColabTop10.map(e => e.valor),
      textinfo: "value+percent initial",
      hovertemplate: "%{y}<br>Custo: R$ %{x:,.2f}<extra></extra>"
    }], {
      margin:{l:120,r:20,t:10,b:20},
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      font:{color:"#f9fafb"},
    });
  }

  function updateTabelaObras(filtered) {
    const tbody = document.getElementById("tabela-detalhada");
    tbody.innerHTML = "";
    filtered.forEach(d => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.DATA || ""}</td>
        <td>${d.OBRA || ""}</td>
        <td>${d.CARGO || ""}</td>
        <td>${d.NOME || ""}</td>
        <td>${d.HORAS_DIARIAS || ""}</td>
        <td>${d.EFICIENCIA || ""}</td>
        <td>${d.PERC_EFICIENCIA != null ? d.PERC_EFICIENCIA.toFixed(1) + "%" : ""}</td>
        <td>${formatCurrencyBR(d.VALOR_DIA || 0)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function handleFileImportObras(evt) {
    const file = evt.target.files[0];
    if (!file) return;
    const status = document.getElementById("import-status-obras");
    const nomeSpan = document.getElementById("file-obras-nome");
    if (nomeSpan) nomeSpan.textContent = file.name;
    status.textContent = "Lendo arquivo...";

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array", cellDates: true });
        const sheetName = workbook.SheetNames[0];
        const ws = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, { defval: null });

        obrasData = rows.map(r => {
          const dataVal = parseExcelDateToISO(r["DATA"] || r["Data"] || r["data"]);
          const nome = r["NOME"] || r["Nome"] || r["COLABORADOR"] || r["Colaborador"] || "";
          const cargo = r["CARGO"] || r["Cargo"] || "";
          const obra = r["OBRA"] || r["Obra"] || "";
          const valorDia = parseBrazilNumber(r["VALOR-DIA"] || r["Valor-dia"] || r["Valor Dia"] || r["VALOR_DIA"]);
          const eficienciaStr = r["EFICI√äNCIA"] || r["Efici√™ncia"] || r["EFICIENCIA"] || "";
          const horasStr = r["Horas-di√°rias"] || r["HORAS-DIARIAS"] || r["Horas_diarias"] || "";
          const horasPrev = parseTimeToHours(horasStr || "00:00:00");
          const horasEff = parseTimeToHours(eficienciaStr || "00:00:00");
          const percEff = (horasPrev > 0) ? (horasEff/horasPrev)*100 : null;

          return {
            DATA: dataVal,
            NOME: nome,
            CARGO: cargo,
            OBRA: obra,
            VALOR_DIA: valorDia,
            EFICIENCIA: eficienciaStr,
            HORAS_DIARIAS: horasStr,
            PERC_EFICIENCIA: percEff
          };
        });

        if (!obrasData.length) {
          status.textContent = "Arquivo sem registros.";
          alert("Nenhuma linha encontrada na planilha de obras.");
          return;
        }

        status.textContent = "Registros carregados: " + obrasData.length + " (Obras)";
        buildFiltersFromDataObras(obrasData);
        refreshDashboardObras();
      } catch (err) {
        console.error(err);
        status.textContent = "Erro ao importar.";
        alert("Erro ao ler o arquivo de obras. Verifique as colunas: DATA, NOME, CARGO, OBRA, VALOR-DIA, EFICI√äNCIA, Horas-di√°rias.");
      }
    };
    reader.readAsArrayBuffer(file);
  }

  // =====================================
  // DASHBOARD CUSTOS INDIRETOS
  // =====================================
  let ciData = [];

  function buildCIFiltersFromData(data) {
    const classSet = new Set();
    const nomeSet = new Set();
    const meses = new Set();

    data.forEach(d => {
      if (d.CLASSIFICACAO) classSet.add(d.CLASSIFICACAO);
      if (d.NOME) nomeSet.add(d.NOME);
      if (d.MES) meses.add(d.MES);
    });

    const selClass = document.getElementById("ci-class");
    const selNome = document.getElementById("ci-nome");
    selClass.innerHTML = "<option value='__ALL__'>Todas</option>";
    selNome.innerHTML = "<option value='__ALL__'>Todos</option>";

    Array.from(classSet).sort().forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      selClass.appendChild(opt);
    });
    Array.from(nomeSet).sort().forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n;
      selNome.appendChild(opt);
    });

    const ordenados = Array.from(meses).sort(monthCompare);
    if (ordenados.length > 0) {
      document.getElementById("ci-mes-inicio").value = ordenados[0];
      document.getElementById("ci-mes-fim").value = ordenados[ordenados.length-1];
    }
  }

  function applyCIFilters() {
    const classSel = document.getElementById("ci-class").value;
    const nomeSel = document.getElementById("ci-nome").value;
    const modeloSel = document.getElementById("ci-modelo").value;
    const mesIni = document.getElementById("ci-mes-inicio").value;
    const mesFim = document.getElementById("ci-mes-fim").value;

    return ciData.filter(d => {
      if (classSel !== "__ALL__" && d.CLASSIFICACAO !== classSel) return false;
      if (nomeSel !== "__ALL__" && d.NOME !== nomeSel) return false;
      if (modeloSel !== "__ALL__" && d.MODELO !== modeloSel) return false;
      if (mesIni && d.MES && monthCompare(d.MES, mesIni) < 0) return false;
      if (mesFim && d.MES && monthCompare(d.MES, mesFim) > 0) return false;
      return true;
    });
  }

  function computeDespesa(d) {
    const v = Number(d.VALOR || 0);
    if (!isFinite(v)) return 0;
    return Math.abs(v);
  }

  function groupByCI(arr, keyFn, aggFn) {
    const map = new Map();
    arr.forEach(item => {
      const key = keyFn(item);
      if (!map.has(key)) map.set(key, []);
      map.get(key).push(item);
    });
    const result = [];
    map.forEach((items, key) => {
      result.push(aggFn(key, items));
    });
    return result;
  }

  function updateCIKPIs(filtered) {
    let totalDespesa = 0;
    let despAntigo = 0;
    let despNovo = 0;

    filtered.forEach(d => {
      const desp = computeDespesa(d);
      totalDespesa += desp;
      if (d.MODELO === "ANTIGO") despAntigo += desp;
      if (d.MODELO === "NOVO") despNovo += desp;
    });

    const diff = despNovo - despAntigo;

    document.getElementById("ci-kpi-despesa").textContent = formatCurrencyBR(totalDespesa);
    document.getElementById("ci-kpi-antigo").textContent = formatCurrencyBR(despAntigo);
    document.getElementById("ci-kpi-novo").textContent = formatCurrencyBR(despNovo);
    document.getElementById("ci-kpi-diff").textContent = formatCurrencyBR(diff);
  }

  function updateCICharts(filtered) {
    // por classifica√ß√£o x modelo
    const porClassModelo = groupByCI(
      filtered,
      d => (d.CLASSIFICACAO || "Sem classifica√ß√£o") + "||" + (d.MODELO || "SEM"),
      (key, items) => {
        const [cls, modelo] = key.split("||");
        let desp = 0;
        items.forEach(d => desp += computeDespesa(d));
        return { classificacao: cls, modelo, despesa: desp };
      }
    );
    const classSet = Array.from(new Set(porClassModelo.map(r => r.classificacao))).sort();
    const modelos = ["ANTIGO", "NOVO"];

    const tracesClassModelo = modelos.map(modelo => ({
      name: modelo,
      type: "bar",
      x: classSet,
      y: classSet.map(cls => {
        const found = porClassModelo.find(r => r.classificacao === cls && r.modelo === modelo);
        return found ? found.despesa : 0;
      })
    }));

    Plotly.react("chart-ci-class-model", tracesClassModelo, {
      barmode: "group",
      margin: {l: 40, r: 20, t: 20, b: 80},
      paper_bgcolor: "rgba(0,0,0,0)",
      plot_bgcolor: "rgba(0,0,0,0)",
      yaxis: {title:"Despesas (R$)", tickprefix:"R$ "},
      xaxis: {tickangle:-30},
      font: {color:"#f9fafb"}
    });

    // Mensal por modelo + tend√™ncia ANTIGO
    const porMesModelo = groupByCI(
      filtered,
      d => (d.MES || "Sem m√™s") + "||" + (d.MODELO || "SEM"),
      (key, items) => {
        const [mes, modelo] = key.split("||");
        let desp = 0;
        items.forEach(d => desp += computeDespesa(d));
        return { mes, modelo, despesa: desp };
      }
    ).sort((a,b)=>monthCompare(a.mes,b.mes));

    const meses = Array.from(new Set(porMesModelo.map(r=>r.mes))).sort(monthCompare);
    const yAntigo = meses.map(m => {
      const f = porMesModelo.find(r=>r.mes===m && r.modelo==="ANTIGO");
      return f ? f.despesa : 0;
    });
    const yNovo = meses.map(m => {
      const f = porMesModelo.find(r=>r.mes===m && r.modelo==="NOVO");
      return f ? f.despesa : 0;
    });

    const tracesMesModelo = [
      {
        name: "ANTIGO",
        type: "bar",
        x: meses,
        y: yAntigo
      },
      {
        name: "NOVO",
        type: "bar",
        x: meses,
        y: yNovo
      }
    ];

    const trendAntigo = computeTrendLine(yAntigo);
    if (trendAntigo) {
      tracesMesModelo.push({
        name: "Tend√™ncia ANTIGO",
        type: "scatter",
        mode: "lines",
        x: meses,
        y: trendAntigo,
        line: {dash:"dash", width:2, color:"#f97316"},
        hoverinfo: "skip"
      });
    }

    Plotly.react("chart-ci-mensal-modelo", tracesMesModelo, {
      barmode: "group",
      margin: {l:60, r:20, t:20, b:50},
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      yaxis:{title:"Despesas (R$)", tickprefix:"R$ "},
      xaxis:{title:"M√™s"},
      font:{color:"#f9fafb"},
      legend:{orientation:"h", y:-0.2}
    });

    // Pizza classifica√ß√£o
    const porClass = groupByCI(
      filtered,
      d => d.CLASSIFICACAO || "Sem classifica√ß√£o",
      (cls, items) => {
        let desp = 0;
        items.forEach(d => desp += computeDespesa(d));
        return { classificacao: cls, despesa: desp };
      }
    ).filter(r=>r.despesa>0);

    Plotly.react("chart-ci-pizza-class", [{
      type:"pie",
      labels: porClass.map(r=>r.classificacao),
      values: porClass.map(r=>r.despesa),
      hole:0.4,
      hovertemplate:"%{label}<br>Despesa: R$ %{value:,.2f}<extra></extra>"
    }], {
      margin:{l:10,r:10,t:20,b:10},
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      font:{color:"#f9fafb"}
    });

    // Top 10 colaboradores
    const porColab = groupByCI(
      filtered,
      d => d.NOME || "Sem nome",
      (nome, items) => {
        let desp = 0;
        items.forEach(d => desp += computeDespesa(d));
        return { nome, despesa: desp };
      }
    ).sort((a,b)=>b.despesa-a.despesa).slice(0,10);

    Plotly.react("chart-ci-top-colab", [{
      type:"bar",
      orientation:"h",
      x: porColab.map(r=>r.despesa),
      y: porColab.map(r=>r.nome),
      hovertemplate:"%{y}<br>Despesa: R$ %{x:,.2f}<extra></extra>"
    }], {
      margin:{l:160,r:20,t:20,b:40},
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      font:{color:"#f9fafb"},
      xaxis:{tickprefix:"R$ "}
    });

    // Total por modelo
    const porModelo = groupByCI(
      filtered,
      d => d.MODELO || "SEM",
      (modelo, items) => {
        let desp = 0;
        items.forEach(d => desp += computeDespesa(d));
        return { modelo, despesa: desp };
      }
    );

    const modelosDisponiveis = ["ANTIGO","NOVO"].filter(m => porModelo.some(r=>r.modelo===m));
    Plotly.react("chart-ci-modelo-total", [{
      type:"bar",
      x:modelosDisponiveis,
      y:modelosDisponiveis.map(m=>{
        const f = porModelo.find(r=>r.modelo===m);
        return f?f.despesa:0;
      }),
      hovertemplate:"%{x}<br>Despesa: R$ %{y:,.2f}<extra></extra>"
    }], {
      margin:{l:40,r:20,t:20,b:40},
      paper_bgcolor:"rgba(0,0,0,0)",
      plot_bgcolor:"rgba(0,0,0,0)",
      font:{color:"#f9fafb"},
      yaxis:{title:"Despesas (R$)", tickprefix:"R$ "}
    });
  }

  function updateCITable(filtered) {
    const tbody = document.getElementById("ci-table-body");
    tbody.innerHTML = "";
    filtered.forEach(d => {
      const desp = computeDespesa(d);
      if (desp <= 0) return;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.MES || ""}</td>
        <td>${d.MODELO || ""}</td>
        <td>${d.CLASSIFICACAO || ""}</td>
        <td>${d.NOME || ""}</td>
        <td>${formatCurrencyBR(desp)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function refreshCIDashboard() {
    if (!ciData || ciData.length === 0) return;
    const filtered = applyCIFilters();
    updateCIKPIs(filtered);
    updateCICharts(filtered);
    updateCITable(filtered);
  }

  function handleCIFileImport(evt) {
    const file = evt.target.files[0];
    if (!file) return;
    const status = document.getElementById("ci-import-status");
    const subtitle = document.getElementById("ci-table-subtitle");
    const nomeSpan = document.getElementById("file-ci-nome");
    if (nomeSpan) nomeSpan.textContent = file.name;
    status.textContent = "Lendo arquivo...";

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array", cellDates: true });
        const sheetName = workbook.SheetNames[0];
        const ws = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, { defval: null });

        ciData = rows.map(row => {
          const mesRaw = row["M√™s"] || row["MES"] || row["Mes"];
          const mes = parseMonthToYYYYMM(mesRaw);
          const modelo = row["Modelo"] || row["MODELO"] || "";
          const classificacao = row["Classifica√ß√£o"] || row["CLASSIFICACAO"] || row["Classificacao"] || "";
          const nome = row["Colaborador"] || row["Nome"] || row["NOME"] || "";
          let valor = row["Despesa (R$)"] ?? row["Despesa"] ?? row["Valor"] ?? 0;
          valor = parseBrazilNumber(valor);

          return {
            MES: mes,
            MODELO: modelo,
            CLASSIFICACAO: classificacao,
            NOME: nome,
            VALOR: valor
          };
        });

        if (!ciData.length) {
          status.textContent = "Arquivo sem registros.";
          alert("Nenhuma linha encontrada na planilha de custos indiretos.");
          return;
        }

        buildCIFiltersFromData(ciData);
        subtitle.textContent = "Base importada de " + file.name + " ¬∑ " + ciData.length + " registros";
        status.textContent = "Registros carregados: " + ciData.length;
        refreshCIDashboard();
      } catch (err) {
        console.error(err);
        status.textContent = "Erro ao importar.";
        alert("Erro ao ler o arquivo de custos indiretos. Verifique as colunas: M√™s, Modelo, Classifica√ß√£o, Colaborador, Despesa (R$).");
      }
    };
    reader.readAsArrayBuffer(file);
  }

  // ---------- INICIALIZA√á√ÉO ----------
  document.addEventListener("DOMContentLoaded", () => {
    // Obras
    document.getElementById("file-obras").addEventListener("change", handleFileImportObras);
    ["cargo-select","colaborador-select","data-inicio","data-fim"].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("change", refreshDashboardObras);
    });

    // Custos indiretos
    document.getElementById("file-ci").addEventListener("change", handleCIFileImport);
    ["ci-class","ci-nome","ci-modelo","ci-mes-inicio","ci-mes-fim"].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("change", refreshCIDashboard);
    });

    // Toggle filtros Custos Indiretos
    const fw = document.getElementById("ci-filters-wrapper");
    const ft = document.getElementById("ci-filter-toggle");
    ft.addEventListener("click", () => {
      const collapsed = fw.classList.toggle("collapsed");
      const icon = ft.querySelector(".icon");
      const text = ft.querySelector("span:nth-child(2)");
      if (collapsed) {
        if (icon) icon.textContent = "‚¨á";
        if (text) text.textContent = "Mostrar filtros";
      } else {
        if (icon) icon.textContent = "‚¨Ü";
        if (text) text.textContent = "Ocultar filtros";
      }
    });

    // Toggle filtros OBRAS
    const obFw = document.getElementById("ob-filters-wrapper");
    const obFt = document.getElementById("ob-filter-toggle");
    obFt.addEventListener("click", () => {
      const collapsed = obFw.classList.toggle("collapsed");
      const icon = obFt.querySelector(".icon");
      const text = obFt.querySelector("span:nth-child(2)");
      if (collapsed) {
        if (icon) icon.textContent = "‚¨á";
        if (text) text.textContent = "Mostrar filtros";
      } else {
        if (icon) icon.textContent = "‚¨Ü";
        if (text) text.textContent = "Ocultar filtros";
      }
    });
  });
</script>
</body>
</html>
