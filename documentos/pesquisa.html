
<!doctype html>
<html lang="pt-br" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pesquisa de documentos — Módulo independente</title>
  <style>
    :root{
      --azul:#0A1A3A; --azul-dark:#08142E; --azul-acc:#3B82F6;
      --bg:#f6f8fb; --card:#ffffff; --borda:#e5e7eb; --txt:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1000px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--borda);border-radius:16px;box-shadow:0 18px 60px rgba(2,6,23,.08)}
    .head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;
          background:linear-gradient(90deg,var(--azul),var(--azul-dark));color:#fff;border-radius:16px 16px 0 0}
    .title{font-weight:900;letter-spacing:.2px}
    .body{padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .row input{flex:1 1 220px;padding:10px 12px;border:1px solid var(--borda);border-radius:12px}
    .btn{border:none;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--azul-dark),var(--azul));color:#fff}
    .btn.ghost{background:#e5e7eb;color:var(--azul)}
    .list{border-top:1px solid var(--borda)}
    .item{display:grid;grid-template-columns:160px 160px 1fr;gap:12px;align-items:center;padding:12px;border-bottom:1px solid var(--borda);cursor:pointer}
    .item:hover{background:#f9fafb}
    .code{font-weight:900;color:var(--azul)}
    .date{color:#475569}
    .client{white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .empty{padding:16px;color:#64748b}
    /* modal */
    .back{position:fixed;inset:0;display:none;place-items:center;background:rgba(2,6,23,.5);z-index:1000}
    .modal{width:min(520px,94vw);background:#fff;border:1px solid var(--borda);border-radius:16px;overflow:hidden;box-shadow:0 28px 80px rgba(2,6,23,.35)}
    .mhead{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:linear-gradient(90deg,var(--azul),var(--azul-dark));color:#fff}
    .mbody{padding:16px;color:var(--txt)}
    .mactions{display:flex;gap:10px;justify-content:flex-end;padding:14px 16px;border-top:1px solid var(--borda);background:#f8fafc}
    .x{background:transparent;border:none;font-size:20px;color:#fff;cursor:pointer;padding:6px 8px}
    .chip{display:inline-block;margin-left:8px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.35);padding:2px 8px;border-radius:999px}
    /* loader */
    .loaderBack{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.8);z-index:1100}
    .loaderBox{display:flex;flex-direction:column;align-items:center;gap:12px;background:#000;color:#fff;border:2px solid #fff;padding:20px 22px;border-radius:14px}
    .spin{width:42px;height:42px;border-radius:50%;border:4px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .note{margin-top:12px;color:#64748b}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head"><div class="title">Consulta de documentos</div></div>
      <div class="body">
        <div class="row">
          <input id="codigo" placeholder="Digite o código (ex.: AC05925)" />
          <button class="btn primary" id="btnListar">Listar</button>
          <button class="btn ghost" id="btnListarTodos">Listar todos</button>
          <a class="btn ghost" href="/documentos/index.html">Voltar para etapas</a>
        </div>
        <div id="list" class="list"></div>
        <div class="note">Este módulo é independente. Ele não interfere no HTML legado das etapas.</div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="back" id="back">
    <div class="modal">
      <div class="mhead">
        <div class="title">Documento <span id="mcode" class="chip">—</span></div>
        <button class="x" id="x">×</button>
      </div>
      <div class="mbody" id="mbody">Selecione uma ação para este documento.</div>
      <div class="mactions">
        <button class="btn ghost" id="btnFechar">Fechar</button>
        <button class="btn ghost" id="btnAtualizar">Atualizar</button>
        <button class="btn ghost" id="btnGerarOS">Gerar OS</button>
        <button class="btn primary" id="btnGerarContrato">Gerar contrato</button>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div class="loaderBack" id="loader">
    <div class="loaderBox"><div class="spin"></div><div>Processando... aguarde...</div></div>
  </div>

<script>
(function(){
  // ====== CONFIG ======
  const JSON_URL = 'https://api.erpimpar.com.br/gerador/json_table_cors.php';
  const SAVE_TOKEN = '8ce29ab4b2d531b0eca93b9f3a8882e543cbad73663b77';
  const API_BASE = 'https://api.erpimpar.com.br/gerador';
  const TPL_CONTRATO = 'Template-Contrato.docx';
  const TPL_OS = 'Template_OS.docx';

  // ====== UTILS ======
  const $ = sel => document.querySelector(sel);
  const listEl = $('#list');
  const back = $('#back');
  const loader = $('#loader');
  const setLoader = (v) => loader.style.display = v ? 'grid' : 'none';
  const showBack = v => back.style.display = v ? 'grid':'none';

  function bind(btn, fn){
    btn.replaceWith(btn.cloneNode(true));
    const neo = document.getElementById(btn.id);
    neo.onclick = fn;
  }

 function toast(msg){
  let t = document.getElementById('toast');
  if(!t){
    t = document.createElement('div');
    t.id = 'toast';
    Object.assign(t.style,{
      position:'fixed',right:'16px',bottom:'16px',zIndex:2000,
      background:'#0b0f19',color:'#d1fae5',border:'1px solid #10b981',
      padding:'10px 14px',borderRadius:'10px',boxShadow:'0 10px 30px rgba(0,0,0,.35)',
      fontWeight:'700',letterSpacing:'.2px'
    });
    document.body.appendChild(t);
  }
  t.textContent = msg||'OK';
  t.style.opacity='1';
  clearTimeout(t._hide);
  t._hide = setTimeout(()=>{ t.style.opacity='0'; }, 2200);
 }

  function row(r){
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div class="code">${r.codigo||'-'}</div>
      <div class="date">${(r.data_criacao||'').slice(0,10)}</div>
      <div class="client">${r.nomeContratante||''}</div>
    `;
    div.addEventListener('click', ()=> openModal(r.codigo||''));
    return div;
  }

  function render(items){
    listEl.innerHTML='';
    if(!items || !items.length){
      listEl.innerHTML = '<div class="empty">Sem registros.</div>';
      return;
    }
    items.forEach(r=> listEl.appendChild(row(r)));
  }

  async function fetchList(){
    const u = `${JSON_URL}?op=list${SAVE_TOKEN?('&token='+encodeURIComponent(SAVE_TOKEN)):""}`;
    const r = await fetch(u, {cache:'no-store'});
    const j = await r.json().catch(()=>null);
    return (j && j.ok) ? (j.items||[]) : [];
  }

  async function fetchGet(codigo){
    const u = `${JSON_URL}?op=get&codigo=${encodeURIComponent(codigo)}${SAVE_TOKEN?('&token='+encodeURIComponent(SAVE_TOKEN)):""}`;
    const r = await fetch(u, {cache:'no-store'});
    const j = await r.json().catch(()=>null);
    return (j && j.ok) ? j.item : null;
  }

  // ====== MODAL ======
  window.openModal = function(code){
    document.getElementById('mcode').textContent = (code||'').toUpperCase();
    document.getElementById('back').style.display = 'grid';

    bind(document.getElementById('x'),        () => document.getElementById('back').style.display='none');
    bind(document.getElementById('btnFechar'),() => document.getElementById('back').style.display='none');
    bind(document.getElementById('btnAtualizar'), () => {
      const c = encodeURIComponent((document.getElementById('mcode').textContent||'').trim());
      window.open('/documentos/index.html?codigo='+c, '_blank');
    });
    bind(document.getElementById('btnGerarContrato'), () => gerar('make_contract_json.php','Template-Contrato.docx'));
    bind(document.getElementById('btnGerarOS'),       () => gerar('make_contract_json.php','Template_OS.docx'));
  };

  async function gerar(php, template){
    const code = (document.querySelector('#mcode')?.textContent||'').trim();
    if(!code){ document.getElementById('back').style.display='none'; return; }

    const loader = document.getElementById('loader');
    const showBack = v => document.getElementById('back').style.display = v ? 'grid' : 'none';
    const setLoader = v => loader.style.display = v ? 'grid' : 'none';

    setLoader(true);
    try{
      const ts = Date.now();
      const url = `https://api.erpimpar.com.br/gerador/${php}?codigo=${encodeURIComponent(code)}&template=${encodeURIComponent(template)}&_ts=${ts}`;
      const r = await fetch(url, { cache:'no-store' });
      const ct = (r.headers.get('content-type')||'').toLowerCase();

      if (ct.includes('application/json')) {
        const j = await r.json();
        if (j && j.ok && j.url){
          // Abre a URL já com cache-busting
          const u = j.url + (j.url.includes('?') ? '&' : '?') + '_ts=' + ts;
          window.open(u, '_blank');
          toast('Gerado com sucesso!');
        } else {
          alert('Falha ao gerar documento. Verifique o código/template.');
          console.warn('Resposta do gerador:', j);
        }
      } else {
        // Blob (download direto)
        const blob = await r.blob();
        const disp = r.headers.get('content-disposition') || '';
        let name = (disp.match(/filename\*?=(?:UTF-8'')?("?)([^";]+)\1/i)||[])[2] || '';
        if (!name) {
          const isOS = /Template_OS\.docx/i.test(template);
          const safe = code.replace(/[^\w.-]+/g,'_');
          name = (isOS ? `OS-${safe}` : `Contrato-${safe}`) + '.docx';
        }
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = name;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
        toast('Gerado com sucesso!');
      }
    }catch(e){
      console.error(e);
      alert('Erro de rede durante a geração.');
    }finally{
      setLoader(false);
      showBack(false);
    }
  }

  // ====== BARRA DE BUSCA ======
  $('#btnListarTodos').addEventListener('click', async ()=>{
    setLoader(true);
    try{
      render(await fetchList());
    } finally { setLoader(false); }
  });

  $('#btnListar').addEventListener('click', async ()=>{
    const c = ($('#codigo').value||'').trim();
    if(!c){
      $('#btnListarTodos').click();
      return;
    }
    setLoader(true);
    try {
      const item = await fetchGet(c);
      render(item ? [item] : []);
    } finally { setLoader(false); }
  });

  // Auto: listar últimos na carga
  $('#btnListarTodos').click();
})();
</script>
</body>
</html>
