<!doctype html>
<html lang="pt-br" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pesquisa de documentos — Módulo independente</title>
  <style>
    :root{
      --azul:#0A1A3A; --azul-dark:#08142E; --azul-acc:#3B82F6;
      --bg:#f6f8fb; --card:#ffffff; --borda:#e5e7eb; --txt:#0f172a;
      --verde:#22c55e; --vermelho:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1000px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--borda);border-radius:16px;box-shadow:0 18px 60px rgba(2,6,23,.08)}
    .head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;
          background:linear-gradient(90deg,var(--azul),var(--azul-dark));color:#fff;border-radius:16px 16px 0 0}
    .title{font-weight:900;letter-spacing:.2px}
    .x{background:transparent;border:none;font-size:20px;color:#fff;cursor:pointer;padding:6px 8px;line-height:1}
    .body{padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .row input{flex:1 1 220px;padding:10px 12px;border:1px solid var(--borda);border-radius:12px}
    .btn{border:none;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--azul-dark),var(--azul));color:#fff}
    .btn.ghost{background:#e5e7eb;color:var(--azul)}
    .list{border-top:1px solid var(--borda)}
    .item{display:grid;grid-template-columns:160px 160px 1fr;gap:12px;align-items:center;padding:12px;border-bottom:1px solid var(--borda);cursor:pointer}
    .item:hover{background:#f9fafb}
    .code{font-weight:900;color:var(--azul)}
    .date{color:#475569}
    .client{white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .empty{padding:16px;color:#64748b}

    /* ===== Modal navy com borda branca ===== */
    .back{position:fixed;inset:0;display:none;place-items:center;background:rgba(2,6,23,.5);z-index:1000}
    .modal{
      width:min(520px,94vw);
      background:var(--azul);
      color:#fff;
      border:2px solid #fff;
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 28px 80px rgba(2,6,23,.45)
    }
    .mhead{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--azul)}
    .mbody{padding:16px;color:#E5E7EB}
    .mactions{display:flex;gap:10px;justify-content:flex-end;padding:14px 16px;border-top:1px solid rgba(255,255,255,.25);background:var(--azul)}
    .x{background:transparent;border:none;font-size:20px;color:#fff;cursor:pointer;padding:6px 8px}
    .chip{display:inline-block;margin-left:8px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.35);padding:2px 8px;border-radius:999px}
    .btn-modal{border:none;border-radius:999px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn-modal.primary{background:var(--verde);color:var(--azul)}
    .btn-modal.ghost{background:transparent;color:#fff;border:2px solid #fff}

    /* ===== Loader preto com borda branca ===== */
    .loaderBack{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.8);z-index:1100}
    .loaderBox{display:flex;flex-direction:column;align-items:center;gap:12px;background:#000;color:#fff;border:2px solid #fff;padding:20px 22px;border-radius:14px}
    .spin{width:42px;height:42px;border-radius:50%;border:4px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ===== Toast (canto inferior direito) ===== */
    .toast{
      position:fixed;right:16px;bottom:16px;z-index:1200;
      background:#0B1220;color:#E5E7EB;border:1px solid var(--verde);
      padding:12px 16px;border-radius:12px;font-weight:700;
      box-shadow:0 8px 24px rgba(0,0,0,.35);min-width:320px
    }
    .barWrap{height:3px;background:#1f2937;border-radius:999px;margin-top:10px;overflow:hidden}
    .barOk{height:100%;width:100%;background:var(--verde);animation:bar 2.5s linear forwards}
    @keyframes bar{from{width:100%}to{width:0%}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="title">Consulta de documentos</div>
        <button id="headClose" class="x" type="button" title="Fechar">×</button>
      </div>
      <div class="body">
        <div class="row">
          <input id="codigo" placeholder="Digite o código (ex.: AC05925)" />
          <button class="btn primary" id="btnListar">Listar</button>
          <button class="btn ghost" id="btnListarTodos">Listar todos</button>
          <!-- REMOVIDO: Voltar para etapas -->
        </div>
        <div id="list" class="list"></div>
        <div class="note">Este módulo é independente. Ele não interfere no HTML legado das etapas.</div>
      </div>
    </div>
  </div>

  <!-- Modal navy -->
  <div class="back" id="back">
    <div class="modal">
      <div class="mhead">
        <div class="title">Documento <span id="mcode" class="chip">—</span></div>
        <button class="x" id="x">×</button>
      </div>
      <div class="mbody" id="mbody">Selecione uma ação para este documento.</div>
      <div class="mactions">
        <button class="btn-modal ghost"   id="btnFechar">Fechar</button>
        <!-- REMOVIDO: Atualizar -->
        <button class="btn-modal ghost"   id="btnGerarOS">Gerar OS</button>
        <button class="btn-modal primary" id="btnGerarContrato">Gerar contrato</button>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div class="loaderBack" id="loader">
    <div class="loaderBox"><div class="spin"></div><div>Processando... aguarde...</div></div>
  </div>

<script>
(function(){
  /* ====== CONFIG (mantida exatamente como no seu código) ====== */
  const JSON_URL   = 'https://api.erpimpar.com.br/gerador/json_table_cors.php';
  const SAVE_TOKEN = '8ce29ab4b2d531b0eca93b9f3a8882e543cbad73663b77';
  const API_BASE   = 'https://api.erpimpar.com.br/gerador';
  const TPL_CONTRATO = 'Template-Contrato.docx';
  const TPL_OS       = 'Template_OS.docx';
  /* =========================================================== */

  const $ = sel => document.querySelector(sel);
  const listEl = $('#list');
  const back   = $('#back');
  const loader = $('#loader');
  const setLoader = v => loader.style.display = v ? 'grid' : 'none';
  const showBack  = v => back.style.display = v ? 'grid' : 'none';
  const headClose = document.getElementById('headClose');
  if (headClose){
    headClose.addEventListener('click', ()=>{
      // Se abriu via window.open, fecha; senão, volta uma página.
      if (window.opener) {
        try { window.close(); } catch(_) { location.href = '/documentos/index.html'; }
      } else {
        // fallback caso não consiga fechar
        location.href = '/documentos/index.html';
      }
    });
  }
  function row(r){
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div class="code">${r.codigo||'-'}</div>
      <div class="date">${(r.data_criacao||'').slice(0,10)}</div>
      <div class="client">${r.nomeContratante||''}</div>
    `;
    div.addEventListener('click', ()=> openModal(r.codigo||'', r.nomeContratante||''));
    return div;
  }
  function render(items){
    listEl.innerHTML='';
    if(!items || !items.length){
      listEl.innerHTML = '<div class="empty">Sem registros.</div>';
      return;
    }
    items.forEach(r=> listEl.appendChild(row(r)));
  }

  async function fetchJSON(url){
    const r = await fetch(url, { cache:'no-store' });
    return await r.json().catch(()=>null);
  }
  async function fetchList(){
    const u = `${JSON_URL}?op=list${SAVE_TOKEN?('&token='+encodeURIComponent(SAVE_TOKEN)):""}&t=${Date.now()}`;
    const j = await fetchJSON(u);
    return (j && j.ok) ? (j.items||[]) : [];
  }
  async function fetchGet(codigo){
    const u = `${JSON_URL}?op=get&codigo=${encodeURIComponent(codigo)}${SAVE_TOKEN?('&token='+encodeURIComponent(SAVE_TOKEN)):""}&t=${Date.now()}`;
    const j = await fetchJSON(u);
    return (j && j.ok) ? j.item : null;
  }

  function openModal(code, nome){
    $('#mcode').textContent = (code||'').toUpperCase();
    $('#mcode').setAttribute('data-nome', nome||'');
    showBack(true);

    $('#x').onclick = () => showBack(false);
    $('#btnFechar').onclick = () => showBack(false);

    // REMOVIDO: Atualizar
    $('#btnGerarContrato').onclick = () => gerar('make_contract_json.php', TPL_CONTRATO);
    $('#btnGerarOS').onclick       = () => gerar('make_contract_json.php', TPL_OS);
  }

  async function gerar(php, template){
    const code = ($('#mcode').textContent||'').trim();
    const nome = ($('#mcode').getAttribute('data-nome')||'').trim();
    if(!code){ showBack(false); return; }

    setLoader(true);
    try{
      const url = `${API_BASE}/${php}?codigo=${encodeURIComponent(code)}&template=${encodeURIComponent(template)}&t=${Date.now()}`;
      const res = await fetch(url, { cache:'no-store' });
      if (!res.ok) { toastErro('Erro ao gerar documento.'); return; }

      const blob = await res.blob();
      // define prefixo pelo template
      const prefix = template.includes('OS') ? 'O.S.' : 'Contrato';
      let fname = `${prefix}-${code}`;
      if (nome) fname += `-${nome}`;
      fname = fname.replace(/[\\/:*?"<>|]+/g,'').trim() + '.docx';

      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);

      toastOk('Documento gerado com sucesso', `Código: ${code}${nome?` — ${nome}`:''}`);
    }catch(e){
      console.error(e);
      toastErro('Erro de rede durante a geração.');
    }finally{
      setLoader(false);
      showBack(false);
    }
  }

  $('#btnListarTodos').addEventListener('click', async ()=>{
    setLoader(true);
    try{ render(await fetchList()); } finally{ setLoader(false); }
  });

  $('#btnListar').addEventListener('click', async ()=>{
    const c = ($('#codigo').value||'').trim();
    if(!c){ $('#btnListarTodos').click(); return; }
    setLoader(true);
    try{ const item = await fetchGet(c); render(item ? [item] : []); }
    finally{ setLoader(false); }
  });

  // 1ª carga: listar todos
  $('#btnListarTodos').click();

  /* ===== Toasts bonitos (canto inferior direito) ===== */
  function toastBase(html, borderColor){
    const box = document.createElement('div');
    box.className = 'toast';
    box.style.borderColor = borderColor || 'var(--verde)';
    box.innerHTML = html;
    document.body.appendChild(box);
    setTimeout(()=> box.remove(), 2600);
  }
  function toastOk(titulo, linha2){
    const html = `
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="width:18px;height:18px;border-radius:50%;border:2px solid var(--verde);display:inline-flex;align-items:center;justify-content:center">
          <div style="width:8px;height:8px;background:var(--verde);border-radius:50%"></div>
        </div>
        <div>
          <div style="color:#fff">${titulo||'Concluído'}</div>
          ${linha2?`<div style="margin-top:2px;color:#9CA3AF;font-weight:600">${linha2}</div>`:''}
        </div>
      </div>
      <div class="barWrap"><div class="barOk"></div></div>
    `;
    toastBase(html, 'var(--verde)');
  }
  function toastErro(msg){
    const html = `<div style="color:#fff">${msg||'Ocorreu um erro.'}</div>`;
    toastBase(html, 'var(--vermelho)');
  }
})();
</script>

</body>
</html>
