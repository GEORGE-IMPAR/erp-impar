
<!doctype html>
<html lang="pt-br" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pesquisa de documentos — Módulo independente</title>
  <style>
    :root{
      --azul:#0A1A3A; --azul-dark:#08142E; --azul-acc:#3B82F6;
      --bg:#f6f8fb; --card:#ffffff; --borda:#e5e7eb; --txt:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1000px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--borda);border-radius:16px;box-shadow:0 18px 60px rgba(2,6,23,.08)}
    .head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;
          background:linear-gradient(90deg,var(--azul),var(--azul-dark));color:#fff;border-radius:16px 16px 0 0}
    .title{font-weight:900;letter-spacing:.2px}
    .body{padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .row input{flex:1 1 220px;padding:10px 12px;border:1px solid var(--borda);border-radius:12px}
    .btn{border:none;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--azul-dark),var(--azul));color:#fff}
    .btn.ghost{background:#e5e7eb;color:var(--azul)}
    .list{border-top:1px solid var(--borda)}
    .item{display:grid;grid-template-columns:160px 160px 1fr;gap:12px;align-items:center;padding:12px;border-bottom:1px solid var(--borda);cursor:pointer}
    .item:hover{background:#f9fafb}
    .code{font-weight:900;color:var(--azul)}
    .date{color:#475569}
    .client{white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .empty{padding:16px;color:#64748b}
    /* modal */
    .back{position:fixed;inset:0;display:none;place-items:center;background:rgba(2,6,23,.5);z-index:1000}
    .modal{width:min(520px,94vw);background:#fff;border:1px solid var(--borda);border-radius:16px;overflow:hidden;box-shadow:0 28px 80px rgba(2,6,23,.35)}
    .mhead{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:linear-gradient(90deg,var(--azul),var(--azul-dark));color:#fff}
    .mbody{padding:16px;color:var(--txt)}
    .mactions{display:flex;gap:10px;justify-content:flex-end;padding:14px 16px;border-top:1px solid var(--borda);background:#f8fafc}
    .x{background:transparent;border:none;font-size:20px;color:#fff;cursor:pointer;padding:6px 8px}
    .chip{display:inline-block;margin-left:8px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.35);padding:2px 8px;border-radius:999px}
    /* loader */
    .loaderBack{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.8);z-index:1100}
    .loaderBox{display:flex;flex-direction:column;align-items:center;gap:12px;background:#000;color:#fff;border:2px solid #fff;padding:20px 22px;border-radius:14px}
    .spin{width:42px;height:42px;border-radius:50%;border:4px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .note{margin-top:12px;color:#64748b}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head"><div class="title">Consulta de documentos</div></div>
      <div class="body">
        <div class="row">
          <input id="codigo" placeholder="Digite o código (ex.: AC05925)" />
          <button class="btn primary" id="btnListar">Listar</button>
          <button class="btn ghost" id="btnListarTodos">Listar todos</button>
          <a class="btn ghost" href="/documentos/index.html">Voltar para etapas</a>
        </div>
        <div id="list" class="list"></div>
        <div class="note">Este módulo é independente. Ele não interfere no HTML legado das etapas.</div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="back" id="back">
    <div class="modal">
      <div class="mhead">
        <div class="title">Documento <span id="mcode" class="chip">—</span></div>
        <button class="x" id="x">×</button>
      </div>
      <div class="mbody" id="mbody">Selecione uma ação para este documento.</div>
      <div class="mactions">
        <button class="btn ghost" id="btnFechar">Fechar</button>
        <button class="btn ghost" id="btnAtualizar">Atualizar</button>
        <button class="btn ghost" id="btnGerarOS">Gerar OS</button>
        <button class="btn primary" id="btnGerarContrato">Gerar contrato</button>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div class="loaderBack" id="loader">
    <div class="loaderBox"><div class="spin"></div><div>Processando... aguarde...</div></div>
  </div>

<script>
(function(){
  const JSON_URL   = 'https://api.erpimpar.com.br/gerador/json_table_cors.php';
  const SAVE_TOKEN = '8ce29ab4b2d531b0eca93b9f3a8882e543cbad73663b77';
  const API_BASE   = 'https://api.erpimpar.com.br/gerador';
  const TPL_CONTRATO = 'Template-Contrato.docx';
  const TPL_OS       = 'Template_OS.docx';

  const $ = sel => document.querySelector(sel);
  const listEl = $('#list');
  const back   = $('#back');
  const loader = $('#loader');
  const setLoader = v => loader.style.display = v ? 'grid' : 'none';
  const showBack  = v => back.style.display = v ? 'grid' : 'none';

  function row(r){
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div class="code">${r.codigo||'-'}</div>
      <div class="date">${(r.data_criacao||'').slice(0,10)}</div>
      <div class="client">${r.nomeContratante||''}</div>
    `;
    div.addEventListener('click', ()=> openModal(r.codigo||'', r.nomeContratante||''));
    return div;
  }
  function render(items){
    listEl.innerHTML='';
    if(!items || !items.length){
      listEl.innerHTML = '<div class="empty">Sem registros.</div>';
      return;
    }
    items.forEach(r=> listEl.appendChild(row(r)));
  }

  async function fetchJSON(url){
    const r = await fetch(url, { cache:'no-store' });
    return await r.json().catch(()=>null);
  }
  async function fetchList(){
    const u = `${JSON_URL}?op=list${SAVE_TOKEN?('&token='+encodeURIComponent(SAVE_TOKEN)):""}&t=${Date.now()}`;
    const j = await fetchJSON(u);
    return (j && j.ok) ? (j.items||[]) : [];
  }
  async function fetchGet(codigo){
    const u = `${JSON_URL}?op=get&codigo=${encodeURIComponent(codigo)}${SAVE_TOKEN?('&token='+encodeURIComponent(SAVE_TOKEN)):""}&t=${Date.now()}`;
    const j = await fetchJSON(u);
    return (j && j.ok) ? j.item : null;
  }

  function openModal(code, nome){
    $('#mcode').textContent = (code||'').toUpperCase();
    $('#mcode').setAttribute('data-nome', nome||'');
    showBack(true);

    $('#x').onclick = () => showBack(false);
    $('#btnFechar').onclick = () => showBack(false);
    $('#btnAtualizar').onclick = () => {
      const c = encodeURIComponent(($('#mcode').textContent||'').trim());
      window.parent.postMessage({ type: 'impar:doc', action: 'update', item }, '*');	
      //window.open('/documentos/index.html?codigo='+c, '_blank');
    };
    $('#btnGerarContrato').onclick = () => gerar('make_contract_json.php', TPL_CONTRATO);
    $('#btnGerarOS').onclick       = () => gerar('make_contract_json.php', TPL_OS);
  }

  async function gerar(php, template){
    const code = ($('#mcode').textContent||'').trim();
    const nome = ($('#mcode').getAttribute('data-nome')||'').trim();
    if(!code){ showBack(false); return; }

    setLoader(true);
    try{
      const url = `${API_BASE}/${php}?codigo=${encodeURIComponent(code)}&template=${encodeURIComponent(template)}&t=${Date.now()}`;
      const res = await fetch(url, { cache:'no-store' });
      if (!res.ok) { alert('Erro ao gerar documento.'); return; }

      const blob = await res.blob();
      // define prefixo pelo template
      const prefix = template.includes('OS') ? 'O.S.' : 'Contrato';
      let fname = `${prefix}-${code}`;
      if (nome) fname += `-${nome}`;
      fname = fname.replace(/[\\/:*?"<>|]+/g,'').trim() + '.docx';

      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
      toast('Gerado com sucesso!');
    }catch(e){
      console.error(e);
      alert('Erro de rede durante a geração.');
    }finally{
      setLoader(false);
      showBack(false);
    }
  }

  $('#btnListarTodos').addEventListener('click', async ()=>{
    setLoader(true);
    try{ render(await fetchList()); } finally{ setLoader(false); }
  });

  $('#btnListar').addEventListener('click', async ()=>{
    const c = ($('#codigo').value||'').trim();
    if(!c){ $('#btnListarTodos').click(); return; }
    setLoader(true);
    try{ const item = await fetchGet(c); render(item ? [item] : []); }
    finally{ setLoader(false); }
  });

  $('#btnListarTodos').click();

  function toast(msg){
    const box = document.createElement('div');
    box.style.cssText = `
      position:fixed;right:16px;bottom:16px;z-index:1200;
      background:#0f172a;color:#22c55e;border:1px solid #22c55e;
      padding:10px 14px;border-radius:10px;font-weight:700;
      box-shadow:0 8px 24px rgba(0,0,0,.35)
    `;
    box.textContent = msg;
    document.body.appendChild(box);
    setTimeout(()=> box.remove(), 1800);
  }
})();
</script>


<script>
(function(){
  // tenta detectar clique no botão/ação "Atualizar" e envia o código selecionado ao parent
  function getCodigoSelecionado(root){
    var el = root.querySelector('input[name="codigo"]:checked');
    if(el && el.value) return el.value;
    el = root.querySelector('[data-codigo-selecionado]'); if(el) return el.getAttribute('data-codigo-selecionado');
    el = root.querySelector('.selecionado,[aria-selected="true"], .active'); if(el){ var v = el.getAttribute('data-codigo')||el.textContent; if(v) return v.trim(); }
    el = root.querySelector('#codigoSelecionado, input[id*="codigo"], input[name*="codigo"]'); if(el && el.value) return el.value.trim();
    el = root.querySelector('a[href*="codigo="]'); if(el){ try { return new URL(el.href).searchParams.get('codigo'); } catch(e){} }
    return null;
  }
  var root = document;
  root.addEventListener('click', function(e){
    var t=e.target;
    while(t && t!==root){
      if(t.matches('[data-acao="atualizar"], button, a, input[type="submit"]')){
        var txt=(t.innerText||t.value||'').toLowerCase();
        if(txt.includes('atualizar') || t.getAttribute('data-acao')==='atualizar'){
          e.preventDefault();
          var codigo = getCodigoSelecionado(root);
          if(!codigo){ alert('Selecione um código.'); return; }
          try{
            parent.postMessage({type:'pesquisa:atualizar', codigo: codigo}, '*');
          }catch(err){ console.error(err); }
          return false;
        }
      }
      t=t.parentElement;
    }
  });
})();
</script>


<script>
(function(){
  // Guarda o último código clicado na lista
  var __codigoSelecionado = null;

  function setSelecionado(cod){
    if(!cod) return;
    __codigoSelecionado = String(cod).trim();
    // marca visual (quando houver)
    try{
      document.querySelectorAll('[data-codigo].selecionado').forEach(el=>el.classList.remove('selecionado'));
      var el = document.querySelector('[data-codigo="'+__codigoSelecionado+'"]');
      if(el) el.classList.add('selecionado');
    }catch(e){}
  }

  function extractCodigoFromNode(n){
    if(!n) return null;
    if(n.getAttribute){
      var d = n.getAttribute('data-codigo'); if(d) return d;
      var h = n.getAttribute('href'); if(h && h.indexOf('codigo=')>-1){ try{ return new URL(h, location.href).searchParams.get('codigo'); }catch(e){} }
    }
    var txt = (n.innerText||n.textContent||'').trim();
    // regex: AC##### opcional sufixo
    var m = txt.match(/[A-Z]{2}\d{5}[A-Z0-9]*/);
    if(m) return m[0];
    return null;
  }

  // Click numa linha/anchor -> seleciona código
  document.addEventListener('click', function(e){
    var t=e.target;
    // Clique em "Voltar para etapas"
    if(t.matches('a,button') && ((t.innerText||t.value||'').toLowerCase().includes('voltar para etapas'))){
      e.preventDefault();
      try{ parent.postMessage({type:'pesquisa:voltar'}, '*'); }catch(err){}
      return;
    }
    // Clique em "Fechar" (se existir no conteúdo)
    if(t.id==='fecharPesquisa' || ((t.innerText||'').trim().toLowerCase()==='fechar' && t.closest('#conteudo-pesquisa'))){
      e.preventDefault();
      try{ parent.postMessage({type:'pesquisa:fechar'}, '*'); }catch(err){}
      return;
    }

    // Seleção de código por clique em linha/anchor
    var n=t;
    while(n && n!==document.body){
      if(n.hasAttribute && (n.hasAttribute('data-codigo') || n.tagName==='A' || n.classList.contains('linha') || n.classList.contains('row'))){
        var cod = extractCodigoFromNode(n);
        if(cod){ setSelecionado(cod); }
        break;
      }
      n = n.parentElement;
    }
  }, true);

  // Clique em "Atualizar" -> envia o código selecionado para o Index
  document.addEventListener('click', function(e){
    var t=e.target;
    while(t && t!==document.body){
      if(t.matches('[data-acao="atualizar"], button, a, input[type="submit"]')){
        var label=(t.innerText||t.value||'').toLowerCase();
        if(label.includes('atualizar') || t.getAttribute('data-acao')==='atualizar'){
          e.preventDefault();
          var cod = __codigoSelecionado;
          if(!cod){
            // tenta extrair do próprio botão ou vizinhança
            cod = extractCodigoFromNode(t) || extractCodigoFromNode(document.querySelector('.selecionado')) || extractCodigoFromNode(document);
          }
          if(!cod){ alert('Selecione um código na lista antes de atualizar.'); return; }
          try{ parent.postMessage({type:'pesquisa:atualizar', codigo: cod}, '*'); }catch(err){ console.error(err); }
          return false;
        }
      }
      t=t.parentElement;
    }
  });
})();
</script>

</body>
</html>
