<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicita√ß√£o de Materiais - ERP √çmpar</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
  <script>
    (function(){
      emailjs.init("WddODLBw11FUrjP-q"); // Public Key do EmailJS
    })();
  </script>
</head>
<body>
  <div class="solicitacao-container">
    <h2>Solicita√ß√£o de Materiais</h2>
    <form id="solicitacaoForm">
      
      <label for="obra">Obra:</label>
      <select id="obra" required>
        <option value="">Selecione a obra...</option>
      </select>

      <label for="material">Material:</label>
      <select id="material" required>
        <option value="">Selecione o material...</option>
      </select>

      <label for="quantidade">Quantidade:</label>
      <input type="number" id="quantidade" min="1" inputmode="numeric" required>

      <label for="data">Prazo limite de entrega:</label>
      <input type="date" id="data" required>

      <button type="submit">Enviar Solicita√ß√£o</button>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const obraSelect = document.getElementById('obra');
      const materialSelect = document.getElementById('material');

      try {
        console.debug("üîÑ Carregando obras.json...");
        const obrasResponse = await fetch('obras.json');
        if (!obrasResponse.ok) throw new Error('Erro HTTP obras: ' + obrasResponse.status);
        const obras = await obrasResponse.json();
        console.debug("‚úÖ Obras carregadas:", obras);

        obras.forEach(o => {
          const option = document.createElement('option');
          option.value = `${o.Obra} (${o['Centro de Custo']})`;
          option.textContent = `${o.Obra} (${o['Centro de Custo']})`;
          obraSelect.appendChild(option);
        });

        console.debug("üìã Combo de obras preenchido.");

        console.debug("üîÑ Carregando materiais.json...");
        const materiaisResponse = await fetch('materiais.json');
        if (!materiaisResponse.ok) throw new Error('Erro HTTP materiais: ' + materiaisResponse.status);
        const materiais = await materiaisResponse.json();
        console.debug("‚úÖ Materiais carregados:", materiais);

        materiais
          .sort((a, b) => a.Material.localeCompare(b.Material))
          .forEach(m => {
            const option = document.createElement('option');
            option.value = m.Material;
            option.textContent = `${m.Material} (${m.UND})`;
            materialSelect.appendChild(option);
          });

        console.debug("üìã Combo de materiais preenchido.");
      } catch (error) {
        console.error("üö® Erro ao carregar dados:", error);
        alert('Falha ao carregar dados de obras ou materiais.');
      }

      document.getElementById('solicitacaoForm').addEventListener('submit', function(e) {
        e.preventDefault();
        console.debug("‚û°Ô∏è Enviando solicita√ß√£o...");

        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        if (!usuarioLogado) {
          console.error("üö® Nenhum usu√°rio logado encontrado no localStorage.");
          alert('Erro: Nenhum usu√°rio logado.');
          return;
        }

        const templateParams = {
          usuario: usuarioLogado.Nome,
          from_email: usuarioLogado.Email,
          obra: obraSelect.value,
          material: materialSelect.value,
          quantidade: document.getElementById('quantidade').value,
          data: document.getElementById('data').value
        };

        console.debug("üì¶ Dados enviados ao EmailJS:", templateParams);

        emailjs.send("default_service", "template_solicitacao", templateParams)
          .then(() => {
            console.debug("‚úÖ Solicita√ß√£o enviada via EmailJS!");
            alert('E-mail com o relat√≥rio de compras enviado com sucesso!');
            document.getElementById('solicitacaoForm').reset();
          }, (error) => {
            console.error("üö® Erro ao enviar EmailJS:", error);
            alert('Erro ao enviar solicita√ß√£o. Tente novamente.');
          });
      });
    });
  </script>
</body>
</html>
