<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicita√ß√£o de Materiais - ERP √çmpar</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
  <script>
    (function(){
      emailjs.init("WddODLBw11FUrjP-q"); // Sua public key
    })();
  </script>
  <style>
    /* Estilo extra para popups e lista */
    .popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      display: none;
      z-index: 1000;
      animation: fadeIn 0.4s ease;
    }
    .popup.error {
      background: #dc3545;
    }
    .materiais-lista {
      margin-top: 20px;
      text-align: left;
    }
    .materiais-lista table {
      width: 100%;
      border-collapse: collapse;
    }
    .materiais-lista th, .materiais-lista td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    .materiais-lista th {
      background: #f8f9fa;
      font-weight: bold;
    }
    .btn-remover {
      color: red;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="solicitacao-container">
    <h2>Solicita√ß√£o de Materiais</h2>
    <form id="solicitacaoForm">
      
      <label for="obra">Obra:</label>
      <select id="obra" required>
        <option value="">Selecione a obra...</option>
      </select>

      <label for="localEntrega">Local de Entrega:</label>
      <select id="localEntrega" required>
        <option value="">Selecione...</option>
        <option value="Impar">Impar</option>
        <option value="Cliente">Cliente</option>
      </select>

      <label for="material">Material:</label>
      <select id="material" required>
        <option value="">Selecione o material...</option>
      </select>

      <label for="quantidade">Quantidade:</label>
      <input type="number" id="quantidade" min="1" inputmode="numeric" required>

      <label for="data">Prazo limite de entrega:</label>
      <input type="date" id="data" required>

      <button type="button" id="adicionarBtn">Adicionar Material</button>

      <div class="materiais-lista" id="materiaisLista">
        <h3>Materiais Adicionados</h3>
        <table>
          <thead>
            <tr>
              <th>Material</th>
              <th>UND</th>
              <th>Quantidade</th>
              <th>A√ß√£o</th>
            </tr>
          </thead>
          <tbody id="listaMateriaisBody"></tbody>
        </table>
      </div>

      <button type="submit">Enviar Solicita√ß√£o</button>
    </form>
  </div>

  <div id="popup" class="popup"></div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const obraSelect = document.getElementById('obra');
      const materialSelect = document.getElementById('material');
      const listaMateriaisBody = document.getElementById('listaMateriaisBody');
      const popup = document.getElementById('popup');
      let materiaisSelecionados = [];

      function mostrarPopup(msg, isError=false) {
        popup.textContent = msg;
        popup.className = 'popup' + (isError ? ' error' : '');
        popup.style.display = 'block';
        setTimeout(() => popup.style.display = 'none', 4000);
      }

      try {
        console.debug("üîÑ Carregando obras.json...");
        const obrasResponse = await fetch('obras.json');
        const obras = await obrasResponse.json();
        obras.forEach(o => {
          const option = document.createElement('option');
          option.value = o.Obra;
          option.textContent = `${o.Obra} (${o['Centro de Custo']})`;
          obraSelect.appendChild(option);
        });

        console.debug("üîÑ Carregando materiais.json...");
        const materiaisResponse = await fetch('materiais.json');
        const materiais = await materiaisResponse.json();
        materiais.sort((a, b) => a.Material.localeCompare(b.Material));
        materiais.forEach(m => {
          const option = document.createElement('option');
          option.value = JSON.stringify(m);
          option.textContent = `${m.Material} (${m.UND})`;
          materialSelect.appendChild(option);
        });

        document.getElementById('adicionarBtn').addEventListener('click', () => {
          const materialObj = JSON.parse(materialSelect.value || '{}');
          const quantidade = document.getElementById('quantidade').value;

          if (!materialObj.Material || !quantidade) {
            mostrarPopup("Selecione material e informe a quantidade!", true);
            return;
          }

          materiaisSelecionados.push({
            Material: materialObj.Material,
            UND: materialObj.UND,
            Quantidade: quantidade
          });

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${materialObj.Material}</td>
            <td>${materialObj.UND}</td>
            <td>${quantidade}</td>
            <td><span class="btn-remover">‚ùå</span></td>
          `;
          row.querySelector('.btn-remover').addEventListener('click', () => {
            row.remove();
            materiaisSelecionados = materiaisSelecionados.filter(m => m.Material !== materialObj.Material);
          });
          listaMateriaisBody.appendChild(row);
          mostrarPopup("Material adicionado com sucesso!");
        });

        document.getElementById('solicitacaoForm').addEventListener('submit', function(e) {
          e.preventDefault();

          const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
          if (!usuarioLogado) {
            mostrarPopup("Erro: Nenhum usu√°rio logado.", true);
            return;
          }

          if (materiaisSelecionados.length === 0) {
            mostrarPopup("Adicione pelo menos um material!", true);
            return;
          }

          const templateParams = {
            usuario: usuarioLogado.Nome,
            from_email: usuarioLogado.Email,
            obra: obraSelect.value,
            localEntrega: document.getElementById('localEntrega').value,
            data: document.getElementById('data').value,
            materiais: JSON.stringify(materiaisSelecionados, null, 2)
          };

          console.debug("üì¶ Dados enviados ao EmailJS:", templateParams);

          emailjs.send("service_SEU_ID", "template_SEU_ID", templateParams)
            .then(() => {
              mostrarPopup("E-mail com o relat√≥rio de compras enviado com sucesso!");
              document.getElementById('solicitacaoForm').reset();
              listaMateriaisBody.innerHTML = "";
              materiaisSelecionados = [];
            }, (error) => {
              console.error("üö® Erro ao enviar EmailJS:", error);
              mostrarPopup("Erro ao enviar solicita√ß√£o. Verifique os dados.", true);
            });
        });

      } catch (error) {
        console.error("üö® Erro ao carregar dados:", error);
        mostrarPopup("Falha ao carregar dados de obras ou materiais.", true);
      }
    });
  </script>
</body>
</html>
