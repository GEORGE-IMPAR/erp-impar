<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP ÍMPAR — Consulta de Preços</title>

  <style>
    :root{
      --bg1:#061a35;
      --bg2:#0b2a52;
      --bg3:#0c6f6a;
      --card:#071c2fdd;
      --stroke:#1a3a58;
      --text:#e9f6ff;
      --muted:#b7d4e6;
      --green:#19ff7b;
      --green2:#00d86a;
      --red:#ff3d3d;
      --orange:#ffb35c;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Candara, "Segoe UI", Tahoma, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 25% 10%, rgba(63, 130, 255, .18), transparent 60%),
                  radial-gradient(900px 500px at 85% 30%, rgba(25, 255, 123, .10), transparent 55%),
                  linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 45%, var(--bg3) 100%);
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1220px;
      margin: 26px auto 36px;
      padding: 0 18px;
    }

    /* Header ÍMPAR */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 16px 18px;
      border:1px solid rgba(120,190,255,.18);
      background: linear-gradient(180deg, rgba(6,26,53,.72), rgba(6,26,53,.25));
      border-radius: 16px;
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 280px;
    }
    .logoDot{
      width:34px;height:34px;border-radius:50%;
      background: conic-gradient(from 210deg, #4bd6ff, #28ff8a, #ffd56a, #4bd6ff);
      box-shadow: 0 0 0 3px rgba(255,255,255,.10), 0 10px 25px rgba(0,0,0,.35);
    }
    .brandTxt .kicker{
      font-size:12px;
      letter-spacing:.20em;
      opacity:.85;
    }
    .brandTxt .title{
      font-size:18px;
      font-weight:700;
      margin-top:2px;
    }
    .brandTxt .sub{
      font-size:12px;
      color:rgba(233,246,255,.78);
      margin-top:2px;
    }

    .pillBtn{
      appearance:none;
      border:1px solid rgba(120,255,190,.25);
      background: linear-gradient(180deg, rgba(25,255,123,.95), rgba(0,216,106,.88));
      color:#042013;
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 800;
      letter-spacing:.04em;
      cursor:pointer;
      box-shadow: 0 10px 25px rgba(0,0,0,.35), 0 0 25px rgba(25,255,123,.22);
      transition: transform .08s ease, filter .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .pillBtn:hover{filter: brightness(1.02)}
    .pillBtn:active{transform: translateY(1px) scale(.995)}
    .pillBtn.secondary{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      color: var(--text);
      border:1px solid rgba(150,210,255,.18);
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }

    /* Card principal */
    .card{
      margin-top: 16px;
      border-radius: 18px;
      border:1px solid rgba(120,190,255,.18);
      background: linear-gradient(180deg, rgba(7, 28, 47, .82), rgba(7, 28, 47, .45));
      box-shadow: 0 22px 55px rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .cardHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 16px 18px;
      border-bottom: 1px solid rgba(120,190,255,.14);
      gap:12px;
      flex-wrap:wrap;
    }

    .searchRow{
      display:flex;
      align-items:center;
      gap: 12px;
      width: 100%;
    }
    .search{
      flex: 1;
      min-width: 280px;
      padding: 12px 14px;
      border-radius: 12px;
      border:1px solid rgba(25,255,123,.45);
      outline:none;
      color: var(--text);
      background: rgba(2, 12, 24, .55);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.35), 0 0 0 3px rgba(25,255,123,.06);
    }
    .search:focus{
      border-color: rgba(25,255,123,.75);
      box-shadow: 0 0 0 3px rgba(25,255,123,.14), inset 0 0 0 1px rgba(0,0,0,.35);
    }

    .kpis{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }
    .kpi{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(150,210,255,.16);
      background: rgba(2, 12, 24, .35);
      min-width: 180px;
    }
    .kpi .lbl{font-size:11px; opacity:.85; letter-spacing:.10em}
    .kpi .val{margin-top:2px; font-size:14px; font-weight:800}

    /* Tabela */
    table{
      width:100%;
      border-collapse: collapse;
    }
    th, td{
      padding: 14px 14px;
      border-bottom: 1px solid rgba(120,190,255,.12);
      font-size: 14px;
    }
    th{
      text-align:left;
      color: rgba(233,246,255,.85);
      font-size: 12px;
      letter-spacing:.12em;
      text-transform: uppercase;
      opacity:.95;
    }
    tbody tr:hover{
      background: rgba(25,255,123,.04);
    }
    .muted{color: rgba(233,246,255,.72)}
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(150,210,255,.16);
      background: rgba(2, 12, 24, .35);
      font-size: 12px;
      font-weight: 800;
    }
    .tag.ok{border-color: rgba(25,255,123,.28)}
    .tag.warn{border-color: rgba(255,179,92,.30)}
    .tag.err{border-color: rgba(255,61,61,.35)}

    .miniBtn{
      appearance:none;
      border: 1px solid rgba(120,190,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.02em;
    }
    .miniBtn:hover{background: rgba(255,255,255,.08)}
    .miniBtn:active{transform: translateY(1px)}

    .rowEmpty{
      text-align:center;
      padding: 22px 14px;
      color: rgba(233,246,255,.75);
    }
    .rowErr{
      text-align:center;
      padding: 18px 14px;
      color: rgba(255,180,180,.95);
    }

    /* Rodapé */
    .foot{
      margin-top: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color: rgba(233,246,255,.60);
      font-size: 12px;
      padding: 0 6px;
    }
    .ver{
      opacity:.75;
      letter-spacing:.10em;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .modal{
      width:min(920px, 100%);
      border-radius: 16px;
      border:1px solid rgba(120,190,255,.18);
      background: linear-gradient(180deg, rgba(7, 28, 47, .92), rgba(7, 28, 47, .60));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(120,190,255,.14);
      gap:10px;
    }
    .modalTitle{
      font-weight:900;
      letter-spacing:.02em;
    }
    .modalBody{
      padding: 14px 16px;
      max-height: 70vh;
      overflow:auto;
    }
    pre{
      margin:0;
      padding: 12px;
      border-radius: 12px;
      background: rgba(2, 12, 24, .55);
      border: 1px solid rgba(150,210,255,.16);
      color: rgba(233,246,255,.92);
      overflow:auto;
    }

    @media (max-width: 900px){
      .brand{min-width:auto}
      .kpi{min-width: 160px}
      th:nth-child(4), td:nth-child(4){display:none} /* esconde datas no mobile se quiser */
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logoDot" aria-hidden="true"></div>
        <div class="brandTxt">
          <div class="kicker">PLATAFORMA</div>
          <div class="title">ERP ÍMPAR</div>
          <div class="sub">Consulta de Preços • Pricing / Cotações</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button class="pillBtn secondary" id="btnDocs">Gerador de Documentos</button>
        <button class="pillBtn secondary" id="btnMenu">Menu principal</button>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="searchRow">
          <input id="q" class="search" placeholder="Buscar por obra, código, status ou ID (ex: OBRA_001, Q-2026...)" />
          <button class="pillBtn" id="btnRefresh">Atualizar</button>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="lbl">TOTAL (retorno)</div>
            <div class="val" id="kpiTotal">—</div>
          </div>
          <div class="kpi">
            <div class="lbl">ÚLTIMA ATUALIZAÇÃO</div>
            <div class="val" id="kpiTime">—</div>
          </div>
          <div class="kpi">
            <div class="lbl">STATUS API</div>
            <div class="val" id="kpiStatus">—</div>
          </div>
        </div>
      </div>

      <div style="width:100%; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="min-width:210px;">ID</th>
              <th style="min-width:140px;">Obra</th>
              <th style="min-width:90px;">Itens</th>
              <th style="min-width:220px;">Atualizado</th>
              <th style="min-width:140px;">Status</th>
              <th style="min-width:120px;">Ação</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td class="rowEmpty" colspan="6">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="foot">
      <div>© 2026 ERP ÍMPAR • Pricing</div>
      <div class="ver">v1.0 • layout ÍMPAR</div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle" id="modalTitle">Detalhes</div>
        <button class="miniBtn" id="btnClose">Fechar</button>
      </div>
      <div class="modalBody">
        <pre id="modalPre">{}</pre>
      </div>
    </div>
  </div>

<script>
  // ====== Caminho A: chave fixa no front (para apresentação interna) ======
  const API_BASE = "https://api.erpimpar.com.br/pricing";
  const API_KEY  = "IMP4R_CHAVE_FIXA_TESTE_123";
  const DEFAULT_LIMIT = 50;

  const els = {
    q: document.getElementById("q"),
    tbody: document.getElementById("tbody"),
    kpiTotal: document.getElementById("kpiTotal"),
    kpiTime: document.getElementById("kpiTime"),
    kpiStatus: document.getElementById("kpiStatus"),
    btnRefresh: document.getElementById("btnRefresh"),
    btnMenu: document.getElementById("btnMenu"),
    btnDocs: document.getElementById("btnDocs"),
    modalBack: document.getElementById("modalBack"),
    modalTitle: document.getElementById("modalTitle"),
    modalPre: document.getElementById("modalPre"),
    btnClose: document.getElementById("btnClose"),
  };

  function fmtMoneyBR(v){
    if (v === null || v === undefined || isNaN(v)) return "—";
    return Number(v).toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
  }

  function fmtDateBR(iso){
    if (!iso) return "—";
    try {
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleString("pt-BR");
    } catch { return iso; }
  }

  function statusTag(s){
    const txt = (s || "").toString().toLowerCase();
    if (txt.includes("complete") || txt.includes("ok")) return { cls:"ok", label:s || "ok" };
    if (txt.includes("pend") || txt.includes("proc")) return { cls:"warn", label:s || "pending" };
    if (!s) return { cls:"warn", label:"—" };
    return { cls:"warn", label:s };
  }

  function setLoadingRow(text){
    els.tbody.innerHTML = `<tr><td class="rowEmpty" colspan="6">${text}</td></tr>`;
  }

  function setErrorRow(msg){
    els.tbody.innerHTML = `<tr><td class="rowErr" colspan="6">❌ ${msg}</td></tr>`;
  }

  async function apiFetch(path){
    const url = API_BASE + path;
    const res = await fetch(url, {
      method: "GET",
      headers: {
        "X-API-KEY": API_KEY,
        "Content-Type": "application/json"
      }
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=> "");
      const err = new Error("http_" + res.status);
      err.status = res.status;
      err.body = txt;
      throw err;
    }

    return res.json();
  }

  function openModal(title, obj){
    els.modalTitle.textContent = title;
    els.modalPre.textContent = JSON.stringify(obj, null, 2);
    els.modalBack.style.display = "flex";
  }

  function closeModal(){
    els.modalBack.style.display = "none";
  }

  function renderRows(rows){
    if (!rows || rows.length === 0){
      els.tbody.innerHTML = `<tr><td class="rowEmpty" colspan="6">Nenhuma cotação encontrada.</td></tr>`;
      return;
    }

    els.tbody.innerHTML = rows.map(r => {
      const t = statusTag(r.status);
      return `
        <tr>
          <td><strong>${r.quote_id || "—"}</strong><div class="muted" style="font-size:12px;margin-top:3px;">${r.file || ""}</div></td>
          <td>${r.obra_id || "—"}</td>
          <td>${(r.items_count ?? "—")}</td>
          <td>${fmtDateBR(r.updated_at || r.created_at)}</td>
          <td><span class="tag ${t.cls}">${t.label}</span></td>
          <td>
            <button class="miniBtn" data-view='${encodeURIComponent(JSON.stringify(r))}'>Ver</button>
          </td>
        </tr>
      `;
    }).join("");

    // bind botões "Ver"
    els.tbody.querySelectorAll("button[data-view]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const payload = JSON.parse(decodeURIComponent(btn.getAttribute("data-view")));
        openModal(`Cotação: ${payload.quote_id || "Detalhes"}`, payload);
      });
    });
  }

  async function loadQuotes(){
    setLoadingRow("Carregando...");
    els.kpiStatus.textContent = "consultando...";
    const q = (els.q.value || "").trim();

    try{
      const data = await apiFetch(`/list_quotes.php?limit=${DEFAULT_LIMIT}&q=${encodeURIComponent(q)}`);
      renderRows(data.data || []);
      els.kpiTotal.textContent = String(data.total ?? (data.data || []).length);
      els.kpiTime.textContent = new Date().toLocaleString("pt-BR");
      els.kpiStatus.textContent = "ok";
    } catch(e){
      console.error(e);
      const status = e.status || "";
      if (status === 401) {
        setErrorRow("API não autorizada (401). Confere a chave fixa no HTML e no PHP.");
        els.kpiStatus.textContent = "401";
      } else {
        setErrorRow("Falha ao consultar a API. Veja o console (F12).");
        els.kpiStatus.textContent = "erro";
      }
    }
  }

  // Eventos
  els.btnRefresh.addEventListener("click", loadQuotes);
  els.q.addEventListener("keydown", (ev)=>{ if (ev.key === "Enter") loadQuotes(); });

  els.btnClose.addEventListener("click", closeModal);
  els.modalBack.addEventListener("click", (ev)=>{ if (ev.target === els.modalBack) closeModal(); });

  els.btnMenu.addEventListener("click", ()=>{ window.location.href = "/index.html"; });
  els.btnDocs.addEventListener("click", ()=>{ window.location.href = "/documentos/index.html"; });

  // boot
  loadQuotes();
</script>
</body>
</html>
