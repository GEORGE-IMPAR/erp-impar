<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ERP √çMPAR ‚Äî Consulta de Pre√ßos</title>
  <style>
    :root {
      --bg1:#061227;
      --bg2:#0b2a44;
      --bg3:#0f6d73;
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --good:#19c37d;
      --warn:#ffb020;
      --bad:#ff4d4f;
      --blue:#2b7cff;
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --r: 18px;
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family: Candara, "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 25% 15%, rgba(24,122,255,.20), transparent 55%),
                  radial-gradient(1100px 700px at 75% 25%, rgba(25,195,125,.14), transparent 55%),
                  linear-gradient(120deg, var(--bg1), var(--bg2) 45%, var(--bg3));
      overflow-x:hidden;
    }

    .wrap{max-width:1220px;margin:26px auto;padding:0 18px;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:18px 18px;border:1px solid var(--stroke);border-radius:var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:240px;}
    
         /* --- √çMPAR Premium: logo orb no header --- */
     .logo-orb{
      width:36px;height:36px;border-radius:999px;
      position:relative;
      background: conic-gradient(from 210deg,
        #22c55e,
        #06b6d4,
        #3b82f6,
        #a855f7,
        #f97316,
        #22c55e);
      box-shadow:
        0 10px 22px rgba(0,0,0,.35),
        0 0 0 1px rgba(255,255,255,.18) inset;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logo-orb:before{
      content:"";
      position:absolute; inset:-6px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 55%);
      filter: blur(0.2px);
    }
    .logo-orb:after{
      content:"";
      position:absolute; inset:-14px;
      background: radial-gradient(circle at 50% 50%, rgba(34,197,94,.35), transparent 65%);
      filter: blur(10px);
      opacity:.7;
    }

    .logo{
      width:44px;height:44px;border-radius:14px;
      background: conic-gradient(from 90deg, #29d2ff, #2b7cff, #19c37d, #ffb020, #29d2ff);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    .brand h1{font-size:15px;line-height:1.2;margin:0;letter-spacing:.2px;}
    .brand small{display:block;color:var(--muted);margin-top:2px;font-size:12px;}
    .userpill{margin-left:auto;display:flex;align-items:center;gap:10px;color:var(--muted);}
    .userpill .dot{width:10px;height:10px;border-radius:50%;background:var(--good);box-shadow:0 0 0 4px rgba(25,195,125,.14);}
    .userpill b{color:var(--text);font-weight:700;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .btn{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.15);
      color: var(--text);
      padding:10px 14px;border-radius:14px;
      cursor:pointer; user-select:none;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
      font-weight:700; letter-spacing:.2px;
    }
    .btn:hover{transform: translateY(-1px);box-shadow:0 14px 30px rgba(0,0,0,.25);border-color:rgba(255,255,255,.18)}
    .btn:active{transform: translateY(0)}
    .btn.green{background: linear-gradient(180deg, rgba(25,195,125,.95), rgba(13,140,92,.95)); border-color: rgba(25,195,125,.35); box-shadow: 0 18px 30px rgba(25,195,125,.16);}
    .btn.blue{background: linear-gradient(180deg, rgba(43,124,255,.95), rgba(20,80,190,.95)); border-color: rgba(43,124,255,.35); box-shadow: 0 18px 30px rgba(43,124,255,.16);}
    .btn.ghost{background: rgba(255,255,255,.04);}
    .btn.small{padding:8px 12px;border-radius:12px;font-size:12px;}
    .btn.glow{position:relative;overflow:hidden}
    .btn.glow::after{
      content:"";position:absolute;inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 55%);
      opacity:.0;transform: translateX(-12%);
      transition: opacity .18s ease, transform .18s ease;
    }
    .btn.glow:hover::after{opacity:.9;transform: translateX(0);}

    .grid{display:grid;grid-template-columns: 1.15fr .85fr; gap:16px; margin-top:16px;}
    @media(max-width:1020px){ .grid{grid-template-columns:1fr;} }

    .card{
      border:1px solid var(--stroke);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding:16px;
    }
    .card h2{margin:0 0 8px;font-size:14px;letter-spacing:.2px;}
    .muted{color:var(--muted);}
    .row{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;}
    .field{flex:1;min-width:180px;}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px;}
    input, select{
      width:100%; box-sizing:border-box;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding:12px 12px; border-radius: 14px;
      outline:none;
      transition:border-color .12s ease, box-shadow .12s ease, transform .12s ease;
    }
    input:focus, select:focus{border-color: rgba(43,124,255,.55); box-shadow:0 0 0 4px rgba(43,124,255,.18);}
    .input-ok{border-color: rgba(25,195,125,.55)!important; box-shadow:0 0 0 4px rgba(25,195,125,.16)!important;}
    .input-error{border-color: rgba(255,77,79,.65)!important; box-shadow:0 0 0 4px rgba(255,77,79,.16)!important;}
    .shake{animation: imparShake .35s ease-in-out 1;}
    @keyframes imparShake {
      0%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      50%{transform:translateX(6px)}
      75%{transform:translateX(-4px)}
      100%{transform:translateX(0)}
    }

    .drop{
      border:1.5px dashed rgba(255,255,255,.18);
      border-radius: var(--r);
      padding:16px;
      background: rgba(0,0,0,.14);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .drop b{font-size:13px;}
    .hint{font-size:12px;color:var(--muted);line-height:1.35;}
    .table{
      width:100%; border-collapse: separate; border-spacing:0;
      overflow:hidden;border-radius:16px;border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      margin-top:12px;
    }
    .table th, .table td{padding:10px 10px;font-size:12px;border-bottom:1px solid rgba(255,255,255,.08);}
    .table th{text-align:left;color:rgba(255,255,255,.78);font-weight:800;letter-spacing:.2px;background: rgba(255,255,255,.04);}
    .table tr:last-child td{border-bottom:none;}
    .kpi{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px;}
    .tag{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.16);font-size:12px;color:var(--muted);}
    .tag.good{border-color: rgba(25,195,125,.35); color: rgba(205,255,234,.95);}
    .tag.warn{border-color: rgba(255,176,32,.35); color: rgba(255,240,210,.95);}
    .tag.bad{border-color: rgba(255,77,79,.35); color: rgba(255,220,220,.95);}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter: blur(8px);display:none;align-items:center;justify-content:center;padding:18px;z-index:50;}
    .modal-backdrop.on{display:flex;}
    .modal{
      width:min(1100px, 96vw);
      max-height: 86vh;
      overflow:auto;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(10,34,56,.92), rgba(6,20,35,.88));
      box-shadow: 0 30px 75px rgba(0,0,0,.55);
    }
    .modal-head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10);}
    .modal-title{display:flex;flex-direction:column;gap:2px;}
    .modal-title b{font-size:13px;}
    .modal-title small{font-size:12px;color:var(--muted);}
    .modal-body{padding:14px 16px;}
    .best{color: rgba(205,255,234,.95);}
    
  .storeLink{
    color: #e6f3ff;
    font-weight: 800;
    text-decoration: none;
    border-bottom: 1px dashed rgba(230,243,255,.35);
    padding-bottom: 1px;
  }
  .storeLink:hover{ border-bottom-color: rgba(255,255,255,.9); }
  .storeSub{
    display:block;
    font-size: 11px;
    opacity: .7;
    margin-top: 2px;
  }
.price{font-variant-numeric: tabular-nums;}
    a{color: rgba(180,220,255,.95);}
    a:hover{color: #fff;}
    .subtle{opacity:.85}

    /* Overlay + toast */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:60;background:rgba(0,0,0,.45);backdrop-filter: blur(8px);}
    .overlay.on{display:flex;}
    .overlay-card{border:1px solid rgba(255,255,255,.14);background:linear-gradient(180deg, rgba(10,34,56,.92), rgba(6,20,35,.88));border-radius:20px;box-shadow:0 30px 75px rgba(0,0,0,.55);padding:18px 18px;min-width:280px;}
    .spinner{width:28px;height:28px;border-radius:50%;border:3px solid rgba(255,255,255,.22);border-top-color: rgba(25,195,125,.9);animation: spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .overlay-row{display:flex;align-items:center;gap:12px;}
    .toast-wrap{position:fixed;right:14px;bottom:14px;display:flex;flex-direction:column;gap:10px;z-index:70;}
    .toast{display:flex;align-items:center;gap:10px;min-width:280px;max-width:min(520px, 92vw);
      border-radius:16px;padding:12px 12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.30);backdrop-filter: blur(10px);
      transform: translateY(10px);opacity:0;transition: all .18s ease;
      box-shadow:0 18px 45px rgba(0,0,0,.35);
    }
    .toast.in{transform: translateY(0);opacity:1;}
    .toast.out{transform: translateY(10px);opacity:0;}
    .toast-dot{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,.55);}
    .toast.info .toast-dot{background: rgba(43,124,255,.85);}
    .toast.ok .toast-dot{background: rgba(25,195,125,.90);}
    .toast.warn .toast-dot{background: rgba(255,176,32,.90);}
    .toast.err .toast-dot{background: rgba(255,77,79,.90);}
    .toast-msg{font-size:12px;color: rgba(255,255,255,.92);line-height:1.35;}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:rgba(255,255,255,.45);font-size:11px;}
  
/* ===== Premium modal goodies ===== */
.badge-src{
  display:inline-flex; align-items:center; gap:6px;
  padding:4px 10px; margin-left:8px;
  border-radius:999px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  color:rgba(229,231,235,.92);
  font-size:12px; font-weight:800; letter-spacing:.6px;
  text-transform:uppercase;
  box-shadow:0 6px 18px rgba(0,0,0,.25) inset;
}
.badge-src::before{
  content:"‚üê";
  opacity:.9;
}
.store-name{
  color:rgba(231,241,255,.95);
  font-weight:900;
  text-decoration:none;
  border-bottom:1px dashed rgba(120,200,255,.25);
}
.store-name:hover{ filter:brightness(1.12); border-bottom-color:rgba(120,200,255,.55); }
.iconLink{
  display:inline-flex; align-items:center; justify-content:center;
  width:26px; height:26px; margin-left:6px;
  border-radius:10px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  color:rgba(231,241,255,.92);
  text-decoration:none;
  transform:translateY(2px);
}
.iconLink:hover{ filter:brightness(1.15); transform:translateY(1px) scale(1.03); }
.bestPrice{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 10px;
  border-radius:14px;
  background:rgba(34,197,94,.10);
  border:1px solid rgba(34,197,94,.25);
  box-shadow: 0 0 0 1px rgba(34,197,94,.08), 0 12px 40px rgba(34,197,94,.10);
  font-weight:900;
}
.bestPrice .trophy{ filter:drop-shadow(0 6px 18px rgba(34,197,94,.25)); }
tr.row-best td{
  box-shadow: inset 0 0 0 1px rgba(34,197,94,.12);
  background: linear-gradient(90deg, rgba(34,197,94,.08), rgba(34,197,94,.02));
}
.tip{
  position:relative;
  cursor:help;
  border-bottom:1px dotted rgba(255,255,255,.25);
}
.tip:hover::after{
  content: attr(data-tip);
  position:absolute;
  left:0; top:calc(100% + 10px);
  min-width:260px;
  max-width:520px;
  z-index:9999;
  padding:12px 14px;
  border-radius:16px;
  background:rgba(8,15,24,.94);
  border:1px solid rgba(255,255,255,.12);
  box-shadow: 0 18px 60px rgba(0,0,0,.55);
  color:rgba(243,244,246,.96);
  font-size:13px;
  line-height:1.3;
  white-space:normal;
}
.tip:hover::before{
  content:"";
  position:absolute;
  left:18px; top:100%;
  width:0; height:0;
  border-left:10px solid transparent;
  border-right:10px solid transparent;
  border-bottom:10px solid rgba(8,15,24,.94);
  filter:drop-shadow(0 -1px 0 rgba(255,255,255,.10));
}
/* ===== /Premium modal goodies ===== */

</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo-orb"></div>
        <div>
          <h1>PLATAFORMA ERP √çMPAR</h1>
          <small>Consulta de Pre√ßos ‚Ä¢ CSV por obra ‚Ä¢ Ranking de ofertas</small>
        </div>
      </div>

      <div class="userpill" id="userPill">
        <span class="dot"></span>
        <div>
          <div><b id="userName">Usu√°rio</b></div>
          <div style="font-size:12px;color:var(--muted)" id="userEmail">‚Äî</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn ghost small" id="btnMenu">‚Üê Menu</button>
        <button class="btn blue glow" id="btnRefresh">Atualizar</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>1) Importar itens da obra (CSV)</h2>
        <div class="row">
          <div class="field">
            <label>Obra (obra_id)</label>
            <input id="obraId" placeholder="Ex.: OBRA_001" value="OBRA_001"/>
          </div>
          <div class="field" style="max-width:260px">
            <label>Origem do CSV</label>
            <select id="csvMode">
              <option value="upload">Upload do arquivo</option>
              <option value="sample">Usar exemplo (2 itens)</option>
            </select>
          </div>
        </div>

        <div class="drop" style="margin-top:12px">
          <div>
            <b>Arraste o CSV aqui</b>
            <div class="hint">Colunas: <b>codigo,produto</b> (ou descricao), <b>ncm</b>, <b>quantidade</b> (ou qtd). (opcional: un)</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
            <input id="csvFile" type="file" accept=".csv,text/csv" style="display:none"/>
            <button class="btn ghost small" id="btnPick">Selecionar CSV</button>
            <button class="btn ghost small" id="btnModel">Baixar modelo CSV</button>
          </div>
        </div>

        <div class="kpi">
          <span class="tag" id="kpiItems">Itens carregados: 0</span>
          <span class="tag" id="kpiApi">API: ‚Äî</span>
          <span class="tag" id="kpiLast">√öltima atualiza√ß√£o: ‚Äî</span>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn green glow" id="btnPreview">Carregar & Pr√©-visualizar</button>
          <button class="btn blue glow" id="btnCreate">Criar cota√ß√£o</button>
        </div>

        <table class="table" id="itemsTable">
          <thead>
            <tr>
              <th style="width:90px">C√≥digo</th>
              <th>EAN</th><th>Descri√ß√£o</th>
              <th style="width:70px">Qtd</th>
              <th style="width:90px">NCM</th>
              <th style="width:70px">UN</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="footer">
          <div>¬© 2026 ERP √çMPAR ‚Ä¢ Pricing</div>
          <div>v3.0 ‚Ä¢ layout √çMPAR Premium</div>
        </div>
      </div>

      <div class="card">
        <h2>2) Consultar cota√ß√µes</h2>

        <div class="row">
          <div class="field">
            <label>Buscar</label>
            <input id="q" placeholder="Buscar por obra, c√≥digo, status ou ID (ex: OBRA_001, Q-2026...)" />
          </div>
          <div style="min-width:140px">
            <button class="btn blue glow" id="btnSearch">Consultar</button>
          </div>
        </div>

        <table class="table" id="quotesTable">
          <thead>
            <tr>
              <th style="width:160px">ID</th>
              <th style="width:120px">Obra</th>
              <th style="width:70px">Itens</th>
              <th style="width:110px">Total (melhor)</th>
              <th style="width:120px">Status</th>
              <th style="width:90px">A√ß√£o</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="hint" style="margin-top:10px">
          Dica: clique em <b>Ver</b> para abrir o detalhe com ranking de ofertas (melhor, 2¬∫, 3¬∫) e total por item (pre√ßo √ó quantidade).
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalBack">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">
          <b id="modalTitle">Detalhe da cota√ß√£o</b>
          <small id="modalSub">‚Äî</small>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn ghost small" id="btnCopyJson">Copiar JSON</button>
          <button class="btn ghost small" id="btnOpenJson">Abrir JSON</button>
          <button class="btn small" id="btnClose">Fechar</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="detailWrap"></div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="overlay-card">
      <div class="overlay-row">
        <div class="spinner"></div>
        <div>
          <div style="font-weight:900;letter-spacing:.2px">Processando</div>
          <div class="hint" id="overlayText">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>

  <script>
  
const $ = (sel, root=document)=>root.querySelector(sel);
const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

function toast(type, msg, ms=2600){
  const wrap = $("#toastWrap");
  const el = document.createElement("div");
  el.className = `toast ${type||"info"}`;
  el.innerHTML = `<div class="toast-dot"></div><div class="toast-msg"></div>`;
  $(".toast-msg", el).textContent = msg;
  wrap.appendChild(el);
  requestAnimationFrame(()=> el.classList.add("in"));
  setTimeout(()=>{
    el.classList.remove("in");
    el.classList.add("out");
    setTimeout(()=>el.remove(), 260);
  }, ms);
}

function setFieldState(el, ok, msg){
  if(!el) return;
  el.classList.remove("input-error","input-ok","shake");
  if(ok === true){
    el.classList.add("input-ok");
    return true;
  }
  if(ok === false){
    el.classList.add("input-error","shake");
    if(msg) toast("err", msg, 2800);
    setTimeout(()=>el.classList.remove("shake"), 450);
    try{ el.focus(); }catch(e){}
    return false;
  }
  return true;
}

function showOverlay(on, text="Processando..."){
  $("#overlay").classList.toggle("on", !!on);
  $("#overlayText").textContent = text;
}


  const API_BASE = "https://api.erpimpar.com.br/pricing";


  function getApiKey(){
    return (
      localStorage.getItem("impar_x_api_key") ||
      localStorage.getItem("x_api_key") ||
      localStorage.getItem("API_KEY") ||
      ""
    ).trim();
  }

  function withKeyInUrl(url){
    const k = getApiKey();
    if(!k) return url;
    // fallback para servidores que aceitam querystring
    const sep = url.includes("?") ? "&" : "?";
    return url + sep + "x_api_key=" + encodeURIComponent(k);
  }

  async function apiGet(path){
    const k = getApiKey();
    const res = await fetch(withKeyInUrl(API_BASE + path), {
      method:"GET",
      headers: k ? { "X-API-KEY": k } : {}
    });
    const txt = await res.text();
    let data;
    try{ data = JSON.parse(txt); }catch(e){ data = txt; }
    if(!res.ok){
      const err = (data && data.error) ? data.error : (typeof data === "string" ? data : "Erro");
      const e = new Error(err);
      e.status = res.status;
      e.payload = data;
      throw e;
    }
    return data;
  }

  async function apiPost(path, body){
    const k = getApiKey();
    const headers = { "Content-Type":"application/json" };
    if(k) headers["X-API-KEY"] = k;
    const res = await fetch(withKeyInUrl(API_BASE + path), {
      method:"POST",
      headers,
      body: JSON.stringify(body||{})
    });
    const txt = await res.text();
    let data;
    try{ data = JSON.parse(txt); }catch(e){ data = txt; }
    if(!res.ok){
      const err = (data && data.error) ? data.error : (typeof data === "string" ? data : "Erro");
      const e = new Error(err);
      e.status = res.status;
      e.payload = data;
      throw e;
    }
    return data;
  }

  async function triggerProcess(quoteId){
    if(!quoteId) return null;
    try{
      return await apiPost("/process_quote.php", { quote_id: String(quoteId) });
    }catch(e){
      // se falhar, o polling ainda mostra status pending
      return null;
    }
  }

  function fmtBRL(v){
    const n = Number(v);
    if(!isFinite(n)) return "‚Äî";
    return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
  }

  function safeStr(x){ return (x===null||x===undefined) ? "" : String(x); }

  // ---- store link helpers (ERP √çMPAR) ----
  function normStore(s){
    return (s||"").toString().trim().toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/\s+/g," ");
  }
  const STORE_HOME = {
    "loja do mecanico": "https://www.lojadomecanico.com.br/",
    "lojadomecanico": "https://www.lojadomecanico.com.br/",
    "mercado livre": "https://www.mercadolivre.com.br/",
    "mercadolivre": "https://www.mercadolivre.com.br/",
    "leroy merlin": "https://www.leroymerlin.com.br/",
    "leroymerlin": "https://www.leroymerlin.com.br/",
    "magalu": "https://www.magazineluiza.com.br/",
    "magazine luiza": "https://www.magazineluiza.com.br/",
    "amazon": "https://www.amazon.com.br/",
    "shopee": "https://shopee.com.br/",
    "kabum": "https://www.kabum.com.br/",
    "riberfluid": "https://www.riberfluid.com.br/",
    "zavvor ltda": "",
    "zavvor": ""
  };
  function storeHref(storeName, itemQuery, explicitUrl){
    const url = (explicitUrl||"").toString().trim();
    if(url) return url;
    const key = normStore(storeName);
    if(key && STORE_HOME[key]) return STORE_HOME[key];
    // fallback: search by store + item
    const q = encodeURIComponent([storeName, itemQuery].filter(Boolean).join(" ").trim());
    return q ? ("https://www.google.com/search?q=" + q) : "";
  }
  function offerPrice(offer){
    if(!offer) return NaN;
    const v = offer.preco ?? offer.pre√ßo ?? offer.price;
    return Number(v);
  }
  function offerStore(offer){
    if(!offer) return "";
    return offer.loja || offer.Loja || offer.store || offer.armazenar || "";
  }
  function offerUrl(offer){
    if(!offer) return "";
    return offer.link || offer.url || offer.href || "";
  }


function offerTitle(o){
  if(!o) return "";
  return (o.title ?? o.titulo ?? o.nome ?? o.name ?? "");
}
function offerSource(o){
  if(!o) return "";
  return (o.fonte ?? o.source ?? o.origem ?? o.provider ?? "");
}
function offerLinkFallback(store, title){
  const q = [store||"", title||""].join(" ").trim();
  if(!q) return "";
  return "https://www.google.com/search?q=" + encodeURIComponent(q);
}
function escAttr(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}
  function loadUser(){
    const raw = localStorage.getItem("usuarioLogado") || localStorage.getItem("ERPIMPAR_USER") || localStorage.getItem("impar_user") || "";
    try{
      const u = JSON.parse(raw);
      document.getElementById("userName").textContent = u.Nome || u.nome || "Usu√°rio";
      document.getElementById("userEmail").textContent = u.Email || u.email || "‚Äî";
    }catch(e){
      document.getElementById("userName").textContent = "Usu√°rio";
      document.getElementById("userEmail").textContent = "‚Äî";
    }
  }

  function parseCSV(text){
    // Aceita CSV com separador ";" (preferido) ou "," e headers em PT/EN.
    const raw = String(text||"").replace(//g,"").trim();
    if(!raw) return [];
    const lines = raw.split("
").map(l=>l.trim()).filter(Boolean);
    if(!lines.length) return [];

    const headerRaw = lines[0];
    const sep = headerRaw.includes(";") ? ";" : ",";

    const header = headerRaw.split(sep).map(h=>String(h||"").trim().toLowerCase());
    const getIdx = (...names)=> {
      for(const n of names){
        const i = header.indexOf(String(n).toLowerCase());
        if(i>=0) return i;
      }
      return -1;
    };

    const idxCodigo = getIdx("codigo","c√≥digo","cod");
    const idxEAN   = getIdx("ean","gtin","barcode");
    const idxProd  = getIdx("produto","descricao","descri√ß√£o","description","item");
    const idxNcm   = getIdx("ncm");
    const idxQtd   = getIdx("quantidade","qtd","qtde","quant");
    const idxUn    = getIdx("un","unidade");

    const out=[];
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(sep).map(c=>String(c||"").trim().replace(/^"|"$/g,""));
      if(cols.length===1 && !cols[0]) continue;

      const codigo = safeStr(cols[idxCodigo]).trim();
      const ean    = safeStr(cols[idxEAN]).trim();
      const descricao = safeStr(cols[idxProd]).trim();
      const ncm = safeStr(cols[idxNcm]).trim();
      const un  = safeStr(cols[idxUn]).trim();
      const qtd = Number(String(cols[idxQtd]||"").replace(",","."));

      if(!codigo && !descricao && !ean) continue;
      out.push({
        codigo: codigo||"",
        ean: ean||"",
        descricao: descricao||"",
        ncm: ncm||"",
        qtd: (isFinite(qtd)&&qtd>0 ? qtd : 1),
        un: un||""
      });
    }
    return out;
  }
    return out;
  }

  function modelCSV(){
    const csv = "codigo;ean;produto;ncm;quantidade;un
2734;7890000000000;RED CA/C SCH 40 6 X 4;73079200;4;\n9999;7890000000001;TUBO ACO CARBONO SCH40;73064000;4;\n";
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="modelo_itens_obra.csv";
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
  }

  let items = [];
  let currentDetail = null;

  function renderItems(){
    const tb = document.querySelector("#itemsTable tbody");
    tb.innerHTML = "";
    for(const it of items){
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${safeStr(it.codigo)}</td>
        <td>${safeStr(it.ean||'')}</td>
        <td>${safeStr(it.descricao)}</td>
        <td class="price">${safeStr(it.qtd)}</td>
        <td>${safeStr(it.ncm)}</td>
        <td>${safeStr(it.un)}</td>`;
      tb.appendChild(tr);
    }
    document.getElementById("kpiItems").textContent = `Itens carregados: ${items.length}`;
  }

  function renderQuotes(rows){
    const tb = document.querySelector("#quotesTable tbody");
    tb.innerHTML = "";
    for(const r of (rows||[])){
      const tr=document.createElement("tr");
      const st = (r.status||"").toLowerCase();
      const tagClass = st.includes("complete") || st.includes("conclu") ? "good" : (st.includes("error")||st.includes("erro") ? "bad" : "warn");
      tr.innerHTML = `
        <td>${safeStr(r.quote_id || r.id || "")}</td>
        <td>${safeStr(r.obra_id||"")}</td>
        <td class="price">${safeStr(r.items_count ?? "")}</td>
        <td class="price">${fmtBRL(r.total_best)}</td>
        <td><span class="tag ${tagClass}">${safeStr(r.status||"")}</span></td>
        <td><button class="btn small ghost" data-view="${safeStr(r.quote_id)}">Ver</button></td>
      `;
      tb.appendChild(tr);
    }
    if(!rows || !rows.length){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td colspan="6" class="muted">Nenhuma cota√ß√£o encontrada.</td>`;
      tb.appendChild(tr);
    }
  }

  function closeModal(){ document.getElementById("modalBack").classList.remove("on"); }

  function renderDetail(quote){
    quote = quote?.quote || quote; // <-- se vier envelope, extrai
    currentDetail = quote;
    document.getElementById("modalTitle").textContent = `Cota√ß√£o: ${quote.quote_id || quote.id || ""}`;
    const obra = quote?.payload?.obra_id || quote?.carga_util?.obra_id || quote?.obra_id || "‚Äî";
    const upd = quote.updated_at || quote.atualizado_em || "‚Äî";
    document.getElementById("modalSub").textContent = `Obra: ${obra} ‚Ä¢ Status: ${quote.status || "‚Äî"} ‚Ä¢ Atualizado: ${upd}`;

    const res = quote.resultados || quote.results || [];
    const wrap = document.getElementById("detailWrap");
    wrap.innerHTML = "";

    let grandTotal = 0;

    const box = document.createElement("div");
    box.className = "card";
    box.style.padding = "0";
    box.style.overflow = "hidden";
    box.innerHTML = `
      <table class="table" style="margin:0">
        <thead>
          <tr>
            <th style="width:90px">C√≥digo</th>
            <th>Item</th>
            <th style="width:70px">Qtd</th>
            <th style="width:130px">Melhor (R$)</th>
            <th style="width:150px">Loja</th>
            <th style="width:130px">Total</th>
            <th style="width:130px">2¬∫ melhor</th>
            <th style="width:130px">3¬∫ melhor</th>
          </tr>
        </thead>
        <tbody id="detailTb"></tbody>
        <tfoot>
          <tr>
            <td colspan="5" style="text-align:right;font-weight:900">TOTAL (melhor oferta)</td>
            <td class="price" id="grandTotal"></td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    `;
    wrap.appendChild(box);

    const tb = box.querySelector("#detailTb");
    for(const it of res){
      const offers = it.ofertas || it.offers || [];
      const best = it.melhor_oferta || it.best_offer || offers[0] || null;
      const bestPrice = best ? Number(best.preco ?? best.pre√ßo ?? best.price) : NaN;
      const qtd = Number(it.qtd ?? it.quantidade ?? 1);
      const total = (isFinite(bestPrice) ? bestPrice : 0) * (isFinite(qtd) ? qtd : 1);
      grandTotal += total;

      const bestLoja = best ? (best.loja || best.Loja || best.store || "") : "";
      const bestLink = best ? (best.link || best.url || "") : "";

      const second = offers[1] || null;
      const third  = offers[2] || null;

      const tr=document.createElement("tr");
      tr.className = (bestPrice && isFinite(bestPrice)) ? "row-best" : "";
      const bestTitle = best ? offerTitle(best) : "";
      const bestSrc = best ? offerSource(best) : "";
      const bestHref = (best ? offerUrl(best) : "") || offerLinkFallback(bestLoja, bestTitle);
      // Loja: clique no nome abre o site da loja (homepage); clique no √≠cone abre o link do item/oferta.
// Regra: 1) tenta mapear pelo nome da loja (mais confi√°vel)
//        2) se n√£o achar, tenta extrair o dom√≠nio do bestHref (desde que N√ÉO seja Google)
      let storeHome = storeHomepage(bestLoja);
      if (!storeHome && bestHref) {
        try {
          const u = new URL(bestHref);
          const host = (u.hostname || "").toLowerCase();
          const isGoogle = host.includes("google.");
          storeHome = isGoogle ? "" : u.origin;
        } catch (e) { storeHome = ""; }
      }

      const lojaHtml = bestLoja
        ? `<a class="store-name" href="${storeHome || bestHref}" target="_blank" rel="noopener">${safeStr(bestLoja)}</a>`
        : "‚Äî";

      const iconHtml = bestHref
        ? `<a class="iconLink" href="${bestHref}" target="_blank" rel="noopener" aria-label="Abrir item" title="Abrir item">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M10.59 13.41a1 1 0 0 0 1.41 0l4.59-4.59V11a1 1 0 1 0 2 0V6a2 2 0 0 0-2-2h-5a1 1 0 1 0 0 2h2.17L12 10.17l-1.41-1.41a3 3 0 0 0-4.24 0l-2.83 2.83a3 3 0 0 0 0 4.24l2.83 2.83a3 3 0 0 0 4.24 0l1.41-1.41a1 1 0 1 0-1.41-1.41l-1.41 1.41a1 1 0 0 1-1.41 0l-2.83-2.83a1 1 0 0 1 0-1.41l2.83-2.83a1 1 0 0 1 1.41 0l1.41 1.41-1.41 1.41a1 1 0 0 0 0 1.41Z"/></svg>
          </a>`
        : "";
      const srcBadge = bestSrc ? `<span class="badge-src">${safeStr(bestSrc)}</span>` : "";
      const itemTip = escAttr(bestTitle || (it.descricao||it.descri√ß√£o||""));
      tr.innerHTML = `
        <td>${safeStr(it.codigo||it.c√≥digo||"")}</td>
        <td><span class="tip" data-tip="${itemTip}">${safeStr(it.descricao||it.descri√ß√£o||"")}</span></td>
        <td class="price">${safeStr(qtd)}</td>
        <td class="price"><span class="bestPrice"><span class="trophy">üèÜ</span>${fmtBRL(bestPrice)}</span></td>
        <td>${lojaHtml} ${iconHtml} ${srcBadge}</td>
        <td class="price"><b>${fmtBRL(total)}</b></td>
        <td class="price">${second ? fmtBRL(offerPrice(second)) : "‚Äî"}</td>
        <td class="price">${third ? fmtBRL(offerPrice(third)) : "‚Äî"}</td>
      `;
      tb.appendChild(tr);
    }

    box.querySelector("#grandTotal").textContent = fmtBRL(grandTotal);
    document.getElementById("modalBack").classList.add("on");
  }

function storeHomepage(store){
  if(!store) return "";

  const map = {
    "zavvor": "https://www.zavvor.com.br",
    "riberfluid": "https://www.riberfluid.com.br",
    "epizeus": "https://www.epizeus.com.br",
    "mercado livre": "https://www.mercadolivre.com.br",
    "amazon": "https://www.amazon.com.br",
    "shopee": "https://shopee.com.br",
    "kabum": "https://www.kabum.com.br",
    "leroy": "https://www.leroymerlin.com.br",
    "loja do mecanico": "https://www.lojadomecanico.com.br",
    "magalu": "https://www.magazineluiza.com.br"
  };

  const key = store.toLowerCase();

  for(const name in map){
    if(key.includes(name)){
      return map[name];
    }
  }

  return "";
}


  async function loadQuotes(){
    const q = (document.getElementById("q").value || "").trim();
    showOverlay(true, "Carregando lista de cota√ß√µes...");
    try{
      const data = await apiGet(`/list_quotes.php?limit=50&q=${encodeURIComponent(q)}`);
      document.getElementById("kpiApi").textContent = "API: conectado";
      document.getElementById("kpiApi").classList.add("good");
      document.getElementById("kpiLast").textContent = "√öltima atualiza√ß√£o: " + new Date().toLocaleString("pt-BR");
      renderQuotes(data.data || []);
      showOverlay(false);
    }catch(e){
      showOverlay(false);
      document.getElementById("kpiApi").textContent = "API: erro";
      toast("err", `Erro ao consultar: ${e.message || e}`);
      renderQuotes([]);
    }
  }

  async function createQuote(){
    const obraEl = document.getElementById("obraId");
    const obra = (obraEl.value||"").trim();
    if(!obra) return setFieldState(obraEl, false, "Informe a OBRA (obra_id).");
    if(!items.length) return toast("warn","Carregue um CSV com itens antes de criar a cota√ß√£o.");
    setFieldState(obraEl, true);

    showOverlay(true, "Criando cota√ß√£o (salvando JSON)...");
    try{
      const payload = {
        obra_id: obra,
        search: {
        market: (document.getElementById("market")?.value || "br"),
        prefer_ean: !!document.getElementById("preferEAN")?.checked
      },
        items: items.map(x=>({
          codigo: x.codigo,
          descricao: x.descricao,
          ncm: x.ncm || null,
          qtd: Number(x.qtd)||1,
          un: x.un || null,
          ean: x.ean || null
        }))
      };
      const out = await apiPost("/create_quote.php", payload);
      toast("ok", `Cota√ß√£o criada: ${out.quote_id || out.id || "OK"}`);

      // Dispara o processamento (SerpAPI) no servidor.
      // (Se o servidor ainda n√£o estiver com SERPAPI_KEY configurada, a cota√ß√£o ficar√° como pending.)
      if (out && (out.quote_id || out.id)) {
        triggerProcess(String(out.quote_id || out.id)).catch(()=>{});
      }
      await loadQuotes();
      if(out.quote_id) await openDetail(out.quote_id, true);
      showOverlay(false);
    }catch(e){
      showOverlay(false);
      toast("err", `Erro ao criar: ${e.status || ""} ${e.message || e}`);
    }
  }

  async function openDetail(quoteId, autoPoll=false){
    if(!quoteId) return;
    showOverlay(true, "Carregando detalhe da cota√ß√£o...");
    try{
      let data = await apiGet(`/get_quote.php?quote_id=${encodeURIComponent(quoteId)}`);
      if(autoPoll){
        // dispara o processamento no servidor (se ainda estiver pending)
        triggerProcess(quoteId).catch(()=>{});
        const start = Date.now();
        while(true){
          const st = String(data.status||"").toLowerCase();
          const done = st.includes("complete") || st.includes("conclu") || st.includes("done");
          const hasResults = (data.resultados && data.resultados.length) || (data.results && data.results.length);
          if(done || hasResults) break;
          if(Date.now()-start > 65000) break;
          showOverlay(true, "Cotando... (atualizando a cada 2.5s)");
          await sleep(2500);
          data = await apiGet(`/get_quote.php?quote_id=${encodeURIComponent(quoteId)}`);
        }
      }
      showOverlay(false);
      renderDetail(data);
    }catch(e){
      showOverlay(false);
      toast("err", `Erro ao carregar detalhes: ${e.status || ""} ${e.message || e}`);
    }
  }

  async function loadCSVAndPreview(){
    const mode = document.getElementById("csvMode").value;
    if(mode === "sample"){
      items = [
        {codigo:"2734", descricao:"RED CA/C SCH 40 6 X 4", ncm:"73079200", qtd:4, un:""},
        {codigo:"9999", descricao:"TUBO ACO CARBONO SCH40", ncm:"73064000", qtd:4, un:""}
      ];
      renderItems();
      toast("ok","Exemplo carregado.");
      return;
    }
    const f = document.getElementById("csvFile").files && document.getElementById("csvFile").files[0];
    if(!f) return toast("warn","Selecione um CSV.");
    const txt = await f.text();
    const parsed = parseCSV(txt);
    if(!parsed.length){
      toast("err","N√£o consegui ler itens do CSV. Confira cabe√ßalho: codigo,produto,ncm,quantidade.");
      return;
    }
    items = parsed;
    renderItems();
    toast("ok", `CSV carregado: ${items.length} itens.`);
  }

  document.addEventListener("click", async (ev)=>{
    const btn = ev.target.closest("[data-view]");
    if(btn){
      openDetail(btn.getAttribute("data-view"));
    }
  });

  document.getElementById("btnClose").addEventListener("click", closeModal);
  document.getElementById("modalBack").addEventListener("click", (e)=>{ if(e.target === document.getElementById("modalBack")) closeModal(); });

  document.getElementById("btnCopyJson").addEventListener("click", async ()=>{
    if(!currentDetail) return;
    const txt = JSON.stringify(currentDetail, null, 2);
    try{ await navigator.clipboard.writeText(txt); toast("ok","JSON copiado."); }
    catch(e){ toast("warn","N√£o consegui copiar (permiss√£o do navegador)."); }
  });

  document.getElementById("btnOpenJson").addEventListener("click", ()=>{
    if(!currentDetail) return;
    const blob = new Blob([JSON.stringify(currentDetail, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank");
    setTimeout(()=>URL.revokeObjectURL(url), 8000);
  });

  document.getElementById("btnPick").addEventListener("click", ()=>document.getElementById("csvFile").click());
  document.getElementById("btnModel").addEventListener("click", modelCSV);
  document.getElementById("btnPreview").addEventListener("click", loadCSVAndPreview);
  document.getElementById("btnCreate").addEventListener("click", createQuote);

  document.getElementById("btnRefresh").addEventListener("click", loadQuotes);
  document.getElementById("btnSearch").addEventListener("click", loadQuotes);
  document.getElementById("q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") loadQuotes(); });

  document.getElementById("btnMenu").addEventListener("click", ()=>{
    window.location.href = "../index.html";
  });

  const drop = document.querySelector(".drop");
  ["dragenter","dragover"].forEach(evt=>drop.addEventListener(evt, e=>{
    e.preventDefault(); e.stopPropagation();
    drop.style.borderColor = "rgba(25,195,125,.55)";
  }));
  ["dragleave","drop"].forEach(evt=>drop.addEventListener(evt, e=>{
    e.preventDefault(); e.stopPropagation();
    drop.style.borderColor = "rgba(255,255,255,.18)";
  }));
  drop.addEventListener("drop", async (e)=>{
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if(!f) return;
    document.getElementById("csvFile").files = e.dataTransfer.files;
    await loadCSVAndPreview();
  });

  loadUser();
  renderItems();
  loadQuotes();
  </script>
</body>
</html>
