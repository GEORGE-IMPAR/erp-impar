<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>ERP √çMPAR ‚Äî Consulta de Pre√ßos</title>

<style>
body{
    margin:0;
    font-family:Segoe UI, Arial;
    background:linear-gradient(90deg,#061a3a,#0b4f5a);
    color:#fff;
}

.card{
    background:rgba(0,0,0,.28);
    border-radius:18px;
    padding:28px;
    margin:24px;
    box-shadow:0 0 30px rgba(0,0,0,.45);
}

h2{margin-top:0}

.toolbar{
    display:flex;
    gap:10px;
    margin-bottom:18px;
}

input{
    flex:1;
    background:rgba(255,255,255,.12);
    border:1px solid #1aff6c;
    border-radius:12px;
    padding:10px;
    color:#fff;
    font-size:14px;
}

input:focus{
    outline:none;
    box-shadow:0 0 10px rgba(26,255,108,.7);
}

.btn{
    background:#1aff6c;
    color:#003b1a;
    border:none;
    border-radius:22px;
    padding:10px 20px;
    font-weight:700;
    cursor:pointer;
    box-shadow:0 0 12px rgba(26,255,108,.8);
    transition:.2s;
}

.btn:hover{
    transform:scale(1.05);
}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
}

th,td{
    padding:12px;
    border-bottom:1px solid rgba(255,255,255,.15);
    text-align:center;
}

th{
    color:#9af7c0;
}

.status{
    color:#1aff6c;
    font-weight:700;
}
</style>
</head>

<body>

<div class="card">
<h2>üîç Consulta de Pre√ßos ‚Äî ERP √çMPAR</h2>

<div class="toolbar">
<input id="search" placeholder="Buscar por obra, c√≥digo ou ID">
<button class="btn" onclick="loadQuotes()">Atualizar</button>
</div>

<table>
<thead>
<tr>
<th>ID</th>
<th>Obra</th>
<th>Itens</th>
<th>Total</th>
<th>Status</th>
<th>A√ß√£o</th>
</tr>
</thead>

<tbody id="tbody">
<tr><td colspan="6">Carregando‚Ä¶</td></tr>
</tbody>
</table>
</div>

<script>
const API = "https://api.erpimpar.com.br/pricing";
const KEY = "IMP4R_CHAVE_FIXA_TESTE_123";

function setLoading(msg="Carregando..."){
  document.getElementById("tbody").innerHTML =
    `<tr><td colspan="6">${msg}</td></tr>`;
}

async function loadQuotes(){
  const q = document.getElementById("search").value.trim();
  const url = `${API}/list_quotes.php?limit=50&q=${encodeURIComponent(q)}`;

  setLoading("Carregando...");

  try{
    // timeout de 12s (pra n√£o ficar preso)
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 12000);

    const r = await fetch(url,{
      method: "GET",
      headers: { "X-API-KEY": KEY },
      signal: controller.signal
    });

    clearTimeout(t);

    const text = await r.text(); // l√™ como texto primeiro (pra debug)
    let j;
    try { j = JSON.parse(text); }
    catch(e){
      console.error("Resposta n√£o √© JSON:", text);
      setLoading("‚ùå Resposta inv√°lida do servidor (n√£o √© JSON). Abra o Console (F12).");
      return;
    }

    console.log("list_quotes response:", j);

    if(!r.ok){
      setLoading(`‚ùå ERRO ${r.status}: ${(j && j.error) ? j.error : "Falha ao carregar"}`);
      return;
    }

    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    if(!j.data || j.data.length === 0){
      tbody.innerHTML = "<tr><td colspan='6'>Nenhuma cota√ß√£o encontrada.</td></tr>";
      return;
    }

    j.data.forEach(x=>{
      const total = (x.total_best ?? 0);
      tbody.innerHTML += `
        <tr>
          <td>${x.quote_id ?? ""}</td>
          <td>${x.obra_id ?? ""}</td>
          <td>${x.items_count ?? 0}</td>
          <td>R$ ${Number(total).toFixed(2)}</td>
          <td class="status">${x.status ?? ""}</td>
          <td><button class="btn" onclick="openQuote('${x.quote_id}')">Abrir</button></td>
        </tr>`;
    });

  }catch(err){
    console.error("Falha no fetch:", err);
    const msg = (err.name === "AbortError")
      ? "‚è≥ Timeout (12s) ao consultar a API."
      : "‚ùå Falha ao consultar a API. Veja o Console (F12).";
    setLoading(msg);
  }
}

function openQuote(id){
  window.open(`${API}/get_quote.php?id=${encodeURIComponent(id)}`,"_blank");
}

loadQuotes();

function openQuote(id){
    window.open(`${API}/get_quote.php?id=${id}`,"_blank");
}

loadQuotes();
</script>

</body>
</html>
