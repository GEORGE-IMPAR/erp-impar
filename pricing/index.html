<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP ÍMPAR — Consulta de Preços</title>
  <style>
    :root{
      --bg1:#071a33;
      --bg2:#0b5c66;
      --card:#0b223d;
      --card2:#071a33cc;
      --stroke:#143a63;
      --text:#e7f3ff;
      --muted:#a7c2dd;
      --green:#18c47a;
      --green2:#0e9d60;
      --orange:#ff8a2a;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: "Candara", "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 18% 12%, rgba(24,196,122,.14), transparent 60%),
        radial-gradient(900px 500px at 82% 10%, rgba(255,138,42,.10), transparent 60%),
        linear-gradient(120deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    a{color:#7fe4ff; text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1280px; margin:0 auto; padding:22px 18px 30px}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:16px 16px;
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:240px}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: conic-gradient(from 210deg, #22d1ee, #18c47a, #ff8a2a, #22d1ee);
      box-shadow: 0 10px 22px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.08) inset;
    }
    .brand h1{font-size:14px; line-height:1.1; margin:0; letter-spacing:.2px}
    .brand small{display:block; margin-top:2px; color:var(--muted); font-size:12px}
    .userpill{
      display:flex; align-items:center; gap:10px; flex:1;
      max-width:560px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      backdrop-filter: blur(8px);
    }
    .keydot{
      width:10px;height:10px;border-radius:50%;
      background: var(--green);
      box-shadow: 0 0 0 3px rgba(24,196,122,.18);
    }
    .usertext{display:flex; flex-direction:column; min-width:0}
    .usertext b{font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .usertext span{font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .rightbtns{display:flex; gap:10px; align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      color:var(--text);
      padding:10px 14px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
      transition:.18s transform, .18s filter, .18s background;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); filter: brightness(1.07)}
    .btn:active{transform: translateY(0)}
    .btn.green{
      border-color: rgba(24,196,122,.35);
      background: linear-gradient(180deg, rgba(24,196,122,.95), rgba(14,157,96,.95));
      box-shadow: 0 10px 28px rgba(24,196,122,.20), 0 0 0 1px rgba(255,255,255,.05) inset;
      color:#062117;
    }
    .btn.orange{
      border-color: rgba(255,138,42,.35);
      background: linear-gradient(180deg, rgba(255,138,42,.95), rgba(232,106,18,.95));
      box-shadow: 0 10px 28px rgba(255,138,42,.18), 0 0 0 1px rgba(255,255,255,.05) inset;
      color:#2a1406;
    }
    .btn.ghost{
      background: rgba(0,0,0,.08);
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      align-items:start;
    }
    .card{
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.09);
      background: linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.22));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.07);
    }
    .card .hd h2{margin:0; font-size:14px; letter-spacing:.2px}
    .card .hd small{color:var(--muted); font-size:12px}
    .card .bd{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .field{flex:1; min-width:170px}
    label{display:block; font-size:11px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.09);
      background: rgba(0,0,0,.14);
      color: var(--text);
      padding: 12px 12px;
      outline:none;
      transition: .15s border, .15s box-shadow;
      font-size: 13px;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(127,228,255,.35);
      box-shadow: 0 0 0 4px rgba(127,228,255,.10);
    }

    .drop{
      border:1.5px dashed rgba(127,228,255,.25);
      background: rgba(0,0,0,.10);
      border-radius: 16px;
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      position:relative;
    }
    .drop.drag{border-color: rgba(24,196,122,.45); box-shadow: 0 0 0 6px rgba(24,196,122,.10)}
    .drop b{display:block; font-size:14px}
    .drop small{display:block; color:var(--muted); font-size:12px; margin-top:3px}
    .drop input[type=file]{display:none}
    .hint{font-size:11px; color:var(--muted); margin-top:10px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border-radius: 999px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      font-size:12px;
      color:var(--muted);
    }
    .kpis{display:flex; gap:8px; flex-wrap:wrap}
    .kpis .pill b{color:var(--text)}

    .tableWrap{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      border-radius: 14px;
      overflow:auto;
    }
    table{width:100%; border-collapse:separate; border-spacing:0}
    th,td{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:12px;
      white-space:nowrap;
    }
    th{
      position:sticky; top:0;
      background: rgba(6, 18, 34, .92);
      text-align:left;
      font-size:11px;
      letter-spacing:.35px;
      color: #b9d5ee;
      z-index:2;
    }
    tr:hover td{background: rgba(255,255,255,.03)}
    td.mono{font-family:var(--mono); font-size:11.5px}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 9px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      color: var(--muted);
      font-size:11px;
    }
    .tag.ok{border-color: rgba(24,196,122,.28); color:#bff5dc}
    .tag.err{border-color: rgba(255,90,90,.30); color:#ffd2d2}
    .tag.wait{border-color: rgba(255,138,42,.28); color:#ffe2c9}
    .foot{
      margin-top:10px;
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      color: rgba(255,255,255,.42);
      font-size:11px;
    }

    /* modal */
    .modalMask{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding: 18px;
      z-index: 999;
    }
    .modal{
      width:min(1100px, 100%);
      max-height: 88vh;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(10,30,55,.92), rgba(6,18,34,.92));
      box-shadow: 0 25px 80px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex; flex-direction:column;
      backdrop-filter: blur(12px);
    }
    .modal .mh{
      padding:14px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modal .mh b{font-size:14px}
    .modal .mb{padding:14px; overflow:auto}
    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 1050px){
      .split{grid-template-columns: 1fr 1fr;}
    }
    pre{
      margin:0;
      padding:12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      color:#d9f0ff;
      font-family: var(--mono);
      font-size: 11px;
      overflow:auto;
      line-height: 1.35;
    }
    .spin{
      width:16px;height:16px;border-radius:50%;
      border:2px solid rgba(255,255,255,.18);
      border-top-color: rgba(127,228,255,.90);
      animation: sp 0.9s linear infinite;
      display:inline-block;
    }
    @keyframes sp{to{transform:rotate(360deg)}}

    .toast{
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
      display:none;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(12px);
      box-shadow: 0 20px 70px rgba(0,0,0,.45);
      z-index: 1000;
      min-width: 280px;
      max-width: 680px;
    }
    .toast .trow{display:flex; gap:10px; align-items:center}
    .toast .msg{font-size:12px; color:#eaf6ff}
    .toast.ok{border-color: rgba(24,196,122,.30)}
    .toast.err{border-color: rgba(255,90,90,.35)}
    .toast.warn{border-color: rgba(255,138,42,.30)}
    .mini{font-size:11px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>ERP ÍMPAR</h1>
          <small>Consulta de preços • Cotação por CSV • v2.0</small>
        </div>
      </div>

      <div class="userpill" title="Usuário logado (lido do localStorage: usuarioLogado)">
        <span class="keydot" id="apiDot"></span>
        <div class="usertext">
          <b id="userName">Carregando usuário...</b>
          <span id="userEmail">—</span>
        </div>
      </div>

      <div class="rightbtns">
        <button class="btn ghost" id="btnRefresh">Atualizar</button>
        <button class="btn green" id="btnOpenCsv">Importar CSV</button>
        <button class="btn" id="btnMenu">Menu</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: quotes list -->
      <div class="card">
        <div class="hd">
          <div>
            <h2>Lista de cotações</h2>
            <small>Como um cronograma: histórico + busca</small>
          </div>
          <span class="tag ok" id="apiStatus"><span class="spin" id="apiSpin" style="display:none"></span><span id="apiStatusText">API conectada</span></span>
        </div>
        <div class="bd">
          <div class="row" style="align-items:flex-end">
            <div class="field" style="flex:1.2; min-width:240px">
              <label>Buscar</label>
              <input id="q" placeholder="obra, quote_id, status..." />
            </div>
            <div class="field" style="min-width:120px">
              <label>Limite</label>
              <select id="limit">
                <option>20</option>
                <option selected>50</option>
                <option>100</option>
                <option>200</option>
              </select>
            </div>
            <div class="field" style="min-width:120px">
              <button class="btn green" id="btnSearch" style="width:100%">Buscar</button>
            </div>
          </div>

          <div class="kpis" style="margin-top:10px">
            <span class="pill"><span class="mini">Total:</span> <b id="kpiTotal">0</b></span>
            <span class="pill"><span class="mini">Atualizado:</span> <b id="kpiTime">—</b></span>
          </div>

          <div class="tableWrap" style="margin-top:10px; max-height: 58vh">
            <table id="tblQuotes">
              <thead>
                <tr>
                  <th>Quote ID</th>
                  <th>Obra</th>
                  <th>Itens</th>
                  <th>Total (melhor)</th>
                  <th>Status</th>
                  <th>Criado</th>
                  <th>Ação</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="7" class="mini">Nenhuma cotação carregada.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="foot">
            <span>Dica: clique em <b>Ver</b> para abrir a tabela de ofertas (melhor, 2º, 3º) por item.</span>
            <span style="opacity:.7">© ERP ÍMPAR • pricing</span>
          </div>
        </div>
      </div>

      <!-- RIGHT: import/create -->
      <div class="card">
        <div class="hd">
          <div>
            <h2>Importação por CSV</h2>
            <small>Colunas: <span class="mono">codigo,produto,ncm,quantidade</span> (opcional: <span class="mono">un</span>)</small>
          </div>
          <button class="btn" id="btnHelp">Como funciona?</button>
        </div>
        <div class="bd">
          <div class="row">
            <div class="field">
              <label>Obra (obra_id)</label>
              <input id="obraId" value="OBRA_001" />
            </div>
            <div class="field">
              <label>Origem do CSV</label>
              <select id="csvSource">
                <option value="upload" selected>Upload do arquivo</option>
                <option value="paste">Colar CSV (texto)</option>
              </select>
            </div>
          </div>

          <div id="uploadBox" class="drop" style="margin-top:10px">
            <div>
              <b>Arraste o CSV aqui</b>
              <small>ou clique para selecionar. Vamos pré-visualizar antes de criar a cotação.</small>
            </div>
            <div style="display:flex; gap:10px; align-items:center">
              <button class="btn" id="btnPick">Selecionar CSV</button>
              <input id="file" type="file" accept=".csv,text/csv" />
            </div>
          </div>

          <div id="pasteBox" style="display:none; margin-top:10px">
            <label>Colar CSV aqui</label>
            <textarea id="csvText" rows="6" placeholder="codigo,produto,ncm,quantidade&#10;2734,RED CA/C SCH 40 6 X 4,73079200,4"></textarea>
          </div>

          <div class="row" style="margin-top:10px; align-items:center">
            <button class="btn" id="btnModel">Baixar modelo CSV</button>
            <button class="btn green" id="btnPreview">Carregar & Pré-visualizar</button>
            <button class="btn orange" id="btnCreate">Criar cotação</button>
          </div>

          <div class="kpis" style="margin-top:10px">
            <span class="pill"><span class="mini">Itens carregados:</span> <b id="kpiItens">0</b></span>
            <span class="pill"><span class="mini">Quote ID:</span> <b id="kpiQuoteId">—</b></span>
          </div>

          <div class="tableWrap" style="margin-top:10px; max-height: 34vh">
            <table id="tblItems">
              <thead>
                <tr>
                  <th>Código</th>
                  <th>Produto</th>
                  <th>NCM</th>
                  <th>Qtd</th>
                  <th>UN</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="5" class="mini">Sem itens. Importe um CSV.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="hint">
            <b>Resultado por item:</b> ao abrir uma cotação, você verá <span class="mono">Melhor</span>, <span class="mono">2º</span> e <span class="mono">3º</span> preço, com <b>Loja</b>, <b>Link</b> e <b>Total = Unitário × Qtd</b>, além do total da cotação.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: quote details -->
  <div class="modalMask" id="mask">
    <div class="modal">
      <div class="mh">
        <div>
          <b id="mTitle">Cotação</b>
          <div class="mini" id="mSub">—</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center">
          <button class="btn" id="btnExport">Exportar CSV (resultado)</button>
          <button class="btn ghost" id="btnCopyJson">Copiar JSON</button>
          <button class="btn" id="btnClose">Fechar</button>
        </div>
      </div>
      <div class="mb">
        <div class="split">
          <div class="card" style="box-shadow:none">
            <div class="hd"><h2>Resumo</h2><small>Totais + melhores ofertas</small></div>
            <div class="bd">
              <div class="kpis">
                <span class="pill"><span class="mini">Status:</span> <b id="mStatus">—</b></span>
                <span class="pill"><span class="mini">Itens:</span> <b id="mItens">—</b></span>
                <span class="pill"><span class="mini">Total (melhor):</span> <b id="mTotal">—</b></span>
              </div>
              <div class="tableWrap" style="margin-top:10px; max-height: 42vh">
                <table id="tblResult">
                  <thead>
                    <tr>
                      <th>Código</th>
                      <th>Item</th>
                      <th>Qtd</th>
                      <th>Melhor (R$)</th>
                      <th>Loja</th>
                      <th>Link</th>
                      <th>Total</th>
                      <th>2º (R$)</th>
                      <th>3º (R$)</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="9" class="mini">Carregue uma cotação.</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="foot">
                <span>Obs.: 2º e 3º são calculados ordenando as ofertas por preço.</span>
                <span id="mTotalsMini"></span>
              </div>
            </div>
          </div>

          <div class="card" style="box-shadow:none">
            <div class="hd"><h2>JSON bruto</h2><small>Para debug</small></div>
            <div class="bd">
              <pre id="mJson">{}</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"><div class="trow"><span id="toastIcon">•</span><div><div class="msg" id="toastMsg"></div><div class="mini" id="toastMini"></div></div></div></div>

<script>
/* ====== CONFIG ====== */
const API_BASE = "https://api.erpimpar.com.br/pricing";

/* ====== HELPERS ====== */
const $ = (id)=>document.getElementById(id);
const fmtBRL = (v)=>{
  if (v === null || v === undefined || v === "") return "—";
  const n = Number(v);
  if (!isFinite(n)) return "—";
  return n.toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
};
const fmtDate = (iso)=>{
  if (!iso) return "—";
  try { return new Date(iso).toLocaleString("pt-BR"); } catch { return String(iso); }
};
function toast(type, msg, mini=""){
  const t = $("toast");
  t.className = "toast " + (type||"");
  $("toastIcon").textContent = type==="ok"?"✓":type==="err"?"✖":type==="warn"?"!":"•";
  $("toastMsg").textContent = msg;
  $("toastMini").textContent = mini;
  t.style.display = "block";
  clearTimeout(window.__tTo);
  window.__tTo = setTimeout(()=> t.style.display="none", 4200);
}
function setApiState(state, text){
  const tag = $("apiStatus");
  tag.classList.remove("ok","err","wait");
  tag.classList.add(state);
  $("apiStatusText").textContent = text;
}

/* ====== USER HEADER ====== */
(function(){
  // padrão: nos seus outros módulos, você costuma salvar algo assim em localStorage.
  let u = null;
  try{
    const raw = localStorage.getItem("usuarioLogado");
    if (raw) u = JSON.parse(raw);
  }catch(e){}
  const nome = (u && (u.Nome || u.nome || u.user || u.usuario)) ? (u.Nome || u.nome || u.user || u.usuario) : "Usuário";
  const email = (u && (u.Email || u.email)) ? (u.Email || u.email) : "—";
  $("userName").textContent = nome;
  $("userEmail").textContent = email;
})();

/* ====== API ====== */
async function apiGet(path){
  const url = API_BASE + path;
  const res = await fetch(url, {method:"GET"});
  const text = await res.text();
  if (!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
  try{ return JSON.parse(text); }catch{ return text; }
}
async function apiPost(path, body){
  const url = API_BASE + path;
  const res = await fetch(url, {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(body||{})
  });
  const text = await res.text();
  if (!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
  try{ return JSON.parse(text); }catch{ return text; }
}

/* ====== QUOTES LIST ====== */
function renderQuotes(rows){
  const tb = $("tblQuotes").querySelector("tbody");
  tb.innerHTML = "";
  if (!rows || !rows.length){
    tb.innerHTML = `<tr><td colspan="7" class="mini">Nenhuma cotação encontrada.</td></tr>`;
    return;
  }
  for (const r of rows){
    const st = String(r.status||"");
    const tag = st.includes("complete") || st.includes("concl") ? "ok" : (st.includes("process")||st.includes("queue")) ? "wait" : "err";
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td class="mono">${(r.quote_id||"—")}</td>
        <td class="mono">${(r.obra_id||"—")}</td>
        <td class="mono">${(r.items_count ?? "—")}</td>
        <td>${fmtBRL(r.total_best)}</td>
        <td><span class="tag ${tag}">${st||"—"}</span></td>
        <td class="mono">${fmtDate(r.created_at)}</td>
        <td><button class="btn" data-view="${(r.quote_id||"")}">Ver</button></td>
      </tr>
    `);
  }
  tb.querySelectorAll("button[data-view]").forEach(b=>{
    b.addEventListener("click", ()=> openQuote(b.getAttribute("data-view")));
  });
}
async function loadQuotes(){
  $("apiSpin").style.display = "inline-block";
  setApiState("wait", "Carregando…");
  const q = encodeURIComponent(($("q").value||"").trim());
  const limit = encodeURIComponent($("limit").value||"50");
  try{
    const data = await apiGet(`/list_quotes.php?limit=${limit}&q=${q}`);
    renderQuotes(data.data || []);
    $("kpiTotal").textContent = String(data.total ?? (data.data||[]).length);
    $("kpiTime").textContent = new Date().toLocaleString("pt-BR");
    setApiState("ok", "API conectada");
  }catch(e){
    console.error(e);
    setApiState("err", "Erro na API");
    toast("err", "Falha ao carregar cotações", String(e.message||e));
  }finally{
    $("apiSpin").style.display = "none";
  }
}

/* ====== CSV IMPORT ====== */
let parsedItems = [];

function csvToRows(text){
  // suporta separador ; ou , e ignora linhas vazias
  const lines = text.replace(/\r/g,"").split("\n").map(l=>l.trim()).filter(Boolean);
  if (!lines.length) return [];
  const sep = (lines[0].includes(";") && !lines[0].includes(",")) ? ";" : ",";
  const parseLine = (line)=>{
    // parse simples com aspas
    const out = [];
    let cur="", inQ=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (ch === '"'){ inQ = !inQ; continue; }
      if (!inQ && ch===sep){ out.push(cur.trim()); cur=""; continue; }
      cur += ch;
    }
    out.push(cur.trim());
    return out;
  };
  const header = parseLine(lines[0]).map(h=>h.toLowerCase().trim());
  const idx = (name)=> header.indexOf(name);
  const iCodigo = idx("codigo");
  const iProduto = Math.max(idx("produto"), idx("descricao"));
  const iNcm = idx("ncm");
  const iQtd = Math.max(idx("quantidade"), idx("qtd"));
  const iUn = idx("un");
  const rows = [];
  for (let i=1;i<lines.length;i++){
    const cols = parseLine(lines[i]);
    const codigo = (cols[iCodigo]||"").trim();
    const desc = (cols[iProduto]||"").trim();
    const ncm = (cols[iNcm]||"").trim();
    const qtdRaw = (cols[iQtd]||"").trim().replace(",",".");
    const unRaw = (cols[iUn]||"").trim().replace(",",".");
    const qtd = Number(qtdRaw || 0);
    const un = Number(unRaw || "");
    if (!codigo && !desc) continue;
    rows.push({
      codigo: codigo || "",
      descricao: desc || "",
      ncm: ncm || "",
      qtd: isFinite(qtd) ? qtd : 0,
      un: isFinite(un) ? un : null
    });
  }
  return rows;
}

function renderItemsPreview(items){
  const tb = $("tblItems").querySelector("tbody");
  tb.innerHTML = "";
  if (!items.length){
    tb.innerHTML = `<tr><td colspan="5" class="mini">Sem itens. Importe um CSV.</td></tr>`;
    return;
  }
  for (const it of items){
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td class="mono">${it.codigo || "—"}</td>
        <td>${it.descricao || "—"}</td>
        <td class="mono">${it.ncm || "—"}</td>
        <td class="mono">${String(it.qtd ?? "—")}</td>
        <td class="mono">${it.un ?? "—"}</td>
      </tr>
    `);
  }
  $("kpiItens").textContent = String(items.length);
}

async function loadCsvAndPreview(){
  try{
    let raw = "";
    const src = $("csvSource").value;
    if (src === "paste"){
      raw = $("csvText").value || "";
    } else {
      const f = $("file").files && $("file").files[0];
      if (!f) { toast("warn","Selecione um CSV primeiro."); return; }
      raw = await f.text();
    }
    const rows = csvToRows(raw);
    parsedItems = rows;
    renderItemsPreview(rows);
    toast("ok", "CSV carregado", `${rows.length} item(ns) prontos para cotar.`);
  }catch(e){
    console.error(e);
    toast("err", "Erro ao ler CSV", String(e.message||e));
  }
}

async function createQuote(){
  const obra_id = ($("obraId").value||"").trim() || "OBRA_001";
  if (!parsedItems.length){
    toast("warn","Sem itens.","Importe um CSV e clique em Carregar & Pré-visualizar.");
    return;
  }
  $("btnCreate").disabled = true;
  $("btnCreate").textContent = "Criando…";
  setApiState("wait","Criando cotação…");
  try{
    // payload padrão do seu modelo
    const payload = {
      obra_id,
      itens: parsedItems.map(x=>({
        codigo: x.codigo,
        descricao: x.descricao,
        ncm: x.ncm || null,
        qtd: x.qtd,
        un: (x.un===null||x.un===undefined||x.un==="") ? null : x.un
      }))
    };
    const res = await apiPost("/create_quote.php", payload);
    // esperado: {status:"ok", quote_id:"Q-..."}
    const qid = res.quote_id || res.id || res.quote || res.data?.quote_id;
    if (!qid) throw new Error("Resposta sem quote_id: " + JSON.stringify(res).slice(0,300));
    $("kpiQuoteId").textContent = qid;
    toast("ok","Cotação criada", `Quote ID: ${qid}`);
    await loadQuotes();
    await openQuote(qid);
    setApiState("ok","API conectada");
  }catch(e){
    console.error(e);
    setApiState("err","Erro ao criar");
    toast("err","Falha ao criar cotação", String(e.message||e));
  }finally{
    $("btnCreate").disabled = false;
    $("btnCreate").textContent = "Criar cotação";
  }
}

/* ====== QUOTE DETAILS ====== */
let lastQuoteJson = null;

function bestOffersFrom(ofertas){
  const arr = (ofertas||[]).slice().filter(o=>{
    const p = Number(o.preco ?? o.price);
    return isFinite(p) && p > 0;
  }).sort((a,b)=> Number(a.preco ?? a.price) - Number(b.preco ?? b.price));
  const pick = (o)=>{
    if (!o) return null;
    const preco = Number(o.preco ?? o.price);
    return {
      title: o.title || o.titulo || "—",
      loja: o.loja || o.Loja || o.store || o.armazem || o.armazenar || "—",
      link: o.link || o.url || null,
      preco
    };
  };
  return [pick(arr[0]), pick(arr[1]), pick(arr[2])];
}

function safeStoreLink(link){
  if (!link) return "—";
  // se vier sem protocolo, não cria link quebrado
  try{
    const u = new URL(link);
    return `<a href="${u.href}" target="_blank" rel="noopener">Abrir</a>`;
  }catch{
    return "—";
  }
}

function renderQuoteDetail(q){
  lastQuoteJson = q;
  $("mTitle").textContent = `Cotação: ${q.quote_id || "—"}`;
  const obra = q.payload?.obra_id || q.obra_id || "—";
  $("mSub").textContent = `Obra: ${obra} • Criado: ${fmtDate(q.created_at)} • Atualizado: ${fmtDate(q.updated_at || q.atualizado_em)}`;
  $("mStatus").textContent = String(q.status || "—");
  const resultados = q.resultados || q.results || [];
  $("mItens").textContent = String(resultados.length);
  // total melhor
  let totalBest = 0, total2=0, total3=0;
  const tb = $("tblResult").querySelector("tbody");
  tb.innerHTML = "";
  for (const r of resultados){
    const qtd = Number(r.qtd ?? 0);
    const [b1,b2,b3] = bestOffersFrom(r.ofertas || r.offers);
    const p1 = b1?.preco ?? null;
    const p2 = b2?.preco ?? null;
    const p3 = b3?.preco ?? null;
    const line1 = (isFinite(p1)? p1*qtd : 0);
    const line2 = (isFinite(p2)? p2*qtd : 0);
    const line3 = (isFinite(p3)? p3*qtd : 0);
    if (isFinite(line1) && line1>0) totalBest += line1;
    if (isFinite(line2) && line2>0) total2 += line2;
    if (isFinite(line3) && line3>0) total3 += line3;

    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td class="mono">${r.codigo || r.código || "—"}</td>
        <td title="${(r.descricao||r.descrição||"").replaceAll('"','&quot;')}">${(r.descricao || r.descrição || "—")}</td>
        <td class="mono">${qtd || "—"}</td>
        <td>${isFinite(p1)? fmtBRL(p1) : "—"}</td>
        <td>${b1?.loja ?? "—"}</td>
        <td>${safeStoreLink(b1?.link)}</td>
        <td>${isFinite(p1)? fmtBRL(p1*qtd) : "—"}</td>
        <td>${isFinite(p2)? fmtBRL(p2) : "—"}</td>
        <td>${isFinite(p3)? fmtBRL(p3) : "—"}</td>
      </tr>
    `);
  }
  $("mTotal").textContent = fmtBRL(totalBest);
  $("mTotalsMini").textContent = `Totais: Melhor ${fmtBRL(totalBest)} • 2º ${fmtBRL(total2)} • 3º ${fmtBRL(total3)}`;
  $("mJson").textContent = JSON.stringify(q, null, 2);
}

async function openQuote(quote_id){
  if (!quote_id){ toast("warn","Quote ID vazio."); return; }
  $("mask").style.display = "flex";
  $("mTitle").textContent = "Carregando…";
  $("mSub").textContent = "—";
  $("mJson").textContent = "{}";
  setApiState("wait","Carregando cotação…");
  try{
    const q = await apiGet(`/get_quote.php?quote_id=${encodeURIComponent(quote_id)}`);
    renderQuoteDetail(q);
    setApiState("ok","API conectada");
  }catch(e){
    console.error(e);
    setApiState("err","Erro ao abrir");
    toast("err","Falha ao abrir cotação", String(e.message||e));
    // mantém modal aberta para o usuário ver erro
    $("mJson").textContent = String(e.message||e);
  }
}

/* ====== EXPORT CSV (RESULT) ====== */
function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();}, 0);
}
function exportResultCsv(){
  if (!lastQuoteJson){ toast("warn","Sem cotação aberta."); return; }
  const resultados = lastQuoteJson.resultados || lastQuoteJson.results || [];
  const header = ["codigo","produto","quantidade","melhor_preco","melhor_loja","melhor_link","total_melhor","segundo_preco","terceiro_preco"];
  const lines = [header.join(";")];
  for (const r of resultados){
    const qtd = Number(r.qtd ?? 0);
    const [b1,b2,b3] = bestOffersFrom(r.ofertas || r.offers);
    const p1 = b1?.preco ?? "";
    const p2 = b2?.preco ?? "";
    const p3 = b3?.preco ?? "";
    const total = (isFinite(p1)? (p1*qtd) : "");
    const row = [
      r.codigo || r.código || "",
      (r.descricao || r.descrição || "").replaceAll(";"," "),
      String(qtd || ""),
      String(p1 ?? ""),
      String(b1?.loja ?? ""),
      String(b1?.link ?? ""),
      String(total ?? ""),
      String(p2 ?? ""),
      String(p3 ?? "")
    ];
    lines.push(row.join(";"));
  }
  const qid = lastQuoteJson.quote_id || "cotacao";
  downloadText(`${qid}_resultado.csv`, lines.join("\n"));
  toast("ok","CSV exportado", `${qid}_resultado.csv`);
}

/* ====== MODEL CSV ====== */
function downloadModel(){
  const model = "codigo,produto,ncm,quantidade,un\n2734,RED CA/C SCH 40 6 X 4,73079200,4,UN\n9999,TUBO AÇO CARBONO SCH40,73064000,12,UN\n";
  downloadText("modelo_itens_obr.csv", model);
  toast("ok","Modelo baixado","modelo_itens_obr.csv");
}

/* ====== UI EVENTS ====== */
$("btnSearch").addEventListener("click", loadQuotes);
$("btnRefresh").addEventListener("click", loadQuotes);
$("q").addEventListener("keydown", (e)=>{ if (e.key==="Enter") loadQuotes(); });

$("btnPick").addEventListener("click", ()=> $("file").click());
$("file").addEventListener("change", ()=>{ if ($("file").files?.[0]) toast("ok","Arquivo selecionado", $("file").files[0].name); });

$("csvSource").addEventListener("change", ()=>{
  const v = $("csvSource").value;
  $("uploadBox").style.display = v==="upload" ? "flex" : "none";
  $("pasteBox").style.display = v==="paste" ? "block" : "none";
});

$("btnPreview").addEventListener("click", loadCsvAndPreview);
$("btnCreate").addEventListener("click", createQuote);
$("btnModel").addEventListener("click", downloadModel);

$("btnOpenCsv").addEventListener("click", ()=>{
  window.scrollTo({top: 0, behavior:"smooth"});
  toast("ok","Importar CSV","Use o painel da direita para carregar e criar a cotação.");
});

$("btnClose").addEventListener("click", ()=> $("mask").style.display="none");
$("mask").addEventListener("click", (e)=>{ if (e.target === $("mask")) $("mask").style.display="none"; });

$("btnCopyJson").addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText(JSON.stringify(lastQuoteJson||{}, null, 2));
    toast("ok","JSON copiado");
  }catch(e){
    toast("err","Não consegui copiar","Permissão de clipboard negada.");
  }
});
$("btnExport").addEventListener("click", exportResultCsv);

$("btnHelp").addEventListener("click", ()=>{
  toast("warn","Como funciona (modo simples)", "1) Importa CSV → 2) Cria cotação → 3) Worker processa → 4) Abre cotação e exporta resultado.");
});
$("btnMenu").addEventListener("click", ()=>{
  // ajuste se você tiver um menu principal
  window.location.href = "https://www.erpimpar.com.br/";
});

/* Drag & drop */
(function(){
  const drop = $("uploadBox");
  const fileInput = $("file");
  ["dragenter","dragover"].forEach(evt=>{
    drop.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add("drag"); });
  });
  ["dragleave","drop"].forEach(evt=>{
    drop.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove("drag"); });
  });
  drop.addEventListener("drop", (e)=>{
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (!f) return;
    fileInput.files = e.dataTransfer.files;
    toast("ok","CSV carregado no drop", f.name);
  });
  drop.addEventListener("click", (e)=>{
    // evita abrir quando clicar no botão
    if (e.target && e.target.closest("button")) return;
    fileInput.click();
  });
})();

/* INIT */
loadQuotes();
</script>
</body>
</html>
