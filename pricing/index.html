<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ERP √çMPAR ‚Äî Consulta de pre√ßos</title>
  <style>
    :root{
      --bg1:#07152c;
      --bg2:#0c2c6b;
      --bg3:#0f7a7b;
      --card:#071c2a;
      --card2:#062434;
      --text:#eaf2ff;
      --muted:#9bb2d6;
      --line:#1e6db8;
      --line2:#19b38a;
      --danger:#ff4d6d;
      --ok:#3bf1a8;
      --btn1:#1a74ff;
      --btn2:#00c08b;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius:22px;
      --radius2:16px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 800px at 20% 25%, rgba(30,109,184,.35), transparent 55%),
        radial-gradient(900px 700px at 80% 30%, rgba(25,179,138,.25), transparent 55%),
        linear-gradient(120deg, var(--bg1), var(--bg2) 45%, var(--bg3));
      overflow-x:hidden;
    }
    .topbar{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(10px);
      background: rgba(3,10,22,.45);
      border-bottom:1px solid rgba(140,180,255,.12);
      padding:14px 22px;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:260px}
    .brand .logo{
      width:44px; height:44px; border-radius:14px;
      background: conic-gradient(from 200deg, #2cffda, #1a74ff, #ff7a3d, #2cffda);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    .brand .txt{line-height:1.1}
    .brand .txt b{display:block; letter-spacing:.6px}
    .brand .txt span{color:var(--muted); font-size:12px}
    .pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 14px; border-radius:999px;
      border:1px solid rgba(140,180,255,.18);
      background: rgba(0,0,0,.18);
      min-width:280px;
    }
    .pill input{
      width:100%;
      background:transparent;
      border:0; outline:0;
      color:var(--text);
      font-size:13px;
    }
    .btn{
      border:0; cursor:pointer; user-select:none;
      color:#fff; font-weight:700;
      padding:11px 16px; border-radius:999px;
      display:inline-flex; align-items:center; gap:10px;
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      white-space:nowrap;
    }
    .btn:active{transform: translateY(1px) scale(.99)}
    .btn.primary{background: linear-gradient(135deg, var(--btn1), #45b8ff)}
    .btn.success{background: linear-gradient(135deg, var(--btn2), #47ffd1)}
    .btn.ghost{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(140,180,255,.18);
      box-shadow:none;
      color:var(--text);
    }
    .btn.warn{background: linear-gradient(135deg, #ff7a3d, #ffd36a)}
    .container{
      max-width: 1200px;
      margin: 22px auto;
      padding: 0 18px 30px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:18px;
    }
    .card{
      background: linear-gradient(180deg, rgba(6,36,52,.92), rgba(4,24,40,.92));
      border-radius: var(--radius);
      border:1px solid rgba(140,180,255,.16);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(600px 240px at 20% 0%, rgba(26,116,255,.22), transparent 60%),
                  radial-gradient(500px 220px at 80% 0%, rgba(0,192,139,.18), transparent 60%);
      pointer-events:none;
    }
    .card .hd{
      padding:18px 18px 12px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      position:relative;
    }
    .card .hd h2{margin:0; font-size:18px; letter-spacing:.4px}
    .tag{
      font-size:12px; color:var(--muted);
      padding:7px 10px; border-radius:999px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(140,180,255,.14);
      white-space:nowrap;
    }
    .card .bd{padding: 0 18px 18px; position:relative;}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;}
    .field{flex:1; min-width:220px}
    label{display:block; font-size:12px; color:var(--muted); margin:12px 0 6px}
    .input{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(140,180,255,.22);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
      transition: border-color .12s ease, box-shadow .12s ease, transform .12s ease;
      font-size: 14px;
    }
    .input::placeholder{color: rgba(180,205,245,.5)}
    .input:focus{
      border-color: rgba(69,184,255,.95);
      box-shadow: 0 0 0 4px rgba(26,116,255,.16);
    }
    .input.invalid{
      border-color: rgba(255,77,109,.95) !important;
      box-shadow: 0 0 0 4px rgba(255,77,109,.14) !important;
      animation: shake .35s linear;
    }
    @keyframes shake{
      0%,100%{transform:translateX(0)}
      20%{transform:translateX(-6px)}
      40%{transform:translateX(6px)}
      60%{transform:translateX(-4px)}
      80%{transform:translateX(4px)}
    }
    .help{font-size:12px; color: rgba(205,220,255,.75); margin-top:8px}
    .drop{
      margin-top:12px;
      border-radius: var(--radius2);
      border:1px dashed rgba(140,180,255,.35);
      background: rgba(0,0,0,.16);
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      transition: border-color .12s ease, background .12s ease, transform .12s ease;
    }
    .drop.drag{border-color: rgba(69,184,255,.95); background: rgba(26,116,255,.10); transform: translateY(-1px);}
    .drop small{color: rgba(205,220,255,.75)}
    .tableWrap{
      margin-top:14px;
      border-radius: 16px;
      overflow:hidden;
      border:1px solid rgba(140,180,255,.14);
      background: rgba(0,0,0,.16);
      max-height: 360px;
      overflow:auto;
    }
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{padding:10px 10px; border-bottom:1px solid rgba(140,180,255,.10); vertical-align:top}
    th{position:sticky; top:0; background: rgba(3,10,22,.75); backdrop-filter: blur(8px); text-align:left; color: rgba(220,235,255,.9); font-weight:800}
    td{color: rgba(230,242,255,.92)}
    .muted{color: rgba(190,210,245,.75)}
    .right{display:flex; justify-content:flex-end; gap:10px; align-items:center; flex-wrap:wrap}
    .divider{height:1px; background: rgba(140,180,255,.12); margin:14px 0}
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(3,10,22,.88);
      border:1px solid rgba(140,180,255,.18);
      box-shadow: 0 20px 50px rgba(0,0,0,.45);
      padding: 12px 14px;
      border-radius: 16px;
      max-width: 92vw;
      display:none;
      gap:10px;
      align-items:flex-start;
      z-index: 10;
    }
    .toast.show{display:flex; animation: pop .18s ease-out}
    @keyframes pop{from{transform:translateX(-50%) translateY(8px); opacity:0} to{transform:translateX(-50%) translateY(0); opacity:1}}
    .spinner{
      width:18px; height:18px; border-radius:999px;
      border:2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.95);
      animation: spin .85s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .statusPill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(140,180,255,.18);
      background: rgba(0,0,0,.18);
      color: rgba(230,242,255,.95);
      font-size:12px;
    }
    .dot{width:8px; height:8px; border-radius:999px; background: rgba(69,184,255,.9)}
    .dot.ok{background: rgba(59,241,168,.95)}
    .dot.bad{background: rgba(255,77,109,.95)}
    .fadeIn{animation: fadeIn .18s ease-out}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}
    .ver{
      position: fixed; right: 14px; bottom: 12px;
      color: rgba(210,225,255,.55);
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div class="txt">
        <b>ERP √çMPAR</b>
        <span>Consulta de pre√ßos ‚Ä¢ SerpAPI</span>
      </div>
    </div>

    <div class="pill" title="Chave do ERP √çMPAR (header X-API-KEY)">
      <span style="opacity:.85">üîë</span>
      <input id="erpKey" placeholder="X-API-KEY (obrigat√≥rio)" autocomplete="off"/>
    </div>

    <div class="right">
      <button class="btn ghost" id="btnMenu">‚Üê Menu</button>
      <button class="btn primary" id="btnSaveKey">Salvar chave</button>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <section class="card fadeIn">
        <div class="hd">
          <div>
            <h2>1) Criar cota√ß√£o</h2>
            <div class="help">Importe um CSV, revise os itens e clique em <b>Criar cota√ß√£o</b>. O sistema gera um <b>quote_id</b> e salva em <span class="muted">/storage/data/quotes</span>.</div>
          </div>
          <div class="tag">CSV ‚Üí quote.json</div>
        </div>
        <div class="bd">
          <div class="row">
            <div class="field">
              <label>Obra (obra_id)</label>
              <input class="input" id="obraId" placeholder="Ex.: OBRA_001" value="OBRA_001"/>
            </div>
            <div class="field">
              <label>Origem do CSV</label>
              <select class="input" id="csvMode">
                <option value="upload">Upload do arquivo</option>
                <option value="paste">Colar conte√∫do CSV</option>
              </select>
            </div>
          </div>

          <div id="uploadBox" class="drop">
            <div>
              <b>Arraste o CSV aqui</b><br/>
              <small>ou clique para selecionar. Colunas: codigo, descricao, qtd (opcional: ncm, un)</small>
            </div>
            <input type="file" id="csvFile" accept=".csv,text/csv" style="display:none"/>
            <button class="btn ghost" id="btnPick">Selecionar CSV</button>
          </div>

          <div id="pasteBox" style="display:none">
            <label>Conte√∫do CSV</label>
            <textarea class="input" id="csvText" rows="8" placeholder="codigo,descricao,qtd&#10;2734,RED CA/C SCH 40 6 X 4,1"></textarea>
            <div class="help">Dica: pode copiar direto do Excel (Salvar como CSV) e colar aqui.</div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="field" style="min-width:320px">
              <div class="statusPill" id="csvStatus"><span class="dot"></span><span>Nenhum CSV carregado</span></div>
            </div>
            <div class="right" style="flex:1">
              <button class="btn ghost" id="btnModelo">Baixar modelo CSV</button>
              <button class="btn success" id="btnParse">Carregar & Pr√©-visualizar</button>
              <button class="btn primary" id="btnCreate">Criar cota√ß√£o</button>
            </div>
          </div>

          <div class="tableWrap" id="previewWrap" style="display:none">
            <table id="previewTable">
              <thead>
                <tr>
                  <th style="width:90px">C√≥digo</th>
                  <th>Descri√ß√£o</th>
                  <th style="width:70px">Qtd</th>
                  <th style="width:90px">NCM</th>
                  <th style="width:70px">UN</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

        </div>
      </section>

      <aside class="card fadeIn">
        <div class="hd">
          <div>
            <h2>2) Acompanhar resultados</h2>
            <div class="help">Cole um <b>quote_id</b> e consulte o JSON salvo no storage. O <b>worker.py</b> preenche os pre√ßos.</div>
          </div>
          <div class="tag">quote_id ‚Üí status</div>
        </div>
        <div class="bd">
          <label>Quote ID</label>
          <input class="input" id="quoteId" placeholder="Ex.: Q-20260106-215649"/>

          <div class="row">
            <div class="field">
              <label>Atualiza√ß√£o autom√°tica</label>
              <select class="input" id="poll">
                <option value="off">Desligado</option>
                <option value="on">Ligado (2,5s)</option>
              </select>
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button class="btn primary" id="btnGet">Consultar</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="statusPill" id="quoteStatus"><span class="dot"></span><span>Sem consulta</span></div>

          <div class="tableWrap" id="resultWrap" style="display:none">
            <table id="resultTable">
              <thead>
                <tr>
                  <th style="width:90px">C√≥digo</th>
                  <th>Descri√ß√£o</th>
                  <th style="width:70px">Qtd</th>
                  <th style="width:120px">Melhor (R$)</th>
                  <th>Loja</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="divider"></div>

          <div class="right">
            <button class="btn ghost" id="btnOpenJson">Abrir JSON</button>
            <button class="btn warn" id="btnCopyJson">Copiar JSON</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast">
    <div id="toastIcon">‚ÑπÔ∏è</div>
    <div>
      <div id="toastTitle" style="font-weight:900; margin-bottom:2px">Aviso</div>
      <div id="toastMsg" style="color:rgba(220,235,255,.85); font-size:13px">
<button id="btnImportCsvObra" class="btn btn-green" type="button">Importar CSV (Obra)</button>
</div>
    </div>
  </div>

  <div class="ver">pricing ‚Ä¢ v1.0.0</div>

<script>
(() => {
  const API_BASE = "https://api.erpimpar.com.br/pricing"; // usa o rewrite que voc√™ j√° tem
  const MODEL_CSV_URL = "./modelo_itens_pricing.csv";

  const $  = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

  let parsedItems = [];
  let lastJsonText = "";
  let pollTimer = null;

  const toast = (title, msg, icon="‚ÑπÔ∏è", ms=3200) => {
    $("#toastIcon").textContent = icon;
    $("#toastTitle").textContent = title;
    $("#toastMsg").textContent = msg;
    const t = $("#toast");
    t.classList.add("show");
    clearTimeout(t._tm);
    t._tm = setTimeout(() => t.classList.remove("show"), ms);
  };

  const setInvalid = (el, msg) => {
    el.classList.add("invalid");
    setTimeout(() => el.classList.remove("invalid"), 450);
    if (msg) toast("Valida√ß√£o", msg, "‚ö†Ô∏è");
  };

  const getKey = () => $("#erpKey").value.trim() || localStorage.getItem("impar_x_api_key") || "";
  const setKey = (k) => { localStorage.setItem("impar_x_api_key", k); };

  function setCsvStatus(ok, text){
    const pill = $("#csvStatus");
    const dot = pill.querySelector(".dot");
    dot.className = "dot " + (ok ? "ok" : "bad");
    pill.querySelector("span:nth-child(2)").textContent = text;
  }
  function setQuoteStatus(kind, text){
    const pill = $("#quoteStatus");
    const dot = pill.querySelector(".dot");
    dot.className = "dot " + (kind === "ok" ? "ok" : kind === "bad" ? "bad" : "");
    pill.querySelector("span:nth-child(2)").textContent = text;
  }

  function csvToRows(csvText){
    const lines = csvText
      .split(/\r?\n/)
      .map(l => l.trim())
      .filter(l => l.length);

    if (!lines.length) return [];

    const sep = lines[0].includes(";") ? ";" : ",";
    const parseLine = (line) => {
      // parser simples (suporta aspas)
      const out = [];
      let cur = "", inQ = false;
      for (let i=0;i<line.length;i++){
        const ch = line[i];
        if (ch === '"'){ inQ = !inQ; continue; }
        if (!inQ && ch === sep){ out.push(cur.trim()); cur=""; continue; }
        cur += ch;
      }
      out.push(cur.trim());
      return out;
    };

    const header = parseLine(lines[0]).map(h => h.toLowerCase().trim());
    const idx = (name) => header.indexOf(name);

    const iCodigo = idx("codigo");
    const iDesc   = idx("descricao");
    const iQtd    = idx("qtd");
    const iNcm    = idx("ncm");
    const iUn     = idx("un");

    if (iCodigo < 0 || iDesc < 0){
      throw new Error("Cabe√ßalho inv√°lido. Precisa ter colunas: codigo, descricao (qtd opcional).");
    }

    const rows = [];
    for (let r=1; r<lines.length; r++){
      const cols = parseLine(lines[r]);
      const codigo = (cols[iCodigo] ?? "").trim();
      const descricao = (cols[iDesc] ?? "").trim();
      const qtdRaw = (iQtd >= 0 ? (cols[iQtd] ?? "1") : "1").trim();

      if (!codigo && !descricao) continue;

      const qtd = Number(String(qtdRaw).replace(",", ".")) || 1;

      rows.push({
        codigo,
        descricao,
        qtd,
        ncm: iNcm >= 0 ? (cols[iNcm] ?? "").trim() : "",
        un:  iUn  >= 0 ? (cols[iUn]  ?? "").trim() : ""
      });
    }
    return rows;
  }

  function renderPreview(rows){
    const wrap = $("#previewWrap");
    const tb = $("#previewTable tbody");
    tb.innerHTML = "";
    rows.forEach(it => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(it.codigo)}</td>
        <td>${escapeHtml(it.descricao)}</td>
        <td>${escapeHtml(String(it.qtd))}</td>
        <td class="muted">${escapeHtml(it.ncm || "-")}</td>
        <td class="muted">${escapeHtml(it.un || "-")}</td>
      `;
      tb.appendChild(tr);
    });
    wrap.style.display = rows.length ? "block" : "none";
  }

  function renderResults(json){
    const wrap = $("#resultWrap");
    const tb = $("#resultTable tbody");
    tb.innerHTML = "";
    const res = Array.isArray(json.resultados) ? json.resultados : [];
    res.forEach(it => {
      const best = it.melhor_oferta || {};
      const price = (best.preco ?? best.pre√ßo ?? null);
      const loja = best.loja ?? best.Loja ?? "-";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(it.codigo ?? it.c√≥digo ?? "")}</td>
        <td>${escapeHtml(it.descricao ?? it.descri√ß√£o ?? "")}</td>
        <td>${escapeHtml(String(it.qtd ?? ""))}</td>
        <td><b>${price != null ? fmtBRL(price) : "-"}</b></td>
        <td class="muted">${escapeHtml(loja)}</td>
      `;
      tb.appendChild(tr);
    });
    wrap.style.display = res.length ? "block" : "none";
  }

  function fmtBRL(n){
    const num = Number(n);
    if (!Number.isFinite(num)) return String(n);
    return num.toLocaleString("pt-BR", {minimumFractionDigits:2, maximumFractionDigits:2});
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  async function apiFetch(path, options={}){
    const key = getKey();
    if (!key){
      throw new Error("X-API-KEY n√£o informada. Cole a chave e clique em 'Salvar chave'.");
    }
    const headers = Object.assign({
      "Content-Type": "application/json",
      "X-API-KEY": key
    }, options.headers || {});
    const resp = await fetch(`${API_BASE}/${path}`, {...options, headers});
    const text = await resp.text();
    let json = null;
    try { json = JSON.parse(text); } catch(e) {}
    if (!resp.ok){
      const msg = (json && (json.error || json.message)) ? (json.error || json.message) : text.slice(0,180);
      throw new Error(`${resp.status} ${resp.statusText} ‚Äî ${msg}`);
    }
    return json ?? text;
  }

  async function handleParse(){
    try{
      const mode = $("#csvMode").value;
      let csv = "";
      if (mode === "upload"){
        const f = $("#csvFile").files[0];
        if (!f) { setInvalid($("#btnPick"), "Selecione um CSV primeiro."); return; }
        csv = await f.text();
      } else {
        csv = $("#csvText").value;
        if (!csv.trim()) { setInvalid($("#csvText"), "Cole o conte√∫do CSV."); return; }
      }

      const rows = csvToRows(csv);
      parsedItems = rows;
      renderPreview(rows);
      setCsvStatus(true, `Itens carregados: ${rows.length}`);
      toast("CSV", `Pr√©-visualiza√ß√£o pronta (${rows.length} itens).`, "‚úÖ");
    } catch(err){
      parsedItems = [];
      renderPreview([]);
      setCsvStatus(false, "Falha ao ler o CSV");
      toast("CSV inv√°lido", err.message || String(err), "‚ùå", 5200);
    }
  }

  async function handleCreate(){
    try{
      const obraId = $("#obraId").value.trim();
      if (!obraId) { setInvalid($("#obraId"), "Informe o obra_id."); return; }
      if (!parsedItems.length){ setInvalid($("#btnParse"), "Carregue & pr√©-visualize o CSV antes."); return; }

      $("#btnCreate").disabled = true;
      $("#btnCreate").innerHTML = `<span class="spinner"></span> Criando...`;

      const payload = {
        obra_id: obraId,
        itens: parsedItems.map(it => ({
          codigo_erp: it.codigo,
          descricao: it.descricao,
          ncm: it.ncm || null,
          qtd: it.qtd,
          un: it.un || null
        }))
      };

      const json = await apiFetch("create_quote.php", {
        method: "POST",
        body: JSON.stringify(payload)
      });

      const qid = json.quote_id || json.quoteId || json.id;
      if (qid){
        $("#quoteId").value = qid;
        toast("Cota√ß√£o criada", `quote_id: ${qid}`, "‚úÖ", 5200);
      } else {
        toast("Cota√ß√£o criada", "Resposta sem quote_id (verifique o retorno).", "‚úÖ", 5200);
      }

    } catch(err){
      toast("Erro ao criar", err.message || String(err), "‚ùå", 6500);
    } finally {
      $("#btnCreate").disabled = false;
      $("#btnCreate").textContent = "Criar cota√ß√£o";
    }
  }

  async function handleGet(){
    try{
      const qid = $("#quoteId").value.trim();
      if (!qid){ setInvalid($("#quoteId"), "Informe o quote_id."); return; }

      $("#btnGet").disabled = true;
      $("#btnGet").innerHTML = `<span class="spinner"></span> Consultando...`;

      const json = await apiFetch(`get_quote.php?quote_id=${encodeURIComponent(qid)}`, { method:"GET", headers:{} });
      lastJsonText = JSON.stringify(json, null, 2);

      const st = json.status || json.estado || "ok";
      setQuoteStatus("ok", `Status: ${st}`);
      renderResults(json);

      toast("Consulta OK", `quote_id ${qid} carregado.`, "‚úÖ");
    } catch(err){
      setQuoteStatus("bad", "Erro na consulta");
      $("#resultWrap").style.display = "none";
      toast("Erro", err.message || String(err), "‚ùå", 6500);
    } finally {
      $("#btnGet").disabled = false;
      $("#btnGet").textContent = "Consultar";
    }
  }

  function startPoll(){
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(() => {
      const qid = $("#quoteId").value.trim();
      if (qid) handleGet();
    }, 2500);
  }
  function stopPoll(){
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = null;
  }

  // UI bindings
  $("#btnMenu").addEventListener("click", () => window.location.href = "/menu.html");
  $("#btnSaveKey").addEventListener("click", () => {
    const k = $("#erpKey").value.trim();
    if (!k){ setInvalid($("#erpKey"), "Cole sua X-API-KEY."); return; }
    setKey(k);
    toast("Chave salva", "X-API-KEY armazenada no navegador.", "üîê");
  });

  // Restore key if exists
  const saved = localStorage.getItem("impar_x_api_key");
  if (saved) $("#erpKey").value = saved;

  $("#csvMode").addEventListener("change", () => {
    const mode = $("#csvMode").value;
    $("#uploadBox").style.display = (mode === "upload") ? "flex" : "none";
    $("#pasteBox").style.display = (mode === "paste") ? "block" : "none";
  });

  $("#btnPick").addEventListener("click", () => $("#csvFile").click());
  $("#csvFile").addEventListener("change", () => {
    const f = $("#csvFile").files[0];
    if (f) setCsvStatus(true, `Arquivo selecionado: ${f.name}`);
  });

  const drop = $("#uploadBox");
  drop.addEventListener("click", (e) => {
    if (e.target && e.target.id === "btnPick") return;
    $("#csvFile").click();
  });
  ["dragenter","dragover"].forEach(ev => drop.addEventListener(ev, (e) => {
    e.preventDefault(); e.stopPropagation();
    drop.classList.add("drag");
  }));
  ["dragleave","drop"].forEach(ev => drop.addEventListener(ev, (e) => {
    e.preventDefault(); e.stopPropagation();
    drop.classList.remove("drag");
  }));
  drop.addEventListener("drop", async (e) => {
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (!f) return;
    if (!f.name.toLowerCase().endsWith(".csv")){
      toast("Arquivo inv√°lido", "Envie um .csv", "‚ùå");
      return;
    }
    const dt = new DataTransfer();
    dt.items.add(f);
    $("#csvFile").files = dt.files;
    setCsvStatus(true, `Arquivo selecionado: ${f.name}`);
  });

  $("#btnModelo").addEventListener("click", () => window.open(MODEL_CSV_URL, "_blank"));
  $("#btnParse").addEventListener("click", handleParse);
  $("#btnCreate").addEventListener("click", handleCreate);

  $("#btnGet").addEventListener("click", handleGet);
  $("#poll").addEventListener("change", () => {
    if ($("#poll").value === "on"){ startPoll(); toast("Auto", "Atualiza√ß√£o autom√°tica ligada.", "‚è±Ô∏è"); }
    else { stopPoll(); toast("Auto", "Atualiza√ß√£o autom√°tica desligada.", "‚èπÔ∏è"); }
  });

  $("#btnOpenJson").addEventListener("click", () => {
    const qid = $("#quoteId").value.trim();
    if (!qid){ setInvalid($("#quoteId"), "Informe o quote_id."); return; }
    const url = `${API_BASE}/get_quote.php?quote_id=${encodeURIComponent(qid)}`;
    window.open(url, "_blank");
  });

  $("#btnCopyJson").addEventListener("click", async () => {
    if (!lastJsonText){ toast("Nada para copiar", "Fa√ßa uma consulta primeiro.", "‚ö†Ô∏è"); return; }
    try{
      await navigator.clipboard.writeText(lastJsonText);
      toast("Copiado", "JSON copiado para a √°rea de transfer√™ncia.", "üìã");
    }catch(e){
      toast("Falha ao copiar", "Seu navegador bloqueou a c√≥pia autom√°tica.", "‚ùå");
    }
  });

})();
</script>

<!-- CSV OBRA -->
<input id="csvObraFile" type="file" accept=".csv,text/csv" style="display:none" />


<script>

/* ============================================================
   ERP √çMPAR ‚Äî PRICING ‚Äî Importar CSV de Obra (Caminho 3)
   CSV: codigo,produto,ncm,quantidade
   ============================================================ */

const CSV_COLUMNS = ["codigo","produto","ncm","quantidade"];
const API_KEY_QS_NAME = "x_api_key"; // Caminho A (sem preflight)
const EXPORT_DEFAULT_TOP = 3;

function getKey() {
  // compatibilidade com suas chaves antigas
  const candidates = ["IMPAR_PRICING_API_KEY","impar_x_api_key","impar_api_key","imp4r_api_key","IMPAR_API_KEY"];
  for (const k of candidates) {
    const v = (localStorage.getItem(k)||"").trim();
    if (v) return v;
  }
  return "";
}

function setKey(v){
  v = (v||"").trim();
  if (!v) return;
  localStorage.setItem("IMPAR_PRICING_API_KEY", v);
  localStorage.setItem("impar_x_api_key", v);
}

async function apiFetch(path, opts = {}) {
  const apiKey = getKey();
  if (!apiKey) throw new Error("Chave de API n√£o encontrada. Clique em CONFIGURAR CHAVE.");
  let url = API_BASE + path;
  url += (url.includes("?") ? "&" : "?") + API_KEY_QS_NAME + "=" + encodeURIComponent(apiKey);

  const method = (opts.method || "GET").toUpperCase();
  const headers = Object.assign({}, (opts.headers || {}));
  // N√£o colocar Content-Type em GET evita preflight em alguns cen√°rios
  if (method !== "GET") headers["Content-Type"] = "application/json";

  const res = await fetch(url, {
    method,
    headers,
    body: opts.body ? JSON.stringify(opts.body) : undefined
  });

  const text = await res.text();
  let data;
  try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }
  if (!res.ok) {
    const err = new Error((data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${res.status}`);
    err.status = res.status;
    err.data = data;
    throw err;
  }
  return data;
}

// CSV parser (supports ; or , and quoted fields)
function parseCsv(text){
  text = (text||"").replace(/
/g,"").trim();
  if (!text) return { headers: [], rows: [] };

  // detect separator
  const firstLine = text.split("
")[0];
  const sep = (firstLine.includes(";") && !firstLine.includes(",")) ? ";" : ",";

  const rows = [];
  let row = [], cur = "", inQuotes = false;
  for (let i=0;i<text.length;i++){
    const ch = text[i];
    if (ch === '"'){
      if (inQuotes && text[i+1] === '"'){ cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (!inQuotes && ch === sep){
      row.push(cur); cur = "";
    } else if (!inQuotes && ch === "
"){
      row.push(cur); rows.push(row); row = []; cur = "";
    } else {
      cur += ch;
    }
  }
  row.push(cur); rows.push(row);

  const headers = rows[0].map(h => (h||"").trim().toLowerCase());
  const dataRows = rows.slice(1).filter(r => r.some(c => String(c||"").trim() !== ""));
  return { headers, rows: dataRows, sep };
}

function mapCsvToItems(parsed){
  const { headers, rows } = parsed;
  // indices by header
  const idx = {};
  for (const col of CSV_COLUMNS) {
    const i = headers.indexOf(col);
    idx[col] = i;
  }
  // allow synonyms
  if (idx["produto"] < 0) idx["produto"] = headers.indexOf("descricao");
  if (idx["quantidade"] < 0) idx["quantidade"] = headers.indexOf("qtd");

  const items = [];
  for (const r of rows){
    const codigo = (idx["codigo"]>=0 ? r[idx["codigo"]] : r[0]) || "";
    const produto = (idx["produto"]>=0 ? r[idx["produto"]] : r[1]) || "";
    const ncm = (idx["ncm"]>=0 ? r[idx["ncm"]] : r[2]) || "";
    const qtdRaw = (idx["quantidade"]>=0 ? r[idx["quantidade"]] : r[3]) || "1";
    const qtd = Number(String(qtdRaw).replace(".", "").replace(",", ".")) || 1;

    const p = String(produto||"").trim();
    if (!p) continue;

    items.push({
      codigo: String(codigo||"").trim(),
      produto: p,
      ncm: String(ncm||"").trim(),
      quantidade: qtd
    });
  }
  return items;
}

function money(v){
  const n = Number(v);
  if (!isFinite(n)) return "-";
  return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
}

function sortOffers(offers){
  return (offers||[])
    .map(o => ({
      loja: o.loja || o.Loja || o.store || o.source || o.merchant || o.seller || o.armazenar || "",
      titulo: o.title || o.titulo || "",
      link: o.link || o.url || null,
      preco: (o.preco ?? o.pre√ßo ?? o.price ?? null),
      moeda: o.moeda || o.currency || "BRL"
    }))
    .filter(o => o.preco !== null && o.preco !== undefined)
    .sort((a,b) => Number(a.preco) - Number(b.preco));
}

function bestN(offers, n=3){
  const s = sortOffers(offers);
  return s.slice(0, n);
}

function normalizeResults(quote){
  const resultados = quote.resultados || quote.results || [];
  return resultados.map(r => {
    const codigo = r.codigo || r.c√≥digo || "";
    const produto = r.produto || r.descricao || r.descri√ß√£o || r.description || "";
    const ncm = r.ncm || null;
    const qtd = r.quantidade ?? r.qtd ?? 1;
    const offers = r.ofertas || r.offers || [];
    const top = bestN(offers, 3);

    // fallback if melhor_oferta exists but ofertas empty
    if (!top.length) {
      const b = r.melhor_oferta || r.best_offer || null;
      if (b) top.push({
        loja: b.loja || b.Loja || "",
        titulo: b.title || "",
        link: b.link || null,
        preco: b.preco ?? b.pre√ßo ?? b.price ?? null,
        moeda: b.moeda || b.currency || "BRL"
      });
    }

    return { codigo, produto, ncm, qtd: Number(qtd)||1, top };
  });
}

function renderQuoteTable(quote){
  const container = document.getElementById("quoteHumanTable");
  if (!container) return;

  const rows = normalizeResults(quote);
  const payload = quote.carga_util || quote.payload || {};
  const obraId = payload.obra_id || quote.obra_id || "";
  const header = `
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin:10px 0 6px 0;">
      <div style="font-weight:800">Obra: ${obraId || "-"} ‚Ä¢ Cota√ß√£o: ${quote.quote_id || "-"}</div>
      <div style="opacity:.85">Status: ${quote.status || "-"}</div>
    </div>
  `;

  let totalGeral = 0;

  const bodyRows = rows.map((r, i) => {
    const best = r.top[0] || {};
    const second = r.top[1] || {};
    const third = r.top[2] || {};
    const unit = Number(best.preco);
    const total = isFinite(unit) ? unit * r.qtd : NaN;
    if (isFinite(total)) totalGeral += total;

    const linkBtn = (o) => o && o.link ? `<a class="btn btn-mini" href="${o.link}" target="_blank" rel="noopener">Abrir</a>` : `<span style="opacity:.55">-</span>`;

    return `
      <tr>
        <td>${i+1}</td>
        <td><div style="font-weight:700">${(r.codigo||"-")}</div><div style="opacity:.85">${(r.ncm||"")}</div></td>
        <td style="min-width:260px"><div style="font-weight:700">${r.produto || "-"}</div></td>
        <td style="text-align:right;font-weight:700">${r.qtd}</td>

        <td>
          <div style="font-weight:800">${money(best.preco)}</div>
          <div style="opacity:.85">${best.loja || "-"}</div>
          <div>${linkBtn(best)}</div>
        </td>
        <td style="text-align:right;font-weight:800">${isFinite(total) ? money(total) : "-"}</td>

        <td>
          <div style="font-weight:700">${money(second.preco)}</div>
          <div style="opacity:.85">${second.loja || "-"}</div>
          <div>${linkBtn(second)}</div>
        </td>
        <td>
          <div style="font-weight:700">${money(third.preco)}</div>
          <div style="opacity:.85">${third.loja || "-"}</div>
          <div>${linkBtn(third)}</div>
        </td>
      </tr>
    `;
  }).join("");

  const footer = `
    <div style="margin-top:10px;display:flex;justify-content:flex-end">
      <div style="padding:10px 14px;border-radius:12px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.08);font-weight:900">
        Total (Melhor): ${money(totalGeral)}
      </div>
    </div>
  `;

  container.innerHTML = `
    ${header}
    <div class="table-wrap">
      <table class="table table-impar">
        <thead>
          <tr>
            <th>#</th>
            <th>C√≥digo / NCM</th>
            <th>Produto</th>
            <th style="text-align:right">Qtd</th>
            <th>Melhor (Loja/Pre√ßo/Link)</th>
            <th style="text-align:right">Total</th>
            <th>2¬∫ Melhor</th>
            <th>3¬∫ Melhor</th>
          </tr>
        </thead>
        <tbody>
          ${bodyRows || `<tr><td colspan="8" style="opacity:.85">Sem resultados ainda. Rode o worker e clique em Atualizar.</td></tr>`}
        </tbody>
      </table>
    </div>
    ${footer}
  `;
}

// Adds a panel below list for human table
function ensureHumanPanel(){
  if (document.getElementById("quoteHumanTable")) return;
  const host = document.querySelector("#quotesSection") || document.body;
  const panel = document.createElement("div");
  panel.id = "quoteHumanPanel";
  panel.style.marginTop = "16px";
  panel.innerHTML = `
    <div class="card">
      <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
        <div>
          <div style="font-weight:900;font-size:16px">Tabela de Cota√ß√£o (Obra)</div>
          <div style="opacity:.8;font-size:12px">Melhor / 2¬∫ / 3¬∫ ‚Ä¢ Total por item e total geral</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnExportCsv" class="btn btn-dark" type="button">Exportar CSV</button>
          <button id="btnExportExcel" class="btn btn-dark" type="button">Exportar Excel</button>
        </div>
      </div>
      <div class="card-body" id="quoteHumanTable" style="overflow:auto"></div>
    </div>
  `;
  host.appendChild(panel);

  document.getElementById("btnExportCsv").addEventListener("click", () => {
    if (!window.__lastQuoteId) return alert("Selecione uma cota√ß√£o primeiro (clique em VER).");
    const key = getKey();
    window.open(API_BASE + `/export_quote_csv.php?quote_id=${encodeURIComponent(window.__lastQuoteId)}&x_api_key=${encodeURIComponent(key)}`, "_blank");
  });
  document.getElementById("btnExportExcel").addEventListener("click", () => {
    if (!window.__lastQuoteId) return alert("Selecione uma cota√ß√£o primeiro (clique em VER).");
    const key = getKey();
    window.open(API_BASE + `/export_quote_excel.php?quote_id=${encodeURIComponent(window.__lastQuoteId)}&x_api_key=${encodeURIComponent(key)}`, "_blank");
  });
}

async function openQuoteHuman(quoteId){
  ensureHumanPanel();
  window.__lastQuoteId = quoteId;
  const quote = await apiFetch(`/get_quote.php?quote_id=${encodeURIComponent(quoteId)}`);
  renderQuoteTable(quote);
}

async function importCsvObraFlow(file){
  const text = await file.text();
  const parsed = parseCsv(text);
  const items = mapCsvToItems(parsed);
  if (!items.length) {
    alert("CSV sem itens v√°lidos. Use colunas: codigo,produto,ncm,quantidade");
    return;
  }

  // obra name from file
  const obraNome = file.name.replace(/\.[^/.]+$/, "");
  const payload = { obra_nome: obraNome, itens: items };

  // Cria cota√ß√£o
  const out = await apiFetch("/upload_csv.php", {
    method: "POST",
    body: payload
  });

  alert(`CSV importado!
Obra: ${obraNome}
Itens: ${items.length}
Cota√ß√£o: ${out.quote_id}

Agora rode o worker (GitHub) e clique em Atualizar.`);
  if (typeof loadQuotes === "function") loadQuotes();
  // abre tabela mesmo sem resultados (vai mostrar "sem resultados")
  await openQuoteHuman(out.quote_id);
}

document.addEventListener("DOMContentLoaded", () => {
  ensureHumanPanel();

  const btn = document.getElementById("btnImportCsvObra");
  const input = document.getElementById("csvObraFile");
  if (btn && input) {
    btn.addEventListener("click", () => input.click());
    input.addEventListener("change", async () => {
      try{
        const f = input.files && input.files[0];
        if (!f) return;
        await importCsvObraFlow(f);
      } catch(e){
        console.error(e);
        alert("Falha ao importar CSV. Veja o console.");
      } finally {
        input.value = "";
      }
    });
  }

  // Hook: se existir uma fun√ß√£o de "ver" no seu sistema, tentamos interceptar
  // Voc√™ pode manualmente trocar o onclick de VER para: openQuoteHuman(quote_id)
  window.openQuoteHuman = openQuoteHuman;
});

</script>
</body>
</html>
