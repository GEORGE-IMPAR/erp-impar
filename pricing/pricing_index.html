<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ERP ÍMPAR — Consulta de preços</title>

<style>
:root{
      --bg:#020617;
      --card:#020617;
      --border:#1f2937;
      --text:#e5e7eb;
      --text-soft:#9ca3af;
      --blue:#3b82f6;
      --blue-dark:#1d4ed8;
      --green:#22c55e;
      --yellow:#eab308;
      --red:#ef4444;
      --accent:#cc6e00;
    }
    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:linear-gradient(120deg,#0b1e4a,#0e3b6e,#0f766e);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      padding:10px 16px 4px;
      display:flex;
      justify-content:center;
    }
    .header-inner{
      width:100%;
      max-width:1200px;
      display:flex;
      justify-content:space-between;
      gap:16px;
      align-items:flex-start;
    }
    .brand{
      display:flex;
      flex-direction:row;
      align-items:center;
      gap:12px;
      text-shadow:0 2px 6px rgba(0,0,0,.8);
    }
    .brand-txt{display:flex; flex-direction:column; gap:2px;}
    .brand-kicker{
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      opacity:.85;
    }
    .brand-title{
      font-size:16px;
      font-weight:800;
      letter-spacing:.02em;
    }
    .brand-sub{
      font-size:12px;
      opacity:.85;
    }
    .tag-top{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.7);
      color:var(--text-soft);
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:12px;
    }
    .pill-btn{
      border:none;
      background:transparent;
      color:inherit;
      font:inherit;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .pill-btn .icn{font-size:14px;}

    main{
      flex:1;
      display:flex;
      justify-content:center;
      padding:12px 16px 18px;
    }
    .layout{
      width:100%;
      max-width:1200px;
      display:flex;
      justify-content:center;
    }
    .container{
      width:100%;
      background:linear-gradient(120deg,#0b1e4a,#0e3b6e,#0f766e);
      border-radius:18px;
      border:1px solid rgba(148,163,184,.6);
      box-shadow:0 24px 60px rgba(15,23,42,.9);
      padding:18px 18px 16px;
    }

    h1{
      font-size:18px;
      margin-bottom:4px;
    }
    .subtitulo{
      font-size:12px;
      color:var(--text-soft);
      margin-bottom:10px;
    }

    form{
      margin-top:4px;
      font-size:12px;
    }
    label{
      display:block;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#9ca3af;
      margin-bottom:4px;
    }
    input,select{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #111827;
      background:#020617;
      color:var(--text);
      font-size:12px;
      outline:none;
    }
    input:focus,select:focus{
      border-color:var(--blue);
      box-shadow:0 0 0 1px rgba(59,130,246,.95), 0 0 18px rgba(59,130,246,.55), 0 0 46px rgba(29,78,216,.35);
    }
    input[disabled]{
      opacity:.85;
      cursor:not-allowed;
    }

    .form-row{
      display:flex;
      gap:12px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .form-row>div{
      flex:1 1 0;
      min-width:160px;
    }

    .modo-manual-box{
      margin-top:4px;
      font-size:11px;
      color:var(--text-soft);
    }
    .modo-manual-box label{
      text-transform:none;
      letter-spacing:0;
      display:flex;
      align-items:center;
      gap:6px;
      margin:0;
      cursor:pointer;
    }
    .modo-manual-box input[type="checkbox"]{
      width:auto;
      accent-color:var(--blue);
    }

    .btn-primary,
    .btn-secondary{
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      font-weight:600;
      cursor:pointer;
    }
    .btn-primary{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#020617;
      box-shadow:0 10px 30px rgba(22,163,74,.6);
    }
    .btn-secondary{
      background:#111827;
      color:#fff;
      border:1px solid #374151;
    }

    .actions{
      margin-top:8px;
      margin-bottom:4px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .header-info{
      margin-top:2px;
      margin-bottom:6px;
      font-size:12px;
      color:#cfd8ff;
    }
    .header-info strong{font-weight:600;}

    .table-wrapper{
      overflow-x:auto;
      border-radius:12px;
      border:1px solid #111827;
      margin-top:6px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      background:#020617;
      min-width:480px;
    }
    th,td{
      padding:5px 6px;
      border-bottom:1px solid #1f2937;
      text-align:left;
    }
    th{
      background:#020617;
      position:sticky;
      top:0;
      z-index:1;
      font-weight:600;
      color:var(--text-soft);
    }
    tbody tr:hover{
      background:#111827;
    }
    .btn-remover{
      cursor:pointer;
    }

    footer{
      background:#020617;
      color:#9ca3af;
      padding:6px 16px;
      font-size:10px;
    }
    .rodape-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    @media(max-width:900px){
      .container{padding:14px 12px 16px;}
      h1{font-size:16px;}
    }
  
/* =========================================================
   ÍMPAR PREMIUM (Menu) — Overrides Visuais
   *Não mexe em IDs, nomes e lógica do JS*
   ========================================================= */

:root{
  --p-bg-left:  #0b3a8a;
  --p-bg-mid:   #0b4c7a;
  --p-bg-right: #0a8a71;

  --p-card: rgba(2, 6, 23, .58);
  --p-card-2: rgba(2, 6, 23, .70);
  --p-border: rgba(255,255,255,.10);
  --p-border-soft: rgba(255,255,255,.08);

  --p-text: #e5e7eb;
  --p-text-soft: rgba(229,231,235,.78);

  --p-blue: #2f7bff;
  --p-blue-soft: rgba(47,123,255,.35);
  --p-green: #22c55e;

  --p-grad: linear-gradient(90deg, rgba(37,99,235,1), rgba(16,185,129,1));
  --p-grad-soft: linear-gradient(90deg, rgba(37,99,235,.25), rgba(16,185,129,.20));

  --p-radius: 22px;
  --p-radius-sm: 14px;
}

/* Fundo igual Menu */
body{
  color: var(--p-text) !important;
  background:linear-gradient(120deg,#0b1e4a,#0e3b6e,#0f766e);
      }
body{
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
.layout{
  flex:1 0 auto;
  width:100%;
}
footer{
  margin-top:auto;
}

/* Evita scroll horizontal em tabelas sem "empurrar" a página */
.tabela-wrapper{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}
.tabela-wrapper table{
  min-width: 760px; /* garante scroll dentro do wrapper, não no body */
}

/* Loader sempre centralizado */
/* Mobile (<= 720px) */
@media (max-width: 720px){
  header{
    padding: 14px 12px;
  }
  .header-inner{
    flex-wrap: wrap;
    gap: 10px;
  }
  .brand{
    flex: 1 1 auto;
    min-width: 0;
  }
  .brand-text{
    min-width:0;
  }
  .brand-line{
    white-space: normal;
    line-height: 1.15;
  }
  .brand-title{
    font-size: 18px;
  }
  .brand-sub{
    font-size: 12px;
  }
  .title-stack{
    flex: 1 1 100%;
    min-width: 0;
    text-align: left;
  }
  .page-title{
    font-size: 14px;
    white-space: normal;
    line-height: 1.15;
  }
  .sub-title{
    font-size: 12px;
    white-space: normal;
  }
  .actions{
    margin-left: auto;
  }

  .container{
    padding: 14px 12px 22px;
  }
  .card{
    padding: 16px;
    border-radius: 18px;
  }

  .form-row{
    gap: 10px;
  }
  .field{
    flex: 1 1 100%;
    min-width: 0;
  }

  .input,
  select,
  textarea{
    font-size: 14px;
  }

  /* Ícone do calendário: menor e integrado, sem “sobrar” */
  .date-icon-btn{
    width: 40px;
    right: 8px;
  }
  .field.has-icon input{
    padding-right: 52px !important;
  }

  /* Tabela: scroll dentro do card (sem quebrar layout) */
  .tabela-wrapper{
    margin-top: 10px;
    border-radius: 14px;
  }

  footer{
    padding: 12px 12px;
  }
}

/* Loader (igual menu) */
.loader-card{
  width:min(420px, 92vw);
  padding:18px 18px 16px;
  border-radius:18px;
  background: rgba(2,6,23,.66);
  border: 1px solid rgba(255,255,255,.10);
  box-shadow: 0 30px 80px rgba(0,0,0,.45);
  backdrop-filter: blur(12px);
  text-align:center;
}
.loader-title{ font-weight:700; letter-spacing:.2px; margin:2px 0 6px; }
.loader-sub{ color: rgba(229,231,235,.78); font-size:12px; margin:0 0 10px; }
.spinner{
  width:44px; height:44px;
  border-radius:999px;
  border:4px solid rgba(255,255,255,.14);
  border-top-color: rgba(37,99,235,1);
  border-right-color: rgba(16,185,129,1);
  animation: spin 0.9s linear infinite;
  margin: 0 auto 8px;
}
@keyframes spin{ to{ transform: rotate(360deg);} }

/* Date input with calendar icon */
.date-wrap{ position:relative; }
.date-wrap input[type="date"]{ padding-right:42px !important; }
.date-icn{
  position:absolute; right:10px; top:50%;
  transform: translateY(-50%);
  width:30px; height:30px;
  border-radius:10px;
  display:grid; place-items:center;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  cursor:pointer;
  transition: transform .15s ease, background .15s ease, box-shadow .15s ease;
}
.date-icn:hover{
  transform: translateY(-50%) scale(1.03);
  background: rgba(255,255,255,.08);
  box-shadow: 0 12px 28px rgba(0,0,0,.22);
}
.date-icn svg{ width:16px; height:16px; opacity:.92; }



	'''      align-items:flex-start;
    }
    .brand{
      display:flex;
      flex-direction:row;
      align-items:center;
      gap:12px;
      text-shadow:0 2px 6px rgba(0,0,0,.8);
    }
    .brand-txt{display:flex; flex-direction:column; gap:2px;}
    .brand-kicker{
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      opacity:.85;
    }
    .brand-title{
      font-size:16px;
      font-weight:800;
      letter-spacing:.02em;
    }
    .brand-sub{
      font-size:12px;
      opacity:.85;
    }
    .tag-top{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.7);
      color:var(--text-soft);
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:12px;
    }
    .pill-btn{
      border:none;
      background:transparent;
      color:inherit;
      font:inherit;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .pill-btn .icn{font-size:14px;}

    main{
      flex:1;
      display:flex;
      justify-content:center;
      padding:12px 16px 18px;
    }
    .layout{
      width:100%;
      max-width:1200px;
      display:flex;
      justify-content:center;
    }
    .container{
      width:100%;
      background:radial-gradient(circle at top left,rgba(59,130,246,.16) 0,transparent 55%),
                 radial-gradient(circle at bottom right,rgba(248,113,113,.14) 0,transparent 55%),
                 linear-gradient(135deg,rgba(15,23,42,.98),rgba(12,10,25,.98));
      border-radius:18px;
      border:1px solid rgba(148,163,184,.6);
      box-shadow:0 24px 60px rgba(15,23,42,.9);
      padding:18px 18px 16px;
    }

    h1{
      font-size:18px;
      margin-bottom:4px;
    }
    .subtitulo{
      font-size:12px;
      color:var(--text-soft);
      margin-bottom:10px;
    }

    form{
      margin-top:4px;
      font-size:12px;
    }
    label{
      display:block;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#9ca3af;
      margin-bottom:4px;
    }
    input,select{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #111827;
      background:#020617;
      color:var(--text);
      font-size:12px;
      outline:none;
    }
    input:focus,select:focus{
      border-color:var(--blue);
      box-shadow:0 0 0 1px rgba(59,130,246,.6);
    }
    input[disabled]{
      opacity:.85;
      cursor:not-allowed;
    }

    .form-row{
      display:flex;
      gap:12px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .form-row>div{
      flex:1 1 0;
      min-width:160px;
    }

    .modo-manual-box{
      margin-top:4px;
      font-size:11px;
      color:var(--text-soft);
    }
    .modo-manual-box label{
      text-transform:none;
      letter-spacing:0;
      display:flex;
      align-items:center;
      gap:6px;
      margin:0;
      cursor:pointer;
    }
    .modo-manual-box input[type="checkbox"]{
      width:auto;
      accent-color:var(--blue);
    }



/* --- ÍMPAR Premium: logo orb no header --- */
.logo-orb{
      width:36px;height:36px;border-radius:999px;
      position:relative;
      background: conic-gradient(from 210deg,
        #22c55e,
        #06b6d4,
        #3b82f6,
        #a855f7,
        #f97316,
        #22c55e);
      box-shadow:
        0 10px 22px rgba(0,0,0,.35),
        0 0 0 1px rgba(255,255,255,.18) inset;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logo-orb:before{
      content:"";
      position:absolute; inset:-6px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 55%);
      filter: blur(0.2px);
    }
    .logo-orb:after{
      content:"";
      position:absolute; inset:-14px;
      background: radial-gradient(circle at 50% 50%, rgba(34,197,94,.35), transparent 65%);
      filter: blur(10px);
      opacity:.7;
    }


    header{
      padding:10px 16px 4px;
      display:flex;
      justify-content:center;
    }
    .header-inner{
      width:100%;
      max-width:1200px;
      display:flex;
      justify-content:space-between;
      gap:16px;
      align-items:flex-start;
    }
    .brand{
      display:flex;
      flex-direction:row;
      align-items:center;
      gap:12px;
      text-shadow:0 2px 6px rgba(0,0,0,.8);
    }
    .brand-txt{display:flex; flex-direction:column; gap:2px;}
    .brand-kicker{
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      opacity:.85;
    }
    .brand-title{
      font-size:16px;
      font-weight:800;
      letter-spacing:.02em;
    }
    .brand-sub{
      font-size:12px;
      opacity:.85;
    }
    .tag-top{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.7);
      color:var(--text-soft);
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:12px;
    }
    .pill-btn{
      border:none;
      background:transparent;
      color:inherit;
      font:inherit;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .pill-btn .icn{font-size:14px;}

    main{
      flex:1;
      display:flex;
      justify-content:center;
      padding:12px 16px 18px;
    }
    .layout{
      width:100%;
      max-width:1200px;
      display:flex;
      justify-content:center;
    }
    .container{
      width:100%;
      background:linear-gradient(120deg,#0b1e4a,#0e3b6e,#0f766e);
      border-radius:18px;
      border:1px solid rgba(148,163,184,.6);
      box-shadow:0 24px 60px rgba(15,23,42,.9);
      padding:18px 18px 16px;
    }

    h1{
      font-size:18px;
      margin-bottom:4px;
    }
    .subtitulo{
      font-size:12px;
      color:var(--text-soft);
      margin-bottom:10px;
    }

    form{
      margin-top:4px;
      font-size:12px;
    }
    label{
      display:block;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#9ca3af;
      margin-bottom:4px;
    }
    input,select{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #111827;
      background:#020617;
      color:var(--text);
      font-size:12px;
      outline:none;
    }
    input:focus,select:focus{
      border-color:var(--blue);
      box-shadow:0 0 0 1px rgba(59,130,246,.95), 0 0 18px rgba(59,130,246,.55), 0 0 46px rgba(29,78,216,.35);
    }
    input[disabled]{
      opacity:.85;
      cursor:not-allowed;
    }

    .form-row{
      display:flex;
      gap:12px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .form-row>div{
      flex:1 1 0;
      min-width:160px;
    }

    .modo-manual-box{
      margin-top:4px;
      font-size:11px;
      color:var(--text-soft);
    }
    .modo-manual-box label{
      text-transform:none;
      letter-spacing:0;
      display:flex;
      align-items:center;
      gap:6px;
      margin:0;
      cursor:pointer;
    }
    .modo-manual-box input[type="checkbox"]{
      width:auto;
      accent-color:var(--blue);
    }

    .btn-primary,
    .btn-secondary{
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      font-weight:600;
      cursor:pointer;
    }
    .btn-primary{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#020617;
      box-shadow:0 10px 30px rgba(22,163,74,.6);
    }
    .btn-secondary{
      background:#111827;
      color:#fff;
      border:1px solid #374151;
    }

    .actions{
      margin-top:8px;
      margin-bottom:4px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .header-info{
      margin-top:2px;
      margin-bottom:6px;
      font-size:12px;
      color:#cfd8ff;
    }
    .header-info strong{font-weight:600;}

    .table-wrapper{
      overflow-x:auto;
      border-radius:12px;
      border:1px solid #111827;
      margin-top:6px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      background:#020617;
      min-width:480px;
    }
    th,td{
      padding:5px 6px;
      border-bottom:1px solid #1f2937;
      text-align:left;
    }
    th{
      background:#020617;
      position:sticky;
      top:0;
      z-index:1;
      font-weight:600;
      color:var(--text-soft);
    }
    tbody tr:hover{
      background:#111827;
    }
    .btn-remover{
      cursor:pointer;
    }

    footer{
      background:#020617;
      color:#9ca3af;
      padding:6px 16px;
      font-size:10px;
    }
    .rodape-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    @media(max-width:900px){
      .container{padding:14px 12px 16px;}
      h1{font-size:16px;}
    }
  
/* =========================================================
   ÍMPAR PREMIUM (Menu) — Overrides Visuais
   *Não mexe em IDs, nomes e lógica do JS*
   ========================================================= */

:root{
  --p-bg-left:  #0b3a8a;
  --p-bg-mid:   #0b4c7a;
  --p-bg-right: #0a8a71;

  --p-card: rgba(2, 6, 23, .58);
  --p-card-2: rgba(2, 6, 23, .70);
  --p-border: rgba(255,255,255,.10);
  --p-border-soft: rgba(255,255,255,.08);

  --p-text: #e5e7eb;
  --p-text-soft: rgba(229,231,235,.78);

  --p-blue: #2f7bff;
  --p-blue-soft: rgba(47,123,255,.35);
  --p-green: #22c55e;

  --p-grad: linear-gradient(90deg, rgba(37,99,235,1), rgba(16,185,129,1));
  --p-grad-soft: linear-gradient(90deg, rgba(37,99,235,.25), rgba(16,185,129,.20));

  --p-radius: 22px;
  --p-radius-sm: 14px;
}

/* Fundo igual Menu */
body{
  color: var(--p-text) !important;
  background:linear-gradient(120deg,#0b1e4a,#0e3b6e,#0f766e);
      }
body{
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
.layout{
  flex:1 0 auto;
  width:100%;
}
footer{
  margin-top:auto;
}

/* Evita scroll horizontal em tabelas sem "empurrar" a página */
.tabela-wrapper{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}
.tabela-wrapper table{
  min-width: 760px; /* garante scroll dentro do wrapper, não no body */
}

/* Loader sempre centralizado */
/* Mobile (<= 720px) */
@media (max-width: 720px){
  header{
    padding: 14px 12px;
  }
  .header-inner{
    flex-wrap: wrap;
    gap: 10px;
  }
  .brand{
    flex: 1 1 auto;
    min-width: 0;
  }
  .brand-text{
    min-width:0;
  }
  .brand-line{
    white-space: normal;
    line-height: 1.15;
  }
  .brand-title{
    font-size: 18px;
  }
  .brand-sub{
    font-size: 12px;
  }
  .title-stack{
    flex: 1 1 100%;
    min-width: 0;
    text-align: left;
  }
  .page-title{
    font-size: 14px;
    white-space: normal;
    line-height: 1.15;
  }
  .sub-title{
    font-size: 12px;
    white-space: normal;
  }
  .actions{
    margin-left: auto;
  }

  .container{
    padding: 14px 12px 22px;
  }
  .card{
    padding: 16px;
    border-radius: 18px;
  }

  .form-row{
    gap: 10px;
  }
  .field{
    flex: 1 1 100%;
    min-width: 0;
  }

  .input,
  select,
  textarea{
    font-size: 14px;
  }

  /* Ícone do calendário: menor e integrado, sem “sobrar” */
  .date-icon-btn{
    width: 40px;
    right: 8px;
  }
  .field.has-icon input{
    padding-right: 52px !important;
  }

  /* Tabela: scroll dentro do card (sem quebrar layout) */
  .tabela-wrapper{
    margin-top: 10px;
    border-radius: 14px;
  }

  footer{
    padding: 12px 12px;
  }
}

/* Loader (igual menu) */
.loader-card{
  width:min(420px, 92vw);
  padding:18px 18px 16px;
  border-radius:18px;
  background: rgba(2,6,23,.66);
  border: 1px solid rgba(255,255,255,.10);
  box-shadow: 0 30px 80px rgba(0,0,0,.45);
  backdrop-filter: blur(12px);
  text-align:center;
}
.loader-title{ font-weight:700; letter-spacing:.2px; margin:2px 0 6px; }
.loader-sub{ color: rgba(229,231,235,.78); font-size:12px; margin:0 0 10px; }
.spinner{
  width:44px; height:44px;
  border-radius:999px;
  border:4px solid rgba(255,255,255,.14);
  border-top-color: rgba(37,99,235,1);
  border-right-color: rgba(16,185,129,1);
  animation: spin 0.9s linear infinite;
  margin: 0 auto 8px;
}
@keyframes spin{ to{ transform: rotate(360deg);} }

/* Date input with calendar icon */
.date-wrap{ position:relative; }
.date-wrap input[type="date"]{ padding-right:42px !important; }
.date-icn{
  position:absolute; right:10px; top:50%;
  transform: translateY(-50%);
  width:30px; height:30px;
  border-radius:10px;
  display:grid; place-items:center;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  cursor:pointer;
  transition: transform .15s ease, background .15s ease, box-shadow .15s ease;
}
.date-icn:hover{
  transform: translateY(-50%) scale(1.03);
  background: rgba(255,255,255,.08);
  box-shadow: 0 12px 28px rgba(0,0,0,.22);
}
.date-icn svg{ width:16px; height:16px; opacity:.92; }



/* --- ÍMPAR Premium: logo orb no header --- */
.logo-orb{
      width:36px;height:36px;border-radius:999px;
      position:relative;
      background: conic-gradient(from 210deg,
        #22c55e,
        #06b6d4,
        #3b82f6,
        #a855f7,
        #f97316,
        #22c55e);
      box-shadow:
        0 10px 22px rgba(0,0,0,.35),
        0 0 0 1px rgba(255,255,255,.18) inset;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logo-orb:before{
      content:"";
      position:absolute; inset:-6px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 55%);
      filter: blur(0.2px);
    }
    .logo-orb:after{
      content:"";
      position:absolute; inset:-14px;
      background: radial-gradient(circle at 50% 50%, rgba(34,197,94,.35), transparent 65%);
      filter: blur(10px);
      opacity:.7;
    }

/* --- Input com ícone interno (calendário) --- */
.input-icon-wrap{ position:relative; width:100%; }
.input-icon-wrap input{ padding-right:52px; }
.input-icon-wrap .btn-calendar{
  position:absolute;
  right:10px; top:50%;
  transform:translateY(-50%);
  width:38px; height:38px;
  border-radius:12px;
  display:grid; place-items:center;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.14);
  color: rgba(255,255,255,.92);
  cursor:pointer;
  transition: transform .15s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
}
.input-icon-wrap .btn-calendar:hover{
  transform: translateY(-50%) scale(1.03);
  background: rgba(255,255,255,.09);
  border-color: rgba(255,255,255,.22);
  box-shadow: 0 10px 22px rgba(0,0,0,.25);
}
.input-icon-wrap .btn-calendar:active{ transform: translateY(-50%) scale(.98); }
.input-icon-wrap .btn-calendar svg{ opacity:.95 }

/* Esconde o ícone nativo do Chrome pra não duplicar */
input[type="date"]::-webkit-calendar-picker-indicator{ opacity:0; cursor:pointer; }
input[type="date"]::-webkit-inner-spin-button{ display:none; }

/* --- HEADER (ajuste responsivo / igual ao menu) --- */
.header-inner{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;}
.brand{display:flex;align-items:center;gap:14px;min-width:0;}
.brand-text{display:flex;flex-direction:column;gap:2px;min-width:0;}
.brand-kicker{letter-spacing:.18em;text-transform:uppercase;font-weight:700;font-size:12px;opacity:.9;}
.brand-title{font-size:22px;font-weight:800;line-height:1.1;}
.brand-sub{font-size:14px;font-weight:700;opacity:.95;line-height:1.2;}
.brand-tagline{font-size:12px;opacity:.85;line-height:1.2;max-width:52ch;}
header{padding:14px 18px;}
@media (max-width: 720px){
  header{padding:14px 14px;}
  .header-inner{justify-content:flex-start;}
  .tag-top{margin-left:auto;}
  .brand-title{font-size:20px;}
}
@media (max-width: 520px){
  .header-inner{flex-direction:column;align-items:flex-start;}
  .tag-top{width:100%;display:flex;justify-content:flex-end;}
  .brand-tagline{max-width:100%;}
}


/* ===== Header layout (stacked like MENU) ===== */
html, body{ overflow-x:hidden; }
header{ padding:14px 14px 12px; }
.header-inner{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
.brand{ display:flex; align-items:center; gap:12px; min-width:0; }
.brand-text{ display:flex; flex-direction:column; gap:2px; min-width:0; }
.brand-kicker{ letter-spacing:.24em; font-size:12px; opacity:.9; }
.brand-title{ font-size:18px; font-weight:800; line-height:1.05; }
.brand-sub{ font-size:14px; font-weight:700; opacity:.92; }
.brand-tagline{ font-size:12px; opacity:.75; max-width:60ch; white-space:normal; }
.tag-top{ margin-left:auto; }

@media (max-width: 720px){
  .header-inner{ justify-content:flex-start; }
  .tag-top{ width:100%; margin-left:0; display:flex; justify-content:flex-end; }
  .brand-tagline{ max-width:100%; }
}
800;line-height:1.1;}
.brand-sub{font-size:14px;font-weight:700;opacity:.95;line-height:1.2;}
.brand-tagline{font-size:12px;opacity:.85;line-height:1.2;max-width:52ch;}
header{padding:14px 18px;}
@media (max-width: 720px){
  header{padding:14px 14px;}
  .header-inner{justify-content:flex-start;}
  .tag-top{margin-left:auto;}
  .brand-title{font-size:20px;}
}
@media (max-width: 520px){
  .header-inner{flex-direction:column;align-items:flex-start;}
  .tag-top{width:100%;display:flex;justify-content:flex-end;}
  .brand-tagline{max-width:100%;}
}


/* ===== Header layout (stacked like MENU) ===== */
html, body{ overflow-x:hidden; }
header{ padding:14px 14px 12px; }
.header-inner{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
.brand{ display:flex; align-items:center; gap:12px; min-width:0; }
.brand-text{ display:flex; flex-direction:column; gap:2px; min-width:0; }
.brand-kicker{ letter-spacing:.24em; font-size:12px; opacity:.9; }
.brand-title{ font-size:18px; font-weight:800; line-height:1.05; }
.brand-sub{ font-size:14px; font-weight:700; opacity:.92; }
.brand-tagline{ font-size:12px; opacity:.75; max-width:60ch; white-space:normal; }
.tag-top{ margin-left:auto; }

@media (max-width: 720px){
  .header-inner{ justify-content:flex-start; }
  .tag-top{ width:100%; margin-left:0; display:flex; justify-content:flex-end; }
  .brand-tagline{ max-width:100%; }
}

/* Loader (igual menu) — overlay (não ocupa espaço) */
#pageLoader{
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 18px;
  background: radial-gradient(1200px 600px at 20% 10%, rgba(59,130,246,.35), transparent 55%),
              radial-gradient(900px 500px at 90% 30%, rgba(16,185,129,.28), transparent 60%),
              linear-gradient(120deg, #031434 0%, #0b2b47 35%, #0f6a66 100%);
  z-index: 9999;
  opacity: 1;
  visibility: visible;
  pointer-events: auto;
  transition: opacity .35s ease, transform .35s ease, visibility .35s ease;
}
#pageLoader.hidden{
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transform: translateY(-6px);
}

/* Mobile/overflow safety */
html, body{ width:100%; overflow-x:hidden; }

/* =========================================================
   SWEETALERT2 — Tema ÍMPAR Premium (UI only)
   ========================================================= */
.impar-swal{
  background: rgba(2,6,23,.92) !important;
  color: #e5e7eb !important;
  border: 1px solid rgba(255,255,255,.10) !important;
  border-radius: 18px !important;
  box-shadow: 0 30px 80px rgba(0,0,0,.55) !important;
  backdrop-filter: blur(14px);
}
.impar-swal .swal2-title{ color:#e5e7eb !important; font-weight:800; }
.impar-swal .swal2-html-container{ color: rgba(229,231,235,.88) !important; }
.impar-swal .swal2-icon{ border-color: rgba(59,130,246,.8) !important; }
.impar-swal .swal2-loader{
  border-color: rgba(59,130,246,.25) !important;
  border-top-color: rgba(59,130,246,.95) !important;
}
.impar-swal-confirm{
  border: 0 !important;
  border-radius: 12px !important;
  padding: 10px 14px !important;
  font-weight: 800 !important;
  color: #fff !important;
  background: linear-gradient(120deg,#0b1e4a,#0e3b6e,#0f766e) !important;
  box-shadow: 0 18px 38px rgba(0,0,0,.35) !important;
}
.impar-swal-cancel{
  border: 1px solid rgba(255,255,255,.16) !important;
  border-radius: 12px !important;
  padding: 10px 14px !important;
  font-weight: 800 !important;
  color: #e5e7eb !important;
  background: rgba(255,255,255,.06) !important;
}
.impar-swal .swal2-close{ color: rgba(229,231,235,.7) !important; }
.impar-swal-body{
  display:flex; gap:12px; align-items:center; justify-content:center;
  padding-top: 6px;
}
.impar-spinner{
  width:18px; height:18px; border-radius:999px;
  border:3px solid rgba(59,130,246,.25);
  border-top-color: rgba(59,130,246,.95);
  animation: imparSpin .85s linear infinite;
  flex: 0 0 auto;
}
@keyframes imparSpin { to { transform: rotate(360deg); } }
.impar-swal-sub{ text-align:left; line-height:1.25; }
.impar-swal-sub b{ color:#e5e7eb; }


/* =========================================================
   TRANSIÇÃO DE ENTRADA — estilo slide (menu → solicitação)
   ========================================================= */
body { opacity: 0; }
@keyframes imparEnter {
  0% { opacity:0; transform: translateY(34px) scale(.97); filter: blur(10px); }
  100% { opacity:1; transform: translateY(0) scale(1); filter: blur(0); }
}
body.impar-enter { animation: imparEnter .80s cubic-bezier(.16,1,.3,1) both; }
@media (prefers-reduced-motion: reduce) {
  body { opacity: 1; }
  body.impar-enter { animation:none; }
}


/* ===== Loader Premium — padrão INDEX (override) ===== */
#pageLoader{
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
  background: rgba(2,6,23,.45);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: 9999;
  opacity: 1;
  visibility: visible;
  pointer-events: auto;
  transition: opacity .35s ease, transform .35s ease, visibility .35s ease;
}
#pageLoader.hidden{
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transform: translateY(-6px);
}


/* ===== Botões verdes — hover/focus premium (zoom + brilho) ===== */
.btn-primary{
  transition: transform .22s cubic-bezier(.16,1,.3,1),
              box-shadow .22s cubic-bezier(.16,1,.3,1),
              filter .22s cubic-bezier(.16,1,.3,1);
  will-change: transform;
}
.btn-primary:hover{
  transform: translateY(-1px) scale(1.035);
  filter: saturate(1.18) brightness(1.08);
  box-shadow:
    0 0 0 1px rgba(34,197,94,.95),
    0 0 22px rgba(34,197,94,.55),
    0 18px 45px rgba(22,163,74,.55);
}
.btn-primary:active{
  transform: translateY(0) scale(.99);
  filter: saturate(1.08) brightness(1.03);
}
.btn-primary:focus-visible{
  outline:none;
  transform: translateY(-1px) scale(1.035);
  box-shadow:
    0 0 0 2px rgba(2,6,23,.90),
    0 0 0 4px rgba(34,197,94,.75),
    0 0 26px rgba(34,197,94,.55);
}
.pill-btn{
  transition: transform .2s cubic-bezier(.16,1,.3,1), box-shadow .2s cubic-bezier(.16,1,.3,1);
}
.pill-btn:hover{ transform: translateY(-1px) scale(1.02); box-shadow: 0 12px 28px rgba(0,0,0,.28); }
.pill-btn:focus-visible{ outline:none; box-shadow: 0 0 0 2px rgba(2,6,23,.9), 0 0 0 4px rgba(47,123,255,.55); }

/* pequenos ajustes para o módulo */

/* --- PRICING (Consulta de preços) --- */
.kpi-row{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:10px}
.kpi{background:rgba(2,6,23,.55);border:1px solid rgba(148,163,184,.25);border-radius:16px;padding:12px}
.kpi .label{color:rgba(226,232,240,.75);font-size:.85rem}
.kpi .value{font-size:1.35rem;font-weight:800;margin-top:6px}
.table-wrap{overflow:auto;border-radius:16px;border:1px solid rgba(148,163,184,.25);background:rgba(2,6,23,.40)}
table{width:100%;border-collapse:separate;border-spacing:0}
thead th{position:sticky;top:0;background:rgba(2,6,23,.88);backdrop-filter:blur(8px);text-align:left;font-size:.85rem;color:rgba(226,232,240,.85);padding:12px;border-bottom:1px solid rgba(148,163,184,.25)}
tbody td{padding:10px 12px;border-bottom:1px solid rgba(148,163,184,.14);vertical-align:top}
tbody tr:hover td{background:rgba(59,130,246,.06)}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.25);background:rgba(2,6,23,.35);font-size:.85rem}
.badge.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.08)}
.badge.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.08)}
.badge.err{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08)}
.mini{font-size:.85rem;color:rgba(226,232,240,.75)}
.input-inline{width:100%;min-width:180px}
.actions-row{display:flex;gap:10px;flex-wrap:wrap}
hr.sep{border:none;border-top:1px solid rgba(148,163,184,.18);margin:14px 0}

</style>
</head>

<body>
  <!-- Loading overlay (padrão ÍMPAR) -->
  <div id="loadingOverlay" style="display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;background:rgba(2,6,23,.76);backdrop-filter:blur(6px)">
    <div class="card" style="max-width:520px;width:92%">
      <div style="display:flex;align-items:center;gap:14px">
        <div class="spinner"></div>
        <div>
          <div style="font-weight:900;font-size:1.1rem">Aguarde…</div>
          <div id="loadingLabel" class="mini">Processando…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastWrap" class="toastWrap"></div>

  <div class="page">
    <header class="topbar">
      <div class="brand">
        <div class="logoDot"></div>
        <div>
          <div class="brandTitle">ERP ÍMPAR</div>
          <div class="brandSub">Consulta de preços • Materiais de climatização</div>
        </div>
      </div>
      <div class="topActions">
        <a class="btn ghost" href="/menu.html">← Menu</a>
      </div>
    </header>

    <main class="container">
      <div class="card hero">
        <div class="heroLeft">
          <h1>Consulta de preços</h1>
          <p class="muted">
            Importe um CSV ou digite itens, dispare a cotação e acompanhe o retorno automático do worker (SerpAPI).
          </p>

          <div class="kpi-row">
            <div class="kpi">
              <div class="label">Itens na lista</div>
              <div class="value" id="kpiItens">0</div>
            </div>
            <div class="kpi">
              <div class="label">Total melhor oferta</div>
              <div class="value" id="kpiTotal">—</div>
            </div>
            <div class="kpi">
              <div class="label">Ofertas coletadas</div>
              <div class="value" id="kpiOfertas">0</div>
            </div>
          </div>
        </div>

        <div class="heroRight">
          <div class="badge">API: <span class="mini">api.erpimpar.com.br</span></div>
          <div class="badge">Worker: <span class="mini">GitHub • erp-impar/pricing</span></div>
          <div class="badge">Fonte: <span class="mini">SerpAPI (Google Shopping)</span></div>
        </div>
      </div>

      <!-- Screen: edit -->
      <section id="screen-edit" class="screen active">
        <div class="card">
          <div class="sectionTitle">
            <h2>1) Montar lista de itens</h2>
            <p class="muted">CSV é o caminho mais fácil. Colunas recomendadas: <b>codigo,descricao,ncm,qtd,un</b>.</p>
          </div>

          <div class="grid2">
            <div>
              <label class="label">Obra (ID)</label>
              <input id="obraId" class="input" placeholder="OBRA_001" value="OBRA_001">
            </div>
            <div>
              <label class="label">CEP da obra (opcional)</label>
              <input id="cepObra" class="input" placeholder="89200-000">
            </div>
          </div>

          <hr class="sep">

          <div class="grid2">
            <div>
              <label class="label">Importar CSV</label>
              <input id="csvFile" class="input" type="file" accept=".csv,text/csv">
              <div class="mini" style="margin-top:6px">Dica: use “;” ou “,” — o sistema detecta automaticamente.</div>
            </div>
            <div class="actions-row" style="align-items:flex-end">
              <button id="btnAdd" class="btn">+ Adicionar linha</button>
              <button id="btnClear" class="btn ghost">Limpar</button>
              <button id="btnCreate" class="btn primary">⚡ Disparar cotação</button>
            </div>
          </div>

          <div style="margin-top:14px" class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Código</th>
                  <th>Descrição</th>
                  <th>NCM</th>
                  <th>Qtd</th>
                  <th>UN</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="itemsBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Screen: status/results -->
      <section id="screen-status" class="screen">
        <div class="card">
          <div class="sectionTitle">
            <h2>2) Acompanhar cotação</h2>
            <p class="muted">O worker vai preencher o JSON no storage e o front atualiza automaticamente.</p>
          </div>

          <div class="grid2">
            <div>
              <div class="badge">Quote ID: <b id="quoteId">—</b></div>
              <div class="mini" style="margin-top:8px">Status: <b id="kpiStatus">—</b> • Atualizado: <b id="kpiAtualizado">—</b></div>
            </div>
            <div class="actions-row" style="justify-content:flex-end">
              <button id="btnBack" class="btn ghost">← Voltar</button>
              <button id="btnReload" class="btn">Atualizar</button>
              <button id="btnDownload" class="btn ghost">Baixar JSON</button>
            </div>
          </div>

          <hr class="sep">

          <div class="grid2">
            <div>
              <label class="label">Carregar cotação existente (opcional)</label>
              <input id="quoteIdInput" class="input" placeholder="Q-20260106-215649">
              <div class="mini" style="margin-top:6px">Cole um Quote ID para reabrir uma cotação já criada.</div>
            </div>
            <div class="actions-row" style="align-items:flex-end;justify-content:flex-end">
              <button id="btnLoad" class="btn">Abrir Quote ID</button>
            </div>
          </div>

          <div style="margin-top:14px" class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Código</th>
                  <th>Item</th>
                  <th>Qtd</th>
                  <th>Status</th>
                  <th>Melhor oferta</th>
                  <th>Top ofertas</th>
                </tr>
              </thead>
              <tbody id="resultsBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <div class="footerNote mini" style="text-align:center;margin:18px 0 8px">
        Ambiente interno • ERP ÍMPAR • Pricing v1.0
      </div>
    </main>
  </div>

<script>

/* ERP ÍMPAR – Pricing (Consulta de preços) */

const API_BASE = "https://api.erpimpar.com.br/pricing"; // public URL
const API_KEY  = "IMPAR_CHAVE_FIXA_TESTE_123";          // sua chave fixa do ERP ÍMPAR (header X-API-KEY)
const POLL_MS  = 2500;

const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

function nowBR(){
  const d = new Date();
  return d.toLocaleString("pt-BR", { timeZone: "America/Sao_Paulo" });
}

function toast(msg, type="info"){
  const wrap = $("#toastWrap") || document.body;
  const el = document.createElement("div");
  el.className = "toast " + type;
  el.innerHTML = `<div class="toastTitle">${type==="err"?"Erro":type==="ok"?"OK":"Aviso"}</div>
                  <div class="toastMsg">${msg}</div>`;
  wrap.appendChild(el);
  setTimeout(()=>el.classList.add("show"), 10);
  setTimeout(()=>{
    el.classList.remove("show");
    setTimeout(()=>el.remove(), 250);
  }, 3500);
}

function setLoading(on, label="Processando..."){
  const ov = $("#loadingOverlay");
  if(!ov) return;
  $("#loadingLabel").textContent = label;
  ov.style.display = on ? "flex" : "none";
}

function switchScreen(id){
  $$(".screen").forEach(s=>s.classList.remove("active"));
  const el = document.getElementById(id);
  if(el) el.classList.add("active");
  window.scrollTo({top:0, behavior:"smooth"});
}

function parseCSV(text){
  // Auto-detect delimiter ( ; or , )
  const sample = (text.split(/\r?\n/).find(l=>l.trim()) || "");
  const delim = (sample.split(";").length > sample.split(",").length) ? ";" : ",";
  const lines = text.split(/\r?\n/).filter(l=>l.trim());
  if(!lines.length) return [];
  const header = lines[0].split(delim).map(h=>h.trim().toLowerCase());
  const idx = (name)=> header.indexOf(name);

  const out = [];
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(delim).map(c=>c.trim());
    if(cols.length < 2) continue;
    const item = {
      codigo: cols[idx("codigo")] ?? cols[0] ?? "",
      descricao: cols[idx("descricao")] ?? cols[idx("descrição")] ?? cols[1] ?? "",
      ncm: cols[idx("ncm")] ?? "",
      qtd: Number((cols[idx("qtd")] ?? cols[idx("quantidade")] ?? "1").replace(",", ".")) || 1,
      un: cols[idx("un")] ?? cols[idx("unidade")] ?? "",
    };
    if(item.descricao) out.push(item);
  }
  return out;
}

function normalizeItem(it){
  return {
    codigo_erp: String(it.codigo || it.codigo_erp || "").trim(),
    descricao: String(it.descricao || "").trim(),
    ncm: it.ncm ? String(it.ncm).trim() : null,
    qtd: Number(it.qtd || 1) || 1,
    un: it.un ? String(it.un).trim() : null,
  };
}

let currentItems = [];
let currentQuoteId = null;

function renderItems(){
  const tbody = $("#itemsBody");
  tbody.innerHTML = "";
  currentItems.forEach((it, i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mini">${i+1}</td>
      <td><input class="input input-inline" value="${(it.codigo||"").replace(/"/g,'&quot;')}" data-k="codigo" data-i="${i}" placeholder="Código (ERP)"></td>
      <td><input class="input input-inline" value="${(it.descricao||"").replace(/"/g,'&quot;')}" data-k="descricao" data-i="${i}" placeholder="Descrição"></td>
      <td><input class="input input-inline" value="${(it.ncm||"")}" data-k="ncm" data-i="${i}" placeholder="NCM (opcional)"></td>
      <td style="max-width:120px"><input class="input input-inline" value="${it.qtd}" data-k="qtd" data-i="${i}" placeholder="Qtd"></td>
      <td style="max-width:120px"><input class="input input-inline" value="${(it.un||"")}" data-k="un" data-i="${i}" placeholder="UN"></td>
      <td><button class="btn danger" data-act="del" data-i="${i}">Remover</button></td>
    `;
    tbody.appendChild(tr);
  });

  // bind
  $$("#itemsBody input").forEach(inp=>{
    inp.addEventListener("blur", ()=>{
      const i = Number(inp.dataset.i);
      const k = inp.dataset.k;
      if(k === "qtd"){
        const v = Number(String(inp.value).replace(",", "."));
        currentItems[i][k] = (isFinite(v) && v>0) ? v : 1;
        inp.value = currentItems[i][k];
      }else{
        currentItems[i][k] = inp.value;
      }
    });
  });
  $$("#itemsBody button[data-act='del']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = Number(btn.dataset.i);
      currentItems.splice(i,1);
      renderItems();
    });
  });

  $("#kpiItens").textContent = String(currentItems.length);
}

async function apiPost(url, payload){
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      "X-API-KEY": API_KEY
    },
    body: JSON.stringify(payload)
  });
  const txt = await res.text();
  let data = null;
  try { data = JSON.parse(txt); } catch(e){ /* ignore */ }
  if(!res.ok){
    const msg = (data && (data.error||data.message)) ? (data.error||data.message) : txt;
    throw new Error(`${res.status} ${res.statusText}: ${msg}`);
  }
  return data ?? {};
}

async function apiGet(url){
  const res = await fetch(url, { headers: { "X-API-KEY": API_KEY } });
  const txt = await res.text();
  let data = null;
  try { data = JSON.parse(txt); } catch(e){ /* ignore */ }
  if(!res.ok){
    const msg = (data && (data.error||data.message)) ? (data.error||data.message) : txt;
    throw new Error(`${res.status} ${res.statusText}: ${msg}`);
  }
  return data ?? {};
}

async function createQuote(){
  const obraId = $("#obraId").value.trim() || "OBRA_000";
  if(!currentItems.length){
    toast("Adicione itens (ou importe um CSV) antes de disparar a consulta.", "warn");
    return;
  }
  const payload = {
    obra_id: obraId,
    cep_obra: ($("#cepObra").value || "").trim() || null,
    itens: currentItems.map(it=>({
      codigo_erp: String(it.codigo||"").trim() || null,
      descricao: String(it.descricao||"").trim(),
      ncm: it.ncm ? String(it.ncm).trim() : null,
      qtd: Number(it.qtd||1) || 1,
      un: it.un ? String(it.un).trim() : null,
    }))
  };

  setLoading(true, "Criando cotação...");
  try{
    const data = await apiPost(`${API_BASE}/create_quote.php`, payload);
    currentQuoteId = data.quote_id || data.quoteId || null;
    $("#quoteId").textContent = currentQuoteId ? currentQuoteId : "—";
    toast(`Cotação criada: ${currentQuoteId}`, "ok");
    $("#kpiStatus").textContent = "criada";
    $("#kpiAtualizado").textContent = nowBR();
    switchScreen("screen-status");
    setLoading(false);
    pollQuote();
  }catch(e){
    setLoading(false);
    toast(e.message, "err");
  }
}

let pollTimer = null;

async function pollQuote(){
  if(!currentQuoteId) return;

  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async ()=>{
    try{
      const data = await apiGet(`${API_BASE}/get_quote.php?quote_id=${encodeURIComponent(currentQuoteId)}`);
      renderResults(data);
      const st = String(data.status || "").toLowerCase();
      $("#kpiStatus").textContent = data.status || "—";
      $("#kpiAtualizado").textContent = data.atualizado_em || data.updated_at || nowBR();

      if(st.includes("conclu") || st.includes("completed")){
        clearInterval(pollTimer);
        pollTimer = null;
        toast("Consulta finalizada!", "ok");
      }
    }catch(e){
      // keep polling but show only once in UI
      $("#kpiStatus").textContent = "erro ao ler";
    }
  }, POLL_MS);
}

function moneyBRL(v){
  const n = Number(v);
  if(!isFinite(n)) return "—";
  return n.toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
}

function renderResults(data){
  const results = data.resultados || data.results || [];
  $("#kpiOfertas").textContent = String(results.reduce((acc,r)=>acc + (Array.isArray(r.ofertas)?r.ofertas.length:0), 0));
  const tbody = $("#resultsBody");
  tbody.innerHTML = "";

  let totalBest = 0;
  results.forEach((r, i)=>{
    const best = r.melhor_oferta || r.best_offer || null;
    if(best && isFinite(Number(best.preco))) totalBest += Number(best.preco) * (Number(r.qtd)||1);

    const offers = (r.ofertas || r.offers || []).slice(0, 6).map(o=>{
      const loja = o.loja || o.store || o.seller || o.source || "—";
      const link = o.link ? `<a class="link" target="_blank" href="${o.link}">abrir</a>` : `<span class="mini">—</span>`;
      return `<div class="mini" style="display:flex;gap:10px;align-items:center;justify-content:space-between">
                <span>${loja} • ${moneyBRL(o.preco)}${o.envio?` • frete ${moneyBRL(o.envio)}`:""}</span>
                <span>${link}</span>
              </div>`;
    }).join("");

    const st = best ? "ok" : "warn";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mini">${i+1}</td>
      <td class="mini">${r.codigo || r.codigo_erp || "—"}</td>
      <td>
        <div style="font-weight:800">${r.descricao || "—"}</div>
        <div class="mini">Consulta: ${r.consulta || r.query || "—"}</div>
      </td>
      <td class="mini">${r.qtd || 1}</td>
      <td><span class="badge ${st}">${best ? "Melhor" : "Sem oferta"}</span></td>
      <td style="min-width:220px">
        ${best ? `<div style="font-weight:800">${moneyBRL(best.preco)}</div>
                 <div class="mini">${best.loja || best.store || "—"} • ${best.title || ""}</div>` : `<span class="mini">—</span>`}
      </td>
      <td style="min-width:360px">${offers || `<span class="mini">Sem ofertas (ainda)</span>`}</td>
    `;
    tbody.appendChild(tr);
  });

  $("#kpiTotal").textContent = moneyBRL(totalBest);
}

function downloadJSON(){
  if(!currentQuoteId){
    toast("Nenhuma cotação carregada.", "warn"); return;
  }
  apiGet(`${API_BASE}/get_quote.php?quote_id=${encodeURIComponent(currentQuoteId)}`)
    .then(data=>{
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${currentQuoteId}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    })
    .catch(e=>toast(e.message, "err"));
}

function wire(){
  // CSV import
  $("#csvFile").addEventListener("change", async (ev)=>{
    const f = ev.target.files?.[0];
    if(!f) return;
    const text = await f.text();
    const items = parseCSV(text);
    if(!items.length){
      toast("CSV sem itens válidos. Use colunas: codigo, descricao, ncm, qtd, un.", "err");
      return;
    }
    currentItems = items;
    renderItems();
    toast(`CSV importado: ${items.length} itens`, "ok");
  });

  $("#btnAdd").addEventListener("click", ()=>{
    currentItems.push({codigo:"", descricao:"", ncm:"", qtd:1, un:""});
    renderItems();
  });

  $("#btnClear").addEventListener("click", ()=>{
    currentItems = [];
    renderItems();
    toast("Lista limpa.", "ok");
  });

  $("#btnCreate").addEventListener("click", createQuote);

  $("#btnReload").addEventListener("click", ()=>{
    if(!currentQuoteId){
      const q = $("#quoteIdInput").value.trim();
      if(q) currentQuoteId = q;
      $("#quoteId").textContent = currentQuoteId || "—";
    }
    pollQuote();
    toast("Atualizando...", "ok");
  });

  $("#btnBack").addEventListener("click", ()=>switchScreen("screen-edit"));
  $("#btnDownload").addEventListener("click", downloadJSON);

  // optional direct open
  $("#btnLoad").addEventListener("click", ()=>{
    const q = $("#quoteIdInput").value.trim();
    if(!q){ toast("Informe o Quote ID.", "warn"); return; }
    currentQuoteId = q;
    $("#quoteId").textContent = currentQuoteId;
    switchScreen("screen-status");
    pollQuote();
  });

  renderItems();
}

document.addEventListener("DOMContentLoaded", wire);

</script>
</body>
</html>
